<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Antlr</title>
    <url>/posts/55501/</url>
    <content><![CDATA[<h2 id="什么是-Antlr"><a href="#什么是-Antlr" class="headerlink" title="什么是 Antlr?"></a>什么是 Antlr?</h2><p>　<strong>ANTLR</strong>™ (<strong>AN</strong>other <strong>T</strong>ool for <strong>L</strong>anguage <strong>R</strong>ecognition) is a powerful parser generator for reading, processing, executing, or translating structured text or binary files. It’s widely used to build languages, tools, and frameworks. From a grammar, ANTLR generates a parser that can build and walk parse trees.</p>
<h2 id="为什么要有-Antlr"><a href="#为什么要有-Antlr" class="headerlink" title="为什么要有 Antlr?"></a>为什么要有 Antlr?</h2><h3 id="简易性"><a href="#简易性" class="headerlink" title="简易性"></a>简易性</h3><p>　可以通过断言（Predicate）解决识别冲突<br>　支持动作（Action）和返回值（Return Value）<br>　它可以根据输入自动生成语法树，并可视化的展示出来</p>
<h3 id="模块化"><a href="#模块化" class="headerlink" title="模块化"></a>模块化</h3><p>　复杂情况下，需要基于语法树遍历（walking the tree）生成目标代码<br>　Embeded action 将处理代码跟语法描述混合起来，语法复杂时使语法文件臃肿<br>　语法可能经常需要修改，而语法的主要表达式却不会变动，因此，Antlr 将语法识别与转换、生成（目标代码）的处理分离</p>
<a id="more"></a>
<h2 id="Antlr-工作机制"><a href="#Antlr-工作机制" class="headerlink" title="Antlr 工作机制"></a>Antlr 工作机制</h2><h3 id="词法分析器（Lexer）"><a href="#词法分析器（Lexer）" class="headerlink" title="词法分析器（Lexer）"></a>词法分析器（Lexer）</h3><p>　分析量化字符流，翻译成离散的字符组（也就是一堆 Token）, 包括关键字，标识符，符号（symbols）和操作符，以供语法分析器使用</p>
<h3 id="语法分析器（Parser）"><a href="#语法分析器（Parser）" class="headerlink" title="语法分析器（Parser）"></a>语法分析器（Parser）</h3><p>　将 Tokens 组织起来，并转换成为目标语言语法（默认是 <a href="https://yuzhouwan.com/posts/27328/">Java</a>）定义所允许的序列</p>
<h3 id="树分析器（Tree-Parser）"><a href="#树分析器（Tree-Parser）" class="headerlink" title="树分析器（Tree Parser）"></a>树分析器（Tree Parser）</h3><p>　用于对语法分析生成的抽象语法树进行遍历，并在先序经过每个树节点的时候，进行一些定制操作</p>
<h2 id="Antlr-运作流程"><a href="#Antlr-运作流程" class="headerlink" title="Antlr 运作流程"></a>Antlr 运作流程</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Download</span></span><br><span class="line">$ <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/lib</span><br><span class="line">$ curl -O https://www.antlr.org/download/antlr-4.7.2-complete.jar</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add antlr-4.7.2-complete.jar to your CLASSPATH</span></span><br><span class="line"><span class="comment"># Create aliases for the ANTLR Tool, and TestRig</span></span><br><span class="line">$ vim ~/.bashrc</span><br><span class="line">  <span class="built_in">export</span> CLASSPATH=<span class="string">".:/usr/local/lib/antlr-4.7.2-complete.jar:<span class="variable">$CLASSPATH</span>"</span></span><br><span class="line">  <span class="built_in">alias</span> antlr4=<span class="string">'java -Xmx500M -cp "/usr/local/lib/antlr-4.7.2-complete.jar:$CLASSPATH" org.antlr.v4.Tool'</span></span><br><span class="line">  <span class="built_in">alias</span> grun=<span class="string">'java -Xmx500M -cp "/usr/local/lib/antlr-4.7.2-complete.jar:$CLASSPATH" org.antlr.v4.gui.TestRig'</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">source</span> ~/.bashrc</span><br></pre></td></tr></tbody></table></figure>
<h3 id="编写源文件"><a href="#编写源文件" class="headerlink" title="编写源文件"></a>编写源文件</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim Benedict.g4</span><br><span class="line">  // Define a grammar called Benedict</span><br><span class="line">  grammar Benedict;</span><br><span class="line">  r    : <span class="string">'hello'</span> Name ;         // match keyword hello followed by an identifier</span><br><span class="line">  Name : [a-z]+ ;               // match lower-case identifiers</span><br><span class="line">  WS   : [ \t\r\n]+ -&gt; skip ;   // skip spaces, tabs, newlines</span><br></pre></td></tr></tbody></table></figure>
<h3 id="词法语法分析"><a href="#词法语法分析" class="headerlink" title="词法语法分析"></a>词法语法分析</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ antlr4 Benedict.g4</span><br><span class="line">$ ll</span><br><span class="line">  total 36K</span><br><span class="line">  -rw-r--r-- 1 benedictjin wheel   93  1 15 14:47 Benedict.g4</span><br><span class="line">  -rw-r--r-- 1 benedictjin wheel  321  1 15 14:47 Benedict.interp</span><br><span class="line">  -rw-r--r-- 1 benedictjin wheel   38  1 15 14:47 Benedict.tokens</span><br><span class="line">  -rw-r--r-- 1 benedictjin wheel 1.3K  1 15 14:47 BenedictBaseListener.java</span><br><span class="line">  -rw-r--r-- 1 benedictjin wheel 1.3K  1 15 14:47 BenedictLexer.interp</span><br><span class="line">  -rw-r--r-- 1 benedictjin wheel 3.7K  1 15 14:47 BenedictLexer.java</span><br><span class="line">  -rw-r--r-- 1 benedictjin wheel   38  1 15 14:47 BenedictLexer.tokens</span><br><span class="line">  -rw-r--r-- 1 benedictjin wheel  569  1 15 14:47 BenedictListener.java</span><br><span class="line">  -rw-r--r-- 1 benedictjin wheel 3.9K  1 15 14:47 BenedictParser.java</span><br></pre></td></tr></tbody></table></figure>
<h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ javac Benedict*.java</span><br><span class="line">$ ll</span><br><span class="line">  total 60K</span><br><span class="line">  -rw-r--r-- 1 benedictjin wheel   93  1 15 14:47  Benedict.g4</span><br><span class="line">  -rw-r--r-- 1 benedictjin wheel  321  1 15 14:47  Benedict.interp</span><br><span class="line">  -rw-r--r-- 1 benedictjin wheel   38  1 15 14:47  Benedict.tokens</span><br><span class="line">  -rw-r--r-- 1 benedictjin wheel  822  1 15 14:48  BenedictBaseListener.class</span><br><span class="line">  -rw-r--r-- 1 benedictjin wheel 1.3K  1 15 14:47  BenedictBaseListener.java</span><br><span class="line">  -rw-r--r-- 1 benedictjin wheel 3.8K  1 15 14:48  BenedictLexer.class</span><br><span class="line">  -rw-r--r-- 1 benedictjin wheel 1.3K  1 15 14:47  BenedictLexer.interp</span><br><span class="line">  -rw-r--r-- 1 benedictjin wheel 3.7K  1 15 14:47  BenedictLexer.java</span><br><span class="line">  -rw-r--r-- 1 benedictjin wheel   38  1 15 14:47  BenedictLexer.tokens</span><br><span class="line">  -rw-r--r-- 1 benedictjin wheel  329  1 15 14:48  BenedictListener.class</span><br><span class="line">  -rw-r--r-- 1 benedictjin wheel  569  1 15 14:47  BenedictListener.java</span><br><span class="line">  -rw-r--r-- 1 benedictjin wheel  896  1 15 14:48 <span class="string">'BenedictParser$SayContext.class'</span></span><br><span class="line">  -rw-r--r-- 1 benedictjin wheel 4.4K  1 15 14:48  BenedictParser.class</span><br><span class="line">  -rw-r--r-- 1 benedictjin wheel 3.9K  1 15 14:47  BenedictParser.java</span><br><span class="line"></span><br><span class="line">$ grun Benedict r -tree</span><br><span class="line">  hello benedict</span><br><span class="line">  (r hello benedict)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="可视化"><a href="#可视化" class="headerlink" title="可视化"></a>可视化</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ grun Benedict r -gui</span><br><span class="line">  hello benedict</span><br><span class="line">  ^D</span><br></pre></td></tr></tbody></table></figure>
<p><img data-src="/picture/antlr/antlr4_hello_benedict.png" alt="antlr say hello example"></p>
<center>（对 <a href="https://www.antlr.org/" target="_blank">Antlr4</a>™ 输出界面的截图）</center>



<h2 id="踩到的坑"><a href="#踩到的坑" class="headerlink" title="踩到的坑"></a>踩到的坑</h2><h3 id="给每次-antlr-的结果文件添加-package"><a href="#给每次-antlr-的结果文件添加-package" class="headerlink" title="给每次 antlr 的结果文件添加 package"></a>给每次 antlr 的结果文件添加 package</h3><p>　在 .g4 中使用 <code>@header{ ... }</code> 添加 </p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@header</span>{</span><br><span class="line">    <span class="keyword">package</span> com.yuzhouwan.antlr;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="确定节点与子节点之间的关系"><a href="#确定节点与子节点之间的关系" class="headerlink" title="确定节点与子节点之间的关系"></a>确定节点与子节点之间的关系</h3><p>　使用 <code>if-else</code> 在 <code>exit/enter()</code> 中判别，节点与子节点之间的关系，确定是否是 operator</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">say</span><br><span class="line">    : 'say' Colon Name    #Colon</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">`benedictListener` 将会得到一个定位粒度为 Colon 的访问节点</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Enter a parse tree produced by the {<span class="doctag">@code</span> Colon}</span></span><br><span class="line"><span class="comment"> * labeled alternative in {<span class="doctag">@link</span> benedictParser#say}.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ctx the parse tree</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">enterColon</span><span class="params">(benedictParser.ColonContext ctx)</span></span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Exit a parse tree produced by the {<span class="doctag">@code</span> Colon}</span></span><br><span class="line"><span class="comment"> * labeled alternative in {<span class="doctag">@link</span> benedictParser#say}.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ctx the parse tree</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">exitColon</span><span class="params">(benedictParser.ColonContext ctx)</span></span>;</span><br></pre></td></tr></tbody></table></figure>
<h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><h3 id="Doc"><a href="#Doc" class="headerlink" title="Doc"></a>Doc</h3><ul>
<li><a href="https://github.com/antlr/antlr4/blob/master/doc/getting-started.md">Getting Started with ANTLR v4</a></li>
<li><a href="https://www.antlr.org/api/maven-plugin/latest/examples/simple.html">ANTLR 4 Maven plugin</a></li>
</ul>
<h3 id="Blog"><a href="#Blog" class="headerlink" title="Blog"></a>Blog</h3><ul>
<li><a href="https://www.quora.com/Which-is-better-ANTLR-or-JavaCC-Why">Which is better, ANTLR or JavaCC? Why?</a></li>
<li><a href="https://tomassetti.me/parsing-any-language-in-java-in-5-minutes-using-antlr-for-example-python/">Parsing Any Language in Java in 5 Minutes Using ANTLR: for Example Python</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/47179842">用 Golang 和 Antlr4 实现词法解析器</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/28516587">Go 的 AST（抽象语法树）</a></li>
<li><a href="https://blog.gopheracademy.com/advent-2017/parsing-with-antlr4-and-go/">Parsing with ANTLR 4 and Go</a></li>
</ul>
<h3 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h3><ul>
<li><a href="https://github.com/ftomassetti/python-ast">Python parser built using ANTLR</a></li>
<li><a href="https://github.com/antlr/grammars-v4/tree/master/golang">Golang Grammar</a></li>
<li><a href="https://github.com/yuroyoro/goast-viewer">Golang AST visualizer</a></li>
<li><a href="https://github.com/dglo/java2go">Convert Java code to something like Go</a></li>
<li><strong><a href="https://github.com/apache/druid/blob/master/core/src/main/antlr4/org/apache/druid/math/expr/antlr/Expr.g4">Expr.g4</a></strong></li>
</ul>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt=""></a></td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>语言</category>
      </categories>
      <tags>
        <tag>Antlr</tag>
      </tags>
  </entry>
  <entry>
    <title>Apache Calcite：一款开源 SQL 解析工具</title>
    <url>/posts/201018/</url>
    <content><![CDATA[<h2 id="Apache-Calcite-是什么？"><a href="#Apache-Calcite-是什么？" class="headerlink" title="Apache Calcite 是什么？"></a>Apache Calcite 是什么？</h2><blockquote>
<p><strong><a href="https://github.com/apache/calcite">Apache Calcite</a></strong>™ is a dynamic data management framework.</p>
</blockquote>
<p><img data-src="/picture/calcite/calcite_mountain.jpg" alt="Calcite Mountain"></p>
<center>（图片来源：<a href="https://pixabay.com/photos/landscape-travertine-pamukkale-2380833/" target="_blank">Pixabay</a>™ 官网，已确认无版权）</center>






<h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><h3 id="Catelog"><a href="#Catelog" class="headerlink" title="Catelog"></a>Catelog</h3><p>　用于定义 SQL 语义相关的元数据与命名空间</p>
<h3 id="SQL-Parser"><a href="#SQL-Parser" class="headerlink" title="SQL Parser"></a>SQL Parser</h3><p>　负责将 SQL 转化成 AST（<strong>A</strong>bstract <strong>S</strong>yntax <strong>T</strong>ree）</p>
<h3 id="SQL-Validator"><a href="#SQL-Validator" class="headerlink" title="SQL Validator"></a>SQL Validator</h3><p>　负责通过 Catalog 对 AST 进行校证</p>
<h3 id="Query-Optimizer"><a href="#Query-Optimizer" class="headerlink" title="Query Optimizer"></a>Query Optimizer</h3><p>　负责将 AST 转化成物理执行计划、优化物理执行计划</p>
<h3 id="SQL-Generator"><a href="#SQL-Generator" class="headerlink" title="SQL Generator"></a>SQL Generator</h3><p>　负责将物理执行计划反向转化成 SQL 语句</p>
<h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2><ul>
<li>支持标准 SQL 语言</li>
<li>通过适配器（<a href="https://calcite.apache.org/docs/adapter.html">Adapter</a>）可以支持连接任何数据源</li>
<li>支持丰富的关系代数（并集、交集、连接、笛卡尔积等）</li>
<li>支持对逻辑规划规则进行定制（例如 Filter 下推）</li>
<li>支持成本模型优化（<strong>CBO</strong>, <strong>C</strong>ost-<strong>B</strong>ased <strong>O</strong>ptimizer 和 <strong>RBO</strong>, <strong>R</strong>ule-<strong>B</strong>ased <strong>O</strong>ptimizer）</li>
<li>支持管理物化视图（<a href="https://calcite.apache.org/docs/materialized_views.html">Materialized view</a>）</li>
<li>支持查询流式数据</li>
<li>稳定可靠（开发迭代 10 年以上）</li>
<li>已贡献给 Apache 基金会（于 2013 年）</li>
<li>开源社区活跃（<a href="https://yuzhouwan.com/posts/5845/">Apache Druid</a>、Apache Hive、Apache Drill、<a href="https://yuzhouwan.com/posts/20644/">Apache Flink</a>、<a href="https://yuzhouwan.com/posts/45888/#Phoenix-%E5%91%BD%E4%BB%A4">Apache Phoenix</a> 等项目均在使用）</li>
</ul>
<div class="note success">Apache Calcite 借助开源的 JavaCC 完成 SQL 解析，将 SQL 语句转化为 Java 代码</div>
<div class="note success">Apache Calcite 还使用了轻量级 Janino 编译运行时 Java 代码，以便灵活地管理元数据</div>

<a id="more"></a>
<h2 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h2><h3 id="整体架构"><a href="#整体架构" class="headerlink" title="整体架构"></a>整体架构</h3><p><img data-src="/picture/calcite/apache_calcite_architecture.jpg" alt="Apache Calcite Architecture"></p>
<center>（图片来源：<a href="https://arxiv.org/pdf/1802.10233.pdf" target="_blank">arxiv.org</a>™）</center>



<h3 id="专注的层面"><a href="#专注的层面" class="headerlink" title="专注的层面"></a>专注的层面</h3><pre class="mermaid">graph TD

query_language(fa:fa-language Query Language)
query_optimization(fa:fa-fast-forward Query Optimization)
query_execution(fa:fa-spinner Query Execution)
data_management(fa:fa-cog Data Management)
data_storage(fa:fa-database Data Storage)

query_language ==&gt; query_optimization
query_optimization ==&gt; query_execution
query_execution ==&gt; data_management
data_management ==&gt; data_storage

style data_management fill:#808080
style data_storage fill:#808080</pre>

<div class="note info">其中，数据管理和存储，交由第三方计算和存储引擎实现</div>



<h3 id="解析流程"><a href="#解析流程" class="headerlink" title="解析流程"></a>解析流程</h3><pre class="mermaid">graph LR

SQL[SQL]
Parser(fa:fa-align-left Parser)
AST[AST]
Validate(fa:fa-check-square-o Validate)
RelNode[RelNode]
Optimize(fa:fa-fast-forward Optimize)
Plan[Plan]
Execute(fa:fa-spinner Execute)

SQL --&gt; Parser
Parser --&gt; AST
AST --&gt; Validate
Validate --&gt; RelNode
RelNode --&gt; Optimize
Optimize --&gt; Plan
Plan --&gt; Execute

style Parser fill:#0099FF
style Validate fill:#0099FF
style Optimize fill:#0099FF
style Execute fill:#0099FF</pre>



<h3 id="RBO"><a href="#RBO" class="headerlink" title="RBO"></a>RBO</h3><h3 id="谓词下推"><a href="#谓词下推" class="headerlink" title="谓词下推"></a>谓词下推</h3><pre class="mermaid">graph BT

Set1(fa:fa-table Set1)
Set2(fa:fa-table Set2)
Join(fa:fa-compress Join)
Filter(fa:fa-filter Filter)
Set1'(fa:fa-table Set1)
Set2'(fa:fa-table Set2)
Join'(fa:fa-compress Join)
Filter'(fa:fa-filter Filter)

Set1 --&gt; Join
Set2 ==&gt; Join
Join ==&gt; Filter

Set1' --&gt; Join'
Set2' ==&gt; Filter'
Filter' ==&gt; Join'

style Filter fill:#009933
style Filter' fill:#009933</pre>

<h3 id="列裁剪"><a href="#列裁剪" class="headerlink" title="列裁剪"></a>列裁剪</h3><pre class="mermaid">graph BT

Set1(fa:fa-table Set1)
Set2(fa:fa-table Set2)
Join(fa:fa-compress Join on Set1.id == Set2.id)
Res(fa:fa-table Set1.name, Set1.age)
Set1'(fa:fa-table Set1)
Set2'(fa:fa-table Set2)
Crop'(fa:fa-cut Crop and only keep id)
Join'(fa:fa-compress Join on Set1.id == Set2.id)
Res'(fa:fa-table Set1.name, Set1.age)

Set1 --&gt; Join
Set2 ==&gt; Join
Join ==&gt; Res

Set1' --&gt; Join'
Set2' ==&gt; Crop'
Crop' ==&gt; Join'
Join' ==&gt; Res'

style Crop' fill:#009933</pre>

<h3 id="常量折叠"><a href="#常量折叠" class="headerlink" title="常量折叠"></a>常量折叠</h3><pre class="mermaid">graph BT

Set1(fa:fa-table Set1)
Set2(fa:fa-table Set2)
Join(fa:fa-compress Join)
Res(fa:fa-table Set1.name, Set1.age, 1024 + 996)
Set1'(fa:fa-table Set1)
Set2'(fa:fa-table Set2)
Join'(fa:fa-compress Join)
Res'(fa:fa-table Set1.name, Set1.age, 2020)

Set1 --&gt; Join
Set2 --&gt; Join
Join --&gt; Res

Set1' --&gt; Join'
Set2' --&gt; Join'
Join' --&gt; Res'

style Res' fill:#009933</pre>



<h3 id="比对"><a href="#比对" class="headerlink" title="比对"></a>比对</h3><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">查询语言</th>
<th style="text-align:center">JDBC</th>
<th style="text-align:center">SQL 解析与校验</th>
<th style="text-align:center">Relational Algebra</th>
<th style="text-align:center">Execution Engine</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><strong>Apache Drill</strong></td>
<td style="text-align:center">SQL</td>
<td style="text-align:center">✔</td>
<td style="text-align:center">✔</td>
<td style="text-align:center">✔</td>
<td style="text-align:center">Native</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://yuzhouwan.com/posts/5845/"><strong>Apache Druid</strong></a></td>
<td style="text-align:center">SQL</td>
<td style="text-align:center">✔</td>
<td style="text-align:center">✔</td>
<td style="text-align:center">✔</td>
<td style="text-align:center">Native</td>
</tr>
<tr>
<td style="text-align:center"><strong>Apache Phoenix</strong></td>
<td style="text-align:center">SQL</td>
<td style="text-align:center">✔</td>
<td style="text-align:center">✔</td>
<td style="text-align:center">✔</td>
<td style="text-align:center"><a href="https://yuzhouwan.com/posts/45888/">Apache HBase</a></td>
</tr>
<tr>
<td style="text-align:center"><strong>Apache Solr</strong></td>
<td style="text-align:center">SQL</td>
<td style="text-align:center">✔</td>
<td style="text-align:center">✔</td>
<td style="text-align:center">✔</td>
<td style="text-align:center">Native, Enumerable, <a href="https://yuzhouwan.com/posts/22654/#Lucene-1">Apache Lucene</a></td>
</tr>
<tr>
<td style="text-align:center"><a href="https://yuzhouwan.com/posts/25015/"><strong>Apache Storm</strong></a></td>
<td style="text-align:center">SQL</td>
<td style="text-align:center">✔</td>
<td style="text-align:center">✔</td>
<td style="text-align:center">✔</td>
<td style="text-align:center">Native</td>
</tr>
<tr>
<td style="text-align:center"><strong>Apache Kylin</strong></td>
<td style="text-align:center">SQL</td>
<td style="text-align:center">✔</td>
<td style="text-align:center">✔</td>
<td style="text-align:center"></td>
<td style="text-align:center">Enumerable, Apache HBase</td>
</tr>
<tr>
<td style="text-align:center"><strong>MapD</strong></td>
<td style="text-align:center">SQL</td>
<td style="text-align:center"></td>
<td style="text-align:center">✔</td>
<td style="text-align:center">✔</td>
<td style="text-align:center">Native</td>
</tr>
<tr>
<td style="text-align:center"><strong>Lingual</strong></td>
<td style="text-align:center">SQL</td>
<td style="text-align:center"></td>
<td style="text-align:center">✔</td>
<td style="text-align:center">✔</td>
<td style="text-align:center">Cascading</td>
</tr>
<tr>
<td style="text-align:center"><strong>Apache Hive</strong></td>
<td style="text-align:center">SQL</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center">✔</td>
<td style="text-align:center">Apache Tez, <a href="https://yuzhouwan.com/posts/4735/">Apache Spark</a></td>
</tr>
<tr>
<td style="text-align:center"><strong>Qubole Quark</strong></td>
<td style="text-align:center">SQL</td>
<td style="text-align:center">✔</td>
<td style="text-align:center">✔</td>
<td style="text-align:center">✔</td>
<td style="text-align:center">Apache Hive, <a href="https://yuzhouwan.com/posts/200906/">Presto</a></td>
</tr>
<tr>
<td style="text-align:center"><strong>Apache Apex</strong></td>
<td style="text-align:center">Streaming SQL</td>
<td style="text-align:center">✔</td>
<td style="text-align:center">✔</td>
<td style="text-align:center">✔</td>
<td style="text-align:center">Native</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://yuzhouwan.com/posts/20644/"><strong>Apache Flink</strong></a></td>
<td style="text-align:center">Streaming SQL</td>
<td style="text-align:center">✔</td>
<td style="text-align:center">✔</td>
<td style="text-align:center">✔</td>
<td style="text-align:center">Native</td>
</tr>
<tr>
<td style="text-align:center"><strong>Apache Samza</strong></td>
<td style="text-align:center">Streaming SQL</td>
<td style="text-align:center">✔</td>
<td style="text-align:center">✔</td>
<td style="text-align:center">✔</td>
<td style="text-align:center">Native</td>
</tr>
</tbody>
</table>
</div>
<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> --depth 1 --single-branch --branch master https://github.com/apache/calcite.git</span><br></pre></td></tr></tbody></table></figure>
<h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> calcite/example/csv</span><br><span class="line">$ ./sqlline</span><br></pre></td></tr></tbody></table></figure>
<h3 id="链接"><a href="#链接" class="headerlink" title="链接"></a>链接</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">sqlline&gt; !connect jdbc:calcite:model=src/<span class="built_in">test</span>/resources/model.json admin admin</span><br></pre></td></tr></tbody></table></figure>
<h3 id="展示所有-Tables"><a href="#展示所有-Tables" class="headerlink" title="展示所有 Tables"></a>展示所有 Tables</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">0: jdbc:calcite:model=src/<span class="built_in">test</span>/resources/mode&gt; !tables</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">+-----------+-------------+------------+--------------+---------+----------+------------+-----------+---------------------------+----------------+</span><br><span class="line">| TABLE_CAT | TABLE_SCHEM | TABLE_NAME |  TABLE_TYPE  | REMARKS | TYPE_CAT | TYPE_SCHEM | TYPE_NAME | SELF_REFERENCING_COL_NAME | REF_GENERATION |</span><br><span class="line">+-----------+-------------+------------+--------------+---------+----------+------------+-----------+---------------------------+----------------+</span><br><span class="line">|           | SALES       | DEPTS      | TABLE        |         |          |            |           |                           |                |</span><br><span class="line">|           | SALES       | EMPS       | TABLE        |         |          |            |           |                           |                |</span><br><span class="line">|           | SALES       | SDEPTS     | TABLE        |         |          |            |           |                           |                |</span><br><span class="line">|           | metadata    | COLUMNS    | SYSTEM TABLE |         |          |            |           |                           |                |</span><br><span class="line">|           | metadata    | TABLES     | SYSTEM TABLE |         |          |            |           |                           |                |</span><br><span class="line">+-----------+-------------+------------+--------------+---------+----------+------------+-----------+---------------------------+----------------+</span><br></pre></td></tr></tbody></table></figure>
<h3 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h3><figure class="highlight"><table><tbody><tr><td class="code"><pre><span class="line">0: jdbc:calcite:model=src/test/resources/mode&gt; SELECT * FROM emps;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">+-------+-------+--------+--------+---------------+-------+------+---------+---------+------------+</span><br><span class="line">| EMPNO | NAME  | DEPTNO | GENDER |     CITY      | EMPID | AGE  | SLACKER | MANAGER |  JOINEDAT  |</span><br><span class="line">+-------+-------+--------+--------+---------------+-------+------+---------+---------+------------+</span><br><span class="line">| 100   | Fred  | 10     |        |               | 30    | 25   | <span class="literal">true</span>    | <span class="literal">false</span>   | 1996-08-03 |</span><br><span class="line">| 110   | Eric  | 20     | M      | San Francisco | 3     | 80   |         | <span class="literal">false</span>   | 2001-01-01 |</span><br><span class="line">| 110   | John  | 40     | M      | Vancouver     | 2     | null | <span class="literal">false</span>   | <span class="literal">true</span>    | 2002-05-03 |</span><br><span class="line">| 120   | Wilma | 20     | F      |               | 1     | 5    |         | <span class="literal">true</span>    | 2005-09-07 |</span><br><span class="line">| 130   | Alice | 40     | F      | Vancouver     | 2     | null | <span class="literal">false</span>   | <span class="literal">true</span>    | 2007-01-01 |</span><br><span class="line">+-------+-------+--------+--------+---------------+-------+------+---------+---------+------------+</span><br><span class="line">5 rows selected (1.266 seconds)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Join"><a href="#Join" class="headerlink" title="Join"></a>Join</h3><figure class="highlight"><table><tbody><tr><td class="code"><pre><span class="line">0: jdbc:calcite:model=src/test/resources/mode&gt; SELECT d.name, COUNT(*)</span><br><span class="line">. . . . . . . . . . . . . . . . . . semicolon&gt; FROM emps AS e</span><br><span class="line">. . . . . . . . . . . . . . . . . . semicolon&gt; JOIN depts AS d ON e.deptno = d.deptno</span><br><span class="line">. . . . . . . . . . . . . . . . . . semicolon&gt; GROUP BY d.name;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">+-----------+--------+</span><br><span class="line">|   NAME    | EXPR<span class="variable">$1</span> |</span><br><span class="line">+-----------+--------+</span><br><span class="line">| Sales     | 1      |</span><br><span class="line">| Marketing | 2      |</span><br><span class="line">+-----------+--------+</span><br><span class="line">2 rows selected (0.336 seconds)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="内置函数"><a href="#内置函数" class="headerlink" title="内置函数"></a>内置函数</h3><figure class="highlight"><table><tbody><tr><td class="code"><pre><span class="line">0: jdbc:calcite:model=src/test/resources/mode&gt; VALUES CHAR_LENGTH('Hello, ' || 'world!');</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">+--------+</span><br><span class="line">| EXPR<span class="variable">$0</span> |</span><br><span class="line">+--------+</span><br><span class="line">| 13     |</span><br><span class="line">+--------+</span><br><span class="line">1 row selected (0.092 seconds)</span><br></pre></td></tr></tbody></table></figure>
<h2 id="社区发展"><a href="#社区发展" class="headerlink" title="社区发展"></a>社区发展</h2><h3 id="Star-趋势"><a href="#Star-趋势" class="headerlink" title="Star 趋势"></a>Star 趋势</h3><p><img data-src="/picture/calcite/apache_calcite_star_history.jpg" alt="Apache Calcite Star History"></p>
<center>（图片来源：<a href="https://star-history.t9t.io/#apache/calcite&amp;apache/drill&amp;prestodb/presto&amp;prestosql/presto" target="_blank">star-history.t9t.io</a>™ 官网）</center>

<h3 id="个人贡献"><a href="#个人贡献" class="headerlink" title="个人贡献"></a>个人贡献</h3><ul>
<li><a href="https://github.com/apache/calcite/pulls?q=is%3Apr+author%3Aasdf2014">Pull Request</a></li>
</ul>
<p>　详见：《<a href="https://yuzhouwan.com/posts/19631/">如何成为 Apache 的 PMC</a>》</p>
<h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><h3 id="Doc"><a href="#Doc" class="headerlink" title="Doc"></a>Doc</h3><ul>
<li><a href="https://calcite.apache.org/docs/">Apache Calcite</a></li>
</ul>
<h3 id="Paper"><a href="#Paper" class="headerlink" title="Paper"></a>Paper</h3><ul>
<li><a href="https://arxiv.org/pdf/1802.10233.pdf">Apache Calcite: A Foundational Framework for Optimized Query Processing Over Heterogeneous Data Sources</a></li>
<li><a href="https://www.cse.iitb.ac.in/infolab/Data/Courses/CS632/Papers/Volcano-graefe.pdf">The Volcano Optimizer Generator: Extensibility and Efficient Search</a></li>
<li><a href="https://15721.courses.cs.cmu.edu/spring2018/papers/15-optimizer1/graefe-ieee1995.pdf">The Cascades Framework for Query Optimization</a></li>
</ul>
<h3 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h3><ul>
<li><a href="https://github.com/javacc/javacc">JavaCC: The most popular parser generator for use with Java applications</a></li>
<li><a href="https://github.com/janino-compiler/janino">Janino is a super-small, super-fast Java™ compiler</a></li>
<li><a href="https://issues.apache.org/jira/projects/CALCITE">Apache Calcite Jira</a></li>
</ul>
<h3 id="Blog"><a href="#Blog" class="headerlink" title="Blog"></a>Blog</h3><h4 id="Apache-Calcite"><a href="#Apache-Calcite" class="headerlink" title="Apache Calcite"></a>Apache Calcite</h4><ul>
<li><a href="https://www.slideshare.net/JordanHalterman/introduction-to-apache-calcite">Introduction to Apache Calcite</a></li>
<li><a href="https://www.jianshu.com/p/2dfbd71b7f0f">Apache Calcite 简介</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/67560995">Apache Calcite 为什么能这么流行</a></li>
<li><a href="https://blog.csdn.net/QXC1281/article/details/89060701">Apache Calcite 教程 - 关系代数</a></li>
<li><a href="https://www.cnblogs.com/listenfwind/p/13192259.html">深入浅出 Calcite 与 SQL CBO（Cost-Based Optimizer）优化</a></li>
</ul>
<h4 id="JavaCC"><a href="#JavaCC" class="headerlink" title="JavaCC"></a>JavaCC</h4><ul>
<li>JavaCC、解析树和 XQuery 语法，<a href="https://www.ibm.com/developerworks/cn/xml/x-javacc/part1/index.html">第 1 部分</a> &amp; <a href="https://www.ibm.com/developerworks/cn/xml/x-javacc/part2/index.html">第 2 部分</a></li>
</ul>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt=""></a></td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>SQL</category>
      </categories>
      <tags>
        <tag>Apache Calcite</tag>
        <tag>JavaCC</tag>
        <tag>Janino</tag>
        <tag>SQL</tag>
      </tags>
  </entry>
  <entry>
    <title>Aapche Drill：一款分布式查询引擎</title>
    <url>/posts/201025/</url>
    <content><![CDATA[<h2 id="Aapche-Drill-是什么？"><a href="#Aapche-Drill-是什么？" class="headerlink" title="Aapche Drill 是什么？"></a>Aapche Drill 是什么？</h2><blockquote>
<p><strong><a href="https://github.com/apache/drill">Apache Drill</a></strong>™ is a distributed MPP query layer that supports SQL and alternative query languages against NoSQL and Hadoop data storage systems. It was inspired in part by <a href="http://research.google.com/pubs/pub36632.html">Google’s Dremel</a>.</p>
</blockquote>
<p><img data-src="/picture/drill/drill.jpg" alt="Drill"></p>
<center>（图片来源：<a href="https://www.pexels.com/zh-cn/photo/87236/" target="_blank">Pexels</a>™ 官网，已确认无版权）</center>





<h2 id="优缺点"><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h2><h3 id="优势"><a href="#优势" class="headerlink" title="优势"></a>优势</h3><ul>
<li>支持自定义的嵌套数据结构</li>
<li>兼容 Hive（包括 Hive 的 UDF，且支持自定义 UDF）</li>
<li>高性能、低延迟的 SQL 查询</li>
<li>支持多数据源（插件化，包括 <a href="https://yuzhouwan.com/posts/26002/">Apache Kafka</a>、<a href="https://yuzhouwan.com/posts/45888/">Apache HBase</a>、Apache Hive、OpenTSDB、S3 <a href="https://drill.apache.org/docs/connect-a-data-source-introduction/">等</a>）</li>
</ul>
<div class="note info">UDF（User Defined Funcation）：用户定义普通函数，只作用于单行记录</div>
<div class="note info">UDAF（User Defined Aggregation Funcation）：用户定义聚合函数，只作用于多行记录</div>
<div class="note info">UDTF（User Defined Table Generating Funcation）：用户定义表生成函数，可以输入一行记录输出多行记录</div>

<h3 id="劣势"><a href="#劣势" class="headerlink" title="劣势"></a>劣势</h3><ul>
<li>与标准 SQL 略有不同</li>
<li>外部依赖较多（基于 <a href="https://yuzhouwan.com/posts/31915/">Apache ZooKeeper</a> 实现分布式、基于 <a href="https://yuzhouwan.com/posts/201018/">Apache Calcite</a> 实现 SQL 解析）</li>
<li>比较小众，相关资料缺乏</li>
</ul>
<a id="more"></a>
<h2 id="比对"><a href="#比对" class="headerlink" title="比对"></a>比对</h2><h3 id="Apache-Drill-vs-Presto"><a href="#Apache-Drill-vs-Presto" class="headerlink" title="Apache Drill vs Presto"></a>Apache Drill vs Presto</h3><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">Apache Drill</th>
<th style="text-align:center">Presto</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><strong>针对领域</strong></td>
<td style="text-align:center">非关系型数据库</td>
<td style="text-align:center">分布式数据库</td>
</tr>
<tr>
<td style="text-align:center"><strong>企业级</strong></td>
<td style="text-align:center">✔</td>
<td style="text-align:center">✔</td>
</tr>
<tr>
<td style="text-align:center"><strong>成功案例</strong></td>
<td style="text-align:center">MapR™</td>
<td style="text-align:center">Teradata™</td>
</tr>
<tr>
<td style="text-align:center"><strong>部署</strong></td>
<td style="text-align:center">较繁琐</td>
<td style="text-align:center">较快捷</td>
</tr>
</tbody>
</table>
</div>
<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a><a href="https://www.apache.org/dyn/closer.cgi?path=/drill/drill-1.18.0/apache-drill-1.18.0.tar.gz">下载</a></h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ wget https://mirror.bit.edu.cn/apache/drill/drill-1.18.0/apache-drill-1.18.0.tar.gz</span><br><span class="line">$ tar zxvf apache-drill-1.18.0.tar.gz</span><br><span class="line">$ ln -s apache-drill-1.18.0 drill</span><br><span class="line">$ <span class="built_in">cd</span> drill</span><br></pre></td></tr></tbody></table></figure>
<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ bin/drill-embedded</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">Apache Drill 1.18.0</span><br><span class="line"><span class="string">"In Drill We Trust."</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="展示所有-Tables"><a href="#展示所有-Tables" class="headerlink" title="展示所有 Tables"></a>展示所有 Tables</h3><figure class="highlight"><table><tbody><tr><td class="code"><pre><span class="line">apache drill&gt; !tables</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">+-----------+--------------------+----------------------+--------------+---------+----------+------------+-----------+---------------------------+----------------+</span><br><span class="line">| TABLE_CAT |    TABLE_SCHEM     |      TABLE_NAME      |  TABLE_TYPE  | REMARKS | TYPE_CAT | TYPE_SCHEM | TYPE_NAME | SELF_REFERENCING_COL_NAME | REF_GENERATION |</span><br><span class="line">+-----------+--------------------+----------------------+--------------+---------+----------+------------+-----------+---------------------------+----------------+</span><br><span class="line">| DRILL     | information_schema | CATALOGS             | SYSTEM TABLE | null    | null     | null       | null      | null                      | null           |</span><br><span class="line">| DRILL     | information_schema | COLUMNS              | SYSTEM TABLE | null    | null     | null       | null      | null                      | null           |</span><br><span class="line">| DRILL     | information_schema | FILES                | SYSTEM TABLE | null    | null     | null       | null      | null                      | null           |</span><br><span class="line">| DRILL     | information_schema | PARTITIONS           | SYSTEM TABLE | null    | null     | null       | null      | null                      | null           |</span><br><span class="line">| DRILL     | information_schema | SCHEMATA             | SYSTEM TABLE | null    | null     | null       | null      | null                      | null           |</span><br><span class="line">| DRILL     | information_schema | TABLES               | SYSTEM TABLE | null    | null     | null       | null      | null                      | null           |</span><br><span class="line">| DRILL     | information_schema | VIEWS                | SYSTEM TABLE | null    | null     | null       | null      | null                      | null           |</span><br><span class="line">| DRILL     | sys                | boot                 | SYSTEM TABLE | null    | null     | null       | null      | null                      | null           |</span><br><span class="line">| DRILL     | sys                | connections          | SYSTEM TABLE | null    | null     | null       | null      | null                      | null           |</span><br><span class="line">| DRILL     | sys                | drillbits            | SYSTEM TABLE | null    | null     | null       | null      | null                      | null           |</span><br><span class="line">| DRILL     | sys                | <span class="built_in">functions</span>            | SYSTEM TABLE | null    | null     | null       | null      | null                      | null           |</span><br><span class="line">| DRILL     | sys                | internal_options     | SYSTEM TABLE | null    | null     | null       | null      | null                      | null           |</span><br><span class="line">| DRILL     | sys                | internal_options_old | SYSTEM TABLE | null    | null     | null       | null      | null                      | null           |</span><br><span class="line">| DRILL     | sys                | memory               | SYSTEM TABLE | null    | null     | null       | null      | null                      | null           |</span><br><span class="line">| DRILL     | sys                | options              | SYSTEM TABLE | null    | null     | null       | null      | null                      | null           |</span><br><span class="line">| DRILL     | sys                | options_old          | SYSTEM TABLE | null    | null     | null       | null      | null                      | null           |</span><br><span class="line">| DRILL     | sys                | profiles             | SYSTEM TABLE | null    | null     | null       | null      | null                      | null           |</span><br><span class="line">| DRILL     | sys                | profiles_json        | SYSTEM TABLE | null    | null     | null       | null      | null                      | null           |</span><br><span class="line">| DRILL     | sys                | threads              | SYSTEM TABLE | null    | null     | null       | null      | null                      | null           |</span><br><span class="line">| DRILL     | sys                | version              | SYSTEM TABLE | null    | null     | null       | null      | null                      | null           |</span><br><span class="line">+-----------+--------------------+----------------------+--------------+---------+----------+------------+-----------+---------------------------+----------------+</span><br></pre></td></tr></tbody></table></figure>
<h3 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h3><figure class="highlight"><table><tbody><tr><td class="code"><pre><span class="line">apache drill&gt; select * from cp.`employee.json` limit 2;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">+-------------+-----------------+------------+-----------+-------------+--------------------+----------+---------------+------------+-----------------------+---------+---------------+-----------------+----------------+--------+-------------------+</span><br><span class="line">| employee_id |    full_name    | first_name | last_name | position_id |   position_title   | store_id | department_id | birth_date |       hire_date       | salary  | supervisor_id | education_level | marital_status | gender |  management_role  |</span><br><span class="line">+-------------+-----------------+------------+-----------+-------------+--------------------+----------+---------------+------------+-----------------------+---------+---------------+-----------------+----------------+--------+-------------------+</span><br><span class="line">| 1           | Sheri Nowmer    | Sheri      | Nowmer    | 1           | President          | 0        | 1             | 1961-08-26 | 1994-12-01 00:00:00.0 | 80000.0 | 0             | Graduate Degree | S              | F      | Senior Management |</span><br><span class="line">| 2           | Derrick Whelply | Derrick    | Whelply   | 2           | VP Country Manager | 0        | 1             | 1915-07-03 | 1994-12-01 00:00:00.0 | 40000.0 | 1             | Graduate Degree | M              | M      | Senior Management |</span><br><span class="line">+-------------+-----------------+------------+-----------+-------------+--------------------+----------+---------------+------------+-----------------------+---------+---------------+-----------------+----------------+--------+-------------------+</span><br><span class="line">2 rows selected (0.281 seconds)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="退出"><a href="#退出" class="headerlink" title="退出"></a>退出</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">apache drill&gt; !quit</span><br></pre></td></tr></tbody></table></figure>
<h2 id="踩过的坑"><a href="#踩过的坑" class="headerlink" title="踩过的坑"></a>踩过的坑</h2><h3 id="默认时区是-UTC"><a href="#默认时区是-UTC" class="headerlink" title="默认时区是 UTC"></a><a href="https://drill.apache.org/docs/data-type-conversion/#time-zone-limitation">默认时区是 UTC</a></h3><h4 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h4><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> to_timestamp(<span class="keyword">CONCAT</span>(<span class="string">`timestamp`</span>, <span class="string">' +0800'</span>), <span class="string">'YYYY-MM-dd HH:mm:ss.SSS Z'</span>) <span class="keyword">AS</span> tm <span class="keyword">FROM</span> <span class="string">`yuzhouwan`</span>.<span class="string">`blog`</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><h3 id="Doc"><a href="#Doc" class="headerlink" title="Doc"></a>Doc</h3><ul>
<li><a href="https://drill.apache.org/docs/drill-introduction/">Apache Drill Introduction</a></li>
<li><a href="https://drill.apache.org/docs/drill-query-execution/">Apache Drill Query Execution</a></li>
<li><a href="https://drill.apache.org/docs/reserved-keywords/">Apache Drill Keywords</a></li>
<li><a href="https://www.bookstack.cn/read/apache-drill-cn-1.4/README.md">Apache Drill 1.4 参考手册</a></li>
</ul>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt=""></a></td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>SQL</category>
      </categories>
      <tags>
        <tag>Apache Calcite</tag>
        <tag>SQL</tag>
        <tag>Aapche Drill</tag>
      </tags>
  </entry>
  <entry>
    <title>Apache Storm 与 Kafka 的整合应用</title>
    <url>/posts/25015/</url>
    <content><![CDATA[<p><br></p>
<p>　Apache Storm 和 Apache Kafka 相关知识，可以分别参考《<a href="https://yuzhouwan.com/posts/13977/">Apache Storm 简介</a>》和《<a href="https://yuzhouwan.com/posts/26002/">Apache Kafka 分布式消息队列框架</a>》</p>
<h2 id="搭建-Storm-和-Kafka-的基础环境"><a href="#搭建-Storm-和-Kafka-的基础环境" class="headerlink" title="搭建 Storm 和 Kafka 的基础环境"></a>搭建 Storm 和 Kafka 的基础环境</h2><h3 id="搭建-Storm-Kafka-集群"><a href="#搭建-Storm-Kafka-集群" class="headerlink" title="搭建 Storm / Kafka 集群"></a>搭建 <a href="https://yuzhouwan.com/posts/39683/#Storm">Storm</a> / <a href="https://yuzhouwan.com/posts/39683#Kafka">Kafka</a> 集群</h3><p>　具体安装步骤，详见我的另一篇博客《<a href="https://yuzhouwan.com/posts/39683/#Storm">Apache Eagle</a>》</p>
<h3 id="启动-Kafka"><a href="#启动-Kafka" class="headerlink" title="启动 Kafka"></a>启动 Kafka</h3><ul>
<li>Start the zookeeper and kafka server</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ bin/zookeeper-server-start.sh config/zookeeper.properties</span><br><span class="line">$ bin/kafka-server-start.sh config/server.properties</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Create a topic</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ bin/kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic my-replicated-topic</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>List topics</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ bin/kafka-topics.sh --list --zookeeper localhost:2181</span><br></pre></td></tr></tbody></table></figure>
<a id="more"></a>
<h2 id="发送-Message-往-Kafka"><a href="#发送-Message-往-Kafka" class="headerlink" title="发送 Message 往 Kafka"></a>发送 Message 往 Kafka</h2><h3 id="编写-SendMessageToKafka"><a href="#编写-SendMessageToKafka" class="headerlink" title="编写 SendMessageToKafka"></a>编写 SendMessageToKafka</h3><ul>
<li>根据 kafka 中 cluster 的属性，定义好 Producer</li>
<li>利用 <code>Producer.send(KeyedMessage)</code> 方法，将 <code>topic - message</code> 发送给 Kafka</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SendMessageToKafka</span> </span>{</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> Producer&lt;String, String&gt; producer;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>{</span><br><span class="line">    Properties props = <span class="keyword">new</span> Properties();</span><br><span class="line">    props.put(<span class="string">"zk.connect"</span>, <span class="string">"192.168.1.201:2181"</span>);</span><br><span class="line">    props.put(<span class="string">"serializer.class"</span>, <span class="string">"kafka.serializer.StringEncoder"</span>);</span><br><span class="line">    props.put(<span class="string">"metadata.broker.list"</span>, <span class="string">"192.168.1.201:9092"</span>);</span><br><span class="line">    ProducerConfig config = <span class="keyword">new</span> ProducerConfig(props);</span><br><span class="line">    producer = <span class="keyword">new</span> Producer&lt;String, String&gt;(config);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String... arg)</span> </span>{</span><br><span class="line">    init();</span><br><span class="line">    KeyedMessage&lt;String, String&gt; data = <span class="keyword">new</span> KeyedMessage&lt;String, String&gt;(<span class="string">"my-replicated-topic"</span>, <span class="string">"asdf2015"</span>);</span><br><span class="line">    producer.send(data);</span><br><span class="line">    producer.close();</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Run the main method</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">com.yuzhouwan.hadoop.customer_behaviour_analyse.kafka.SendMessageToKafka</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Check out the message that tht broker catched</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ bin/kafka-console-consumer.sh --zookeeper localhost:2181 --from-beginning --topic my-replicated-topic</span><br></pre></td></tr></tbody></table></figure>
<p>　Then, u will see that the <code>asdf2015</code> message was sent sucessfully.</p>
<h2 id="从-Kafka-中获得-Message"><a href="#从-Kafka-中获得-Message" class="headerlink" title="从 Kafka 中获得 Message"></a>从 Kafka 中获得 Message</h2><h3 id="编写-TestMessageScheme"><a href="#编写-TestMessageScheme" class="headerlink" title="编写 TestMessageScheme"></a>编写 TestMessageScheme</h3><ul>
<li>在 <code>deserialize(byte[])</code> 方法中将 message 显示</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestMessageScheme</span> <span class="keyword">implements</span> <span class="title">Scheme</span> </span>{</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> List&lt;Object&gt; <span class="title">deserialize</span><span class="params">(<span class="keyword">byte</span>[] ser)</span> </span>{</span><br><span class="line"></span><br><span class="line">    String msg;</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">      msg = <span class="keyword">new</span> String(ser, <span class="string">"UTF-8"</span>);</span><br><span class="line">      System.out.println(<span class="string">"$$$$$$$$$$$$$$"</span> + msg);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Values(msg);</span><br><span class="line">    } <span class="keyword">catch</span> (UnsupportedEncodingException e) {</span><br><span class="line">      LOGGER.error(<span class="string">"Can not parse the provide message from bytes."</span>);</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="编写-ShowKafkaMessageBolt"><a href="#编写-ShowKafkaMessageBolt" class="headerlink" title="编写 ShowKafkaMessageBolt"></a>编写 ShowKafkaMessageBolt</h3><ul>
<li>在 <code>prepare(Map, TopologyContext, OutputCollector)</code> 中得到 <code>OutputCollector</code>（emit 方法完成 message 的发射）、<code>Context</code>（提供 <code>name/id</code> 之类的属性）</li>
<li>在 <code>execute(Tuple)</code> 中完成 message 处理工作</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShowKafkaMessageBolt</span> <span class="keyword">implements</span> <span class="title">IRichBolt</span> </span>{</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> OutputCollector collector;</span><br><span class="line">  <span class="keyword">private</span> String name;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@SuppressWarnings("rawtypes")</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(Map stormConf, TopologyContext context, OutputCollector collector)</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>.collector = collector;</span><br><span class="line">    <span class="keyword">this</span>.name = context.getThisComponentId();</span><br><span class="line">    <span class="keyword">this</span>.id = context.getThisTaskId();</span><br><span class="line">    System.out.println(<span class="string">"Bolt: "</span> + name + <span class="string">" and Id: "</span> + id + <span class="string">" prepared ##################"</span>);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Tuple input)</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (input != <span class="keyword">null</span>) {</span><br><span class="line">      String message = input.getString(<span class="number">0</span>);</span><br><span class="line">      collector.emit(<span class="keyword">new</span> Values(message));</span><br><span class="line">      System.out.println(message);</span><br><span class="line">    }</span><br><span class="line">    collector.ack(input);</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="编写-BehaviourAnalyse"><a href="#编写-BehaviourAnalyse" class="headerlink" title="编写 BehaviourAnalyse"></a>编写 BehaviourAnalyse</h3><ul>
<li>基于 <a href="https://yuzhouwan.com/posts/31915/">ZooKeeper</a> 属性 定义 Broker</li>
<li>整合 broker、topic、zkRoot、spoutId 和 TestMessageScheme 为 SpoutConfig，完成 KafkaSpout 的实例化</li>
<li>利用 LocalCluster 完成 topology 的提交</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BehaviourAnalyse</span> </span>{</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line"></span><br><span class="line">    BrokerHosts brokerHosts = <span class="keyword">new</span> ZkHosts(<span class="string">"192.168.1.201:2181"</span>);</span><br><span class="line">    String topic = <span class="string">"my-replicated-topic"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * We can get the param from the 'config/zookeeper.properties' path.&lt;BR&gt;</span></span><br><span class="line"><span class="comment">      * # the directory where the snapshot is stored.&lt;BR&gt;</span></span><br><span class="line"><span class="comment">      * dataDir=/tmp/zookeeper</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">    String zkRoot = <span class="string">"/tmp/zookeeper"</span>;</span><br><span class="line">    String spoutId = <span class="string">"myKafka"</span>;</span><br><span class="line"></span><br><span class="line">    SpoutConfig spoutConfig = <span class="keyword">new</span> SpoutConfig(brokerHosts, topic, zkRoot,</span><br><span class="line">                                              spoutId);</span><br><span class="line">    spoutConfig.scheme = <span class="keyword">new</span> SchemeAsMultiScheme(<span class="keyword">new</span> TestMessageScheme());</span><br><span class="line"></span><br><span class="line">    TopologyBuilder builder = <span class="keyword">new</span> TopologyBuilder();</span><br><span class="line">    KafkaSpout kafkaSpout = <span class="keyword">new</span> KafkaSpout(spoutConfig);</span><br><span class="line">    builder.setSpout(<span class="string">"kafka-spout"</span>, kafkaSpout);</span><br><span class="line"></span><br><span class="line">    builder.setBolt(<span class="string">"show-message-bolt"</span>, <span class="keyword">new</span> ShowKafkaMessageBolt())</span><br><span class="line">      .shuffleGrouping(<span class="string">"kafka-spout"</span>);</span><br><span class="line"></span><br><span class="line">    Config conf = <span class="keyword">new</span> Config();</span><br><span class="line">    conf.setDebug(<span class="keyword">true</span>);</span><br><span class="line">    conf.put(Config.TOPOLOGY_MAX_SPOUT_PENDING, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    LocalCluster cluster = <span class="keyword">new</span> LocalCluster();</span><br><span class="line">    cluster.submitTopology(<span class="string">"Show-Message-From-Kafka"</span>, conf, builder.createTopology());</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>run the main method</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">com.yuzhouwan.hadoop.customer_behaviour_analyse.BehaviourAnalyse</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>start a kafka´s producer</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ bin/kafka-console-producer.sh --broker-list localhost:9092 --topic my-replicated-topic</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Input a sentence ending, like:</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">This is a message from kafka.</span><br></pre></td></tr></tbody></table></figure>
<p>　You will see the information which shows in console sucessfully :-)</p>
<h2 id="小技巧"><a href="#小技巧" class="headerlink" title="小技巧"></a>小技巧</h2><ul>
<li>Get the value of <code>metadata.broker.list</code></li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim config/producer.properties</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>查看 Storm 与其他框架的兼容版本</li>
</ul>
<p>　<a href="http://mvnrepository.com/artifact/org.apache.storm">http://mvnrepository.com/artifact/org.apache.storm</a></p>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt=""></a></td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>大数据</category>
      </categories>
      <tags>
        <tag>Apache Storm</tag>
        <tag>Apache Kafka</tag>
      </tags>
  </entry>
  <entry>
    <title>Apache OpenWhisk：一款高性能的开源 Serverless 云平台</title>
    <url>/posts/201008/</url>
    <content><![CDATA[<div id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">
  <div class="hbe-input-container">
  <input type="password" id="hbePass" placeholder="" />
    <label for="hbePass">Hey, password is required here.</label>
    <div class="bottom-line"></div>
  </div>
  <script id="hbeData" type="hbeData" data-hmacdigest="4840a77670dd7f3d684d1f302401fda95a603fbc96d7235f4f9d1f4f13b9e3c1">5afa538a4bb3e8abdaf2eb3701e26cbfa904c70dd5b15c4e7f6c466bd0627e3590a09d951346bf6c0229bdf3435c761996738802df06c11de236a770c3bb2cb6e5e4217d518fb44f3f9c18a763753e7f8cb8d6ad38fa5a53d0bdcba30cf8e9b656559aa3be5317f313dac45213796b6800b85fe692cb636f43eb9229417af2b4caebcff71a3bcf1c39abf7431a15049ea4cc2587856b81f057f4bfc1d3bbdbcf450143094044e492fab44a68a15c6a2a0fd771b0b1f7e83175e746086e852e1fc5faa59d8b5c21eddd9c4974f8451a3004847bd749b5bd898ed1ee567cd2ba99a03e77c6c828dd6c8a946de0e3d44ade663512c02ce7615c2c616783dd23d874be64d15450b7a688c275f9bee9ee31cdadb34d7ef0856b0b7b0d48021925ce2a9d3bbb8e22f796a07fd150000d32accd2e242684094201c9ad0963f3fb6855828d77b0d14f3f010e2abdd58a7bb0a8a05f684743292fe8d8ecf7e1b58a53134d531ec5deb85c26a142634492560f1631a56778b87f3512ef2c0b4d027cc784d8ac27786f2a7fdace33a0840fcbb0cc3cb40b05a66d711d318c169a77ad31aea4dd6b2488986ab610c9cd01ec60fa1c20669ea684ae73adb649b51f0e4b837cb3962cebaba2ce2ae63ede6a43714cec1058ea968465a1dc51a53033141f5f7129c17d2cf17c96486fef63afb85014c5df8b24722e20ca72bef7e0fda9add1e5b83e0c3b72d7677cd44ee8a5481bc5518a787ab6c315e8685215ccf9d6b80265dad3a3f984f54d98c3d4c95dc2540ada7c11da2c11c0ccb6bbc2285cff94d4ac5a44dce38cecb7fdff56787f7846a011f841e9e1eb60d0c48882459870ae4ee05111c2963932ddd2b68d3b9813ed02ddf506821af2a5f78a010ccc0c7a945dad45e6ecdbcad42527604ad54a8222481746974fce998545a5df89a23f14a0d7a419548057c66ca249491458a80e8562fef737bf391579cf1d52b3135fe41634cd968b7dee1052806af04fb525ce4335fcc29c45977d8b145959a9d6e81ddc44594fca6866dbb9f20f2136dda1409f791590b54180fb272acec066f8a261a3c634102e3779857709e001734f0d2879420d1e6ddf7558ea19c604a9a660d0063b1d6d2fcab425fb50d0389f318fca89ebe3aebe8a25a6ef0403545e5affeabce98988bcbeaa73057d602973cd87ab1f33ac6652aa152ff3f1a08c7c4c51a303e6a9c0ab3cc0ffb84813c06a5edb75ef36fec776a80ff0bb3db0a0db006e55c016b0eb82ced14ea5155dbf69864dfe4d09cfeea899a3d2fc04d6708aac9c9225cc37b92382a6141a9b58c81a4fe2403b86ece710031b3d12558744193a67f7f9af4a404d8b6c8c7b218b328fae3c21ff2514aec4fbdc6e5b1dde8d3c8e01b62350da2ef151a669f2274166d3fa9c4a73acaaf99ac876f61e0abf62e3b9c479f5dae0f8406d050c55818d03f8b8e9899d2e3f5950790b0b9d5b656fa96b11a9be25dc3b635eb383a57e56a0e617c922582b7c7903689a1ba8a8c609ff6878e6a7e283ab197f06aca8e63d1c8db532e0a69fc0b83e0efb27274f72f67145173f861965a349b69834806a3d13ef456d9e3bc9b112aa527764d060ed19dfe8cc8d71c02447b3e04638807f9f9e70f9d67d704c24791b267fffb716803f059c21c58a168f9994c94e259fc0cf73db764170582db24586288fe8a20452cea004dd23c9ee24abb564893853d4b8b893dcce51cfd7569a69d05edc6ae984009af97b1ac068c8ab4fa44740124e719c641868635217efdecafc869bbe6859da74ef641050fb9adedac5053067cc437fa961c9ba9b52f4d2c264bb01392a03c7e7bac1e1486a7f6a44b10b6b6fbeaa67ee32dac061572700920d69c1f7a2c9edc6061419de4f3a113f6efa499ea0477d9f7288287238b0a1d5fc2ab88c67e13758eb82858236a7afc50388d1be88b5431ed52d846d5f452df3611d689c49ed0e365f5f4647badb25b9704a6adef5fa5507ec7cf8020e1a77462889720d1b330dec25f1be53a68d049b1ca886cbec4900d7902fa9ab634ca6e6bdfec0110942250147452734bebe41a34533908f6e9537e98e6bf147e8f8246594cb09fd304b2de91b923bd067357d82e3fd6bebb9da695b61c1ff77e0f1f588c23d971b5d770307be177968243c935c5b2783ba3422dee94f59c4adf2a1be283f8f390f2d32062f737d03bf733a62b156b08859dbf979b8a00783d01c3b5e5bc9bac2d21d07c2c5216d9183e9de510f162aeb80c431ff14c201f53afb00571adca68d93059fb061a66010b92ff277a3802efb8a92e2b860009680016903fd6526e666e5c1833985c5f0c5bd6af8a83ff34a05376e677442eef810e874fab242d5d34b39e9e44518e7206abdadfad7216bf5feb22fe0f597a7b9938e36d9f6f7ab3f692aaf87b4f88ff112d95b9aa7b6bdd5584aa877846297f9ec5ee52634c62cc159047058a6d1545cbd829b4f206fe6644ac92d093707e3d6b0532ac911ab040c92b7b392220f37dea10a4ceb1bc7833ca3d0c0eded1e83673caf5590c9dda3278ea89ffa0d7d4d4746e1a01c0d97e71a91d6f89e6f0c9415ddbb4c965e4a240a4331ac3f356db04a32137017b292114b9f42b9e376936df645992b3700cc157f6c97d4a4ac34e06218ab7ece84ec21cd90234fb337c3ad0a51b8b0b367b049c16a9a1172e17d0e6aab1d4ad75a6bd50a7d3acc9d27379c691092781c8ef79cfc21b8211d4c302ac7fd671d615ef694aaa2afa87c14fec1185b52d64e3bc551396b3e3a6cc63d866046d2aa5b10f25e099877f976fe854ddfca75649751fc21fe04901ac6011aec76163d4c259a59042acc574840f066f0de172fec7ba95b37d0fe9248ac564fbbfcc96034cea96e10be30a0092617b07c638095d0e0e4c659257dfd3bb3fe4bfa6fb1f6b9d9b2a3def07fc3f16893e7668e83c5c24873ba8d7832c45c18968f5b327433b4a5896d4b65cbc4d52b79fe96776e089739eac867d35b2c84845f70affc8036970565f89cb23f093d712de989e77d49f49c174bd800b51a493f1be179540271a99ee39a23bbc3170fc1f8431fc9bd802bfd496beff22d66a7d5dd991a0b843431151f4351a4a63eea643bd53e574d61de028efdcbc6fbcfee784a78e1c24043028fef2b4243b9377a1e9bd38f1adb15d75ee75127922e5fde57f5dcee1a2e9720fa18a4be383cbd84f8a54e1c6165685d518df7a1a6046c5de10fd831b79e1c69332e5f4ed3eecb8eac6b1a7a90221b11e016e1ee6e6d8e0fbd3d5d540d82cc1407c5a701cb37aca58cf7ee24657318e0e191aa8a7d7868b4bdae25225f167eadeff68470323ba12ed1be915d85eb8ab21433db098ae46326c9bd3c70f28070327e83911a3e35256bc46a9c9e9cc469a4d5ccef1db756ad87bd9badd2a37f4d07542d4089163b7c4d359d8d6f900637ee355ae01ee32f10bcabb8b20b696bbf90122815fb8f6cfe3143c8b2226845815203e21c3f1d7ea2f390710d1c6bf629af57614137834dd9ecc6013e47c0b64eb7472a7f6e3bda16a65958b2db2ce687ef405e69ef536db26866d506f07249e5eb8efcec9679d27ce85d4156888aa01fb3e9682ada8dce56f5ec3647c5d19b0cd4db42fe49f444a210e7591bd0525ce6b41d5cc00b3e53855d7802212b26438a781ebc14ba7191d555e9be600e86783b1a6a2e0d5025de45b33ef6c48d0b81b001814a1472c1208342c8fa14abad6cfe9b16ea8cd98e732423a5c413fcc89e5be7f89162be89f5e77f2b26b26775a4bff4c8b7633aa6f2c97844baed2c3d23bf8f5f03214e926aa1e5fc5aea9e4bf846919c66a40e094deecce2f586161597a1df55c7e54c752b4163551ac47ce5d3623209026139d87aef4acd3be694b720b984fdac5fe6912edbcd838e55fa83613437dcd4bb70f6b74fa1cc5776953aae210d6e19ece7ecff17260dd8694cff0ec2cc185c2c0905ebc01579ea08b9d0db2fae3c0263418bcdafc05e0b6174e1d2208c8f0b44ed966fe0b07be59f0a47805fe52f54a4f25f5bb92251829952cec0e517a4299c89e1e2c88555c946ecfbecf1cf0e255e00f547c8774504c5af36bdc3f2a389525ff8bbecc8451d64cc72dc1ec75572ebdd3a662a8aac4e87283584e8a2c438d9cfdce2a1cbe3c6629a4b4a8084e09efdd8e773ea8754e2a25a6fef0ceaa832c552f38fab0698b6838f340995954b1e5121b5111e1692aefb645dfb130e46aff871d71ee6a628a4c0b037604cd34dd91e9f1a62f55f31661833a568261785c0d3ee5ee03097492ab2ecd7f44415eb0ee41468f0859681d23ac9edf2c4b241e6211223f22ad706f9fabcce44c4a45f02699d4d3d257ebaeb33f11b9ea81ff9e52725ce97485c94dfbcc6cb6925fd146edfa601e8317fcf8b0135f130679e0aa53c36179b6289910ce64773726da3f7ce3097c6134d00dc6d47f85865e2eb6d817a49384977d5a79770bcc9967f44e5b9fa1e46217383e62c7b15071d911b8150734bcdf59ec6739b1f643551dd801f6277427f5f3e1bfd9f8889b29dd28a10374b05f3da5bf337fad79768bc9ac1180f33ab79ce74d768dbfc520b5d3a4c871518b9845ee7942234c4f3ab7cded170e38c3f8534e8e641e6fc2e26e2c3ef5c5605ce6c50f415cc41fcab79e3b03da3dec71e9669fd2df15971b276f221e3d0810bde08af76b2ba73eb69a6847a06c56ed4abb0400ab0dd5e9ca4f7d26f84930ffef44dd0fbb626950e68ae0c8e7f7a6ae79e39f18396c60ffb1a58fc769230ea97fd0e6a6eecfaff3c075b25219ecc38b7443abf78048edc714483c874d6da596d0d3798650dbab2e3fd4245353013204dc4257234765063d5c02d38c25a867220b86f9cb473ee44d93f30a5ff4afdbd11fd541b1c66bb1389071fd55a5bed11870344243262d14ac02d71f965b4e2d9be9fff9c493d37e2c0d806e5c2f13ca0c4cce2c0911d3be85f355a78f21eb1ffbd489a8048bb4d46644a71d90100f29beb23c186b8ce7ff7554b39d6b631afbcdcc22045574414be05efbd9479c062ad5117118fafa0dadef5558927070c4b818f60a371c932f5e294a143bb40b73abc2d6ad3b1fd50bea78074cdb9506c59cbba3ba5ca0fdefcb28ee0c47ff16b8af2901159c03d0fec42c2f1f52d5344c9fa37bb5cab740c6726f1b530c471a2f175723e51fdc4516c2675a5c96d00bfa60a5672fad897fac94a4c911ca940dff2e70d01a16c7f3e71d3f9eeff58f88e57cd675131d51e321963d44ff2e39733739bb717c9cca60d235bc1c9fe6c23a84b91a643fd224eeae472c44bfe151dc49ab609f2c38b5ed90242bcfcbc6388408dbb0cff02d86d092af417e78cef51ab33c8a4ff34b69e92bd3d9410f5b34a3f393be6230d4f3b94cd4f90a04a584c47bcd242a9963cd29273bdafd5d1485c363731ea246c355b422776ff31c16f3c35b6e8195a2a700a68d6fcf5f3542cb253e639b5d8fc58a1608d83589e2501f1c01c829812a28e52a240132fc12ce701873aba76a13e0854cf2960c521a800eff8c138d3e25e6f5645113971f8711b7ee9b0a5221143cf6932398061dfb38a96313ae6827ffb09128f9bf27ca22d356b1c72fd14ceebcf453a66842c5ccdde6f0c8a0a95b63829d8a296691a0d7a29664e080ee2b85ff4b0f82413149b1133be69fbb5f8d52ad037ddcd6ce8824019d0e2c18e195274dc3a16d38ea000c7d8846c38f2e90e42177ce707ccf39cfff41b0a4a508f95923faf5efdd965c1eaad9cb9d98d0d6e3a028bbaddb422093e28d7518367cf5cd4a696df4a940c879b23f0fed5bff8ad81faca3e97241022e54d0008a48c07a489318f10307cb7bd290d7b07b3a0633fefeb895e3f1a7985e6bfdbd6efb1ea2c2864fa06ca162eba8ee0eef930a16bb64ef901cf593d7b0a201af44557e56d94144d060ac9a85d706df95d90e7e7569d838e4cbb15a2bb8397c7d851b568ab44ccb4b79fb94eae0d025caaa55a75036396d9ee2e159672f8185280893ed866e4c16e7ef9c2675697fac809c0de573e87951fae44ad1a062f24f89923f53c28bbc66e3e4353b7dcbf9895cafb7f0f4035d91dcb014606996b273048f8c397c0c3584a2f9ff17893bf97a2fb4ea9d446a03b75b605138432825fe6143f8110314ceeed5d4db6a21eee7119e902e5d0ef4836e16b241a539b23cca7287b379bb96c1b7c0cd2c7961930827cdf421d3b2c7a51bbbcb43dc8c1c2c2e049486c9816af11f357c2a073c90a442ebe21bbc894f23d94c21003e5ee4de94ea9229e24e1f2e9eb8494fbe2fd71a9ea779f882daae7565e5139846630945855e1841c6ff4934beeceede9bee7ddd5d19ab36293043ba24b0e11d3204f04eb8311501a511bea9cf2890b73aeb18041664e344d8afcbad8122da2e49fa72623ab69151a67bbeff1da9eda810aca06030dd5540f8eefee005320fda578070e8153df9463c3ccbb76d6a25465e49bd1be92d4d575a8c2c70062e3e2209070e97f0f53c4d56d52ced14193d0d983cc4f2547ac17a90bfc81ddb7b151ebde4809bec467c7a0b5d1caed1f8f04547542ee7814ba91d93d9d22248d0b5b4f096bbe8ff3331b74ff2ec806bbf97064435910d2796f83bb72661a0264df64a30f20f3e844e9e71da9cfb5549c3d6a377a6788ca4c466fd3d84bc4555274e3358b60c38b5ba3ad82367f4e2cea094c1bb0df82cf0711033a5cf4774ddd7029921307420bcdc52e39bf3bb0faa596a84a224a3edabdf2af9b24ab430e43f93ed03946a9ca646aae33a8bd3e3911327343e1e2d58960b5b3fd9efdeaad5d1f5e09cee38b273a960f8eec0aa584070db791bc5be31efdcb3c8017c28b60c160d54b59be2ff00f69a1b297dc6777671c23e2d36d4964cbd1042ec336f84a80f89b3921c559a2cfe107e9c18ed0f2b3f31326615275761b4b42aab6afaa90deb8ba0e1c07d6769e303868734cc95ad95826e612e0ec3c7f6780022f14562af00d01585df11d2180fa1676ac62cfc1b90795c7d2bdb74c93453e3a96211fe92dc9a6423ee9336f323beb3101617ec0534dda02a7ee1fe9dd4126e57e92e08768024fafb529e1b1b2251da4bfd282fef320138e85a6031ac5bc5e9b0d3cf949425e8904224f74afd9599b91989a54323417f995a14025e092dedecbb60a71d7e7fe4ca86300e7876674c848fd57895159eea75a6bee54162e310240742854e19f2b1325da135b2980a3bdda97d405612736c33a40a9e2b7b6cdd8b3ff997faf076433c52ad85c0f00293ed2513380f7f2c050a5efddff0184958a63d89596795fb86eba5794629f8fb3da1fc9b47242f956d7748eea24a8f4f89b94772d02c4036262279fbfd61fa544819b530d064c3297499af060d40a69408ef4feb8f9d2d4bdff26d1eb27eeb787480eb89de9545189f32ef883ff0f54bae80b231f4baadef9f2514d034c02b0a6fd52b2bfff16dc566324ef9c93165e26a5b439eab9e4670067f7ef7b49a8cf136e5e7a9ca4fe6e12fd16759b4ea9d8c6757dcf142e96f21f622c6fb6678b7affa41a168fc98f69d26a4ded7e995246fa09a39bb8a1019bfd514839db6250c0fe786fa15a1b190f1275ab763d4da87d36e80319a6a6e15d6684da1d1f4a5ffd417e7d3557e920f840362763917a1a9ae041008c390fc096b5720afc1832c79bb9a83be67aab8e0c60620afbc2acd002232cfd22a6898ecd0cd1e39caa278727c3fc1681ea003d18cc045ea8ace58d01ed2c8ac82b0ee89b0499b60ca0b080b616f7f7b915f6376e5fc211875ff7d60f884c3b044774e600d7f1323d8a0bcb3add5b9472a3d71730571f2e7da7283b03748769443d9a2c636cafc9066a031da2c5418cd9bb5f783d313cc32fdaad6c5c596c90bbe3080aae1337db855b7858733d543df73567cc24c83f213233adac96e9fca6910febb387b4923712fe0af6dae15790f14d1574681e359d113bd1f738359456184ae8b8d4418f8cee3c74d2b8f9f05e482f3ea75b68e11dd544f5b6559c1a4cbadd20aa72c96032031eddd6e4c33040a40161c1b6d70bc6f88c39a58a641c6db99562722e49b611a2dac9add3bb5dc2f8014c695cc1f2503a4ed231620af8857841465a1edf98b3886436f2365e2f6b8e610194655ddc7cf83005bc690d6283e1ba671c421d193357a3783daca79f1f588387e4de16101d1299a706ed04047be509e8686121c1b95c1fa3152fa7b5f90fc0bc02d3795b88aa167504e30997d93a46908e37794b6fb515963b19c85f8a51397f9aa0b5ad1eed4158fb2ce99028d7d6891b55a639e65fcb2f35dea3cacb90e54f031fe4f129008fbdf08b7270f3d29c818c2305c9379392dc2bbc48b6030f3905a78bb05c7b02db9da0abded1100a543aa9c55e560a49d4040e3edb226d326e76bdf114e8833d7206dd7fc840dac14aabdf51d40a1fd4d14157292d9d6f1fffcca6435cbe2f0f800fdc8df4cc3fa4be2a9f6ab9c8207dda792121f5152a4faaae6c63231283107fb6a814260f55e7b812ba75d34023be1f3c5f10df707a1634798c2aa491a409ffdd143d9f508ab06a55c164de48726b3d8ecf6642248a0dbd294191b6f65feeeac1ae737dc7028d6a7267bc0455a33db534ac0a9c99376a7dca6c63469217d0325152fdd8e05d63d0528d15089af57b53dbdbbd1231386aa9d15a01d8c9369537b078557088e383533f5f3cc08c50b2ceb5385b46931d82a5d5b617aaed2ab750cbe2ebcfcd47a38cfd1c273bd2e9af7c961fee1cf9486054c46c35536bc54cb27ca9120c8d8905c40628cd5ad90058d0ecf83caee956262689d3a28a64f303f161ad11597bc5c0474c8f0928eebf99ef3f668f03d606a911d9990b69b898423c32491f1262a1844ed75a7f92ce1e23d45172104469b6fa866675e630e1633e77643374cdab0dc916142ebf091d3492dbd5eabd426fc8ecd275f9044e46b771aeb05e2c57b816e61857fcdd24903ced2032b5ef4c813ee8aa5d638e67917647f744953bd26a8ab3c81f1b99f02a7640fc8109ef76fb85f62764319409875db21416936a6b2af87b4d632822b9198f7a152208e3027c0cf525750982ed2bd220916fb45ca3365aa7d15a9365875c937c2c00a5b94a9ab058e42ecdf8237b2a358014dae5772674199fceef7d73d7cc33302a8bf24fa97782c9147f38e160214fdb7d413a6dc802e6af1686d79cace13c92817dc2af6b586c79bc8ef576bde8c99798ff2e453e53dc46aa2dfe3ccc02f7e46ce3e6c996de41573f862250e3f745ea0c432f7b476b608a90dee8890b32c839e41e830a783d19eab7c31f4b1628196efd1637a5774eec0daf8f895023e90664bae1b3c02dd300a732439035d56cf3ba086878eb885f16303f27d51e1431ab4870665500c0596832fdbf71d24aefb4d08596270ecc267574548f7e32818d4b8ffc020244588e0b952252011f5b95f72cb47b744ec512fc83e1bed482df6d500b2fd2cb890022498852efccd3a49abd960b6617ad4c48a70ce75b281d0a858a4ace696bf6ca892a8d6e1d66e8a2a394c4d076f002b2d8afc16b49a6168180917655168b6ef44299accc91cd16844f04ca157a44c979d363b6267d49bb669679663cd648392d494b515fa1c9980aa90c6cd2bde10ad049af3e4fed03cc09bac80bc40510fa4954873397fbf66d3161ea3e126fa90c75358ca39772f0160f2162578fe1144d49b3f5265f89836c3a624fa61dbc9a0cbc5ffee23807cff50273504fa96bf1b13cb19e1e60bcd4bb60cc3b28230e77fa4033f2580081bbb2cd7431f4f6591d26ce0963f39fc4c7c154d45eb9c1b55db86799070a69be9ab1625acb8db1ca32bf58d8dfa0efa6af82dd24283414170006b62bd5ce78342ab985be2fa4a60785af874bd48b6efa7923e99fe3e0fc509ad9c058d6c344eb87cdc3d2e072eae6241b047f5dc85df518c6a02b20cdf58c2c3d5abe104e713d487485389d43cc766e6414fe568d5715482258ab4923a482028db67b3c1cb8e9448462410e76482946e6e9707baef10bf9f014de1ceabde2fb7ced0c8a8f6528b523c3dd707129017d2d012aaf22108298b5923c191a571f31273b1f9fb52f97d88a4117cee47d3e73c030f5ababd650b9dbf74f1b2c428ccd91dac6c9689bf47e8d0992895c361c3a070ba4c4d63a5a9257826e052bbba61b595d93b60a9cf114e95625f86d2c046bcd27acef3363acc3ec097b0a553ac506363eb24b926fd2623c7dab936c472b69cd6e6fdb62ee8c6cd8ab922c0e3c595afe0c2f08dd682c682b5e4ddb243fa366255899631072270de094308ee7e1ab79fcf37f528a40e89a834919efc0e05f1adff74b5c76e425d69b659cd875f57f2ea084a631b385f7aace53da1fd533f239eb24488658e5f1a47e9784c86e4d9ff43c71a091382778736bfdbe27d87edbcb2e64087eeca179331237f3d2a54b40e4840beffca530e19b3f540c9057857eb57abed0ea6fc7f309927e7ec92b1e4f93335639be2f7e4331612686e7e5d3629d8ad8dc547468d6cb6bf84084a3b4b61bbec51ba64c3d0e5875474a497c456bcc73d5385e22498bc9359033684dd9708368bf5313b4a8f0705e4bf49fc70143e5e4285df4277ad6e6730308769f1321eb53bd155e4a47f60ada32c1206e1bee4038140f3e98fff4abc5650d39e3aa6507448d34e1d0a80bd1d00c3e1053a37b59784c2e800830bd5c6ec41d9f4209aede175147f1cf652bca05c4a59ac98d6f35f151932725d77462f09544c755169facbc7652005c64dc9590ed0397cfb85f91005cb62de87f8233ac234c0138c8ccf1f180d16061c1bbca477f353233614ab4e17323468c18a5ab492a7190a88671c204cff3f841758d11392f87094216a99fcf900a5589fc452c8cb7a999ec3fe8ee97571b8996067f7843ea2bae795cdc7b51b54a532d61a4e2982af29ddef5241ca4b805eeede6af9d2038b97880d88ac66dc7a32d9e9c71b9d7a0b6e1a9ad27737767ff3a1a2850290d52caeab8bb4f560805064d5ab3f6e7d604cc6b594047ed0df305bdebf173f67f242ef1d397dcfb760e0fc9bd317a658d4ca72ce44910f077a926d1d698624ad4cfb9551fe99466a3666f2d4dc4c0435219fa1e0a4e824701c95ba81fc79cfbb62359913a8001fbb391526064197e7276cd0ca181b9b96abe5b0aef467319df7da8b203588dfc0b25c897d057ee2d1586360e3f9d70432739b0e0d4a382f266919afbdb2f7973efba9dc24e7dea5190ab0dda718d7caab23b2f7b7e657427811fd56cfaaac7c1034d9be8be49d26aedcd397a2bf11e00470c5c7d745a0bccdea925ef7fbaac5078de436e57bca4b52f9b5eb814b235015787ad4b6e7145bda2b20b999d01ffb9ed0c2add7c5c93ea878c72e19bc5d30ff674a692def48f2f7297085097c1a94046b4dfc077fa998ab66758b346efe90b53808484351756c3e9dcd9c7eed95ab01eddfb02357bdbce91e680ed3e8e4880d8e01c19722ed191473f4c399a374cede947e621eb119d90e308546088511a0c865bfbb9d91513a7a2f5febb4fea6020abea6bbea2fe9dd69f65043707ae7b04038d22df22323e2f9f6fa097759d17802e74ca5ac5850749bd37d2fdb8bd8c09c2a3353352dd5c6898718de496b60c150278bc05d74541b050e4eb7e72d307c1bf703c3ea18d14ae9ed4435506f3ec69a8b30e7dbe7596e66d7f6cedcd2223fc315ff7e048abc153fc0076a431719e787820cf991b0f8f83ab0416cf24fd0037434ac2d5fd9cd6b5d8b4214a3e2fa8a23b9d3e5e2ad9990bc7d1aa51bc9ff4e2f5bb5d70e2544f43c6d8adbaa14158c2f9a16855093fa7f89e94da4844bfe8ea5fe6daf3f57fa6655be77eb0d7f161568a9d19b255725aa7298bcafb5de312c87102009808884b2d533994ac84ae6cbcae834115d598cc9836b891d3b31a268b653bee758387ce4150a8c9eae2f45412bd4ffb478c848fd9a735037952e3941a3961674dd2df0e18db81354a65bef0f4dde2c16417addce0f04e1486e1ca2e68db5b50e7a2560bfee3510bd9b26d7323ff6ec97e2987761b26e601fad5dcba24c21a943af55cf0f4b5c27343fc4ea87d999f70493b7297071a111bfc5933c297cfb110706dab5fb57ae28eaddc3b5e56fb2ccc1f20c29ed660a08b348a24a492cd46f9e74affccb42706114818998b637b4ec8ab86e7e6c8f2992c6826d15a716e09231dd94eaf16c08270337b5b337aa966ddc294488c32b29728d6a28c0f7321fdadb5e1bec65c17bb8d2b3963b5b5a41f11623547c808b1f55ca5a9b8292f9485c137fbec8ba13577c900ff0f7b299e0804610510eecc88847ee43d5092f2609407ad2752661d6d770ec9fe2bc423ee7b3109a4c92ab7c180be4e18aeffd5e8d25cc8b5f143941968afda6392dc2610f0eb186241e1862001d831f14cf2d2982093f6501ce3adb2d64133ebf00daa1b45542d02f57c27281ccbf74edd5dc6b8f7cbba170c03b5d1bb07c35335f6f129004aaf4942e024d6d3de5a4cbdd47b0eeb9e846caadca3dd2a44c1182f4c677f9968ed45222e8603d3407299e132041c001ecfeb60c5f06bf9555a8ed3cb38ee1d697150007b838b47c678e6d4c015d6ae37960d50855069c3e03068fa34d602b3134eb365076f04d98b1cbcd4456174443380a09d789c87083a9e7d0b8171c396c7548cd4f45b09dd2fff050f7facb3b5ae41bf0027e872ee92c8825f060b677b3c661ebe93716aacdc41019fb7c04966c0ab17bafa124cb5b2287a3c1ee338d5b08cbe4d7ce29ad9bec01e746832748f7a0a5eae9ac13e7c02c924d675b0ed16d153b9827b496ef5904c44f3246b59f4080eb14983a8698719ba88084ecda4c9c986b4f0353fef19379e8808a0169bdefe8d57823a471ab04b565434db3b844db8711ee95f49749cbbadcd1a7e09dc3e6f2453cfabecb03c812b35e24659d804e90dcc2afa417eac6b10ec3579332aeeac150a06687104ec0dc89b2088756d8a13398bb5fffb281c2d4b839aa353aaade3721513ff2e8ebf1f3925ac03348bc213ad1aa071d9e65c57701914c81018b6743dd1ca6079c7929e392004efaba967e17c52b1344aebc2990e3aa2c1ccd39e363cc998218028fbfef36dbb08c8759fcf53721431b02735b32de4fb5d4466ec5f01a6f67889ff949f7a7cf8c38b65c3b4b3609858fb29d51539d917113fb324796b53a35d5f0bc687aa4b726d5808ed993e45f8d821b543d64d3e7034cfbbabe602d2acc1698d9d25099a56dad008eb598dd78bb5eed1c526957bbb433c682a55292404e21445bc443abb05753ac45b5a83d2268de1337d31a00d918580fb4557303b9d46d9bb8115400b0e231820c17283ae7263fa15d594441c5c53fdef94770d932f266422743690fcbe4f3552e0c6fa27da692bd2da5edc6e7cc4c164d6b0b2956a663ffd4711817280105e14649488474143e06cedd98350c14074ac4891b8bfc5d4ae050fb9745fbde9d613aa33690d78a3253c57a64d6b37e1a121e3af51030e3b373b7ebcb6be3d0e93d0696dab0482043ae2e9ca938d1a15a2b89dae5f8b81e4c491ba933aa69addaf9f26f74d8c7ca7c5f2e0c3f958197f48aa5ee57beab0dd44269afc0d52cd545d8317e675c4efe91ed11a080469c24f8c474ddde2420c4fd6e5ee145e5f3c7b622490d4e3b64c3ca067018672dd6d1ecfc3b6394919248588aac0c723e09cc3a9f821594c9cd1403418a4806f656d8dc2cbc06568685d34511afb0c98029262252c61938ee6617afc39b31c59f6c1d312da8a952086c75d5fa268759b9a6010bca99c7bd327ef4db6d24e7ad92379c7556231b29c4863dd716dc62c0e37600d7d72a6e16dcbc676d1f67011b1a55db676e8a03f1bf052df4db31b12a0f962156a7232c0d8ec8e7e1abf0fa2f8a4dfa17868fe157d378d870aead98330c6972e9f2ce79ca9f2a5439abaf3aafd149d4da168ac073be45662f4c71244babfae906eb313ba63ea70b5f4afd958ed5d0e800831a06766b49126c2cc2058f36de9506120d01e607d545b3ffdbb4d4694917397e9513f7f351698e9622e460f3e3468eac0b42892261747d7985bfcab842e9deba8e4923a43f874af038c8e4407b95dfe25753b06289925cd707fe3f5c2652d7983d36f124afa13750a8ce2fd63982b35849dbc136187f9db9e0199cb57f1e7de849f3d37a3ae72c33a734d619977a7d74b42f1798da490dace3bf6549fb18926542ae98d8894e37d4bd30bf5f030361230faf40a81f40ca6a21de2759be69481c8a19efb5f0d8d6a920e1fac69878b53db4a63e76bbb5be1b2262d67be538981c456a1709d6bd7f17995855b0b9c7a65dbfb5f371e234c971ff45018b188eca5e562b7804be95cc782246e6c6b3083ada7e79f969b7c814b4ef767abf079a42c6b7671e668c368ce360928f784e19bc9f818740448bad81fa4d3a001142302bc9cf1ebec8ded86577c070e705cdbe5af4dbd7388e6fdfc486f771c05370ca76e2522acdd6647dba415080297ecc557c869d2bc0cd698db11af03a60a67ac1a376551bfff4e1155935808609cdbde8b2267a0c7adb0653547d4b1c755a65c0d5e52c9e62448b1605ac54e7073815686fa2f7e84d467d2cbcfb39df85e5dff5270c699fc4309eb48cc15e55bf0c08e5cee33701c65b408b7c81b7fbba69556439dbba7f35a6b68f8f79544f629d63d9205636763d26c9b8edbe7307a0aba5dc4f092016aca1cdd342e6061d5f2328f4b7af7bddc0af27498274d4cc2f966f6b857d7388cbef9e9a14548708aa5a5cfd173f1214c6a3584badd3f4a66d8ee4706a83d984186e87ffdbd5ee9c506029e7f2cce1a0281b1a76f9f15279de1b2aed1906d6e7607281d15cd8271bbccac687e13a2b8dcea678cde73292c2b496dd65d2dac3280e75618b779f31a0aa64b8abe4dbc503d5661017b97c8b8000af3a755c5b75f24e2929ed0f0014c9f200798c39dd562e294f36541e210e3a5d8b716f5465db2688a8e5df6c029c78ef61235493dedc15dd427ff9d43a62fb5f10f71da657071fb2593cac11fa3dfe789f112ea39fefdaab10538241e9c50076359a3ddcba922cb9931666b1fab207d7caf2d98bb0eee4cb3a7684a59e57693bdd630a6b57e48fd38334d0adac10de31798ba8d36474dac9b3bcb614deb9e3c27218054a6c7ba39eb0391259e4d16de7fa50af11593c7d50c56240114c6d26609f8a4304306668659efb483cddd69c195758a71f70e112b57c7cac8b3ca597bbf441b995d7445e4a7c571fb5eb0686a4b8edf9ef6528bba404f75173703de433923b7d0042fa9c1181d4c317753f52d8b136795fd092abcf5f968410b435b601bcf3bd2b071f30a280fb42b02f381c16f2662328bca4a35a9ad09f96df6b52955617afff8ebbbe3bcca75d057d3f5ad08f6b31b200e761fc38df6154596a330fe6137df87ea28655e90fc8623eed713fe13b4fa9eff23bec58d1307aa997564a1cf1b607e794d208dd97605dc9ea421237387c2f19fdff4325fd5db22fcfb59632404bf38ad631a35bb5e3f3ee7d9e66669d46c41cf07603d28d54c9535449c0e8c1e723dbb1b6c6646ee444ea13743608e9a74c99c83bdfcf193abe86cf7b05ce42233a38b7ebec960570f584ba6d00d11f9491cbd91590295a34785a3bbf556dec28f657cd0997fab98e1552395073a81c625e1047e4e87c2a0651485db1a73bc37769caf9c8447a38a891be4fa59616f8d7cf31d459814cd60b703550b03f8317bf186e4386799a6126a1651b3713ad705b9c637f09578836301ce289176767b59738bf94fbcb82a994fbc8889f0fcc728d246aad68a86bd277978a682d45edc9d3db15b0f07b629d6a215af2d7b9fd77e405503a66fab6b8a4d3ea4c18d50f5075198e6daf820c0bf8b10686a5953c1b330a15cd01d63610e5d612c31dce65dc44d26b9e1b2d988fee94b37be4ecc2886ffc275d08d6853c44f1382a3c58b0136e29f7967c857899a7b9db9f893e4c64fad10dd9ee69df1ccbcbf4dc355a1eaba4b04bc46c6245bca83cb736d940b529393e0b6c681804a4e04ab94ff85c806f7b56ec5ca91777262900e9fe1d9b3e428f3999620ed72cb7b6fd204a083eb1e5a4e26b1e92e6d5f</script>
</div>
<script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
      <categories>
        <category>Serverless</category>
      </categories>
      <tags>
        <tag>Apache OpenWhisk</tag>
        <tag>Serverless</tag>
        <tag>FaaS</tag>
        <tag>Kubernetes</tag>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title>Apache Storm 简介</title>
    <url>/posts/13977/</url>
    <content><![CDATA[<h2 id="Storm-是什么？"><a href="#Storm-是什么？" class="headerlink" title="Storm 是什么？"></a>Storm 是什么？</h2><p>　<strong>Apache Storm</strong>™ is a free and open source distributed realtime computation system. Storm makes it easy to reliably process unbounded streams of data, doing for realtime processing what Hadoop did for batch processing.</p>
<h2 id="为什么要有-Storm？"><a href="#为什么要有-Storm？" class="headerlink" title="为什么要有 Storm？"></a>为什么要有 Storm？</h2><h3 id="分布式"><a href="#分布式" class="headerlink" title="分布式"></a>分布式</h3><p>　具备经济、快速、可靠、易扩充、数据共享、设备共享、通讯方便、灵活等分布式所具备的特性</p>
<h3 id="可扩展性"><a href="#可扩展性" class="headerlink" title="可扩展性"></a>可扩展性</h3><p>　计算在多线程、进程 和 服务器之间并行进行</p>
<h3 id="高可靠性"><a href="#高可靠性" class="headerlink" title="高可靠性"></a>高可靠性</h3><p>　能管理工作进程 和 节点的故障<br>　消息处理，能得到一次完成处理的保证</p>
<h3 id="编程模型简单"><a href="#编程模型简单" class="headerlink" title="编程模型简单"></a>编程模型简单</h3><p>　降低了并行批处理复杂性</p>
<h3 id="高效实时"><a href="#高效实时" class="headerlink" title="高效实时"></a>高效实时</h3><p>　利用 ZeroMQ 保证了消息的快速处理</p>
<h3 id="支持热部署"><a href="#支持热部署" class="headerlink" title="支持热部署"></a>支持热部署</h3><p>　加速应用开发</p>
<a id="more"></a>
<h2 id="Storm-工作机制"><a href="#Storm-工作机制" class="headerlink" title="Storm 工作机制"></a>Storm 工作机制</h2><h3 id="一些主要概念"><a href="#一些主要概念" class="headerlink" title="一些主要概念"></a>一些主要概念</h3><ul>
<li>Topology（计算拓扑）</li>
<li>Stream（消息流）</li>
<li>Spout（消息源）</li>
<li>Bolt（消息处理者）</li>
<li>grouping（数据的分发方式）</li>
<li>Topology（拓扑）</li>
<li>Worker（工作进程）</li>
<li>Task（执行具体逻辑的任务）</li>
<li>Executor（执行 Task 的线程）</li>
<li>Configuration（配置）</li>
</ul>
<div class="note info">To be continued...</div>


<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt=""></a></td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>大数据</category>
      </categories>
      <tags>
        <tag>Apache Storm</tag>
        <tag>Apache Kafka</tag>
      </tags>
  </entry>
  <entry>
    <title>Benedict Jin&#39;s Blog</title>
    <url>/posts/18517/</url>
    <content><![CDATA[<h2 id="Welcome"><a href="#Welcome" class="headerlink" title="Welcome"></a>Welcome</h2><p>　<strong>Welcome to My Blog!</strong></p>
<h2 id="博客介绍"><a href="#博客介绍" class="headerlink" title="博客介绍"></a>博客介绍</h2><p>　吾生有涯而学无涯，以有涯而逐无涯（有点断章取义，不过追寻知识的热情是必要的）</p>
<h2 id="大事件纪实"><a href="#大事件纪实" class="headerlink" title="大事件纪实"></a>大事件纪实</h2><div class="table-container">
<table>
<thead>
<tr>
<th>标题</th>
<th>内容</th>
<th>日期</th>
</tr>
</thead>
<tbody>
<tr>
<td>混沌初开</td>
<td>建站第一天</td>
<td>2014-11-01</td>
</tr>
<tr>
<td>模糊的记忆</td>
<td>Hexo 框架 / next 主题 / 七牛图床 / Gulp 压缩 / 静态资源 CDN / 支持 MathJax</td>
<td>2014~2016</td>
</tr>
<tr>
<td>多说关闭</td>
<td>评论系统切换为 Disqus</td>
<td>2017-04-10</td>
</tr>
<tr>
<td>Order by Update</td>
<td>文章以<strong>最后更新时间</strong>倒排展示（避免养成隔一段时间水一篇的坏习惯）</td>
<td>2017-04-22</td>
</tr>
<tr>
<td>Aliyun 备案</td>
<td>苏 ICP</td>
<td>2017-05-25</td>
</tr>
<tr>
<td>全站 HTTPS</td>
<td>TrustAsia 域名证书</td>
<td>2017-10-10</td>
</tr>
<tr>
<td>Coding.net</td>
<td>静态页面从 github.io 切换为 coding.net（香港服务器）</td>
<td>2017-11-15</td>
</tr>
<tr>
<td>不蒜子 502</td>
<td>页面统计切换为 Lean Cloud，之前的 PV / UV 统计无奈清零</td>
<td>2017-11-19</td>
</tr>
<tr>
<td>DDoS 攻击解除</td>
<td>回归不蒜子</td>
<td>2017-11-20</td>
</tr>
<tr>
<td>Gitment</td>
<td>延迟加载 Gitment</td>
<td>2018-05-29</td>
</tr>
<tr>
<td>回归 Github Page</td>
<td>Github Page 开始支持 HTTPS</td>
<td>2019-04-20</td>
</tr>
<tr>
<td>全站 CDN</td>
<td>阿里云 DCDN</td>
<td>2019-04-21</td>
</tr>
<tr>
<td>简繁切换</td>
<td>支持简体与繁体切换</td>
<td>2019-04-27</td>
</tr>
<tr>
<td>支持 Gitalk</td>
<td>Gitment 验证存在跨域问题，而 Gitalk 可以无缝迁移</td>
<td>2019-05-01</td>
</tr>
<tr>
<td>支持 DaoVoice</td>
<td>可以匿名留言，在线沟通</td>
<td>2019-05-02</td>
</tr>
<tr>
<td>暂闭 DaoVoice</td>
<td>出于其服务稳定性的考量，暂时关闭</td>
<td>2019-05-11</td>
</tr>
<tr>
<td>设计 Logo</td>
<td>新 Logo 寓意着浩瀚宇宙中的一处安心的港湾</td>
<td>2019-05-11</td>
</tr>
<tr>
<td>源站迁移</td>
<td>全站迁移至阿里云 OSS，代替 Github Page 作为源站</td>
<td>2020–01-01</td>
</tr>
<tr>
<td>镜像网站</td>
<td>搭建镜像网站 <a href="https://yuzhouwan.github.io/">yuzhouwan.github.io</a></td>
<td>2020-02-09</td>
</tr>
</tbody>
</table>
</div>
<a id="more"></a>
<h2 id="代码库"><a href="#代码库" class="headerlink" title="代码库"></a>代码库</h2><ul>
<li>Advance <a href="https://yuzhouwan.com/posts/2254/">Maven</a> Skill</li>
<li><a href="https://yuzhouwan.com/tags/">BigData</a><ul>
<li><a href="https://yuzhouwan.com/posts/60504/">Hadoop</a> <strong>/</strong> <a href="https://yuzhouwan.com/posts/25015/">Storm</a> <strong>/</strong> <a href="https://yuzhouwan.com/posts/4735/">Spark</a> <strong>/</strong> <a href="https://yuzhouwan.com/posts/45888/">HBase</a> <strong>/</strong> <a href="https://yuzhouwan.com/posts/22654/">ElasticSearch</a> <strong>/</strong> <a href="https://yuzhouwan.com/posts/5845/">Druid</a> <strong>/</strong> <a href="https://yuzhouwan.com/posts/26002/">Kafka</a> <strong>/</strong> <a href="https://yuzhouwan.com/posts/22654/#%e6%95%b4%e5%90%88%e5%bc%80%e5%8f%91">Flume</a> <strong>/</strong> <a href="https://yuzhouwan.com/posts/2129/">Redis</a> <strong>/</strong> <a href="https://yuzhouwan.com/posts/31915/">ZooKeeper</a></li>
</ul>
</li>
<li>Hack technology<ul>
<li><a href="https://github.com/asdf2014/yuzhouwan/tree/master/yuzhouwan-hacker/src/main/java/com/yuzhouwan/hacker/algorithms">Algorithm</a> <strong>/</strong> <a href="https://github.com/asdf2014/yuzhouwan/tree/master/yuzhouwan-hacker/src/main/java/com/yuzhouwan/hacker/algorithms/leetcode">Leetcode</a> <strong>/</strong> <a href="https://github.com/asdf2014/yuzhouwan/tree/master/yuzhouwan-hacker/src/main/java/com/yuzhouwan/hacker/codegen">Code Generate</a> <strong>/</strong> <a href="https://github.com/asdf2014/yuzhouwan/tree/master/yuzhouwan-hacker/src/main/java/com/yuzhouwan/hacker/effective">Effective Code</a> <strong>/</strong> <a href="https://github.com/asdf2014/yuzhouwan/tree/master/yuzhouwan-hacker/src/main/java/com/yuzhouwan/hacker/algorithms/thread">Multi Threads</a> <strong>/</strong> <a href="https://github.com/asdf2014/yuzhouwan/tree/master/yuzhouwan-hacker/src/main/java/com/yuzhouwan/hacker/lambda">Lambda</a> <strong>/</strong> <a href="https://github.com/asdf2014/yuzhouwan/tree/master/yuzhouwan-hacker/src/main/java/com/yuzhouwan/hacker/snmp">SNMP</a></li>
</ul>
</li>
<li>Languages<ul>
<li><a href="https://github.com/asdf2014/yuzhouwan/tree/master/yuzhouwan-hacker/src/main/java/com/yuzhouwan/hacker">Java</a> for Most Logic <strong>/</strong> <a href="https://github.com/asdf2014/yuzhouwan/tree/master/yuzhouwan-hacker/src/main/scala/com/yuzhouwan/hacker">Scala</a> Feature <strong>/</strong> <a href="https://github.com/asdf2014/yuzhouwan/tree/master/yuzhouwan-hacker/src/main/groovy/com/yuzhouwan/hacker">Groovy</a> for DSL <strong>/</strong> <a href="https://yuzhouwan.com/posts/43687/">Python</a> for <a href="https://github.com/asdf2014/yuzhouwan/tree/master/yuzhouwan-hacker/yuzhouwan-hacker-python">SQL Parser</a> &amp; <a href="https://yuzhouwan.com/posts/42737/">AI</a> <strong>/</strong> <a href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-common/src/main/resources/shell/gc_monitor2.sh">Shell</a> for <a href="https://yuzhouwan.com/posts/27328/">JVM</a> Monitor</li>
</ul>
</li>
<li><a href="https://github.com/asdf2014/yuzhouwan/tree/master/yuzhouwan-site">WebSite</a><ul>
<li><a href="https://github.com/asdf2014/yuzhouwan/tree/master/yuzhouwan-site/yuzhouwan-site-service/src/test/java/com/yuzhouwan/site/service">RPC</a> <strong>/</strong> <a href="https://github.com/asdf2014/yuzhouwan/tree/master/yuzhouwan-site/yuzhouwan-site-service/src/main/java/com/yuzhouwan/site/service/nio">NIO</a> <strong>/</strong> <a href="https://github.com/asdf2014/yuzhouwan/tree/master/yuzhouwan-site/yuzhouwan-site-service/src/main/resources">Spring</a> stuff <strong>/</strong> <a href="https://github.com/asdf2014/yuzhouwan/tree/master/yuzhouwan-site/yuzhouwan-site-service/src/main/webapp">Swagger</a> for Doc</li>
</ul>
</li>
<li>A lot of Commons <a href="https://github.com/asdf2014/yuzhouwan/tree/master/yuzhouwan-common/src/main/java/com/yuzhouwan/common/util">Utils</a></li>
</ul>
<h2 id="技术交流群"><a href="#技术交流群" class="headerlink" title="技术交流群"></a>技术交流群</h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt=""></a></td>
</tr>
</tbody>
</table>
</div>
<h3 id="BigData-生态圈"><a href="#BigData-生态圈" class="headerlink" title="BigData 生态圈"></a><strong><a href="https://yuzhouwan.com/categories/大数据/">BigData 生态圈</a></strong></h3><p>　讨论大数据生态圈的各种领域，包括：</p>
<ul>
<li>Spark / Storm / Hadoop / Flink / Heron / Cassandra / Docker 主流框架</li>
<li>Paxos / Raft / Gossip / Consistent Hashing / Chubby / ZooKeeper 分布式算法与架构</li>
<li>Java / Python / Golang / Scala / Clojure / Ruby 各大流行语言</li>
<li>PostgreSQL / HBase / Hive / ElasticSearch / Redis / Druid 数据持久化策略</li>
<li>Data Mining / Machine Learning / Deep Learning / AI 数据分析领域 等等</li>
</ul>
<h3 id="人工智能"><a href="#人工智能" class="headerlink" title="人工智能"></a><strong><a href="https://yuzhouwan.com/posts/42737/">人工智能</a></strong></h3><p>　研究 人工智能 相关领域，欢迎加入，互相学习，共同进步<br>　讨论包括，统计学、NLP、Data Mining、Deep Learning、Machine Learning、人工智能 等相关领域</p>
<p>　从 深蓝到 AlaphZero，人工智能的智力水平、普适性、学习能力 正在以爆炸式地速度快速发展；<br>　从 棋类到 医学，人工智能开始在各类应用领域，都在大展身手；<br>　从 CPU / GPU 到 TPU，人工智能的计算能力正向着无法穷举的极限不断逼近…</p>
<p>　本群持续沉淀的一篇人工智能的文章：<a href="https://yuzhouwan.com/posts/42737/">https://yuzhouwan.com/posts/42737/</a></p>
<h3 id="算法"><a href="#算法" class="headerlink" title="算法"></a><strong><a href="https://yuzhouwan.com/posts/666/">算法</a></strong></h3><p>　讨论算法的各种领域：</p>
<ul>
<li>从底层常用 Algorithm，到分布式算法、框架，再到高可用系统架构</li>
<li>从原始的模式匹配，到机器学习、深度学习、神经网络，再到人工智能</li>
<li>从网络路由算法，到数据库 B+Tree、香农信息论，再到 Linux 内核算法</li>
</ul>
<p>　汲取世界的方方面面，不断充实技术树，踏踏实实地点亮每一片枝叶  </p>
<p>　本群长期进行 <a href="https://yuzhouwan.com/posts/666/">“LeetCode 组队刷题活动”</a></p>
<h2 id="搜索引擎收录"><a href="#搜索引擎收录" class="headerlink" title="搜索引擎收录"></a>搜索引擎收录</h2><p>　Just <a href="https://www.google.com/search?q=%E5%AE%87%E5%AE%99%E6%B9%BE">Google</a> it :D</p>
<p><img data-src="/picture/blog/google_yuzhouwan.png" alt="Google Yuzhouwan.com"></p>
]]></content>
      <categories>
        <category>关于本站</category>
      </categories>
      <tags>
        <tag>Blog</tag>
      </tags>
  </entry>
  <entry>
    <title>DIRT</title>
    <url>/posts/47609/</url>
    <content><![CDATA[<h2 id="DIRT-是什么？"><a href="#DIRT-是什么？" class="headerlink" title="DIRT 是什么？"></a>DIRT 是什么？</h2><p>　DIRT：数据密集型实时（<strong>D</strong>ata-<strong>I</strong>ntensive <strong>R</strong>eal-<strong>T</strong>ime）</p>
<h2 id="为什么适用于-Node-js-开发？"><a href="#为什么适用于-Node-js-开发？" class="headerlink" title="为什么适用于 Node.js 开发？"></a>为什么适用于 Node.js 开发？</h2><h3 id="轻量"><a href="#轻量" class="headerlink" title="轻量"></a>轻量</h3><p>　因为 <a href="https://yuzhouwan.com/posts/23363/">Node.js</a> 自身在 I/O 上非常轻量，它善于将数据从一个管道混排 或 代理到另一个管道上，这能在处理大量请求时持有很多开放的连接，并且只占用一小部分内存（如同浏览器一样，保证了响应能力）</p>
<h3 id="Web-发展形势"><a href="#Web-发展形势" class="headerlink" title="Web 发展形势"></a>Web 发展形势</h3><p>　不管是用实时组件增强已有程序，还是打造全新的程序，Web 都在朝着响应性和协作型环境逐渐进发<br>而这种新型的 Web 应用程序需要一个能够实时相应大量并发请求的平台来支撑它们（除此之外，还有 I/O 负载较重的程序也可以用到）</p>
<a id="more"></a>
<h3 id="Node-js-作为-JavaScript-程序的平台"><a href="#Node-js-作为-JavaScript-程序的平台" class="headerlink" title="Node.js 作为 JavaScript 程序的平台"></a>Node.js 作为 JavaScript 程序的平台</h3><ul>
<li>Timer API (for example, setTimeout)</li>
<li>Console API (for example, console.log)</li>
<li>Network and File I/O modules (HTTP, TLS, HTTPS, filesystem (POSIX), Datagram (UDP), and NET (TCP))</li>
</ul>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt=""></a></td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>语言</category>
      </categories>
      <tags>
        <tag>Node.js</tag>
      </tags>
  </entry>
  <entry>
    <title>Gradle 实战</title>
    <url>/posts/190816/</url>
    <content><![CDATA[<h2 id="Gradle-是什么？"><a href="#Gradle-是什么？" class="headerlink" title="Gradle 是什么？"></a>Gradle 是什么？</h2><p>　Gradle™ 是一个基于 Apache Ant 和 Apache <a href="https://yuzhouwan.com/posts/2254/">Maven</a> 概念的项目自动化建构工具。它使用一种基于 Groovy 的特定领域语言来声明项目设置，而不是传统的 XML。当前其支持的语言限于 <a href="https://yuzhouwan.com/posts/27328/">Java</a>、<a href="https://github.com/asdf2014/yuzhouwan/tree/master/yuzhouwan-hacker/src/main/groovy/com/yuzhouwan/hacker/dsl">Groovy</a> 和 <a href="https://yuzhouwan.com/posts/18651/">Scala</a>，计划未来将支持更多的语言。  — <a href="https://zh.wikipedia.org/wiki/Gradle">wikipedia.org</a></p>
<h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2><ul>
<li>DSL 声明项目的配置，更加直观</li>
<li>细粒度的传递依赖管理</li>
<li>增量编译</li>
<li>高效的内存执行</li>
</ul>
<a id="more"></a>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><h3 id="安装-Gradle"><a href="#安装-Gradle" class="headerlink" title="安装 Gradle"></a>安装 Gradle</h3><h4 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h4><p>　在 Gradle 的<a href="https://gradle.org/releases/">下载页面</a>，下载 gradle-5.4.1-all.zip 文件，解压至 <code>D:\apps\gradle</code>，并添加环境变量 <code>PATH=D:\apps\gradle\gradle-5.4.1\bin</code></p>
<h4 id="Mac"><a href="#Mac" class="headerlink" title="Mac"></a>Mac</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ brew install gradle</span><br><span class="line">$ brew upgrade gradle</span><br></pre></td></tr></tbody></table></figure>
<h4 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 检查是否安装成功</span></span><br><span class="line">$ gradle -v</span><br><span class="line">  ------------------------------------------------------------</span><br><span class="line">  Gradle 5.4.1</span><br><span class="line">  ------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">  Build time:   2019-04-26 08:14:42 UTC</span><br><span class="line">  Revision:     261d171646b36a6a28d5a19a69676cd098a4c19d</span><br><span class="line"></span><br><span class="line">  Kotlin:       1.3.21</span><br><span class="line">  Groovy:       2.5.4</span><br><span class="line">  Ant:          Apache Ant(TM) version 1.9.13 compiled on July 10 2018</span><br><span class="line">  JVM:          11.0.4 (Oracle Corporation 11.0.4+10-LTS)</span><br><span class="line">  OS:           Mac OS X 10.14.6 x86_64</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Gradle-代理设置"><a href="#Gradle-代理设置" class="headerlink" title="Gradle 代理设置"></a>Gradle 代理设置</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gradle xxx -Dhttp.proxyHost=127.0.0.1 -Dhttp.proxyPort=1080</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者修改 gradle.properties 配置文件</span></span><br><span class="line">$ vim gradle.properties</span><br><span class="line">  systemProp.http.proxyHost=192.168.1.101</span><br><span class="line">  systemProp.http.proxyPort=8080</span><br><span class="line">  systemProp.http.nonProxyHosts=*.nonproxyrepos.com|localhost</span><br><span class="line">  systemProp.https.proxyHost=192.168.1.101</span><br><span class="line">  systemProp.https.proxyPort=8080</span><br><span class="line">  systemProp.https.nonProxyHosts=*.nonproxyrepos.com|localhost</span><br></pre></td></tr></tbody></table></figure>
<div class="note info">如果在 Kafka 源码目录下修改的 gradle.properties 无法生效，可以直接拷贝到 ~/.gradle 目录下</div>



<h3 id="编译源码"><a href="#编译源码" class="headerlink" title="编译源码"></a>编译源码</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 下载依赖</span></span><br><span class="line">$ gradle</span><br><span class="line"></span><br><span class="line"><span class="comment"># 增加 `-x test` 参数，可跳过单元测试</span></span><br><span class="line">$ gradle -x <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 随后，生成可以用 Intellij Idea 打开的工程</span></span><br><span class="line">$ gradle idea</span><br></pre></td></tr></tbody></table></figure>
<div class="note success">如果 Gradle 的配置文件里面，没有设置 idea 插件，导致项目模块无法被识别。则需要删除 .idea 文件夹，并以 build.gradle 打开为项目，即可</div>





<h2 id="实战技巧"><a href="#实战技巧" class="headerlink" title="实战技巧"></a>实战技巧</h2><h3 id="不同的项目使用的-Gradle-版本不一致"><a href="#不同的项目使用的-Gradle-版本不一致" class="headerlink" title="不同的项目使用的 Gradle 版本不一致"></a>不同的项目使用的 Gradle 版本不一致</h3><p>　可以使用 <code>./gradlew</code> 包装器，就可以避免使用本地安装的 Gradle。Gradlew 会根据项目各自指定的 Gradle 版本进行下载，确保和项目要求的编译环境一致。常用命令如下：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ ./gradlew build</span><br></pre></td></tr></tbody></table></figure>
<h3 id="运行单元测试时，报错-No-Class-Found"><a href="#运行单元测试时，报错-No-Class-Found" class="headerlink" title="运行单元测试时，报错 No Class Found"></a>运行单元测试时，报错 No Class Found</h3><p>　修改 <code>Build and run using</code> 和 <code>Run tests using</code> 两个选项为 <code>Gradle</code>（默认为 <code>IntelliJ IDEA</code>）</p>
<p><img data-src="/picture/gradle/gradle_idea_config_for_testcase.png" alt="Configurations of Gradle in Intellij Idea for Testcases"></p>
<center>（对 <a href="https://www.jetbrains.com/idea/" target="_blank">IntelliJ IDEA</a>™ 的截图）</center>



<h3 id="并发执行任务"><a href="#并发执行任务" class="headerlink" title="并发执行任务"></a>并发执行任务</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 修改配置文件</span></span><br><span class="line">$ vim gradle.properties</span><br><span class="line">  org.gradle.parallel=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行任务时指定参数</span></span><br><span class="line">$ ./gradlew &lt;task&gt; --parallel</span><br></pre></td></tr></tbody></table></figure>
<h3 id="无法正常识别-module-下的代码"><a href="#无法正常识别-module-下的代码" class="headerlink" title="无法正常识别 module 下的代码"></a><a href="https://docs.gradle.org/current/userguide/idea_plugin.html">无法正常识别 module 下的代码</a></h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 清理所有的 IDEA 配置文件</span></span><br><span class="line">$ ./gradlew cleanIdea</span><br><span class="line"><span class="comment"># 生成 IDEA 配置文件</span></span><br><span class="line">$ ./gradlew idea</span><br></pre></td></tr></tbody></table></figure>
<h3 id="加载本地-jar"><a href="#加载本地-jar" class="headerlink" title="加载本地 jar"></a>加载本地 jar</h3><figure class="highlight groovy"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 加载单个 jar 包</span></span><br><span class="line">dependencies { compile files(<span class="string">'libs/yuzhouwan.jar'</span>) }</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加载多个 jar 包</span></span><br><span class="line">dependencies { compile fileTree(<span class="attr">dir:</span> <span class="string">'libs'</span>, <span class="attr">include:</span> [<span class="string">'*.jar'</span>]) }</span><br><span class="line">dependencies { compile fileTree(<span class="attr">dir:</span> <span class="string">'libs'</span>, <span class="attr">include:</span> [<span class="string">'yuzhouwan.jar'</span>]) }</span><br></pre></td></tr></tbody></table></figure>
<h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><h3 id="Doc"><a href="#Doc" class="headerlink" title="Doc"></a>Doc</h3><ul>
<li><a href="https://docs.gradle.org/current/userguide/userguide.html">Gradle User Manual</a></li>
<li><a href="https://www.gitbook.com/book/dongchuan/gradle-user-guide-/details">Gradle User Guide 中文版</a></li>
<li><a href="https://docs.gradle.org/3.3/userguide/gradle_daemon.html#when_should_i_not_use_the_gradle_daemon">When should I not use the Gradle Daemon?</a></li>
</ul>
<h3 id="Blog"><a href="#Blog" class="headerlink" title="Blog"></a>Blog</h3><ul>
<li><a href="https://gradle.org/maven-vs-gradle/">Gradle vs Maven Comparison</a></li>
</ul>
<h3 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h3><ul>
<li><a href="https://github.com/gradle/gradle">Gradle</a></li>
</ul>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt=""></a></td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>Apache Kafka</tag>
        <tag>Gradle</tag>
        <tag>Ant</tag>
        <tag>Maven</tag>
        <tag>Java</tag>
        <tag>Groovy</tag>
        <tag>Scala</tag>
        <tag>Windows</tag>
        <tag>Mac</tag>
      </tags>
  </entry>
  <entry>
    <title>Hadoop RPC 源码领略</title>
    <url>/posts/60504/</url>
    <content><![CDATA[<h2 id="什么是-RPC？"><a href="#什么是-RPC？" class="headerlink" title="什么是 RPC？"></a>什么是 RPC？</h2><p>　In distributed computing, a <strong>remote procedure call</strong> (<strong>RPC</strong>) is when a computer program causes a procedure (subroutine) to execute in a different address space (commonly on another computer on a shared network), which is coded as if it were a normal (local) procedure call, without the programmer explicitly coding the details for the remote interaction. That is, the programmer writes essentially the same code whether the subroutine is local to the executing program, or remote. This is a form of client–server interaction (caller is client, executor is server), typically implemented via a request–response message-passing system.</p>
<h2 id="为什么要有-RPC？"><a href="#为什么要有-RPC？" class="headerlink" title="为什么要有 RPC？"></a>为什么要有 RPC？</h2><h3 id="地域性"><a href="#地域性" class="headerlink" title="地域性"></a>地域性</h3><p>　当主机不可达时，通过远程调用可以使得终端操作目标机器成为可能</p>
<h3 id="含糖性"><a href="#含糖性" class="headerlink" title="含糖性"></a>含糖性</h3><p>　底层的网络通信细节封装入 API，方便网络分布式系统的开发</p>
<h3 id="模块化"><a href="#模块化" class="headerlink" title="模块化"></a>模块化</h3><p>　在 Hadoop 分布式系统中，上层的分布式子系统（MapReduce、YARN、HDFS …）能够共用这个网络通信模块</p>
<h2 id="Hadoop-的-RPC-调用链"><a href="#Hadoop-的-RPC-调用链" class="headerlink" title="Hadoop 的 RPC 调用链"></a>Hadoop 的 RPC 调用链</h2><p>　这里我们以 “从 HDFS 下载一个文件” 为例</p>
<h3 id="启动-Hadoop-集群的-DFS、YARN"><a href="#启动-Hadoop-集群的-DFS、YARN" class="headerlink" title="启动 Hadoop 集群的 DFS、YARN"></a>启动 Hadoop 集群的 DFS、YARN</h3><p>   <img data-src="/picture/hadoop/hadoop_hdfs.png" alt="hdfs"><br>   <a id="more"></a></p>
<h3 id="可以使用-Explorer-的-50070-端口，查看-NameNode"><a href="#可以使用-Explorer-的-50070-端口，查看-NameNode" class="headerlink" title="可以使用 Explorer 的 50070 端口，查看 NameNode"></a>可以使用 Explorer 的 50070 端口，查看 NameNode</h3><p>   <img data-src="/picture/hadoop/hadoop_host_yuzhouwan.png" alt="host - yuzhouwan"></p>
<h3 id="通过-FileSystem-的-get-uri-conf-user-初始化-FS"><a href="#通过-FileSystem-的-get-uri-conf-user-初始化-FS" class="headerlink" title="通过 FileSystem 的 get(uri, conf, user) 初始化 FS"></a>通过 FileSystem 的 get(uri, conf, user) 初始化 FS</h3><p>   <img data-src="/picture/hadoop/hadoop_file_system.png" alt="FileSystem"></p>
<h3 id="抽象类-FileSystem-拥有-13-个子类"><a href="#抽象类-FileSystem-拥有-13-个子类" class="headerlink" title="抽象类 FileSystem 拥有 13 个子类"></a>抽象类 FileSystem 拥有 13 个子类</h3><p>   <img data-src="/picture/hadoop/hadoop_file_systems.png" alt="FileSystems"></p>
<h3 id="加载配置文件，并给相应属性赋值"><a href="#加载配置文件，并给相应属性赋值" class="headerlink" title="加载配置文件，并给相应属性赋值"></a>加载配置文件，并给相应属性赋值</h3><p>   <img data-src="/picture/hadoop/hadoop_file_system_get_uri_conf_user.png" alt="FileSystem.get(uri,conf,user)"></p>
<h3 id="反射-org-apache-hadoop-hdfs-DistributedFileSystem"><a href="#反射-org-apache-hadoop-hdfs-DistributedFileSystem" class="headerlink" title="反射 org.apache.hadoop.hdfs.DistributedFileSystem"></a>反射 org.apache.hadoop.hdfs.DistributedFileSystem</h3><p>   <img data-src="/picture/hadoop/hadoop_reflection_utils_new_instance_dfs.png" alt="ReflectionUtils.newInstance--DFS"></p>
<h3 id="调用-initialize-uri-conf-初始化-DFS"><a href="#调用-initialize-uri-conf-初始化-DFS" class="headerlink" title="调用 initialize(uri, conf) 初始化 DFS"></a>调用 initialize(uri, conf) 初始化 DFS</h3><p>   <img data-src="/picture/hadoop/hadoop_dfs_initialize.png" alt="DFS.initialize"></p>
<h3 id="获得-DFSClient-代理"><a href="#获得-DFSClient-代理" class="headerlink" title="获得 DFSClient 代理"></a>获得 DFSClient 代理</h3><p>   <img data-src="/picture/hadoop/hadoop_dfs_client.png" alt="DFSClient(nameNodeUri,rpcNamenode,conf,stats)"></p>
<h3 id="创建代理"><a href="#创建代理" class="headerlink" title="创建代理"></a>创建代理</h3><p>   <img data-src="/picture/hadoop/hadoop_proxy.png" alt="Proxy"></p>
<h3 id="让-DFSClient-持有-uri、conf、statistics"><a href="#让-DFSClient-持有-uri、conf、statistics" class="headerlink" title="让 DFSClient 持有 uri、conf、statistics"></a>让 DFSClient 持有 uri、conf、statistics</h3><p>  <img data-src="/picture/hadoop/hadoop_dfs_client_.png" alt="DFSClient"></p>
<h3 id="解析-uri"><a href="#解析-uri" class="headerlink" title="解析 uri"></a>解析 uri</h3><p>   <img data-src="/picture/hadoop/hadoop_uri_create.png" alt="URI.create"></p>
<h3 id="根据用户组信息中的简单用户名，获取工作路径"><a href="#根据用户组信息中的简单用户名，获取工作路径" class="headerlink" title="根据用户组信息中的简单用户名，获取工作路径"></a>根据用户组信息中的简单用户名，获取工作路径</h3><p>   <img data-src="/picture/hadoop/hadoop_dfs_get_home_directory.png" alt="DFS.getHomeDirectory"></p>
<h3 id="FileSystem-完成初始化"><a href="#FileSystem-完成初始化" class="headerlink" title="FileSystem 完成初始化"></a>FileSystem 完成初始化</h3><p>   <img data-src="/picture/hadoop/hadoop_dfs_is_ok.png" alt="DFS-is-ok!!!"></p>
<h3 id="利用-FS-open-path-打开读取流"><a href="#利用-FS-open-path-打开读取流" class="headerlink" title="利用 FS.open(path) 打开读取流"></a>利用 FS.open(path) 打开读取流</h3><p>   <img data-src="/picture/hadoop/hadoop_distributed_file_system.png" alt="DistributedFileSystem"></p>
<h3 id="解析-path"><a href="#解析-path" class="headerlink" title="解析 path"></a>解析 path</h3><p>   <img data-src="/picture/hadoop/hadoop_path.png" alt="Path"></p>
<h3 id="装饰-open-方法"><a href="#装饰-open-方法" class="headerlink" title="装饰 open() 方法"></a>装饰 open() 方法</h3><p>   <img data-src="/picture/hadoop/hadoop_fs_data_input_stream.png" alt="FSDataInputStream--open(path)"></p>
<h3 id="FileSystemLinkResolver-回调函数"><a href="#FileSystemLinkResolver-回调函数" class="headerlink" title="FileSystemLinkResolver 回调函数"></a>FileSystemLinkResolver 回调函数</h3><p>   <img data-src="/picture/hadoop/hadoop_dfs_open.png" alt="DFS.open(f,bufferSize)"></p>
<h3 id="HdfsDataInputStream-读取流"><a href="#HdfsDataInputStream-读取流" class="headerlink" title="HdfsDataInputStream 读取流"></a>HdfsDataInputStream 读取流</h3><p>   <img data-src="/picture/hadoop/hadoop_hdfs_data_input_stream.png" alt="HdfsDataInputStream"></p>
<h3 id="FileOutputStream-写入流"><a href="#FileOutputStream-写入流" class="headerlink" title="FileOutputStream 写入流"></a>FileOutputStream 写入流</h3><p>   <img data-src="/picture/hadoop/hadoop_file_output_stream.png" alt="FileOutputStream"></p>
<h3 id="缓冲池"><a href="#缓冲池" class="headerlink" title="缓冲池"></a>缓冲池</h3><p>   <img data-src="/picture/hadoop/hadoop_buff_size.png" alt="buffSize"></p>
<h3 id="IOUtils-封装的拷贝方法"><a href="#IOUtils-封装的拷贝方法" class="headerlink" title="IOUtils 封装的拷贝方法"></a>IOUtils 封装的拷贝方法</h3><p>   <img data-src="/picture/hadoop/hadoop_ioutils.png" alt="IOUtiles.copyBytes(in,out,buffSize)"></p>
<h3 id="Download-over"><a href="#Download-over" class="headerlink" title="Download over!"></a>Download over!</h3><p>   <img data-src="/picture/hadoop/hadoop_rpc_success.png" alt="RPC-success"></p>
<h2 id="自己实现一套-RPC-系统"><a href="#自己实现一套-RPC-系统" class="headerlink" title="自己实现一套 RPC 系统"></a>自己实现一套 RPC 系统</h2><p>Full code is <a href="https://github.com/asdf2014/yuzhouwan/tree/master/yuzhouwan-site/yuzhouwan-site-service/src/main/java/com/yuzhouwan/site/service/rpc">here</a>.</p>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt=""></a></td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>大数据</category>
      </categories>
      <tags>
        <tag>Apache Hadoop</tag>
        <tag>HDFS</tag>
        <tag>RPC</tag>
      </tags>
  </entry>
  <entry>
    <title>Helm 实战</title>
    <url>/posts/200926/</url>
    <content><![CDATA[<div id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">
  <div class="hbe-input-container">
  <input type="password" id="hbePass" placeholder="" />
    <label for="hbePass">Hey, password is required here.</label>
    <div class="bottom-line"></div>
  </div>
  <script id="hbeData" type="hbeData" data-hmacdigest="e9ec39e1ba15dcc742a6095cc299734d294e7d7c19542509f6735909e0cd2dcf">f7756d22290f35cc46a507c4b347061b15ac7f7ecfd5eeb941acae4df8cb85acbabf75a1e5c6d265e93dff21f34a03054e577b189dbd3c70bc013454e91d6761fa25eae1b64e1931fd656c4e6cfc6884138da48fa0d8e30c23e700803c6f2fe6d23653702d0043eb61a2b6d376433be47451b586e39f8f797c4d981850a9a23b6f6a463ad04164057a5731952341103c6ece6037db50a2d4566e7a1d0fa9026cd29083acb58ba34756095dc433a651aea14200885c854fbde426446ea1c9e468aa254e6e6304cea1f589c1ab79715ce183ad369e8deeccca831f90af2ef7ed85e36d96947f44c06b3c5a4e347bdf6aff746b536b765fbe577be6e7f58f8d9bc61e454008fcdc467ae558158f4c1c6115195adc0b4b255baff4bd3163999acf524c27a80fe27470c53063adf9779bcbb4548ec0fca18cf0e10dfa66174ae006555ef72c15db9fdfc16c84c2a11d201b192a8f19c28fd22f6db7ddbcb34087209ac7d4c337700e175a6069eb4fced65c32ce297ac7a8d2346652ee244227bb2fb1039da8c70ac7c6ed15a7e90d2a498b66cec2e7b1e66beacdf91380aefd247d0e200b253faac35dec9e393f1b6a5696a948cd10d074770b011d013c664a23ef88c10363d9a7dd13172f014daebce15c97d641cb51891fcdcecbbb0c36d52fae72bed349b7ba6e4144e495393b5e53df1844f3f2d24abce32cc11dff9e624331bed05157c42585ef3a9e54e61d94187ae305ae9cf2af32f78bd045a89e081372ce6463996d7de3c7366f487d70cfaea8a737541c9b491dbbc8e0b53d1f018be9fb52ab25cb79e5466984d8e2218503753b25cea4c06f855a5d9a77234dffd6442913d241b6ad15d69d8aa97fcfdb5baf8eb14b29e67949dd9651db5da77f5ee8a9f599f580ee765cd77e0764ee1d069f5579c41a26b3482e9b8446acae0020dbdfe23637412e9931800774745b408264c2065e6da971e4b0aeedc08f9429147e7c3db86ff145c6b798801c139bbb3bdbcbf8d17bb090e7c07a48387dc37782996ec8ee6985bf9c106a2f93e071b7548f4da729071fd8d9ffcd16b46425ecb77c6335899ad4c2017fcfbe80864ebc2239e7682ca1993d4cd56c899c27f7f4bac1808fd7e9e82efc745a5549439f549fb2899b492de00e70b9e49e743b5fe7450a343af04e73a00bc2be051b0e54fd606826eed04cc9e4fa2cf9de80861842f54a922b105eb1c414a00b789260baaff89d44cd83eb842341b8c23fe8339229616bdaaa728106bfed16dc32c124b3343cf9211f38c98cca3dbc4979066e68151c65cd3b21f4806f88c4ada0ea890db7e7c7c12765aea217e2ea26b6d25c86e0e86745507c61439e87b103c5e18dca601aa5202350482b2cdf4d094ed2aa1120cd88e810a4bebb8134c46d1b7846a10f0a7c59eb9f1782d009d2e5a1ab0b317a37bd5335957368c05aa895af3c5e71768f4fbc242dca3f2a1b3e364f89c48597867eb995a9ba8e3d880065d9a116eaf363365d2042bbf05dc9eb4303b585bc652701c0151148fbb4c209c428cabaf663ee38083e2396d5c80c68ea0deb0c0888895d6fb43eb46d22076c47dab08c0c8114d1a68080414615a5b9a517017f89348ac6c6bbcfcf6d32e96b611afb642e0fedf39826b7b7a5a1ddfe6ca9c70831adc9e0fbde79ee03ac1940f68ce67b05d85ae0327a66431b419258714c70ae8a1c1b4eac5837bbc0d92af61e2a0baa2f4a9eaa99593e4b0318fa8d2e1cbf6c38abc353205315526e149754a09e36ef7eb9e386d0380d96f698d112bf31418e459fd8b35fc94103a1c2f2e7b70a4c0ba6081e8d6b55c4b8646d88230a80513167de385bd11af423963453e9338f93a0cbe6f7f69948c981889ea64e287fc4fba8468b4686435a4a38578bab55a9c027564e73ee488dc8e7243a8619b84cb8dff83bec3df7a4aa8a67ff3d6f217b4e269f4b85df5e4b5d25e2aecd7084c5f6dd80fa2323dba68256bb57a1f83ab220993311244bddb63b21693b4aec703fc11c67eac7a18dffc57c9cadf6938e2ab6e4b78f64d842154c007bada7c4e2192a44c1331b4bda44cb9394e055a6385a1d2e5f41636e9bc4cf1e84f0db8e9f42e7dc59d9a86c7ffa7015ceb506630733a9ab5cadcb2aa1ee8d1133f7f6209856f79efff5904174509580bc491266a26d9c37fa5d58823a14f4debfa2e26bfbde7a0969add2ff1d57da321654c3bfe87dd58f24aaef60e011d5cab89edf7bcf2ed6664c9c8fa47e541ac060ce3f0dd3e028e096f4c7f389fe6ab05aa8c78b13aa941193350166dc72a359e8ffbacbfd02ef9167b5cae3f9d29a7b900ac59ae492f622a9fe355ede4619543987b7057df5b24efc7894951c2056f5c996e48b8a038d60b2e0f83e9cba1464606f7a6d9f64d56bc9176f3371c7a84254ec167400d7bfa90779501e348d3da76d068d610be497171a96b986aa5d839bc2e718471e74c3397981d12a64ebd717d235fa333bc8e0be878f23e3e56e35d7850b23bce99e86dd1e2948789b3e94a655471f1fe467fbee24efbecd4518348b701dbc497b35a9d556cf13337f5d0a0d5c772b0761265e7c4fbf833366ed6f0b2cc02474aef464a3d8fdc85af6f57eb05edd666687b6d52ac551e6b1faf6196eb534c6f04d7cc228110f6636b137fc8636bfdb5aa17e3f00f718ff64144ac7783e34728754c964db9a94b54cde8c829a7f68953ac7b44defa76a367aaf9657a349518b3cdad6fd34eac60b14448d5d84d370a281db7c3465157861ea69585f3e7d79b81f0f3826b818292b18ee4106c17d6a51d19b08f8e73f64db6a45492461899895deea6b3eef8a95e565b2157b1a1d8ae5d34c8a1c9967953d1db2e4a5dcdcec23f9da4f5c1c4480fc9bd75566496f973c5e5a0ee5b6d25b470fecadfb53a60131eb5f2fe41e3f841e1829daf77fda8ea03ff70c75ff13236aaf07774ca9fb8925cea5b1901769025afb10e233180ad716738532e0f2c16e5ccecce9d0d0eff5ee22698ce9a0db65cd185381979f11d014dd81148c7b55a46928c5ad0b39de78f39374035cc0d241f6eba9d2d8b6232c9d280387c0a59eeccb0f75e27f54837b0d9ac460bccfa5342d3592d90e94dfbe9a51fb2cc802d1911f26f4baf164683865b849c3603bbbbf33976a17c29d1ac1ba3ce8b441633696da3df6d611f504580e55b37880f32a07e9cfff2e7fa9469cf0c3f84fa199533a8f5452577cc5e535da9b3818f154e01173c3c67560bb11a6c7da50c9c8d6099556587300f7fb678062a49b9d34432a511e8203a941d943dc38204f9bc8cefcd14c2272d0329743fe40d2a5115359f3cdb1d871a98fb202678b23afa99ad83a78913c349e382d04c9b4f330ba8e2cce54ab0d7d665b509c4bda5e920bc37ab26ee78fad84f33250010558eb008c8421e7ee921eb0360e2e986f8765bfa221ea16760c69b637b9c1dc7cad4f95dd4aac5e144ad3d4699d61d017508fe7fbbacc48e3f9e4ab8950572da32458a2b437f2c395a21065d9a7e5597cc65d8d5754ee9d0280e91895bf5960df00ed5efd5218f1a20c33d5a48def0d6af2eaff285978749e46088fe2dd355a7a8f03ea592ca4dfa82525ccb1150be5d8b3c5ffc9a641a09c14c7624bc5f8fccc6ac603ca5ab75bfae26740cf22c18e45e7ed48e8abfb3fdaec5a55a18e9ea4af93aa0d7649f754a50546943697193b8ae43c50f7c28852d460fa6d1f4a5793872c7452de6be33c22e57ef37601dcffc4975a3fc2590fa9423e2952331b4a17ec379824e2c48f4cd4d5c8a20991765dc4feb1e19bc7823e7ae0a29d22824a014fa7b70513fbda5b598f60ccd3f4ef5bf1d8f404dbc6cee106ebeb600a6ddea467de8d4686495a747e310a25612520ec2152756c6313fdddffd4fa51e7f22d485dacf27f46800675eb2a41f81b8eb35351badabe74784ee3f99a8c85126a932c27cb1d528b3fe98b83eaa191b430bef432c5744ad703b7db2a29c9bd1a1e65b653acefe21721b0fee5bcbb2364ec15a5df3893457541f9e15c353c061ded96fb0df8d591e03508a19a55b977affe17ae9a3b34907b40711e26f1de5a11bb7ed73dca96bacdbe38961e0598f0cf0fa91dea769db2cc1089a1dedace2fc0ab47294ba3112ee47f0d976b0af97fd9cbb681af6956378a037fc6f5c0147926401e1cee73a21d36c8938037b04fa2511e301c497c1d14a07ebe65424d0f9150add55399f4cb098e3f373d941df3d1187b055be877d206a3f7a0e6b59df953bd8070659ca006f9e9fd39569f4feec1efd7f0e321033c0ecc93774c8babc22fa6b143375667584185784d218f19d0942a694b4ba3e13772c8e4987859012341815f2e6d7e8c44ddad79a43b38d22471a3a6dfecf506d7c02df8583317f0f9cec7f698715ec2e70a866b6c474cb42035a30c7b0ffaa23ce73daa7b85c7936eb8c851dd448f10dbc8db0ab65627852696fc35ccd9ba5cfe85b41ad6690c8bf2fd56dede14064d1f88a3eaa57cfbdbb21a98773c8de78c2d1dc053434d76ea9ad4a3d7a29477190a684fad1b303bd1b78f17d22e37d43bf3c16a39cb5f4f8296789e37370c47fc316ebdebe0e08ca4cea6fc579cd727cead90daa90358a51085904a82601e2ebc40413d4e014fbd995b91fcd579de3b08f8eeb2b3dcab0e6fc50a618fdb20f8b5ccd986ffd895bff412db0eb38dac627dc00057f11bf82ce78aec822e8db4651e8315fa4880b394a1df2d2655ea73486f3a7a7057c12b12516d3aeeaea19c7586ddad95d63a536deb4a9e3eb21f3cb52d5d75d5f4493382f8dc1284d817e804cd81032df032e3d2cdea4e949dbd45c4e189df0fba35826df0435cc135e63b9cafda19baff1fb845757aa19b133b9240b86bd169677a673d22f42c03272ea2c01949f2c27b557b6f9d8f7340d8ea44841b4d434a2dfb91149954bd74d525cf162212bf826457c33641eba7947cb1d6f5c85fc811428c71a172dfb8c8c6f337534bfa290ea7cdcaa67f6617d2d4748d27be6e4536f27bcd6bc264777bab383073413ab10330517e7e8bad0189053d55cf0b0d79dc53c26697172714085aff788602585d1bb46d2c60298eb200f63a405ef508808dc9a194a353aceae75c95e88bd2e64aadc6190ca2b3a23edbaaf6c98e9448ee192b442655bc5ef96a0bdc8f953c618f4f5ae7e6d5c24dfaa2f9c160ec89032c3d454a6b57ddc090624c5fa6a481edc3c38e4044a013d17b1b6eadc27cdd79fa3fb13f4bb3a8c00346e490a0cc6c41ed15ab233eff30806c5a802bcc3f784d154fb2aac510a0e27914408ec20cc3c01fd65fad361dfd4870b419c8bae938b01ae442b1f1efecfd443991292aae5b62b643c57c3ce0ee76e740875383b59504bbed9b276347468bda0a5437105a356496c6ec581e157545f672b28cc5fad73f37072232105116b4a8f618024dabcbdf1022fa0d09dcdba43327c3fe34895b2c9b025ed7a82bfc4e381d5d57a905d3df6df8a0c288887140126ba63ae9a30b04124f1ee37ac40dc59bd627126eb12b25d086d891d25d6b06ebb6912fa5e034403241230f32f375391b5e00c0ed842b74e009e4aa55207b7a605e7bfc618a04e292194f2bbb0af3773bb0dbb1c70b390fa502b570423845ee7cd86f0ac26492bcfa6269ba53f208544665db7e62e89569fc3d98d1c1978fe9aa99074451ae23b5c7f3aaa31ea927ef33cd36971e0dd19010131bd52e32e13f049bd69e56effd4d530b85f32c86c582fbe9177b37e04858959449f245e3347ef3dbfe1b42f2f9d59638780b9869e510272fd851b070eb8fb7577c79d358ad56f1782210ef9d4e817cf721a8fdf8afab5262d80f435ea42717561faf3e4845979b62b1955f431dddb2b4ec2a37dbe95b76a278b28f840c9f07f36c2e0a61c645a715d430cfe14e18c2732a405a8bb5b1a4e01015f9ee7e05b5ff791f3037ce7dd6f01828525a70988185a89220025ced268945c4d8a2b6fbd5b1dc42d456ae0362b38aa0b2ec90813b48622687db991f4ca39e19981e1e9b96db2a0f7b8826a131649c3c26f2640a044d9d218213f467556997d497009e713d1044e88e5cc7021c840e450aa13abce935e2da52accbecc9e1be0946827b0f3f5e102bb2fb787ab4f5e9d8121ff4bb9c9b0d231feb12940bcc1229d220a74fa98bbaa7dcb8b728209350a3ba3f6482f2569131e815736472f7b7f72deee7fa9b9b94d1ebd5b97e2ac090765706e0176fec66f2379f5f9d7f9f35becfd77c340eceeda7b7cb510c4a3fda4a0ae0493b10487e85d5363d5c84cce3d82a3337c20f71855eee053fdc2ceb0a8b60a6386b0f19efae0bae34b495fc08b738104d8ae158d93083ec8bd114034eb64ac23fbd986b53a1cc7b881e9b4b41e631fd5a65ad50a3f9d68bdc8aebfd9ba171831341d2c23ea3d3cdec0178a1297cf41ce195973c24efeee0032ebdacdf6ba9b003a28dda6444819e909452eb48db218f250655001c878dd176a38c22d2bca627dba40f49df8138dc0cd64908880a468e90df1551be28d0a8973209ccb0123d91cf7f3fc755af56b0bd738a4cec424688a3b5c2e0f38e17dfbf7fed5224b430406cf61d5633f1283a97d0473c4e61bd76f0d94831337474ea8ec013b1ef2436df763739ca26d2714c774b0fa990148189bcc2f0729aed682cb8bb5c4d93a76c4865fc62dfbfc15e1d018dd42d1ac6956c889104b7ca8119b595b36bca86bb8a0bfcbf2c37ccd406d298dfa5fe5641ed4135f3e0bad4f2477ec0580d7eac403a104b6ec7f1466ba3aea5a4b7a12e9b993e09c54b61af040ffda2ec4d7536170a91d4b648b36f1ed76f9bae6727efa5da961ee7242d4e942534c063e68616a4a69572bf78fc729d2b66a7a24e51b021014e90ccb8aced64560931f947bcf1bf82fc3329ce05aef0ae2019b9b5450c9ac46911358c21db673a5a85f2ee5548a085c5a9ee2d8b026c0c1f80c5c56abe36e3b3d5a69f35c2ad5d84aa6ddf09482f2131239d11fbb4116fae945cbc6dfcc0061645f61e6a907985dbe857615df29eb90a94c8fa6c92b4d371fc016e49417cbe33fbab44c019d76c2d3e0021150c04b46dea6f2d41b5f5066ed6cbe58185692bd0d2b2ad18ae4f1cdda68d69ba4f893a1ef71b490545313feb40340c0f72e123bb735fc5d9d04d4d405faf80f2d9fa324ce6e9c45449f940351823327555c54f6136b4ef5e22d7a5b3fd741ba83405f18263586c6d2b55f0249f506e11e9405a2e5a5cec3db5f6693e2f70d3a08cf780f2d8bf62f6919ee37e283c29fc7adb43c75cab4fcb4996909c873421dcc3256f55667dec928f0785cc6a6ab031667d0a9cce0f2b68a8fe62a9288a1233563829c80de695d0f390f61ef1b2bc37d523e3a55f812acb5933a7fddfbf7d77892ab18cfcf28d43045097c8a7aecfa224f44c05bec2829199a76c7a5e504e4f9c75cac10d54928ec20ce1faecc9ef8009a0f047ea9f2764f2e70ae70cf8fdf86216a3e9f572dbcf5dc8a956e3f8b5aa395f3dced2d65de84c553c8effd0abdd9dfceb77a8c88ef58b226f0d40ad76954193fed0e5d015f72ebafd1f2acdad0a972465d33860b4f5822dc0b02b3661bfcfa469c1e2cff5b9fe32fa5610f7a85329d3a39bd1834dc8f45d5af80ac8b53a46a272b4938e3cb366ef043d2a19e7eb2c605ce0ebd21ab10ca4d279aca78ded596450f179cfe9b134514b06c6788531cf3487f9765a44602f26916b52b837454715d3c25300ec28ba124acba31a1beb259d1877ba4519de39f9bcc506fad72c99d1f5a7a51e32edecc7c207f170e2e0581628f81ba3c7aca510b6d6ac64e045077326c9b88f9ff345341bbb6964afc293131cdcd0e1dfe7c199d7555bb1b85e6391237f9a3923da86e8cd465227d2a0e970dc507d8f297e80150ddd0c7429424b707c073d6a98488fc1e988542152d3726f7413e442a06909bdca2257cee9e5791c789e77732a93240eaa8ccf671f53b4584e9c0a335f8968b941e13a21893e95d9778623d1e2548b59e5c4a26b4256711fc881fa8c38aafc589a1ee5d5231c4e9eb73e06a0a1e783028c8ddb622aa13d369843cb3d35867270587c18942ef75590e6355f364e4d7a3a09d2d39ef88a3195c7f3ce0dbec9a424e63c6da2201858b5716fc9eb384396cc86108e8c7bd8363081bc160dfdbe987de21e9627f5557d3fa66e6f108f3d0e58cb129957b83f001a29c343dd398e29350619f824bd2eace10adc94eaa42c643852c09c13f954064cc8dd6ef70b0ff29b35b96082fab18f47e66d6f4fe3cd0e877d943b2b842e282967915cc53523d9327354f1676ffa27ce714210c689351e1d0b6614470afb9b01dc24c920ccae2f19d7f98e332751514c40456326b20dfdcaca9d5ac538b0fdc09f4231e26c19ea81dbb7f1a1695dc26775a36bbaee1716a871cb6376f0d5326fe4dbf8d7baa959f7d2fe2bcf539163b420ccbbdcdb41dee16376a677fb630bc74c8151b4657d576731721e1b6fd65b020baa4dfde17dda134eb2e822c55c0ad97117b1feef8d6ff3d9ce9140393638c9fbf588863431f6b822b36e666e622c7f40da89c585d1ce5af9ed7c3cdf196a483e8c8671292450970ae485d2eea7b23f50881866df7947c4063c91f244c6cdb6bc249ab40fdcf44628cfd6dcfdbde3ccf8199b823d5b5cd959d84c4de50dcd39f3127392950981cf880e135efa1a43a63e195a759feb283a6d449402299b065beb871fd3e1909ea2a1280d81f6cd7073d781f9e4a9b75ed8214812400b0597991309ad3df033f5ad2337ccb2200f4eaddd812fce070cae91f01b9cf25e46f739939518d0feee8c76c10fcde019e6d50b6dff06239864491ad687d0da8b787826147ba14b238a72dbd4037f04a22e5d1cdcb94bad755083edfc28542cf16c6e7ee3c23cec158ac75176ae756929153015b15a733afb3a5a098d7a81aea73b76cec9b18f753ed9c4040b01a28be8594d371066da88ffef51ca05dee1868ff734ea2eb4a65e93053663f85f2b563a94a4c9a40b864c57f44d93715db443cef9c8c041cd9d5fa67334ea70752d140d1a5765296bd1b28d985fa183ff3fd4f6a38bd0f4302a71380e72914062f8d62ab50d34b8510ea18e6dd2ef3c02b7f2ba6cd1f7e2f1413acc0e9dab2d3e57357eae3e097807ffe95f344ff74a00a09e2f14c6188d2875ef48949a63def172a211accc007c6c0e0936a6c8097619cf956f2087384feb4b983a1dc3f6311610bc23232eb773de658a6927ff2a71f90220c36188793d6dfaeaa63228fa2f50753f1129579fe2b92379dec93dcc6da144e9cef210574233d94b0b7899cf743a564aa9dc80e5c143105acc9e9f2210235183af7b5e3b8abc786722241b96d8f335f67459b66158dd98579ce7f1bb4f01c27fb2000e0ac4a4530a53cb41bb7a3507bce07ec205ef0692c1e08a4febbb24e3e025bfa7c8db81613323bdcffc89504592ce708255e01cb2366128dc53830f09b24e070dd10d219393b167cc6dc1f28bc76c84a02268f827c1982770673caa87d6ceaa514887c1da61c7a5f491c20ef07eafbf737882f77b2697a5309a938faebc7d65cc3f48ba95cda285298b7e8831fbfce8559773990682677da60ac7d6ffabd024c326aaef07ac6d4a342a161e058f1a9e01238bf6d2da7667bdd482b8b3aa0e2798aeb70aa4da83aaeacf8c5add411f9a8addc94f58640610e01813b3be217af7d9979a48503ae6a206b60593559a88b7189b9d06633cf38334b69ff7fa37f8025c8a1c5ba97d07bb5c4b2733bf60f7755a73fcff92232abbf90626c8a7c0bcb5350e43a88b766acc9467fedc8cbdc307920858cacc05d2a35cab2a7224565bcc17b382f20a262472433596867bf682058c5c25d0cc33bc83b0abcfbdee6229ac061ca729bca3e31ebfebaf9c2ae98251592dd8d753d10638bba1e3d26f18ca24947e2a67086659b6e6ef0412d0b35f1dad19bfeeb41e8a5ab3df98c0235fe339168b11636135f4d4dabbf5edefb38ef5190a9c663554feeff3f874b79c644b99ed83a2de8ba81a56c9d552beac7ba75ed65177b06a42bcdc645f3762e7c3028916648278a9cd17dd37f53a37fab9df35a72962c414550b3859630faac7afd42ff3d7ec2efd8fa34f3de660a39c2bf3a16f417022a50971971a849d064d1e502586d7ccc1a91c424ffa0b7697e95534f5537defbb803ffe553227ff74a68b3c4b302bdb1e07789a98d9ca589eb2ff96efdfd46f77ce376e3ea597b18fde2d441b87ab6b745e742af10cda473e36658cb7d3a211b596cf2fb66f23fb393380a835508ef4a57497260b19016b154ab10d61e2f74a7cedd5e2f258511f71080fd13811b590d5deed2ce2ff169e91fb38e88cec86ae253d2242e226153adb64d5d19b0ecbe5b0682592f69d7ffeee40aa7272a3490dc7b60a57d62a8442c3e6b8841890e76139b54e028256f8bdaea505e67f438b6d71a03d08799566be8086f3c78d448dcb48f5c9752488cc6875fdcef1f37709769705a2a52d251f152e315808e96426f3520f62017c922e523267eda672a4f04b22792c3d4010dd476443539264c6387ee38fff59a9943c3e3bcfa2820c3108d6eb13784e0d70b2800848a0f714b9ef0ac71112946baf352a8b4d6deb035fc72cdcccefa227fd7349989461d6d790e6c2440fe44ffb4a6ac67448e1102876b5e06213e9e3c7488769c592e8b39207488a60a0723e91605d83510b175725d753bf7970767e665ced587052e718d000d1603cfc79c9c429ce404a4ce8fe403479cd6e7c45ed33a730fa478c710b244cbd9b00a6ac4f8d3a74889713f95c5cfcf40a4d1d7efa6810470fe7475af9af1c73cd71b17e9c56fe2aa26c1be22341ff00461e60b77f4fa37c17b4d2ee6accb081f2313e161b4ad96bd597f8db951f75fea504638068cef81f910768ddfe285c3a7836bba624c430f3a468eaa4569aa5cd82b419b13a683eb9cb6a98859af364d4c57089647ddfe996dcce10487c2905e0f1cadaddcfa6ee2a9693d66234b5f657d72c36a6c870f6eb8a1dab779050bf83ca5a5226f7a4a0e4ac5bd11565fa0c65829ff323eba1cb8885c9128103c6f2a04c0a8642c3e009776399d41757b23b9dae072cc864d8cf279bd07afebc1dfa3a546a476d97a71427b7cb37f2604d13ea2139a4cae3002dbd85da9445ea0fe07bf6fd15caac01605c1e86ca878f6b71473f94241542ed14a19538d1648fd24a0eeb06553903089f3fe36fca02a712c3861b4f50a80d24e30e97ef565e15ce4d268ec56bbffcb703fbc9298b3aae427b2ed1b3e3a20f13c16be8742b9eb56447660c163f62ab61a630e7fff63a5a12e5f34756fabf9df820f100105de6a55cc31abe68a17c0661a632d6ae10b5cc4970be48684ca35026b33dfe1f8a9b4d26f41c8a335a4507508f503ee5b98400444b2bea91034d22f2444d9c8bce0c00d56926b1a65da27d0be95559ae9cf00132525c141bf4d13a9a834ac49257ad62809ab41a21f4dcd3a7ebacb6da6f36d51d5bc20c14cb226d324a709f9c5a207ee1088d1c0ccfbd78c80ad1a57f1964e002277bb4c852bcaa767a5c3811fd014dbd4eb36e16240d207a720680cf6bf7ba6354714b8f94a88985097d4f4646bb5b2aea4abcd281323f97a41b44d7d5a8247aa55b1b3708cde7a9c43c97afbc2f7f9fb9bb21b402a25d59fc27d8ce03b0ad1c79d4b983e2d16ad7175819b66e80440fb5a7c2d771e4cc5d61c95257f61aaa48a1c555bcded97e4fd29b706610979978520a3a067ec50336591a209e5138cfa656798a462ee241585ff37a327b5c9a65c694972307ef1606f74cbcc4ea16a4bb7a71cb16e7349672fe6f124bbbc7ef7d1cfeb7f25e7bf70a9e129e1b9abdeaaadbbf1640df028cedd72166ecd65ecc0977526e67e86ea3e366564f955a97657154d775c260ef513a61d4e1061e45a4f847df1739f2597ffb9aead93209a1933dd1671b6d03e41cae77b127b07e58abb20ea26cc2324608390c3bc4eec60589f8b010c1715e18e4b437fffcdcf6560913f9cb77c6a90c4cc599a8bfd3ee593dc75c28a03b49a97b2d6e2399037f0bd04306d2997c5f71ca20959e8afef5c851da0b840072c981ae6aaf7ea3e25ce03203ac737c2a250bc6736bd21cdd276cb8135cbfb9934d47fa4571ee31ebd6c715dae6386ce1f890c1253e1dd6a9f3ce3d2444e6d837a59387b68072df6fba24f6db30060bcece793a50f8172dc304edeedb78f0590695f578f138ccd80eaa02d0f4680c404e7283464e6cf20d13fb4fed16c4722c060d176a13f71e633425ba7f268edcd2c0c8ef568fab2023a1b7e265672645589eb2989672ab9917c3071fbaad5839bf32f6652cdf77924645425c3e015c498a52b330205849b554331e3837130e1399e674e2667fdeb0867781aaf50d25b415f00c70b5b28ddec98e0434d47f47bc4b8c54c18dd894008344af72a0bf00c36a165dac12fbb96af3efe9a8df9559f598dd22c38a3b778bae745ea8e454e672f8ba1aca7630f46bc8b2a1d556f83097946ebb918f945438ab60a6285d9a12337eaf244817174795d0007bec269729bddddbebf2970b6b0b2310e1ee25d85c87a0c5b86a46630cda2e4b9cc1c294f12f70870c57d61b6104834f544d2d9c02926dc7f931305bc17d382cc76ae267695f71cf38b35da02d95922f6b406e3638a9a883af7ab87985dc004767b3a17b722f324c2130f863697dfceaf9878c45f113856fdbd755707aee8c7b46bcdb9db5414d6de8242437494267f0be976c3b79a07fdb2fca43888ea3b8e1aced5c9ce74591ba12c28ea2ebf1d4d9942b6d5482447107f5d2a7eb3b7486e8740837549c993a9edc06845c43b04b02a98890d3e9e04c2bbd08f77c1dc150ffd4b45612a4bf328003ca49e038ebe4cf0a552ac7e75995c764536a604cc799416d49d0c6d63ec604e698a4c67b57e8f52adaaec0041bc5cad8075e8e9aa43423b69366e5e63ef6d9627af9173a68f40418255a82da2ba70ea8ccd172b29982f0b911c69270ef9b3872b8420f588c3faf312df62a2d8b5ae58759ea3e860d3daa3b181a1a4829d3c9cd8e5bc2fc958a26b7a9249f7f84ef515b8fd04dd0cd61c7ce966d298c8bc7495a8a26ae209ff8f27e5ae56bce2d5ccbb0435b177bc11f946adf71e54330d5867d9d43776f87fd7d8a9642147205de69d7a66b88d26906b2fb6c6105ea63dbc9b9920ed82b955e43379e09d461cb75126778bd81d6c88daf828d164c8d7a1036fc1529629d112187f5d654ba6766373f979055bf6d4e7b21448ecc95a34fe4e2c5d5a942729e74abfe436c8131ba536a0d0508fde3e6ad77e3866f1a65c4f3b985fde9072d5ed8fa876515ccbdb093c896378562b217d4663bc1b5b9a26fd75fd51eb98fe4440aa19732b31b02909f1a0b267b40aed162a1aaeb1f6b49584b65dcbfdd7aef0a6141444cbd502f0dae97e3cdc78a878be5fdc34076d70371b0a905ccf96109d8404478e39c3b27126b49e27368a1bbde3a7cede728d37c2edbc1bbfe2217f0a67f3bcec1ab61e70f947230fba2980ddd76095cfc957a5599dafd5ca8ad0762a6dfe1545d9138274fe24702032085092a56764b59e4aa8acb3f698d8d206c94ef98d61c61459c8f700b04d5f3f095b7acb2050bb239ed22ebc4d4ab1154ee834aa8e3dd1e5b97f0f595cc9bc443064275da0230fc34f73d2d0cf31c13a9a39099451c2939aac962f9b92db163b51dbf1c084478580d70d5280a9b67aa27b4c6af2a89e001b1e24304e227a6875e5c3ec559512c7529ced4d16a561ece5ef2dcfdc19acfb40442b7eca47308a1cc9638d5d8d2df39ce7da0fa4fc34a04c31c52205d59e42a07eb53270eeb3e189460db62aa015949339b064a36bd9ae6b2c8ab5e090c8cc1174de6f9ec0c6ba5291a8b55e6be8027586541d8b6d1da30fe6f62a52670b227090090932811671cfe0ad842e52fe84b97055f2b6bbb81f3293b47ff8e459becffcb89f87630d39da67cef2e0a6492a5756fcc8a4c821df9f14252f2d24d615a9add7dbd5cfb6e292764e814a633ee678c8b6d1dffc96cfe693515c23edf013d132eecf497d0fab3a0a76165358decad73c7aabd3176898406e8986b688de306bd4e9d178e695a62e0325f30ee5ae5014e373e4fe49218f377b2709c442eab91cf543535022f32f08512cc1b12cdb38c96a35d55099d6b9771e05c33889e28569e4fe31827668682ea31054cbc2dbbe20d0812ad6b93794a17b747bea385954dc5e210859c988e2cff8fa6923081cb3cd632b07f4c0c7ba90686593dfcddb3f252575414f5f24c1f1c5096292891e2ee34e2e3d3e92e8b98de7d96883936241ef7417a6f608682f905b82408f52fe15e58b84b5665bf0092a2e9be8e046c318c587896a3f063925d48b6a32a140b42d6ce8885f6b26deb6a35d0ce5d47b831b34a6bddd4ee6f78dca445b87ced18935312285f35a57f7ac472b93972135393aec00b996e2115a6d5996375cfe982f6333d5e0ed46a224d45db995d4a5560f3e316afce787fdc9c38894f6985651f68a8e3775d7ef09d65db05c3962cb9fd02f5e7f7a295a827c907cc14ef0f305d9386ad550ad6656c819470d5e6ffbdabc9d20d23b20159b83eab7e76b0a6cdf84d87d7122a8a7362f57a693f3c85ceeb29ca9c06c61c84d20ad42c0a0c8175050fc827e9e9846a30425a4e1ad1c27c11a01c7cbbb63581a542a2ae61a2aeeb01d48cc758d8d20d9c464a652125a1165faf4d920d45e5e0e7f714fdad2e7b651dc7ebe39f64d3402b3262b05fb67d888204894899c5e7efa304b7d2045b3881ebbd7fb4e99f4939a507de8cce609e59d3357fa4672bc3bb58c5e091a50feb4c00d9b3fc60a66471c7f39bc81cd4e14867563f3d135257f2187378924df43f0f2347c801c90cc08c4f064bc3248394c56560bfa6b01f9a3f6cada3b0fb3c0236f57eefa84d0637ff060cf3d550d3d44ef0f513360222aacbeac6c846d7cd6107020ee4255efe13ec2f82a9b31761b948172f2f0f601c310de7a2c350659a562b43de6ab62c38f4e6ff0e2445f8260427d29b63a7f3a307aba323c975c83ad379820b639168a7885798241d9dde54e48d4fe3c2a463e9134db415e35f77ec27c8d6d9bacbb2ee6941d2998398919458b35a1d32c992ffb39334c1f1a9757e9673b5c75d4a9c0cf9b18618e554f692984cd0a94b0a7f807a756a5838dd6c2a68046c2680b1263a724c4ef1212dc66549d73b12c19ce849843efa19f6a98b8439904a589de604febf48123ca5daf3ad8d3980d38f5e2023ff8feafb3813ef1c68ba40eb74f21fe43521b33f79404bbd1ea6fff13b1d842e3dfc1630a801ee93ebab413045a67c04f8833fc8991da8528c91c17056d4f21af9a8c29a721f9c981d3c57ed2681751b6b8b2ac6884a0b5f60f265cc5742cf149868c6caeb43256a83976cfc74413d629c94a1ecbd01602fa965f15aff55dda89a579276b1e12a8935cbc1a44faf918b7e8b44a69548550549d38a5cbe53fe767d05d08ef6e7cb908e6c17d3f1197906158c44d18e4f99eb2e8e27c2c3addcf5666a6d33f40791d396ce7144c68f73e91f5e59b2d69faf3b354b78c4757a4defebab7355f8bcea77d064b0d28c23992c048d6013be237f0eecf26dd2b1efbf40e46a30ceb8eca854314f5a378173065508b917e5f3dc397602bd1d13d438c10353be572cb7d6fb138c17953466609a0d0c5973b820f17a5f77754e6e1cc2cff5079b5e4cc4f70e90c32110f5be06103e5d00db1787946d30a90da1dfb24afcd95db8a80138870ae489d2be39bad0d1300fb3640cf1514e101d1e46534bcbce8683bacdb01be2445740ecc52275736a7ef79f9cde7fd6b4b14f4fd1775be0f7a1b02244cda79e88e664e5732b94f12a7393862b1600d774969f4ff133161b36c823c6e79380db163d40c1ef60da70b0b0870130938b9356e5b1959dbdf0993f24ab9dff7f7e0f4e352e855d16eec6fd64b57043ed70815087e6cfc020b46cf720c63d026fc61c8bce410aaa42624ab36174fdded09597ce27c006e0bb3e2304d2a5356aca86bfac6ca03d8827c3d720aec362534dad5965776cd1f52f88f1b7b61ae9a185702714d723b9d17275cb17506a79bd503af8616274e172eda75ce444d347e429b8c6463ae6e147b605b0114e7bd4f9523a3ea66e1b3a2d698fa19dff185cede077b6529129d0a3744480636726dd7f431886d0acef1678a538df46cdd8f32ab325b5492d91ea6a6c5ec6cf39a1a68705630565af8015aa1cf7bc3e105883b4eda80b8edbc1c6565411870b47040792104c890c864bb6ee3efa50c055f3b5d66acc71e23123192071b22ffe70326dc4c65f2e44391541ccf48aa78854d79f13e0a3255c76ec2f5f5edc9942972eda6a0b3e6075de8d8147fc40acc277421854f415e711a462c4f17d9ca65c689ce6f401a425e1494bf86774e650c0739fade916150b4496e41cc298454e815971f85f4c5f89edde068526dd9a8c96b506dd998d42e4c2664d5bf297849fa39679241ffdee4170f35a08405e8e07bd98ad506ac07645c66916f96dbc86960126282e321a2a03086646b4c10529f79f6d855e50a814fe8711fe1666d04122c0f764da109dbcce40c6b7b174d6e6e5052d7f46c346161afedf04eafa1757a939de9dbfb7f46bd49c93b4f5a10be57c8994e5d8043b12108fd447548363f0eafb6dec2a31b2698f8ea791b8818dc6fed43a3fc96db6cea1d25babe4b22060041196be5bffab808f1b331e2a253f847d2cdbd34487bcf795031b85fc89b58fe6fa081edceb8613a302497140fcb3d6264b5cd9c1d4e76b06e671471c4cae0d4e220071789fabfe0c3da5da207f0b4c83fac6450e604e1ec8d1e041e46cae8ee756969ade1683599ea56d9c46ebb7bbb9d132355130d23b599f22baec7a5707b570d95226cdf5350bb0b06e9e4087b25c495e2fb16fa68fd5dc78448f95634f4d061d72df402ed6bade051d0af3605c80591082075b20b0cacefa9210325aa1f209815913f309561a6181bab97caa1fd9520fcc3af0512155bd51178f63e1e2f4a9b914bf99ab6fb0f7ae46aafa07f3acef75ab40dabdc72b67d55d0478c7294952b8aa9a2c0117d5b90885573afb9b8999b7a8a376285f3f8a8afd11fca83d4295f13d0924feb350e4b5028464619bde79a877fdfc790a6f10f3b3fb1b40715200aa67024c899ce0b01b1eeff89f90567e13087c7a0b283c57fb27211a75500899dc94c61b0a4541a3c0ced340944717703f70433a7514403aeed00d778a46897006b151948e2fc70590186a644cf0f3eeb6219bdd42709bb69c9e2f35e026d7871e95a95cacdd191ecb54a7fe04b904269f6c0813755b283b25ea7e79d09e702e15a1582371a7c805243e91429f2fcf9bf9b369da35ed5a3c13d94071a30fa9828d311ce8893199369c2d2a1edd7305f04fc631c35a08a0b1c88c82b0aa28cfc820532d9a292aba4ecc8c422faeee41982fb59ff5c76e015d45677ce62dd5d2f9516f08a64928f7193bb5eee98ca9c68c6c681949c789867163c0c1f8e22a20695b470ff9fc52151eadd03d85f2f13591f30e8f22360c46bf4d85f98b7104a9502c9dfc456ce5dac3b3259d2ba3d9fd5d3234377a7cb1c202c31920329da8c7d2e81984b08956471921125b0812db051c48fe15da638a221ad862d4d79d07d29d0ef10bf7602c765ee6b2126f22980fe03454e2f01c759c22727a3be6b0f29c59345a93a50234f0c9b83e00ab591b2457c70b15a4afafd66c6b244cd236d4fde88bcbb955f1dd2062108ded75c765771e055d6349ff4c675692f2ed6bbc7d44eac1cda0ee5b658d5ed1297a9b3a233e0ff49b67376f461000c804cfd032ad98ce5fcdcdee81d377d0467dc8390b71a6e34856502687d25d63b9994924add44658a8aeffd52569c35fe2a9d50a1904f8635e7d51a5735ac3eb0df7302c28ef54afd3b04362333107ec87a51a170629cf12ad019e3b2297470ef0c08eb6a1b9d550201bdf21298a282fdbd2f72387698c80a409c60abf7ad300c13c55286596b20809aab529c511b8b089eb8cef9ef0fd4f5adb5bb5f3a7af8d905d7f9c6ec8bd1e0bfd8e8772f6eeab1d3b774d7011a7ca5c798bf9f099794850fe61831d526781edcd5948932fece33f758834441b28845e66bd21fecdc473f4f91a40a16d8fc2360995794b71d5c4a069c45af29dc1717fbe030e1b13d6bcd27d559590f0e0b8a6cba357ce6d545e1fe6892f7dd58b652675f66d34fa38cf76989c990234e9b843084284952355f0ae7ecf0e8de63b1d07aa05d44348b03814d01256a8a34e80dc3d40a6ed2764f9d6f00e164039ee275a2a404a1e36230cf7434e3a157e542cad8cb793eede2b20f7a98e7e4f5dd06c82d98d004094e5d8f4537d6153de96b3118772f2b2011022cbec4cc40cb1a15fbd21b97664d8734ad2c6f808755f7f202109d7e181f3ecfe02f47bf7487a7c1ec05196b80a0afd4b75bdcb06b1b9a1b939dfdd25907515d4703fda00bffd1b285cb478fe55cca0b0cfcd34da37efa6cd876ac6397571f6c64306d6f8f22e71ba880129a6212a66346673cd5763bc97f6115e41cb262a23e01274668912fddace0b27eb6ff82aa1a182a46a89c521bf4e5d33b934f2b811fc4ed5b78db3d661c5cc2345809a2697ad1d07eda2c911162e843f4e930989f7adf1486590deb399f323af524182f9706cd300308cdecf20b9c1aab2a72bdbfe66916c691efa0a9153213c6198134448b19dd9397bff13859f2a68308367bf2616e1785e3bede6dcbdcaa350f158bdd82c097d7639035d394267cb566414c971aff8887631b2c16cf066cf3225910fe51eeb4b36efa851373572cc3be6e76b19abb4eb8457de0a718fb3e78ec5179e12edcefef655d9429a77ae76db7eb2499782274671fde6fff2af0783c9a914f041aaa9f7ec0515daeed6abe96a4a14fb4634d2ffbdc379bd3a93ccd8eb507c7e9457487a57b2b9dab3bc93121690f04bd63e35a7bccc4642175d4fcd2c4cc5ac5ccc5b900e574936935778adf2f68e75660cf7b0e670741e480388f05dd0ba519744db226ec8ee47db570932cd0fa08a402fba03d0bb5d958639e6548c437fdbaa102d8509541b967a05aaff84d3890d96def02f28144fe2530861975147e0a0b02417331dd9e2b4ca3c1999cb2f1705f63fcc5deb389d546c7f95ff047fe1db0ce62d6d0a91acdb965dca3a7d70722f6da351d514e0ba7ca006ba4168283fdf080e42fb188dc2903f920d2bf2c80dd056b701fb1280031e004c363465ec508c5589d46566cd4628911762e6085db34aff2182e6cc184fde4c214a1d58c1aeed4ccb5a53985c8c66a7dc739d21d8bb0df978fd25db121186f7529695e4f67a982ad72cc779654689767666c368b671a03e763b8170654673513877656158eb66aa8658d1c18e6abd789390afb1dcffd155485703cd75747fb16f6622007b18b9b23ede343cfb91d18d4d6248981a102df2e2820ce55d3cd0389290098ee850ca16fca48601da8bf18432fba2c1aecda4bd9f8fdf3ef9707950c0cfaa7d7d317ea7d27f8e4e76f23c247634489fb53d6d6ecfcc3fbe4c34c37d8776fe7cfb247b1db8f592295c16b9e0dec079bcbc18654986a95d583a33e150db1e04526bc28507ba38b6cd90f4a4477bb259555f6e2aca3fc44d7096639277c6d07610ba05fd8171fe95d64c7f24cc13c459399178941821c90aba44da0623260155a0dbc13346fd160b7effefce5408297dc2081cc01a799a6d43f6c365c974089b0e5053420ad74d2af925d2e9562108ec07da67c1f6e7a1d09af60d4245fd5340e137fd6333ff82d48207bbcc400c58f16f063d1b89f1245a75018ff9430c925d27343e892fc8e7d7b09f47b62ee8d20da46545b4f3126924991b5e84bba6c8301c9f77bfa9522781b740f2acec7a65b0f9f09194a20d2324894c6bb6446fa215419f71c2596e95fe9f3e726950e1cd0ccca294115adf878bacffa0e16d427669a9f5b933c1872c0ed79c911a421d6f2d13c3a38c835ef992f1750e88bb853b39d6c262e57fad601d5b53ef647c7b422d524a7a24518a8bf6a7118090a04ab3db72307abb890a22430622f37b7025adf7077a7b9a774a2192c44a81215e53483c0ead7e5b968b0cb059358e3764fda6fdf7e93aaa690c37bd6aef62c6b9e5be6978588db73db4e871c0e2145956fe5d8fcd44397826fed82e9543091197e0fd47da4f3630d5c6fb3be98d2746c14827b0e98c0cd2be9e65291f4e00c3bbe38298e6252c16107720d2ee165d2ed989e8e457ec2d4c9d7f0be0f61e4b8b6cfe75aae9105eee00d95346fddbef8f4adb5a1b8710b60470f856063e156c14684caaaff09a0868664df1649b2c563be7a7656dee9181c5535c9fa85bf27ba336842dc66760d26c25939e1d8ae4afa5287120c7b739beb7b53c25379fd1cfcf2c21f7d49737081a943441591ca3ac29189a62392670731093cfdefd9747eabffa1d84c32c3b8e467c8baf6d6dd540f703a527f8aaa67683011df21c641918c7427b77a83f13bbe3e259d9cf7ba9d738408a70899442209f171586f3d2f108614d76d1c695608c35bb8cb13f9d9c855c81399891a121d7d18ee27dfe63085b8e055cbe6db3adf5c7c89adb96156d6dde41d403a2fde1a160aad7e46a416f5b9ffae76bbea0b22d7b64531256fb12def47bdf3613b54aa65867035d8b1008121e6d070a0f207ff254eb200c711684146a215a2dba8caa4d90944fabff5b0b0e665e32c9ccb4ddeb2ddf68c5f7792b07056b4edc497d980dd849f6efb62d624861f5464e9872077f77320724bf645397f1d180f75ecb486be1a9b5a357f1df64ca9649e9c773ad657a35bf1bced05d795ecd26efae072ab78eca4bf1d7f516fc0e6f15aca60617ccde298b8612a32d3859e52c392ffcfc6e763f3db53513643daf80277ccc838846b9bfb4dee9839ecfd23ffae14b0f692cb8e5bd0f62f6292061506aad8f2ef6469847c8eebf1e78ff5ff4203500b07da64409c3a7f7dc0d8ccf190b59dd81708296681c7591f4df894732b9851d4c2ca272a3b0de99bc0ffd22b89d181af0d1381455c1c019d554ccd4236d9e3bea2ded73f031fdd3eb33b56b09e8e2cd2b780c230ca57d9e3cd7a53b2719b1452f33393f8430ae37d9567d4fc641d7eedd2c99edc36ebf9af0cb49a3542cf1a5f214ed4efac6ebee34a0c70bdf0a8645f80bdc36a519aa433cc9461248536209032b3eee9bc5cbed1dd0259fde24ee4548042b008a1562b3edbe052271d26289931e563f5812fce2de41dc6c8cc5485c3712f7d3381907c7b727564d9effbc82f31f1ff0415520dece0ae864c5cae18ee114aafc95e6c7768d222eac487ed0ce609bb92c7b277bdf5ff1bb8824cec95a3c0b7594910359e8a0f26faec0ab94a2ee07b3314ab2383043d7fceed1f1a48bc67f7ab462ddbb0671b3fe9ab6b931ee4ad7456b170aa412b84ef5337b9ef407a41112ff12416b9932bb08b8bafd4df273dfc35ec65dbc5d2f8c6f8ae270f4b9f578b798f1358d7a6474c6a2cf3c3f87a49a7416e6d41d65470eb8a9cccf0be6fdb98905d61c320fa8916584d62fa7eedc98b19e24b5f65c2179af95077e25246168369a521ca41b08c12427851baeb943b16ec695570765e1b2ce0d9b7d1fc21a8f30f80dd5c1cb2f405e0f4870852668ae67070a850c925f97a85a152b8f453c90a7fab058af20360d661bc7bed318cb3430d6dda892097abeaeec6b3f582650c86f79d055e8d349546d8f00a17c3b084bf30439777471999dbb77eff7dc36dc3e57ea04caf807bca027f108a94cd8ef485579085ed8f15e7ee585579150e169b0c1c743bd7f2af56ff3cfc3fe55734e32ba11fc8f9b71e559b2afb656efe5758b44ce5fa27815638e60d362bcf4f180a702a8eb637563c28d38966bbb56edc55c8d9a67e0a737e77943f30e958e931c5b2ba2af7f02832c29a7b261c88378958adb1a02b7629f3839c81670955dcd8b6f3cbef12b5da0f4b956cf891470dc7ac2baa0d9d57427db1f41b60463f6232c4e2ccce57ab99a3f3576c7c2e003d66f27c3e23f676cf7bc87f8576612d55c4bf5dac05da11ea3e6e5ef9bd4626c8bc8452b1119fcaeeac4d85d01bebc45e8ad0a895aa2d05800ab3131472137f91cb7c46af289b491477596c2b5b93b93a60d5b8ba1759f5e9070a3144a3ba3177e16f6a2a465a689d922f2dab5e62e6f1d7be0e4dab4c99aa4d022c5d77ec7cf2fcd9d92f736f1212a5450d49e2cc941f128787f600eb965f92ca9e7baf8408e99c3b4e5e80fc021402f1ebf30f2d74a3676807369fc35a7639383eee14932359785b8335d3adce7823ef2415d7703bdd313d6577502df1bafcc2eea04a8fd675736b31021d7b4dbe70ed4930fc07f1a114463ebc01ed7c37b11c97549192c0d458faaa50d4372d6cb6a0c0dc6d4ab0f43b8201abbf2d0495883bf9e1203abaf195e960fd61a2e9d73b3ea76e299edb17624e9c783f5d224c890873d603108d6c085527581621294faea852e62c1034e018542f982a4a2ba5f4d1494ec94e1209e39322c964d2c793c74e50ae955a1f620bd25f9b728ee3aa009b62df67049ef6369b06573e5351f43358d2d11d1fd287fd4b63618116f997ef4d62f5038d3ac90dd304b74ebd3138e6d8daf92b57deeb4443458af6fce0b6b8aa681ef27969d32d42405d2d72a3f0f70cc1fb3193abc37fee448d3a0f6b80a72a00db8d950a94329d029d326769f8eb03edb2061c308d5f1629177e31ae578ac462b573c54f20e2280ed3faeef1d79029f15c5445b913fcdd42b92bd61a6110537c092f93110cad2f6c8c3f95be7aa42dadad1231ec96b64606166f01ac35fbd920676e7897bfa7133c83d64e227141428f71aeaa02948e5fb01344ce76de0b8c0a6d48f4a9160f36a222631499059218e8a8f4836db8c1c00a73cbe50991484482af637b9bab6797d91f29e3a8ec3d45b0a01f792c8a259181d2623cc2c221b87b4856bc2d1d5482aa8409a201a995ce2dd290eee431c241f8b0a7d49fb50a11885cc9acbec6c3388963a2bb8f5970b75ea1aee4f480b8aa99a97965c194e1c92a48646c3dfc1ae61b1b835f607efe83a0e5b331f02ff4880890cf114427a31a7f1c9b8fceaa759631de07ed85afca11e07a639dcdffcc3b6dd8c2dbb9e7aada2a865a98de3e6e9b38cdd6fc8975ddfcd5155f6f9c15db2a9a70739a8df0ea77a37a15b6479c22193958ccfa43c3ad7db4e866a8d749c052d2c444430a1b1305c19108a7704775e3af4d00212adaa0095b1106af15315af3068fc4c446849a332ff58c7ce6a8397f801a63845b9514cbb11ef05fe5c0d26688ce09e6d4cd8c02f068bb6542c1ac60d9ed64ea9425d3b075c47565c2c49df3ad0fc6a344b32937de627b8cbc52c1b48e2f9a62cee23059ca5050948ef9eb3a94c9343564610530aa86c2b326be4e5780a019575e1ba9cf7b08be17f3080239908980f0c2cd945d0e0920f0fc5e9cda38e5d891fc2d275136b51926d6842a90027615322b81deb54fdef21f7441e9fa989916eb0df56d9f1521e5ba3af364256cedae6d2ff0bc66d47334ed84e649bfa0e1bf0eb570374a9edbe82b2a2a19136001c5a6e027e357f14175b49a248e5769163fdd728e4597fdc7199e579bb2097b4ba0aeb35d5327379403c784ddedff0517eee89ab9ba671370f1e0522efb0d2d32a3ce572ba278503dc8807e3a9dbf2aace5f85efb7248ce8d5a45977ae89cafd1b61fe52754f41a244cf65e23be17975fbd754be4820b0ec8a9c573bda674599aa6a62887ca87c978ad064e786a535cccc5702be31984f4ab13e177bd8ce91205cb989d0ef524f0ea4fb3ce4be1675b4839e1ad5f566c9bc0700af7939b7782aa9d50dd44868b2cd88b9b20479b684223d69570db166fef1b0533b381b6219d89257983afbe2dd3cec0759bad11ce04e44b2f9ddcd5be8fadde3524479e70595f6405fe70fe779506288c2db982b385c2c721fce77444b70e23a32c7ac4c5f2a826cd91c080d6a69a143b08b22b5bf8efc1fbf681aa94896eadf9e85425759f23f4eeea6fcd0f6c14606fe1e1df0963dd36e18d1dbfdfef88baa1dd99e247f13911c8440fdf3449c568530f6c1a85e63462dc1011c8f40544d48e33adcf650ac72545d38b2e651e2208b6227457b38956982299832771190967b51f343845a4a91226561ae5ed6bb1cf8f42f686831a652ac986e046ef4fea07eb237c0f9c73ee42b5a7edd7d1bb5afe30695b669f6260586b101c4641aaed99d93f52fbe99e8939718ef515e92a56f3ee545f1acfdc0e0144192c76bd7f400ff9c4979a897fb9a49e4fa7e2f5d83df003a153830b32a2fab23d0735d7f91fb1a77becd69b9906c99c97350cf5632ebe2f7c60a5fcb477d4c57fa96318857c8e631e5ee0bd8debd8ee2a8f2ba08b81f542939189a5899e05021764275b3338798cc01f4d087e4ca0f965051ba948f46e4f8e69a0f692cb8cbb36055f5b4f0a36637f99d1aded10d9f99e70027f11c03acfa37fbd3a5972f606e7e8ad03f79e02a12a792ef249197f48e6cfe1625b65987a1ff1c60cd98567e61b8d9d446fb2901f9933ee299c8fbec0dc1cde4e8c9760376ffe08a39700f975efc2f3977a452bcb964091920cb587ec25190b89c70d95a30c36f297b099d8c7bdb22f2200de65737a7c185e9ba696f21c499ec069c978f54ad8402db3c8d1dcc7f05f97948bff003f0324f97bef76304e65316e17e10b2dded5721b66f6757a96427d63d6d3786e34d37cdb6af6f76ccfea66b033ecfadbec406f9ff47cd71a62e57ea270df14f1a84fee3c0ae6991af3c68b081ab3c626ab368352a6ea97ffa819c1c134f5025de87542cf98f783fe64f986b92d37dd8985a90844314815f97e0190550981c529543a3790e01563c34e27d066e989abe45ec9bda5c5aaed285bfe850b3f1922fe9962f09319f52e23a60db2c26b48974fd9e416dcc44670e8a72c5da385cf71b9191c84ec573c244c8bc149c1f23856f26f781c6add7b8e1f48727e8db790034c4483191174850a780400cb3df22c92fd31a05bc8704f45b909ad6cd8c561363124e5c5896fd2d0dfd2d1589e513c07452e410b6d82ba76b04a725666d809a01a6a2b03b9d10426d890f1c3550cadc703efe41af0143f378d8028133d78479a4a191f2ff2ef961550f4b0db7d7d8dba1ad2b0858347a0bb0d8e627c2f17827195c9a2b8ecac42fca982eab25b57e268d226bc28f5dbebf059cad08d5db45fe669a875f4395d29b3cd15c7cf1eb177c4a102e20aa5bbe6f45872e8debf734b70db0f718da7580a1d640eb7592c24b198791b032843043b47407bf6ad8796517dd2e2a52d12bcf4d43ca80da30c19cfdf2c1e07dc12eb46bc52900a959f3db7c041914f9410ceffead7d93287f80d51b1ce4ba0d66bd6d72da18fc889b2367451dd40a09d9bc244038ab6d68850f0ab1c9ff606d9015cf7904541a8e597faf1a80a45595eb7f98bd270e27b341a90ba92001b0788267a65369d3521ff35211d9299f039aeaee6f5a4d9610bc25d263e9ed7a86f9c042c9e84bba34f5dcfcfdd5112812d4c6606be925cd8ec4d8246118b2c33e155521dc47188964d09d87e78d92451a16e2016ddfe7a5e0b56f926f92c237a5a716864c49e3a27dedf5f9f3f3802ccb20edf9096a21da6965171d027888ebcb26e49ce9e8d2a917b190909469d140bc0aea319f3f73e7472f911171afda16a3c41044d6b5d01ed018ba711599b4f2ae5b835b526bfe11623ae80a84b78feffa7bee39eabc84982bed002b973c9f113d73d88df2f841d1c74dbeaac1f1c6345ccdce4a4d3bb666762aaacdc292b5445411889bffe490ec7d56c7eb7f5004802d57ffd4b5c2f413b52c25b81bbff5c3fb9c409cc6a65cb64fa7e5412e1e475b968a800a62b6907e9c1d50f5b6762c07a487792115d61c6391553d3934a822e5bc9363b8364398e05527e4eeda45730db1f15e4da97856eda6947331312fb4d880bc39bea318d7c080322f840415311006efde0fe06245d24aa0e1bb502cd2c7548dc33e3bd8de77a8a1b3c481350229d93b254aedebc9e4d9b1b2470d01c8802e2f0ee5cacdc220ddfd3e2d7afba1614e184bdd67e3a0c9505a1e4060f1f85e482cc478790ec0c04a58c0951301c9af7aaaf1685be93aa18fd971fa173c2b6e0a9bed21b255862fd7dba578ecf1528325417c8eb7e2e926e47106f0d79bb22c622412d9c0cb41c46c79a45e6acbc5ea2083ea67f75698b96eb6a7fabad70c981c8637bea048da1c440217ee3acb7dfab4271849aba7318c834d41ae5ef264310a8397e2aa9a3f62a2c3ccbd46b27b994edcd3d87cd5b805c1fbab7526319670ed8a8c85b0bf2e88b4365c812b5c6dd1f360bccaa679bdcbaa591a706f838a32fbea6eaf987023761c951e87acc2c533c7137344ba56d8fc7441b21925c0f7178fda5a399d1bfd891ed5aaedeed325f5e76ebb8792bdffb9b0864b5466b14b9faf4d93bda90b2d604cd5323996fb79f6f709ff9b416cf29ab3b5f18d2b209f4c00fd40583d3fb2546052d261f3a0c3729d21bc5ee1f93d57baaa29bf5effe6ed5a1c62f126bf3b0df108895855529ce4cd08c53e9ff58e864e867956dc917b41def01ae2d2cb5396d5749f9190459a2453ba62c839583395dade0f462b8a6aad7dfb0df0058cd385b18749bb670d9af47c2ac36c4c30df677b9cb4f02bacdaf84ac8acd9883ec4abc6d5dc5d8a6274a7b2ba1a056d114444b0288dcf70394fc5d9f701fabf3739678d6dd201d26e6363294b0a399a51cffde6ccba8288ac6888b97451cf176924aba1ca7d1155c2c8eac30b23ef88f412bbca4f5c4afa48a77c2cc6a6f712972aa64d854840dda6ab65eaf671dbb36f5182d70dfd6eff1c891b41abe268592f5c6aa1188f431a68c548534b6bb072d5abaad2130f779fde3a1a39769f353bed8a8abaa83e5d223eb7706d239ff4d7792371d4e59650e169014735bfe5d6c2be80591098fe6cd92d36c141610907155dc28af9f5dde50817bf6879c241e0506511366014f0f3127445bd712fbaaeb7f68e1706b174d2309612a951e30a2d47f4a6be3ac6b0dc11c57dd2d9f8c39337d751df9013061d7d9be2f5e50e0f0f462565d9a96f85955c34415d4dca0c2796eddb7a3ed47494d95cbcaee4a10b0b74f8fa6c573621e849c5ec1a580bf9d355346112f3a379c81ba944716e478afb678e8bc711a3195f64c1e8f8f3bda2c10ad163715e8416880df5b2aae8b66b9f94f2a7f4fbdf310631455e45f7b929a405855f823364bc8d534666351467c049d2c85e9266fd57d91ee8ac211d0d1966d57d79383073f884066207ebb41569b5850bca492dc803074a5e22016bd6e40e827f89cb8888129d25127033ccc1826a2bfafc7943946ce971cf5aff0b69dc69d862ceaf394821b9bf174f67295b062de4e869aeb6cc9b46f45c48e17ae979cbc9e779d4d3d190eeb94b088fee997aaf50428afa9733912b9fc3621b802367c54e4dd795c95ae6ed121928a7d73731c88aee82480a173cb68c73042ac1fb148e99881009e8c15bafed9da0a0cdbdda46e6fd61755c8fceab5f0b33ac87aae4a7185bad08ab30e91644acb7ec1f02a2ecff84ed8e57607a374557940bceedda3d6aba64267ba455b815e779d21090722cbfc34b9d5b36043c78650d3091eb5d535a7e5272e41616244dfecc901eb32cad122dc389b3e3f60770e6654a502908c72820cb413a4b906a4786ffd68c3c167f4dc2495aa70b6cc79769579e3b83e7c2ca6b504ead23173261e3efa6bb41da2b40f9d1f4194da78bcfab4d0b4386740cb6e670aa0df990061ae55237a6ebc96157c23b05858a36b6c340a8e29c2ebc2388beadf6c5e5075c5679643311289efbe3ec2f1cc087f95533f04402d7b705aa4778f8be319f31001f3764f6f1d8365dacd35af00afb28c0be822b3fca7b89581f9535e93505b526f90e7d8d9b0e724399a61b5b29ac32ac839b7893644406fc789baac9a066893406f290bc5b8eb1fc13d3e1aaa194dfa47a3a317835b1076a7dee03b6dadedb1d21cffbea5094b674730efc73bc6d68646e1e2cfdca1da8e976c4f9e0fdea3fdb0780ae6b2ed0b50d241da9c17206379130c0333392a991f0ca2e143c1b98ebf638f6fe338b49a4eb27ccc6b5aa035d7b927f051fdf7e2a2d064cc53f649a5230b7aecbf0f9ec3e003a94b8e9c02e34e803de2ee16252dbee125753edcf96c5208bd237b07a85d71e0b7b3f32238b4e5c88e013667ed7ec43c59f53a9d63e03b3d556bc386a43f9484555b4c8ad2abc5853600fed22b44cae06c845a061289f81f5d8d70bb33cdfce8fdff02cab5b2c290cee7aa4aadd2779a6c9459923772899d722348b6c4622004c393a1856fb96a8860aa6c04ad2757ad777df41b3e169e2af0d69ff245840d08da63358843d625a4c225e956847f8f5d4c4fb76b0d67a00217b174d0b8858468970e921019bfac6e58d5b90bb1da01d8c0917df3595fe41f4e8b5af582b7d18b2190d241c45df971ba5bb2238a864be473c98daf8facb62d66d8085fa0c6f31021b10dd64b17a51ff24cc1740e27269d53e0d176a4f8166bbeb03dd6ae45688968e62574913b517b128b3d6478baf68f8795fd0269768f562916adb701364ad18456800f91ebb9df36e47092f01c484c8684642b4992c839e9ab64e51696c9bfeff2871827fd75bced5e7fc43ee4f0f820c71bd15c16b8da32b9bb047ecf14ae725341ff919eca0da06a620d363c5ddea66a0ef1186966d98922e9e89325ba1c2ce45319da9b9aa14ba457108ed6af10ab8f716cb75e4df1d2dd5e776099459d3885dca194282ef2202aab572b365e8c3cc21607dd979f155784e32dfadf4224ef758d0553fb78a3bac5c56e52d0673d75e71b7a89814149abfb7861005e98b0aea83432541cddb5bd979348384400ae1e1f9ed0b19f9117934d7e07c3cfafac00a6d085608f4e0318be17ca6bebdadf47e0329b739b048edc49fff563332d312d80ff0b635ee94ebe38862dd1ea846ba73982f949f06025569d9b36c5a6c5541c15a48810df19ad7a5380c73f8050651babfd530a8b22d3bb04881bfb14c37f0af9db94163982010855b6606b995e044c9b66f2376a313c3d6ef47beb3ca0b5ef084adefffbffb67e924bd8bd9e8f06a055254fb4aaf028dc845b18c916a3d0d77815d723a62078868919abb74ce0b6913f1872677a4a6285b49b309220a6b58c5a759c92f137374661e4ef57140bebc4132a095dd9711c289bdd97a0664121466a06c8c30a5a70888a836787f85916c650f48b0ec84cbd2b31812f971f0726ef665810be53cd6dfb0ae1285a4cba40c17552fbabae36ee778465492a11b308bcee207ff33d64576d8b450243ebe82ca6aff8ad4918b7db4ab8b760c56d2949a95dc88046ea38fae2eeccc76edba2a760a0b0b13031513967d43caa8e24b774d126fad740034342d3342b26cfa6f06362665b4cc6b7555cd4be9132db2ba236113f8fecc8dee5cf4798efde79f9f2eb3ad9cc45ceb55289adc1e53c9089cb4573fb4e0f73e312de970e22b0d9ca441c93a0864e9cd05965f9b3dda1e434a8d8e57ae841ae9a5cbc7bb9628e326216ba6858820a826603dc856af8d614ebe1db29e71027c2b338c374b177aa179c415d08f20a653d6afcb37c5a8cce14503a0c366202136f222a88ae06f5accd1b4494e96de37a91513484326041b1c2e2985ca1f6dd7df2f8f2ed101fe1fdd4b963c1ebbf31a7dc1231d7f37c2b6ac3227350a939733c0821e7127c2da894b5bd0b7cf6dde0ef3f7227c140481a1e07143af912a480f547b8ce0b42b735079a574d2f5d3cbcb4d7a978f7625e748a670dfc4373bd22d3f9f63f11f04986ec49e944a3159f5ee25312dce0c12412279abacb324634061c04044b91ae4a0a5199a23375ffb56e5988b886dc23167aba142758f377a933a5e71069065b68224c1c82692f3ccbed11075e071b509e342933feb08e50244dea7f345eb1a1c070bb7d78627631372f3579460469e9e65522ef10fe9dceb532bfbf8db246df492e985fc469512638352d5008e2e59b2a83f81f7c09a86e9589fe2ef7c2d61bef22bf95493cb5f13290629d6743d181f67362694f0065e15dce1148c7c66f28ce14e8ac2a550e3f70b874bd1cf539f92df180294859a3626518f1df5c45865244ba026026893179d0bdadd89a763e75bf3e489408be85037d78f8e5d3bc1577989f80bb72bdeddbe520a685f9fffb67a92a20798c06ea7b58a59aa91607d9d903ef39ce8f0b4209065e7c73c85885e3bd3fa410a89e6428cde9827e0881d2ebc2338d8011127ae50b0a00ddaeaf84adef8a7447793f0b632309b6498ee179e12808b2bac587b32ce53cc66240168a877500350addf115944b1482879349c1d71aa0e3b53b6b2666abcbc30315bd0bb8c511f5dc3909ec8a62398be78dd6bdda95b344f33bb69afbc45faf3225914f046dd9c05502e27f466e190bfc81b1e53b346916164e7f4345a5c0654836f2d469c254f96c25c2b6168f9f62f8096ee26f18e25100bde3db518b722d7e5389d1f46d2c0ef7c5472d47d1e9332c39c5dc21cf205d455b9cc9505374a501be6cfe9ce0209a0cb9e28d79828d38b5a2049584a8637296d8a3eec49e0ec1626ebeed29201efb6e49613d7385edfc5773243352204d998bbd1a3d5d4fc53db94215eb1b7d3316cc50460a73296ffba2f40d4be6964d9c049e68613f3bdc5a22e84e759d2a6523fb678738071f9a65bf8b799d0a0c3a71210cc30f98960b1fa286b184512c3f936aa02ee63981c8bd84677ccc037389b47cdd0ab04288750e165703abd451848d4a1a2bc2b8739189c26eef8788ccabd3dd260295e10c53e7f33d0fa998c9adb181e6fc9ccf43259befdf47a793068884d0b246654d69d13a942d8b5e5a53cb595c9fb94f3a8f3922c2cca87890256e59b9bbc6fad3a5b6d4b73d6811cbed69169f72802ba81b6468bcc3ec57ba6df1593990b5fa74a9f9da519ed9d65b36154c037fed2190b6ae02defb51bd874666aaa0af62e6c9be5231f8250c60d44c06df1b0a8065ef7031a82198cba485e8031e5b36ad27db7dca2f8d37793a0cc6ba34f58bbf7ceffc2f552c5125fe7eed9368ef5ed4f5e27772f5b3f6d39c392cd48b957b5103f9668f053b5844c3ee2626b386a3f25a11e9a1d5a5fa49405ff0ac9f63c80e58fe25a656607e0b5552aaf45b37b82f280adfba0155b9ee04198a7f7ebd38735a640c541b72a3cce72170113e85286404e26bebcdef4e8ade52ecd135df983ee7ec8b2929189988a3f7c65aa80671db3f43c095ca8b9b72c635b81f75872ea15e7e548342b5ff4cc67c7bff5e17dd9f1758b001c83d2789c0efad70137d77d7240a12d782b2e98ef46f2454c5c198276fbd6d678048033ee1c19bfeb4543d6ecfca3a53d17ea1a6d4be3466d45b044067e2c181e5cb56cc7ce559a7097b3c4216ce0e0cf995b86f45dea0ef2953d32a1849ac92968fabf07beb4cfcd579ada697ac2af59885d8e8dc51c9acd4c30b13b9c7c12f74652a2f417e409c5fdf9f75af3311215ce0c06c6a928629ea669a36ab05462185978ca9d39477bf86150ec723a1e62d06e7e7e751bff16a6542110ded0e5ee49d16cfbcf6870099c839f66ae0e466f80396629ad7f055fb89243d47799edeff5b41afbab11e5b81408df0aea218c57b9bc4bf9822b0ec53ca5de6b2943436e15aca53982f7c5d1e699f44f7e7f6daabe23b6eaebd61f87b22fc748dac77c146fc75eee0a870c3b241eb0ea5b4a057d3fbad4a6d97677ad62d13ca87e98f69f25e406ea8eb523ab0c64a96969bc8b9a20d563985c76541c6e5172184b5881f3567affd0c73e9d9d96e84d76e6fd2f3af4a36d0b258cf389623c4be5f96c43466ca86f931c99424063e6c469603406d92e9dc86632fd957684081c0ed9cea7df15f176a4fbdcf1ff4e613432fdb577a1bea10590d19ab643fa3e9656215585e01bbc179456ce40d3294e0b03f9515176442c1a8a5d1b5d2cfce20cee0aa5cb870e13155910db458649813fb90ba83aa0b9598754504094a85d635a391717e34d8960630a283ce8e8249841fc43f3c7e1655695be982474617a4ebd351a4020985de6b31a09339e9bd946b80d7054717efa4e0adee03c50161feaf56bb0d9e268b42abc643d7c5cf809860a2785bf41e4ebe90d79f66996beaf5a072ef9aac1bd531f58b2c28c09718fb41e713ffce265e0f6eda06f0d7c52dab4f9ca549837cff51456f05f8523ade97c574bc8d6ffbcd876a70fdfc2919ccf8fc8622e416ebaae74d0356f9a1873963da3fe618fc3e3615fa2277d4ceaf2b3ff87b86abd5a091be0c8c70abd3b8349b6a856251e92360a9bd5946a4296926eb1e5df70c5733e659656dc1c59b80656ab0c4c7f3c86f4cabbb130376d30a48df31d23c6385a62d8fe45d49c9b37b76ec8ddb0029af3860d24066f2cffe7bcaf749d94ed1a468ae46300aa343cb4a31da226033b95c49ef8cab719ec3e85dcca2606ba08b281088d65b71e2228e4d8637870b7d2963812e090721ab42a3e35d55d688faf8e398411921e4fe7b1b3049ba221b729735ca5696e49e2cce842ce11f657b414b59298c26d1452ff1432b9b5b0b2da51a5607e2037f9875ca3f3de7f39d8283c34af6626087cadeea04aad1142c6d45033249c6483434f967cbbb1108a1347d5285d0dd9383dfb503ffdf580cd8677e956c2b490021e1aa47154046860ffd7a27fdb32fa215fd3996ed29d8e0fe56592467f489ddf7b701414747ef5cc5124e4e1db69d06a402125e5f0e1ee8deaa6d4f899c15ff0c7a8520248d1a18d1aad1f2aac95482db2ab28948024dd125553ac8f92c7223ada27547f2b6476463b2fe52a3a8be0df9463c7cd378ee120b1410151f8339395d735194e8e6735fb6ce57e6be3ea8f54abefeab566282137a21d955074199096a9a24887af213703608da03de75643d5910ec01ce30390e05cb5eb1ea85413a28404f47dab903baa0f7a30628b03992d028d60811235bafdb3164db69d6e2f77be935711fbfa760774628da5370b8e6b79d75fa469</script>
</div>
<script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
      <categories>
        <category>云原生</category>
      </categories>
      <tags>
        <tag>Kubernetes</tag>
        <tag>Docker</tag>
        <tag>HDFS</tag>
        <tag>Helm</tag>
        <tag>Apache Druid</tag>
        <tag>PrestoDB</tag>
      </tags>
  </entry>
  <entry>
    <title>Netty：从入门到实践</title>
    <url>/posts/200316/</url>
    <content><![CDATA[<h2 id="Netty-是什么？"><a href="#Netty-是什么？" class="headerlink" title="Netty 是什么？"></a>Netty 是什么？</h2><blockquote>
<p><strong><a href="https://netty.io/">Netty</a></strong>™ is an asynchronous event-driven network application framework for rapid development of maintainable high performance protocol servers &amp; clients.</p>
</blockquote>
<h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><h3 id="Channel"><a href="#Channel" class="headerlink" title="Channel"></a>Channel</h3><p>　代表一个到实体（硬件设备、文件、网络 Socket 等）的开放连接，如读操作或写操作</p>
<h3 id="Callback"><a href="#Callback" class="headerlink" title="Callback"></a>Callback</h3><p>　代表一个在处理完某个事件之后，被调用的方法</p>
<h3 id="Future"><a href="#Future" class="headerlink" title="Future"></a>Future</h3><p>　代表一个异步操作结果的占位符</p>
<h3 id="Event"><a href="#Event" class="headerlink" title="Event"></a>Event</h3><p>　代表一个可能会触发相应动作的事件连接被激活、用户事件等</p>
<h3 id="ChannelHandler"><a href="#ChannelHandler" class="headerlink" title="ChannelHandler"></a>ChannelHandler</h3><p>　代表一个响应特定事件而被执行的回调</p>
<a id="more"></a>
<h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2><ul>
<li>统一的 API</li>
<li>简单易用</li>
<li>高性能</li>
<li>健壮</li>
<li>安全</li>
<li>庞大的社区支持</li>
</ul>
<h2 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h2><p><img data-src="/picture/netty/netty_components.png" alt=""></p>
<center>（图片来源：<a href="https://netty.io/" target="_blank">Netty</a>™ 官网）</center>





<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><h3 id="String-与-ByteBuf-的互相转换"><a href="#String-与-ByteBuf-的互相转换" class="headerlink" title="String 与 ByteBuf 的互相转换"></a>String 与 ByteBuf 的互相转换</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">String s = <span class="string">"yuzhouwan.com"</span>;</span><br><span class="line"><span class="keyword">final</span> ByteBuf buf = Unpooled.wrappedBuffer(s.getBytes(StandardCharsets.UTF_8));</span><br><span class="line"><span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[buf.readableBytes()];</span><br><span class="line">buf.readBytes(bytes);</span><br><span class="line">Assert.assertEquals(s, <span class="keyword">new</span> String(bytes, StandardCharsets.UTF_8));</span><br></pre></td></tr></tbody></table></figure>
<h3 id="提高-LEAK-检测的级别"><a href="#提高-LEAK-检测的级别" class="headerlink" title="提高 LEAK 检测的级别"></a>提高 LEAK 检测的级别</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">-Dio.netty.leakDetection.level=PARANOID</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">ResourceLeakDetector.setLevel(ResourceLeakDetector.Level.PARANOID)</span><br></pre></td></tr></tbody></table></figure>
<h2 id="技术内幕"><a href="#技术内幕" class="headerlink" title="技术内幕"></a>技术内幕</h2><h3 id="Netty-和-TCP-的关系"><a href="#Netty-和-TCP-的关系" class="headerlink" title="Netty 和 TCP 的关系"></a>Netty 和 TCP 的关系</h3><p>　本质上，Netty 仍然会调用 <a href="https://yuzhouwan.com/posts/190413/">Java</a> 的 Socket 库（如常见的 IO、NIO 和 NIO2 等），而 Java 自身也是对操作系统 Socket 接口的封装。到了操作系统层面，Socket 仍然会走 TCP 协议。所以，可以将 Netty 理解为，是对 TCP 协议的高度封装</p>
<h3 id="IdleStateHandler-和-ReadTimeoutHandler-WriteTimeoutHandler-的异同"><a href="#IdleStateHandler-和-ReadTimeoutHandler-WriteTimeoutHandler-的异同" class="headerlink" title="IdleStateHandler 和 ReadTimeoutHandler / WriteTimeoutHandler 的异同"></a>IdleStateHandler 和 ReadTimeoutHandler / WriteTimeoutHandler 的异同</h3><p>　三者均是基于心跳机制来完成 socket 超时断开的，前者的功能实际上包含了后两者，<strong>IdleStateHandler</strong> 可以同时对 read / write 请求进行超时控制</p>
<h3 id="DefaultFileRegion-和-HttpChunkedInput-的区别"><a href="#DefaultFileRegion-和-HttpChunkedInput-的区别" class="headerlink" title="DefaultFileRegion 和 HttpChunkedInput 的区别"></a>DefaultFileRegion 和 HttpChunkedInput 的区别</h3><h4 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h4><ul>
<li>二者都是应用于大文件传输的</li>
<li>而 <strong>HttpChunkedInput</strong> 可应用于 SSL（<strong>S</strong>ecure <strong>S</strong>ockets <strong>L</strong>ayer）协议</li>
</ul>
<h4 id="用法"><a href="#用法" class="headerlink" title="用法"></a><a href="https://github.com/netty/netty/tree/4.1/example/src/main/java/io/netty/example/http/file">用法</a></h4><ul>
<li><strong>DefaultFileRegion</strong> 需要在 <code>ChannelHandlerContext</code> 写入时指定文件的字节长度</li>
<li><strong>DefaultFileRegion</strong> 完成文件传输之后，需要再发送一个 <code>LastHttpContent.EMPTY_LAST_CONTENT</code> 标识位，以通知客户端断开连接</li>
<li><strong>HttpChunkedInput</strong> 只需要指定 chunk 块的大小</li>
<li><strong>HttpChunkedInput</strong> 需要在 <code>ChannelHandlerContext</code> 的 pipeline 中增加 <code>ChunkedWriteHandler</code></li>
</ul>
<h3 id="EpollEventLoopGroup-和-NioEventLoopGroup-的区别"><a href="#EpollEventLoopGroup-和-NioEventLoopGroup-的区别" class="headerlink" title="EpollEventLoopGroup 和 NioEventLoopGroup 的区别"></a>EpollEventLoopGroup 和 NioEventLoopGroup 的区别</h3><p>　Java 中的 NIO 会根据操作系统不同，选用不同的 Selector 实现，例如 <a href="https://yuzhouwan.com/posts/15691/">Linux</a> 对应 <code>EPollSelectorProvider</code>（epoll 模式）和 <code>PollSelectorProvider</code>（selector 模式）、<a href="https://yuzhouwan.com/posts/190101/">MacOS</a> 对应 <code>KQueueSelectorProvider</code>、Windows 对应 <code>WindowsSelectorProvider</code>。由此可见，<strong>EpollEventLoopGroup</strong> 只能被应用于 Linux 环境中。其主要优势是：</p>
<ul>
<li>使用的是边缘触发（<strong>ET</strong>，<strong>e</strong>dge-<strong>t</strong>riggered），而非使用水位触发（<strong>LT</strong>，<strong>l</strong>evel-<strong>t</strong>riggered）</li>
<li>提供了更多的配置参数，如 <code>TCP_CORK</code>、<code>SO_REUSEADDR</code> 等</li>
<li>通过 JNI 调用 C 代码，可以减少 GC 压力</li>
</ul>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><ul>
<li><a href="https://netty.io/wiki/native-transports.html">Using the Linux native transport</a></li>
<li><a href="https://www.zhihu.com/question/20122137/answer/14049112">epoll 或者 kqueue 的原理是什么？</a></li>
</ul>
<h2 id="踩过的坑"><a href="#踩过的坑" class="headerlink" title="踩过的坑"></a>踩过的坑</h2><h3 id="Connection-reset-by-peer"><a href="#Connection-reset-by-peer" class="headerlink" title="Connection reset by peer"></a>Connection reset by peer</h3><h4 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h4><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">io.netty.channel.unix.Errors$NativeIoException: readAddress(..) failed: Connection reset by peer</span><br></pre></td></tr></tbody></table></figure>
<h4 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h4><p>　客户端和服务器未统一使用 TCP 短连接或者长连接导致的</p>
<h4 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h4><h5 id="短连接-vs-长连接"><a href="#短连接-vs-长连接" class="headerlink" title="短连接 vs 长连接"></a>短连接 vs 长连接</h5><ul>
<li><p>短连接</p>
<p>每次请求都需要先建立 TCP 连接（三次握手），再执行业务逻辑，最后关闭连接（四次挥手）</p>
<ul>
<li>优点<ul>
<li>实现简单</li>
</ul>
</li>
<li>缺点<ul>
<li>性能较差，大量资源消耗在了 TCP 层面的交互上</li>
<li>出现大量 <code>TIME_WAIT</code> 状态的 TCP 连接。如果未设置 <code>SO_REUSEADDR</code> 参数，则可能出现端口被占满的问题。因为连接被主动关闭后，TCP 连接的状态仍然会是 <code>TIME_WAIT</code>，只有等两个 MSL 后（<strong>M</strong>aximum <strong>S</strong>egment <strong>L</strong>ifetime，报文最大生存时间，<a href="https://tools.ietf.org/rfc/rfc793.txt">RFC 793</a> 规范中 MSL 取值为 2 分钟），才会回到 CLOSED 状态</li>
</ul>
</li>
</ul>
</li>
<li><p>长连接</p>
<p>连接建立完，不释放连接</p>
<ul>
<li>优点<ul>
<li>性能较高，不需要重复建立或关闭 TCP 连接</li>
<li>不会出现 <code>CLOSE_WAIT</code> 和 <code>TIME_WAIT</code> 的问题</li>
</ul>
</li>
<li>缺点<ul>
<li>实现复杂，需要使用连接池来维护长连接</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="查看连接状态"><a href="#查看连接状态" class="headerlink" title="查看连接状态"></a>查看连接状态</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ netstat -ant</span><br></pre></td></tr></tbody></table></figure>
<h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><h3 id="Doc"><a href="#Doc" class="headerlink" title="Doc"></a>Doc</h3><ul>
<li><a href="https://javadoc.io/static/io.netty/netty-all/4.1.49.Final/io/netty/util/ReferenceCountUtil.html">ReferenceCountUtil</a></li>
<li><a href="https://netty.io/wiki/reference-counted-objects.html">Reference counted objects</a></li>
</ul>
<h3 id="Book"><a href="#Book" class="headerlink" title="Book"></a>Book</h3><ul>
<li>《<a href="https://book.douban.com/subject/27038538/">Netty 实战</a>》</li>
<li>《<a href="https://book.douban.com/subject/30381214/">Netty 进阶之路：跟着案例学 Netty</a>》</li>
</ul>
<h3 id="Blog"><a href="#Blog" class="headerlink" title="Blog"></a>Blog</h3><ul>
<li><a href="https://www.jianshu.com/p/7290fec6ce38">Google Protobuf 与 Netty 结合</a></li>
<li><a href="https://stackoverflow.com/questions/14388706/how-do-so-reuseaddr-and-so-reuseport-differ">How do SO_REUSEADDR and SO_REUSEPORT differ?</a></li>
</ul>
<h3 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h3><ul>
<li><a href="https://github.com/netty/netty/issues/2182">Fix a bug where HttpObjectAggregator doesn’t always produce FullHttpMessage</a></li>
<li><a href="https://github.com/apache/shardingsphere/blob/3c82fb8c9e158028ed76d12b24e6c6413a3c03ea/sharding-proxy-postgresql/src/main/java/org/apache/shardingsphere/shardingproxy/frontend/postgresql/PostgreSQLFrontendHandler.java#L69">PostgreSQLFrontendHandler - channelWritabilityChanged</a></li>
</ul>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt=""></a></td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>后端开发</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Netty</tag>
        <tag>NIO</tag>
      </tags>
  </entry>
  <entry>
    <title>Nginx：一款高性能的反向代理服务器</title>
    <url>/posts/200321/</url>
    <content><![CDATA[<h2 id="Nginx-是什么？"><a href="#Nginx-是什么？" class="headerlink" title="Nginx 是什么？"></a>Nginx 是什么？</h2><blockquote>
<p><strong><a href="http://nginx.org/">Nginx</a></strong>™ [engine x] is an HTTP and reverse proxy server, a mail proxy server, and a generic TCP/UDP proxy server</p>
</blockquote>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><p>　在 Nginx <a href="https://nginx.org/download/">Archive</a> 下载页面，下载 <a href="https://nginx.org/download/nginx-1.13.12.tar.gz">nginx-1.13.12.tar.gz</a> 安装包</p>
<h3 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ yum -y install openssl openssl-devel</span><br><span class="line">$ yum -y install pcre-devel</span><br></pre></td></tr></tbody></table></figure>
<h3 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ tar zxvf nginx-1.13.12.tar.gz</span><br><span class="line"><span class="comment"># 必须要跳转到 nginx 安装目录下</span></span><br><span class="line">$ <span class="built_in">cd</span> nginx-1.13.12</span><br><span class="line">$ ./configure --prefix=/usr/<span class="built_in">local</span>/nginx --conf-path=/usr/<span class="built_in">local</span>/nginx/nginx.conf</span><br><span class="line">$ make -j4 &amp;&amp; make -j4 install</span><br></pre></td></tr></tbody></table></figure>
<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/nginx/</span><br><span class="line">$ sbin/nginx -c /usr/<span class="built_in">local</span>/nginx/nginx.conf</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ ps -ef | grep nginx</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">root     107034      1  0 Oct31 ?        00:00:00 nginx: master process sbin/nginx</span><br><span class="line">nobody   107036 107034  0 Oct31 ?        00:00:00 nginx: worker process</span><br><span class="line">nobody   107266 107265  0 Oct31 ?        00:00:00 tsar --check --apache --cpu --mem --load --io --traffic --tcp --partition --nginx --swap</span><br><span class="line">root     107270  97588  0 Oct31 pts/1    00:00:00 grep nginx</span><br></pre></td></tr></tbody></table></figure>
<a id="more"></a>
<h3 id="停止"><a href="#停止" class="headerlink" title="停止"></a>停止</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ sbin/nginx -s stop</span><br></pre></td></tr></tbody></table></figure>
<h3 id="校验"><a href="#校验" class="headerlink" title="校验"></a>校验</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ curl localhost</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight html"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>Welcome to nginx!<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line">    body {</span><br><span class="line">        width: 35em;</span><br><span class="line">        margin: 0 auto;</span><br><span class="line">        font-family: Tahoma, Verdana, Arial, sans-serif;</span><br><span class="line">    }</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Welcome to nginx!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>If you see this page, the nginx web server is successfully installed and working. Further configuration is required.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>For online documentation and support please refer to</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"http://nginx.org/"</span>&gt;</span>nginx.org<span class="tag">&lt;/<span class="name">a</span>&gt;</span>.<span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">Commercial support is available at</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"http://nginx.com/"</span>&gt;</span>nginx.com<span class="tag">&lt;/<span class="name">a</span>&gt;</span>.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">em</span>&gt;</span>Thank you for using nginx.<span class="tag">&lt;/<span class="name">em</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim nginx.conf</span><br></pre></td></tr></tbody></table></figure>
<h3 id="重新加载配置文件"><a href="#重新加载配置文件" class="headerlink" title="重新加载配置文件"></a>重新加载配置文件</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ sbin/nginx -s reload</span><br></pre></td></tr></tbody></table></figure>
<h3 id="查看日志"><a href="#查看日志" class="headerlink" title="查看日志"></a>查看日志</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 查看流量详情</span></span><br><span class="line">$ tail -f logs/access.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看异常日志</span></span><br><span class="line">$ tail -f logs/error.log</span><br></pre></td></tr></tbody></table></figure>
<h2 id="流量镜像"><a href="#流量镜像" class="headerlink" title="流量镜像"></a>流量镜像</h2><h3 id="Upstream-模块"><a href="#Upstream-模块" class="headerlink" title="Upstream 模块"></a>Upstream 模块</h3><p>　通过 <code>upstream</code> 模块，可以将源地址（当前集群）和镜像地址（目标集群）分组</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">upstream curr {</span><br><span class="line">    server 192.168.0.101:8080;</span><br><span class="line">    server 192.168.0.102:8080;</span><br><span class="line">    keepalive 64;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">upstream dest {</span><br><span class="line">    server 192.168.0.103:8080;</span><br><span class="line">    server 192.168.0.104:8080;</span><br><span class="line">    keepalive 64;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Server-模块"><a href="#Server-模块" class="headerlink" title="Server 模块"></a>Server 模块</h3><p>　如下定义了当前 Nginx 进程（<code>localhost</code>）监听的端口（<code>80</code>）</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">server {</span><br><span class="line">    listen         80;</span><br><span class="line">    server_name    localhost;</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<div class="note warning">注意观察 logs/error.log 日志，检查是否出现端口冲突的日志，以调整这里面的端口号</div>



<h3 id="Location-模块"><a href="#Location-模块" class="headerlink" title="Location 模块"></a>Location 模块</h3><p>　<code>server</code> 模块下的 <code>location</code> 模块，可以定义流量转发的规则，<code>location /</code> 会接受所有 Nginx 进来的流量，而 <code>mirror /mirror;</code> 会将流量转发到镜像地址，而 <code>location /mirror</code> 则定义了转发的规则</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">location / {</span><br><span class="line">    root   html;</span><br><span class="line">    index  index.html index.htm;</span><br><span class="line">    mirror /mirror;</span><br><span class="line">    mirror_request_body on;</span><br><span class="line">    proxy_pass http://curr;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">location /mirror {</span><br><span class="line">    internal;</span><br><span class="line">    proxy_pass http://dest<span class="variable">$request_uri</span>;</span><br><span class="line">    proxy_set_header X-Original-URI <span class="variable">$request_uri</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="完整示例"><a href="#完整示例" class="headerlink" title="完整示例"></a>完整示例</h3><h4 id="本地转发"><a href="#本地转发" class="headerlink" title="本地转发"></a>本地转发</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">#user              nginx;</span></span><br><span class="line">worker_processes  auto;</span><br><span class="line"></span><br><span class="line"><span class="comment">#error_log  logs/error.log;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  notice;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  info;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#pid        logs/nginx.pid;</span></span><br><span class="line"></span><br><span class="line">events {</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">http {</span><br><span class="line">    include             mime.types;</span><br><span class="line">    default_type        application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format          main  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line">                              <span class="string">'$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line">                              <span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</span><br><span class="line"></span><br><span class="line">    access_log          logs/access.log  main;</span><br><span class="line">    sendfile            on;</span><br><span class="line"></span><br><span class="line">    keepalive_timeout   65;</span><br><span class="line"></span><br><span class="line">    upstream curr {</span><br><span class="line">        server localhost:8080;</span><br><span class="line">        keepalive 64;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    server {</span><br><span class="line">        listen         80;</span><br><span class="line">        server_name    localhost;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#charset koi8-r;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#access_log    logs/host.access.log  main;</span></span><br><span class="line"></span><br><span class="line">        location / {</span><br><span class="line">            root   html;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">            mirror_request_body on;</span><br><span class="line">            proxy_pass http://curr;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        error_page     500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html {</span><br><span class="line">            root   html;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="集群间转发"><a href="#集群间转发" class="headerlink" title="集群间转发"></a>集群间转发</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">#user              nginx;</span></span><br><span class="line">worker_processes  auto;</span><br><span class="line"></span><br><span class="line"><span class="comment">#error_log  logs/error.log;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  notice;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  info;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#pid        logs/nginx.pid;</span></span><br><span class="line"></span><br><span class="line">events {</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">http {</span><br><span class="line">    include             mime.types;</span><br><span class="line">    default_type        application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format          main  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line">                              <span class="string">'$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line">                              <span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</span><br><span class="line"></span><br><span class="line">    access_log          logs/access.log  main;</span><br><span class="line">    sendfile            on;</span><br><span class="line"></span><br><span class="line">    keepalive_timeout   65;</span><br><span class="line"></span><br><span class="line">    upstream curr {</span><br><span class="line">        server 192.168.0.101:8080;</span><br><span class="line">        server 192.168.0.102:8080;</span><br><span class="line">        keepalive 64;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    upstream dest {</span><br><span class="line">        server 192.168.0.103:8080;</span><br><span class="line">        server 192.168.0.104:8080;</span><br><span class="line">        keepalive 64;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    server {</span><br><span class="line">        listen         80;</span><br><span class="line">        server_name    localhost;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#charset koi8-r;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#access_log    logs/host.access.log  main;</span></span><br><span class="line"></span><br><span class="line">        location / {</span><br><span class="line">            root   html;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">            mirror /mirror;</span><br><span class="line">            mirror_request_body on;</span><br><span class="line">            proxy_pass http://curr;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        location /mirror {</span><br><span class="line">            internal;</span><br><span class="line">            proxy_pass http://dest<span class="variable">$request_uri</span>;</span><br><span class="line">            proxy_set_header X-Original-URI <span class="variable">$request_uri</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        error_page     500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html {</span><br><span class="line">            root   html;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="轮询策略"><a href="#轮询策略" class="headerlink" title="轮询策略"></a>轮询策略</h2><h3 id="RR"><a href="#RR" class="headerlink" title="RR"></a>RR</h3><p>　按时间顺序逐一将请求发送到不同的服务器，并且服务器故障后，会被自动剔除</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">upstream yuzhouwan {</span><br><span class="line">  server 192.168.0.101:80 max_fails=3 fail_timeout=3s weight=9;</span><br><span class="line">  server 192.168.0.102:80 max_fails=3 fail_timeout=3s weight=9;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<div class="note info">Nginx 默认会采用 RR（round-robin）简单轮询策略</div>



<h3 id="balance"><a href="#balance" class="headerlink" title="balance"></a>balance</h3><p>　支持指定轮询的几率，参数 <code>weight</code> 的数值和访问几率成正比，常用于集群中服务器资源不均的场景</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">upstream yuzhouwan {</span><br><span class="line">  server 192.168.0.101:80 weight=6;</span><br><span class="line">  server 192.168.0.102:80 weight=1;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="ip-hash"><a href="#ip-hash" class="headerlink" title="ip_hash"></a>ip_hash</h3><p>　按访问 ip 的 hash 结果将请求发送到不同的服务器，这样每个访客固定访问一个后端服务器。可以在 <a href="https://yuzhouwan.com/posts/48905/">Session</a> 有状态情况下，避免请求被转发到不同的服务器后，需要重复登录的问题</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">upstream yuzhouwan {</span><br><span class="line">  ip_hash;</span><br><span class="line">  server 192.168.0.101:80;</span><br><span class="line">  server 192.168.0.102:80;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="fair"><a href="#fair" class="headerlink" title="fair"></a><a href="https://github.com/gnosek/nginx-upstream-fair">fair</a></h3><p>　按服务器的响应时间来分配请求，响应时间短的优先分配</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">upstream yuzhouwan {</span><br><span class="line">  fair;</span><br><span class="line">  server 192.168.0.101:80;</span><br><span class="line">  server 192.168.0.102:80;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="url-hash"><a href="#url-hash" class="headerlink" title="url_hash"></a><a href="https://github.com/evanmiller/nginx_upstream_hash">url_hash</a></h3><p>　按访问 url 的 hash 结果来分配请求，可以充分发挥服务器上缓存的作用</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">upstream yuzhouwan {</span><br><span class="line">  <span class="built_in">hash</span> <span class="variable">$request_uri</span>;</span><br><span class="line">  hash_method crc32;</span><br><span class="line">  server 192.168.0.101:80;</span><br><span class="line">  server 192.168.0.102:80;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="踩过的坑"><a href="#踩过的坑" class="headerlink" title="踩过的坑"></a>踩过的坑</h2><h3 id="client-intended-to-send-too-large-body"><a href="#client-intended-to-send-too-large-body" class="headerlink" title="client intended to send too large body"></a>client intended to send too large body</h3><h4 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h4><p>　Nginx 默认不允许发送超过 1MB 的请求体，由 <code>client_max_body_size</code> 参数控制</p>
<h4 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim nginx.conf</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">http {</span><br><span class="line">  client_max_body_size 10M;</span><br><span class="line">  <span class="comment"># ...</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ sbin/nginx -s reload</span><br></pre></td></tr></tbody></table></figure>
<h4 id="补充"><a href="#补充" class="headerlink" title="补充"></a><a href="https://nginx.org/en/docs/http/ngx_http_core_module.html">补充</a></h4><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">参数名</th>
<th style="text-align:center">含义</th>
<th style="text-align:center">默认值</th>
<th style="text-align:center">作用域</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>chunked_transfer_encoding</code></td>
<td style="text-align:center">是否开启 HTTP/1.1 下的 chunked 编码</td>
<td style="text-align:center">on</td>
<td style="text-align:center">http, server, location</td>
</tr>
<tr>
<td style="text-align:center"><code>client_header_buffer_size</code></td>
<td style="text-align:center">请求头的大小限制</td>
<td style="text-align:center">1k</td>
<td style="text-align:center">http, server</td>
</tr>
<tr>
<td style="text-align:center"><code>client_body_timeout</code></td>
<td style="text-align:center">读取请求体的超时限制</td>
<td style="text-align:center">60s</td>
<td style="text-align:center">http, server, location</td>
</tr>
</tbody>
</table>
</div>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt=""></a></td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>Nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>Node 模块</title>
    <url>/posts/23363/</url>
    <content><![CDATA[<h2 id="Node-js-是什么？"><a href="#Node-js-是什么？" class="headerlink" title="Node.js 是什么？"></a>Node.js 是什么？</h2><blockquote>
<p><a href="https://nodejs.org/en/">Node.js</a>® is a JavaScript runtime built on Chrome’s V8 JavaScript engine.</p>
</blockquote>
<h2 id="为什么要有-Node-模块？"><a href="#为什么要有-Node-模块？" class="headerlink" title="为什么要有 Node 模块？"></a>为什么要有 Node 模块？</h2><p>　模块，是 Node 让代码易于重用的一种组织和包装方式</p>
<a id="more"></a>
<h2 id="模块创建流程"><a href="#模块创建流程" class="headerlink" title="模块创建流程"></a>模块创建流程</h2><h3 id="创建模块"><a href="#创建模块" class="headerlink" title="创建模块"></a>创建模块</h3><figure class="highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="string">'a'</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">A</span>(<span class="params"></span>) </span>{</span><br><span class="line">    <span class="built_in">console</span>.log(a);</span><br><span class="line">}</span><br><span class="line"><span class="built_in">exports</span>.printA = A;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="引入模块"><a href="#引入模块" class="headerlink" title="引入模块"></a>引入模块</h3><figure class="highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="built_in">require</span>(<span class="string">'./module_'</span>);</span><br><span class="line">a.printA();</span><br></pre></td></tr></tbody></table></figure>
<h3 id="模块暴露构造函数"><a href="#模块暴露构造函数" class="headerlink" title="模块暴露构造函数"></a>模块暴露构造函数</h3><figure class="highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//定义</span></span><br><span class="line"><span class="keyword">var</span> B = <span class="function"><span class="keyword">function</span> (<span class="params">input</span>) </span>{</span><br><span class="line">    <span class="built_in">this</span>.input = input;</span><br><span class="line">}</span><br><span class="line">B.prototype.printB = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">this</span>.input);</span><br><span class="line">}</span><br><span class="line"><span class="built_in">module</span>.exports = <span class="built_in">exports</span> = B;</span><br><span class="line"></span><br><span class="line"><span class="comment">//调用</span></span><br><span class="line"><span class="keyword">var</span> B = <span class="built_in">require</span>(<span class="string">'./module_'</span>);</span><br><span class="line"><span class="keyword">var</span> b = <span class="keyword">new</span> B(<span class="string">'asdf'</span>);</span><br><span class="line">b.printB();</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>exports</p>
<p>只是对 module.exports 的一个全局引用，最初被定义为一个可以添加属性的空对象</p>
</li>
<li><p>exports.printA</p>
<p>是 module.exports.printA 的简写</p>
</li>
<li><p>exports = B</p>
<p>将会打破 module.exports 和 exports 之间的引用关系</p>
</li>
<li><p>module.exports = exports</p>
<p>可以修复链接</p>
</li>
</ul>
<h2 id="Monkey-Patching"><a href="#Monkey-Patching" class="headerlink" title="Monkey Patching"></a>Monkey Patching</h2><p>　Node 将模块作为对象缓存起来。第一个文件会将模块返回的数据存到程序的内存中，第二个文件就不用再去访问和计算模块的源文件了。并且，第二次引入有机会修改缓存的数据</p>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt=""></a></td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>语言</category>
      </categories>
      <tags>
        <tag>Node.js</tag>
        <tag>Module</tag>
      </tags>
  </entry>
  <entry>
    <title>Qcon 2015 见闻之一：猿题库</title>
    <url>/posts/17444/</url>
    <content><![CDATA[<h2 id="什么是-‘猿题库’"><a href="#什么是-‘猿题库’" class="headerlink" title="什么是 ‘猿题库’ ?"></a>什么是 ‘猿题库’ ?</h2><p>　初高中刷题利器 - - <a href="http://yuantiku.com/">猿题库 官网</a></p>
<p>　猿：猿到人的进化 - - <a href="http://qconbeijing.com/">QCon</a></p>
<h2 id="在线教育领域应用-ML"><a href="#在线教育领域应用-ML" class="headerlink" title="在线教育领域应用 ML"></a>在线教育领域应用 <a href="https://yuzhouwan.com/posts/4735/">ML</a></h2><h3 id="小猿搜题"><a href="#小猿搜题" class="headerlink" title="小猿搜题"></a>小猿搜题</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">Photo（手机横屏采集题目）-&gt; Prepare -&gt; Split -&gt; CNN识别 -&gt; NLP纠错 -&gt; 搜索 -&gt; 返回题目</span><br><span class="line">                      -&gt; 插图匹配 --------------------------------------&gt;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>Photo</p>
<p>内容多样，模糊图（30%），公式（50%）</p>
</li>
<li><p>Prepare</p>
<p>横屏（转向），黑底白字</p>
</li>
<li><p>Split</p>
<p>公式分词（根号）</p>
</li>
<li><p><a href="https://yuzhouwan.com/posts/42737">CNN</a> 识别</p>
<p>卷积神经网络（Model）、标记数据、自动生成、DL（SGD -&gt; 高斯牛顿）</p>
</li>
<li><p>NLP 纠错</p>
<p>语言模型（e.g, ‘回边形’ -&gt; ‘四边形’）</p>
</li>
<li><p>搜索</p>
<p>分词、inverted-index、排序、Learning to Rank、GBRT</p>
</li>
<li><p>插图匹配</p>
<p>SIFT、高命中</p>
</li>
</ul>
<a id="more"></a>
<h3 id="学生能力预测"><a href="#学生能力预测" class="headerlink" title="学生能力预测"></a>学生能力预测</h3><ul>
<li><p>项目反应理论</p>
<p>IRT -&gt; FTRL</p>
</li>
<li><p>特征</p>
<p>用户（学校 + 地区 + 目标考试）、题目（知识点 + 关键字）、时序（距离目标考试时间）</p>
</li>
</ul>
<h3 id="猿辅导老师推荐"><a href="#猿辅导老师推荐" class="headerlink" title="猿辅导老师推荐"></a>猿辅导老师推荐</h3><ul>
<li><p>推荐系统</p>
<p>冷启动、Item-base</p>
</li>
<li><p>ML</p>
<p>logistic factorization machine、E&amp;E（挖掘潜力）</p>
</li>
</ul>
<h2 id="未来走向"><a href="#未来走向" class="headerlink" title="未来走向"></a>未来走向</h2><ul>
<li><p>知识图谱</p>
<p>学生成长之路：题目 + 学生 = 提升后的学生（可量化）</p>
</li>
<li><p>手写识别</p>
<p>手写搜题 + 解答题 + 自动判卷</p>
</li>
<li><p>高考机器</p>
<p>机器自动出题、做题</p>
</li>
<li><p>智能芯片</p>
<p>极短的时间内，将十几年需要学习的知识学习完</p>
</li>
</ul>
<p><strong>最后感谢：猿题库 研究部总监 — <a href="http://2015.qconbeijing.com/speakers/201685">邓澍军</a> 的精彩演讲！</strong></p>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt=""></a></td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>见闻</category>
      </categories>
      <tags>
        <tag>Qcon</tag>
        <tag>猿题库</tag>
        <tag>机器学习</tag>
      </tags>
  </entry>
  <entry>
    <title>SSO</title>
    <url>/posts/5517/</url>
    <content><![CDATA[<h2 id="SSO-是什么？"><a href="#SSO-是什么？" class="headerlink" title="SSO 是什么？"></a>SSO 是什么？</h2><p>　SSO（<strong>S</strong>ingle <strong>S</strong>ign-<strong>o</strong>n），即单点登录，指在一个多系统共存的环境下，用户在一处登录后，就不用在其他系统中重新登录，也就是说用户的一次登录能得到其他所有系统的信任</p>
<h2 id="为什么要有-SSO？"><a href="#为什么要有-SSO？" class="headerlink" title="为什么要有 SSO？"></a>为什么要有 SSO？</h2><p>　尤其，大型网站背后是成百上千的子系统，用户一次操作或交易可能涉及到几十个子系统的协作<br>　如果每次子系统都需要用户认证，不仅用户会疯掉，各子系统也会为这种重复认证的逻辑搞疯掉</p>
<a id="more"></a>
<h2 id="SSO-框架"><a href="#SSO-框架" class="headerlink" title="SSO 框架"></a>SSO 框架</h2><h3 id="CAS（Central-Authentication-Server）"><a href="#CAS（Central-Authentication-Server）" class="headerlink" title="CAS（Central Authentication Server）"></a>CAS（<strong>C</strong>entral <strong>A</strong>uthentication <strong>S</strong>erver）</h3><p>　是 Yale 大学发起的一个开源项目，据统计，大概每 10 个采用开源构建 Web SSO 的 Java 项目，就有 8 个使用 CAS</p>
<h3 id="Passport-认证服务"><a href="#Passport-认证服务" class="headerlink" title="Passport 认证服务"></a>Passport 认证服务</h3><p>　ASP.NET 基于 Form 的认证方法</p>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt=""></a></td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>后端开发</category>
      </categories>
      <tags>
        <tag>SSO</tag>
        <tag>Session</tag>
        <tag>Cookie</tag>
      </tags>
  </entry>
  <entry>
    <title>Scala 实战</title>
    <url>/posts/18651/</url>
    <content><![CDATA[<h2 id="实用技巧"><a href="#实用技巧" class="headerlink" title="实用技巧"></a>实用技巧</h2><h3 id="List"><a href="#List" class="headerlink" title="List"></a>List</h3><figure class="highlight scala"><table><tbody><tr><td class="code"><pre><span class="line"><span class="type">List</span>(<span class="number">1</span>, <span class="number">9</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">5</span>) span (_ &lt; <span class="number">3</span>)       <span class="comment">// (List(1), List(9, 2, 4, 5))  碰到不符合就结束</span></span><br><span class="line"></span><br><span class="line"><span class="type">List</span>(<span class="number">1</span>, <span class="number">9</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">5</span>) partition (_ &lt; <span class="number">3</span>)  <span class="comment">// (List(1, 2), List(9, 4, 5))  扫描所有</span></span><br><span class="line"></span><br><span class="line"><span class="type">List</span>(<span class="number">1</span>, <span class="number">9</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">5</span>) splitAt <span class="number">2</span>          <span class="comment">// (List(1, 9), List(2, 4, 5))  以下标为分割点</span></span><br><span class="line"></span><br><span class="line"><span class="type">List</span>(<span class="number">1</span>, <span class="number">9</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">5</span>) groupBy (<span class="number">5</span> &lt; _)    <span class="comment">// Map(false -&gt; List(1, 2, 4, 5), true -&gt; List(9))  分割成 Map 对象，以 Boolean 类型为 Key</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="Iterator"><a href="#Iterator" class="headerlink" title="Iterator"></a>Iterator</h3><h4 id="grouped"><a href="#grouped" class="headerlink" title="grouped"></a>grouped</h4><figure class="highlight scala"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> scala.collection.{<span class="type">AbstractIterator</span>, mutable}</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.{<span class="type">SparkConf</span>, <span class="type">SparkContext</span>}</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.sql.<span class="type">SparkSession</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.sql.<span class="type">BigquerySparkSession</span>._</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> conf = <span class="keyword">new</span> <span class="type">SparkConf</span>()</span><br><span class="line"><span class="keyword">val</span> builder = <span class="type">SparkSession</span>.builder().config(conf).enableHiveSupport()</span><br><span class="line"><span class="keyword">val</span> spark = builder.getOrCreateBigquerySparkSession()</span><br><span class="line"><span class="keyword">val</span> df = spark.sql(<span class="string">"use db; select * from table"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> dataset = df.rdd.mapPartitions(iter =&gt; {</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将每个 partition 中的多行数据，以 100 为长度作为一组，进行一次批处理</span></span><br><span class="line">  iter.grouped(<span class="number">100</span>)</span><br><span class="line">    .flatMap(rows =&gt; {</span><br><span class="line">      <span class="keyword">val</span> records = <span class="keyword">new</span> mutable.<span class="type">MutableList</span>[<span class="type">String</span>]()</span><br><span class="line">      rows.foreach(row =&gt; records.add(<span class="type">JSON</span>.toJSONString(row, <span class="literal">false</span>)))</span><br><span class="line">      records</span><br><span class="line">    })</span><br><span class="line">})</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> filteredEmptyLine = dataset</span><br><span class="line">  .filter(_ != <span class="literal">null</span>)</span><br><span class="line">  .map(<span class="type">JSON</span>.toJSONString(_, <span class="literal">false</span>))</span><br><span class="line">  .filter(_.trim.length != <span class="number">0</span>)</span><br></pre></td></tr></tbody></table></figure>
<a id="more"></a>
<h3 id="Enum"><a href="#Enum" class="headerlink" title="Enum"></a>Enum</h3><figure class="highlight scala"><table><tbody><tr><td class="code"><pre><span class="line">scala&gt; <span class="class"><span class="keyword">object</span> <span class="title">Types</span> <span class="keyword">extends</span> <span class="title">Enumeration</span> </span>{</span><br><span class="line">     |   <span class="class"><span class="keyword">type</span> <span class="title">Types</span> </span>= <span class="type">Value</span></span><br><span class="line">     |   <span class="keyword">val</span> <span class="type">ZERO</span>, <span class="type">ONE</span>, <span class="type">TWO</span> = <span class="type">Value</span></span><br><span class="line">     |</span><br><span class="line">     |   <span class="function"><span class="keyword">def</span> <span class="title">toType</span></span>(types: <span class="type">String</span>): <span class="type">Option</span>[<span class="type">Types</span>] = {</span><br><span class="line">     |     <span class="comment">// Types.values.filter(_.toString.trim.toUpperCase.equals(types.trim.</span></span><br><span class="line">toUpperCase)).headOption</span><br><span class="line">     |     <span class="type">Types</span>.values.find(_.toString.trim.toUpperCase.equals(types.trim.toUpp</span><br><span class="line">erCase))</span><br><span class="line">     |   }</span><br><span class="line">     | }</span><br><span class="line">defined <span class="class"><span class="keyword">object</span> <span class="title">Types</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">scala&gt;</span> <span class="title">Types</span>.<span class="title">toType</span>(<span class="params">"<span class="type">Zero</span>"</span>)</span></span><br><span class="line"><span class="class"><span class="title">res6</span></span>: <span class="type">Option</span>[<span class="type">Types</span>.<span class="type">Types</span>] = <span class="type">Some</span>(<span class="type">ZERO</span>)</span><br><span class="line"></span><br><span class="line">scala&gt; <span class="type">Types</span>.toType(<span class="string">"ONE"</span>)</span><br><span class="line">res7: <span class="type">Option</span>[<span class="type">Types</span>.<span class="type">Types</span>] = <span class="type">Some</span>(<span class="type">ONE</span>)</span><br><span class="line"></span><br><span class="line">scala&gt; <span class="type">Types</span>.toType(<span class="string">"two"</span>)</span><br><span class="line">res8: <span class="type">Option</span>[<span class="type">Types</span>.<span class="type">Types</span>] = <span class="type">Some</span>(<span class="type">TWO</span>)</span><br><span class="line"></span><br><span class="line">scala&gt; <span class="type">Types</span>.toType(<span class="string">"three"</span>)</span><br><span class="line">res9: <span class="type">Option</span>[<span class="type">Types</span>.<span class="type">Types</span>] = <span class="type">None</span></span><br><span class="line"></span><br><span class="line">scala&gt; <span class="type">Types</span>.toType(<span class="string">"THREE"</span>)</span><br><span class="line">res10: <span class="type">Option</span>[<span class="type">Types</span>.<span class="type">Types</span>] = <span class="type">None</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="Case-class"><a href="#Case-class" class="headerlink" title="Case class"></a>Case class</h3><h4 id="和-class-的-8-个不同之处"><a href="#和-class-的-8-个不同之处" class="headerlink" title="和 class 的 8 个不同之处"></a>和 class 的 8 个不同之处</h4><figure class="highlight scala"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 定义</span></span><br><span class="line">scala&gt; <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span>(<span class="params">name: <span class="type">String</span>, age: <span class="type">Int</span></span>)</span></span><br><span class="line"><span class="class"><span class="title">defined</span> <span class="title">class</span> <span class="title">Person</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">//</span> <span class="title">初始化</span></span></span><br><span class="line"><span class="class"><span class="title">scala&gt;</span> <span class="title">val</span> <span class="title">bj</span> </span>= <span class="type">Person</span>(<span class="string">"Benedict Jin"</span>, <span class="number">18</span>)</span><br><span class="line">bj: <span class="type">Person</span> = <span class="type">Person</span>(<span class="type">Benedict</span> <span class="type">Jin</span>,<span class="number">18</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 参数的访问权限都是 public</span></span><br><span class="line">scala&gt; bj.name</span><br><span class="line">res0: <span class="type">String</span> = <span class="type">Benedict</span> <span class="type">Jin</span></span><br><span class="line"></span><br><span class="line">scala&gt; bj.age</span><br><span class="line">res1: <span class="type">Integer</span> = <span class="number">18</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 更加简洁的 toString 打印</span></span><br><span class="line">scala&gt; bj.toString</span><br><span class="line">res2: <span class="type">String</span> = <span class="type">Person</span>(<span class="type">Benedict</span> <span class="type">Jin</span>,<span class="number">18</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 默认实现了 hashCode 和 equals 方法</span></span><br><span class="line">scala&gt; bj.hashCode</span><br><span class="line">res3: <span class="type">Int</span> = <span class="number">1059149039</span></span><br><span class="line"></span><br><span class="line">scala&gt; <span class="type">Person</span>(<span class="string">"Benedict Jin"</span>, <span class="number">18</span>).hashCode</span><br><span class="line">res4: <span class="type">Int</span> = <span class="number">1059149039</span></span><br><span class="line"></span><br><span class="line">scala&gt; <span class="type">Person</span>(<span class="string">"Benedict Jin"</span>, <span class="number">18</span>) == bj</span><br><span class="line">res5: <span class="type">Boolean</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 默认实现了 java.io.Serializable 接口，支持序列化</span></span><br><span class="line">scala&gt; <span class="keyword">import</span> java.io._</span><br><span class="line"><span class="keyword">import</span> java.io._</span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">val</span> bos = <span class="keyword">new</span> <span class="type">ByteArrayOutputStream</span></span><br><span class="line">bos: java.io.<span class="type">ByteArrayOutputStream</span> =</span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">val</span> oos = <span class="keyword">new</span> <span class="type">ObjectOutputStream</span>(bos)</span><br><span class="line">oos: java.io.<span class="type">ObjectOutputStream</span> = java.io.<span class="type">ObjectOutputStream</span>@<span class="number">62</span>ddd21b</span><br><span class="line"></span><br><span class="line">scala&gt; oos.writeObject(bj)</span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">val</span> obj = <span class="keyword">new</span> <span class="type">ObjectInputStream</span>(<span class="keyword">new</span> <span class="type">ByteArrayInputStream</span>(bos.toByteArray)</span><br><span class="line">).readObject()</span><br><span class="line">obj: <span class="type">Object</span> = <span class="type">Person</span>(<span class="type">Benedict</span> <span class="type">Jin</span>,<span class="number">18</span>)</span><br><span class="line"></span><br><span class="line">scala&gt; <span class="type">Person</span>(<span class="string">"Benedict Jin"</span>, <span class="number">18</span>) == obj</span><br><span class="line">res6: <span class="type">Boolean</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 支持 match</span></span><br><span class="line">scala&gt; bj <span class="keyword">match</span> {</span><br><span class="line">     |   <span class="keyword">case</span> <span class="type">Person</span>(<span class="string">"Benedict Jin"</span>, <span class="number">18</span>) =&gt; println(<span class="string">"matched"</span>)</span><br><span class="line">     |   <span class="keyword">case</span> _ =&gt; println(<span class="string">"non-matched"</span>)</span><br><span class="line">     | }</span><br><span class="line">matched</span><br><span class="line"></span><br><span class="line"><span class="comment">// 默认继承 scala.Product 类，并实现了其中的方法</span></span><br><span class="line">scala&gt; bj.productArity</span><br><span class="line">res7: <span class="type">Int</span> = <span class="number">2</span></span><br><span class="line"></span><br><span class="line">scala&gt; bj.productIterator.next()</span><br><span class="line">res8: <span class="type">Any</span> = <span class="type">Benedict</span> <span class="type">Jin</span></span><br><span class="line"></span><br><span class="line">scala&gt; bj.productElement(<span class="number">1</span>)</span><br><span class="line">res9: <span class="type">Any</span> = <span class="number">18</span></span><br><span class="line"></span><br><span class="line">scala&gt; bj.productPrefix</span><br><span class="line">res10: <span class="type">String</span> = <span class="type">Person</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="打印-trait-中的字段"><a href="#打印-trait-中的字段" class="headerlink" title="打印 trait 中的字段"></a>打印 trait 中的字段</h4><figure class="highlight scala"><table><tbody><tr><td class="code"><pre><span class="line">scala&gt; <span class="class"><span class="keyword">trait</span> <span class="title">T</span> </span>{</span><br><span class="line">     |   <span class="keyword">var</span> t: <span class="type">String</span> = <span class="string">""</span></span><br><span class="line">     | }</span><br><span class="line">defined <span class="class"><span class="keyword">trait</span> <span class="title">T</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">//</span> <span class="title">正常情况下，不会打印</span> <span class="title">trait</span> <span class="title">中的字段</span></span></span><br><span class="line"><span class="class"><span class="title">scala&gt;</span> <span class="title">case</span> <span class="title">class</span> <span class="title">Person</span>(<span class="params">name: <span class="type">String</span></span>) <span class="keyword">extends</span> <span class="title">Serializable</span> <span class="keyword">with</span> <span class="title">T</span></span></span><br><span class="line"><span class="class"><span class="title">defined</span> <span class="title">class</span> <span class="title">Person</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">scala&gt;</span> <span class="title">Person</span>(<span class="params">"<span class="type">Benedict</span> <span class="type">Jin</span>"</span>)</span></span><br><span class="line"><span class="class"><span class="title">res6</span></span>: <span class="type">Person</span> = <span class="type">Person</span>(<span class="type">Benedict</span> <span class="type">Jin</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过 ScalaRunTime._toString(this) 来覆写 toString 方法，可以避免 case class 的 toString 方法被篡改</span></span><br><span class="line">scala&gt; <span class="keyword">import</span> scala.runtime.<span class="type">ScalaRunTime</span></span><br><span class="line"><span class="keyword">import</span> scala.runtime.<span class="type">ScalaRunTime</span></span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Person2</span>(<span class="params">name: <span class="type">String</span></span>) <span class="keyword">extends</span> <span class="title">Serializable</span> <span class="keyword">with</span> <span class="title">T</span> </span>{</span><br><span class="line">     |   <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">toString</span></span>: <span class="type">String</span> = <span class="type">ScalaRunTime</span>._toString(<span class="keyword">this</span>)</span><br><span class="line">     | }</span><br><span class="line">defined <span class="class"><span class="keyword">class</span> <span class="title">Person2</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">scala&gt;</span> <span class="title">Person2</span>(<span class="params">"<span class="type">Benedict</span> <span class="type">Jin</span>"</span>).<span class="title">toString</span></span></span><br><span class="line"><span class="class"><span class="title">res7</span></span>: <span class="type">String</span> = <span class="type">Person2</span>(<span class="type">Benedict</span> <span class="type">Jin</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重写 toString 来打印 trait 中的字段</span></span><br><span class="line">scala&gt; <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Person3</span>(<span class="params">name: <span class="type">String</span></span>) <span class="keyword">extends</span> <span class="title">Serializable</span> <span class="keyword">with</span> <span class="title">T</span> </span>{</span><br><span class="line">     |   <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">toString</span></span>: <span class="type">String</span> = <span class="string">s"Person3(<span class="subst">${this.name}</span>, <span class="subst">${this.t}</span>)"</span></span><br><span class="line">     | }</span><br><span class="line">defined <span class="class"><span class="keyword">class</span> <span class="title">Person3</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">scala&gt;</span> <span class="title">val</span> <span class="title">p3</span> </span>= <span class="type">Person3</span>(<span class="string">"Benedict Jin"</span>)</span><br><span class="line">p3: <span class="type">Person3</span> = <span class="type">Person3</span>(<span class="type">Benedict</span> <span class="type">Jin</span>, )</span><br><span class="line"></span><br><span class="line">scala&gt; p3.t = <span class="string">"t"</span></span><br><span class="line">p3.t: <span class="type">String</span> = t</span><br><span class="line"></span><br><span class="line">scala&gt; p3.toString</span><br><span class="line">res8: <span class="type">String</span> = <span class="type">Person3</span>(<span class="type">Benedict</span> <span class="type">Jin</span>, t)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h3><p>　详见，《在不同场景下，<a href="https://yuzhouwan.com/posts/27328/#Scala">如何选择合适的 JVM 语言</a>》</p>
<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h3 id="classOf-和-getClass-的区别"><a href="#classOf-和-getClass-的区别" class="headerlink" title="classOf 和 getClass 的区别"></a>classOf 和 getClass 的区别</h3><figure class="highlight scala"><table><tbody><tr><td class="code"><pre><span class="line">scala&gt; <span class="class"><span class="keyword">class</span>  <span class="title">A</span></span></span><br><span class="line"><span class="class">  <span class="title">defined</span> <span class="title">class</span> <span class="title">A</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">scala&gt;</span> <span class="title">val</span> <span class="title">a</span> </span>= <span class="keyword">new</span> <span class="type">A</span></span><br><span class="line">  a: <span class="type">A</span> = <span class="type">A</span>@<span class="number">1</span>d483de4</span><br><span class="line"></span><br><span class="line"><span class="comment">// A 的任意子类</span></span><br><span class="line">scala&gt; a.getClass</span><br><span class="line">  res0: <span class="type">Class</span>[_ &lt;: <span class="type">A</span>] = <span class="class"><span class="keyword">class</span> <span class="title">A</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">//</span> <span class="title">A</span> <span class="title">类本身</span></span></span><br><span class="line"><span class="class"><span class="title">scala&gt;</span> <span class="title">classOf</span>[<span class="type">A</span>]</span></span><br><span class="line"><span class="class">  <span class="title">res1</span></span>: <span class="type">Class</span>[<span class="type">A</span>] = <span class="class"><span class="keyword">class</span> <span class="title">A</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">//</span> <span class="title">两者是等价的</span></span></span><br><span class="line"><span class="class"><span class="title">scala&gt;</span> <span class="title">a</span>.<span class="title">getClass</span> <span class="title">==</span> <span class="title">classOf</span>[<span class="type">A</span>]</span></span><br><span class="line"><span class="class">  <span class="title">res2</span></span>: <span class="type">Boolean</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// getClass 的返回值，是不能直接赋值给 Class[A] 的</span></span><br><span class="line">scala&gt; <span class="keyword">val</span> c: <span class="type">Class</span>[<span class="type">A</span>] = a.getClass</span><br><span class="line">  &lt;console&gt;:<span class="number">13</span>: error: <span class="class"><span class="keyword">type</span> <span class="title">mismatch</span></span>;</span><br><span class="line">   found   : <span class="type">Class</span>[?<span class="number">0</span>] where <span class="class"><span class="keyword">type</span> <span class="title">?0</span> <span class="title">&lt;</span></span>: <span class="type">A</span></span><br><span class="line">   required: <span class="type">Class</span>[<span class="type">A</span>]</span><br><span class="line">  <span class="type">Note</span>: ?<span class="number">0</span> &lt;: <span class="type">A</span>, but <span class="type">Java</span>-defined <span class="class"><span class="keyword">class</span> <span class="title">Class</span> <span class="title">is</span> <span class="title">invariant</span> <span class="title">in</span> <span class="title">type</span> <span class="title">T</span>.</span></span><br><span class="line"><span class="class">  <span class="title">You</span> <span class="title">may</span> <span class="title">wish</span> <span class="title">to</span> <span class="title">investigate</span> <span class="title">a</span> <span class="title">wildcard</span> <span class="title">type</span> <span class="title">such</span> <span class="title">as</span> `<span class="title">_</span> <span class="title">&lt;</span></span>: <span class="type">A</span>`. (<span class="type">SLS</span> <span class="number">3.2</span><span class="number">.10</span>)</span><br><span class="line">         <span class="keyword">val</span> c:<span class="type">Class</span>[<span class="type">A</span>] = a.getClass</span><br><span class="line">                            ^</span><br><span class="line"></span><br><span class="line"><span class="comment">// 需要声明 Class[_ &lt;: A] 才行，类似于 Java 里面的 Class&lt;? extends A&gt;</span></span><br><span class="line">scala&gt; <span class="keyword">val</span> c: <span class="type">Class</span>[_ &lt;: <span class="type">A</span>] = a.getClass</span><br><span class="line">  c: <span class="type">Class</span>[_ &lt;: <span class="type">A</span>] = <span class="class"><span class="keyword">class</span> <span class="title">A</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">//</span> <span class="title">但是获取全限定名的返回值，却是一样的</span></span></span><br><span class="line"><span class="class"><span class="title">scala&gt;</span> <span class="title">c</span>.<span class="title">getName</span></span></span><br><span class="line"><span class="class">  <span class="title">res3</span></span>: <span class="type">String</span> = <span class="type">A</span></span><br><span class="line"></span><br><span class="line">scala&gt; classOf[<span class="type">A</span>].getName</span><br><span class="line">  res4: <span class="type">String</span> = <span class="type">A</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="稳定的标识符模式"><a href="#稳定的标识符模式" class="headerlink" title="稳定的标识符模式"></a>稳定的标识符模式</h3><figure class="highlight scala"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 如果不用 ` 反引号将 a / b / c 变量括起来</span></span><br><span class="line"><span class="comment">// 那么这些变量，其实就变成了指向 i 的别名，已经和 match 外层的 a / b / c 变量无关了</span></span><br><span class="line">scala&gt; <span class="function"><span class="keyword">def</span> <span class="title">m</span></span>(i: <span class="type">Int</span>) = {</span><br><span class="line">     |   <span class="keyword">val</span> a = <span class="number">3</span></span><br><span class="line">     |   <span class="keyword">val</span> b = <span class="number">2</span></span><br><span class="line">     |   <span class="keyword">val</span> c = <span class="number">1</span></span><br><span class="line">     |   i <span class="keyword">match</span> {</span><br><span class="line">     |     <span class="keyword">case</span> `a` =&gt; <span class="number">0</span></span><br><span class="line">     |     <span class="keyword">case</span> `b` =&gt; <span class="number">-1</span></span><br><span class="line">     |     <span class="keyword">case</span> `c` =&gt; <span class="number">4</span></span><br><span class="line">     |     <span class="keyword">case</span> _ =&gt; <span class="number">2</span></span><br><span class="line">     |   }</span><br><span class="line">     | }</span><br><span class="line">m: (i: <span class="type">Int</span>)<span class="type">Int</span></span><br><span class="line"></span><br><span class="line">scala&gt; m(<span class="number">1</span>)</span><br><span class="line">res17: <span class="type">Int</span> = <span class="number">4</span></span><br><span class="line"></span><br><span class="line">scala&gt; m(<span class="number">2</span>)</span><br><span class="line">res18: <span class="type">Int</span> = <span class="number">-1</span></span><br><span class="line"></span><br><span class="line">scala&gt; m(<span class="number">3</span>)</span><br><span class="line">res19: <span class="type">Int</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 另外，使用反引号将变量括起来之后，scala 会在字节码层面做优化</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> 0: iconst_3</span></span><br><span class="line"><span class="comment"> 1: istore_2</span></span><br><span class="line"><span class="comment"> 2: iconst_2</span></span><br><span class="line"><span class="comment"> 3: istore_3</span></span><br><span class="line"><span class="comment"> 4: iconst_1</span></span><br><span class="line"><span class="comment"> 5: istore          4</span></span><br><span class="line"><span class="comment"> 7: iload_1</span></span><br><span class="line"><span class="comment"> 8: istore          5</span></span><br><span class="line"><span class="comment">10: iload_2</span></span><br><span class="line"><span class="comment">11: iload           5</span></span><br><span class="line"><span class="comment">13: if_icmpne       22</span></span><br><span class="line"><span class="comment">16: iconst_0</span></span><br><span class="line"><span class="comment">17: istore          6</span></span><br><span class="line"><span class="comment">19: goto            50</span></span><br><span class="line"><span class="comment">22: iload_3</span></span><br><span class="line"><span class="comment">23: iload           5</span></span><br><span class="line"><span class="comment">25: if_icmpne       34</span></span><br><span class="line"><span class="comment">28: iconst_m1</span></span><br><span class="line"><span class="comment">29: istore          6</span></span><br><span class="line"><span class="comment">31: goto            50</span></span><br><span class="line"><span class="comment">34: iload           4</span></span><br><span class="line"><span class="comment">36: iload           5</span></span><br><span class="line"><span class="comment">38: if_icmpne       47</span></span><br><span class="line"><span class="comment">41: iconst_4</span></span><br><span class="line"><span class="comment">42: istore          6</span></span><br><span class="line"><span class="comment">44: goto            50</span></span><br><span class="line"><span class="comment">47: iconst_2</span></span><br><span class="line"><span class="comment">48: istore          6</span></span><br><span class="line"><span class="comment">50: iload           6</span></span><br><span class="line"><span class="comment">52: ireturn</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></tbody></table></figure>
<p>Tips: Full code is <a href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-hacker/src/main/scala/com/yuzhouwan/hacker/cases/CaseStableIdentifier.scala">here</a> and <a href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-hacker/src/main/scala/com/yuzhouwan/hacker/cases/CaseNotStableIdentifier.scala">here</a>.</p>
<h3 id="在函数调用里面，对变量进行赋值"><a href="#在函数调用里面，对变量进行赋值" class="headerlink" title="在函数调用里面，对变量进行赋值"></a>在函数调用里面，对变量进行赋值</h3><figure class="highlight scala"><table><tbody><tr><td class="code"><pre><span class="line">scala&gt; <span class="keyword">val</span> map = <span class="keyword">new</span> java.util.<span class="type">LinkedHashMap</span>[<span class="type">String</span>, <span class="type">String</span>]()</span><br><span class="line">map: java.util.<span class="type">LinkedHashMap</span>[<span class="type">String</span>,<span class="type">String</span>] = {}</span><br><span class="line"></span><br><span class="line">scala&gt; map.put(<span class="string">"1"</span>, <span class="string">"1"</span>)</span><br><span class="line">res0: <span class="type">String</span> = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">scala&gt; map.put(<span class="string">"2"</span>, <span class="string">"2"</span>)</span><br><span class="line">res1: <span class="type">String</span> = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">scala&gt; map.put(<span class="string">"3"</span>, <span class="string">"3"</span>)</span><br><span class="line">res2: <span class="type">String</span> = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">scala&gt; map</span><br><span class="line">res3: java.util.<span class="type">LinkedHashMap</span>[<span class="type">String</span>,<span class="type">String</span>] = {<span class="number">1</span>=<span class="number">1</span>, <span class="number">2</span>=<span class="number">2</span>, <span class="number">3</span>=<span class="number">3</span>}</span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">var</span> s = <span class="string">"1 "</span></span><br><span class="line">s: <span class="type">String</span> = <span class="string">"1 "</span></span><br><span class="line"></span><br><span class="line">scala&gt; map.containsValue(s)</span><br><span class="line">res4: <span class="type">Boolean</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 虽然已经将 s.trim 赋值给 s 变量了，但是传入 map.containsValue 方法的仍然是未进行 trim 操作之前的 s 变量</span></span><br><span class="line"><span class="comment">// 这里和 Java 是不一样的，Java 会将已经赋值之后的变量值，传入到方法中</span></span><br><span class="line">scala&gt; map.containsValue(s = s.trim)</span><br><span class="line">res5: <span class="type">Boolean</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">scala&gt; s</span><br><span class="line">res6: <span class="type">String</span> = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">scala&gt; <span class="string">"1"</span>.equals(s)</span><br><span class="line">res7: <span class="type">Boolean</span> = <span class="literal">true</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="Java-的-Lambda-表达式转为-Scala-的-Function"><a href="#Java-的-Lambda-表达式转为-Scala-的-Function" class="headerlink" title="Java 的 Lambda 表达式转为 Scala 的 Function"></a>Java 的 Lambda 表达式转为 Scala 的 Function</h3><h4 id="Java-的-Lambda-表达式"><a href="#Java-的-Lambda-表达式" class="headerlink" title="Java 的 Lambda 表达式"></a>Java 的 Lambda 表达式</h4><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">static</span> ThreadLocal&lt;String&gt; BLOG_ID = ThreadLocal.withInitial(() -&gt; <span class="string">"null"</span>);</span><br></pre></td></tr></tbody></table></figure>
<h4 id="反面示例"><a href="#反面示例" class="headerlink" title="反面示例"></a>反面示例</h4><figure class="highlight scala"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 直接填入 lambda 表达式，IDE 并不会报错，但是会在代码编译阶段报错</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> <span class="type">BLOG_ID</span>: <span class="type">ThreadLocal</span>[<span class="type">String</span>] = <span class="type">ThreadLocal</span>.withInitial(() -&gt; <span class="string">"null"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 即便把 function 单独拿出来作为 Supplier 变量进行申明，仍然会出现编译错误</span></span><br><span class="line"><span class="keyword">val</span> blogIdFunc: java.util.function.<span class="type">Supplier</span>[<span class="type">String</span>] = () =&gt; <span class="string">"null"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 具体编译报错，如下：</span></span><br><span class="line"><span class="keyword">val</span> func: java.util.function.<span class="type">Supplier</span>[<span class="type">String</span>] = () =&gt; <span class="string">"null"</span></span><br><span class="line"> error: <span class="class"><span class="keyword">type</span> <span class="title">mismatch</span></span>;</span><br><span class="line"> found   : () =&gt; <span class="type">String</span></span><br><span class="line"> required: java.util.function.<span class="type">Supplier</span>[<span class="type">String</span>]</span><br><span class="line">       <span class="keyword">val</span> func: java.util.function.<span class="type">Supplier</span>[<span class="type">String</span>] = () =&gt; <span class="string">"null"</span></span><br><span class="line">                                                          ^</span><br></pre></td></tr></tbody></table></figure>
<h4 id="正面示例"><a href="#正面示例" class="headerlink" title="正面示例"></a>正面示例</h4><figure class="highlight scala"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 写成 new Supplier[T]{...} 的写法之后，则可以完成编译</span></span><br><span class="line"><span class="comment">// 不过，奇怪的是，编译器仍然会提示，可以将代码优化为 () =&gt; "null"</span></span><br><span class="line"><span class="keyword">val</span> blogIdFunc: java.util.function.<span class="type">Supplier</span>[<span class="type">String</span>] = <span class="keyword">new</span> <span class="type">Supplier</span>[<span class="type">String</span>] { <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">get</span></span>(): <span class="type">String</span> = <span class="string">"null"</span> }</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> <span class="type">BLOG_ID</span>: <span class="type">ThreadLocal</span>[<span class="type">String</span>] = <span class="type">ThreadLocal</span>.withInitial(blogIdFunc)</span><br></pre></td></tr></tbody></table></figure>
<h4 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h4><figure class="highlight scala"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 如果这部分代码还需要运行在 JDK7 及以下版本的 JVM 环境中，则可以改成普通的 "初始化 ThreadLocal" 方式</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> <span class="type">BLOG_ID</span>: <span class="type">ThreadLocal</span>[<span class="type">String</span>] = <span class="keyword">new</span> <span class="type">ThreadLocal</span>[<span class="type">String</span>]() {</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">initialValue</span></span>(): <span class="type">String</span> = <span class="string">"null"</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 另外，如果存在 "跨父子线程" 和 "线程池缓存" 的场景，则可以使用 TransmittableThreadLocal 来替换原生的 ThreadLocal</span></span><br><span class="line"><span class="comment">// 不过，在使用 TTL 时，需要注意以下两点：</span></span><br><span class="line"><span class="comment">//   1) 根据 JDK 版本选择合适版本的 TTL 框架（JDK7 只能使用 2.2.2 及以下版本的 TTL）</span></span><br><span class="line"><span class="comment">//   2) 及时使用 remove 方法完成主动清理，提高 GC 效率</span></span><br></pre></td></tr></tbody></table></figure>
<p>Tips: Full code is <a href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-hacker/src/test/java/com/yuzhouwan/hacker/algorithms/thread/ttl/TransmittableThreadLocalTest.java">here</a>.</p>
<h3 id="如何传递变长参数"><a href="#如何传递变长参数" class="headerlink" title="如何传递变长参数"></a>如何传递变长参数</h3><h4 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h4><figure class="highlight scala"><table><tbody><tr><td class="code"><pre><span class="line">scala&gt; <span class="function"><span class="keyword">def</span> <span class="title">detail</span></span>(d: <span class="type">Any</span>*): <span class="type">Unit</span> = println(<span class="string">"%s_%s"</span>.format(d))</span><br><span class="line">detail: (d: <span class="type">Any</span>*)<span class="type">Unit</span></span><br><span class="line"></span><br><span class="line">scala&gt; detail(<span class="string">"a"</span>, <span class="string">"b"</span>)</span><br><span class="line">java.util.<span class="type">MissingFormatArgumentException</span>: <span class="type">Format</span> specifier '%s'</span><br><span class="line">  at java.util.<span class="type">Formatter</span>.format(<span class="type">Formatter</span>.java:<span class="number">2519</span>)</span><br><span class="line">  at java.util.<span class="type">Formatter</span>.format(<span class="type">Formatter</span>.java:<span class="number">2455</span>)</span><br><span class="line">  at java.lang.<span class="type">String</span>.format(<span class="type">String</span>.java:<span class="number">2940</span>)</span><br><span class="line">  at scala.collection.immutable.<span class="type">StringLike</span>$<span class="keyword">class</span>.format(StringLike.scala:<span class="number">318</span>)</span><br><span class="line">  at scala.collection.immutable.<span class="type">StringOps</span>.format(<span class="type">StringOps</span>.scala:<span class="number">29</span>)</span><br><span class="line">  at .detail(&lt;console&gt;:<span class="number">11</span>)</span><br><span class="line">  ... <span class="number">32</span> elided</span><br></pre></td></tr></tbody></table></figure>
<h4 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h4><figure class="highlight scala"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 在函数中，想要将传入的变长参数，保持成多个参数的特性，传递下去的话，需要声明 : _*</span></span><br><span class="line">scala&gt; <span class="function"><span class="keyword">def</span> <span class="title">detail</span></span>(d: <span class="type">Any</span>*): <span class="type">Unit</span> = println(<span class="string">"%s_%s"</span>.format(d: _*))</span><br><span class="line">detail: (d: <span class="type">Any</span>*)<span class="type">Unit</span></span><br><span class="line"></span><br><span class="line">scala&gt; detail(<span class="string">"a"</span>, <span class="string">"b"</span>)</span><br><span class="line">a_b</span><br></pre></td></tr></tbody></table></figure>
<h4 id="补充-1"><a href="#补充-1" class="headerlink" title="补充"></a>补充</h4><figure class="highlight scala"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 如果直接用 String.format，会因为占位符和变长参数 数量不一致，导致报错</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">countSubString</span></span>(str: <span class="type">String</span>, sub: <span class="type">String</span>): <span class="type">Int</span> = str.sliding(sub.length).count(slide =&gt; slide == sub)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">patchSubString</span></span>(str: <span class="type">String</span>, sub: <span class="type">String</span>): <span class="type">String</span> = str.patch(str.lastIndexOf(sub), <span class="string">""</span>, sub.length)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 封装 superFormat 方法来解决该问题</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">superFormat</span></span>(str: <span class="type">String</span>, detail: <span class="type">String</span>*): <span class="type">String</span> = {</span><br><span class="line">  <span class="keyword">val</span> holderSize: <span class="type">Int</span> = countSubString(str, <span class="string">"%s"</span>)</span><br><span class="line">  <span class="keyword">val</span> detailSize: <span class="type">Int</span> = detail.size</span><br><span class="line">  <span class="keyword">var</span> result: <span class="type">String</span> = str</span><br><span class="line">  <span class="keyword">if</span> (detailSize &lt; holderSize) {</span><br><span class="line">    <span class="keyword">for</span> (_ &lt;- <span class="number">0</span> until (holderSize - detailSize)) {</span><br><span class="line">      result = patchSubString(result, <span class="string">"%s"</span>)</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  result.format(detail: _*)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>Tips: Full code is <a href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-common/src/main/scala/com/yuzhouwan/common/util/StrUtils4Scala.scala">here</a> and <a href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-common/src/test/scala/com/yuzhouwan/common/util/StrUtils4ScalaTest.scala">here</a>.</p>
<h3 id="隐式转换"><a href="#隐式转换" class="headerlink" title="隐式转换"></a>隐式转换</h3><figure class="highlight scala"><table><tbody><tr><td class="code"><pre><span class="line">scala&gt; <span class="keyword">import</span> java.util</span><br><span class="line"><span class="keyword">import</span> java.util</span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">val</span> l = <span class="keyword">new</span> util.<span class="type">LinkedList</span>[<span class="type">String</span>]()</span><br><span class="line">l: java.util.<span class="type">LinkedList</span>[<span class="type">String</span>] = []</span><br><span class="line"></span><br><span class="line">scala&gt; l.add(<span class="string">"yuzhouwan.com"</span>)</span><br><span class="line">res0: <span class="type">Boolean</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">scala&gt; <span class="type">Seq</span>(l)</span><br><span class="line">res1: <span class="type">Seq</span>[java.util.<span class="type">LinkedList</span>[<span class="type">String</span>]] = <span class="type">List</span>([yuzhouwan.com])</span><br><span class="line"></span><br><span class="line">scala&gt; l.toSeq</span><br><span class="line">&lt;console&gt;:<span class="number">14</span>: error: value toSeq is not a member of java.util.<span class="type">LinkedList</span>[<span class="type">String</span>]</span><br><span class="line">       l.toSeq</span><br><span class="line">         ^</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这可能是每个 java 开发，在接触 scala 的时候，都会遇到的问题，，有点小恶心</span></span><br><span class="line">scala&gt; <span class="keyword">import</span> scala.collection.<span class="type">JavaConversions</span>._</span><br><span class="line"><span class="keyword">import</span> scala.collection.<span class="type">JavaConversions</span>._</span><br><span class="line"></span><br><span class="line">scala&gt; l.toSeq</span><br><span class="line">res3: <span class="type">Seq</span>[<span class="type">String</span>] = <span class="type">Buffer</span>(yuzhouwan.com)</span><br></pre></td></tr></tbody></table></figure>
<h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><h3 id="Book"><a href="#Book" class="headerlink" title="Book"></a>Book</h3><ul>
<li><a href="https://www.amazon.cn/dp/0134540565">Scala for the Impatient，2nd Edition</a></li>
<li><a href="https://www.amazon.cn/dp/1119267226">Professional Scala</a></li>
<li><a href="https://www.amazon.cn/dp/1484230353">Practical Scala DSLs</a></li>
<li><a href="https://www.amazon.cn/dp/1484231074">Scala for Java Developers</a></li>
<li><a href="https://www.amazon.cn/dp/178646604X">Scala High Performance Programming</a></li>
<li><a href="https://www.amazon.cn/dp/B01E4X8X52">Scala 程序设计（第 2 版）</a></li>
<li><a href="https://www.amazon.cn/dp/B073ZTH556">快学 Scala（第 2 版）</a></li>
<li><a href="https://www.amazon.cn/dp/B00CBBKJ0W">Scala 程序设计：Java 虚拟机多核编程实战</a></li>
</ul>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt=""></a></td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>语言</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Scala</tag>
        <tag>JVM</tag>
        <tag>Apache Spark</tag>
      </tags>
  </entry>
  <entry>
    <title>Serverless 详解</title>
    <url>/posts/201001/</url>
    <content><![CDATA[<h2 id="Serverless-是什么？"><a href="#Serverless-是什么？" class="headerlink" title="Serverless 是什么？"></a>Serverless 是什么？</h2><blockquote>
<p>Serverless computing is a cloud computing execution model in which the cloud provider runs the server, and dynamically manages the allocation of machine resources. Pricing is based on the actual amount of resources consumed by an application, rather than on pre-purchased units of capacity. It can be a form of utility computing. — <a href="https://en.wikipedia.org/wiki/Serverless_computing">wikipedia.org</a></p>
<p>Serverless architectures are application designs that incorporate third-party “Backend as a Service” (BaaS) services, and/or that include custom code run in managed, ephemeral containers on a “Functions as a Service” (FaaS) platform. — <a href="https://martinfowler.com/articles/serverless.html">《Serverless Architectures》</a></p>
<p>无服务器架构是基于互联网的系统，其中应用开发不使用常规的服务进程。相反，它们仅依赖于第三方服务（例如 AWS Lambda 服务），客户端逻辑和服务托管远程过程调用的组合。  — <a href="https://aws.amazon.com/cn/blogs/china/iaas-faas-serverless/">亚马逊 AWS 官方博客</a></p>
<p>Serverless（无服务器架构）是指服务端逻辑由开发者实现，运行在无状态的计算容器中，由事件触发，完全被第三方管理，其业务层面的状态则存储在数据库或其他介质中。  — <a href="https://www.bookstack.cn/read/serverless-handbook/concepts-what-is-serverless.md">《无服务架构实践手册》</a></p>
<p>If your PaaS can efficiently start instances in 20ms that run for half a second, then call it serverless.  — Adrian Cockroft</p>
</blockquote>
<h2 id="优缺点"><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h2><h3 id="优势"><a href="#优势" class="headerlink" title="优势"></a>优势</h3><h4 id="低成本"><a href="#低成本" class="headerlink" title="低成本"></a>低成本</h4><h5 id="运维成本"><a href="#运维成本" class="headerlink" title="运维成本"></a>运维成本</h5><p>　服务器、中间件、数据库等均托管于 BaaS/FaaS 平台，用户无需再参与基础设施及软件的维护，省去了集群的运维成本</p>
<h5 id="开发成本"><a href="#开发成本" class="headerlink" title="开发成本"></a>开发成本</h5><p>　对比 IaaS 或者 PaaS 平台的服务器或者操作系统，Serverless 的架构中，用户操作的是服务化的组件，比如存储服务、授权服务等，可以缩短开发周期，节约时间成本</p>
<h4 id="按需计费"><a href="#按需计费" class="headerlink" title="按需计费"></a>按需计费</h4><p>　Serverless/FaaS 区别于 IaaS/PaaS 预先分配计算资源的计费方式，其计费方式通常是按请求次数及运行时间。如此一来，不仅可以最大程度地利用资源，还能实现真正的按需计费，以降低用户的使用成本</p>
<p><img data-src="/picture/serverless/serverless_cost.png" alt="Serverless cost"></p>
<center>（使用 <a href="https://www.apple.com/cn/ipad/" target="_blank">iPad</a>™ 手绘而成）</center>

<h4 id="高扩展"><a href="#高扩展" class="headerlink" title="高扩展"></a>高扩展</h4><p>　自动进行横向扩展（毫秒级部署，秒级生命周期）</p>
<h4 id="高资源利用率"><a href="#高资源利用率" class="headerlink" title="高资源利用率"></a>高资源利用率</h4><p>　提供细粒度的计算能力，最大限度满足实时需求，使得资源利用率大幅度提升</p>
<h4 id="NoOps"><a href="#NoOps" class="headerlink" title="NoOps"></a>NoOps</h4><p>　运维的发展经历了，人肉运维、自动化运维、DevOps、AiOps 等。而 Serverless 模式下，用户只需要关心业务编码，真正实现了零运维成本</p>
<div class="note info">从更广泛的意义上来讲，Ops 除了指服务器维护，还会包括部署、网络、安全、监控、故障恢复和水平扩展等</div>

<a id="more"></a>
<h3 id="劣势"><a href="#劣势" class="headerlink" title="劣势"></a>劣势</h3><h4 id="状态管理"><a href="#状态管理" class="headerlink" title="状态管理"></a>状态管理</h4><p>　对于有状态的服务，使用 Serverless 可能会导致灵活性降低。而在借助第三方存储媒介的时候，因为无法使用连接池，也使得创建与释放连接的成本加重</p>
<div class="note info">第三方存储媒介包括数据库、分布式缓存和云盘等</div>

<h4 id="延迟"><a href="#延迟" class="headerlink" title="延迟"></a>延迟</h4><p>　Serverless 应用程序是无状态、分布式、低耦合的，导致很难实现低延迟</p>
<h4 id="资源争用"><a href="#资源争用" class="headerlink" title="资源争用"></a>资源争用</h4><p>　多租户模式下，资源隔离控制不当的话，会导致资源争用，使得某一个任务影响到其他任务的运行</p>
<h4 id="没有统一的规范"><a href="#没有统一的规范" class="headerlink" title="没有统一的规范"></a>没有统一的规范</h4><p>　业内没有形成统一的接口和规范，导致很难跨平台地使用不同云服务厂商的 Serverless 产品</p>
<h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><ul>
<li>价格敏感场景（针对测试阶段 Demo 级别的实例输出）</li>
<li>流式事件处理（视频流、图片流等）</li>
<li>事件驱动架构</li>
<li>响应式架构</li>
<li>IoT 物联网</li>
<li>资源利用率低的业务（大部分时间空闲，只在固定时间触发计算）</li>
<li>流量突发场景（难以预估流量高峰的峰值或时间点）</li>
<li>混合云场景</li>
<li>Edge Computing 边缘计算（将应用部署至 CDN 节点，通过 CDN 触发 Lambda，在网络边缘节点直接完成计算，以提高响应速度）</li>
</ul>
<h2 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h2><h3 id="Serverless-发展路线图"><a href="#Serverless-发展路线图" class="headerlink" title="Serverless 发展路线图"></a>Serverless 发展路线图</h3><pre class="mermaid">gantt

dateFormat YYYY-MM-DD
title Serverless 发展路线图

section 概念提出
《Why The Future Of Software And Apps Is Serverless?》 : done , 首次提出 Serverless 概念 , 2012-10-15 , 2014-11-13

section 产品落地
AWS Lambda 发布 : done , 从概念落地为产品 , 2014-11-13 , 2015-07-09

section 完全构建
AWS API Gateway 发布 : done , AWS Lambda 和 AWS API Gateway 的结合，使得完全构建 Serverless 成为可能 , 2015-07-09 , 2015-10-13

section 成功案例
PlayOnSports 生产级 Serverless 应用 : done , 第一例商业案例大获成功 , 2015-10-13 , 2016-05-25

section 积极布道
举办第一届 Serverless Conf : done , 第一届 Serverless Conf 在纽约成功举办 , 2016-05-25 , 2017-01-01

section 厂商跟风
众多厂商争相入市 : done, IaaS 和 PaaS 厂商跟风，包括 Google Cloud Functions、Azure Funcions、IBM OpenWhis、阿里云函数计算等 , 2017-01-01 , 2018-01-01

section 蓬勃发展
Serverless 借势迅速发展 : active , 去中心化、轻量虚拟化、细粒度计算等技术蓬勃发展 , 2018-01-01 , 2021-01-01</pre>



<h3 id="云计算发展路线图"><a href="#云计算发展路线图" class="headerlink" title="云计算发展路线图"></a>云计算发展路线图</h3><pre class="mermaid">graph TD
start[Start] --&gt; IDC(物理机房)
IDC --&gt; IaaS(基础设施即服务)
IaaS --&gt; PaaS(平台即服务)
PaaS --&gt; SaaS(软件即服务)
SaaS --&gt; Serverless(Serverless)
Serverless --&gt; BaaS(后端即服务)
Serverless --&gt; FaaS(函数即服务)
BaaS --&gt; e[End?]
FaaS --&gt; e[End?]</pre>



<h4 id="IDC"><a href="#IDC" class="headerlink" title="IDC"></a>IDC</h4><p>　物理机房</p>
<h4 id="IaaS"><a href="#IaaS" class="headerlink" title="IaaS"></a>IaaS</h4><h5 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h5><p>　<strong><a href="https://en.wikipedia.org/wiki/Infrastructure_as_a_service">IaaS</a></strong>，全称 <strong>I</strong>nfrastructure <strong>a</strong>s <strong>a</strong> <strong>S</strong>ervice，表示<strong>基础设施即服务</strong>，也有称作 <strong>H</strong>ardware <strong>a</strong>s <strong>a</strong> <strong>S</strong>ervice</p>
<h5 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h5><ul>
<li><p>公有云</p>
<p>公有云是放在公共的互联网上的，只要是平台上的用户都可以使用</p>
</li>
<li><p>私有云</p>
<p>私有云是为某一个客户单独构建，可以最大程度地保证数据安全和服务质量</p>
</li>
<li><p>混合云</p>
<p>混合云融合了公有云和私有云，将重要数据保存在本地私有云环境，同时将非核心数据上传公有云处理</p>
</li>
</ul>
<h5 id="平台"><a href="#平台" class="headerlink" title="平台"></a>平台</h5><ul>
<li><p>国内</p>
<p>阿里云™、知名 IaaS 平台™、青云™、盛大云™、华为云™、太平洋电信™、51IDC™、UCloud™</p>
</li>
<li><p>国外</p>
<p>Amazon AWS（Elastic Compute Cloud）™、Google Compute Engine™、EMC™、IBM™</p>
</li>
</ul>
<h4 id="PaaS"><a href="#PaaS" class="headerlink" title="PaaS"></a>PaaS</h4><h5 id="定义-1"><a href="#定义-1" class="headerlink" title="定义"></a>定义</h5><p>　<strong><a href="https://en.wikipedia.org/wiki/Platform_as_a_service">PaaS</a></strong>，全称 <strong>P</strong>latform <strong>a</strong>s <strong>a</strong> <strong>S</strong>ervice，表示<strong>平台即服务</strong>。用户可以自己部署操作系统和软件</p>
<h5 id="平台-1"><a href="#平台-1" class="headerlink" title="平台"></a>平台</h5><ul>
<li><p>国内</p>
<p>AppCan™、APICloud™、Testin™、Coding™、八百客™、云之讯™、追信魔盒™、机智云™</p>
</li>
<li><p>国外</p>
<p>Google App Engine™、Amazon Elastic Beanstalk™、Microsoft Azure™、VMware Cloud Foundry™</p>
</li>
</ul>
<h4 id="SaaS"><a href="#SaaS" class="headerlink" title="SaaS"></a>SaaS</h4><h5 id="定义-2"><a href="#定义-2" class="headerlink" title="定义"></a>定义</h5><p>　<strong><a href="https://en.wikipedia.org/wiki/Software_as_a_service">SaaS</a></strong>，全称 <strong>S</strong>oftware <strong>a</strong>s <strong>a</strong> <strong>S</strong>ervice，表示<strong>软件即服务</strong>。软件的开发、管理、部署都交给第三方，不需要担心任何技术问题，可以拿来即用。省去技术团队，直接应用云端系统进行运营和使用即可</p>
<h5 id="平台-2"><a href="#平台-2" class="headerlink" title="平台"></a>平台</h5><ul>
<li><p>国内</p>
<p>阿里钉钉™、用友超客™、明道™、今目标™、Tower™、纷享销客™、红圈营销™、小满科技™、腾腾科技™、麦客™、美洽™、销售易™、快消总管™、EC 营客通™、店小三™、逸创云客服™</p>
</li>
<li><p>国外</p>
<p>Salesforce™、Sales cloud™、Zendesk™、Zoho™、IBM Lotus Live™</p>
</li>
</ul>
<h4 id="BaaS"><a href="#BaaS" class="headerlink" title="BaaS"></a>BaaS</h4><h5 id="定义-3"><a href="#定义-3" class="headerlink" title="定义"></a>定义</h5><p>　<strong><a href="https://en.wikipedia.org/wiki/Mobile_backend_as_a_service">BaaS</a></strong>，全称 <strong>B</strong>ackend <strong>a</strong>s <strong>a</strong> <strong>S</strong>ervice，表示<strong>后端即服务</strong>。为客户（开发者）提供整合云后端的服务，例如提供文件存储、数据存储、推送服务、身份验证服务等功能，以帮助开发者快速开发应用</p>
<h4 id="FaaS"><a href="#FaaS" class="headerlink" title="FaaS"></a>FaaS</h4><h5 id="定义-4"><a href="#定义-4" class="headerlink" title="定义"></a>定义</h5><p>　<strong><a href="https://en.wikipedia.org/wiki/Function_as_a_service">FaaS</a></strong>，全称 <strong>F</strong>unction <strong>a</strong>s <strong>a</strong> <strong>S</strong>ervice，表示<strong>函数即服务</strong>。服务商提供一个平台，允许客户开发、运行和管理应用程序功能，而无需构建和维护基础架构。按照此模型构建应用程序是实现“无服务器”体系结构的一种方式，通常在构建微服务应用程序时使用</p>
<h2 id="社区发展"><a href="#社区发展" class="headerlink" title="社区发展"></a>社区发展</h2><h3 id="Star-趋势"><a href="#Star-趋势" class="headerlink" title="Star 趋势"></a>Star 趋势</h3><p><img data-src="/picture/serverless/serverless_star_history.png" alt="Serverless Star History"></p>
<center>（图片来源：<a href="https://star-history.t9t.io/#openfaas/faas&amp;apache/openwhisk&amp;knative/serving" target="_blank">star-history.t9t.io</a>™ 官网）</center>








<h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><h3 id="Wikipedia"><a href="#Wikipedia" class="headerlink" title="Wikipedia"></a>Wikipedia</h3><ul>
<li><a href="https://en.wikipedia.org/wiki/AWS_Lambda">AWS Lambda</a></li>
</ul>
<h3 id="Doc"><a href="#Doc" class="headerlink" title="Doc"></a>Doc</h3><ul>
<li><a href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-releases.html">AWS Lambda releases</a></li>
</ul>
<h3 id="Paper"><a href="#Paper" class="headerlink" title="Paper"></a>Paper</h3><ul>
<li><a href="https://www2.eecs.berkeley.edu/Pubs/TechRpts/2019/EECS-2019-3.pdf">A Berkeley View on Serverless Computing</a></li>
<li><a href="https://arxiv.org/pdf/1812.03651.pdf">Serverless Computing: One Step Forward, Two Steps Back</a></li>
</ul>
<h3 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h3><ul>
<li><a href="https://github.com/apache/openwhisk">Apache OpenWhisk is an open source serverless cloud platform</a></li>
<li><a href="https://github.com/openfaas/faas">OpenFaaS - Serverless Functions Made Simple</a></li>
<li><a href="https://github.com/kubeless/kubeless">Kubeless is a Kubernetes-native serverless framework</a></li>
<li><a href="https://github.com/fission/fission">Fission is a fast serverless framework for Kubernetes</a></li>
<li><a href="https://github.com/Miserlou/Zappa">Zappa makes it super easy to build and deploy server-less, event-driven Python applications on AWS Lambda + API Gateway</a></li>
<li><a href="https://github.com/serverless/serverless">Serverless Framework – Build web, mobile and IoT applications with serverless architectures using AWS Lambda, Azure Functions, Google CloudFunctions &amp; more!</a></li>
</ul>
<h3 id="Blog"><a href="#Blog" class="headerlink" title="Blog"></a>Blog</h3><ul>
<li><a href="https://readwrite.com/2012/10/15/why-the-future-of-software-and-apps-is-serverless/">Why The Future Of Software And Apps Is Serverless</a></li>
<li><a href="https://www.linkedin.com/pulse/serverless-architecture-its-challenges-veselin-pizurica/">Serverless architecture and its challenges</a></li>
<li><a href="https://yq.aliyun.com/roundtable/66569">除了最新的区块链，AI，你知道 Serverless 吗？</a></li>
<li><a href="https://blog.hyprcubd.com/top-7-predictions-for-serverless-databases/">Top 7 Predictions for Serverless Databases</a></li>
</ul>
<h3 id="Video"><a href="#Video" class="headerlink" title="Video"></a>Video</h3><ul>
<li><a href="https://www.youtube.com/watch?v=U8ODkSCJpJU">AWS re:Invent 2015 | (ARC308) The Serverless Company Using AWS Lambda</a></li>
</ul>
<h3 id="Conf"><a href="#Conf" class="headerlink" title="Conf"></a>Conf</h3><ul>
<li><a href="https://serverlessconf.io/">ServerlessConf</a></li>
</ul>
<h3 id="DataBase"><a href="#DataBase" class="headerlink" title="DataBase"></a>DataBase</h3><ul>
<li><a href="https://aws.amazon.com/timestream/">Amazon Timestream: Fast, scalable, serverless time series database</a></li>
<li><a href="https://www.hyprcubd.com/">Hyprcubd: The first serverless time series database designed to dramatically increase your productivity</a></li>
<li><a href="https://serverless.kx.com/">Serverless kdb+</a></li>
<li><a href="https://www.influxdata.com/blog/extending-influxdb-with-serverless-functions/">Extending InfluxDB with Serverless Functions</a></li>
<li><a href="https://kubeless.io/">Prometheus monitoring of functions calls and function latency by default</a></li>
</ul>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt=""></a></td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>Serverless</category>
      </categories>
      <tags>
        <tag>Apache OpenWhisk</tag>
        <tag>Serverless</tag>
        <tag>FaaS</tag>
        <tag>IDC</tag>
        <tag>IaaS</tag>
        <tag>PaaS</tag>
        <tag>SaaS</tag>
        <tag>BaaS</tag>
      </tags>
  </entry>
  <entry>
    <title>Session</title>
    <url>/posts/48905/</url>
    <content><![CDATA[<h2 id="Session-是什么？"><a href="#Session-是什么？" class="headerlink" title="Session 是什么？"></a>Session 是什么？</h2><p>　代表服务器与浏览器之间的一次会话过程，这个过程可以是连续的，也可以是时断时续的。而在 Web 开发语境下，则指一类用来在客户端与服务器之间保持状态的解决方案</p>
<h2 id="多样的存在形式"><a href="#多样的存在形式" class="headerlink" title="多样的存在形式"></a>多样的存在形式</h2><ul>
<li><a href="https://yuzhouwan.com/posts/190413/">Java</a></li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">javax.servlet.http.HttpSession</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><a href="https://yuzhouwan.com/posts/43687/">Python</a></li>
</ul>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line">s = requests.session()</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>PHP</li>
</ul>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line">$_session</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Hibernate</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">org.hibernate <span class="class"><span class="keyword">interface</span> <span class="title">Session</span></span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>WebLogic</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">Weblogic Server session</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>JSP</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">HttpSession</span><br></pre></td></tr></tbody></table></figure>
<a id="more"></a>
<h2 id="为什么要有-Session"><a href="#为什么要有-Session" class="headerlink" title="为什么要有 Session ?"></a>为什么要有 Session ?</h2><p>　HTTP 本身是无状态的，这与 HTTP 协议本身的目的是相符的<br>　当客户每次访问 Web 页面，服务器重新打开新的会话时，为了维护其上下文信息（记住同一个用户）<br>　由于此类种种场景，需要让 HTTP 协议成为有状态的</p>
<h2 id="Session-工作原理"><a href="#Session-工作原理" class="headerlink" title="Session 工作原理"></a>Session 工作原理</h2><p>　Session 机制是一种服务器端的机制，服务器使用一种类似于散列表的结构来保存信息</p>
<p><img data-src="/picture/session/session.png" alt="Session"></p>
<center>（利用 <a href="https://www.wps.com/mac/" target="_blank">WPS</a>™ 绘制而成）</center>



<h2 id="踩过的坑"><a href="#踩过的坑" class="headerlink" title="踩过的坑"></a>踩过的坑</h2><h3 id="Session-的创建"><a href="#Session-的创建" class="headerlink" title="Session 的创建"></a>Session 的创建</h3><p>　不是在客户端访问 Server 的时候就创建，而是在服务器的某个构建 Session 的语句被调用时</p>
<ul>
<li>PHP</li>
</ul>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line">session_start()</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>JSP</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">内置对象 Session</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Java</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">HttpServletRequest.getSession(<span class="keyword">true</span>)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Hibernate</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">new</span> Configuration.configure(<span class="string">"hibernate.cfg.xml"</span>).buildSessionFactory().openSesssion()</span><br></pre></td></tr></tbody></table></figure>
<h3 id="SSO（Single-Sign-on）"><a href="#SSO（Single-Sign-on）" class="headerlink" title="SSO（Single Sign-on）"></a><a href="https://yuzhouwan.com/posts/5517/">SSO</a>（<strong>S</strong>ingle <strong>S</strong>ign-<strong>o</strong>n）</h3><p>　按照 Servlet 规范，Session 的作用域应该仅仅限于当前应用程序下，不同的应用程序之间是不能够相互访问对方的 Session 的<br>　各个应用服务器从实际效果上都遵守了这一规范，但是实现的细节却可能各有不同，因此解决跨应用程序 Session 共享的方法也不尽相同<br>　可以借助于第三方的力量，比如使用文件、数据库、JMS 或者客户端 cookie，URL 参数或者隐藏字段等手段<br>　还有一种较为方便的做法，就是把一个应用程序的 Session 放到 ServletContext 中取得前一个应用程序的引用</p>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt=""></a></td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>后端开发</category>
      </categories>
      <tags>
        <tag>Session</tag>
      </tags>
  </entry>
  <entry>
    <title>Stephen William Hawking</title>
    <url>/posts/54868/</url>
    <content><![CDATA[<p><img data-src="/picture/people/stephen_william_hawking.jpg" alt="Stephen William Hawking"></p>
<p>2018.3.14 他摆脱了躯壳的束缚，终自由地遨游于星辰之间</p>
<a id="more"></a>
]]></content>
      <categories>
        <category>人物</category>
      </categories>
      <tags>
        <tag>人物</tag>
      </tags>
  </entry>
  <entry>
    <title>一门让你觉得离散数据没白学的语言：TLA+</title>
    <url>/posts/200725/</url>
    <content><![CDATA[<div id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">
  <div class="hbe-input-container">
  <input type="password" id="hbePass" placeholder="" />
    <label for="hbePass">Hey, password is required here.</label>
    <div class="bottom-line"></div>
  </div>
  <script id="hbeData" type="hbeData" data-hmacdigest="acc4e93a24eadfd8818269d953644a1075a0c6096166082f1aa209d9ad99ccbc">06d7929d50b05b6d35891c2467a73a99898edff2e833a9ae9018a0560e55d0fa390f9cba52d90f7be18011768cfaa894e1b71a4f1e7e29e4f89c4bd5117b06a96e6f0b221f8d6a7edad7d67b2fd5e2aed0e23dd39c2c279429ff59e66b897bcecb0e263f2e9a58fe08550ee878f2e0529470647b661d2c7b46400ea83c0ff7ee8a9e081342d74fcdeab48dcff2bc585ef4caee53e14388cac2da29f4a9478df9e1f8eefa53cf26a93ccb0990d58e3d67de1cce7725a752b1bd4d6455221cc9d43ca3890c0744c2b00a85a834d8d56fad821dd650c0bd7152cf1e62859292cc37b6c2bbb5f69939a3070cb7b08f066c1c759d78df16f33f1464356917f109b9611970ac5842816141854337af25ab363a1f82cf209653926d2158353b5657e4d05d678dc5203e5cb2bbdb9396abfef62cad8682c347556dee3c75d44336a6dfd77ef8d9e8b527ff07b1649a84caf973360b859322e9d713b23409f9c852ccedfac5e4fc6ccee6cd2aba83a42023050e48a32e04f0b5d4d8e7cc4e87282f637fb4df6ebe9e6d123cf5e13ec09a9cfd67622baf0ce8902e46ca7739818cd6e01ceb0be2c7ad521d2c383958a1bbf41583fbea54ffd4358564cc29d46bc286e03801a5ca25b97c9d2053ee67665b6a67b0818c3bc61dfa954ef96e41b3390cde2d86fd0ef05ed24eb27eff785b47c1ba978ed30ef395844ac523bb7539855c48815e7e74daf1744cedc7f2b7dca689a3c6bef56d140042cf4d907c0c9a2baba78abfb0f8903d6a02b09748411976992b3af8776ef794f06093fbe943a9a944dcfaa18db6cf7e250d004cacf7039362a6bba29549035b4bfd8a0b78167690b31e47c4d412aab7e86560b2a443a0377b3ff0d5de19492d0a01cfaacad4a938fbdf9aca394d0be057733416d526408afd9b18fe767254acc6c2d2e2294589e78f8bad28f99e2c590a3ee80c51a0ed27cd345b72ac58d52360b6f9ef1dbfd9c8ee829d2d8218a92bd95e6ae4181613e3a00fa05c4eacf8addfafa45fefc993f801dc5ba1ef2030c8170bcf5763c50af8922be58f636a0c0de415eed10dbbf811d4b100d4f096093f496023a6e1181b3927fb9711b72fea113c87ac5936484fb22b6f0a646a5c46a0d50cd8d72360d310e69bb50a6202caad682cdf1afe000127007cad333b4931d9d992c58ef35a6f32145d73943b1fadb033ce96a6bb575002861adb93db5d91872e65fd50be99da5d650967d961da4d839460dca0181a595d35ad20e008522fa6e6b107351c56e363d1bff44d74aaae9f30c780eedf1db3b362d90a3824b23df03771c3758fc345a21880c7f497e1058e15b420ea1fa5b2bc48f3dcd1fc1ccbeb2b289f96f9fa52b5ffd08d0eef501fc3a6bc37965e1faa329bc57f1a65df1f7a259fbc8ca33c078738e3064ef3fe0472eaf85b100470c8fcc47f874e4b032c7ffa4c57dc2682e6b55bebb91b4f34afc2c6f3f391d52b6ffcba67e63e66859b87886bbe0a012545e502a9ef6d9d2df46dafd15295b36fc6b5c6c550483f61c7fbb8c6f20b510f3fabe0a4185242b9da16d1506cc9f81f3527c67e3b167038496b276f196b346ec3ef6845a4d0c313e223daa379c8b009d607fa18a494f395b1b522a328bd8e8a6ab15e0338f3b44e531bfc685c7b44e8e1791d5a294ff60e5d53c35d7a37d30d00f48311f2d7b6b04d4fcbf7f6ade06a5e80537c080e922314a3a0ab11a1da4f2442172d7f41acc47b66aa7457b84b3a8e83a31f4668240b357cd1a9dd6fbc65640481d27cfa870a3a44de08c7723d7cca016c60926ddc8679fc107a4796bbbe94a4d751a9a05428d8766df581acd5fe6682e57e9156ec226d3e583896db6e2e02baa1d0f1145dff09b352f92cb89da8e96f35a7082f44d01757af366734d74819f0962701b43e7c39314fc98410b4f5917ea60ba6f9a1bfe5a7ae885989e5680d3e369c5836a9f33075e4d042ced77909a5736bf87405cbc9c0b0fd8ec8df88f6817e2cc7208f22c8861f28c98a2537c1d28624fd7b6dec611be3892e7423c5f14d2092b11410e6d4611f63217ddfd882014e56ac93a3574cc5888ac711f931a6d3b87817ec562f4052395040486cf17f1bf05812fe5f5f0bceb5f7965e02bee1b1deb40af535d1e5504dc2d3a65746c459595a0b0d6bc26843936b272719f40d061d77f9c83b614a2d6151c04f5ce21bfd12a43d67f98c00c0ec7868660bdadcf76cbeed286d84a177337f871440bd005b34aaf00b9737b4353cdfab1d4fbccd290b5a581861244f46139ca8c9d11dbf35541d85d8a68b7067012862806e98bfea304d8d15d6a08a81cc256676dc4ae39f684f712483cbcdc74fa589b22832db386830aa14112df641d3d0514241b2d4657e792e3ef0be0d9a68f367739224dcf82bad4e01a2a6a30dc0272c8e1a8de2f0e25d40da3f50eda8574717227abf94d88943efd0ce52214b5aeb4879a930615f94c2487cb045cf29bb9268f6730a838243a832cb2751d6c8cecd630b406fd6be17ca51b718da7d58c92f900c7b922030af4b62d8bd97ee6a3056834eef28eddc81308b2781dce498a24c5490c0d85d995fbb05de9073440f556537e4fcfb57701c18618441199f0a8ca50d95a93d3f61c048772eb1b3123a5c3138c8b4e7602fdb8f171eb3bf426d98cc08989b13d0533317273c7b9ca7648d85dc4dd4349c06b30045fa1360e33bc426531c7d7f534ec4aa2398e2de08747c885b1f8033a35d45946644547a221cf464842d228bf520505495d4ae5b0a7f04c634715c7053359bca84a93ca14b44cc5d22e7256c8b8dd19839f9d068f2e2b135f92f8997e94e597a2d1f307f51df8d663ff3e4dfc5810a4f3cd7ab488c936965034a010fa32e0fec83a5039605e448abbed7a29fffcd7574d08249ad8dc6f40534842184679acd4e0e6b92202051387de1dcca7534e2ec8775365767e8ab84ca94f93f86d9c2a9051f68a85874078043f6b7c85b20730d6b53f02bb03959776e11fa41e0c6d778a9a2766e1169cc658b89ea97fd1ec86afd967b44a1eb4a9c0dee831207a6e4b87810d4ecd4f8dc975500c83129a7203fb6293f952df0567115bca8037b573b40def5050a1343959b2fa397bdf2cb89c0ffe51da570c168d0408ce0c615c47621389a41fd336c2daa56ae245b02f855f70cd6ca4e25682a6fb53f14c6cd3c2c6ad2c8f70727ab0ccd40197af96fce96547f970e533d7d3ac41af575717a1b18c5bf553b0a92586b8e5d80a65d4dbe4c8c259ad68056b5be04061f79f9c94a07fee8771ca93c5ff26ec0ec35f0a1ed2cda98e04cce244eb0add50b95e1a01cbb87e9fb99ec19693239cb7bc0e6f31f99e966cd1c28eb825defd20ced64a288d37ec8182e03392e8dd6173fd9e09a93b954878ce133d0c9075f2b476935a5bd9191600b58d3c2bcc2ddcce63216270992697b8fce2b1e64a2250e2fdb23916b8d33b86c1d1126292ade3df306b0726725ba2b47692b24dc834b2552e3a7547c4965873c06babafbdc25403bb23447956e699c5b7b53379e79c2834e8f26fc86b2d5e23f0592bc7dd8e6c15fcf943b809b2779b54baf6971f02d0b7db0e3a3a3e37e9ca81a86a1073c67e7063c7923a12d57ef7e29627514d1d8a499480301276fc8551e323057d869ce1212c2d1ae4e18b7c80defe29d6cdf071c099cb67cde087138578f1d5726a1dbe9c045bc913a5a6c41406224859801ab2125538efd78e4b22652a3ae963aee8a035548144945d7b6f46834d0aa49b49354761806a613c817778b4bf7dbfb00e53065fbbc67cb84191a74db34b35db717e32d032fd6f98ceac6b47a0cd4d60d340a84aaea92af727e2b45860b4979a2aebd397d5d885348a88b609abeded44c2907b77ccc4de24e7d3ed71e9c0711cad53b23c5e508ab26be0c1e9f9723452bffbbb2557370a7e53896856fa09ca3c7c5329b6268887e35e6dba86ab1bcb77a83f5972735f4352a5a72055e6ab3a3735fba8bf4b269b4f4178995f2dbc0bd5be5f04474f5b4763925b8faaa474ea591753f16068792b43f04d260027b2826d7e8fbcf546bbddf61cdf8826459b135da5032e6dfef044b8f512342a6402059dba899e14fcdbcf686b6c4b2956da30f80cad0e7026370fd38a146bec93560b69c030ece2d2d3a40b79aa2c5027b8d370710bce7fde897a3136498cdb4c6d8a93c48f1caa5c144739b8f24c17bf4550962f0eada50a8bce561300ab0b78ae8129e4cad41f4feadb7f4e9813141b3240eeff2804daf6be5393b515779aff1c562729432d09ba5b7819e6043a35d02f4b608ae3e7393962236fe104a19cbf052a06218537d3232b5f2adc38b22b61ac8b5792bc86916a422c66c7e11e0ba5499e778829135b30eb9b2a814ebe991b14df597a2e6053cf3463efc9fe8c572f43c969122a9e62fd4dee0cefcfc192b34d849c16542d990409f472f06f12bc0f6c5600ce61033c2fb221fe89f4a2fbcf4d1027e89bf5c1e0925635cab99049401bad26501726b0eb6c98b88c4b03144e4f03b0ecfe6b937944b0ceed392a195f230fca00860664a30bd3efe9c42fd9afa740f50cb1d9024158ad83359c7225961b3786193a79a5280b2c8f91d6ef843cf4fe8d28343c305db4d2b3532684cbe9a3d07cdc4ee39a843405b693533d38e3b59dd03eecac783b52240f757e854812114e99474db9917ad42b9f57b23ee81e228ff2239842952c9717eb1e715ffbff2af82167ef63214ac409474f5b104cf352fe3191aaca25f57da34c45f700a34bee809fddf411f9d10706413792b0e5d612c7721a8c5e2d3e9be5e1561cb714e9fc927edd12f653a427fe7d2024653beefc948dac0e0ca3c12425fd0a684ad1608290ad641c78fbac739625e15dbdeba032e0b30abb93971e01a0426a3ae6684e788237892dbf5f8c77bc0762945afccf8fe9fe6438b98a7a38bc40beea3f459ac340eed1f79de3e78c0a7747b4c91607228cb45eddac29448318e80a72261c2732fcc1e60f8ad1e63705d4868875a3a5df0d4156ed075679d46adf7b0a04a3bc4da17ed08dbf17e4326f4bae2dea6c43af169ee8a4b8f8aaee2f85d52e1f92e9078f55408c9f9b6baf808a900922820963204c80d278e9b8b8f23e2b0f43b2c2c771345f4c8b931772380553712232b454c65eb83ca5731a5871d9086f4dbbd99cd6c3c9d7657761b136d72540882415e53f440855271970c349e1734523f0954e5b2e7ef8cc0693e456a5b8ade91e8284b0cca729b79b329b3780141ec8ddf9026b029e3db6249cf85e00f2898d0f8c9f5534c91b02e080689a38798a7cfef95a1caca5eed9b28106d5042932e84438ebbf8ec02233b02733cf852f8ea5b9d8f256e14ab505efb2a3b1607c654c09d2c8eec699fbae569bf90e0291127404ba310c64f8dc397cbeaeb7dfefed48ab134599fdbd5ad4b100513a2daf164f9bebb5290a2359fde4828eaf24feeaa90ec9ea1b0d63944c74d612bcd0acb990df528267170e064d237f4b833d5bb605221be5434ed051904ac46f0f4046ae7f4aa1d83a0aa9b8ef4f883e3ca75de85a0b2f5812aa83e4b833b0c4daf717341ddd92112831fe0d5a2e3d7a1ec3c287d8db55c40939a4fea034511b51e090c993f90e2bfc3b1de435efa4a35cc9bc307ab6e3bc8ad1d99660085dabaeb1e7afe252ad4ab4136d1d06e7387713a46cf0e7555e835cece5a9ae58ec657f840fcab7f7ef7764f84eddd1c071d5184d3324b5f032c14a78c3d1bc963a091de56e0affdb7703c915f76c498e4262245a7d68e1bdf8460ef42b3fe621a6031c8a622ad7dac11047f3876c46e9d2d44c0c983f70de7aebd27a44fb4dbc74f59e27a34015683c98e99187e8190a3ba133323b9764f65de8827d67edd00513e91e680ec704bde88a8dc44db7ca13867dfe58baf8670a242dc610c42fefbee7059636e0bdc65509b89fc98a031c03cbd576c3344ad374f8f0aad552ada4d3e25faa9ae1a4a2f2c3149c6362130ed9bb7d05bafd9875941b7e353ac9cda1d6487a1aa2fbbe9214a9df3dcdf5d7399e877c81bbf1f0f76a988339fcf01c7fd5a3b86457a3496eae2b302660cfa33b1cb1f4917080e8e5909676e207a8a920772370591e34e85996f2d2379206cc6c5f59bafe01fa6b3323b27f5e8a3baa0988241fcc714052259e0f46fde15a3db8b3ac36779a3d2c6c4b6a429bf7f24f877cfa74cbc5a71c29b786e6e78d96b4fa1298aa7502f40f152eed38d443d6796d97013a5a924e6cf922c08a807594b67de3861e93478fbd1608ed5eaa23b2670ec3eaf31e3d70b188b4356d5947f3f23337443f6f18888774f4671254af68d001bd3adf6feb088aeb23af5814cd0e445fb2d90120a794964e6af35a0a9b43e9ff10cbeaf74a3992c6a57e79b570f7b36782a3c63a93d261d178e442ba6954454a74932f5b53bd739a9c2586d0a54b9f1293e999a71450e07a613817e199c8a3f4ed779b2344896a1577ef39e97a35eb2ddb2ea34d0a015b0c848140a78221849185425feed8b125885177e6e869171cfa1469e9d494ad94a5243c138f824816ae30e532d6c88311c7f7206058ef0c4856f11eb77c71bbbd4e3377f94969b95d5d112fc38c8cb917f87fa3f46280053ef94fd716154c5f21cbbbed91334a8d22c1e15b5ccef570a244914cf331184d7631554b81c8207264da040a2a6f9e80639f4ef75badecd2e6e576956d12c88478108deca49c0b43fed953e43e15dcd96c0d8afa3098fbe32c94752b0a5d6a5f44b587992695ddf55046613053554c45d706dd85cdc3536ef95435b227a72723ed8d1a926c999322ff864ac9478b3e7aadeadfd39e675638e814f3a676abdd3989911571627e0afc75618750ef4b91cb1e57559565ae4361b9bdd01631dc7b21c9e5af69cf0e97bc86e17800f5161e3ef4b574368b31f86e9e415cfb121d5d022e7cbe151f6e19506a1f5f50d0a6943474e9a4f803fa8a6310361fdd10a5680882e380402b7fe56a7363bad745739d802ff1567cf7cab39ed7b212233a588f2946792e6b1f884b03434e7610a64ce262b5a662c1ca2c95bf54b16bde067c0e36b3a28fa8c15200636b592bd72320914a235d27c6a8f3e97678f697c7cfceff1059512ab127e8bd76642cc5b3b8dddd983d6d04142effd9916ee701303f962e7530f2caa4ee52d7fbcb18332f03e0c840e1214b55c9753e42b8a44afc7f122eafd5351a936d71bc7bad1f4cab1110d9a7175528ae5ee91d5b12f7120c0caa3ef0bf3203793ca4b0e85ed217f8ecdadba5e12dad56212aca311c3dd60efb3b2700d83838ccad210b47e1fc744f6c9318e82bd25b6a3f75017f0abb0d457b7f9e21f34cd86dacde7e88381d5c0787e15a6fdd0834eefce837d2e6f96059bc496f496ea7bbf8376249bae2322560bdc4bc27ac0f03b512684cb93ebe3d307ee32ccc660b1fa1c3d581197374e47e60a6c3baa1c0e950392fd89927e0ac9873b62dcc02c211974fdca19f7dd1a10ae483b63ae7165de2b4c69dc3567f38b9e8a5dc85605a1740b955efcde04cc67be2ad9febc59e668e9641cc1cc9cca30de0bfc72aa382fee7900f5f2fd43d58e7154e0cea580d342b5b1d5be4965b788afd13a25bbac9b9244c2c2e97504b8a8a28acf32604b1d763b0e28caa97099ccf9e3d4bfcb8682266b15cb37caa7462781ff06896e3806ce3b6e3e72c06a12843747bd90db7052d5c51002ac06fad23ae316565d7e5adb3c44a6b052f941f36c4153c3de14db3ccc1c54bb0c88dc8c1099f04cf3a46d5493318ac4f88c379f3278525e828ce44b2cc61d8ca1590626e006fb2ab34df400193bf7760ca02c1b9a973f9acf6f0ee6a6bb808b11f25f814a947d5e945c12b191f2c3fba01883fd2a495590ee953d2582447ed75eb19e55256c8a67f995b21aa4d296af77f81effcac027586772ac8b69e5b2fc62b9f0a1257fe3e04b213b31bdb71c7c457e4ec49e1a897263122122f382a6f113830c74598f93f3fbe42996916cc2b619c5733fab7150ead6a79636f65410f2a1efc5d1569fd036fb2d69f1fb381355ffc266de7adef6d0038067c3e234c1abbca198779499bb8d182e03e597fa0a89797259bb64df951b5bc8e84d60fe0a613d9c8a7ee00ece804af6c0e5d3675c0cf7e78d58042d85e067e45d68d734fc0f991fe1d438cd9d24a01d9c0f6a1751bca1125eb9befac575ed5a48124b8e15684759aec1a919aac12113157ff3d0ddac18b16fe35e7c1d47b0ce3f2a90e5b8a6fea7f247d5ce7986b0e554001f59529709365715cc3e6476c04eda551d5bfeb82e78ecc38fccd54ee72e40a8a55aeec87684bf62f2d5087eb0b919d3ac4cda369536dcce48add48d65af577d7b007c666f26caa1232040bee4cd6807ef28137499e1ebb9f2e9230aeb24a99807c30efccd4af15faa6023c30245d6a856e21d22e496aab8fa629435bdd9dd00b170fbabb4b115079562ecdb053f775c8002e166383cdcf84b4dad54555df6ee1b5445ca6eabde6f0fc12d4428bd619d5789e991438f203380570c07b33860d939346e1adc8a1cb6cecf10b763782fc54acb57da5065949579280825a340fab499e0c883e7ccbd8378fcf6ef50ed996c0243742cf12b6e71915b945d35a80fdaaab1dc62ae223e2146d79e0502b1e332f9fd013f941bcdee3157d5c3c844448997c82bfacd5fd006c90b8433f74b09474dbf54f10453ce6c3f1d0f3481b32d1e8f29e27e62168e3aa91046c77c47269775a28cb7fa3ead58669982f8820dfcba5332235a69a6b0889dad519a8238fb2b2ea74b98bf66a8ae9e17060863250dff76019c5af24a529337a8a87f080a17895132f419ceb7c9227070c6c0a6e1f2523cfe134dc70bf9a3acca14e95e0ca70644d9250f1e0d8250ebc63c5aff715a272b5e984fc65153322f639f49552393d868bc300b015b1515f51b523d2525cca5287eaf914530f6d4767a23e7fa07fcf0fae48897646b2b717a2ce9afd68ff66b6d47ab694d6c8850400a51754b4f682da9f1bcd463c5f7934d69277a85acf563166819dfc204ecc80b2a93888124095dfb20589a042c212346517ff47399bf9990efeb4ae0cd7729f84aeee7b271a9653bb07a96356c667c5bc13a394a624727843c42410f2a13a9196209823d90dc19c030537137b152185269b9e13f6d2be19df0cd844a7168e013bafcde7f2461d570184ced943b9c51fe2bf24797e73f0df910f6eec9c230b1ed5c8cc24a484044c274331ea7387e8c4999f043c1216871b7430ace4ad2e6f4345d850bf8efb73fe392f929b4f644ff3451f066599f686f49a7ae196749b4161d0e38b180448818b8e036000ef81f5863480186c9095a234d9c4374211467b153240614d05091089181b65745912e0488811cc31fd465567b1d892cc0d6d31f5fa5163b5398d6612e58308449c0faab7bd7e62240f274103c3fa9502b9d6ff40497425160bfdb00ce8d31f4b134396f456a376a54c99459cf4032e168b2f9a15d199fec057f21b616526739ed69a412ece88b90b15833dc902cae629eadf1eb6dae5c8bd1893a8cdf31095d862633daf42a929c9ac8f6e56d66662811d3b61e5e136458155129ac01635cfda8338953f58ad60a6efb983c6a7ca3be58f4886e13f7d4b978d507db2c04561f12795b2f67e1400836ba2c85cb886585bd4d2d932470c22f4b59eb6e4e221f6d3d5fd8476f443c564cf0c670f995d9648db56ce9f794bef48be760aa472c12da0efe2f7034f895a1990b9f7f1250de81411a7b1b97442f22148827f9975a4a00726560b6c86e208764f1f8b777ea9a8ee6a1beadbed52991b7e52f58572644b80b787597538e3eefd1b5450bd428f0024d3712c69ee21e98ae76d7650b6c3cc8e37f613f157ba4a2b0c84dcc3a446ccf9f706d9514d3d8df10001b80c7331338e2016d55953fe0dcd027187f846568f00785f2258ae33a4665314e55bfc8c2e982f9d339b6272f6f2ae320cd4ef33e51c7d964f4dadae017764f98b02514d10e5b179c059f6a89f53138e43a8e6e675579b96c4653ea76498be61118732aae5ef577f6c1050dd1778802f06a3fe5e902bb4cbdb42b123e2d9e17f0680c85121176c83a8ae79236f7bc66aa8b8af30e0e2ba406f7d54dcae0dbc5e34bdaf6353e0156b5cb9ddb6633ea065edd4990ed9b5650f20be3b745ed25932bcc615659de57f9c8d0f0f096db32282884972933a5e933af531ac36ae3212400dae47a174c2d5fe81844d6a0c5d813ce0b86f0f96dac9d0c8166231929169354d70a16690d3e33f12d36c1559583b357ad4fea47690edb019895bfed913dcb99055d25d4702b15db10b2f1d2d2b35ab86f28bbcf60fc37001441a5d0e057685c17ca459289f41d77dc84b49c4f09d4e3332c9662db7ff3cdf9cdfe2a586be0640620e62e74dc1015caedb9efba25335545752f2e86ee1dadae52ebc20f06ebf600ba85fcae00c9fec33cd14b51337205752d44c201f8b8dc1978a2134661cf0c962c0e903853f2d6bb7a55f8dca5a118d59931faeebd65fd281b0bc4669bbf49395c6e3c520b61418f7f8b69ec782b87a18c7ade6e0a550c9e06bbf13bdc758bc1ae54b48c8e6e861eaab0c976c6a57a71e54edf06c642798856b989832030fb607ea0ecbfe6802b2265490f5d46ace93d8350dc7d5a564d2adc1b06731eed03f15f308b933aed94788fe49a241ad0e7fc038f0b97002c9aa5699e4de837fe08dfc9f074fca337ac06613ef49800db6e034b02e3618c6badad910fbefdafc9a80e9bf2b2cbe2b57571581ea8cbb9c83034dfe227145e3806138e7e3bcfa86f20ecaa454ff405ada425c9c6a9c2228815fb60edaac05d9de7df264e99754fada0b81ba4f28e39219f56026053d4650bac1d162e915f756d55bb83c308891948da60495c8dfe1655a23009aad26c0276bc7f824209305fb32fb1c6f2ef06e903d77ca6c77061a1dae0414ee307346ebd8d05e01aead76a969c4cab483ff160ed1c9f264011b66e70558489a21ad9863133c13983c2e059da35393cc041aeba34945d5815053c344cf5a9031059ead6549206f4c7acfd0f3933d8c88c91ec0f11b86dc61bdf33142cfd43b616338915e6e75b5697ba0a670eda5926fd272837241854f28ba987cea4e96cbfe97331da328ce674939e91bc832c9e29227ee761cc4a167ab0adecbe26679f788c2f339be62d02a78e1bbec657330f5afd757d6e1695150a85f712e4ceff4897d4f85a86cb2889179dfb30eba641f8777c0a4d0ff26c6725063bf54b4c42b81c9f8684a65ca22fe25a487d8b5fb0bcd4f3fb8045d8b172dd4e1f7d52ee91489dc5f7385d63489bf69d5b18b55f6396ad57888877d70b3e876e8e54c5fc7a5f342276c8005f2ef3a5c63c62fb8e317bff41154e9d237c2dd21fc7225c9157e6ce9f3ed6d6733d8980235ce601cd399353bcc8bcdca077b342ee689d2b15e066a776f58214545032712083750fb8f005527883b399a071148c5d4d7e2aab73b0342b720606e3397802e1ec4a5bc657e6bf8d2a5f62dad6bd0ac7139a379b49cd2195a4086a0bb92dc3cd1b6bb5bd192a99a0b15f80fac1e3ffea32152b2458fa71a388efa57303926ec1a64897d38f989f97b2f1cf4c14e0da0cb42113e8cd38db0a76c1c112aff05cd6ce6442c050c247d465bdf7a67068aee26da516d3f5184e10e9699f0642da707bc8785105c7b52a201c3ef8a8fb4b9bd452201ef863efebf849199ad4564a0da302f7a838188505731081da86bae357eb3e63f3c114bb67c0f48b8f04c50b56464fd1b15675e7d0bd6e71c546872de679f0db97806f3be9585cce5f340555085d507307b80f8600f3ee95fe1a84f59173facbf63f493d4292eb57caf3bf961e225a77f8d3c2c52211c676f5f29399260e3b3b87e9ee84c606b1d8fdb7c1548b0ce1f9d4549baf9268762bdd19b81848c4b87a1d9d20887743377ff24b59ce0fb50170d86e5c02bf5f3dd427c8d53dbb57a3b0625a4eddfa3c76932d3be486c5d9f51afe76fbd4af943acb2a86044cde21003e4ed683b287b90848d0ea8c779581371dd99e859b2060c359769413ea4919ac1a298490a1a5748e68db862eb2b2c122be62329ab2fdaa1305b3d57caafd08feb1f8c9c3b27baa6050054012f09ea965a3b9ca6673306534fcb4165abb4c8427f8a3f1512aa56e05e93988b58d7644dd20426849279393c90202c6b04c30f2b4efa4c0b9e7ee1d13afe2d9596d3f3c44510f287304cb8776db8fa2c83b867ed68375a8c078b56f7d5d731a12709c8fb53932a6d5dced43ce16efc47171e262e7a7c3bcb7dbbf1f8e7e0c9652456be74609174efc6d78d179bb61c73e1353e9b3a3ea556165e45d42bf169420c42a7a74828f12a3cb7bb496322ff5aef924aed06ad053b64995708e5aa00f756f91c55d1c50d97aec6da96ff210da5e508236f91e050ab6657db6268795bfb09e4f95a047153477860aa07a4660b5780dafd108f13ad4f294948704f01b0453009929c2cd7be6ae575c46010fb38ba3b0804eca6aa019bbb69450c0ad65e75b5776ad095adfa3487ef41dfa3d01d4ae636fb316c4706a90f9feb0dfd249b8eef91af2f63adac1c9c1c99243fbb791cb2c285a52da9cf5ee012365c348308e52d05ed8a859da45f6c1abb6090e17c242c99dc5f8945c16bfb36ae1526f310004c15f2ca871fadc77b812664cc28e7161f92c8670cf2119fb4c3057ca28257c2ab07f6aa43620e724978da73c05fa272e210d864aa1618915e196f2a01e1b7851a2422c3f9dc9ebeadaab8aaeebdcc40cdb704b60d2e0a31b8cc8aa1c99f7e8156e8f6197bda185f3ef7c057f034850fc0fca9346d63f5ff6e2861c879d1995afe58ab53642b96e0ecdb15550390bb24a32bd25a9cded6e0ff750ef01a2bbe648a5436fceb08bd792d837b178c1cf140a773f6ca43851f01ab5ae586c141399d586edd067bcee49cce6c33cd5904afd4212b1b0093636dfa19445a2b153f5074434b5bb57b6d1230acc97e5d5d4276ea5069fd596b8423c46dddcbe2844279aba8333a01aae51547c703b7bd852f411890fa4147a4ef6e9a7be02cbe54b566b9b9b6eb1c6ca0313e3205385611a75eb8886d27d07e9785a36e1ddb041d77e83e3c4afd6495480a2d45147f8afa846e83bbaa14f94bf07d9671a0e792d48f302ef30173d9e6f6198f1be968d8da9f0c6945c3c31d5e2960f3744a8ceac51e9bc2e3be5469e298e926814e95b6ff0e557d4fbc2a3a7de53ddb2e91898463ccba84349580388761ced7e778185af4927646a529c7499bc0e6f597a8f73fcd441174bc3389f3003cd73ecf701b7effd0de05d463bd3a60475a3cb3905c291feb4dcb84a3370a1b59f151e0a4dcbb8b7c3d8952293a7d097fdac2b51dcba329b4fffe91749e7a1e5b6aac624a5cc5bcd58d7094007018ff620a8920c61578f93d07b4d3aa11489287ebce74f15311a5027dc99594179bff570c8bf1545602f14556250f8ec3ebb931b938728942e4892f3e4cd40498dccc68f96e5983f371c09547806fd8b39505be5ce3bb2ae45a2e1fb8a2cd67101637e33d00840da5b1c59e6739fb9f60dd6d5ef4e06d9bd611356c9ff980f644bae0953ac01ae28e6fe01af02cb9969aac1f956b782746e2ca071e233fe665296ad8c2cad82f251fa23945fbb3d087384f44b23dacacedba4fc93f1c5e02d0dad355b58b23bb4ec575cca294cccd8557407d87d475743b369aec2bf8adbff21ef95d5a86d50d0eea7fcbb76016c89236bc2a7ea06fc972696c411d50d72e6c1068f39f1250ed89166a05cf43d640b7729ebf00f1ebbfb12ddf98d37fcddcb449d39c5696838dccd5f4ea63728e0b7808c005822d3da760d549dbcc0fc562eb11b1c170a7862320337402295797e86614e28e3f1e5325eda0f61ce2a324cc56e159f7a3c720e961c6addf17c9d71192cd1c695aa088add649af9fff1334c0a155db6e3966a23578306a5d546231f11cd495ebd1568ffc5e4a63b1f94e22b2ef710bb75ad5ec017788d7fa2d7069cc4c1b2430d6815b478539e6ec5cc9d1c738e9ec013c1da6d042da9cfcec9e21c4cca39c5f717fb61fbf18450e53ed08fcb74400561ec42ab5c17a4ba38c9744a2c72c570b84864ef6b011e2a308c9c3333a071175b1986a5735a4a7249292bcf7ca5d3947af33ae33cda9aa8f9ac82daf629c5ae68fcb5ee90f4762fd2d54673d59060ff50518bc81dffac9225fea5b4af2d575d4ec6c93f7d8b3bcf72e9cc2582d77e768efadc8b464bfdb12ee193f23c046868c25934442c61d141333d572c8c85fd1c39cb36625549f339f95d47b4dd13f22c01c0e3542293501e7a2b06749e662259ffb413c9fa2c2a46b0a87201295933a4e8c490a6d4c4dd97eb540d71d60a70543674844de13f07cef80069293e8435b22b180aa4f45ac96d48e24146121b0c30f208ff7561449cf87fe1a70891d0e18e577ccacf35040534796afb0d81a4b904a8de33a0accdb5d12ada037dfe454ca995a12ff4e842a07e336d73dff3f8a45acd5584237899d2a8782cba613bb33bcefbf1d50605f836891644d3240dfb8e14094aa1a915274e3e6a28f4988fad7536868023b13b4c0f0c3c5d16b317f555dbdbe243be0e241428d8d5cb6dac567cb38cfdca0c5de0e1e4e606a8e325df0d98b03ec3b6827d58b24af3f7c2be95f7791448d8f69f53935dcbe31477b1ec90a4f3cf4a3ec6f38e9a423d767a72e438b84491c9a4ff9b8637ef9f524a1812ec51f9cd7c2533c6bbb703e11e29232f237ec8491ea5c9e9b5d1cc7b029944498aa727d16e50fd173841e7194bb53b6d93df217aa027f555e23ce20c0a36bf6e83006a71096c74d920ff9d8823680645e7a589db2e85bd6baf026b8b024af58296284cd86830ca3fa97f120714089b46909e9868ce8ecb50d7b13bcbfd69c683ffe616c7b1c05c549eb01f7947e3fef433b6644a90b49328158a7a48f152f3c71b5c06d769147786388eae83054611629acb87f013e1a5d21d0653b5849663ac36e589b5e78f5507b1e6c850c1067bb5a4d4bf7fbacc33c8323a6c307f19ac90e774820e375dc2cdeb9fa65afd059a22dd91364f58ebb6b7434e6b469d8d87dcde1bc0e8ff99a2297713d4a578c2952237c5622ea68ec7d8cc3641a6fc0267d9756609778c4f43c1ec9a3cd0a34dd9fb2760d406e52ec04bda94043e1ba0c2acd799bc26b65a2ba001459179bf8199eb6a5deb8edd8efc4a978d38077b3f736c970d451be8a3f453cbaec53162c7d855b66294725ddbc1262c385c8c26a73727b4933f38aac49f3f8cfda26206c6312b96368f02bc3392a0ae5c5f8c141b74a85e93199cd90c91d21f6de3da5c3b66ec964dba86bfdd51d9e17a9d5dda4db5bf68cee3c40298c97660a8afba73ca6d999fd25804f350fb2c77357093246b832d75477334994e41ce177cc08de1f9dc8ad6700c7f13e1b0d9b91f134b9ee34189f57e3ffd7c04c981ce5059f3462401cd6dd44b2b38ac93150ad4b7ffc6a32328e4a98d67b1677b3faa416dfeb3c6372c25bdf6243df3b4a687538ad674a75510cd4125488fe549e70148314dc2e872cebd2a4dbda132dec818708448edbe1bcb2ef72e0d02ed336e24dd2ce9f83acd13933f6aa268549303330b79746afa6829089c6e7d1b1a76ca05d9a03e5efc149c59ba812895a0fb2710d38fc322233242622815bf4f1b2af90c5434e2e9f13cbfadc1d2e7bd5b64004aa907b91b9bda616786972258f18ecd41945bc401be61f3c12718fbdaa7941eb31e4aa70ce2c6f1f66c79c434abe132140fae3e5fedb0e7128eebb2a8aaf59f797f07d093d76234d1fc06156e6115a28eb4f613459f4ff29fb4bf98a1b9325246b3516ee63814cfd7e1b62348c62e8792e1223f8ac7b09d4605028c693d8f774254645a1983663e1bc0583067b0efabe19913f3c76c19b146a7c7cf3234909b4abb2aa73715099bd3ba2f68d0eb7a1d7af38466df55055a5953763de49a6de660cb7bba76f61d5c646eb43d8c47af61006866e53ee6156e6df50700632c0a68de13d5dfea7352e939302c77b1375e556deede47befed295c9f8722fa98af118b23d0baf1fb84a85d8f29281fdc18353b407d8ea1ec2c96108a06e265b05e2f1c5ec7f3417d32579fe8e8ae92bbf66b303bd5b9d4aed3d4b6554e7f17a3470fc37f60d6a68a8ff758768958c3b02d34b00d13bef6726c1b4710cf3b2f74430167f234f751aaf921bf50432b7c40dee73620657e65b70769f8cf63c5a4c3643f3eedb0eef31a679efe61787f7f952c3b0a29cb7cbbc996c2931957c008c30c07cc6707c41b0242305458db212169300e7ebc712d6b6d363712c5a1a0a343da9eaa48a0e2a00452dbf5269fcbbb757eb649bb5720ff316f463b3be773b69b49c429ec83999ca537a2e153ff35a53f528b1f7ef32773b6a42d8245f9730ef5b027b99086365323dac8040bf3f0a26310f98e69928f5c67112cb397fa25dbd6d48124c7b172ea45baa187e87f6d4c3a4f0fbba31b3f5a18b6c01f59e44249ac7d24e82df1c16bb202dc0222ef96cbacfd91563ef749de27b4efa4f9aba21943db02d00a0295f265401d69451fd0f9e50d9ca753624521ef211554e3b270b8765ffc71188f791f4b251f6b8289d975ccb8c1737b6585335a056ca470f6789684ff532820bc140b8574912661e9d800de7f482716f5b57d358c75dc3aaaba25c3292273852ee327e211a0361b5dd2d2122545f21a1d5f1e4fef3f684eb5c5a9b52b7a124be0043fcb78779200bcac1ce66e979c2aa19f146cbcbb1dee2b091f675d923df0081bc3ccada2e0e84e3ce04939734460a01e44a15314be75c035e70e74483d5ee1a7afb18d93f9554e6f78d033c76080f55fc45ea26d95d567b69aceca1e4c68010dd12478554a66478a5161140462341f7af9439112f8d06bf53d346f2547e734dfd2cdefa94d14c10e62a5abb6681a262b826bf6079f8af1db5582a86229ffcadb0c9913fbf24d06e52a3e478791b7659f7255510df7899832f012a9604dc98c71e41be4b73a569ba1ea36badfe8bbd865f72331c19a4bd04c8749f5e1acdb1a061cf00a4bd9a7f2fca3aab3fd7e9df7f9e68e7b102e7d00f3f705e99832088055eda84edea21719a7dfcd89c9984ca288b5b5739f00219ba2720c8a429f65c36d1c13782028fda43e607256eb22f3e6d011d9e712bdc55fadf3931c11f51a245caabdf93ac362b0b312c35e637118ace83affda676a102741b0c54af4d1e7c472d9f68bd9a30a3cb5243d664a8c4857f9729664d845321b056ddea5bfdded12ef81a68d62c789795e2b66ccd1ce40a21a7d30e8ae8280e673b7ccf5d12b973e66bb6c1ecc27643bfa814cca378f9c388ce4833562044649cba30f05d3000a4397e0300814df9c8d8ae9134dbdefaca16b0e81959f90fa7dcb1a0173b6c301ca03be982c78abd6747cb3cbea882bdcfc25e5ecb1289f148be67075e99cd6b785988598309f613a0803b3f3af865130ef7b4d0744499374d68109857f96752b5b2ced09399f1ae1c1783e0728927c2c0bb0fa67cf2bd1e6a7f1954ee4a34a2421fefb423c9cb0a866623aa4d984b2038f770d01f20138b0c822128f1518ad3b26c2bf16df1bfe8df1168084f432de1274cab41493316adca32d8b100a18fde89c16e245cba9e85cf007fd4c384e806427b32bea3949009346c9061c95e8131497ce457d749d84b5638728c7c3414a1027ac21048756a664da2d00420724404d08dd6fb22587ee814a2fad1a64865c326326412ea3d170b0f7cf94c4a4a11bdbc9aeffa5d0d715b58ec3e3c246dcb343c34e81feb91590c2dde666f5be0bfc0b76f968ba04a049f232cfe926efd80bc8d5367d80b869992851ac7873e968fbb5216e861afa8fb625a4008e1abc64c19c75c01d57b6bddbedd4d7ea560234107227426c71181d3826904fe32058b027faa46fb80126e7c7e6857d239cf31ed700dc43ad9f00c5009ef229139e1883e65780c92d7e504f26c9cdb22c29947dd68f28286f44b5c8f3e57126efda26277bdd118b3b36243f35ee2c1b14f7bfdfa8cfb03a3a5a68309da65234a0756c5653d2683a57f258154cb1fbe80c479755fd286835c12b8ee00e1e2280d1791aff3cbaf7a3c4cedef26e3c8ffcce40a3380d77461d3d73e99998850a77596d6dcd9ff2dde9990f75431797fd2c1013657077dfb2a052d545cf3062b61098d25b8e70008d30a056fe2252611858aaf5fd30503031603133e34b5825ec141d92255d3ba9d022c63b71ce5862a40a26787049bf108550a863a99431b750810b64f630e2936ba6e1c73ae211c47ce7de8bfd68707239070628920c79efc929d704c71ed34a7b3a43a222a6a60be13021f570d1801798a6aa816fa069e294454f43941618e3813132c41c582d9ab8397a8a6d6c57e9ff7e5b8c9503d0b8129733b536e6dfb5918b478b6d095b1fdea13ce139fdfb4e63dba60fa5956a9fb3bbfeb7333ac1815248253813b338a4409ba541e3354b7811c4165fd933fdbd88cf5d0f7585390674147c3131f57eac16b68c71a77747e53deb75484bc459a80a4995385e9b21ce5c00452fd9d88f5b51ed0457a11e6d5812fff160dadb682393220054551dace6a562fd703e586302404f9a9500815117236b8a2c503d99fa380379805f8f889419a41e3e2f6d9876d4527881a423adf1edfdf0b815b3090ceb50303fa05940d8ba4fd17a37e1564b8d7bdc6112bade09877c2daf0270dfbab467381c2fb741ae3f2ea888f367ccce4390971c4dc07e07a10bb0c1c8e8bb76e0e23ab860ebffceb44ab50d1872347747672a41f2c18a9a4b380571da369b28d9addded318ee151000e22f782722d191b6c11f70eda435c274a01ef6b145aaa80aaf268b4eeab15372f6057c62bbec9e3a735ac4bd97c83c109e66a95f5765bf9eebc5887ce339296cb9e417ccc985cc8f8d9a0cf5fcbb220315afd8761a7e54a87a3ae80a8fb1dfc306d1111b59a93ab98326da27cabb47ea234c1e306178ce1ce90c1db3f580b488c0de862f9761a55af8686a06b25cb64365a5b08701d8466f6cb6b771cdff8d82ac11bad879969d346b5a7bd02b3ef3c8994beb3d5b33b067386afcfcbbdeea372b19d2bb15725a85ab5efac79a0d659c0862ebba0505a84002709d7ec9590db13c282a61e58ee7ba516fb2fd16efc586a22783e732a23c6dd034753d842a062a86619d6667844018dd6518fde8caae2e43b9339f9c3e520de1802dcb14956a33ddada75380b3b25a48906bfd1122884d115e57bc27d1202ecef75cd68eba851e539d8b358e01d32b9fe09b6754dfea59e3f10c0e871f0a045e39907a232486e117efd230a3008bfba6a998a97fbda76c89f7b784414c5663301d4e2f76f41894d28024a0437b094481a249745949b15a656916618edddcf52a7aad4cea2bd10806e55049362c1715b8c5127b3e574bd0367d0a87f1d2f715f0f2ef963180fc78673882ce37e739d8dc5aea4c78b75ccfe8268573ef74f9f4aa7e365228595034dfb3e014eb0f0867f94aebf1806f31fda5aacb4c6bfbfc02c980d64f376858a2544c6234269b0cebf1ddceb0a98801e4344339401fe69ea422ff965305736ec3dafdd13d51c7bd7fa03d048cf6f2a01005330a0f2836080453189441e7f7b8c24e3bdb35748a27455450806238803ebe478a9d592842f7a5c96b6376d9b9869b67d406a3f609bc2945d875c2250bf2bbd5706d7c9bdad863b4bba1a833790015b6fcc2cde7789791c74bf47bf3aee4c8e1f147f1729d9d73e69165db5f615ad0f2bc2844e920e024b6c9b00c4edb760a9ef3ae7919ba06798e33f4928e1848915452d521181b4c890814e5af4f0873e28be4c3ef26390c773ac1c2277950b829f56a73f6f18b745b1bc1f0d8a57e93eab9e07aa6937fe0333f14b22aa00552bde6c2e8e5980154d23c54b4aeb32f598276f11d11d513c019ac88acbf16ff1c259ed6531135015963442f28e94dc9d75b2da698430be3e968c76bb3ea9d0974ed03f7f55c850fadcb9b0124280090c246305d63f706f384811837fadea0f59fb3b61719964c02f5ada9ded21104b112b0ec229d10c17dd6262eddd6882c228a69e6db69af14c58eed3af1e113faa3bcb01b18c93214b614799411799cd0787ca0fc188c4ed64064d2bc61d8a0841121a7821ce13e19d9c2f5268ae5e71245cc1051bf5debfedd63b476faa422b19c4c342d1c74a8a8e4c0dec09e5e4cc982b235fd6bb854251738b67346d19fadf0b2dd4905b82408c0c88024d83d3fedb2d5689067b817a6d713f9dff43cee07c5f4bd8ff44b348e7fc48f3856df532b30536f62d7ab4af992c8365dde0957a8b1a4786edf975b33c496ae4ebbf3861b213c4965f6ec2b70929c87ea3ae153d72bafec71549baa34025a024531629b9b6d6e8fda92ada8193cffe338c342abd08fb35b522ed181f5d59c919073fed3edde64358e304acec621c49ab3189b02c8d7b921f561309546ccd0eb8e827774d8abf19e9935be089c928c2e3392f7398aa97c563de64f8fd6c9f6f49988371a8236531db7f8a68b296a357a14876c5b8c977ff95d7e4c2d2b7e32ba2fdb07e88ad5e53498da3a3a1950944ea9995eaa60bca9e5a3a69b845f62677943e3f4b1f0d1b708a150776f8e6f9bf41bd394f212638f3fa6670aeb5dd7c5bc4fd8ee69b862021abb33bdbcc39a3cb5c343111eff89fa613ada3814714c8e4b0b4842c61db3a44114b84c6f2797753595cf2b6f925a7dac1eb663875f4f18180bf26a869a3a02811e77b899c0385372ce13748e732ecbdaee1d37afbb3c03df4083f342cb08fda97ffce7758530cebddc791c27af7ba3981bdc2c349b994fdb6e13558c0055f333498c078a679e62ce758e94150aefdea8031175ed0a2fe44b552e58b49f32cfd1b04e5269916b0204530fa2164a37ed525b5fa8c9f6c3027592b013f0b0348526baa04b92901aedbc5585fbda6846e19d4310985194a768c0f64099665977f4ec8fe8d0a0ae4bd80bf697ee9a3465582926d153af02608bc755b1af1e8d8bb813118a45907c42d13da4e459e0268827421f64e0a46c43b135fbb7cdc06f910484690461dfaf2a9f982c28ab04f883a80c7eba39ddc133a9ed4eff3fc972d1a1651ef6a6b584fdfa0b667744cc3c32e4f79b872b1da19c7697b7402a33ea39ba119439dd4f488aae97d3b9bbc25545d961bae1dbd6ff38803bda0fcee1be10a7780fe3f3605e5b7a8c75200f8cdf2ae8e485194ca9972abd5afaef5acc2302d086657cfb93edd3eccbdeb237ccd4a7d05dfa9541095ad8a1ab1e50054dbc2cfc9d2b778d5b0ad9b95d9fec1a09d0df1b928139223a284c62c5b6d724895c1458652cc7c3ae5b9a22f2c6796f38cb68bd0a69fb252db09e0a3d27e2e5de1e4fa9a54ba8261326ecebea7ce2c5c09ef2f319fb772a92db571687391ac18d9da4a212c4ece6285803c77b991dfb1e72138a00af092e20708dc57069554ca36b685cf7a5cc1540f98b50fe6c563b93e7656b0f46d70349f5340d1223a576715acc87bbb6b9be433c4cf317fb690c21e44fa4272618940cbb950c83ff5e580488279fd561b1329fe734d9909ec682b06e6a4de71ac45d48ffb5960bd934112fa4367810882c6174ebc1946b5ae235319c14e0f95abab6ef5ab68d215b4987fc073f0ba13bf5a7bcf2ca9c5ebc3caaf48ace8508d860ac51ebce66f3599eaacd76ad540c7059d059107f23378f898d5b8ca77e86ecb539df6009d2d8c3a82bcfaa5496ec91844cd8471bdb278734a2a228f9c6794e4259abca0ec67b8fb47ed820549fd968b2b757990db323eeccc160c33714d997dc5ce2344b16ddd04ee434a3391d47dc07491c647186c33ad3cf31374ea596c7efd9c5294d2a4d1a98d1358f6fc3dfffb1d75186fa97bd10a50d39f26b3c38d1fd017f91a4207321442d05628cfaef0739e977478809a4f7bf71aab7bdf0bde5eb8df3efc424be842296b2f186a05685547d7f96659d2f88369defcf2a01d2940e18b593b0e312d3bf03e2f1ed4c56eaf2b81c95f89097ffa3de0448cdf72b334f76b42490b78ded5800e2e1d1a14c6a73e5fe6219d034e097350b1828793ed7cb27faaa465386d97da22fe9bfccdcb547045cac2b2a059d0f0cbe0cca1fe95c2c347a12a0d9155eefc65638e7cbef4b3beb5275ccc952814c01b2eed0313a5a61da1ceaa3b39cbc34d6de59607b70a7a98a9e84792c61f5b8f4603a58f3d8e4998eb26e43010b6c87b6437218f7d6520072698201ee5dbb6d72edcc6156046c917e4a79d6e4be3bde3e328f44667aaacda7c1ac8201d80adf1bab4414051f6f8e0f4b6a74270fad131195c8162a9bae13b89a430fbb54ec16603e15e23eb28bc47352c3569ffe234ce56c84aa623e68ac82a58eb92a9e55e3f00db78121165b34e2dc03aa0d7ddc98326a30374ef967e2a4c2681222b7c3bc9d928cac87ffcef4794db8a3965e2f94fc5499df6cb0d73db3393b029fd7eacb95b36c66c5ac317dd84981cc8cdae535f8b357f57ae2bddbfe46c4d2ce2fbad3d00634312760f2d1269e38406b62f4c9baab169677406195ef35d3e111589d060810b5bd68c740c3b66ee9723933ac94654e70e70ac2b9dcf784cbdc8a1da506844e5ae4bfa61750a1c00c3552426f177516b2c9cc5ab848d1b33f694a4352acba74b7179a8ae8f0ca0387539158967cfc08ac783134e7f04c87103fc6f0871f0f6d6cb49ed417eba5e63165b1c6165e92d9690572bf34a722abec5832b752e5268c24c3e50f52cb65ef83dba1add1e06b4e4577e71c4179bfad721e3403015de76636a591a4e05698a9d1238163b5ad727b87b4e32e5510a7fbbaabf0b253468576ea7b5cd7d059816f3a463c102d4ba18df723524d38e973a936c5da3594990cb6023d349a2be477f839781ee45371a7a176b424f4b61c6f47f662b65db9d6aa26933c7cd1cf9c5304f9f0aca3065c8934d267fc7208d20e6844f0bd320a59be5c5028bc395f346302c7ba7dfcbf313cb983181f2af987b6e8f981660515e8349efdf7d71af8983267f9ca45976a72a0663abe9f05a22ed30a063e55181f86ba9e52054f6e0db6d21c9034408af6fef204fd46491c7870eed7c2f82296739bc27a028d40bf7a7d2ea5f15ed2d21b49dbd09773e17092858b14f16c4f55e110e75db6d82c56f1ee545df115b790ddabe366e1a77bc96f7bfdde42f2664ccdf260d248cf210dc78c4bc44705f17987a197955f9a27d769045d2b7d3ae44a9cababca962e555350ca7c746dce76b175471b3b2a19c6a7146a615199acd24b69881701658301a9ae2c3e4a044846136b41af1132c56aea67ac407d058bf704d53e6933c1acdf563620d81ff2a745a77db2756dea95f9bbd16a3bf03161bdc20493f5244e577927f2a49ce3fad6bec95e8492dfeef400ba3cd49b1f4e5d90353c7d2232eab9c0a756d4fdec1a27f79f9b23df77106810e3d335b8cafd5343fd39fe0b757d41d278dc10bb10877d293db12c8e4d7244029afd5bc8399dc57c78c588102065d681eb70fa4c06d063788308cd38db706775e58d2058ca21d58c63285318c66282fb2663f8dc60591f4e89cea59b72deeb7f5de39aaf786013ac55a32bb8c04fd4ace0cf949354709dc3d6f220c0296b6538651e0fe279cae5f7ba00bf0c2bb34474e92f54f92d182209cc3088263eb79449cd1a8607291c9e5caf7e116527e6e8e23647ce8a20f01b1892553cc95e696400e01e9141fe5b961191340401d17bec4adf741942b1e553f9ab3b10cc1659f2501068baf3b2d4072fea6457af2971b4a37a69e9f2dda49d471b57af5f3a47c1ed4e534c29d8c8a2372667db34cd8c608b180688520bde602ddd68cba86edc66e1f54fa32d94e171e528f24c4aac170845efae8e4bdf957ffce4a3060904917882e012ea2669ba68de251ebcd6ab3b9cf217ec739f229e1059f9768f2cf88a25bf75266de64ef9283d5c485c35eb8cd8a88c56e68beb263375b0e950d45d478864dfc90b37beec1ab2ed6a71f1a8c92c06a8084035089398974fdcebf8536ee03913955680b214440ccac6f94c344dea561457bde682659b014dd617c8b3e8509a96b2cd74161b98b503054f41c22eacedb3a2042c4a2d5ef715669561a85d78825b52a9e61cbd35ddc555bc897770be6d8dab97e1a5c83949a25d296fcd49bd0b260919fdc28d8b9ddc6e76033f359057ca8d4b80b45ce8d434d7b1aa164ecd512798a518c124e74ef7b19dabd2546ae1181b07df1e28ab62972a51526e0d0ebf0538f29aed421fc57077eba3bdac205200fca5e0106dafccc21bebe3b648def6eee56a3b12572e8c606f76b4fd477f76a5b449291ab21b66ff13b8b7866484bb49295370ec35da049b055710ab32ca16f12812c0655400e506d18bcd597ffb20abe3794e920709125078c40ebd6429749680cd0752a6bc987484b1ec0a4b7e440c7b6fdc28c6a3611af757f1b2edb50de34e850cea9cef28b03dd9e2ec5d9925c4b1386db5e3eee79b4332c4808b0f1ecbb1750324f9e29bf490f9ab3f87eeb2b8072329028e2c581c7f60de5b845969da74b060c7eba8392e87467e43ca01314f8efed8ece2c276a27947c4f570464eee2cdbbb52889cceeb9a59495153e8ddb14076b56424f9b521169c9e16c9339b093e6431743c46123f45889d0433c232b68c18be7479dc236eaa7798b6cc62edb47520edcf24b331e1f93ef6339fc3b55be3845217e71c8234f58598ccf615c8e624428c038f32b9be59d88bc557ad30deea74fdc61cc2976c53d54cdb70fa541063c9307c60001405d8a76981f533cf8cd89945a28ca13166fe6ff14ca9639c150caf5b4efe30eac1d94d90eb048f707a77323bf45dcd500f5a90c449c49e6fc2bdbf1c1963bf0abc191b62dcba16892a1031367018d1c08b0b96d677d69c11f0c01aa14adc2e9db5d60321af779f6fc842bc369e747c9a7fe1b1896c63fdc522c324f532ada298737f94d8dd22490b98bee77332a96da0c46205a3acf7dcc04dbdaddb0b53c2f717a820dc0a6e942bfa2c0801b227278a77ad9f6df660fcd3b35645776e25702d3536563f19d24ad6582c89fb9735d87dd76d4cc6b3c8b17bba719a23b17b5ccc8cf63a69a26175ad3645bb6d235c1667aba3d701455d7ae29d65a390979bdc1a5e8cbabab3a3959bce30dc678ef08b03ea169bafe145700fbfe05355d58d293aa5cafa78c2750d2a6022961feb47cc1d31330b5ba6f9f6df7708bab070efa81f1782e94510af357de7473db1df4cd2d9c519282fcce3702943f4301568787b615088d9929e8313e2bf3274340f5c6ded2c099f3f5e275c4818f7f1ee0276e90bc2ddf3757340427e7a23a1026e40cfbbb4e15b212a3d5109a81c907af2a861f785fd108b3b9f0abdd733775fd112305d2ac4460da4090af32fe9081a60e62e41d69d42e18e396827aed308789bd3ae26474d482f2e89a1f67065b8f105e4b18eb2cd3e9323e3b94dad19ffae38c90a5fd01df1881a773f50cbce3295aaeb05ce581abf2c9f8d972525b5d645a6fcd5143e6fc6e8d17de422d19001ae6fa823e451a4248510b2ae60d31c128ab942c7f79d81bb7656d94c899ec4af027c3746d01d7a43cd94c4027f7d72b4f35f93e744eea961d69e0dd73e28deacf207fe4d096fd82a73e8b7c27810f74c51f47d0a88825146bfc2cecd988db435edf386dece690f065c4e950cffaa8e8ae19199c07b6d25ed2c5f1b4ca909eb8532acd2c1f8ccdb322ea29ae8845402304709cec8bd053c034599a70638cd9a77b1e0c4f471c48418cefe4c115f8c3a95b75676f5ef33dcf1b80d212417b291593cbf36b8059997529ad6f8dd0a97df1b7f2d052d3f4e4294cc725d6d4477edda3ef2bd71b8cd71ecdfbb63d2902cbde84ce436bcc64f10ecce702eab7a558592988324f6a46ec42985d03964eb96b560c17e206c81fd1d407eb60c2a92a57c5e17d82fdef9882bd537e37501f48bedb21183bfbfb9899759e0a253ce38da596006adc0b631b869b8a43b6efd9c12edc6d7ec5582956c5b480c249c95463b037ab236b568272aecd886564970fa3b7327d2e063273ceba7da5dae8e71c7c9c419cb7bfe4ebff3e3713dd252f3ccc17dc5ba8930a82d22e38e1fd07db4d303411d69a16598ebfd9e28529863284358a3ff41cd21ff58e84fb717ac0f085bb3f43388895ec37c23b20bcba8d65ec554c58a714e2fea7aebdcef9d8c8799217052de44635f45afdbcd1001b27d4af3486b6714d01ce13243da752809764f1b32e414accae5602ede0233b0a826f427283204e4a733dc9f76261fdfbf82de543651e1e8bbb37125d32440e82d07ca0fcce7ab84211d8e20f5a138309b088faad62e2f96a8794528814f0adc9019cc02ac8927fff1f324bfdb50add5bf680bed7b5f768a90eeda61a3a18a02825d7cdcd170d3923c93f1c17ed5e335e91835ffdf12974743071a6e3dad4a1f721e94c6d5e33c2ffed357208fda529327b8e0aade50343d3cf65e9e68b26356bfdf66269453656cec49e899b1daa9281d7274c77b948fd54f98c7933ad97a22d502a3d4411223da0be59b10585baefea89a0c7e94a2d021ec1e7dfa79c72265e7ec6ede133a6619afb2a35fa5a0ce7bb0d385fc53aa455feda5fc5aa110d93e3508f7439385abca65fb5c1932b14e57e35bc8d87e9680872021a8a65bdb7ee2f47d42332f70e40e88352b40bb1d6544e56d041d0b813172a9600dc278ccdf48c76a7e8fc660921964450c8e7cf759c50ebc4d11cfe6933cd8702c9b212036341f4039aba722fdceda0f3d47cc07d23a44e8e9da55c1bc8b26ff471bbed82f2420ed1f5ae63a8b9eb3ac8ed0ebe67f6849ea4cb2c0e209b6e907d3daa603aa080c5d05212e01964aa30fed5802b790e6da12b845d2eb5c8766d7a94939bbd424cb3e386e620c41dac290919de2ca794b71d291f23c43fd2582efeb1ae20b648910ae4aa0186192af8237be98389b3c48111c6eebbc55749ad6df450081adc50a6d48b2b591b5560a4c940653052efa86cfdee00ccbd9971e9e9ee1d670540564950d2cc17766b41895686485d24b352c8f629371447caf43162eb3315320318768fd16c3ca1bc85addaf7e623ba5021006ead1f82159760001b064d9af9f57c3269675a6657a3318d3dc536d5673b3ca6ea1ba46cf64c6c86845a37d0f93c375e7e654a7737d5ec5393e477c68b9a97849762e66766197f7392e9f0df2c1b07707c991fff915da94a2a3889cd912895433773cd91d2ee10f5c604f6e75273f21d052461658e50df716ae46c826a5e02953cd01e7f1a1cad38eda0388c39c6b278ab177f8dd209f16eb54f1342943dac8704cd5a21b174150b4ddb9816e4f77fdf4c52dd44eeb82503ea13bdfa1f09f1333079d2d21179ff8221102ee2a62e406eaa2f5398a3c0100ce2eb788babbd6b0b274b091549ee7a7d3c868f538fae5b9f1bdb986c975c04092dbdd005a615c7b636d2610a870d45d7be01b34ca4a3f3febeafb917ca4a82fe6c2d601d7ce45b9efa9da6b1e2dc6efa8d2dc54a94d3c550d53d088bab382344c1230ac74130aa2f77baebe61fe684a912417fb94692be9a833bdf49651bb94ee8923acbf5824a17d289a190805e538ee578879f6f69d1a636cbb814ee4729f1bc53237bbe8706457c5fd6ffab829a8142bfb0b3cc31e9290a001693fa60e57ee048596fd55ae1f551dec0d17ad07fa742874fb5d31d93cb18e4ccdd2fa77bba2a7e0319eb2a4c144f06bf7c4af3957c444ea3fcbbb6f2cdaed791578d793e28fd43840c4ff4cbb949c02768376f0f5b9cfec293f8eb363ce066da3a85c0f7f2dc42d1bf2b1d36098627509f7bb76fc0b822907051af95f9d390f34aee467248746778b772a3a22ad621a97055ecd71967eef96aa5ed2214ef70d0f54c3e251238ddddfc5385ef54294d17e63dd7a56f09b61932a65120b4a4edcde4c9298d1efbe28a139b57988140a82db2eb780063184050d29be5f0f99a8cff0660b4e0423c0a8bdf614b2a9cbd64be9bf74033f47ebb464419abe01fa98ce904b14f3e7e6192bd26bf98151318da459ba72eedc585972262cacec3105a64c5d577736f08c31d0af54b12ee302df2fb0fae5376430cda9ab8044a5a6f94fb60da32a84717b0e505645b814d0ce93d71f3da8b2b87ab9f5d7740ec4a2be68d0d1bbd3c5ff0a217145f83a02b1da18ecfaeeaec928c3efb529b468cdbd20eb0f8d31a3cb0eb239cadbb070964ea4c464367b7759aaef22aed0dc966143bd201a8ee4b9f6adad612e7dd6e2bc28530ba14c0a702b09b6fa931bb4067356fb9bd589d19204bb2ccd28e880b7b719b57cf24c75fae34cb3975f3021cd034a7c700c7a19a3ad4561c524a7e252fe9d16adc433dfb694b67c0380709f8ab87ece39d8d19f6fe5c17972e1946c4297387a9c65daacc7326ddcd1e1b026f500a9a186a12a90cc387f4aa698337735c5ec562a1da51300a482e971ee91822549539f4b832a61cb83d9869193c967566bc4e565f3d27b03b6528bd711b8c2013ec8287b9bf7e14d9ac6552adc1cab8b42ccea04ae663b508ca84d91a193ffefdabec9bbac7ec5882689682d9eca9533dcb58e32057bae0c0cf9a451dd95b4d131be7b4d4c0180f5bca32d3eae1b8a2319e4b35ca58a2863e80b77e9f7bed9fe402995d3e689bf9ef74ae5245bb54e3720732c502ba3996ad56ea8645b6ebebf8721e6cfda1e53c7d6394d5e67c30f915b2d249ebc6b7631cf1942fcd9444f28d188a3baa3aa8ce541270d225f50365250cba977e5874bcf0af62fccdbdcf008fcb28f4c1b6dd7819d4c2af9e98c1b45a395e23a4c9f540e9b556e808811f5e564b61ec345f3b20ef8d0b61ff6c52f2373df2d573b01af46ccfb2f697c11817cee1f329ad08a003b001a876ab53400cab178aaf4b70f55fe13f35b10fce13ef35506470a4692f09613ed10ae26e1e50a4f89706bc99c05bd3aaa4ad82b6e174a047647ac5506121bf6303a0fbdd7403a7ac7fcf77fd504330af5fdc8aa3f9b70dab92d013ae5d45ebdea587b41f14b6412b84e3a9c6a706dc11052a7a7b858d8cda2ad04d9a62bb9fbeb0059dee0554ea4019cd7b4eee8f1d23398afd354ce541869fbfc575325be7cc8945af56a7214d3c77c518c40c472bc386a532b095a1a0bd7d1673b64790349d5ec2c85f633108e521900b73073c3319c5be1bdbc8a837a5770e9b8587168b61095e5e56d587d9f6e1c9273953ee9e22e59bfe3d3c378ba07c857f71347b70e562966db7d5019dfd071b52095d95339933304f519ff333ba43f232854738236dcd71a12f7ce4560bf1bd91b3ebf1dbae819012cd7995332dad44db34cf20b300b156a307fc5250366e0fa36c9c735a7f27e2e9d85dcdfba11f10723acad62b3c92718d8e02e98c7159a67460ab294518d6c9f10e6b0b8cfc56fcf78a3e1f0aad28527a08ce3bfb2caece533babfe8bb7e9707134ad6bb2c9f6cf9881f194959fb497ace55164ace3046489681c28b9e12db05f9ce895a7e0348c881d89cfe9c9c063251929423af3eeea29afb0fabf8bf1ccc7f58368ea59a7762d102217751ded9bd9ec0cd6eb82a8120b05c0cf5e0308b9251b3fa1521e8b8864f3daf203c2cce5f4596046a44777b146cb096ec46b840b2314dd6aef4aefeb2079ea40783cdc4d7a6aba67ef72f0eb7fe8a3b3145161f1bd26572e14f80a0f55c9dd249dd7cfa36fe499e8df3f4378b9343395d85100190774f47cfc3e132c321c6a58dd0767b2e2ea9f05b86fa3566b68d4f9d7522b7d164c59e71feaeeb0dedead090625fa364ef5a57c7d7c3254ac6810db0d3a171ca61c8e354d6070422dca7fb4a0356cc8265b47bc55f9e89e4ff97a7a9819cd324f0c65be4bbe1b2c2080f2ea5edc028176131f68febb62b477a2a60bbb1be4ce23ca5a6b723a4778e374e9054c2a759cd87c6774c47d27a1dea2a267ce5a376107f9dfad6cdc640e255504a38ea88c8cee54ffc2ee05e854cf9f22ab811d2137e5f2e812d76134ed817174026d70a82e0c97043c0378b2b0d4593d9ec425098e71b70153ccc9602f36829cd850cf1d2bfdda9fc6d82421cef6b447936692dc9aafbd2185b0757deb642476545218883538f5c1d2f213ba21547499a1bed3ad1a7a43b0b8901e5a2492c1d6c6c5fcbfba13fb38ba4aef41edd5c71c40893759e4a4dcd6253f3a0e3d41ca3f45b77e16075a560fc20fc03b2a665a479189fb61248a2e5694cf0fb46ed263163f1d14e69f5d8b44f523a375ea9d9069443c4b04cd4158e723f87c9c486ea8dbafdb567e74f76071c1378163c5079a784f74b9ccf74a9f168c82fc569c8eade9179483e5522289cf81bd006b6739b66bbd0851c2896e3b7c939d26528f3b71217e5433c992fc42dcfba91a8edfda2bdd620880bb5656fc0b5ae5833f2bdc8cb1bce3300a7e393ed757026dceb67a0a7972e2dc479bd900684a26dcc92e671b5d654d3e26935750490f498cd79dafecb7f49e3faedde5ff5a4180e5eb5209b8c4458fe143a98d5ed91c5a46db371b6a0818495df5776a0a9b318cecbe749844990e5b347d9198113c86cf21dfe846a1b65b78a267fb3e157c5cc67718adf23e72366a3edaf79a717d9bfc968bfc8aec6562566f3f6067a5b5edf842d19fb294c3d2e5c497a6a213584904bea36fb4413af9782510d1e62f91e1c19c5f2ce9abccc4b55853ea383683c00b8b60cbceab4b3b424986f7b22b1863e9d9b253a0c3f254b2e0fe6001c53d81871351f30cb98f336f9f9b5778c7bbe88aca7e90742eff5cbcb9e2650d3f31524e4da7849964eb1f189ccda96b55d058caf3cbef6faf5ff6cf16ab631d9cb54ecd493e2b30fedc673dd60881f4fb18931a72126cd916d01d9717a5930e5fca3dd6839299292c2ea651e06d3d7159a42b0967faa7cecdacda9368e76e10cb5ea584f7c0a110803c1f0e8c888575af3606e887eab5039ce585890ac55d08a232385f9a0a39dc94d7ceac4367788c3043c9c47f6516618cf59ee49a6dfdd014ffd57389d0b29e05120db75e5e3edb38c209b9c0911252892e3ada81d9398a7b2558896b7b4aca2c3db24f04df49092b5da521b229b0b8df0779cacf93a37f15ef85cd8f11afa676f08a6c51cfe4cc383c732b91c2d7098e809d855290869dac404a6884bf683679c7dfc17d4859788781a483ef941e13503a26ac3f87609d74ad10fcb664a7cd49f505508fba1c8c908c245f089e2623fbbe357add5c5b3ea4f4bc1a3dd01ace44672e896a01fc3065022dddb09ed24a61c5df20019a79f0525a4cb7c77cbcb231a81a5549442cf5497a4da56512e1a63cbf74d15f43446412c19281752e2967c64ca094f18e155573a6f390fcc1b824524a9ca086e460762713909e7a3f0d4fa9e1d5dee33da5ea25b4181427eabb9f9fab8d237ae10f05e6a6fa5b3d68aa05d3cdd24d88f258a4a290ae48037040ef63e7136b862637b6e937100bb896aeb44d21bd6e5107f940821609b91c5683b8effd665592fcfd4784eaee367cfdd17849870719afd76ecbf16b9f5cc848efd94a45bcb95d3464f9a972ce0a07fadd777aa25d11f91e0a6dc766cd71c0e6f5fe5091067cf4dd8e29b0673047101d2713caf3e919ab6a9a3e71a745b7ed68a9a5e829740f290ab126a1bbfb082912d5441a6d7aa611b8b0857d7eed3aa781ca903d2b49ef8a410b76617f9cd04485e19bbd32ce80419299990690a866d7b8ceda7312557e1abf44b9121315b5e23dcc6ad2fbcca1d9e5245cb35b00dee089e9cf6cea0f6e9683d90853ee308658770ab1aa75f240d77f579986d07d5fff0af19988731545f16a6b303810ae37df55b2cfa09115189b65dd02b37508248fa6f7acd2e9aaa0927178641bb96a3c28f713dc6a02d288b637b1fca83ebc8b1a3072f9251341c965d5e4dd11103761d6ccf9c16192558d33cad85edc37c9441bd23a290b982556a921643e473cf79ca2a079b9289728cfb1ca2d070905fc76c145cbbe4c9ffcb5fe7d2a2ff72aa683137b3e9ec8ad8e95cf344353c756094436597f62b874c75e62e394f42dfab6deb68a8ab6a3b749a0c0d55415d15a95b3b5f0bacb83e1a77d7cb835b428874439591d3f57a5bccd741880eae2cd7d270a38be18a86b929ae5593335bbedcdfc1105536c2ae53efaba2fb418ada22d7fc8b673c5e022ab91025b6d929b68e3ed959bc332bd0523bdb8c41ff81a94422f7151540956cf22b1d5aa05dfb076308ef556b018c1392cfb70227cf17f64cad562610c643bad59daef073889ff74bab516fa503e770c0f33074067e19f802cd0cc047fd18e25753b55f2b20d88211a882255c3d89c0245c6712ca027f53daa9dec7f7bf68a6efd38b732ee73a9344643d4cbd6305283d0ad5a84919460f3b9c1179ba35fd8b24388db932c56c0a462a58a1e44db53e1c667c51502a27525819114195e12516b0e448d8075e2e85bd45da30f34b2d9c9e02ea86013082f137db9996b2a94fe97a19c45b981e3dcb2dff208e0113172fa4c682a4d3dcf5aefe2cd35ad5fe8885f00b0464c33b445801218ac011d2a45ecb56396e1268c30984b631a829d242282ce98fb9ea47ee524517e5a49c18d6e0985e60ee71d8e1239d42ecfe7f239d6eaa765327a4608c47490d4ce779ca053b5d4ca83d14a0f23034e189781786135da6abaf6b5446791fe5589422fa7a4fd933f6a7584453e58fee2d3d4e03131525293660cb227aae23529c59b4ae02e780c33c99574b15cd33016ba80087c51f18314de4ea8c7d02bb47e4812f92e5a4e7152c789567ddab3526a2aba62ec6960b65c043d9404b95d03889c34690ac9cdc69ad7f5de14e675328566cb6f7350c02db517411a9a6254264a4b650f9dbcbaca4c47c6c2bb5cc4271060ed2c74f4c0870d4bcfcd4d40e3fe7ce3fb401bfcd51e91bd02acb79898797e0fe2f632b4fa4ad5243c00962f17f54b408c5b15a06911b5f55ea1caec3bcd97c64a03449eaf3e828f3d49e1f39ac57c3b8162c7c3aec386329c607882b40d8565dc919f34cd51aac8867bc05e352afcfa38345d256a39e1649798f83d7c68fadd90737452870a90cc0427bf210937f0bf5864ebb4a49a14de07f4c8b3380a6e1c838f1b91e2d10b95654c59696e5306ba2c444d0c825ad6a3f555955a8823d5ae85d40f1a140705932eb4b4410efaa1fa385399bdb689663b56396e3d96c963556fb7c1b2a2732ee1fdacee4a5fa6b69335eb38078299838f3e3e8a5a6cb9bdabea45a46695700d9a39c91670fd0bb651870821ceced0c6be9e715e596f18bc16b7a10ea9c3d918c91c18db761cccdb5b3d1a8d6acf1a8a7d5a1a59f3d0de63162afde2913a2fc76f2a80e096c6fc10a5d1d5c0d7debb87119a36b9e3eb8e9d37ce6c6f7c12821f2e53fbd0368af86296a2a835404cd2ec22d3f76a4157c5ed1dccb512215a9525bb4da656cef2a00106df5008ec0e53fee320fc9902a5215b1ee64318548cbcaf28077c9038da5f68a56fc3efa2bdf1213c2644f9e15f6407df4ec9cde0c5d7566a8c4ccf9af8a30d53f793b99a8023c70708db332fc913e406b6e16dc9725898eea57bfc880370b23759e21a96effd4c4c79c7bb599e64ef23ae2ae9cc464cf664ba02e10b634939fca523f714e52a9012818fdff1b8fe8f2bdeb64360328b8763929a676acec4d5d3f0e54c1faff5c833c42e860718ac3534d0ae4aabf7e6817b0efa61ace761fba0e8f425cd6e604d1032aa21adebd00b48f218da991dc0812ad0ade2cc176506939ec6588af7ebc687253fc9f4c6389a4f2a57025b669433704a779d03e7c5515071156647b89821c07e11f9273b79ebfad1b05ef98eeee3a40b27b0d81aa35401bf15a1874950111d6fd7c13b01161644d485b9169cb17d8902515edfb838971aff289e50e5bbf9331bc379dd1ce09ace8128c6ea1a1f01a9e659978f9c9532c8496dc6611854692bb8f1fff31705de02901f20ca13ab04098cb6383f26ffc6bab0497a8696c560e8a89f2b482db75e369264a18ac200af49594d2e8d4c1b3c36dce8d880090629d92b43122075a0d34b479d96ed813565165e0a8d00362d9384a81c67dc9a95c35ace8b0eaf230e879cdd59feae2c94ad03bf71da359bb63cac5ecda52c8beffcef17814863d9fac2599d937f710a9c93665fc2f441b3d98b7edd4effd9c7b5c2b59b3e01fccadabf8c5866dba1089667e98df1da62d8a4a708a6db302be245fa880862aa58b837f4b4a6e8a807dd278e6f2c32dd5e304d55338dd8e530c1debbd5fe4ba00e17f718ae7cce4a3a0</script>
</div>
<script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
      <categories>
        <category>语言</category>
      </categories>
      <tags>
        <tag>Math</tag>
        <tag>离散数学</tag>
        <tag>TLA+</tag>
        <tag>LaTeX</tag>
      </tags>
  </entry>
  <entry>
    <title>为什么 JavaScript 对服务端开发很重要?</title>
    <url>/posts/19989/</url>
    <content><![CDATA[<h2 id="开发人员用一种语言就能编写整个-Web-应用"><a href="#开发人员用一种语言就能编写整个-Web-应用" class="headerlink" title="开发人员用一种语言就能编写整个 Web 应用"></a>开发人员用一种语言就能编写整个 Web 应用</h2><p>　可以减少开发客户端和服务端时所需的语言切换（Clojure, <a href="https://github.com/clojure/clojurescript/">ClojureScript</a> 一样的道理）<br>　代码可以再客户端和服务端中共享（表单校验或游戏逻辑中使用同样的代码）</p>
<h2 id="JSON-是目前非常流行的数据交换格式"><a href="#JSON-是目前非常流行的数据交换格式" class="headerlink" title="JSON 是目前非常流行的数据交换格式"></a>JSON 是目前非常流行的数据交换格式</h2><p>　<a href="https://www.json.org/json-zh.html">JSON</a> 还是 JavaScript 原生的</p>
<h2 id="有些-NoSQL-数据库中用的就是-JavaScript-语言"><a href="#有些-NoSQL-数据库中用的就是-JavaScript-语言" class="headerlink" title="有些 NoSQL 数据库中用的就是 JavaScript 语言"></a>有些 NoSQL 数据库中用的就是 JavaScript 语言</h2><p>　MongoDB 的管理和查询语言都是 JavaScript<br>　CouchDB 的 Map/reduce 也是 JavaScript</p>
<h2 id="JavaScript-是一门编译目标语言"><a href="#JavaScript-是一门编译目标语言" class="headerlink" title="JavaScript 是一门编译目标语言"></a>JavaScript 是一门编译目标语言</h2><p>　<a href="https://github.com/jashkenas/coffeescript/wiki/List-of-languages-that-compile-to-JS/">List of languages that compile to JS</a></p>
<h2 id="Node-用的虚拟机（V8）会紧跟-ECMAScirpt-标准"><a href="#Node-用的虚拟机（V8）会紧跟-ECMAScirpt-标准" class="headerlink" title="Node 用的虚拟机（V8）会紧跟 ECMAScirpt 标准"></a>Node 用的虚拟机（V8）会紧跟 ECMAScirpt 标准</h2><p>　在 Node 中如果想用新的 JavaScript 语言特性，不用等到所有浏览器都支持</p>
<a id="more"></a>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt=""></a></td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>语言</category>
      </categories>
      <tags>
        <tag>JavaScript</tag>
        <tag>V8</tag>
      </tags>
  </entry>
  <entry>
    <title>大数据生态圈里的一致性算法</title>
    <url>/posts/54206/</url>
    <content><![CDATA[<h2 id="大数据生态圈中，保证一致性的方式举不胜举"><a href="#大数据生态圈中，保证一致性的方式举不胜举" class="headerlink" title="大数据生态圈中，保证一致性的方式举不胜举"></a>大数据生态圈中，保证一致性的方式举不胜举</h2><ul>
<li><a href="https://yuzhouwan.com/posts/60504/">Hadoop</a> 用 <a href="https://yuzhouwan.com/posts/31915/">ZooKeeper</a>（Zab，即支持事务顺序的 Paxos）</li>
<li><a href="https://yuzhouwan.com/posts/22654/">ElasticSearch</a> 用 <a href="https://yuzhouwan.com/posts/31130/">Hash</a> 路由算法（而非一致性 Hash）</li>
<li><a href="https://yuzhouwan.com/posts/20644/#ElasticSearch-Connector">Cassandra</a> 用 Gossip 闲话算法</li>
<li><a href="https://yuzhouwan.com/posts/2129/">Redis</a> 用 <a href="https://yuzhouwan.com/posts/31915/#Raft">Raft</a> 选举算法</li>
</ul>
<p>他们各有什么区别，为什么会如此选型？</p>
<h3 id="Paxos-选举算法"><a href="#Paxos-选举算法" class="headerlink" title="Paxos 选举算法"></a>Paxos 选举算法</h3><p>　<strong>Paxos</strong> 是最先解决<strong>拜占庭将军问题</strong>的算法，利用<strong>过半选举</strong>的机制，保证了集群数据副本的一致性（微服务中<a href="https://yuzhouwan.com/posts/31915/#其他技术比对">服务注册与发现</a>的场景，其实已经不再适用了）</p>
<h3 id="Raft-选举算法"><a href="#Raft-选举算法" class="headerlink" title="Raft 选举算法"></a>Raft 选举算法</h3><p>　Redis 使用 <strong>Raft</strong> 实现了自己的分布式一致性。Raft 本身和 Paxos 并没有场景上的区别。更多的是，协议上的简化、Term 概念的强化、Log 只会从 Leader 到 Follower 单向同步，使得实现起来会很方便</p>
<h3 id="Zab-原子广播协议"><a href="#Zab-原子广播协议" class="headerlink" title="Zab 原子广播协议"></a>Zab 原子广播协议</h3><p>　Hadoop 偏向于离线的海量数据处理，利用 <a href="https://yuzhouwan.com/posts/31915/">ZooKeeper</a> 来保证<a href="https://yuzhouwan.com/posts/31915/#Paxos-的强一致性">数据副本的一致性</a>，是最为合适的</p>
<h3 id="Hash-路由算法"><a href="#Hash-路由算法" class="headerlink" title="Hash 路由算法"></a>Hash 路由算法</h3><p>　<a href="https://yuzhouwan.com/posts/22654/">ElasticSearch</a> 集群接收到为文档创建索引的请求时，需要选择在哪一个 shard（完整且独立的 Lucene 索引实例）上对文档进行索引。ElasticSearch 采用的是 <a href="http://www.cse.yorku.ca/~oz/hash.html">djb2</a> 哈希算法（俗称 <a href="https://azrael.digipen.edu/~mmead/www/Courses/CS280/HashFunctions-1.html">times33</a>），对要索引文档默认或指定的 key 进行哈希 <code>hash(key)</code>，然后再对 ElasticSearch 集群中 shard 的数量 n 进行取模，即 $hash(key) \, mod \, n$</p>
<h3 id="一致性-Hash"><a href="#一致性-Hash" class="headerlink" title="一致性 Hash"></a>一致性 Hash</h3><p>　用于对数据存储进行<strong>负载均衡</strong>的算法。最新的进展，是在去年 Google 发表的一篇 <a href="https://arxiv.org/abs/1608.01350">有界负载的一致性 Hash 算法</a>的论文。该算法保证了负载均衡<strong>一致性</strong>和<strong>稳定性</strong>的同时，在<strong>均匀性</strong>方面做出了实质性地改进。同时，Consistent Hashing with Bounded Loads 算法 也在 <a href="http://www.haproxy.org/">HaProxy</a> 开源项目中得以<a href="https://github.com/haproxy/haproxy/blob/master/src/lb_chash.c#L244">应用</a>，有效减少了其 8 倍的缓存带宽</p>
<h3 id="Gossip-闲话算法"><a href="#Gossip-闲话算法" class="headerlink" title="Gossip 闲话算法"></a>Gossip 闲话算法</h3><p>　<strong>Gossip</strong> 主要被 Cassandra 用于实现其分布式一致性。因为 Cassandra 框架，更看重 <strong>去中心化</strong> 和 <strong>容错</strong> 的特性，在不违背 CAP 定理的情况下，能够接受 最终一致性</p>
<a id="more"></a>
<h2 id="实战一致性算法"><a href="#实战一致性算法" class="headerlink" title="实战一致性算法"></a>实战一致性算法</h2><h3 id="分布式存储"><a href="#分布式存储" class="headerlink" title="分布式存储"></a>分布式存储</h3><h4 id="Key-value-Store"><a href="#Key-value-Store" class="headerlink" title="Key-value Store"></a>Key-value Store</h4><h5 id="架构思考"><a href="#架构思考" class="headerlink" title="架构思考"></a>架构思考</h5><h6 id="HashMap"><a href="#HashMap" class="headerlink" title="HashMap"></a>HashMap</h6><p>　HashMap 的数据是存在内存里的，一旦进程重启，会有丢数据的风险。同时，数据流一旦到了 TB / PB 级别，会存在硬件方面的瓶颈。另外，需要考虑 Key 相同的情况下，需要处理覆盖的问题</p>
<h6 id="Berkeley-DB"><a href="#Berkeley-DB" class="headerlink" title="Berkeley DB"></a>Berkeley DB</h6><p>　实际上是一个增强版的 HashMap，从一个简单的键值对存储，进化到可以管理并行访问、支持事务、数据同步等</p>
<h6 id="Kyoto-Cabinet"><a href="#Kyoto-Cabinet" class="headerlink" title="Kyoto Cabinet"></a>Kyoto Cabinet</h6><p>　HashTable 和 B+ Tree 的结合，不过在到达一定数量级，性能下降比较厉害</p>
<h6 id="LevelDB-HBase"><a href="#LevelDB-HBase" class="headerlink" title="LevelDB / HBase"></a>LevelDB / HBase</h6><p>　利用 LSM Tree 实现了读写分离、顺序写入等功能</p>
<h2 id="知识树"><a href="#知识树" class="headerlink" title="知识树"></a>知识树</h2><p><img data-src="/picture/algorithm/distribution.png" alt="分布式系统"></p>
<center>（利用 <a href="https://www.xmind.net/" target="_blank">XMind</a>™ 绘制而成）</center>




<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><h3 id="Book"><a href="#Book" class="headerlink" title="Book"></a>Book</h3><ul>
<li><a href="https://www.amazon.cn/%E4%B8%96%E7%95%8C%E8%91%97%E5%90%8D%E8%AE%A1%E7%AE%97%E6%9C%BA%E6%95%99%E6%9D%90%E7%B2%BE%E9%80%89%E2%80%A2%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86%E4%B8%8E%E8%8C%83%E5%9E%8B-%E7%89%B9%E5%B0%BC%E5%8D%9A%E5%A7%86/dp/B001B1PT9Y">《分布式系统：原理与范型（第2版）》</a></li>
<li><a href="https://www.amazon.cn/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F-%E6%A6%82%E5%BF%B5%E4%B8%8E%E8%AE%BE%E8%AE%A1-%E5%BA%93%E9%B2%81%E9%87%8C%E6%96%AF/dp/B00BS58XAK">《分布式系统：概念与设计（原书 第5版）》</a></li>
<li><a href="https://www.amazon.cn/%E5%A4%A7%E8%A7%84%E6%A8%A1%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8%E7%B3%BB%E7%BB%9F-%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90%E4%B8%8E%E6%9E%B6%E6%9E%84%E5%AE%9E%E6%88%98-%E6%9D%A8%E4%BC%A0%E8%BE%89/dp/B00H6X6BE8">《大规模分布式存储系统：原理解析与架构实战》</a></li>
<li><a href="https://book.douban.com/subject/26852650/">《分布式数据库：管理系统实践》</a></li>
<li><a href="https://www.amazon.cn/%E4%B8%96%E7%95%8C%E8%91%97%E5%90%8D%E8%AE%A1%E7%AE%97%E6%9C%BA%E6%95%99%E6%9D%90%E7%B2%BE%E9%80%89-%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86-%E5%8E%84%E5%85%B9%E5%8F%99/dp/B00JW45XYI">《分布式数据库系统原理（第3版）》</a></li>
<li><a href="http://book.mixu.net/distsys/single-page.html">《Distributed systems for fun and profit》</a></li>
</ul>
<h3 id="Blog"><a href="#Blog" class="headerlink" title="Blog"></a>Blog</h3><ul>
<li><a href="http://codecapsule.com/2012/11/07/ikvs-implementing-a-key-value-store-table-of-contents/">Implementing a Key-Value Store</a></li>
</ul>
<h3 id="Paper"><a href="#Paper" class="headerlink" title="Paper"></a>Paper</h3><ul>
<li><a href="http://www.allthingsdistributed.com/files/amazon-dynamo-sosp2007.pdf">Dynamo: Amazon’s Highly Available Key-value Store</a></li>
</ul>
<h3 id="Video"><a href="#Video" class="headerlink" title="Video"></a>Video</h3><ul>
<li><a href="https://cs162.eecs.berkeley.edu/"><strong>CS162</strong>: Operating Systems and Systems Programming</a></li>
</ul>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt=""></a></td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>大数据</category>
      </categories>
      <tags>
        <tag>Apache Hadoop</tag>
        <tag>Algorithm</tag>
        <tag>Apache Cassandra</tag>
        <tag>Apache ZooKeeper</tag>
        <tag>ElasticSearch</tag>
        <tag>Redis</tag>
        <tag>一致性 Hash</tag>
        <tag>CAP</tag>
        <tag>Paxos</tag>
        <tag>Raft</tag>
        <tag>Gossip</tag>
      </tags>
  </entry>
  <entry>
    <title>容器引擎 Docker</title>
    <url>/posts/200314/</url>
    <content><![CDATA[<h2 id="什么是-Docker？"><a href="#什么是-Docker？" class="headerlink" title="什么是 Docker？"></a>什么是 Docker？</h2><blockquote>
<p><a href="https://docs.docker.com/">Docker</a>™ provides a way to run applications securely isolated in a container, packaged with all its dependencies and libraries.</p>
</blockquote>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><h3 id="MacOS"><a href="#MacOS" class="headerlink" title="MacOS"></a>MacOS</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ brew cask install docker</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h3><h4 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h4><p>　从 Toolbox 的 Archive <a href="https://get.daocloud.io/toolbox/">页面</a>找到 <a href="https://dn-dao-github-mirror.daocloud.io/docker/toolbox/releases/download/v19.03.1/DockerToolbox-19.03.1.exe">DockerToolbox-19.03.1.exe</a> 并下载</p>
<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a><a href="https://docs.docker.com/toolbox/overview/">安装</a></h4><p>　注意安装组件的时候，选择 <code>Full installation</code>，其他的均使用默认的选项，即可</p>
<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><h5 id="代理"><a href="#代理" class="headerlink" title="代理"></a><a href="https://docs.docker.com/network/proxy/#configure-the-docker-client">代理</a></h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim ~/.docker/config.json</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"proxies"</span>: {</span><br><span class="line">    <span class="attr">"default"</span>: {</span><br><span class="line">      <span class="attr">"httpProxy"</span>: <span class="string">"socks5://127.0.0.1:1080"</span>,</span><br><span class="line">      <span class="attr">"httpsProxy"</span>: <span class="string">"socks5://127.0.0.1:1080"</span>,</span><br><span class="line">      <span class="attr">"noProxy"</span>: <span class="string">"*.yuzhouwan.com"</span></span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<a id="more"></a>
<h5 id="镜像源"><a href="#镜像源" class="headerlink" title="镜像源"></a>镜像源</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">https://docker.mirrors.ustc.edu.cn</span><br><span class="line">https://hub-mirror.c.163.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 另外，登陆阿里云账号后，可以通过该地址获取到专属的阿里云镜像</span></span><br><span class="line"><span class="comment"># https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors</span></span><br></pre></td></tr></tbody></table></figure>
<h6 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim ~/.docker/config.json</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"registry-mirrors"</span>: [</span><br><span class="line">    <span class="string">"https://registry.docker-cn.com"</span></span><br><span class="line">  ]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h6 id="配置守护程序"><a href="#配置守护程序" class="headerlink" title="配置守护程序"></a><a href="https://cloud.google.com/container-registry/docs/pulling-cached-images">配置守护程序</a></h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 增加如下配置项</span></span><br><span class="line">$ vim /etc/docker/daemon.json</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"registry-mirrors"</span>: [<span class="string">"https://registry.docker-cn.com"</span>]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 重启 Docker 服务使其生效</span></span><br><span class="line">$ sudo service docker restart</span><br><span class="line"></span><br><span class="line"><span class="comment"># 校验是否生效</span></span><br><span class="line">$ docker system info</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># ...</span></span><br><span class="line">Registry Mirrors:</span><br><span class="line"> https://registry.docker-cn.com</span><br><span class="line"><span class="comment"># ..</span></span><br></pre></td></tr></tbody></table></figure>
<h6 id="命令行指定"><a href="#命令行指定" class="headerlink" title="命令行指定"></a>命令行指定</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ docker-machine create --engine-registry-mirror=http://hub-mirror.c.163.com -d virtualbox kafka-connect</span><br></pre></td></tr></tbody></table></figure>
<h6 id="Desktop-设置"><a href="#Desktop-设置" class="headerlink" title="Desktop 设置"></a>Desktop 设置</h6><p><img data-src="/picture/docker/docker_mirror.png" alt=""></p>
<center>（对 <a href="https://www.docker.com/" target="_blank">Docker</a>™ 的截图）</center>

<h4 id="Boot-2-Docker"><a href="#Boot-2-Docker" class="headerlink" title="Boot 2 Docker"></a><a href="https://github.com/boot2docker/boot2docker/">Boot 2 Docker</a></h4><ul>
<li>打开 cmd 命令行</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ cmd</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>查看帮助文档</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ docker-machine -h</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>创建名为 kafka-connect 的镜像</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ docker-machine create --driver virtualbox kafka-connect</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>进入 kafka-connect 镜像</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ docker-machine env kafka-connect</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">SET DOCKER_TLS_VERIFY=1</span><br><span class="line">SET DOCKER_HOST=tcp://127.0.0.1:2376</span><br><span class="line">SET DOCKER_CERT_PATH=C:\Users\BenedictJin\.docker\machine\machines\kafka-connect</span><br><span class="line">SET DOCKER_MACHINE_NAME=kafka-connect</span><br><span class="line">SET COMPOSE_CONVERT_WINDOWS_PATHS=<span class="literal">true</span></span><br><span class="line">REM Run this <span class="built_in">command</span> to configure your shell:</span><br><span class="line">REM     @FOR /f <span class="string">"tokens=*"</span> %i IN (<span class="string">'docker-machine env kafka-connect'</span>) DO @%i</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>拷贝上面输出的最后一行，去掉 REM 注释，并运行</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ @FOR /f <span class="string">"tokens=*"</span> %i IN (<span class="string">'docker-machine env kafka-connect'</span>) DO @%i</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>此时，就可以执行 docker 相关的命令了</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ docker info</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>移除 kafka-connect 镜像</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ docker-machine rm kafka-connect</span><br></pre></td></tr></tbody></table></figure>
<h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><h3 id="version"><a href="#version" class="headerlink" title="version"></a><a href="https://docs.docker.com/engine/reference/commandline/version/">version</a></h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ docker version</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">Client: Docker Engine - Community</span><br><span class="line"> Version:           19.03.5</span><br><span class="line"> API version:       1.40</span><br><span class="line"> Go version:        go1.12.12</span><br><span class="line"> Git commit:        633a0ea</span><br><span class="line"> Built:             Wed Nov 13 07:22:34 2019</span><br><span class="line"> OS/Arch:           darwin/amd64</span><br><span class="line"> Experimental:      <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">Server: Docker Engine - Community</span><br><span class="line"> Engine:</span><br><span class="line">  Version:          19.03.5</span><br><span class="line">  API version:      1.40 (minimum version 1.12)</span><br><span class="line">  Go version:       go1.12.12</span><br><span class="line">  Git commit:       633a0ea</span><br><span class="line">  Built:            Wed Nov 13 07:29:19 2019</span><br><span class="line">  OS/Arch:          linux/amd64</span><br><span class="line">  Experimental:     <span class="literal">false</span></span><br><span class="line"> containerd:</span><br><span class="line">  Version:          v1.2.10</span><br><span class="line">  GitCommit:        b34a5c8af56e510852c35414db4c1f4fa6172339</span><br><span class="line"> runc:</span><br><span class="line">  Version:          1.0.0-rc8+dev</span><br><span class="line">  GitCommit:        3e425f80a8c931f88e6d94a8c831b9d5aa481657</span><br><span class="line"> docker-init:</span><br><span class="line">  Version:          0.18.0</span><br><span class="line">  GitCommit:        fec3683</span><br></pre></td></tr></tbody></table></figure>
<h3 id="status"><a href="#status" class="headerlink" title="status"></a>status</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ service docker status</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">Redirecting to /bin/systemctl status  docker.service</span><br><span class="line">● docker.service - LSB: start and stop docker</span><br><span class="line">   Loaded: loaded (/etc/docker/docker; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Tue 2018-09-18 09:54:31 CST; 29min ago</span><br><span class="line">     Docs: man:systemd-sysv-generator(8)</span><br><span class="line">  Process: 14743 ExecStart=/etc/docker/docker start (code=exited, status=0/SUCCESS)</span><br><span class="line">   CGroup: /docker.slice/docker.service</span><br><span class="line">           ├─14907 /opt/ali-iaas/docker/plugins/alinet 127.0.0.1</span><br><span class="line">           ├─14919 /opt/ali-iaas/docker/plugins/tmpfs 127.0.0.1</span><br><span class="line">           └─14933 /opt/ali-iaas/docker/plugins/alilocal 127.0.0.1</span><br></pre></td></tr></tbody></table></figure>
<h3 id="logs"><a href="#logs" class="headerlink" title="logs"></a><a href="https://docs.docker.com/engine/reference/commandline/logs/">logs</a></h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ docker logs -f &lt;容器名 or 容器ID&gt;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="login"><a href="#login" class="headerlink" title="login"></a><a href="https://docs.docker.com/engine/reference/commandline/login/">login</a></h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ docker login reg.docker.yuzhouwan.com</span><br></pre></td></tr></tbody></table></figure>
<h3 id="cp"><a href="#cp" class="headerlink" title="cp"></a><a href="https://docs.docker.com/engine/reference/commandline/cp/">cp</a></h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 从容器中将文件拷贝出来</span></span><br><span class="line">$ docker cp &lt;容器名 or 容器ID&gt;:/home/benedict_jin/a.txt /opt/</span><br><span class="line"><span class="comment"># 从将文件拷贝到容器里面</span></span><br><span class="line">$ docker cp /opt/ &lt;容器名 or 容器ID&gt;:/home/benedict_jin/a.txt</span><br></pre></td></tr></tbody></table></figure>
<h3 id="run"><a href="#run" class="headerlink" title="run"></a><a href="https://docs.docker.com/engine/reference/run/">run</a></h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ docker run [OPTIONS] IMAGE[:TAG|@DIGEST] [COMMAND] [ARG...]</span><br></pre></td></tr></tbody></table></figure>
<h3 id="restart"><a href="#restart" class="headerlink" title="restart"></a><a href="https://docs.docker.com/engine/reference/commandline/container_restart/">restart</a></h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ docker restart &lt;容器名 or 容器ID&gt;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="rmi"><a href="#rmi" class="headerlink" title="rmi"></a><a href="https://docs.docker.com/engine/reference/commandline/rmi/">rmi</a></h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># usage</span></span><br><span class="line">$ docker rmi [OPTIONS] IMAGE [IMAGE...]</span><br><span class="line"><span class="comment"># example</span></span><br><span class="line">$ docker rmi k8s.gcr.io/coredns:1.3.1</span><br></pre></td></tr></tbody></table></figure>
<h3 id="rm"><a href="#rm" class="headerlink" title="rm"></a><a href="https://docs.docker.com/engine/reference/commandline/rm/">rm</a></h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ docker rm &lt;容器名 or 容器ID&gt;</span><br></pre></td></tr></tbody></table></figure>
<h2 id="实用技巧"><a href="#实用技巧" class="headerlink" title="实用技巧"></a>实用技巧</h2><h3 id="Engine-API"><a href="#Engine-API" class="headerlink" title="Engine API"></a><a href="https://docs.docker.com/engine/api/v1.40/">Engine API</a></h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 获取到 unhealthy 状态的容器</span></span><br><span class="line">$ curl --unix-socket /var/run/docker.sock <span class="string">"http://localhost/containers/json?filters=\{\"health\":\[\"unhealthy\"\]\}"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取到容器启动的时间戳</span></span><br><span class="line">$ curl --unix-socket /var/run/docker.sock <span class="string">"http://localhost/containers/&lt;容器 ID&gt;/json"</span> | jq <span class="string">'.State.StartedAt'</span> | date +%s</span><br></pre></td></tr></tbody></table></figure>
<h2 id="踩到的坑"><a href="#踩到的坑" class="headerlink" title="踩到的坑"></a>踩到的坑</h2><h3 id="No-default-Boot2Docker-ISO-found-locally"><a href="#No-default-Boot2Docker-ISO-found-locally" class="headerlink" title="No default Boot2Docker ISO found locally"></a>No default Boot2Docker ISO found locally</h3><h4 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ docker-machine create --driver virtualbox kafka-connect</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">Running pre-create checks...</span><br><span class="line">(dataagg) No default Boot2Docker ISO found locally, downloading the latest release...</span><br><span class="line">Error with pre-create check: <span class="string">"Get https://api.github.com/repos/boot2docker/boot2docker/releases/latest: dial tcp 127.0.0.1:443: connectex: A connection attempt failed because the connected party did not properly respond after a period of time, or established connection failed because connected host has failed to respond."</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h4><p>　到 boot2docker 的 <a href="https://github.com/boot2docker/boot2docker/releases">release</a> 页面下载最新的 <a href="https://github.com/boot2docker/boot2docker/releases/download/v17.12.1-ce/boot2docker.iso">boot2docker.iso</a>（当前最新版本为 v17.12.1-ce），并放到 <code>C:\Users\BenedictJin\.docker\machine\cache</code> 目录下，再次运行 <code>docker-machine create xxx</code> 命令即可</p>
<h3 id="Docker-raw-单文件达到-64G"><a href="#Docker-raw-单文件达到-64G" class="headerlink" title="Docker.raw 单文件达到 64G"></a>Docker.raw 单文件达到 64G</h3><h4 id="描述-1"><a href="#描述-1" class="headerlink" title="描述"></a>描述</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ ll -h /Users/benedictjin/Library/Containers/com.docker.docker/Data/vms/0/data/Docker.raw</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">-rw-r--r--  1 benedictjin  staff    64G  3 23 22:18 /Users/benedictjin/Library/Containers/com.docker.docker/Data/vms/0/data/Docker.raw</span><br></pre></td></tr></tbody></table></figure>
<h4 id="解决-1"><a href="#解决-1" class="headerlink" title="解决"></a>解决</h4><p>　进入 <code>Preferences</code> 配置页面，选择  <code>Disk</code> 配置页，调整预分配磁盘大小，点击 <code>Apply</code> 按钮以应用修改</p>
<h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><h3 id="Doc"><a href="#Doc" class="headerlink" title="Doc"></a>Doc</h3><ul>
<li><a href="https://docs.docker.com/install/">Install Docker</a></li>
<li><a href="https://www.xmind.net/m/RHSz/">Docker Ecosystem</a></li>
</ul>
<h3 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h3><ul>
<li><a href="https://github.com/moby/moby">Moby Project - a collaborative project for the container ecosystem to assemble container-based systems</a></li>
</ul>
<h3 id="Resource"><a href="#Resource" class="headerlink" title="Resource"></a>Resource</h3><ul>
<li><a href="https://hub.docker.com/">Docker Hub</a></li>
</ul>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt=""></a></td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>云原生</category>
      </categories>
      <tags>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title>开源时序数据库 InfluxDB</title>
    <url>/posts/200315/</url>
    <content><![CDATA[<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><blockquote>
<p><strong><a href="https://docs.influxdata.com/">InfluxDB</a></strong>™ is a time series database designed to handle high write and query loads. It is an integral component of the TICK stack. InfluxDB is meant to be used as a backing store for any use case involving large amounts of timestamped data, including DevOps monitoring, application metrics, IoT sensor data, and real-time analytics.</p>
</blockquote>
<h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><h3 id="DataBase"><a href="#DataBase" class="headerlink" title="DataBase"></a>DataBase</h3><p>　类似于传统数据库中的 DataBase 概念</p>
<h3 id="Measurement"><a href="#Measurement" class="headerlink" title="Measurement"></a>Measurement</h3><p>　和 OLAP 中广义上的度量概念一致，部分 OLAP 数据库中又称为 Metric</p>
<h3 id="Tag"><a href="#Tag" class="headerlink" title="Tag"></a>Tag</h3><p>　和 OLAP 中广义上的维度概念一致，部分 OLAP 数据库中又称为 TagKV</p>
<h3 id="Field"><a href="#Field" class="headerlink" title="Field"></a>Field</h3><p>　数值</p>
<h3 id="Timestamp"><a href="#Timestamp" class="headerlink" title="Timestamp"></a>Timestamp</h3><p>　时间戳</p>
<h3 id="Points"><a href="#Points" class="headerlink" title="Points"></a>Points</h3><p>　数据点</p>
<h3 id="Series"><a href="#Series" class="headerlink" title="Series"></a>Series</h3><p>　数据点组成的序列</p>
<h3 id="Retention-Policy"><a href="#Retention-Policy" class="headerlink" title="Retention Policy"></a>Retention Policy</h3><p>　数据过期策略，即 TTL</p>
<a id="more"></a>
<h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2><h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><ul>
<li>无任何额外的依赖（例如 <a href="https://yuzhouwan.com/tags/Apache-ZooKeeper/">ZooKeeper</a>、<a href="https://yuzhouwan.com/tags/HDFS/">HDFS</a> 等）</li>
<li>支持类 SQL 查询（<a href="https://yuzhouwan.com/posts/200315/#InfluxQL">InfluxQL</a>）</li>
<li>支持多租户和简单的鉴权功能</li>
<li>开源社区活跃，且常年霸榜 <a href="https://db-engines.com/en/ranking/time+series+dbms">DB-Engines</a> 时序数据库的第一名</li>
</ul>
<h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><ul>
<li>未开源集群版本</li>
<li>不支持懒加载（启动需要扫描所有 TSM 文件，会导致节点故障恢复慢，而 <a href="https://yuzhouwan.com/posts/5845/#Segment-%E5%8A%A0%E8%BD%BD">Apache Druid</a> 是支持的）</li>
<li>无法跨 Measurement 进行 Join 操作</li>
<li>无法存储相同的数据点，会发生覆盖写</li>
<li>不支持冷热数据的分层存储</li>
</ul>
<h2 id="环境部署"><a href="#环境部署" class="headerlink" title="环境部署"></a>环境部署</h2><div class="note info">鉴于目前 InfluxDB 2.x 还没有稳定版本发布，所以这里我们使用的 InfluxDB 版本是 1.x</div>



<h3 id="源码版"><a href="#源码版" class="headerlink" title="源码版"></a>源码版</h3><h4 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ go get github.com/influxdata/influxdb</span><br><span class="line">$ <span class="built_in">cd</span> <span class="variable">$GOPATH</span>/src/github.com/influxdata/influxdb</span><br><span class="line">$ go clean ./...</span><br><span class="line">$ go get -t -v ./...</span><br><span class="line">$ go install -ldflags=<span class="string">"-X main.version=1.8.2"</span> ./...</span><br><span class="line">$ ll <span class="variable">$GOPATH</span>/bin</span><br></pre></td></tr></tbody></table></figure>
<h4 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="variable">$GOPATH</span>/bin/influxd</span><br></pre></td></tr></tbody></table></figure>
<h3 id="容器版"><a href="#容器版" class="headerlink" title="容器版"></a>容器版</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 拉取镜像</span></span><br><span class="line">$ docker pull influxdb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">$ docker run -idt --name influxdb -p 8086:8086 -v ~/influxdb:/var/lib/influxdb influxdb</span><br></pre></td></tr></tbody></table></figure>
<h4 id="校验"><a href="#校验" class="headerlink" title="校验"></a>校验</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ docker ps</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                    NAMES</span><br><span class="line">5cf826d18054        influxdb            <span class="string">"/entrypoint.sh infl…"</span>   50 seconds ago      Up 49 seconds       0.0.0.0:8086-&gt;8086/tcp   influxdb</span><br></pre></td></tr></tbody></table></figure>
<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><h5 id="进入容器"><a href="#进入容器" class="headerlink" title="进入容器"></a>进入容器</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ docker <span class="built_in">exec</span> -it influxdb bash</span><br></pre></td></tr></tbody></table></figure>
<h5 id="连接-InfluxDB-实例"><a href="#连接-InfluxDB-实例" class="headerlink" title="连接 InfluxDB 实例"></a>连接 InfluxDB 实例</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ influx</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">Connected to http://localhost:8086 version 1.8.2</span><br><span class="line">InfluxDB shell version: 1.8.2</span><br></pre></td></tr></tbody></table></figure>
<h5 id="InfluxQL"><a href="#InfluxQL" class="headerlink" title="InfluxQL"></a>InfluxQL</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 创建数据库</span></span><br><span class="line">&gt; CREATE DATABASE yuzhouwan</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用数据库</span></span><br><span class="line">&gt; USE yuzhouwan</span><br><span class="line">Using database yuzhouwan</span><br><span class="line"></span><br><span class="line"><span class="comment"># 展示数据库</span></span><br><span class="line">&gt; SHOW DATABASES</span><br><span class="line">name: databases</span><br><span class="line">name</span><br><span class="line">----</span><br><span class="line">_internal</span><br><span class="line">yuzhouwan</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建用户</span></span><br><span class="line">&gt; CREATE USER asdf2014 WITH PASSWORD <span class="string">'yuzhouwan.com'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 展示用户</span></span><br><span class="line">&gt; SHOW USERS</span><br><span class="line">user     admin</span><br><span class="line">----     -----</span><br><span class="line">asdf2014 <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 赋权</span></span><br><span class="line">&gt; GRANT ALL PRIVILEGES ON yuzhouwan TO asdf2014</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Helm-云原生"><a href="#Helm-云原生" class="headerlink" title="Helm 云原生"></a><a href="https://hub.helm.sh/charts/influxdata/influxdb">Helm 云原生</a></h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ helm repo add influxdata https://helm.influxdata.com/</span><br><span class="line">$ helm install influxdata/influxdb --version 4.8.2 --generate-name</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">NAME</span>: <span class="string">influxdb-1598258562</span></span><br><span class="line"><span class="attr">LAST</span> <span class="string">DEPLOYED: Mon Aug 24 16:42:47 2020</span></span><br><span class="line"><span class="attr">NAMESPACE</span>: <span class="string">default</span></span><br><span class="line"><span class="attr">STATUS</span>: <span class="string">deployed</span></span><br><span class="line"><span class="attr">REVISION</span>: <span class="string">1</span></span><br><span class="line"><span class="attr">TEST</span> <span class="string">SUITE: None</span></span><br><span class="line"><span class="attr">NOTES</span>:<span class="string"></span></span><br><span class="line"><span class="attr">InfluxDB</span> <span class="string">can be accessed via port 8086 on the following DNS name from within your cluster:</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">http</span>:<span class="string">//influxdb-1598258562.default:8086</span></span><br><span class="line"></span><br><span class="line"><span class="attr">You</span> <span class="string">can connect to the remote instance with the influx CLI. To forward the API port to localhost:8086, run the following:</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">kubectl</span> <span class="string">port-forward --namespace default $(kubectl get pods --namespace default -l app=influxdb-1598258562 -o jsonpath='{ .items[0].metadata.name }') 8086:8086</span></span><br><span class="line"></span><br><span class="line"><span class="attr">You</span> <span class="string">can also connect to the influx CLI from inside the container. To open a shell session in the InfluxDB pod, run the following:</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">kubectl</span> <span class="string">exec -i -t --namespace default $(kubectl get pods --namespace default -l app=influxdb-1598258562 -o jsonpath='{.items[0].metadata.name}') /bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="attr">To</span> <span class="string">view the logs for the InfluxDB pod, run the following:</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">kubectl</span> <span class="string">logs -f --namespace default $(kubectl get pods --namespace default -l app=influxdb-1598258562 -o jsonpath='{ .items[0].metadata.name }')</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="Grafana"><a href="#Grafana" class="headerlink" title="Grafana"></a><a href="https://grafana.com/docs/installation/debian/">Grafana</a></h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line">$ wget https://dl.grafana.com/oss/release/grafana-6.0.0-beta2.x86_64.rpm</span><br><span class="line">$ sudo yum localinstall grafana-6.0.0-beta2.x86_64.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">$ systemctl daemon-reload</span><br><span class="line">$ systemctl start grafana-server</span><br><span class="line">$ systemctl status grafana-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自启动</span></span><br><span class="line">$ sudo systemctl <span class="built_in">enable</span> grafana-server.service</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Telegraf"><a href="#Telegraf" class="headerlink" title="Telegraf"></a><a href="https://github.com/influxdata/telegraf">Telegraf</a></h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ wget https://dl.influxdata.com/telegraf/releases/telegraf-1.12.3-1.x86_64.rpm</span><br><span class="line">$ sudo yum localinstall telegraf-1.12.3-1.x86_64.rpm</span><br><span class="line">$ telegraf config &gt; telegraf.conf</span><br><span class="line">$ telegraf --config telegraf.conf</span><br></pre></td></tr></tbody></table></figure>
<h2 id="TICK"><a href="#TICK" class="headerlink" title="TICK"></a>TICK</h2><blockquote>
<p>Collectively, Telegraf, InfluxDB, Chronograf and Kapacitor are known as the TICK Stack.</p>
<p>The TICK Stack is a loosely coupled yet tightly integrated set of open source projects designed to handle massive amounts of time-stamped information to support your metrics analysis needs.</p>
</blockquote>
<p><img data-src="/picture/influxdb/influxdb_tick.png" alt="InfluxDB TICK Stack"></p>
<center>（图片来源：<a href="https://www.influxdata.com/time-series-platform/telegraf/" target="_blank">InfluxDB</a>™ 官网）</center>







<h2 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h2><h3 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ curl -sL -I localhost:8086/ping | grep -i version</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">X-Influxdb-Version</span>: <span class="string">v1.8.2</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="控制台"><a href="#控制台" class="headerlink" title="控制台"></a>控制台</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 输入如下命令，即可进入到 InfluxDB 命令交互的控制台</span></span><br><span class="line">$ influx -host <span class="string">'localhost'</span> -port <span class="string">'8086'</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="建表"><a href="#建表" class="headerlink" title="建表"></a>建表</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">&gt; show databases;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">name: databases</span><br><span class="line">name</span><br><span class="line">----</span><br><span class="line">_internal</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># CREATE DATABASE &lt;database_name&gt; [WITH [DURATION &lt;duration&gt;] [REPLICATION &lt;n&gt;] [SHARD DURATION &lt;duration&gt;] [NAME &lt;retention-policy-name&gt;]]</span></span><br><span class="line">&gt; create database <span class="string">"yuzhouwan"</span>;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">&gt; show databases;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">name: databases</span><br><span class="line">name</span><br><span class="line">----</span><br><span class="line">_internal</span><br><span class="line">yuzhouwan</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">&gt; use yuzhouwan;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">Using database yuzhouwan</span><br></pre></td></tr></tbody></table></figure>
<h3 id="写入"><a href="#写入" class="headerlink" title="写入"></a>写入</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">&gt; insert blog,protocol=https,name=yuzhouwan value=666</span><br></pre></td></tr></tbody></table></figure>
<h3 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h3><h4 id="明细查询"><a href="#明细查询" class="headerlink" title="明细查询"></a>明细查询</h4><figure class="highlight"><table><tbody><tr><td class="code"><pre><span class="line">&gt; select * from blog</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">name: blog</span><br><span class="line">time                name      protocol value</span><br><span class="line">----                ----      -------- -----</span><br><span class="line">1556438552229094000 yuzhouwan https    666</span><br></pre></td></tr></tbody></table></figure>
<h4 id="聚合查询"><a href="#聚合查询" class="headerlink" title="聚合查询"></a>聚合查询</h4><figure class="highlight"><table><tbody><tr><td class="code"><pre><span class="line">&gt; select mean(value) from blog</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">name: blog</span><br><span class="line">time mean</span><br><span class="line">---- ----</span><br><span class="line">0    666</span><br></pre></td></tr></tbody></table></figure>
<h4 id="范围查询"><a href="#范围查询" class="headerlink" title="范围查询"></a>范围查询</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">&gt; select * from blog WHERE time &gt; <span class="string">'2019-04-01T00:00:00Z'</span> OR time &lt; <span class="string">'2019-05-01T00:00:00Z'</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">name: blog</span><br><span class="line">time                name      protocol value</span><br><span class="line">----                ----      -------- -----</span><br><span class="line">1556438552229094000 yuzhouwan https    666</span><br></pre></td></tr></tbody></table></figure>
<h3 id="数据导出"><a href="#数据导出" class="headerlink" title="数据导出"></a>数据导出</h3><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">方法</th>
<th style="text-align:center">优缺点</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">通过 HTTP 接口直接查询</td>
<td style="text-align:center">简单易用</td>
</tr>
<tr>
<td style="text-align:center">influx_tools 命令行工具里的 exporter 功能</td>
<td style="text-align:center">并不能导出原始数据点，只能操作 shard</td>
</tr>
<tr>
<td style="text-align:center">influx_inspect 命令行工具里的 export 功能</td>
<td style="text-align:center">支持导出原始数据点，直接操作底层 TSM、WAL 文件</td>
</tr>
</tbody>
</table>
</div>
<h4 id="query-接口"><a href="#query-接口" class="headerlink" title="query 接口"></a>query 接口</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ curl -G <span class="string">'http://localhost:8086/query?pretty=true'</span> --data-urlencode <span class="string">"db=yuzhouwan"</span> --data-urlencode <span class="string">'q=select * from blog'</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"results"</span>: [</span><br><span class="line">    {</span><br><span class="line">      <span class="attr">"series"</span>: [</span><br><span class="line">        {</span><br><span class="line">          <span class="attr">"columns"</span>: [</span><br><span class="line">            <span class="string">"time"</span>,</span><br><span class="line">            <span class="string">"name"</span>,</span><br><span class="line">            <span class="string">"protocol"</span>,</span><br><span class="line">            <span class="string">"value"</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">"name"</span>: <span class="string">"blog"</span>,</span><br><span class="line">          <span class="attr">"values"</span>: [</span><br><span class="line">            [</span><br><span class="line">              <span class="string">"2019-04-28T08:02:32.229094Z"</span>,</span><br><span class="line">              <span class="string">"yuzhouwan"</span>,</span><br><span class="line">              <span class="string">"https"</span>,</span><br><span class="line">              <span class="number">666</span></span><br><span class="line">            ]</span><br><span class="line">          ]</span><br><span class="line">        }</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"statement_id"</span>: <span class="number">0</span></span><br><span class="line">    }</span><br><span class="line">  ]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="influx-inspect-命令"><a href="#influx-inspect-命令" class="headerlink" title="influx_inspect 命令"></a>influx_inspect 命令</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ influx_inspect <span class="built_in">export</span> -database yuzhouwan -start 2019-01-01T00:00:00+00:00 -end 2019-12-01T00:00:00+00:00 -out yuzhouwan.out</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">writing out tsm file data <span class="keyword">for</span> yuzhouwan/autogen...complete.</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ cat yuzhouwan.out</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># INFLUXDB EXPORT: 2019-01-01T08:00:00+08:00 - 2019-12-01T08:00:00+08:00</span></span><br><span class="line"><span class="comment"># DDL</span></span><br><span class="line">CREATE DATABASE yuzhouwan WITH NAME autogen</span><br><span class="line"><span class="comment"># DML</span></span><br><span class="line"><span class="comment"># CONTEXT-DATABASE:yuzhouwan</span></span><br><span class="line"><span class="comment"># CONTEXT-RETENTION-POLICY:autogen</span></span><br><span class="line"><span class="comment"># writing tsm data</span></span><br><span class="line">blog,name=yuzhouwan,protocol=https value=666 1556438552229094000</span><br></pre></td></tr></tbody></table></figure>
<h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><h3 id="Doc"><a href="#Doc" class="headerlink" title="Doc"></a>Doc</h3><ul>
<li>Data Management - <a href="https://docs.influxdata.com/influxdb/v1.7/query_language/database_management/#create-database">CREATE DATABASE</a></li>
<li>Line Protocol Syntax - <a href="https://docs.influxdata.com/influxdb/v1.8/write_protocols/line_protocol_reference/#data-types">Data Types</a></li>
<li><a href="https://docs.influxdata.com/influxdb/v1.7/tools/shell/#write-data-to-influxdb-with-insert">Write data to InfluxDB with insert</a></li>
<li><a href="https://docs.influxdata.com/influxdb/v1.7/tools/influx_inspect/">Influx Inspect disk utility</a></li>
</ul>
<h3 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h3><ul>
<li>Influxdata / <a href="https://github.com/influxdata/influxdb-java">Influxdb-java</a></li>
</ul>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt=""></a></td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>大数据</category>
      </categories>
      <tags>
        <tag>Kubernetes</tag>
        <tag>Helm</tag>
        <tag>InfluxDB</tag>
        <tag>InfluxQL</tag>
        <tag>Telegraf</tag>
        <tag>Grafana</tag>
        <tag>Golang</tag>
        <tag>TSDB</tag>
      </tags>
  </entry>
  <entry>
    <title>散列表</title>
    <url>/posts/31130/</url>
    <content><![CDATA[<h2 id="什么是-散列表"><a href="#什么是-散列表" class="headerlink" title="什么是 散列表?"></a>什么是 散列表?</h2><p>　散列表（Hash Table，即哈希表）是根据键值（Key）而直接进行访问的数据结构。也就是说，它通过把关键码值映射到表中一个位置来访问记录，以加快查找的速度。这个映射函数叫做散列函数，存放记录的数组叫做散列表</p>
<h2 id="为什么要有-散列表"><a href="#为什么要有-散列表" class="headerlink" title="为什么要有 散列表?"></a>为什么要有 散列表?</h2><h3 id="可以提供快速的插入操作和查找操作"><a href="#可以提供快速的插入操作和查找操作" class="headerlink" title="可以提供快速的插入操作和查找操作"></a>可以提供快速的插入操作和查找操作</h3><p>　不论哈希表中有多少数据，插入和删除（有时包括侧除）只需要接近常量的时间即 <code>O(1)</code> 的时间级<br>　实际上，这只需要几条机器指令<br>　哈希表运算得非常快，在计算机程序中，如果需要在一秒种内查找上千条记录通常使用哈希表（例如拼写检查器），而树的操作通常需要 <code>O(N)</code> 的时间级</p>
<h3 id="编程实现相对容易"><a href="#编程实现相对容易" class="headerlink" title="编程实现相对容易"></a>编程实现相对容易</h3><h2 id="散列表工作机制"><a href="#散列表工作机制" class="headerlink" title="散列表工作机制"></a>散列表工作机制</h2><h3 id="存储"><a href="#存储" class="headerlink" title="存储"></a>存储</h3><p>　使用一个数组实现的无序符号表<br>　意味着，数组创建后，难于扩展（某些哈希表被基本填满时，性能下降得非常严重）<br>　要么预设足够的空间，要么定期将数据迁移到更大的哈希表</p>
<a id="more"></a>
<h3 id="查找"><a href="#查找" class="headerlink" title="查找"></a>查找</h3><p>　首先，用散列函数将被查找的键转化为数组的一个索引<br>　其次，处理碰撞冲突</p>
<ul>
<li>拉链法<br> 使用原始的链表数据类型来扩展 SequentialSerchT<br> 为 M 个元素分别构建符号表来保存散列到这里的键</li>
<li>线性探测法<br> 用大小为 M 的数组保存 N 个键值对（M &gt; N, 依靠数组中空位解决碰撞冲突，此策略的所有方法统称为开放地址散列表） </li>
</ul>
<h2 id="散列表在-Java-中的相关实现：HashMap"><a href="#散列表在-Java-中的相关实现：HashMap" class="headerlink" title="散列表在 Java 中的相关实现：HashMap"></a>散列表在 Java 中的相关实现：HashMap</h2><h3 id="java-lang-Object-的规范"><a href="#java-lang-Object-的规范" class="headerlink" title="java.lang.Object 的规范"></a>java.lang.Object 的规范</h3><ul>
<li>如果一个对象的 <code>equals</code> 方法做比较所用到的信息没有被修改的话，那么，对该对象调用 <code>hashCode</code> 方法多次，必须始终如一地返回同一个整数</li>
<li>如果两个对象根据 <code>equals(Object)</code> 方法是相等，那么调用这两个对象中任意一个对象的 <code>hashCode</code> 方法必须产生同样的整数结果</li>
<li>对于不相等的对象产生截然不同的整数结果，有可能提高散列表的性能</li>
</ul>
<h3 id="HashMap-失效的情况"><a href="#HashMap-失效的情况" class="headerlink" title="HashMap 失效的情况"></a>HashMap 失效的情况</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.yuzhouwan.hashCode2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PhoneNumber</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">short</span> areaCode;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">short</span> exchange;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">short</span> extension;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PhoneNumber</span><span class="params">(<span class="keyword">int</span> areaCode, <span class="keyword">int</span> exchange, <span class="keyword">int</span> extension)</span> </span>{</span><br><span class="line">        rangeCheck(areaCode, <span class="number">999</span>, <span class="string">"area code"</span>);</span><br><span class="line">        rangeCheck(exchange, <span class="number">999</span>, <span class="string">"exchange"</span>);</span><br><span class="line">        rangeCheck(extension, <span class="number">9999</span>, <span class="string">"extension"</span>);</span><br><span class="line">        <span class="keyword">this</span>.areaCode = (<span class="keyword">short</span>) areaCode;</span><br><span class="line">        <span class="keyword">this</span>.exchange = (<span class="keyword">short</span>) exchange;</span><br><span class="line">        <span class="keyword">this</span>.extension = (<span class="keyword">short</span>) extension;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">rangeCheck</span><span class="params">(<span class="keyword">int</span> arg, <span class="keyword">int</span> max, String name)</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (arg &lt; <span class="number">0</span> || arg &gt; max)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(name + <span class="string">": "</span> + arg);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> prime = <span class="number">31</span>;</span><br><span class="line">        <span class="keyword">int</span> result = <span class="number">1</span>;</span><br><span class="line">        result = prime * result + areaCode;</span><br><span class="line">        result = prime * result + exchange;</span><br><span class="line">        result = prime * result + extension;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * If u put the param that is not Object and forget use the annotation that name is 'Override',</span></span><br><span class="line"><span class="comment">     * the equals method loses efficacy and u will find the reason hardly.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="keyword">this</span>) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> PhoneNumber)) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        PhoneNumber pn = (PhoneNumber) o;</span><br><span class="line">        <span class="keyword">return</span> pn.extension == extension &amp;&amp;</span><br><span class="line">                pn.exchange == exchange &amp;&amp;</span><br><span class="line">                pn.areaCode == areaCode;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals2</span><span class="params">(Object obj)</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> == obj) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (obj == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (getClass() != obj.getClass()) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        PhoneNumber other = (PhoneNumber) obj;</span><br><span class="line">        <span class="keyword">if</span> (areaCode != other.areaCode) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (exchange != other.exchange) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (extension != other.extension) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * if u do not rewrite the hashCode method,</span></span><br><span class="line"><span class="comment">     * u will get the different hashCode when u init the same object, then the hashMap will work unusually.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String... args)</span> </span>{</span><br><span class="line">        Map&lt;PhoneNumber, String&gt; m = <span class="keyword">new</span> HashMap&lt;PhoneNumber, String&gt;();</span><br><span class="line"></span><br><span class="line">        PhoneNumber pn = <span class="keyword">new</span> PhoneNumber(<span class="number">408</span>, <span class="number">867</span>, <span class="number">5309</span>);</span><br><span class="line">        m.put(pn, <span class="string">"Jenny"</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"pn\' hashCode: "</span> + pn.hashCode() + <span class="string">" - "</span></span><br><span class="line">                + m.get(pn));</span><br><span class="line"></span><br><span class="line">        pn = <span class="keyword">new</span> PhoneNumber(<span class="number">408</span>, <span class="number">867</span>, <span class="number">5309</span>);</span><br><span class="line">        System.out.println(<span class="string">"pn\' hashCode: "</span> + pn.hashCode() + <span class="string">" - "</span></span><br><span class="line">                + m.get(pn));</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>　如果没有 hashCode 的结果：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">pn hashCode: <span class="number">909751202</span> - Jenny</span><br><span class="line">pn hashCode: <span class="number">104885374</span> - <span class="keyword">null</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="处方"><a href="#处方" class="headerlink" title="处方"></a>处方</h3><p>　1. 把某个非零长数值，比如说 17，保存在一个叫 result 的 int 类型变量中<br>　2. 对于对象中每一个关键域 f（指 equals 方法中考虑的每个域），完成以下步骤：<br>　　a. 为该域计算 int 类型的散列码 c：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">i. 如果该域是 <span class="keyword">boolean</span> 类型，则计算 (f?<span class="number">0</span>:<span class="number">1</span>) </span><br><span class="line">ii. 如果该域是 <span class="keyword">byte</span>、<span class="keyword">char</span>、<span class="keyword">short</span> 或者 <span class="keyword">int</span> 类型，则计算  (<span class="keyword">int</span>) f</span><br><span class="line">iii. 如果该域是 <span class="keyword">long</span> 类型，则计算 (<span class="keyword">int</span>) (f ^ (f &gt;&gt;&gt; <span class="number">32</span>)) </span><br><span class="line">iv. 如果该域是 <span class="keyword">float</span> 类型，则计算 Float.floatToIntBits(f) </span><br><span class="line">v. 如果该域是 <span class="keyword">double</span> 类型，则计算 Double.doubleToLongBits(f) 得到一个 <span class="keyword">long</span> 类型的值，然后按照步骤 <span class="number">2.</span>a.iii，对该 <span class="keyword">long</span> 型值计算散列值</span><br><span class="line">vi. 如果该域是一个对象引用，并且该类的 equals 方法通过递归调用 equals 的方式来比较这个域，则同样对这个域递归调用 hashCode</span><br><span class="line">　如果要求一个更为复杂的比较，则为这个域计算一个 <span class="string">"规范表示（canonical representation）"</span>，然后针对这个范式表示调用 hashCode</span><br><span class="line">　如果这个域的值为 <span class="keyword">null</span>，则返回 <span class="number">0</span>（也可以设置为其他某个常数，但习惯上使用 <span class="number">0</span>）</span><br><span class="line">vii. 如果该域是一个数组，则把每一个元素当做单独的域来处理</span><br><span class="line">　也就是说，递归地应用上述规则，对每个重要的元素计算一个散列码，然后根据步骤 <span class="number">2.</span>b 中的做法把这些散列值组合起来</span><br></pre></td></tr></tbody></table></figure>
<p>　　b. 按照下面的公式，把步骤 a 中计算得到的散列码 c 组合到 result 中：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">result = <span class="number">37</span> * result + c;</span><br></pre></td></tr></tbody></table></figure>
<p>　3. 返回 result<br>　4. 写完了 hashCode 方法之后，问自己 “是否相等的实例具有相等的散列码”。如果不是的话，找出原因，并修改错误</p>
<h3 id="冗余域（redundant-field）"><a href="#冗余域（redundant-field）" class="headerlink" title="冗余域（redundant field）"></a>冗余域（redundant field）</h3><p>　如果一个域的值可以根据参与计算的其他域值计算出来，则把这样的域排除在外是可以接受的</p>
<h2 id="ConcurrentHashMap-如何实现线程安全"><a href="#ConcurrentHashMap-如何实现线程安全" class="headerlink" title="ConcurrentHashMap 如何实现线程安全"></a>ConcurrentHashMap 如何实现线程安全</h2><p>　ConcurrentHashMap 中加了 lock 的方法（<strong>scanAndLockForPut、scanAndLock、lock 用来添加锁，并使用 try-finally 释放锁，以及使用 sun.misc.Unsafe 提供 volatile 变量</strong>）<br></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">+ java.util.concurrent.ConcurrentHashMap.Segment&lt;K, V&gt;</span><br><span class="line">    - scanAndLockForPut  +  unclock</span><br><span class="line">        put</span><br><span class="line">    - scanAndLock        +  unclock</span><br><span class="line">        remove、replace</span><br><span class="line">    - lock               +  unclock</span><br><span class="line">        clear</span><br><span class="line">    - java.util.concurrent.locks.ReentrantLock.lock()  +  unlock()</span><br><span class="line">        size、containsValue</span><br><span class="line"></span><br><span class="line">+ java.util.concurrent.locks.ReentrantLock.lock() -&gt; java.util.concurrent.locks.ReentrantLock.Sync.lock()</span><br><span class="line">+ java.util.concurrent.locks.ReentrantLock.unlock() -&gt; java.util.concurrent.locks.AbstractQueuedSynchronizer.release(int)</span><br><span class="line">        writeObject(Serialization Support)</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>sun.misc.Unsafe.getObjectVolatile(Object, long)</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">get            <span class="comment">// manually integrate access methods to reduce overhead</span></span><br><span class="line">containsKey    <span class="comment">// same as get() except no need for volatile value read</span></span><br></pre></td></tr></tbody></table></figure>
<p>readObject 中读取流中所有的 Object</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// Read the keys and values, and put the mappings in the table</span></span><br><span class="line"><span class="keyword">for</span> (;;) {                          <span class="comment">// = while(true)</span></span><br><span class="line">    K key = (K) s.readObject();     <span class="comment">// java.io.ObjectInputStream</span></span><br><span class="line">    V value = (V) s.readObject();</span><br><span class="line">    <span class="keyword">if</span> (key == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">break</span>;                      <span class="comment">// 只有达到这个条件，才可以退出这个死循环</span></span><br><span class="line">    put(key, value);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt=""></a></td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>语言</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Hash</tag>
        <tag>HashMap</tag>
        <tag>ConcurrentHashMap</tag>
      </tags>
  </entry>
  <entry>
    <title>有趣的数学</title>
    <url>/posts/4534/</url>
    <content><![CDATA[<div id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">
  <div class="hbe-input-container">
  <input type="password" id="hbePass" placeholder="" />
    <label for="hbePass">Hey, password is required here.</label>
    <div class="bottom-line"></div>
  </div>
  <script id="hbeData" type="hbeData" data-hmacdigest="f96e72fd0b38c1641d8234aca6cdd99b632831f22468d29d9ea70fd075944fa3">893042752b8a3870659112552e24373a4e285f6f797c2b7ec6dbab2c8ecc86252729ec23d96cfd01d47305a9be1287b21858eb4b23080b8263368efebd8e293feb6ed7ac1429f61542e9cd20a7d9a10aaef02b87cb4013462a7921988c13d09b96b1a5b746549c4afe15581c7a3d1e4a895913440f58738c1676520b3841cf952dfacc36d06b8d3600163485edd7ce50fa4c9bbdda215aee2ba0678d8cb9f0de5733517102d678588f8348069a2dc19fd4f6de623677b37a489f60be184eb75b83e2b8320a1f9c8b5bb34ed80aba0eed5363ef9b5d4aeb26018123c9c83eb0c2acb45465bcacc300378f61c8bcdfa5d51a65c6ce23decd634a3afc994ae32d7c8b20a8ce63c422039f0633b5122d7a42785684df1c527f3061a248500db860f27e158bc17fe7caa2b402c9fa7d61ee4de8f8134785b6488f8bda87e1adc8234c073b643b0c2fa59d002b877c4fd48f4b9c3631e307e5f19a9520d3f5004251283cdc06d47e6c5df5229c4fa788e5215085aff4c6abd4c6a0d924f1cdd7413a29d87d955ad42ea475e973e1a03ec5bb4e80b469870e210172bfefc239e5ee46e670fc3bd1552f3ac1cec174a063d2e597e4a85f531f420318ae302a88c556efe835324aa18e7728aa61d4dc5aac52c7672b5bc07bd23b763807a57c69a9154999e0f236121c028f43808de58e0e20e0653a699f40bc618122a60c4177958b70e587018dc60f708878ef374db17b3887addd316d55613cba42dff058b04946768ea262088a64e379d60f53ba6d359eaef3b7c9a869432d3b545d65e8cf0c27a65dd7bab460f1ae0e5957f8f8105df7589aa0a99462d48714ef09c7fd1611988e9733dacbfad86d24ee218913da756c2bda0c1c09dbe990068ece42640fb042f4aa148742f86bbd31d8edf2deeb192512f4b4e9107d44986b234f51a45d9336d106233258eb450097c091dab30a4072f1c16f58b0e7dd3683bbbbf8337b724c4249bc8a0c2fc187ee6334638f24667e1890253d449afe2be8086a382b8cc024bef779b6f9d4d399c66fcaea8099d6391bd114baf96ad6bda809e936a84bef5ab3355d64f53f36218a32db71c7efda894224f66b29f0f24fef763d286c227c1113fe73ea3f63bf40d3e23fa9e50b6c8a9ce4f439f8393c7420ffe9c4169b6b578680794b681d2e95ea86e3bc8126bdd261e861b22e33a01fab1d9662d8f22fbc92465c037766335dd463d5fd17117269ef8e24d52d64fcb0a9dba2c710561c809ffe79d5c7b20664862935208451586ed9e59deabed78bd6966d2b25bdccafba4836bdfc5de5072124e0bffa5c2a3847aea7bd88d2c73a37aee17d5927b961994852136680fe8ed1b7331d7f1b2c01798b51638779a1014b9667fb4b49549a13230295cccb05e56089a62bd6356ff50226f38a12d15734209669b330dee509185862364f6b265318418c8039473eec967776f00582774e7e3e4e2498ecbef529ec3bf4dc63bc9347c699ce33746ed55894670141383123f0a43c4d2bc13d6613456b0acf66c1c3b8d5497495911fedba3afda47ee83f9efe36256c71e6c06cbdef6a1bac45b83598d3cbf558c643223bc88aafbaa66a8e2a4adb2c4ff50caa278ac702b4c75c94c6cb30ca5ba5a2fec4f09aae235fedf1cf59bf96cbc758eea4b2f5b1d131d9d9cc712054754f04574269ad00214117f2c8e80c43d05a48343048142b9ce9e8cdbfa56fb1c387588f324b883c5ee137db9ece1ad5be3bd26ccb4dff43c917e2e1a509c07a7a1d495fa09345f256be1c95ab7822beecdda3eaabf7064486f6ac52146d7bdce5a798ec081d340def5cb8a4647dd9f418c5be6bba428d1172648d08450df28f32f976b1b41f62b3aae45fe1a60078b8d73b1187c2645bbfcf96ee22e7dd97d9537fc25e2eda273d6f8b3a967cf79edb8626666ac57bce211ef81850f9f54ce5035f2dbca001efe9ee80b203c90010a4d469ce147d9ca908416c8ab043851137af95086abe7227d2edc46b59673e5df021156ba29c7941f38ed820ff1f831664e78967c20e293ea2912afefeb1a5f4c103520adcc41e0e7f09543203d196886b46876eea6ec6055a3f5e1d326ccc4f7668d4ce0350fea40d1fd369be560682c6b9070d2cd7f5629911a6f9e01dc637bfa152edc205b23cab92c09d936f01793a72fb9e4706dfdbb3bff6206dd0758a4716c4bf88c12bebe71d36675d0448daeb81fe8edb8ef95944f4d310042b857eaea3da7f9c8ea854045fd3dce9a2b8f191b0d3f6b9d7358c284c374350bdb36e11e77119ea92de777fb6edc92ba985e56b4f74cd4c82eb644435ee8c39399033fccd1bf664958ce3f72656f3802e7a0241bf06d74a93e40a53f8514ed9944860b9f76544cd7ad736c6861776b8c467970fe080188839f4fea176c5cf6251496b9aea34b2d7ece535db0ba6c87367430b30498cf6068e560680eb903dfe3f0fa1704ca1df7f0d03fba211760250b21e16858090e1879480e55863903b3fb1c2797ebcf3f0d420c537fb11258783c360e147cbe1b1d5184a9c0dcefc73515210f3270735d878e5e4c93978e63ea4967cf42e98cc232a19ef1a0fa1dd6c4275d3c4befc3bc88a6c80487e0c5f961fa89c1fb46c334fbe2bf2a937d9dbe94203084b288c22f0100bcf3ebc2b0be020d28e56ddd1f674a35c167fe1bdf456ec46ce1c653377cf026a1538d2f3afd2ee75e495c4fdc61d74914bda2fe64c91f2460514ced76a47dd0f725e3488b8bc77529e963a0cc2ea92aa4150ce393b9145c5b97e45507a894b7fc2d5c49c54d645c26703e6fcfe85e9be91b121594c62b3a21af87443fb15e7b52f76b93a47c96eeccf12eac90f528b34eea22ef8de528c4b36400923337460864b3f70b72b11387c9f7f024bf7162dd29022791faae9c87d53022ff11afb4869b216f74153666f9f479dbc975219290798977d72b6201be577c53ef5b5655b017e1f0ae45cd3a511c77c627e0cc35152c04f3705cdd8bb8a0c199bdfe5182a5a680590763e865c5a3e8435287d9b91e494e7b20eccb320072f8c48bc7f4cbce89084af1c6699d84d5e083d9e43e00fff9dd82fc7ec06d3a21849fc112e7751cebf60d7b651e9d7d63eb5d2355bd631025b77b969ad0b9bc055576d8baf3e6c7b7c34d849f7ca21b5241792b57e98901ed5530c3d85876117bbe2c6407ba1419c491cc597c1c85c324b7644d31689e6ea47b3020108e5d1d85079701d79baeaa70bebcac324f42a7ead7343812313eb0ad630854bcd63a03baac5851bf2d5516b3c9f794ee7d88bec7c93e3a0d75b3926b06a8ac99a50941ff2f44bec4b8482fd7e6cf6a4a92c6fb85e3040eef6aede6a44d6f1efe377734abd8be9213103237c7ae73894cdb6bbfe4da7e87f588a00b95d9018019d2cf7696a0e296aff509bfc040628dab32a14d61cce2490e30501341b70b22a51b4d9e8926bd857f79e6469926e15a20dd25cb9e4a6afbf0dac76422420917bf2a809ad07aa60facf02acc4332ea9a38e9a96b8720aa191d639b89b99ba80bb60865af491655ce533267fb28dc6b5b5afc414a60051dd20c9c7b4b51689f59e33a7def1be6a170fc4e49be3279a8318f66eb9d8c22615fde91bc69485b9110ec2dea7c66195ee3c3c00a0203ba0a1477fde326ac2f17fdda86fc606242f8195672f75780549545b91b8e73f6477b54931039037ca5058ea98220be2752fb140a1e0530c5cfd906cb22e009adb6b27c5be24c611cee288294c47a56dbda59b65a4242de7278d4108f9c0fc908b1dbd6e5112fc7f43867770ee26e4fecadf9ea3eaa3617337075e85917b75c79c103fdaa5df112869a3e41541b721378396933123e4dd94f6b54045b855ea9f8f44c253edca9d36655e707f792db0f54613e29d6d2dd43543905f8e87519f1c539991655afa725df9b005bcc0673d2fbe5457aca01ee21356c597c437ca0f5116e914b63cd5d60309a38265bce20ed17ffc1b2cb67f137008178a70cd1279e78f720f408d8a7b27a7cabce0786b22011699c6c18dbc0cec12e3839011bc0b0154adcab046fcc1621b1714fab2434573a5825bcff2393a89eff2fbd7acdfc9a23699c0fe9a4e41a12e9ffce1ee56adfe27c61e735f3dd13e3a64ca93e27f4c14bc9ee496bf0e185c522df69995db744baa5d69bcbc932f8ecd6036062270c0c98734c5fe179d169d7664516f0cfae2287c47e512c446ba04d078b491b89c0dad9546386f769117b050ef5d10d96267c06f5f9cca0fcc26aa136ab1ecdb77247b9643cc857269422ee8bf0ae18fd9693f2f43b93abdb1585a1ca67a5459f62b93ba99a28be9189475085f7203468dd5ce2bbd2c83628d5264da848b75cc8a65dcac473d8109ab350d4fb97ca75d22407b96fed3dc848b40a154c8e4cbaed3aaa897f8acaf2291bb9a25ddaeffa54b31afaf94a949b6f1bc89fa8f88b0170e4b0769bb78932af9a15c24526f8e4bc30eec16955d9f7c5f176ca89e8cd4965f7343a32b9421db8145858460ccf9596b1749dd7f5e7947a1c64bc42a13d1145e7d1d35b5f5868f2bd1662d346fc929b67c94d4756264874c18296631b94c0539cdbb7a9c62b16dd5df97e485faf7aadfbc29c604ef4fe73133b7a18a4180fe71de55d299b371370f88de2070ffc138fd7fa77e461ca1cf8b2b0b695147c0ccd53f06c87320ad4a123f1feb10aa899051dd478142512736d031d5080fb0ebd41b955422f449a9458865133ec340c546ce8a2570b6685330e2b6e9a560d33050dfca4c33ae2428686a40ebd150224eab22f77a87526f91d3dd314f2f7853630a6b3a46fc1d78088da00bb94844307854cb3129e9484eb86045c70f8bb9c64b5702cf6f358cb76fa25ed9279814d9d182db7ebdb012f89b7b4709e0998247dce45bcbd0d41508f981febe68726974a5f30e6ac84e373f6008fba9fce3ca99c4c1c9335bc796393aa0fafd87e42964c94ee980a9eec02808214f692f4b092aac1de2f4adfe6a880cde69d1362fe944d9f5813f56e7cc00787d74383841b4bc1899bfd54a95aa48cf8203f211bc53398488ce60ef72da1545d1e6ff35ed8b7659ca407c574cf593d5700da08c9b2def33d4fb0037a386b9ab5d35567786a579f8fe2e46e1b76b9594e5a066e4b5e293c92c30ae5e0be8a110e5f27d0e34a301a59804aaef4f788836b9e976f984a610f48c0e9526ccc26d3c78cb1e5a4afb2a4ddf130b7841b722c5cde77fbb50c38dca09a885a138667f9f12650da419022d327528a584e8f015abebf9abd1a198aca4a408b10c804c6538012529e190e87814c6f7b40f298355c4425e332e561eeea1e757cbd8f52dce08ad483fe4753d73a73cea0d81442012a9d61331fe055e1643b1763cc2ebce296abf6a1a610c4369b7eb177613398ee4056382f423773c86ea0b0ce63a7ec4c1ae2fb1afc8ce54d8d11f16e77dfb9559a288e096c2171185bb05afcf071cca51b31a0223f2137a2396a138379b0f397d53d50c46a99721a536687af002f1de8226beb9d742328a540a5891b8b41ee8c862afcc6cb71bc768fd6d0b2d5d5425a255bd30d1c506c4a5cc2b3167472a7eb405b5a96fd0e27a95892d37f89c9f54a1310f8cc6d480c9bba45f0e5a9eba2c7bc1663592c0c7f6c4f6d8992dfc36c5b27bb03e25d8955905ada3eb88ff0375a69f3a5c531272c85df984a1cff35ff53a892e47e234195cadced1e0c98d3abea04c360c741585845c364949d9ae24a525ccbf43d7ab05a893e6b16a3322c5087c106bfd335ce6cd817b387ba195e12042c01244241597eda209002b035ff147ae4e5d96e29b69868f571628b7af909530aa2b278e0743712eb5234c7ddb7279ff75bce830319d3de49ef26281f331eeda7b3583d985633dd7f5477e66d6e90d19afdd084a11fc2edfc31fab1c659f024ade22775f3656fdb5aca687abd8f7e25a73351083b8a5ef216470ba00edc2530efe11637d5887c66a5cab3ced64fa9e833f3a9f90347263fc072ee8fc83b9eb5f26586039ed0ed0dee34456da9d5b241693c5e7264146f1e4cd4ef68f85ccd8ed09c29f05d80d338405f7d22d3c1c917c4f83f4e0e8845d3979dc36dc83cefba60ba202b592bcdcc1287b8f42c0ca5c9599b4cf715ffaed6160d52be5b442651d480839b7b54da7e65c58674f8fb47c655be878fdb5e5c9016c9a843a57cec5360e020990b3092927530c9922ce49a25e27d708f41da5d8ec1b36dc234d919bd3b427bc45a4be1ae11c468ce98348b30bfe5cb8e1b8c17ea49e97cd9e6f4b3354ad150aff5025b4270664fbb6d9f6579cf9e3acdc58e64ad47445e80d2de29c79fb98980236d6ec0b01906f0b6c8d6b13310f0629dc59cac97fd92f8a8c71323316257cb1c099f401988247a2d470d2ea9b956adea1b1f964f1f41a0463788507df021cf0552ff2390012339f80480e62c4930ea1daa0f45b5e08d4241c84a3104ea70ee904ed5b195b82928b75f9d1b60e90823dd3e14bc5393e9ae1175533a6e1f21c0cf24867324257593a6e868675ece8ac73c79e0134e22c95686e2c32a2ae554a03d7bce6a8eeddf526e565d66b97317fa5e31cadcdfe5728f2f622c9898a6b8748d4f3386b4ec366f46ccb6d38fa726e7ea295f09407dff7d0933264d7eb29ab541d5573aae2782b7ed5ae789bcfa0e7a8e99617e3d272e825995c8d03f24c7629c5bf925080e33101118b5f0424dbea9c0c8392dc6da3f3b7b1ff16b99d72df8e8fb62fdc5a365a470d45e720b2c9bc202f94517440f595d5b7d9a177b022f4578fbb90622912755ff5b4ce04707a846f59df1d9f20c0c2337581177f923992fd029b525039657683d09db1c649f17796429983b3efb89c7873496c4616a21f7275fbffcfd3869298bcd0cc2a4b66571e0deead96bdce8b746469c48473565b354ae79b8b42d2cd070275e95f5bb36ead0ae4ad2789f08f522e95111c8c14e852416bdaa053e053e383b78bb946aafcf2a07797561c7ed9b8a95aa3f6dec73af33c2c85c4cca4565be970fae54cc85ba1b1b3b3f6931b07bf8cf9ba053eed3102eb1dfd42629eaa89df7a8e8a659145e3a0973ff2cfcafd8b7b5ec82ec1f9cf7e76cdc479463d6763c28371c645f258a6cadea7c732bf40d9a616bb98005d150f1e2a3b545f334f7674bb85cb625c6951f941c1deae3988eeb18ac3fb6f7d8e6b7382d78021817ea318cbd776a7f44e0bd8dbfdebb135af9338b3ca6a92aa0d8404098a1c638d7061b5561600334a20f3f5ae874b314bfc0f671b40f227e884776975f447517eb5e78ed6365dc99497de8017a0e53fc124ed0ab2e8df30daec459ee439e3aaf24a05b31d96ad94f8b2acba60ec29ad58c18f5040cefbc7f785b8659ba5b93e589de7339f991e7b80fc1f65d956ed69d4677c65d4578fb23daf6aa56065a26aa4c311c1e20250fe9940e1d0812bfa47aea819700caf367b5e39792431b8dc1713acb6d06a456f53d5a46c3b98e7229d4751ae9c01b3350e34554d11b0ffe24aa943dbce07de0d5cefa4459898be70a191e9e6c3188308884e53cb2d63fc1d5eba69c182e6bf31e7eed0457b64913e77a79678def6a4e8f677d0fa004b1a3cb0353332f441dd9fcc3b95d4655622b9c9716cc0630850f9bc9b53c9619b17418f385a2e9fb0f6ca46a1ec7db55dac84957c0685d8b1e764c11877ad92409c50ceb3cbb0451fb48eb79cab64e1e267d29b25b33c5b1d0e68b227bfcd70f96c4d24453e84d449f6f181acb39c9a703ab95c7f451609a9ef454dfe17de9fd822eb3352b7e3fbddab31b07332ec3bb45f8584dcb676034e934898e5c4a5e699d4de7beba1f7058f5eb60428c828e70bd07f34114ff562e391a1448debf7b3ba3474c3a8c50243d49896c4016f2ecf876ee0f83ed4171a6d67b9ca6e2f05d6d53dc3810d6224b509bf19171432aa0f106fd359f292d797bbcc9e354ab212310d1bb5977efb50247a42691169f19d1c85c8e12bf6ffadf636645abe4b62c7e149ef28acc5182450448f842e30f0b136d3e721683b7dab81f117add2d8e0cb7e9db7e82b04782a9bdb871fd9c02643eab3cfd843b49b7d19b09affd5dc74d7368d17d2f6720661ffa64fb8976dee57e4bebafdef90834e1a4507d63a99a6e98e7d4450101064be13c8b4b8bfe11204b41ed6b6d31db26719e7b40bc674e3d85484f11844cefa638034b309f694d293e3d21da196564c0a062239c92d4c8dfb73598e9a91d7eebc344fc3b2f4d6275770c3c6725f679340b16a3fe8905b2e333a56e01376776155d689ad01eb03e0db5e7e4601026626b0ff0b2a4df60fe4ce445469801b8f0fb6531d7d99368d23f05aec00fbc71eaa8d4e4f7ab8aa4b867de815e2e033d7f379ba6461aeea7828cd2de4bea76a56ee8af2c9465b839b08b5306dccb4c286e15bb7b88b54f2813f9824d6b507e4c3f7df41824d8a3cec6e73d986b780044fa99bcd59b3556a8031124043d10c71255fa0105952150dce46d3aa29a2cc6d4544da0b6a3b391a0c66b2b9cf4bfb89b1a12b5ea3749c4f2fbf482fba92659f87a50e53d380c0813a9c3e3ab988c5e0afe5a7323e3e472800ee6de5ead696d8b74b7c63ada07156107dea54848c53cbcd85436f17c4018f2e670d6a8d537821ec33adaeaf418a2f065130916ef2a6f8ad1ddd55e9f4e89e2487c86ed3ce12ddfa4d787ee1756f7f349d4d4c8ea0041f3aa3157b2f3e510cfcb6f1ad06548d9c40d0d7ca1387462dcb4308d4ea7c8976199e935b19b30f4c51f24a58a929577806031212f7b75f979461f66ada7b3e311089c44a35017531f87e4a616163ff91b64d21e3f6faf79a332e6c42831327828ce923e54aea1a1a6eb51f409bfeec8189e121dd74d3cd6dfe13b44fe29e572d09d56fdf3c0146c2b0b1bdf837590800b25c3cf443eaad90fea6d36e3476039ff2da5cd923e525d800cc4b9517a9f0c0312530b80a0dbfc24c8981ad7e7dcf0a33aa071ecc970eebd53b14ef21abe5c57f2b14056c7e917b4bc95d5dca7273e1ce46148fe30795487292d76d722e199f7829129247654962a3f7d4dcb5298921a70e326efb0ce3d4760dc65779e3b3657be0cd3fe95411c817559cbf04744e7f17ad3c109e493c78d9c9b1bf1abb60676322528b44048e9842e5b656a556c7c3caa7a25715a6c92962e2e3cbcfca6ba7e0f721b6aa1be9f3e39a644222be353db23a78b3de474d3b18b39ae6901e4bfa1931595d41f70743dbd51a4a06f5dce961f5555ea8e94e27bb8788cf378dab0b92091335f552c8b5184d9f8a8e1b3f42f9c1295545d5b7b85ce00d4b4a500afae1c8b5ce5f6bdc84f202efebca6e2f4ed03f126edc50ca79a7f83dc99a5c42cbcc800db52444f89fa6da1fd25dfbbe9e1c4be7afdff3f0bc765037fb3b8a90b9443ee6ee92fbe27725aee33cbcbccced69a52957d095b18b61aee2e7345c5035b3db6f9186d31372f21b3800d485b196c222c5a9d14d96a9c5c6a5feab6237afb865fe5adf409cf2ed0767a63833ef65366611da809dbb4cec5f9750bfb6d9398844256d88bba7c1d771a0225d2880cfa8312d07cb6458ac7548f96ce006c8cd8c794c11d7202724a376c55023013d6854842cd17551dd8e1db5a8b466cb1f4a3eb95de2b9732eba35e2cb601c8c6cef4b3482ea86d1ec66297a11a5e896353e692fae9121188672bc64d1dfa854623b82ca05a8bbbdfb671ca06731e3448d071261814dd84c1f6fbdcdbe7e68c4cdf7623de33d4fbba4e7457e03b949a75b52b9dce2f63fac538ea1b39169b86da5205a8a5906fe19c04cc501361b9ffc7380ed22d0b0848ec50d909693242488c514032c7c6f584a46ba6278b50bb8646451e7203b351afbce463c20597488b41b724620e06009250bb8d0bb94f18a6500b013aafa375981a3f53d71269711fa7ad7bbe63be0addf36e142b01e5bac94378e3bdf781d0f5c20e86c51eaa6b40e4eee732f3497e2445f372586f103e2f6e27f8dcbda3ab8b86a86bf87275eb54c7aa37398061a659ed7b524e734e8568c199dcd852eaf9cfb4f9418f40b344ae4bc094278a85d4092965c21cd25be73d8f08b0c7ea8fa93e3260ff0c6b912fae80298fd8ea49dd8c8aa751d322532637ea6aa3fd103f91f56f453df68d0d3c1077c8dc0dcacac79568e63a669ba388ef0435108ff0191f0716310669dc3d08af399327ee8da3eabc4eab37b8d2fbd958a44f4c2c028aa14982f7b97fd28447694a567a2398fb1136916cc900f5ee5e82a344449ec1632e81fa6a8639a9efa12602b682148019c4256f571f532253b161f01c0c9e9eb971b4b21b39680dc10c2f3dcfb9529fa61f08df23d6747018e5bf4252145b6f67c606ac0584b0e0e76113bdc397c5ea80ca95bf77e17be72e605b1eb04b935d999fb91b88acf5b3e032c997d00d7c8aee3b6ac8243ff5a4ea1d8c5c524f2dfe2c86ee89b75b151725f0beee9ad9c3468cf66a00885a59f3934d9e510b75fab10996ded74473e7f55f0f86c57c1e674f547ef8fa3304eb050520b8c5ced3813cda36d8f7544e955bcc8493d9b764c72235a79e5bd4e58a0704130fcf33dcbd2010ede350baf13d4dbdeb83fdb3618fbc9e8fa9cbe4adc6b171f548517b5c2be4a7d88dfe11c6cac203989cbaaf80ceb4f62aa64f9ab0e24e289a7185c0a15e7d9fc55ddc30fd492c3cba928d6b5739d1a72002fb95e928c5d3b80eba533fcd448b63394573e51ba8aba6bb37a765152ad87e53b023ee919baadf6c5c4903c1786010cef76d1c7cbd5ea58b517f88c80919b5a1c3e8c13d9aaf767ced498ef276ed26fc6c9091165c94635aff7c04e4885fea5bf6c53692ea151ba044ceeb5631ba51025a2f44c905839f794858ed7bb6ee2bc5007e61fbea206eed8b51fb8677a4bfefb926b5cd58666e846111cdc2cc0558620ce082024b3c03e8afd681b4f1582551c3b53f768dc9e5779d6980f7d3eb5d35f847512761b78d34814206c75560e78564ad5a143f045fca2fedd14a56c07ec02d17a0a3690a5f9b79919d13762d835c4248d2663dbb0287fc3e5345dff62c61cc11536716bf7b70030496e4e26dea7693abd67ecf10a6a05423623bc58eb6a5150eae22643896de2a328e21c3eaf1a4422f23810d39d44f879a15265264c0472009b1c6c59309527d8b77b664acfe75aede90af29455d5d2a47ab19a65cb8750934fcac50d24d9e3b2ebfb64b259f1f5c42600384dc56239536d96e67b9acb80ebe65128a1355f68649e6f333aa7e62b5f3806476f5a91f5c1e7833d7b2ef2d1e977b9ce5a929b05470461b4025416a0a75bb79362c138185dfa83f82c3ab8a90986df56d76976e7133c7500202c9bff37ffe9a911daa953953c34a509e5845a50ba05f6177d141a33706c5eb48f7871773d8e849eafc93493638001508471e8f0a5821a28153aa2001ce9761fb309bf82900e823b43fb278ca8819ac093a0529b60d3c56dd90212fc412a3e56a3a2c9c4e08eb84f349afa11dcf39d3e1678c802aabe89e91b6c60a03a6557d6811cbd39d0912d4d34a5088771bf8a4faf109769a2c878bf0cc01996378ed5ffab0bc247f7c2e59297e7758073a8a23b5ed4a720f751292fd8c6c5324c69ca02cf57acdc49d46b97f128ef94742e58d823e1cf3e8f33b4483cc62904c5aa2bfb37294fcf7540d62ae6cf7d58d6e292ab206b72e578f38586e9d5ab5a88f344aa5e35c335102de1435760f90e1a1000a6db034f6530af4c8df183966ea34c6432e37b31439ef2a313174353715fcecfda15aea02d1701fa7e47434b87fe851faecc1b637f01d9d5dabc140e7acd2b2dd43cf63eefd34fc4324235865f618116f74ba87a4d4af405ec676c315980c5701e032e0ed5230f0dc0f8625e1736d3369da9430cd5428c68f820225c5ed947ec9660a68840dba3c8598baf49ebace673d79527381bd9631397369028ba6fafec1639c315937117335ea5d066b0323fa48df69ea17bd234a47558f3e94027d96bf7df83ee6937fb67cd12333f71afd43c3efcae37ed75b11011ece92d012574c900070b418bf52a527d48f10d1de841c4066c07156414361054e4c5edc41f05abf2dbc2b7a7e48392fe6829b09aa01a286e765fc8f2eff17b99dd72a655bd2e2e8fa449be96e7020c3dfaeb8a2b8952a27f163c56a06cb292310a2a2be2395e8fbc96c0345c5c0fcd7ca9c709186001e43dd10c7d0ebdd8f5667098d85e7880f71ba958f116cc59ee893b3a781448e64939bd882bf8959282deb3f40f91cb2266fe3f15236022333dce21ab5642996929404abcf0502403f2f5005a071169ff49b7c685aa7a7e02e3a54a83dfe785d69e6497af0eaa0d19df6c933a64d206409d9f009843f20ac031cb8547836fc82db0ec632da0bf1cee24d5630ac7a0cd4dfec8feb94d273ffd33791b5b6e3ae7cd0527c2418017cebaad6910bd080e155bb0bf5d5a256e79cfc49f006c1b73ead15b557f4cbc0174675c00bf17772dd0ab8301b1ab5cc468567d72cadbeb375c4c8bd8f48751d80c0afb48f54896e68cc612014979513ca4313b3236314cdfa138a349fd3f9e2e6fb66a6675df59697fdbe51b1d2b0333908d0a861118f263ea591fbe018de37e4c352eabb54ce95ca2b8054b47a445ce97a81ab8277340b00dde7d1ea0b45b86a99d47e610970ee764c676c207a3728afd8ad70a8e65f96b8961126dbe17b70d4402d699ecda34ec90c107f6d2f4836be471c478b504f59b9c26b0c6c36bca</script>
</div>
<script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
      <categories>
        <category>数学</category>
      </categories>
      <tags>
        <tag>Math</tag>
      </tags>
  </entry>
  <entry>
    <title>离散数学拾遗</title>
    <url>/posts/200307/</url>
    <content><![CDATA[<div id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">
  <div class="hbe-input-container">
  <input type="password" id="hbePass" placeholder="" />
    <label for="hbePass">Hey, password is required here.</label>
    <div class="bottom-line"></div>
  </div>
  <script id="hbeData" type="hbeData" data-hmacdigest="2aaa900262754fae643296daed864e13de681d496654bb9e954ac99a1828ceff">f436121a0ada49a2de093d06285ed9855173e099b731cc4184783c4c2044e1a5ec8d98dcfbdc512352d1a1be5fbe98b7fb40c255f967ddc7ecb6b782973df6d9db7d36dcaefd73c6367225901dd7c1a8addfa6352be0034d6a8d06185785fdc7a467fb0444fe2a3999894222a9e6faa499e120db0081023b2973a56e1de65ac68ac4ab45484828318fef27bb935a1c926f66bca4c3c467c39e9f8cfaa97bbf99a4b979d8d2e171cfc6f00b62502d4a5443d50e5ded45b16190b0b60912fd4f87f3bd75c820f4091d5d90e98cd6c436cc15d675740a30b6fcb5e9c1f6e409e12d0db67bd7a348f870c2b317ed6cfa4950a0aab973552ad729d6dd8dbf7abc44510d8f598cd9903fcca7534e1820778709ca9c5e70e357c92089495ccd47fb0e6bbd1c035534df0100941ad8976819a57efdc43772e68feae878032e7652e64fc88e72dd4fbf290a8dcb91a5115d914e1b414ef63564cf3434b5bd164785af14cf4ec72322fe4d26f3eb5b663a653ad0e215d24ec638f28351694861aa82caa845237645107f3e559349573e09f7e06d8d55a09fc57f77533d75158170b16bedf8d1d9b93645e29c740515605fa9535e1c85563468588fb6dad0d0b4e0aae00fcef8d9f9e1078ab5ba0ce22563abc1687c86644ea2005454a2b4654933d83f38483ec5dad3e34a627a70200c46741ff4f1fbfd561c9a2683c2fdf65c4a76c6b95fae4d62840ce1a4289fbcd6aea848c456f09487a7744ff03b23400180064ae644eca1874a98684cf53498637b5d49ef3180c6313fa59ac45fc62ab81cc7371ba89f1ac9ffea0b63f89940b9074a73c1c58597ffc813b8b85219ca8c41a5c57cbeae106338968dba9ff831fbbe62bfa2235aaa93c3f25d368ba92e1eefb4e8f249b882a053c27b4ef9b9fb6acc51ece79ac0dba0666fb773b3bfc46f12875147b011cf62377d1e4dc089ef738af97675510a389c4cade9448869cd30cf67c92067404b22cac80d711378078c92c9c65a454c6be5bedee510557eb33b738ac5da8ab8a4838ffda2cd8ce7b4a061a1b21e7cfdc645c392844b2cbb6a8339506fccd20fc47b6fdd7c6f8925f9ae04a003a2a5aaf43b86dc1ad955f4b75a368b752187b92546be4d5874e6a1a2c93498d928b257b4dc25ea80dcc618d1e99fab60b94c38d0e3a9b3b8183411b6b864d3aae386d294d1f75395610d8b39e89a7f1a424c9ee79445387e73211b10e09bfef65bb2563495fb4a8ff060412fc9b97385baf872c0057af6a907066ed0a6c6830b1d275137031b8c7fbb19adc56fb406d638c1c50c3148430b7925366e05188d33d9dc2a4a1b1e682d527617728eb943c5382b8b3bb3fb016461a442544a4e04e3cea31776fb8522cb9237d8a32ba846d430409cc946fb70cec074e99d04cb4e3c4aba79137bdfae7001475ea0e2c4ff09d957f2aff30b3aec430ed47fe67465a0088884dbef8a1ef9baae9d51d0c02b9359527d5753bcf41716e0cf3b9d0c2a70e0811dca3f0d6c7f6a5980e16623bc0bc7dbeb31b99b25fd9e75f3483cdc75caa0e41833adc6f416dd938fb29f88f78f29de5bada07d52933abf6a907609a5f42ebf58ee261b9c8715af0a1aa9339451b1d3c19d0af1b7610cbb68f00bcb2b16cf24eecceea362eee76c91a66852467301d0531282accba45bf06c50f184555e4ab444932329509eec96a09afcfbd01813226a8627c7ca326c98fad65f285d8bec0c77437eda2cac7ffe5fce83d3df7394a574cabb99bfa6ee3346db218efae5908553f08a0da866c510be5895e89bf53dc539eeee5a3cd8043aafa7a856a5dc46c6c3acf40fffad8ac596b4740279a92a5099cd452b652a16d9a644943b5f6e6e4adf4aa1978e6b47d74dc6ab1f144aa84d9a3f2ae35882c6eeb51e70a99c3d2682655c8b75d90cc5bf0d98ba05e70c17612678340b8ce06a949322c42b5f2169078da7b8eb110f67eacaeb797585335b4ae88481c18d191fb0962762477dd56be0d1df9eab472d66f3b8e1a1169a711dcbfa25f5fa4c957eb3029d4eead8d625d24341cacfb369efa9a9f6b16f5c0842da54292d0d81818cb778eaaef570d200e515ae031ea2e0b2dc801d4d54f692e715ecb24874c52794fe7a849a411604be70c490b0aaf2923aec542f5cea08101d9640183d124e992eea34bfdac555559fd06894d6f4674ee55cef74d028c4b34347c22385113f147cd2bf95321ee5de0ec6bcb3905c3472d5befc65b8382aac5d34651a2ab76a46be8350a355ef4d7a1c93a7261c74c92725747570d082e9ce05d7625c5b8e707f6147bcce96574bf5541335a4f285a041b695b5cc9d62739fd8e3ed49836df2e2045e88d763171c6f15a44693381464e0c7edad3493bc5b3a9dc52aa9334ecf5e21609e1da35ccab91b9323a6700cc270a52bd251a79b80710134564e6889e2960158adb8c0c0670577d5908b4d8235f527be916ebf8b71fd5c3c0b42dfd0a533b0907ccd6d5073032860a0dd81c80bd6213bba39eaee9170d0a68d51616dcbbfd968e41f4384551603dd143df7b4e35cd1a2a3c766df06f13494f6496414b2f8ff06b7e897265632b65cbb3ddb114a71ef55f2153294952dbf9a2e61119a15a1dd2b43cb005cbf7208ae631c3851fdcdce448609486a1cba3e324215268f40617fa3950bab596f3f6f16dd620e23fe7e004832a8e3e8e0a57bf89e303b9dbf061360633fc75f74bb38c4d9c2251d76744a943503d4341c31f1eab368d6cd165f489502987976bca25c53956c1718e2ba8072e2d0c80153b751890fe016355869ced60ae6e042d7b1851f7e274040120ddc88f144ed76d19b7c571e8bdafc000d8643ff27c6495e916f60d9a4577f88ea0b59c874439b3c722d7db0cca547905df6b20a3a592aea825e3fd0a1f146e630acb01fdbf2a99ff3dd9fd97330d98da15ae3148e9a0f883fc0dd96bdfb54423a22d68e7474b66aec842b729e6f610d1d3e81b7584383bc5e37472f4dff87000925562e4625d6b29a5cc08e45ccd361789adf77c1d08f33155bf42b2621ddddae341b638e3718c7cd537747bab076969bf1dc02723f62a4ab00146bf377ce61e8dba04d5c4b49ada2ff38be88b4b2ac715650a182ad8fd8e3ebc035b8ae785c1c878e5be0b37f7052368235f6a13f8b2e2a4d847de742106869db56c3fa954f778d197609c786a8127095917ffdfd3d7800d58dc563605d3db157806f4d9e339838091cee950be788ca632d5b7960eb6f36ff42f099f5b659b35c0b7695fe9778c46b843be321142fc550ec1f77dfee0b1267160ed75d242a5acce94760d4be0a0692ba9640784865cdde0a617326b0b945ba037b779e4b7e23b7071c2f17cd33a575a5cb750cfc2ef170cd51055832d98a261734f695b735118435733051124267b899396c9cc452f016f9e36c75a8461ae553c016630f5a6dbf4c6fa980b1bd2708af48fe1908ef137b9094020e40d8700f6d59814f3cb10d9d4e17e3487e1692bd3e37e18fea59d20eb2d513f715fb5a690a42e6499c94faf169470a426c0e316291955efae78b24d1b839385f243ca83086a817b71869c48c871d00cdb27c3ae63287062981ee1def95c866a1a9b82555cb3e6330e0da1d10254988bcae5cf32f72e1e55598c9928c6c5129c520454b15ec2fa627e5841eb21320bf8484d60c5bf46877ded1d7ba65b04082e1c5425fc87c192077ccf749e14e498da40691a5678a1c9ebf212fdad935088b479b90298940e7371fd5e36679e95ab2784674b06a15dd3be2455eecff3073a674685321f09c99d333c92393283ff6f32becb9511be19d11d423c6713d1f8fd8de044d39bdc133c0bf40485e85b8e6d317018fa53ec731b4c2142dedba0d3f62db119924fae2ed1a09ba801b004949b03662b2b0a14a1a4ee150ad2a90bc7746d30ec874eb033ed4ef6517136779a3014053fea8dd02c50332ee2c78270dea6fd04ecd482af1317df75c23aeaaca77416bc42072da5db3ed317e8360d6ca538b6019e0d4d221b839ac833663ac9d24d63fce8346d8fde64941305147a2a7c3764d79c1f6bcbab6328c35bfb91698706001c2b12cc101db4db9b85303773d5838056f37781caf403c6b8f3b5574def92779dfd1b6da87d20da3938cb35ada41023f0bcfa1d8a45cf6134e7d914ef1b4150c7d35ef13c5fb6f8fe53c6d7ea6ed69b860650d432ae7a960621b23cc8273857856cf3c17731e33c2e1370c1d79cfaade771f9bb9ff01a0be9f2520369e6f44c6fab948f2c71f1fb140ff7eaa65a78aa514ca277d6203590bf689c53edb12def3d6693a1456c860941f03ee77ce607993ff89980d5030c3d6af121f67e710fd71c89e458545c3123d0729b86cd1e13abc1d09d4352e5cabb5345506b025f1dec66707a9c36af595d3cf5caf6a0b40f43d76b13a390ac4c6c5227fa15fbc7bd67964937cb26c93c417e787a4a7aac3d74648a297f3feaad96f3fec5cd38edad81a28ab3b9c4906edbb6e8c4b868d4c5aab2244c6a8c558702d58c1eb01de45359bc3d5e031991059f8e9d344bfb5c9c39311a862c07166b19b78bbca66939610cf98b3e0e9abb4264427b10a32ad541f5865f103e8d212cb767d1f74a5b18fda0380e0cc390fbe9498dead73da9aa09a47a7f590987ebdb1db9ce44dd518a071cbd98185780dd7a5e8bf3ee53f702c8bb5197f90ea393da15216d2c59874fd7c3bb3a31d25ef018290932966b83a56813d7cfaf7cb7194cbc1352faf665a48a2bdcba85fea715dbffa2d094291d25a3eb89e389337232b6891696e36d0c540bfff3001ceed11a71a729c7479f4c4bb10c95ffe46a1ac98822784e249c3f9ee2e9a8f9297ccd3dbf3377111b6b7dfca70f34e5cce57c1b4e6b2bb2a909462eb153cab3a799c82e299fe689c08963d8acfa25e00c2eebfc16034734bb65e2076e360242ed0fe3f5307fe598f156cd1de157a4b3749b8e3a30198d67f82594f6f696df59aa390af35a6a76ca6191e0bed0963748cd7434fcf01910b1b95be9ac22b68633de94590982b2367dffff76d2284df213e5f67aa083d9bf9aa0570100565795a6494a397eb7d6df79518f5278007330401c0d9ba76c7266055d2cb27e24ed0208a021c73b931ca77bff716f0fefeb9d2600f9213df352ec8fb8faf235cbbf43d8aeab735195f9f217d352ca277a08ed4298bd8ccff493a04e517d5e9de08a7fd1e32729bff7490cc2b1e1ea93c8d6fe52cc2467db50a8104f346059d62c3a8cb91e35d894b8c4da9ab26e7531525e55f3e06fc976a051b908b6dd0853e8b5e971ff321a3a5cc5002335419df5285a998ce71c5d2a86acdb9fd06844c563674bb97eecd5b33fdee35e1d8ed588b9e70a622227d16a95a5ffea32413f7a322f9577f7272a754570750954f443631b5bebd4ebfd017bc2cae9f22256af17ebd72727db2c268bbf7d1317d9adf865d525ee5dfdc16952a98342dc54195d1dc11d5fd92c536cfc4863d1aa8dd212a340b01f8e799ddf3435df1088a4c4a5107de8a74950a45a97649ccf358210ca7d831c264c8a96d7db85d03d595b7c9b8192d3850f4dcaa74f0bd6e2be030eda311293c3debd2390ed52ee5f3cd3bd299a6ba3c773a46bd8d11622cd833debd644703bf0af1b1e3b67a82460b4aef04bc6eacb22ca78b3e0e8012f08579f9628144448383ce4b9a1c19160f514485575ee00dd8fbb1f209fa16a983aa367b3025b758cac6f8255acb033bd4da202a88b5693ca0b5c579ef0cf4630f5f2c8c52acbb3838c7feeb202fbf4ee3958ff70d2bef69e158dbefa8934d56568a84b678ef2277721217f423dc4716ade255c19962ef27dc88241bc231944456d19626db9607f2dc7819617d3ac3796ef5b07ce38ea42e87f26100bc52c3209f1561a0cb748e0de2724ecb68a24f4ba25590d8ec727474ae1bda2e0bdbab3c7f4c3b39f341c091e6e02c3c0e33dfbc1b7fae28695020b61afce6eda13d2de37ab4f66f3954710509596564d2fed98a33d90e3b7f5c7ed3c1e2e1a19fa5762de30a0eaa17ac05870749e936890dd4e6534dafa66db3068bfc2ec0f7558720081f52b409bf06a3498ca37f15e2ee03d1509f9dadda989029998d480cf75cda5ae4b34b295c508603cfc6c35d7cb5d3aa715b648e3c5d07ddaeaa3c3636078b965d0cf4c3e5b94faef03bb7f46226f715acc91ee9e4afd0b77f0d6f3a12248e7f3125cf970368eb25794e1297dfd2c5fa3f0e8bb50ee37c71039daee5678cde74ae8806fb3b1551e64c10034f45cc39a70d27ad343824021bdb5fe56bfe982f920d481afbc7d91f7757384e772fe20cf22454bde0824c039a9b0e7c02dcf00e0594a5fc038c27c4c300a397327d07d2d20d6c8c49ac22d9bb4d7786c736f002b3a6cc81a72b2813d80a4b9572d8cba6429412ac133e6215dc9e6168626679bab7fcf9be7df42a61b5f0090a584f96967834e4b90a6c9a949d6f1f64c737974506537cfbf4912b1ad2a4bac78d2a8cf44dc761fd61f84b670302bdc51ec9b707e5160be7ad5a405f76aec6012a46f57fa8228a46d6fa67d0c527c1b5d17c2cc6dd7cab2b75dbeefdf8adbb3c3d4350b69f85fe2ee6a33d606b7c0aaa54386500c16ed59d8389fdfa78fdd518b05bf5d0571e3978b85db58a130edc7f0e5b1ed155478bf3387464f56804c8ca9c5dc848c53a8b9fda83b1e30cb4ac831bf14b897deacd8071e4b6ac20bf0092a24ee3d8640313ddafb727da4805b6c560b40eb379810b972ec6018a8b228957455a2028f399c661321814b8f94c462457e27aee8a605b2a88e44f45500ae889703a917f4be73054124a87b815d405ccc6b33136d622b94c06786d84a4881cc6b942e519d5c42b0adc09ce609c74084a4357eae93f0852727ffcdb280d79a6034457a39c7663eb6dd76251a1a57eef101906e95b56d3504fffa4ab18aa3d3ad91322c8279ecabe0e8088871b3e1b37ea72fa80105a7396bfb98fcc7c5ab72e8d2e5f7952ead4f21d424536449d114100c9b8785ffb8cf4d036dfcc7ec2f0b05512ffd206bad1f857b8953396f0ef60a5b12d27725a3365c2de21f066016d84a2ffb44000547511ccb71552cab95a18d45bea859768b65960a0452b726d39bac47bec6dd68e80391e2b3656414f65305ab91116e469eeb7193c5feb0bce2a1e176729a992e98debcac5c4cec854d4469ab89a89833012d6cb8333f12657533d7922d36ce5c43890842743cb07d9906042fc9166c691d5c618e9c780eac170453b653812186481ca881fbecac92ddfadccdce41c5dfd4ae8c71337a8382ef159dc22e4d3273077ef31133d0a604d3499c0d62f685ee7a8f35e183b7db21ead1d527b071738df80385ca65d77bad786d3f004c25883f8538a2fe80bc5d846231f1736a1074fbf4f18bf9e92aaf618a93a25c7aadb7ff9e9a67f0a5b89c296d32bb608a3f87cdbb08d8aa441626e694214cb60db70528c433a065e6dd1b39c0ea39f7368d62544df6002e5feae0c667676dc7563648e4c5daf9c07e24f40b7c2dde24458d6e2f1b9b622ea1c7357369e3bfb1721f8291116e249a6e46e262f11f42a9c7a34573373910f347fc3548811a7711a7d32c42f8188888a165f070083200edb02a37192dd5c60ef0b99627193f4429a75442784fed82db11b018b2f395430bcb6ca380c202bb828a9b22fcf0dc34f65f667271b68c842f28a2c51b120ccea7ba9e15be24fe7093dcf0435f57923b0fff79cce5ddf2309787591ad0a2628847f084f254efdadc39a85779e78c01a5ff815cb23d8b7ecf5e425043680d552598b84d60c4337835bc2843af2b6a9adf2ae12348328a5a95f52dbb3448dcd7a0fc4f7d93fbd85a2dc148727a44ff2dacb414722510a43312072693c7eec4935f85191f4a6f2a7ad04e43c77e124ed6441cebc1ae76c8e3742e5d3078fb829ce8da54e28dcef08e002ff34fc5bbf406a7f32eec6f97803caabf711252ba4c705d63136c98f4cc53d1ff47f02dd86180e1737c00998c11f9742a42e57c2680b5cd8b448a5709d7ae3f8edc16c6f90ee525dd93d486e4a1aa4029018c990a994bba9f195c4971f8f7546a539175fcd983ed9a08b3a44cf6182840aa04092fa216ea15375be33c94365e30bb784baa934f043ffaf14dcae9c11abfbc82560e6f606ea46b6875f96961744f7d1c92025891c2b39fe8ed05faa6932d3e93840985a56a1732d75173471c95392dd16e9edffbabf58c039bfd167439a0048b56e3c8966f8c94c224031aba3eac7513eddce305822ee63df8e74123c848d7126f8e7d33c68b71186856b067c5698c54335d31c170b5f2ffb55da32744a0e9be0b45ba4e92e2dffdf9f881cd5b87d40ae8b174213ff0255a793af15669f30edd1c9b9b1fe6600898fd4e2a01db3b53681fc81f1589c9703dc1524fde28b24d14c043d57d0ae7c4476046d101b65caacc3fb6a7e4c757b460dea6fbc206c535ed60721bd06cf5920a4324348ba0ff374b062b10f263c470237e18ba461949ce6c9121322e16425fa8c190eab489856785f3f55d455f03b0767fdf2c26689d27e75d403f67d253de3df2d24ef461e1f789e085e2ded6acf927ecdaaed77b1d3244e4c5674efb30991d3e8c7376d696322025751aff6bdd76923af06af52bfd5212b8c18e860ae0a269c6a5c825eeb281236b6d3df0fae459f29b1ba6beb47dc5ef2b47a1048004a87ee0c300caf477e1bede8353599aa71933a89192433ac04c895ec43a39a663edbbbf308e34381c31490616ae01d84617fc6b1e2bc512fa1a121063e576c3cdc0c425ff6c6c6b116476a524630638f5ea36981a75c1b33b1a2b1a2beaa9e755285dab94217194da5247cf6464f9f13614f432a2312d16f6ebc7285dd0ac530be9c38b9e0089d27a75762fe744a72b44704113e7311da1f5e8310c59dbbdc0ed577ccb9030dfc4067f184dbd848eff79ea83e4597a47b2f4c2e61eaa42b3744badf0ac9d8d79bb39268431d3d4e9e690de1c7190fb89955b0428efe62eea69a4443dac07b586f3bb5d18eab09f9cd31508e0421e91b14461e163bbec353ea41bf098ba1157d87fc35b9544eb53077b6dea07396a8bb2fbf66f60cbcd1aa2bc508b24558559ba46280868e123bac679d7a0580be693c3c1a698f23aa48f4b1b29dd5011eddcf8657ffca6e19b6d09531a22490cd7e33554a246587eec864161f488b222a61b3ef3b2081dd4dbba1af8a50332528272ae7eaced93094b3b310a461cd225bd474917f5251e95dcbed4a07cc9a058a4fb4b3378a753d0ac0aed0cec99bf3d3dcdfd17ff7de896cd48e35f1899bec1aea54271b58fa67d5bda0ff499484a827e1d1195d669c59e9de02cdae76250c5617fac35a5862b91aadbfe1796e3c86be835be48c91310d97246a32985125f60d5d409fbe4ba52c7bcdb3673473bed5382cb9d3ad066d9503ff501e3b1511156a1799bff00dd9984d599ceb97da592fbd3cb2040bac7c5f519269e659f13892912c2d90ba2e649f1e4a4ba229801b8ae6ca94a9d82b70701148d5ba08317ee41bb5f1ba2b1d98e3f4ab3e754eb7b5d98a8654ef69c8a5e6b14cb694599c385be95c0059217eb835d75697b1f2914bf5289ac3f7bc2727c57bdd02bc34cd21671097840737c73bd1c863f78cca6c24922143f291be526d2f7388a5684aeac78bd5f038ca6e38c8e4e4e8cbd6458c16fc9a9fd2a870ceb5f9180fff9ee05a5bfd73fa8dfe23b5ed75d130f4f9119465d9d89cb2f8cff8a0e6782742b782952d3f116db413430023ab49271dec4693c36d4428245653cb63ddd7639bc8c52d3a231bb50b9bc38c901e85fc629ca1783008627a31f77f9daf3a6dc18317647ccee3e3ac40db146c818da8e6e55e8859f48f59dbe4e1c41ff2be7429aaaed2e914bb32329361889ba96cc4b595137b6d3e5741baca816e4b18cfef4ba40262df97c34f55b94dcebce89f095fa4fc4eeccb03180506f1b7bd6f987c6473afc80dee546984577e1df770fbc4b8b9fdc85d32fbfe4c113ea4926f8a49566a12837fde932306df285e954d858aa7c194c1b7037d49635010689407a66fb681b6db3c8a6d515f9ecb23b7a364e8ab092530bcd261df668dc024ad8af98e9d0756b345e88dcbf7fb8c341b4f6837991ff1938436672a773e3eceb92cb186c439d540a90c30fc59bfbfa0a61b7aac8f74bbd27422fcb91b014fd792d9adb586772c87c59a56b1ccfbdf11a80819ff05e8c360ab9965273cf657b317561efb0f8d43694e595e7d35f8d26e6211e8272ab373a7e81d3d0f23d295a105a59e7d9ac5fd8bc4b5681111962be8d46e372f50af8cd1021e30b21dabd185a9c6776b9623a8bb6adebeb341725920685bc08149b4e274cf13f4d2b1c7d6098816a725f75e4897b77a18d90681ce2a7e8510d9b789019011067210e7e634f018f48d485edb9cebb4d8233ade844679490b93fa564786a97319e08bec7a41c579ebd104cfa878ce3bff960487695ca85d4bc6ca82abc24e66f13bd66e7285b33a8fd856976b8a00a9ba894f649c041935bfd74ef22e53fc2e11aab1aedf0368ed7745ba1665abfcb848bb25e0469547369db8bdf551f625fc2f1278a51cbcfe4a530837aa39211b72907769913625ab8fc63b1911e1161d26ae2b74fe955b1f59f1a6a202f0ec56cafa6ca519111ad75dd7d509ebc0aedee23929c12d5e44ef4b9e860568d8a46e1cde13e2cc01711737848c4d724eaa6bebc5a299b07bdc208f77488679751ae4d4495d4636bff1a9db68a579119fd3de3895ee457c80282387d71a600d034e0aa06f9f6dbdc0c12d8f69fe3f1dd94f6e8d951c05a9c332944f3710c89fc64ac4d243fe0471e034c7d9989589ede1f0d7b5da6dc744276726308560fc457ab7201187fc6a7ccc344f1892f929e5e07610db48615787e6f33d7d939a07466204adac51d121c591d591c3171b7bd36259bee9c417ef180d49200ec7ebac9fe424db45bd861292ad45b45537d6e238deda5db8cd221e5a6b2f4e02c90c3cdea265d63965650b43b8885be2ad98f3151ee0ddeb1687906d04f29f0a29a48a588d1d8fa6cf401c482324f68ff414becbc257701737e394c3412c044aea0e44529950e37094a390ce872797c3803e3b5d980928b4f473b084d5deab9469d4d626dcab2e1b301918bbc511fef3a7ca3f6a36c9036d9f7fa189d5ade2cafebddba649b1cc300ca7982472aa79c0d8498f5ce5098b10dab6cbd128f3d1cca623f4d2b2c67875c7067f6af3934ca1ea3e908d15d67d0a0433a0796579d0a89508b6c26936098c6f5d0539f55a8841eb7aea0011d3bb8006d6ab7fb0e42a8a3199330357bb7012fe1aaded7c7eb303972d04c3df73bbc9eec61c9f699da11142920b4900752dbd9b6db8eb2c29fff6ef5c2798bc7a565776000eda6e946f91eb3910ce1d3cb246c5f2345deeeb5168f409c70dfe08abf62147e157c6e402df335941146fa80cc126abe7a7249bf7d363542d890cb10ea8de6f12b48e2feb0bc21688a6c8f99ef8e4811ff23ae513da6df68542f63707c1e59d26964506669445fcfc765dc58238e2ca8d116eb8e0ecb7d434668942da643d3e3313686de212ada73462765393240a946aafb152d3f996401295826e1bc03cf06f8508816a4f5c2cdedce1d1a74e85c02a13f416a3bfe369e2469fa0d6a787a8b8167e09feaab6f559369f84f9fa245e0410a32bc8f27df4736ef5de427e9242c9354b9b79f5ad6062e03a4124ec15134a7e9e9260e3001d9f6bad0a81222ddc13c4f379833924f13b3cc4cf2c12c5e350494c5ba01fe2ea4e23468e61282952a802fd06d10b444043e20d684e38e5ed9726d8d0ce71a174a007e3d2cab44194fd0a0e4621d2b3d44a3e3ee15bd62d75580623d4a6334edae37be04bb69a8a5ebe609d187e96ab901b53c14f855874edc6d6e71749f28fef5ff9423c2c8c612c40dba4c50c405db1bd27bf9ae81f39c66fa9ffd11ce6e132350792277f764e82c450db3a181887b69cab4ff94c3b17f7c8cc9efaad8dbfdd9dca10bc92b8d5692d87bda00e68e9168a9f1cbaa6031608bda4d3e2087d2f283e050dc3a4c20855b70ec9b8988518020e815c5c7a98c89616f22437bc46f543d394417bebca2f47d351b32deb452e22a546a1f9e59594f64c6d1e7e26e451942658e9cd9dc787f4c42013fad7e6a9205d86d377942084c453baa7d1d30da63f17f8cb3e166e1a5a44a24baf6d51d79901d21e1829a229fe755cf4c901808cc35f6268f6231f5d717098d1c2de4ba1f93e7c78ce700149d4fcdaae1eefe9e80c39a099569a60a6075180a2756205560807e1ae7c0485a1c575c165456fb5c9818a25a6963c4fb4accf42d7f3db8446703a3d0363e203cc3b261dfbbd41871506bf953f712547240420bd572a17556a0346d52ecf9f35267cfd62d3ce1f84b0748a2c156b0b39de23d98ea13fe503b6f61d14e1c3eced5831e76ef18be38d95ca03e6f68af058e56a6a58ac55d7452987170cfdea250ebf24c8263eaac63f398c487c33fec79b26d3782e2d694e292ec120e0f20b3d38bd43077569a521acca44d11400497e29ae7ce9a4acfa5ab79c5eda027236bd3f36786fc36f5fb2bdf59b1f230c71fd323a36da57e96342f7693acd36745444c7998757af7f146729c2210385a802b425492fe5bece9d4d1f06794924af759bea5e2734a8a611260e3a07dbae493582124a40acb5bc9a79309914a6517471e26f0db41835f222ce804c277d6970bf9dd4b1bdc12e9ebd98245864e2512230f7017cfd650f15da857e1afc3e719c40e3c9a2935d91b384ae01d11ce42afdaab649f618f29fabd4a51a6e3b59c51cfd5f5d7156e53226879afad3b7b6d3b34dab67b3b710b269c1104c0a913cb4c307b5e755475b142de5fcd0fef320cfaba37ba3831ee34f152fa97df153fd6d88ad219cd2052491589d8835ffc41592b2021453d7c8db794a3c4d5cd107ac6f01e82cbb16319b979ee8eefe328b56ad3b0181cd5c4b715c7f59dab542cf90a2eaa499b170ce11e2ba147f170fa9397848e908d7f086119b0f79639931db41002dd23e53e70e2ed190c7dee68a5c7dfaaf275ea54accc25e6067eb4a3c0b09cbda7c4268ea92e4bc6838a7ad2e5d0f50b5ef63fe866a9b08165fce605123491f090951f7740d84b9db5fce9155f416f8bbd703e3ea8a36a2136dbb779811e2357b2b426670700eb012d9c8ee5627b419f5a1895289bcf6a6f891d69c9cf1f60a650d3724e5ec1be2e172d46d84e539ef5c8f991c8eed9057f72b9ff322b61dc525d030056747aea1ffd27f26cfebfe601b144a295d0bfd776b77ab428fc13b9074f066982196871591251dde95ccb8ec1023d17da72a2095fe845b1e6160fe7b32cdf5a8e92ac5dd9182cda1e536a0ce21a39442eed6a3a72a77c5c83f28133c01e92a94fa577a2c934db07ac122d7944bee06949a2041be27215cd65b744ebff955254bdfb7e71c2b1ea9b15196b239ba2b04ce077dab04c0b109c6126c6e88230bd999387acdcb3e4bbe998d08b03e6f1e6c44419ca2bf7e505f56f9a5f975ad407936536b6d2b1a253e6ed48fad7d9bc9238f0fb239ff553e57de7b1393be0227be4bdfdd1e8aeeb04b76ea3c90a58b3383e128577c08abcfff41020ef4e21ce1cd54136eae07c0d2723b27a544860950950257a805489d2404b218d9f13491e49065f1bbe3dd94fb2dc4962b0f4566deae95bb0dd0a7a385e8e156593dd983c7aae74a880d61aede12d6d0c945955e6017c4aa125beb77cb29c8f5833109d14bd2aaa14213119ac18d39837c435b477c5e183b7d33d0201b5d4f8943e6b15515a2cd0df9aca3480d583c2f98c5d797a59fafa3593d0a06c0b7edcc62aad3ccc77c7cf853a48e30cf4432e49a6c549aa933f0ba60f25b3ad53ef330a98189c97fe80fa7c70689742a036c054e2a0c0b1feee7ed1c7ff423d024cc678fd8374bc1b339328342dbfcf8298bde55538d2ee919f51cfcbdb3b26b8f2c8f21040734098d280fde2f44cb4ba7fc2a013b486326dcfce66ce44d1db0d0af1d60211b59129a609f9c67c2f2ee74c4ab547a8a8a9106ede2c0f3930731a926de8b89e6cfac8b44570ecc3f7192150fb240cc5e75913892b4f5a073f766e513556df2d6392414ad69b0af51a467628ee43879e960bf2ae7ad83c8ce0364162abb8872b7be176287cd198e66b66d04738ff438135eda39ba4df68b373c70415d319061ed965ca20204df9881de36add64c84905b71b860c2fe3fc9df6466519adb4f37805703ea5c259daac4ca8762f6fe1dd33a1a4f32e912af8505a2ba8202d0a953082ee3b629c05e04a704cafe92365a19ff69495890f2d5f35190d07f6bd1fc3177008d922a7fd39182b7520dbb4bf91229b7d20db5ddc045e9d25d58e8aab746d84d3ccc5125b7ee6b8d5c96e16a07fbf5a1ab9a739de0a8dae877a0557f2a9c1195b00e2c8171e5783e29d54258d94abd5d3f2863d9eabd7b8b05716495c8257ffbbd0dfdd5a9ac6023f3faa207ff2fc773f2625f8347d92b131820a563d602e574279e2b85d97761445d1d5ca5f41e49c788e3cb638e345593d749ec453966c075220d5eef1ee24ad9d820760cb2a7f9bb5d9194a0c1422857215998e22ca30c0331c0d30df5f80542f3e138f5e25a6257298913113a5205871eb8f84c47a61a9e6b5cd749cb1d93b376a8dae39808e293f43b0bda8b914606e99330940757f753a715fa8e3d2a94726509b9ffe2e9c9249c6f0e5a68b69f790b28f97597a62e625dc4f644c6c5fdf84f309e2cbf425f9becbaaf791c9398771f947acfd6c465262c5dd49d0dcbd4787b112d5ed76c2a14482c296b9f147ec95e87bfa0d16fca8df7b986ea1d88baf78a454c9d37d7f6372e6d4fcc770cad1cfbdacd5d388997019978c054f785f3c4819481cbceef90089a528f392ab467b2ba3b8c425d8e8e711f7f64b42ab513ce8176b95d855f55138540823b7481942bbc976e23a40bb4c656e5fe33c7e07931d648ae2b4cef31ddefeea0b40ea5a3a247d34098bc248b5bf4500828ca0d807acc595dae6993f67934c201d9eb4e37f98168f2c187c33ad726e7c0631ffee63efa98b00d63ea021e1858be2aaf8ad5a7d76f1e9371cca0e73441dac87814ad3a0f9a05363aff3b4abdcea049f7b9a433a8437177aad42e287f228daa59126e865c517fe4ded495846ab6c8bd1d8508e4957e085d65ade07a5f9f413a1cc0af99f7b97408babf65a9d548d21a9640a2069a798cebeec761323106f48f36c28018087b298c957fc66a0755686cc97d4e4d6903cfb33eba93d170d8fee48cab49994f91ea8408015a53a0fc35b221868d62f3e1ed4e0b507749c5d90f26bc24f7b204b62548e97923a2292e02e3e372bcb8752b1ea4375518ed4a1e63575b0bfa46d09c57e328a720dfcde183eb0844b5758d1f2220d36015a217eb6beebd52068b3c0681bf31ebd9ccd9835430c2d3e48408fa65b62cfd6686b4e09db1121923bc1bdcd029b5a8cc038376d0cdc34dcb6d1c9f2ec541241c82f9021c4a75f64774414ca633eb798b90933c42fd96e918801bbbec585600d2e7ee3e52938c55fd129f68ccc3488eca467746875483acc9fe4d741ae235ba60d95056f1bd643367f860f73f415120b5c42c82bb5ff739ac354591fc5ebab6706bec7bd0641b9904cc60669c21b8686e75780adf4687c3e8d6e21fec36d37708b5a29749e69a4a04e6cc8a97a1a5f9024c8d95e5b207c86badfbbd6e1651b0b275a4f4d6d8d3294efd2ab14fdd99d5ab712c2280e437aa822063cd03b39958206476fb7aae23c98c6aa8179b7ee025ec9d0fb1a86211bebadc5a36de17861c1c2892ae6b02a92e8a2bab70b5afc02bf734c2a3f5850d69394aa42ee3237530543d1499ce58432896e8738486699348523ddab783229247ca5af83d52dff3f8a562099966b249ceab17b08dd35ccec3a820d6a034b8679f8633066b2ed01920117064e8a40994d4f54c3f103262753ba53872b592177f9516c7e2f74035bc74e1b1fab6306e72260e43d3edeb156977564d875e198a3faea8bb0f3f039bf45630f5ac59421df611c628f7fe091b2ae0629945b5e44ff56bad5ae3b6b54a10c47c934a6c8cb85cfdb2ad69052bc1e7ce71f2b9c8d15910ad7279d065d62bf2e432124493bda8339697e35c5a26bcf091890204d5617c4c8fc7ed51f5f28243fd79d207d1166e496c5704e17460ef3df284c1788496c7419b592d438879e35008447deb0001473ae334401e6a5b52b28daecc4eb39e724a43e6e0208cb5b1057cf38de88e52132d101232c9e42cc5944c8065cecadc2fef8700806d4cf222660b3b58e2b5710c55e137fd7d04b4830dec7bf9426a44353af09d20c1a3eba101748b0913a20291dae471756b76370bddd05297e89f0f5693f6f49eb4adb7e4d84a19f88e591e318f70800b41ab8a5a599c67ce5d9de9d95ec1e6e13743f071b6a9c9f4819a538e9be66c6f4caa04225d426f670e70a6763d1cca1cd8f8f46dcab259c263a822bc8989b95c97e0c9d519ace307ae706a515d5c8c5404d315eba81e90217253eb513e1abe220fc4335b5cb210b55e8ae08e2bee1a888c8892466b266c2ea65ce3ca8b55539d5f9f473809175199408eff9b5fe97998f392476353a94bfa4d37be866b4a52c9977d83667e8d66f23fc64481057c9a4ce5a10287c1d5577a261ffc42d8dc4eb67a8afb95a28d63c2e83f20dba9a6abfed80c3b5ba42a556ef741a5f98d0ad2b0a3d7de1bc742cb8b0c57f849c7cd5fda4eaf8155e029028511dda83eb34cd99f8d262b838e15a78d3270d77cb9834bdc9f507f5271b70f3d58bca60518eb4f78fc9a024785d88d9c47b980f4110d51025aad83ee456b0f2a16a983e56781aeef6a7474073decf378bc81343342d618eb8ec3965e97b7466511a4d008814b6965c0ba22fc08f2569ad8ac5c5f964e55827f82629eb4544d957ac305a153017ea4a3014d25ff215aedf657ed80fcc97811d1b354be4a811d35b2ffc1d3f1d3220511188db8eb3688600ba080f3b56dc9574f1607bfb72e361d0540474d05fad95fdc598721496ccc40559e76fe6ebe3e16530f029317e295ac96d0c80d60a06056624e57493f119810387b1050f666ad734ab8189d4c34ab007625a7b25a307e80f6a06b7ad11c8d0e047cb88d474019fabfe0a85c810f632f3b2ad80b6673dc610252d08d9bf90dbb4f2831ad729f1a083be5fbc7d64a4c77e204d6681f8cbe50fee66de252bf7486b8123779deca134e45517d803a784ddcb4c7951cbfe45bf3a308716d7eaad51ebdc85ed68ce6db86f8655878964dda08c7376e05c9bae334f80f38d1e38538997e60904177f894116378d37a314b3e8cb921ba07c60d7981907402f60d0c8b7d8c34c75d2191b5b30ccf07480bd49c1cfb3ccba16790edb7327d960208fdbc81a181267b00dab0dc5c72d1354da5d76a6b2f97e2b910a26aa5595c815a6c976ca9a728fc9748abe5411368e8d781661b94de6aa7074d47b0a19a2443f0211a4ed231bf16d6ce71539190b68b6e2262bf299e91bb595aa38437a067ee0a48fe29dc5c26f66a2c45316f190900f5e174cf289f00a2cd840bad0b3d38feec162f8934e90070c829576c374f886bd1367af01293f027e982a93fe21f52331230497a334ad128104ef8bb8d398a7ae2537f1a9f17b65216b4b4c02a9e821fba670f80aa3c076aaf5391beff72d99cf05cbe3ed4d4cfb434257fb06545305d14343d12732e42f1dd57eb4ac9514419dea6600635a1437911086f0a43c87076ee6a797e1e4c3b7c88a5246fc7090401592bfb8ab9e307b0811b488b75d590268f3bd413c671ba6ff86f7528939d63ffc9b3a240e6a462371236341e34e4f83ff9b0205b487e28d332a819c6720a12f077403c07b6493c47052ae4bd3f10549e3d6037e8f2a950ab7c31043f33307a7a7e0a9d58a5fa632042dcb6bf4ac7b78639971050676d3457e2b136e1b52330081889abb36ba91923012c3ba7feda848e84d718e93a6070102dee428522d7ec0909334f2969fb65d24f2bde91051c76bdc733e8c5dfb9748c041630372fe83ed0ee95ad4da3a302c7d05f75be1aa4887b42ff584f7c0f490f4aca7e8c67130e5dfe2bdd2f8596b9340f7a074436cdf3171ee5de472011866fe5ec4ba81ebd51446d8c2ec12b6594776a7a28c2d51141f7afde6263a0c391670267aa2d36971ffde6766762074dd45edf53df935a976cf621df498a170d4fed763a2f27b940b540bc8b69aa468f2d53230572394c3bd8607eb760a46bdb04c7b480bbb0bb455b21db91a1e8e942479d96c4c05fabc53a725d635da4b91b19e6a736fba05b1c7805df134eb031460f9b8a153699319e28615fc54fa9e7aacc4981d38cc3e7ce2031773ea2c4f3bd5c087e9a65606f1c16f961adc71f34cd3a276aef0c02b78c736b3ea222049fc6442b5fee0f14bcddd066fec84e1d8a67d46f57986b5a8fdd2d8ed5bbca4ea6e27223569f88081221f00751d68bab8f66148dfdec3689298612d9e177263cf06d51d5d343469fbe1427dfaada03a3b6a9123433ee05fad8ef387fa7694fff5878e475181378d5d31767eaadbf82a06ceb3a357c140f8570972a45a89d1737ef462bea73207d179edede796af58d859ecf95ac95fecadf84097c9e89048feb51b3fcec74b47a9f368942c0aa774e00ffa533f0b54f7b392905aba4c732d122df37def31612556c63aa3a78e2f5bd59c91385313646df9dd889f3a1e4036aaa806897c9cc4eab71b26d472ea69e34c1688661baf9440c589977b81b0af4c488ffb82080553d8ec90ce3b6f4bb5a1fde0d4acb99e9b143d4a0fca6c0fee5ea629739ba71ec34a782c682aa1fca8470eefe4ffe3e1acb835e13e57eecefca4f806e6960b7036098591700ae6f498bf0dc009e399e863eebc80008bb4447a9afab2af58638336280c60462311cd03018c0cb5dec8fb2e9302c48bcf14d1a44950dfd328039e448677d3b9fd44902acc9d6747b67cf5af1bfeb005467be89a944eee71d096b682cde640a5b467d918058a99616a93ef4644c2eea38ef5bade753795705ae327d821ab932480ea5ed7bca8a827aac2fb2c106ac5d3a544ca6c7562c09180740ee2b24350c18d784ad20df1d8fa8a5f02f9a4db23eb9962a7c625cdb60babff7fbb5ce8a6e11f1416755ac5369c9b19c43eea13645af8ac16914e59247a53d270998efb6f1d01b9548671a3ab01736ca2f9b212626eeb4d75c9a360b1a4615b50a22196f57f5a6408609249210535829ba94d8d4f28a892c393ded0c5a5af10a2d2e9d6ff5844c1411edca1e883ed8913a3ef19ac18edfa843c2bc81e0e6990805d70151d982905b82bfb70302b3af93bfbd9b49fe6cf1dc650faf1f7aebbc7a7ba8458b947c684ec3f3d312719ed0ad427ec7ba96114eade8002ded4c47686da377a61c30d6e39ab6bc80226603bda2b9df7cd684198e972fe068f35c830a6a993dd420e4962a5b5b489f06f4e994ea0a6b65f53592cf000a668b224d345d01cd180696efbdd882fe23f21e54237cba465a321126c3353c96b084ef01efd1a6db41621ea8166d85ff0de480b815acd3d1eae9fd55640d2f85c2b14b9ff60f4c68ecf8d8898b49f3a87f909eb3198dd7e5442be3a77b5fe2caea0a0b867b4f40b8e890d477adca8df5b1733588a52f51aa96e03455331b398c9c146d7bf07e8df8887083ffee005eb6f9ae1d81bef37dae4a5cd84290659509690ab989a2b765f381fb1456a367f906be2f2e336bc7665627f58e6e689f6d165e02286b20fc97f603e29a36a18f0f715cebf297961a9df6bc7ebf57f4f2dfa05193386303cea1f84f4e9765ec842024f4eee86178a7dab6f7e975009626ce7fea4f91def2ec63f068a677e620c6a0631a56d7b4bf5e746ca53ca2d43db7182f6e78c0e46a2c516f6e3383a49141fe6df91baf2aac290d8d036cc18e9435f21a2cda8b6c70f4f840c705faf93a2b3b40b72ea3184489509599d109831a3837bbd80ec6c932ac2d8c68f8eb0e55140fbc8f4d1c9094a0b6daf7212e99ab3966e86dd44501ced822772a62db4a0cdb68327c542a8f6ab504785ec381876892ed9268121733cb70c9367d42d52346bd65477d72516ab25889c4c8a11dbb1532d90f0cff0de880e723806d7aef410a7ab86a6dd5450ca987682917ae548e92185cdf17328cf7444d203ee60b5e3354a1b64ecc6aa171d950b201d40414d43f18b09e6e17e53b530afb52db1ef6b3a4efb7d4d0a6febea44a1edac91a1a60448bb0b3488408a953dd3835850b55cf3d9ac44257ebd42e79117f4c1902064e0c374f7f0807c14e1eec71f9de445ba5a4d03fea27b91834d2ebb45e5939dbdc5227b0cdfbc74e0ded4d987b2ee14eb6225cd5b339b521aa57c3dde660e82260f2caeb0591ded3670a67c901eccfe1cf73b990a00d7f8c9ddc4fd7041adf914ad1bcf12c719e49880d677ba859bbb40d32c58329f0fe77ef82cc42ce2498dd99f4749050d156c1311d56e0cf7f512d5aa071b747e12a1f5856a39aa8d5ab4098873138ad645615715395fe090805dfbddc8634ca33592a0517dcab445b7d28696ff60676398ded7e96bac399783b04bec02cab3f6a9282d2340cd376810b2998ab50a2890d44daf8e4da9e235b1fed5579d8d13df8205bf7f21a7f8bbe20e309a97a607dfedfe1ecbb1fe58bc381852c11b868732d1674505183dadd9a236acdde3e8310be34915a1a4441e6995361dca87324358f7524469773d3f14029162e32fafba245c14aa997716aeeff3a256037e527d4e79da1a058b179dde90f7ab20cbfa662f04e6306d1c0da8a5f72e391b6e3844e589c68dbe02de8b1da2ead3596152ffd21bd91f7136bc59679c14af2ae5642489d9cfdb033fb9588da2700c971aed4af037ad4dad1a8524df909f47ec3247e197b6880140ff2eab28a9e990038ce89b3dacbb6887fae4fa7703f9da6fae14872a4afc0081f46ae92308564db17b002fe7020f461ef977dcf1f6af93a37081b5a43a508c441eb3c30d30ef8d49825a8b755dc0bf5ae54df61703a2363c188ace5d418ac23faf3896d9a914072ce1629606ada25caad4cc99549877ca1f6cf2c3fc83219445f28a9742694713a272e054e337ce6b03ecb020389f425723eb6e723e55f16d1be018619edb794c11745538e4e7c1138ea8d4fad175cab94cb3051e222eedda5655629f380a1e7fe9e6a83616b6c3b615a68f1c6a233ba7346865127caa47512ab1b36a945a9c69bb13e333b2766733f1aa0c77494e025c90f96bb8cc5e5addabf61de7c016df5e5ee733d4bcb834222c669a131be4dde2c38aaf863bfe1eaeba84cc6b0162774819be070be0f26ad79d0f60f3377b7d8d369e07a4be03ae37a241f37a4b66deec60ae7d4b7b005efd391210aa2e4081e913b73298f6d93bb333cbdb1304509b0019cc12de0e17e8c7478f5edd9ef0b6a8fab10e6d6ba70a38b8941599284d0a1d58a4c059e8d123cc4cbf86b6aae587955249eed54f18ae8abf7a60b685749719d8a7be18d32d812b7a84836362ef4f4900b8d21820571ae44f0a209444db40de3333edea76f9abbd6ebf5f43acce8b6b672a1590b5f642a1a6a1b9e7b90942257e4a19f2a101d00afac7148f9a55758664c17d45d59899781d83e5c84e5bbbb0399580209e73d762b4d203dc3d2304e2acb752cc0a06da7a4371ee28fdd021693f2c5970eddf9e63dd8740d3a77d7d1ad573024e79ee982ea5cd40056ccb935b7c12894ce5379378f455e1a1a286927f2f431e1e4c55ebcf5d2bac66283e2d1a2621f07a101a2d17669badb95f6a99352650e2f3c9432d9e36963bc10adaacfaa91247c9879b14093897e8213ae47a7b653a39953a844c869ffdb9c3805abc903a5a0d42ed5e2d2c64a9dfee9aafb791cd5e952f8e5abe0acf1a91eab8ddbc1c8653dc8544ea10782b280023dcf6e0dcff2cec53216afe2045b0c8199d55ca4eebe15c40906af992d92cd94f37f86c86c2b25c303aa40784a503c9578f4057dfc4615a8ea69205e665ed9140df22d7387ccc2d65bdc9afcbd06a7babc379ea1a393e9a4efec1d9523486a567bbe04833bd88ccae36a06bb03b1b98c1986c7686fddd72cc3134cf86f48fddc1c4c9787d159218af3d8124ee6d20c8896562796037f598a16cc4a837fcfc6dcea2de7f00f4e4c18e338a233d91755d2c0e3062d4728603db519a07a95ac2c7e2e2b516a1f456f7f2e830f5ea1feed4bef439aceb28e265a64548ce2777f0c14fbdc9a81bdae75c29f14e2b1bf2c0b2220bceed9c0b0a60f6ddbb0be825eca4b51e9fbee4e9cb78076855a14f44d7f365011baa77c3fb426c5b18fe99f2712b1dc7d17d67e3c11eb866b8273388127d59ae44a3a0c2165193c4db27ed148a0dd6a03122b975227debaefe479fe56fc7effe2543c668166b87614ad21933def26214b59b4066ad258fd3265fd40abc7365924aa1f436501e259e43d9721a8f0d55502f92a68bd7029804456b67bd103036dd57cdd12e29d60f0968cc14b09cc6af3a62b046691227bae7a2b3000c093aa9fae51f77bba0125b777d54932b6f1618c18ab4d947daa370c4e5be622744fd78c253de9d9ba3dc69c9eac4d9f40d4b91dfa08bd5b31128b70cf9852d3db76b69410991f2715217dae4517df4d83d4ae9468c2032f0b0c4017408ed7efa5e03914cb40895c5dfb8f2e234085d47e23cc00fc5a323cc70e64367b127d5ef9231d5128c9a68556ed08b58104cbbeac6c597dc22dded8c605577da4bcba897136d87b794209ed7f77a53efdb4232660aaa2390b3206a165efc64cc98cb947fae930bb7a728405c7f45b214f8b291b30b5e5dcd6b7bf90cbe46741857e4ef98b7c046b2a1011cbf48086d2d812853d14cca8135c1a2b438600953de4fdf35186340ccaad0c193cdbad17f0f0c6167ea749346cf861a1e91c21af789b0713eea2c21c069fd63de3f83be4c40dba0fefb6f474a908a7f92f07da6e5f214ccc2e57ea242e162066b4e6604702d01c07c495e7d729e7a67ac114d15fcda71e53985a43b57f2a18d32cb4aea07830c226b36508bb804a377698efd4a13fb5f536f1a1a18081007f966ab9dd5407da3b8d48a370ce190cc8a50df672742c30688640254216835e571e682938fddf7c7b0138196734f3064be8296764d74033751e3396aed0b71ca625663ab7c8a5d936a5040b36205214ff26727515fdde86c571d92520b569f23e17bb1857458b54984f0986874141b83dfd45bd6317b2fe73035c858de911f8906ed0e4e97fdaedc560645bab7fcf88f43753763dd46cca85a4bc5b04329c8445fa66737c0e22ad056de2125b83935174f7dd10bb63cf9f0b76e00f6fcd9b519b808ab06a28d5d9bb82a93f2d69f5cba6d5a3eea17266dc29899dbbe34ac91c99cd2de60196478ee11309a61223368ef0af12bc7b3ea595033ccd612ea64573ac2aff5a96c40d71e5566ec3ee60c90aa6734d51efed4360471d3797267b4f352810ba34e57dc24165c9886949b741964c7fe96a7525945d73de449b54724e7bdfbb45a02571b69ecf189dd014fffc6ea6141c544163b359ab59fd2209d8210b75aaca8bba6fcdc939f7b5af46f339ee7d8cd21eb11aacbe33c68f6aa73c20a2b38725bd202ca18c66e5488c13b99cc70fab664c7ac4288b5186cc8f950606c15c5977d4c51ed1ed9df6d9ea98d2adc49f9ec569411ffeb98539464186e5695fac92c88aab0f5eed0b6a5309af2eb19d77e0eecb8bf2cd756b6401401b7529b249b278e0b831c1695978eecb0d66d43e047abf31164fbe532fa972f02cd7564e9cde2736fcf9cb9bd31bf8a86e6ec47d24fbff068d686acef43ff0b2f12daf2c733d3820c96ac435cadfd5d2304634a0a8a13643dee7995afd16be7cfd3b1912ef0c79f764fd7a465c777979aa7c44dd518009a10e256077f1b7cd33918569f6f6ebad0d879bf84c0413e9223d86a5f5187f6079d5c84cbf7946d5492e2a9cd43bd7b5fefe9ebe1fb51ecde08ead063512c815d62bec4569dae8c0d532761444a1903c9880082c6d2a3c4c66865a5e50994c294bf9a5e9259dc55b9c9f11063932bcf1e341ae33e65b62a733368a2205d9c7511de187a180750781255b9db797c4c6c1af88f8b876e1d61df43d7c087de48c3fca40e8e8743d32fe607f6a872c87bfbae636e66d6d14c124613efdbcd001e06f04c257389904a6d7a62f8017a1528842b10d862386c936618674d416a3f6efe1097b38e59fc5154dbcb0866d4a81fb8db2bcf82684dce6f60d3c540c153ba5edfe861e228139fb2d5edcc6537a2e2451c5c795a56fbde21a3eb8aa2fc0fb7c563161da77956471bb68fc96458fde682ba0e14df377a3a2bf1bcd603e427953a8af0e42a942fcef7e7359401967940662b56b13ab4388b9b81a17e87fe93bd48e8ceb634f5cf469ce9c7d886bcdc113450b5389230d14183d875689e200de807c61cb78b91d9b1ec778c0562e06afca4f68ea8879469019ea153478ca098d7a838c265f0900b6bfc01b04b72f7ef9387afa8d743a35debc4eb93bb69e2d10a940bf6b43975cefc0012dd1bf6ffe76f9bfcabfcb6a15fbf57c19f01fb3d0520620ede6099bf93c6883063fe20a30f912b99d91d0c4bf1b78a5077dcd9d4224066d052e9903cbc332a3b15323e8352a97cc1c063a0a4d06ae3dac2c05c8ecf59ddc1a00eb5d7d79f88d8b6c3d7228585b9d72f0a6d42b8058e526a4d5688b7517e0298168ce7282ccffe9ca7287af9d8d3456450e7988aec0b22da170abc804c16767edb736bc4fb64a9666c0c7ea3009f5fef12f56fc62f03059353a2831301951f90ea52c7575433fd913bcfd81389e87ad2c4397378f64f85c76b8ea2e6e1619748e881646e1c9e13c74ddbd12e9e97f2879a8b383d77d3e48614e093625cf1018bf35a499e4f51e662fe460aaa0ec6f8e2f05f73a208db9e5bd009aad652b871eafd9e12c6c72d6630d6b15fdefc7a06a3410ea0ea64b27cd96d377153bf32e7d4bcbc0586bed34bd71ca0846864391edc68ffe257488b6f3ad11968065fde7806fcdb85a9ced31cbe70bd3c8fd67d080328b7006b5436ec22704c43872cae250e1125e04b51caaa09a9be44c32357fedfde35ccf6886ab098ab677540533e7b1c3ade705336def20110a6561fde568b71a5a5346241b2a2daa251de38530446a2ef0e8569b1c935d7e98680083ae4ae0292e93dbc7f4c9a876864d9dd1c4411007b8c03c21db8139baf9672d3642a12cf253bb3e8c77af9c2f10a239d75920eca7f8004ce25b9d336a8783de9a293d187d27e9851beaa3b2fc02b55d124364dc40e30ad0134b5c79eacb2c5f7b20d1833420e5127dbfdadb26f261e6ec5db0f18eade486348c589cb0d6e0c2cde17deca41bc6ed2bb0ff41eb7d7540df21ca850a1538a01bd3bb27aef54e1b538d101afc449283f4e99241caf114dcd92d437556fdbd71ad627efdd9ad76af63015033a2bb006f78ee3f89a2403e2f9c5a7a3a9b8bedd5b84e1830dd70f5a4f27aac9dfd2de16264b1ed694093cbfe8e29cfcbf12b82256ade4d3705fde5079f9a65d45e9f96c7f2fb072714975d972b48d7d777884d5e001e98a04e54fe6f35f080fa0c8a1eb85423a063094dc9fb50151d34deeb4cb03d43de519fb8f66b6d6f4302bc51faecf36db0d1a5a2dfed8f319cf385a239b99d9bfbfe186cafc814a6ce0b6d7deb031b4eb9873644ee869dbdbd4f71708e2d0069f71c81d2a1c9858012989c804c09d49778d5243b102674fd2d503b7c6658d432b4c28f80223955109e58803828dda65cbd1324d5a741563ac5f3bf737fe9deadec08a24259f188676ce4ce288cfd487c93e9800df23b470cce16ca57b8a78b3f5987b6f5bc8d46029cf6e1c98350e07f81d9bece1c23b74574227102e5ce416b6aeb6fb97007fd156ddbbe48f2195fdb13062a5c869f46b1ee36a0088e3db3bb07a5f4696714a67923c118c166074d7b700ee9958c3d46a6854a67231a973b3e215e088627945284916f85d3c35b63e58aa9e4f9932cca8f339092b12953c5f0d1801f27adba99c1b2383d0d3d0201b53fbe66629a8d47bb78e4c1c989ce2344183b099df333c2e39946966e32400a6e76fecbb30c069dd1fd8fc7f1613b77ba399c92618dc347a4fcc426322746686afb0c6903dc77d04edd7a526f7556c3c216e821e779fb572a4fc4bf8a81fc2d0c2d70d0b4ab707cf1a5a456679a5062ba89cf4ef813f0e2ef569fd6f44a9ace8bc7b46173190dddb1b3b561e4dabd122d60819567a351a861001059f30b3bf8c67165ce0f0a25fefb96e464eb352ea9bb479ebaad80eb6b0438b5b4b71ead72c92095d5ad94175cee88f744a2c4ba4192a3f105a3c570a60ad756085e119f03e15a7d11c772d28fe1872429693d28a97f15d002805bf4f7fe8b79aa8212ebbf402dce5c7a11a2be22b912e84908b8ae548cbae4f20b6955601f6154511548118fb9190f80b961e943dea2e55c7b43bf4c82ab3e4ecff4f8f72c14cbca13d242b6cd9d2b4d210449c6d52389b7e442a31cc2ad1e464bde7f3425f81349a37d03978fed23f195869d8355ce20d0c9e822128fb43b5c05f9ee23d112de78bcf9b2be54ba7bf882569335181eb4ab995cd68643f951485abdef11b1d0975cb350baf7fe3d84d7d0a16fe946ba7817b314ec8507d6eab7b1e30aa717cb0be386f26b5ac60e9a50c8e22476ee85abf836dd17c23815ec21b5d00fdc454f2d9acb023d550a6c07b1ae120674c4ae4ef85f4e6d5b67a5da446d7919ebf479c1ca5821de445ecb6ced32571f83179368b04525b03eb33da86e9588206c51fcc1d2583e3ffca7f825c87a0c7143fae9c02255d5688e19a3b4ca0c6ae68e65843f56a34ff861530ea587b5c079455e4a260ee4415e89490d8e5e59f6e2d8865ed5e8a0ea4a640b548b496428ef4fdb3876cf522496a6f552e376f9e033b50548d0f062387cffc7dfcbbd1e3a90a887ad8236262492a86b1d5bbd2502d23d8e73ceea7f280dd06cd673c37cc1a142d2db3115bf41a5e4903e0aa906823ce5516428145508df50c6d206bd5d2d7f44e69407230024e39ffc6672e7418d7de94e840ea00972e6f2aae8e6fd864f9e0a39a837404bc6b75d1851a03e1db29df12000547131c713b196fca811c72e38256f7b70f910ef7a49a6a439e4e927f404a446ea33eba81992f3e6009a4069173a2cf595b7fac6da75a96106ac34c72695a3dc7b0387aba5245f20a55142bece3fde79c17a076605ff3ddbe317b84492a8eab0c91da23cfe4fe7c47c1f24d639008ad4c02c4e129bcb9208b987fb26984ff1a903d252680173296508a29bcc1b38f7d87536f76baadf71fa204f9258e45f4f7ac0e7210ca94fccfb7cd1368fbf02af2e38f8504c3a31edac8bcb2f36ac6a120b57f5a444b52b4880a79495900b06bf3899b6e2bce792a636889257d714ec6350a51dc3b302f0fa9ce02b69d18d97122a0e85fbb262164f8bbb8b18f1181d0b179e0e0748c47631d83c545328bc76a53a6218527fa0bf31831e379255049d717c7526ced0667b9aad251e1da4fa46aa1a4a1cba584716c21dfddcefdbbf1c2dab48be51ec258cdafbed37bfccd93620de2acefc803290cf816c91c2ec90a84238af6961de3953b74db8a0ec0d5381f3f8a0e8336e72b3bab267d67ef554ef363655a09ffc5d0fa6e9c877b74e2c21ad009d9e26b46b46548b0cb03dd8f6de7b5a38ea5f9314f3dca1d6a8f4c77a00f943ff7c3287d90cea44bbed9d9f4ef9d84576851909f2337b00b11e5ceeea41f1da055444e14377e71647c9d4cea96a14aba2e745a277f839f443f6f80b8cc996de20abbfc7cf8696a4d266730cbe5b82f4ec11a557cad17ca77f2f2de6edf88eadea8b38b771bff670b432cb04928279f0f51b1aadb8a0bb646d0a81414077939d44fff5956eebca1eed4b0f69a4b8c5d1186c9a3a2d6b5bfc90a9192b6a17ab75c705e189731b9a99c8c10a50eea82f723bb09a1d008fde27dd6abd5ed1f7d28c16cf65c5a84319e49abe5fd4622ac5057703c9e34686bcf012edffa8dc0d5bcc8ce43d23ce1d6b1789586e6f48ee2e0ff92d7bac8e0b3e105c332cd73697cf44ce76</script>
</div>
<script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
      <categories>
        <category>数学</category>
      </categories>
      <tags>
        <tag>Math</tag>
        <tag>离散数学</tag>
      </tags>
  </entry>
  <entry>
    <title>重拾 Golang</title>
    <url>/posts/191026/</url>
    <content><![CDATA[<h2 id="什么是-Golang？"><a href="#什么是-Golang？" class="headerlink" title="什么是 Golang？"></a>什么是 Golang？</h2><blockquote>
<p><strong><a href="https://golang.org/">Go</a></strong>™ is an open source programming language that makes it easy to build simple, reliable, and efficient software.</p>
</blockquote>
<h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2><h3 id="类别"><a href="#类别" class="headerlink" title="类别"></a>类别</h3><ul>
<li>静态语言</li>
<li>编译型语言</li>
</ul>
<h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><ul>
<li>语言层面支持并发</li>
<li>无依赖，直译机器码</li>
<li>内置 <code>runtime</code>，支持 GC</li>
<li>可跨平台编译</li>
<li>支持内嵌 C</li>
<li>丰富的标准库</li>
<li>学习曲线低</li>
</ul>
<h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><ul>
<li>接口是枚举类型</li>
<li><code>import</code> 包不支持版本</li>
<li><code>goroutine</code> 一旦启动，切换将不受程序控制</li>
</ul>
<h2 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>　根据操作系统，在 <a href="https://golang.org/dl/">Download</a> 页面下载对应的安装包，进行安装</p>
<h4 id="MacOS"><a href="#MacOS" class="headerlink" title="MacOS"></a>MacOS</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 安装完成后，iTerm 中看到可以执行 go 命令了</span></span><br><span class="line">$ <span class="built_in">which</span> go</span><br><span class="line">  /usr/<span class="built_in">local</span>/go/bin/go</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ wget https://dl.google.com/go/go1.14.4.linux-amd64.tar.gz</span><br><span class="line">$ sudo tar -C /usr/<span class="built_in">local</span>/ -xzvf go1.14.4.linux-amd64.tar.gz</span><br></pre></td></tr></tbody></table></figure>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 环境变量</span></span><br><span class="line">$ vim ~/.bashrc</span><br><span class="line">  <span class="built_in">export</span> GOROOT=/usr/<span class="built_in">local</span>/go</span><br><span class="line">  <span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$GOROOT</span>/bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 工作目录</span></span><br><span class="line"><span class="comment"># bin: 存放可执行文件</span></span><br><span class="line"><span class="comment"># pkg: 存放编译好的库文件</span></span><br><span class="line"><span class="comment"># src: 存放 go 的源文件</span></span><br><span class="line">$ mkdir -p ~/code/gopath</span><br><span class="line">$ vim ~/.bashrc</span><br><span class="line">  <span class="built_in">export</span> GOROOT=/usr/<span class="built_in">local</span>/go</span><br><span class="line">  <span class="built_in">export</span> GOPATH=~/code/gopath</span><br><span class="line">  <span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$GOROOT</span>/bin:<span class="variable">$GOPATH</span>/bin</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">source</span> ~/.bashrc</span><br></pre></td></tr></tbody></table></figure>
<a id="more"></a>
<h3 id="Hello-world"><a href="#Hello-world" class="headerlink" title="Hello world"></a>Hello world</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 创建项目目录</span></span><br><span class="line">$ mkdir -p <span class="variable">$GOPATH</span>/src/<span class="built_in">test</span>/hello</span><br><span class="line">$ <span class="built_in">cd</span> <span class="variable">$GOPATH</span>/src/<span class="built_in">test</span>/hello</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编写 go 源文件</span></span><br><span class="line">$ vim hello.go</span><br><span class="line">  package main</span><br><span class="line">  import <span class="string">"fmt"</span></span><br><span class="line">  func <span class="function"><span class="title">main</span></span>() {</span><br><span class="line">      fmt.Println(<span class="string">"Hello, world!"</span>)</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行</span></span><br><span class="line">$ go run hello.go</span><br><span class="line">  Hello, world!</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译</span></span><br><span class="line">$ ll</span><br><span class="line">  total 4.0K</span><br><span class="line">  -rw-r--r-- 1 benedictjin wheel 75  1 15 11:20 hello.go</span><br><span class="line">$ go build</span><br><span class="line">$ ll</span><br><span class="line">  total 2.0M</span><br><span class="line">  -rwxr-xr-x 1 benedictjin staff 2.0M  1 15 11:20 hello*</span><br><span class="line">  -rw-r--r-- 1 benedictjin wheel   75  1 15 11:20 hello.go</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行可执行文件</span></span><br><span class="line">$ ./hello</span><br><span class="line">  Hello, world!</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理编译的中间文件</span></span><br><span class="line">$ go clean</span><br><span class="line">$ ll</span><br><span class="line">total 4.0K</span><br><span class="line">  -rw-r--r-- 1 benedictjin wheel 75  1 15 11:20 hello.go</span><br></pre></td></tr></tbody></table></figure>
<h3 id="下载依赖"><a href="#下载依赖" class="headerlink" title="下载依赖"></a>下载依赖</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ GOROOT=/usr/<span class="built_in">local</span>/go</span><br><span class="line">$ GOPATH=~/code/gopath</span><br><span class="line"></span><br><span class="line"><span class="comment"># 单个依赖</span></span><br><span class="line">$ /usr/<span class="built_in">local</span>/go/bin/go get -t -v github.com/golang/snappy/...</span><br><span class="line"><span class="comment"># 所有依赖</span></span><br><span class="line">$ /usr/<span class="built_in">local</span>/go/bin/go get -t -v ./...</span><br></pre></td></tr></tbody></table></figure>
<h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><h3 id="go-mod"><a href="#go-mod" class="headerlink" title="go mod"></a>go mod</h3><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">命令</th>
<th style="text-align:center"><strong>说明</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">init</td>
<td style="text-align:center">在当前目录初始化新的 mod 模块</td>
</tr>
<tr>
<td style="text-align:center">graph</td>
<td style="text-align:center">打印模块依赖图</td>
</tr>
<tr>
<td style="text-align:center">download</td>
<td style="text-align:center">下载并缓存依赖包</td>
</tr>
<tr>
<td style="text-align:center">vendor</td>
<td style="text-align:center">将依赖复制到 vendor 下</td>
</tr>
<tr>
<td style="text-align:center">edit</td>
<td style="text-align:center">编辑 go.mod 文件</td>
</tr>
<tr>
<td style="text-align:center">verify</td>
<td style="text-align:center">验证依赖是否正确</td>
</tr>
<tr>
<td style="text-align:center">why</td>
<td style="text-align:center">解释为什么需要依赖</td>
</tr>
<tr>
<td style="text-align:center">tidy</td>
<td style="text-align:center">拉取缺少的模块，移除不用的模块</td>
</tr>
</tbody>
</table>
</div>
<h2 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h2><h3 id="常量"><a href="#常量" class="headerlink" title="常量"></a>常量</h3><h4 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">const &lt;常量名&gt; &lt;常量类型&gt; = &lt;常量值&gt;</span><br></pre></td></tr></tbody></table></figure>
<h4 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h4><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> NODES <span class="keyword">int</span> = <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    NODES        <span class="keyword">int</span> = <span class="number">4</span></span><br><span class="line">    SHARDS       <span class="keyword">int</span> = <span class="number">64</span></span><br><span class="line">    REPLICATIONS <span class="keyword">int</span> = <span class="number">3</span></span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="三元表达式"><a href="#三元表达式" class="headerlink" title="三元表达式"></a>三元表达式</h3><h4 id="说明-1"><a href="#说明-1" class="headerlink" title="说明"></a>说明</h4><p>　Golang 并不支持三元表达式，只能用 <code>if-else</code> 来表达对应的含义</p>
<h4 id="举例-1"><a href="#举例-1" class="headerlink" title="举例"></a>举例</h4><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> expr {</span><br><span class="line">    n = trueYuzhouwan</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">    n = falseYuzhouwan</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h3><h4 id="说明-2"><a href="#说明-2" class="headerlink" title="说明"></a>说明</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">var &lt;变量名&gt; [SIZE] &lt;元素类型&gt;</span><br></pre></td></tr></tbody></table></figure>
<h4 id="举例-2"><a href="#举例-2" class="headerlink" title="举例"></a>举例</h4><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 声明数组变量</span></span><br><span class="line"><span class="keyword">var</span> yuzhouwan [<span class="number">10</span>] <span class="keyword">float32</span></span><br><span class="line"><span class="comment">// 初始化数组</span></span><br><span class="line"><span class="keyword">var</span> yuzhouwan = [<span class="number">3</span>]<span class="keyword">float32</span>{<span class="number">0.1</span>, <span class="number">0.2</span>, <span class="number">0.30000000000000004</span>}</span><br><span class="line"><span class="comment">// 不指定数组长度，Golang 会根据数组内的元素，来设置数组的大小</span></span><br><span class="line"><span class="keyword">var</span> yuzhouwan = [...]<span class="keyword">float32</span>{<span class="number">0.1</span>, <span class="number">0.2</span>, <span class="number">0.30000000000000004</span>}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 遍历数组</span></span><br><span class="line"><span class="keyword">var</span> arr [<span class="number">3</span>]<span class="keyword">int</span></span><br><span class="line"><span class="keyword">var</span> i, j <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++ {</span><br><span class="line">  arr[i] = i</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> j = <span class="number">0</span>; j &lt; <span class="number">3</span>; j++ {</span><br><span class="line">  fmt.Printf(<span class="string">"%d = %d\n"</span>, j, arr[j])</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印所有元素</span></span><br><span class="line">fmt.Printf(<span class="string">"%v\n"</span>, arr)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 增加新元素</span></span><br><span class="line"><span class="keyword">var</span> yuzhouwan [] <span class="keyword">int</span></span><br><span class="line"><span class="keyword">for</span> n := <span class="number">0</span>; n &lt; <span class="number">3</span>; n++ {</span><br><span class="line">  yuzhouwan = <span class="built_in">append</span>(yuzhouwan, n)</span><br><span class="line">}</span><br><span class="line">fmt.Printf(<span class="string">"%v"</span>, yuzhouwan)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="List"><a href="#List" class="headerlink" title="List"></a>List</h3><h4 id="举例-3"><a href="#举例-3" class="headerlink" title="举例"></a>举例</h4><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">l := list.New()</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">3</span>; i++ {</span><br><span class="line">  l.PushBack(i)</span><br><span class="line">}</span><br><span class="line"><span class="keyword">for</span> e := l.Front(); e != <span class="literal">nil</span>; e = e.Next() {</span><br><span class="line">  fmt.Println(e.Value)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h3><h4 id="举例-4"><a href="#举例-4" class="headerlink" title="举例"></a>举例</h4><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 初始化</span></span><br><span class="line">site := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span>{</span><br><span class="line">  <span class="string">"yuzhouwan"</span>:   <span class="number">0</span>,</span><br><span class="line">  <span class="string">"blog"</span>: <span class="number">1</span>,</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 增加新元素</span></span><br><span class="line">site := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span>)</span><br><span class="line">site[<span class="string">"yuzhouwan"</span>] = <span class="number">0</span></span><br><span class="line">site[<span class="string">"blog"</span>] = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断指定 key 是否存在于 map 中</span></span><br><span class="line"><span class="keyword">if</span> value, exists := site[<span class="string">"yuzhouwan"</span>]; exists {</span><br><span class="line">  fmt.Println(<span class="string">"value: "</span>, value)</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">  fmt.Println(<span class="string">"key not found"</span>)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 遍历</span></span><br><span class="line">m := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span>{<span class="string">"yuzhouwan"</span>: <span class="number">1</span>, <span class="string">"blog"</span>: <span class="number">2</span>,}</span><br><span class="line"><span class="keyword">for</span> k, v := <span class="keyword">range</span> m {</span><br><span class="line">  fmt.Printf(<span class="string">"%s=%d\n"</span>, k, v)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 按照 Key 排序后遍历</span></span><br><span class="line">m := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">string</span>)</span><br><span class="line">m[<span class="number">1</span>] = <span class="string">"a"</span></span><br><span class="line">m[<span class="number">2</span>] = <span class="string">"c"</span></span><br><span class="line">m[<span class="number">0</span>] = <span class="string">"b"</span></span><br><span class="line"><span class="keyword">var</span> keys []<span class="keyword">int</span></span><br><span class="line"><span class="keyword">for</span> k := <span class="keyword">range</span> m {</span><br><span class="line">  keys = <span class="built_in">append</span>(keys, k)</span><br><span class="line">}</span><br><span class="line">sort.Ints(keys)</span><br><span class="line"><span class="keyword">for</span> _, k := <span class="keyword">range</span> keys {</span><br><span class="line">  fmt.Printf(<span class="string">"%v : %v\n"</span>, k, m[k])</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h3><h4 id="说明-3"><a href="#说明-3" class="headerlink" title="说明"></a>说明</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">type</span> &lt;接口名&gt; interface {</span><br><span class="line">    &lt;方法名称&gt;() &lt;方法返回值&gt;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="举例-5"><a href="#举例-5" class="headerlink" title="举例"></a>举例</h4><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> Value <span class="keyword">interface</span> {</span><br><span class="line">    String() <span class="keyword">string</span></span><br><span class="line">    Set(<span class="keyword">string</span>) error</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="自定义数据类型"><a href="#自定义数据类型" class="headerlink" title="自定义数据类型"></a>自定义数据类型</h3><h4 id="说明-4"><a href="#说明-4" class="headerlink" title="说明"></a>说明</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">type</span> &lt;自定义类型&gt; &lt;原始类型&gt;</span><br></pre></td></tr></tbody></table></figure>
<h4 id="举例-6"><a href="#举例-6" class="headerlink" title="举例"></a>举例</h4><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> ErrorHandling <span class="keyword">int</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="给自定义数据类型扩展方法"><a href="#给自定义数据类型扩展方法" class="headerlink" title="给自定义数据类型扩展方法"></a>给自定义数据类型扩展方法</h3><h4 id="说明-5"><a href="#说明-5" class="headerlink" title="说明"></a>说明</h4><p>　可以使得自定义数据类型作为某一个 interface 的实现类，只需要扩展 interface 中申明的方法即可</p>
<h4 id="举例-7"><a href="#举例-7" class="headerlink" title="举例"></a>举例</h4><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> Value <span class="keyword">interface</span> {</span><br><span class="line">    String() <span class="keyword">string</span></span><br><span class="line">    Set(<span class="keyword">string</span>) error</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> StringsFlag []<span class="keyword">string</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(v *StringsFlag)</span> <span class="title">Set</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="title">error</span></span> {</span><br><span class="line">    <span class="keyword">var</span> err error</span><br><span class="line">    *v, err = str.SplitQuotedFields(s)</span><br><span class="line">    <span class="keyword">if</span> *v == <span class="literal">nil</span> {</span><br><span class="line">        *v = []<span class="keyword">string</span>{}</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(v *StringsFlag)</span> <span class="title">String</span><span class="params">()</span> <span class="title">string</span></span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"&lt;StringsFlag&gt;"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="初始化空的结构体"><a href="#初始化空的结构体" class="headerlink" title="初始化空的结构体"></a>初始化空的结构体</h3><h4 id="说明-6"><a href="#说明-6" class="headerlink" title="说明"></a>说明</h4><p>　<code>struct{}</code> 表示一个空的结构体，不包含任何的属性和方法，相当于 Java 中的 <code>Object</code>。而 <code>struct{}{}</code> 表示对空的结构体进行初始化，相当于 Java 中的 <code>new Object()</code></p>
<h4 id="举例-8"><a href="#举例-8" class="headerlink" title="举例"></a>举例</h4><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span>{}{}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="defer-异步"><a href="#defer-异步" class="headerlink" title="defer 异步"></a>defer 异步</h3><h4 id="说明-7"><a href="#说明-7" class="headerlink" title="说明"></a>说明</h4><p>　被 defer 关键字修饰的函数调用可以异步地执行。多次 defer 异步调用之间会以逆序的顺序执行，类似于压栈出栈的过程。并且，defer 修饰的函数会在外层函数返回之前进行调用（准确来说，是在外层函数设置返回值之后，在即将返回之前）。因此，defer 常用于资源的释放</p>
<h4 id="举例-9"><a href="#举例-9" class="headerlink" title="举例"></a>举例</h4><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">1</span>; i &lt;= <span class="number">3</span>; i++ {</span><br><span class="line">        <span class="comment">// noinspection GoDeferInLoop</span></span><br><span class="line">        <span class="keyword">defer</span> fmt.Println(i)</span><br><span class="line">        fmt.Println(fmt.Sprintf(<span class="string">"for %d looping..."</span>, i))</span><br><span class="line">    }</span><br><span class="line">    fmt.Println(<span class="string">"done"</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> 1 looping...</span><br><span class="line"><span class="keyword">for</span> 2 looping...</span><br><span class="line"><span class="keyword">for</span> 3 looping...</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">3</span><br><span class="line">2</span><br><span class="line">1</span><br></pre></td></tr></tbody></table></figure>
<h2 id="实战技巧"><a href="#实战技巧" class="headerlink" title="实战技巧"></a>实战技巧</h2><h3 id="镜像加速"><a href="#镜像加速" class="headerlink" title="镜像加速"></a>镜像加速</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ go env -w GO111MODULE=on</span><br><span class="line"></span><br><span class="line"><span class="comment"># Golang 官方</span></span><br><span class="line">$ go env -w GOPROXY=https://goproxy.io</span><br><span class="line"><span class="comment"># 阿里云镜像</span></span><br><span class="line">$ go env -w GOPROXY=https://mirrors.aliyun.com/goproxy/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 私有库不走代理</span></span><br><span class="line">$ go env -w GOPRIVATE=yuzhouwan.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查是否生效</span></span><br><span class="line">$ go env</span><br></pre></td></tr></tbody></table></figure>
<h3 id="多文件编译"><a href="#多文件编译" class="headerlink" title="多文件编译"></a>多文件编译</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ GOROOT=/usr/<span class="built_in">local</span>/go</span><br><span class="line">$ GOPATH=/Users/benedictjin/gopath</span><br><span class="line">$ /usr/<span class="built_in">local</span>/go/bin/go build -o /Users/benedictjin/output /Users/benedictjin/yuzhouwan/main.go /Users/benedictjin/yuzhouwan/sub_process.go</span><br></pre></td></tr></tbody></table></figure>
<h2 id="常用框架"><a href="#常用框架" class="headerlink" title="常用框架"></a>常用框架</h2><h3 id="influxdb-comparisons"><a href="#influxdb-comparisons" class="headerlink" title="influxdb-comparisons"></a><a href="https://github.com/influxdata/influxdb-comparisons">influxdb-comparisons</a></h3><h4 id="基础环境"><a href="#基础环境" class="headerlink" title="基础环境"></a>基础环境</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ wget https://dl.google.com/go/go1.14.4.linux-amd64.tar.gz</span><br><span class="line">$ tar -C /usr/<span class="built_in">local</span> -xzf go1.14.4.linux-amd64.tar.gz</span><br><span class="line">$ vim ~/.bashrc</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> GOPATH=~/code/gopath/</span><br><span class="line"><span class="built_in">export</span> GO_HOME=/usr/<span class="built_in">local</span>/go</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$GO_HOME</span>/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">source</span> ~/.bashrc</span><br><span class="line">$ go version</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">go version go1.14.4 linux/amd64</span><br></pre></td></tr></tbody></table></figure>
<h4 id="源码编译"><a href="#源码编译" class="headerlink" title="源码编译"></a>源码编译</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ mkdir -p ~/code/gopath/src/github.com/influxdata/influxdb-comparisons</span><br><span class="line">$ <span class="built_in">cd</span> ~/code/gopath/src/github.com/influxdata/influxdb-comparisons</span><br><span class="line">$ yum install git -y</span><br><span class="line">$ git init</span><br><span class="line">$ git remote add upstream git@github.com:influxdata/influxdb-comparisons.git</span><br><span class="line">$ git pull upstream master:master</span><br><span class="line">$ go get -t -v github.com/influxdata/influxdb-comparisons/...</span><br></pre></td></tr></tbody></table></figure>
<h4 id="生成数据"><a href="#生成数据" class="headerlink" title="生成数据"></a>生成数据</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/code/gopath/src/github.com/influxdata/influxdb-comparisons/cmd/bulk_data_gen</span><br><span class="line">$ go build github.com/influxdata/influxdb-comparisons/cmd/bulk_data_gen</span><br><span class="line">$ ./bulk_data_gen --scale-var=10 --format=opentsdb --timestamp-start=2020-01-01T00:00:00Z --timestamp-end=2020-01-01T00:01:00Z &gt; /data/opentsdb_scale10_data.json</span><br></pre></td></tr></tbody></table></figure>
<h4 id="写入数据"><a href="#写入数据" class="headerlink" title="写入数据"></a>写入数据</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/code/gopath/src/github.com/influxdata/influxdb-comparisons/cmd/bulk_load_opentsdb</span><br><span class="line">$ go build github.com/influxdata/influxdb-comparisons/cmd/bulk_load_opentsdb</span><br><span class="line">$ cat /data/opentsdb_scale10_data.json | ./bulk_load_opentsdb --urls=http://yuzhouwan.com:4242 -workers=64</span><br></pre></td></tr></tbody></table></figure>
<h2 id="踩到的坑"><a href="#踩到的坑" class="headerlink" title="踩到的坑"></a>踩到的坑</h2><h3 id="version-go1-11-9-does-not-match-go-tool-version-go1-11-5"><a href="#version-go1-11-9-does-not-match-go-tool-version-go1-11-5" class="headerlink" title="version go1.11.9 does not match go tool version go1.11.5"></a>version go1.11.9 does not match go tool version go1.11.5</h3><h4 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ brew uninstall --ignore-dependencies go</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">Uninstalling /usr/<span class="built_in">local</span>/Cellar/go/1.11.5... (9,298 files, 404.3MB)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="now-Sub-last-Milliseconds-undefined-type-time-Duration-has-no-field-or-method-Milliseconds"><a href="#now-Sub-last-Milliseconds-undefined-type-time-Duration-has-no-field-or-method-Milliseconds" class="headerlink" title="now.Sub(last).Milliseconds undefined (type time.Duration has no field or method Milliseconds)"></a>now.Sub(last).Milliseconds undefined (type time.Duration has no field or method Milliseconds)</h3><h4 id="解决-1"><a href="#解决-1" class="headerlink" title="解决"></a><a href="https://golang.org/dl/">解决</a></h4><p>　将升级 Golang 到 1.13 以上即可</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ curl -o golang.pkg https://dl.google.com/go/go1.13.3.darwin-amd64.pkg</span><br><span class="line">$ sudo open golang.pkg</span><br><span class="line">$ go version</span><br></pre></td></tr></tbody></table></figure>
<h3 id="command-line-arguments-undefined"><a href="#command-line-arguments-undefined" class="headerlink" title="command-line-arguments undefined"></a>command-line-arguments undefined</h3><h4 id="解决-2"><a href="#解决-2" class="headerlink" title="解决"></a>解决</h4><p>　不要直接右击 <code>main.go</code> 运行，需要同时选中相关的几个 go 程序，再右击运行</p>
<h3 id="working-directory-is-not-part-of-a-module"><a href="#working-directory-is-not-part-of-a-module" class="headerlink" title="working directory is not part of a module"></a>working directory is not part of a module</h3><h4 id="解决-3"><a href="#解决-3" class="headerlink" title="解决"></a>解决</h4><p>　这里以 influxdb-comparisons 项目为例，关键步骤是 <code>go mod init main</code>，完整命令如下：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/code/gopath/src/github.com/influxdata/influxdb-comparisons/</span><br><span class="line">$ go mod init main</span><br><span class="line">$ go build github.com/influxdata/influxdb-comparisons/cmd/bulk_load_opentsdb</span><br><span class="line">$ ./bulk_load_opentsdb</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">daemon URLs: [http://localhost:8086]</span><br><span class="line">SysInfo:</span><br><span class="line">  Current GOMAXPROCS: 64</span><br><span class="line">  Num CPUs: 64</span><br><span class="line">Trend statistics using 30 samples</span><br><span class="line">Started load with 1 workers</span><br></pre></td></tr></tbody></table></figure>
<h3 id="verifying-module-checksum-mismatch"><a href="#verifying-module-checksum-mismatch" class="headerlink" title="verifying module: checksum mismatch"></a>verifying module: checksum mismatch</h3><h4 id="解决-4"><a href="#解决-4" class="headerlink" title="解决"></a>解决</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 如果是升级导致的，可以清理旧 mod</span></span><br><span class="line">$ go clean -modcache</span><br><span class="line"><span class="comment"># 如果是私有代码库导致的，可以直接关闭 checksum 功能</span></span><br><span class="line">$ go env -w GOSUMDB=off</span><br></pre></td></tr></tbody></table></figure>
<h3 id="can’t-load-package"><a href="#can’t-load-package" class="headerlink" title="can’t load package"></a>can’t load package</h3><h4 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">go: finding module <span class="keyword">for</span> package github.com/influxdata/influxdb-comparisons/cmd/bulk_load_yuzhouwan</span><br><span class="line">can<span class="string">'t load package: package github.com/influxdata/influxdb-comparisons/cmd/bulk_load_yuzhouwan: module github.com/influxdata/influxdb-comparisons@latest found (v0.0.0-20200224230202-a75268060881), but does not contain package github.com/influxdata/influxdb-comparisons/cmd/bulk_load_yuzhouwan</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="解决-5"><a href="#解决-5" class="headerlink" title="解决"></a>解决</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ go env -w GO111MODULE=off</span><br></pre></td></tr></tbody></table></figure>
<h4 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h4><ul>
<li>auto<br>默认判断是否启用 module 功能<ul>
<li>当前目录在 <code>GOPATH/src</code> 之外且该目录包含 go.mod 文件</li>
<li>当前文件在包含 go.mod 文件的目录下面</li>
</ul>
</li>
<li>off<br>关闭 module 功能，寻找依赖包的方式将会沿用旧版本那种通过 <code>vendor</code> 目录或者 <code>GOPATH</code> 模式来查找</li>
<li>on<br>开启 module 功能，完全不去 GOPATH 目录下查找</li>
</ul>
<h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><h3 id="Blog"><a href="#Blog" class="headerlink" title="Blog"></a>Blog</h3><ul>
<li><a href="https://blog.csdn.net/huwh_/column/info/24158">Golang 系列学习</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/53284649">大规模 Go 项目几乎必踏的几个坑</a></li>
</ul>
<h3 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h3><ul>
<li><a href="https://github.com/avelino/awesome-go#awesome-go">Awesome Go</a></li>
</ul>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt=""></a></td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>语言</category>
      </categories>
      <tags>
        <tag>InfluxDB</tag>
        <tag>Golang</tag>
      </tags>
  </entry>
  <entry>
    <title>Apache Flink</title>
    <url>/posts/20644/</url>
    <content><![CDATA[<h2 id="什么是-Flink？"><a href="#什么是-Flink？" class="headerlink" title="什么是 Flink？"></a>什么是 Flink？</h2><blockquote>
<p><strong><a href="https://flink.apache.org/">Apache Flink</a></strong>™ is a framework and distributed processing engine for stateful computations over unbounded and bounded data streams. Flink has been designed to run in all common cluster environments, perform computations at in-memory speed and at any scale.</p>
</blockquote>
<h2 id="Flink-架构"><a href="#Flink-架构" class="headerlink" title="Flink 架构"></a>Flink 架构</h2><h3 id="核心组件布局"><a href="#核心组件布局" class="headerlink" title="核心组件布局"></a>核心组件布局</h3><p><img data-src="/picture/flink/flink_stack.png" alt="Apache Flink Stack"></p>
<center>（图片来源：<a href="https://flink.apache.org/" target="_blank">Apache Flink</a>™ 官网）</center>

<a id="more"></a>
<h2 id="环境部署"><a href="#环境部署" class="headerlink" title="环境部署"></a>环境部署</h2><h3 id="基础环境"><a href="#基础环境" class="headerlink" title="基础环境"></a>基础环境</h3><h4 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h4><h5 id="用户"><a href="#用户" class="headerlink" title="用户"></a>用户</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 增加用户，并赋予其密码</span></span><br><span class="line">$ adduser flink</span><br><span class="line">$ passwd flink            <span class="comment"># ur password for flink user</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 赋予用户可以 sudo 的权限</span></span><br><span class="line">$ chmod u+w /etc/sudoers</span><br><span class="line">$ vim /etc/sudoers</span><br><span class="line">  <span class="comment"># 找到 `root ALL=(ALL) ALL` 这行，并在下面添加 flink 用户</span></span><br><span class="line">  flink    ALL=(ALL)    ALL</span><br><span class="line">$ chmod u-w /etc/sudoers</span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换到 flink 用户</span></span><br><span class="line">$ su - flink</span><br></pre></td></tr></tbody></table></figure>
<h5 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/flink</span><br><span class="line"></span><br><span class="line"><span class="comment"># 存放软件目录 &amp; 安装目录 &amp; 日志目录 &amp; 临时目录</span></span><br><span class="line">$ mkdir install &amp;&amp; mkdir software &amp;&amp; mkdir logs &amp;&amp; mkdir data</span><br></pre></td></tr></tbody></table></figure>
<h4 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h4><h5 id="JDK"><a href="#JDK" class="headerlink" title="JDK"></a>JDK</h5><p>　Download from <a href="http://download.oracle.com/otn-pub/java/jdk/8u131-b11/d54c1d3a095b4ff2b6607d096fa80163/jdk-8u131-linux-x64.tar.gz">jdk-8u131-linux-x64.tar.gz</a></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/install</span><br><span class="line">$ tar zxvf jdk-8u131-linux-x64.tar.gz -C ~/software/</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> ~/software</span><br><span class="line">$ ln -s jdk-8u131-linux-x64 java</span><br><span class="line">$ vim ~/.bash_profile</span><br><span class="line">  JAVA_HOME=/home/flink/software/java</span><br><span class="line">  FLINK_HOME=/home/flink/software/flink</span><br><span class="line">  CLASSPATH=.:<span class="variable">$JAVA_HOME</span>/lib/tools.jar</span><br><span class="line">  PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$FLINK_HOME</span>/bin:<span class="variable">$PATH</span></span><br><span class="line">  <span class="built_in">export</span> JAVA_HOME CLASSPATH PATH</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">source</span> ~/.bash_profile</span><br></pre></td></tr></tbody></table></figure>
<p>　如果需要清除之前的低版本 JDK，或者重装，可以参照（没有这个需求，可跳过）:<br></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ rpm -qa | grep -iE <span class="string">'jdk|java'</span></span><br><span class="line">  jdk-1.7.0_80-fcs.x86_64</span><br><span class="line"></span><br><span class="line">$ sudo rpm -e --nodeps jdk-1.7.0_80-fcs.x86_64</span><br></pre></td></tr></tbody></table></figure><p></p>
<h3 id="Local-Cluster"><a href="#Local-Cluster" class="headerlink" title="Local Cluster"></a>Local Cluster</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 下载安装包</span></span><br><span class="line">$ <span class="built_in">cd</span> /home/flink/install</span><br><span class="line">$ wget http://archive.apache.org/dist/flink/flink-1.3.1/flink-1.3.1-bin-hadoop2-scala_2.11.tgz</span><br><span class="line">$ wget http://archive.apache.org/dist/flink/flink-1.3.1/flink-1.3.1-bin-hadoop2-scala_2.11.tgz.md5</span><br><span class="line">$ head -n 6 flink-1.3.1-bin-hadoop2-scala_2.11.tgz.md5</span><br><span class="line">  161e51c0b78d1fdf196f1c53c112a37f  flink-1.3.1-bin-hadoop2-scala_2.11.tgz</span><br><span class="line">$ md5sum flink-1.3.1-bin-hadoop2-scala_2.11.tgz | tr <span class="string">"a-z"</span> <span class="string">"A-Z"</span></span><br><span class="line">  161E51C0B78D1FDF196F1C53C112A37F  FLINK-1.3.1-BIN-HADOOP2-SCALA_2.11.TGZ</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对比 MD5 码一致后进行解压安装</span></span><br><span class="line">$ tar zxvf flink-1.3.1-bin-hadoop2-scala_2.11.tgz -C ~/software/</span><br><span class="line">$ <span class="built_in">cd</span> ~/software/ &amp;&amp; ln -s flink-1.3.1/ flink</span><br><span class="line">$ <span class="built_in">cd</span> flink/</span><br><span class="line">$ bin/flink -v</span><br><span class="line">  Version: 1.3.1, Commit ID: 1ca6e5b</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 Local Cluster</span></span><br><span class="line">$ bin/start-local.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># WEB UI</span></span><br><span class="line">$ http://localhost:8081</span><br></pre></td></tr></tbody></table></figure>
<h3 id="分布式集群"><a href="#分布式集群" class="headerlink" title="分布式集群"></a>分布式集群</h3><h4 id="节点分发"><a href="#节点分发" class="headerlink" title="节点分发"></a>节点分发</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ ssh flink@yuzhouwan00</span><br><span class="line">$ rsync -avuz -e ssh /home/flink/ flink@yuzhouwan01:/home/flink</span><br><span class="line">$ rsync -avuz -e ssh /home/flink/ flink@yuzhouwan02:/home/flink</span><br><span class="line">$ rsync -avuz -e ssh /home/flink/ flink@yuzhouwan03:/home/flink</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在各个节点上，激活环境变量</span></span><br><span class="line">$ <span class="built_in">source</span> ~/.bash_profile</span><br><span class="line">$ java -version</span><br><span class="line">  java version <span class="string">"1.8.0_121"</span></span><br><span class="line">  Java(TM) SE Runtime Environment (build 1.8.0_121-b13)</span><br><span class="line">  Java HotSpot(TM) 64-Bit Server VM (build 25.121-b13, mixed mode)</span><br><span class="line"></span><br><span class="line">$ flink -v</span><br><span class="line">  Version: 1.3.1, Commit ID: 1ca6e5b</span><br></pre></td></tr></tbody></table></figure>
<h4 id="免密登录"><a href="#免密登录" class="headerlink" title="免密登录"></a>免密登录</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 因为 Flink 集群中会用到 `sshd` 命令来管理和操作远程组件</span></span><br><span class="line">$ ssh flink@yuzhouwan01</span><br><span class="line">$ <span class="built_in">cd</span> ~/.ssh               <span class="comment"># 如果没有改目录，则需要先执行 `ssh localhost`</span></span><br><span class="line">$ ssh-keygen -t rsa</span><br><span class="line">$ cat ./id_rsa.pub &gt;&gt; ./authorized_keys</span><br><span class="line">$ scp ~/.ssh/id_rsa.pub flink@yuzhouwan02:/home/flink</span><br><span class="line">$ scp ~/.ssh/id_rsa.pub flink@yuzhouwan03:/home/flink</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 Slave 节点上依次执行以下命令</span></span><br><span class="line">$ ssh flink@yuzhouwan02</span><br><span class="line">$ mkdir ~/.ssh</span><br><span class="line">$ cat ~/id_rsa.pub &gt;&gt; ~/.ssh/authorized_keys</span><br><span class="line">$ rm ~/id_rsa.pub</span><br></pre></td></tr></tbody></table></figure>
<h4 id="配置集群"><a href="#配置集群" class="headerlink" title="配置集群"></a>配置集群</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> <span class="variable">$FLINK_HOME</span></span><br><span class="line">$ vim conf/flink-conf.yaml</span><br><span class="line">  jobmanager.rpc.address: yuzhouwan01</span><br><span class="line">  jobmanager.heap.mb: 2048</span><br><span class="line">  taskmanager.heap.mb: 2048</span><br><span class="line">  taskmanager.numberOfTaskSlots: 4</span><br><span class="line">  parallelism.default: 12</span><br><span class="line">  taskmanager.tmp.dirs: /home/flink/data</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 slave 列表</span></span><br><span class="line">$ vim conf/slaves</span><br><span class="line">  yuzhouwan02</span><br><span class="line">  yuzhouwan03</span><br><span class="line"></span><br><span class="line">$ scp -r /home/flink/software/flink-1.3.1/conf/ flink@yuzhouwan02:/home/flink/software/flink/conf/</span><br><span class="line">$ scp -r /home/flink/software/flink-1.3.1/conf/ flink@yuzhouwan03:/home/flink/software/flink/conf/</span><br></pre></td></tr></tbody></table></figure>
<h4 id="启动集群"><a href="#启动集群" class="headerlink" title="启动集群"></a>启动集群</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ start-cluster.sh </span><br><span class="line">  Starting cluster.</span><br><span class="line">  Starting jobmanager daemon on host yuzhouwan01.</span><br><span class="line">  Starting taskmanager daemon on host yuzhouwan02.</span><br><span class="line">  Starting taskmanager daemon on host yuzhouwan03.</span><br><span class="line"></span><br><span class="line"><span class="comment"># WEB UI</span></span><br><span class="line">$ http://yuzhouwan01:8081</span><br></pre></td></tr></tbody></table></figure>
<h3 id="发布应用"><a href="#发布应用" class="headerlink" title="发布应用"></a>发布应用</h3><h4 id="Local"><a href="#Local" class="headerlink" title="Local"></a>Local</h4><p>　使用 <code>ExecutionEnvironment.createLocalEnvironment(parallelism)</code> 获取程序执行环境，本地执行 main 函数即可完成发布</p>
<h4 id="Remote"><a href="#Remote" class="headerlink" title="Remote"></a>Remote</h4><p>　可将本机为 Client，提交任务到远程集群执行，对应获取程序执行环境的代码如下</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">ExecutionEnvironment.createRemoteEnvironment(<span class="string">"localhost"</span>, <span class="number">6123</span>, <span class="string">"target/yuzhouwan.jar"</span>);</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Cluster"><a href="#Cluster" class="headerlink" title="Cluster"></a>Cluster</h4><p>　还有一种方法，可以将程序提交至远程集群上，通过 <code>ExecutionEnvironment.getExecutionEnvironment()</code> 方法 获取执行环境，并通过 <code>maven-assembly-plugin</code> 插件，将程序打包成单个可执行的 jar 包，并在 WEB UI 上找到 <code>Submit new Job</code> 模块，完成上传、展示执行和最终提交任务至集群</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">archive</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">manifest</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>com.yuzhouwan.process.ServerLogProcess<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">archive</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">descriptorRef</span>&gt;</span>jar-with-dependencies<span class="tag">&lt;/<span class="name">descriptorRef</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<div class="note info">在 log/flink-flink-jobmanager-0-federation01.log 中可以查看任务失败的详情</div>



<h2 id="实战技巧"><a href="#实战技巧" class="headerlink" title="实战技巧"></a>实战技巧</h2><h3 id="Flink-CEP"><a href="#Flink-CEP" class="headerlink" title="Flink-CEP"></a>Flink-CEP</h3><p>　当前 Flink v1.3.1 的 <a href="https://ci.apache.org/projects/flink/flink-docs-release-1.3/dev/libs/cep.html">CEP</a>（Complex event processing for Flink）功能相比 <a href="http://www.espertech.com/esper/">Esper</a> / <a href="https://github.com/wso2/siddhi">Siddhi</a> 之类的成熟 CEP框架，可能还是无法满足某些应用场景（如，groupby、aggregation 等聚合操作）。先前，有 <a href="https://github.com/haoch">@haoch</a> 开发的一套 <a href="https://github.com/haoch/flink-siddhi"><strong>flink-siddhi</strong></a> 将 Siddhi整合到 Flink里面，不过 <a href="https://github.com/apache/flink/pull/2487">PR</a> 因为 <a href="https://github.com/apache/bahir">Apache Bahir</a>的一位 <a href="https://github.com/rmetzger">Commitor</a> 提议将这个功能放到 <a href="https://github.com/apache/bahir-flink">Bahir-Flink</a> 里，导致 flink-siddhi 功能提交进度推迟了。好在，Flink目前正在参考 <a href="https://docs.oracle.com/database/121/DWHSG/pattern.htm#DWHSG8956">Oracle’s SQL for pattern matching</a>，设计 <a href="https://docs.google.com/document/d/1HaaO5eYI1VZjyhtVPZOi3jVzikU7iK15H0YbniTnN30/edit#heading=h.vw4618mrw6mw"><strong>CEP on  SQL</strong></a> 的方案，目前看来，还是很值得期待的</p>
<h4 id="组件"><a href="#组件" class="headerlink" title="组件"></a>组件</h4><h5 id="事件流（Event-stream）"><a href="#事件流（Event-stream）" class="headerlink" title="事件流（Event stream）"></a>事件流（Event stream）</h5><h5 id="模式定义（Pattern-definition）"><a href="#模式定义（Pattern-definition）" class="headerlink" title="模式定义（Pattern definition）"></a>模式定义（Pattern definition）</h5><h6 id="单独模式"><a href="#单独模式" class="headerlink" title="单独模式"></a>单独模式</h6><ul>
<li>Begin</li>
<li>Filter</li>
<li>Subtype</li>
<li>OR</li>
<li>Continuity</li>
<li>Within</li>
</ul>
<h5 id="模式检测（Pattern-detection）"><a href="#模式检测（Pattern-detection）" class="headerlink" title="模式检测（Pattern detection）"></a>模式检测（Pattern detection）</h5><h5 id="告警生成（Alert-generation）"><a href="#告警生成（Alert-generation）" class="headerlink" title="告警生成（Alert generation）"></a>告警生成（Alert generation）</h5><h2 id="性能调优"><a href="#性能调优" class="headerlink" title="性能调优"></a>性能调优</h2><h3 id="G1GC"><a href="#G1GC" class="headerlink" title="G1GC"></a>G1GC</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim conf/flink-conf.yaml</span><br><span class="line">  env.java.opts: -XX:+UseG1GC -XX:G1HeapRegionSize=4M -XX:MaxGCPauseMillis=200 -XX:InitiatingHeapOccupancyPercent=45 -XX:ParallelGCThreads=8</span><br></pre></td></tr></tbody></table></figure>
<h2 id="踩过的坑"><a href="#踩过的坑" class="headerlink" title="踩过的坑"></a>踩过的坑</h2><h3 id="ElasticSearch-Connector"><a href="#ElasticSearch-Connector" class="headerlink" title="ElasticSearch Connector"></a><a href="https://yuzhouwan.com/posts/22654/">ElasticSearch</a> Connector</h3><h4 id="Failed-to-collect-dependencies-at-org-apache-flink-flink-connector-elasticsearch5-2-11-jar-1-3-1"><a href="#Failed-to-collect-dependencies-at-org-apache-flink-flink-connector-elasticsearch5-2-11-jar-1-3-1" class="headerlink" title="Failed to collect dependencies at org.apache.flink:flink-connector-elasticsearch5_2.11:jar:1.3.1"></a>Failed to collect dependencies at org.apache.flink:flink-connector-elasticsearch5_2.11:jar:1.3.1</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ git fetch --tags</span><br><span class="line">$ git checkout tags/release-1.3.1</span><br><span class="line"></span><br><span class="line">$ D:\apps\Java\jdk1.8.0_111\bin\java -Dmaven.multiModuleProjectDirectory=E:\Github\Flink\asdf2014\flink-connectors\flink-connector-elasticsearch5 -Dmaven.home=D:\apps\maven\apache-maven-3.3.9 -Dclassworlds.conf=D:\apps\maven\apache-maven-3.3.9\bin\m2.conf -Didea.launcher.port=7538 <span class="string">"-Didea.launcher.bin.path=D:\apps\JetBrains\IntelliJ IDEA 2016.2.5\bin"</span> -Dfile.encoding=UTF-8 -classpath <span class="string">"D:\apps\maven\apache-maven-3.3.9\boot\plexus-classworlds-2.5.2.jar;D:\apps\JetBrains\IntelliJ IDEA 2016.2.5\lib\idea_rt.jar"</span> com.intellij.rt.execution.application.AppMain org.codehaus.classworlds.Launcher -Didea.version=2016.2.5 -T 1C -DskipTests=<span class="literal">true</span> install -P scala-2.11,!scala-2.10,!include-yarn-tests</span><br><span class="line"></span><br><span class="line"><span class="comment"># -Dscala-2.11 指定 profile 失效，是因为 v1.3.1 里面的问题，已经将 scala version 写死了，需要修改 pom 文件，参考 1.4.0-SNAPSHOT</span></span><br><span class="line"><span class="comment"># 此时，应该能在 $MAVEN_HOME/repository 中找到 flink-connector-elasticsearch5_2.11-1.3.1.jar 了，在 maven 中使用就不再报错了；如果没能成功，就需要 install:install-file 的方式进行导入了</span></span><br><span class="line">$ mvn install:install-file -Dfile=D:\apps\maven\repository\org\apache\flink\flink-connector-elasticsearch5_2.11\1.3.1\flink-connector-elasticsearch5_2.11-1.3.1.jar -DgroupId=org.apache.flink -DartifactId=flink-connector-elasticsearch5_2.11 -Dversion=1.3.1 -Dpackaging=jar -DgeneratePom=<span class="literal">true</span> -DpomFile=C:\yuzhouwan\Maven\pom.xml</span><br></pre></td></tr></tbody></table></figure>
<div class="note success">同样的问题，在 Cassandra Connector 也存在，已提交 PR#4087 完成修复</div>



<h3 id="Either-无法被序列化"><a href="#Either-无法被序列化" class="headerlink" title="Either 无法被序列化"></a>Either 无法被序列化</h3><h4 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h4><h5 id="程序"><a href="#程序" class="headerlink" title="程序"></a>程序</h5><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">DataStream&lt;Either&lt;HBaseServerLog, HBaseServerLog&gt;&gt; eventsWarn = cepWarn(events);</span><br><span class="line"></span><br><span class="line">AlertEvent alertPoliceEvent = AlertEvent.getInstance();</span><br><span class="line">eventsWarn.map(log -&gt; {</span><br><span class="line">    alertPoliceEvent.alert(log);</span><br><span class="line">    <span class="keyword">return</span> log;</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>
<h5 id="报错"><a href="#报错" class="headerlink" title="报错"></a>报错</h5><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">Exception in thread <span class="string">"main"</span> org.apache.flink.api.common.functions.InvalidTypesException: The <span class="keyword">return</span> type of function <span class="string">'main(ServerLogProcess.java:46)'</span> could not be determined automatically, due to type erasure. <span class="function">You can give type information hints by using the <span class="title">returns</span><span class="params">(...)</span> method on the result of the transformation call, or by letting your function implement the 'ResultTypeQueryable' interface.</span></span><br><span class="line"><span class="function">  at org.apache.flink.streaming.api.transformations.StreamTransformation.<span class="title">getOutputType</span><span class="params">(StreamTransformation.java:<span class="number">374</span>)</span></span></span><br><span class="line"><span class="function">  at org.apache.flink.streaming.api.graph.StreamGraphGenerator.<span class="title">transform</span><span class="params">(StreamGraphGenerator.java:<span class="number">159</span>)</span></span></span><br><span class="line"><span class="function">  at org.apache.flink.streaming.api.graph.StreamGraphGenerator.<span class="title">generateInternal</span><span class="params">(StreamGraphGenerator.java:<span class="number">129</span>)</span></span></span><br><span class="line"><span class="function">  at org.apache.flink.streaming.api.graph.StreamGraphGenerator.<span class="title">generate</span><span class="params">(StreamGraphGenerator.java:<span class="number">121</span>)</span></span></span><br><span class="line"><span class="function">  at org.apache.flink.streaming.api.environment.StreamExecutionEnvironment.<span class="title">getStreamGraph</span><span class="params">(StreamExecutionEnvironment.java:<span class="number">1526</span>)</span></span></span><br><span class="line"><span class="function">  at org.apache.flink.streaming.api.environment.LocalStreamEnvironment.<span class="title">execute</span><span class="params">(LocalStreamEnvironment.java:<span class="number">87</span>)</span></span></span><br><span class="line"><span class="function">  at com.yuzhouwan.hbase.monitor.server.log.process.ServerLogProcess.<span class="title">main</span><span class="params">(ServerLogProcess.java:<span class="number">58</span>)</span></span></span><br><span class="line"><span class="function">  at sun.reflect.NativeMethodAccessorImpl.<span class="title">invoke0</span><span class="params">(Native Method)</span></span></span><br><span class="line"><span class="function">  at sun.reflect.NativeMethodAccessorImpl.<span class="title">invoke</span><span class="params">(NativeMethodAccessorImpl.java:<span class="number">62</span>)</span></span></span><br><span class="line"><span class="function">  at sun.reflect.DelegatingMethodAccessorImpl.<span class="title">invoke</span><span class="params">(DelegatingMethodAccessorImpl.java:<span class="number">43</span>)</span></span></span><br><span class="line"><span class="function">  at java.lang.reflect.Method.<span class="title">invoke</span><span class="params">(Method.java:<span class="number">498</span>)</span></span></span><br><span class="line"><span class="function">  at com.intellij.rt.execution.application.AppMain.<span class="title">main</span><span class="params">(AppMain.java:<span class="number">147</span>)</span></span></span><br><span class="line"><span class="function">Caused by: org.apache.flink.api.common.functions.InvalidTypesException: The generic type parameters of 'Either' are missing. </span></span><br><span class="line"><span class="function">It seems that your compiler has not stored them into the .class file. </span></span><br><span class="line"><span class="function">Currently, only the Eclipse JDT compiler preserves the type information necessary to use the lambdas feature type-safely. </span></span><br><span class="line"><span class="function">See the documentation <span class="keyword">for</span> more information about how to compile jobs containing lambda expressions.</span></span><br><span class="line"><span class="function">  at org.apache.flink.api.java.typeutils.TypeExtractor.<span class="title">validateLambdaGenericParameter</span><span class="params">(TypeExtractor.java:<span class="number">1503</span>)</span></span></span><br><span class="line"><span class="function">  at org.apache.flink.api.java.typeutils.TypeExtractor.<span class="title">validateLambdaGenericParameters</span><span class="params">(TypeExtractor.java:<span class="number">1489</span>)</span></span></span><br><span class="line"><span class="function">  at org.apache.flink.api.java.typeutils.TypeExtractor.<span class="title">getUnaryOperatorReturnType</span><span class="params">(TypeExtractor.java:<span class="number">426</span>)</span></span></span><br><span class="line"><span class="function">  at org.apache.flink.api.java.typeutils.TypeExtractor.<span class="title">getUnaryOperatorReturnType</span><span class="params">(TypeExtractor.java:<span class="number">379</span>)</span></span></span><br><span class="line"><span class="function">  at org.apache.flink.api.java.typeutils.TypeExtractor.<span class="title">getMapReturnTypes</span><span class="params">(TypeExtractor.java:<span class="number">164</span>)</span></span></span><br><span class="line"><span class="function">  at org.apache.flink.streaming.api.datastream.DataStream.<span class="title">map</span><span class="params">(DataStream.java:<span class="number">527</span>)</span></span></span><br><span class="line"><span class="function">  at com.yuzhouwan.hbase.monitor.server.log.process.ServerLogProcess.<span class="title">main</span><span class="params">(ServerLogProcess.java:<span class="number">46</span>)</span></span></span><br><span class="line"><span class="function">  ... 5 more</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h4><p>　不使用 <code>map</code> 方法去处理告警，将告警逻辑放到 <code>PatternFlatTimeoutFunction</code> 和 <code>PatternFlatSelectFunction</code> 里面</p>
<h3 id="Cannot-retrieve-Left-value-on-a-Right"><a href="#Cannot-retrieve-Left-value-on-a-Right" class="headerlink" title="Cannot retrieve Left value on a Right"></a>Cannot retrieve Left value on a Right</h3><h4 id="描述-1"><a href="#描述-1" class="headerlink" title="描述"></a>描述</h4><h5 id="程序-1"><a href="#程序-1" class="headerlink" title="程序"></a>程序</h5><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">(ElasticsearchSinkFunction&lt;Either&lt;HBaseServerLog, HBaseServerLog&gt;&gt;) (element, ctx, indexer) -&gt; {</span><br><span class="line">            <span class="keyword">if</span> (IS_DEBUG &amp;&amp; IS_DEEP_DEBUG) _log.debug(<span class="string">"Message: {} in ES Sink"</span>, element);</span><br><span class="line">            <span class="keyword">if</span> (element == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line">            HBaseServerLog left = element.left();</span><br><span class="line">            <span class="keyword">if</span> (left != <span class="keyword">null</span>)</span><br><span class="line">                indexer.add(indexRequest()</span><br><span class="line">                        .index(HBASE_SERVER_LOG_INDEX_NAME)</span><br><span class="line">                        .type(HBASE_SERVER_LOG_TYPE_NAME)</span><br><span class="line">                        .source(left.toJSON()));</span><br><span class="line">            HBaseServerLog right = element.right();</span><br><span class="line">            <span class="keyword">if</span> (right != <span class="keyword">null</span>)</span><br><span class="line">                indexer.add(indexRequest()</span><br><span class="line">                        .index(HBASE_SERVER_LOG_INDEX_NAME)</span><br><span class="line">                        .type(HBASE_SERVER_LOG_TYPE_NAME)</span><br><span class="line">                        .source(right.toJSON()));</span><br><span class="line">        };</span><br></pre></td></tr></tbody></table></figure>
<h5 id="报错-1"><a href="#报错-1" class="headerlink" title="报错"></a>报错</h5><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">java.lang.IllegalStateException: Cannot retrieve Left value on a Right</span><br><span class="line">  at org.apache.flink.types.Either$Right.left(Either.java:<span class="number">172</span>) ~[flink-core-<span class="number">1.3</span>.<span class="number">1.</span>jar:<span class="number">1.3</span>.<span class="number">1</span>]</span><br><span class="line">  at com.yuzhouwan.hbase.monitor.server.log.store.StoreData2ES.lambda$createEsSinkFunction$<span class="number">8</span>bb6efc1$<span class="number">1</span>(StoreData2ES.java:<span class="number">102</span>) ~[classes/:na]</span><br><span class="line">  at org.apache.flink.streaming.connectors.elasticsearch.ElasticsearchSinkBase.invoke(ElasticsearchSinkBase.java:<span class="number">282</span>) ~[flink-connector-elasticsearch-base_2.<span class="number">11</span>-<span class="number">1.3</span>.<span class="number">1.</span>jar:<span class="number">1.3</span>.<span class="number">1</span>]</span><br><span class="line">  at org.apache.flink.streaming.api.operators.StreamSink.processElement(StreamSink.java:<span class="number">41</span>) ~[flink-streaming-java_2.<span class="number">11</span>-<span class="number">1.3</span>.<span class="number">1.</span>jar:<span class="number">1.3</span>.<span class="number">1</span>]</span><br><span class="line">  at org.apache.flink.streaming.runtime.tasks.OperatorChain$CopyingChainingOutput.pushToOperator(OperatorChain.java:<span class="number">528</span>) ~[flink-streaming-java_2.<span class="number">11</span>-<span class="number">1.3</span>.<span class="number">1.</span>jar:<span class="number">1.3</span>.<span class="number">1</span>]</span><br><span class="line">  at org.apache.flink.streaming.runtime.tasks.OperatorChain$CopyingChainingOutput.collect(OperatorChain.java:<span class="number">503</span>) ~[flink-streaming-java_2.<span class="number">11</span>-<span class="number">1.3</span>.<span class="number">1.</span>jar:<span class="number">1.3</span>.<span class="number">1</span>]</span><br><span class="line">  at org.apache.flink.streaming.runtime.tasks.OperatorChain$CopyingChainingOutput.collect(OperatorChain.java:<span class="number">483</span>) ~[flink-streaming-java_2.<span class="number">11</span>-<span class="number">1.3</span>.<span class="number">1.</span>jar:<span class="number">1.3</span>.<span class="number">1</span>]</span><br><span class="line">  at org.apache.flink.streaming.api.operators.AbstractStreamOperator$CountingOutput.collect(AbstractStreamOperator.java:<span class="number">891</span>) ~[flink-streaming-java_2.<span class="number">11</span>-<span class="number">1.3</span>.<span class="number">1.</span>jar:<span class="number">1.3</span>.<span class="number">1</span>]</span><br><span class="line">  at org.apache.flink.streaming.api.operators.AbstractStreamOperator$CountingOutput.collect(AbstractStreamOperator.java:<span class="number">869</span>) ~[flink-streaming-java_2.<span class="number">11</span>-<span class="number">1.3</span>.<span class="number">1.</span>jar:<span class="number">1.3</span>.<span class="number">1</span>]</span><br><span class="line">  at org.apache.flink.streaming.api.operators.TimestampedCollector.collect(TimestampedCollector.java:<span class="number">51</span>) ~[flink-streaming-java_2.<span class="number">11</span>-<span class="number">1.3</span>.<span class="number">1.</span>jar:<span class="number">1.3</span>.<span class="number">1</span>]</span><br><span class="line">  at org.apache.flink.cep.PatternStream$PatternFlatSelectTimeoutWrapper$RightCollector.collect(PatternStream.java:<span class="number">374</span>) ~[flink-cep_2.<span class="number">11</span>-<span class="number">1.3</span>.<span class="number">1.</span>jar:<span class="number">1.3</span>.<span class="number">1</span>]</span><br><span class="line">  at com.yuzhouwan.hbase.monitor.server.log.analyse.func.select.SelectFunctionWarn.lambda$flatSelect$<span class="number">0</span>(SelectFunctionWarn.java:<span class="number">39</span>) ~[classes/:na]</span><br><span class="line">  at java.util.ArrayList.forEach(ArrayList.java:<span class="number">1249</span>) ~[na:<span class="number">1.8</span>.<span class="number">0_111</span>]</span><br><span class="line">  at com.yuzhouwan.hbase.monitor.server.log.analyse.func.select.SelectFunctionWarn.flatSelect(SelectFunctionWarn.java:<span class="number">37</span>) ~[classes/:na]</span><br><span class="line">  at org.apache.flink.cep.PatternStream$PatternFlatSelectTimeoutWrapper.flatMap(PatternStream.java:<span class="number">341</span>) ~[flink-cep_2.<span class="number">11</span>-<span class="number">1.3</span>.<span class="number">1.</span>jar:<span class="number">1.3</span>.<span class="number">1</span>]</span><br><span class="line">  at org.apache.flink.cep.PatternStream$PatternFlatSelectTimeoutWrapper.flatMap(PatternStream.java:<span class="number">320</span>) ~[flink-cep_2.<span class="number">11</span>-<span class="number">1.3</span>.<span class="number">1.</span>jar:<span class="number">1.3</span>.<span class="number">1</span>]</span><br><span class="line">  at org.apache.flink.streaming.api.operators.StreamFlatMap.processElement(StreamFlatMap.java:<span class="number">50</span>) ~[flink-streaming-java_2.<span class="number">11</span>-<span class="number">1.3</span>.<span class="number">1.</span>jar:<span class="number">1.3</span>.<span class="number">1</span>]</span><br><span class="line">  at org.apache.flink.streaming.runtime.io.StreamInputProcessor.processInput(StreamInputProcessor.java:<span class="number">206</span>) ~[flink-streaming-java_2.<span class="number">11</span>-<span class="number">1.3</span>.<span class="number">1.</span>jar:<span class="number">1.3</span>.<span class="number">1</span>]</span><br><span class="line">  at org.apache.flink.streaming.runtime.tasks.OneInputStreamTask.run(OneInputStreamTask.java:<span class="number">69</span>) ~[flink-streaming-java_2.<span class="number">11</span>-<span class="number">1.3</span>.<span class="number">1.</span>jar:<span class="number">1.3</span>.<span class="number">1</span>]</span><br><span class="line">  at org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:<span class="number">262</span>) ~[flink-streaming-java_2.<span class="number">11</span>-<span class="number">1.3</span>.<span class="number">1.</span>jar:<span class="number">1.3</span>.<span class="number">1</span>]</span><br><span class="line">  at org.apache.flink.runtime.taskmanager.Task.run(Task.java:<span class="number">702</span>) ~[flink-runtime_2.<span class="number">11</span>-<span class="number">1.3</span>.<span class="number">1.</span>jar:<span class="number">1.3</span>.<span class="number">1</span>]</span><br><span class="line">  at java.lang.Thread.run(Thread.java:<span class="number">745</span>) [na:<span class="number">1.8</span>.<span class="number">0_111</span>]</span><br></pre></td></tr></tbody></table></figure>
<h4 id="解决-1"><a href="#解决-1" class="headerlink" title="解决"></a>解决</h4><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 先使用 `isLeft | isRight` 方法，做一下判断，然后再做处理</span></span><br><span class="line">HBaseServerLog log = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span> (element.isLeft()) log = element.left();</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (element.isRight()) log = element.right();</span><br></pre></td></tr></tbody></table></figure>
<h3 id="ElasticsearchSinkFunction-is-not-serializable"><a href="#ElasticsearchSinkFunction-is-not-serializable" class="headerlink" title="ElasticsearchSinkFunction is not serializable"></a>ElasticsearchSinkFunction is not serializable</h3><h4 id="描述-2"><a href="#描述-2" class="headerlink" title="描述"></a>描述</h4><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">java.lang.IllegalArgumentException: The implementation of the provided ElasticsearchSinkFunction is not serializable. The object probably contains or references non-serializable fields.</span><br><span class="line">  at org.apache.flink.util.Preconditions.checkArgument(Preconditions.java:<span class="number">139</span>) ~[flink-core-<span class="number">1.3</span>.<span class="number">0.</span>jar:<span class="number">1.3</span>.<span class="number">0</span>]</span><br><span class="line">  at org.apache.flink.streaming.connectors.elasticsearch.ElasticsearchSinkBase.&lt;init&gt;(ElasticsearchSinkBase.java:<span class="number">195</span>) ~[flink-connector-elasticsearch-base_2.<span class="number">11</span>-<span class="number">1.3</span>.<span class="number">0.</span>jar:<span class="number">1.3</span>.<span class="number">0</span>]</span><br><span class="line">  at org.apache.flink.streaming.connectors.elasticsearch5.ElasticsearchSink.&lt;init&gt;(ElasticsearchSink.java:<span class="number">95</span>) ~[flink-connector-elasticsearch5_2.<span class="number">11</span>-<span class="number">1.3</span>.<span class="number">0.</span>jar:<span class="number">1.3</span>.<span class="number">0</span>]</span><br><span class="line">  at org.apache.flink.streaming.connectors.elasticsearch5.ElasticsearchSink.&lt;init&gt;(ElasticsearchSink.java:<span class="number">78</span>) ~[flink-connector-elasticsearch5_2.<span class="number">11</span>-<span class="number">1.3</span>.<span class="number">0.</span>jar:<span class="number">1.3</span>.<span class="number">0</span>]</span><br><span class="line">  at com.yuzhouwan.hbase.monitor.server.log.store.StoreData2ES.initEsSink(StoreData2ES.java:<span class="number">89</span>) ~[classes/:na]</span><br><span class="line">  at com.yuzhouwan.hbase.monitor.server.log.store.StoreData2ES.init(StoreData2ES.java:<span class="number">85</span>) ~[classes/:na]</span><br><span class="line">  at com.yuzhouwan.hbase.monitor.server.log.store.StoreData2ES.&lt;init&gt;(StoreData2ES.java:<span class="number">50</span>) ~[classes/:na]</span><br><span class="line">  at com.yuzhouwan.hbase.monitor.server.log.process.ServerLogProcess.main(ServerLogProcess.java:<span class="number">52</span>) ~[classes/:na]</span><br></pre></td></tr></tbody></table></figure>
<h4 id="解决-2"><a href="#解决-2" class="headerlink" title="解决"></a>解决</h4><p>　原因是，从外部传入两个关于 <a href="https://yuzhouwan.com/posts/22654/">ES</a> 的参数，导致 <code>ElasticSearchSinkFunction</code> 类无法被序列化。解决方法，就是实现 <code>ElasticsearchSinkFunction&lt;T&gt;</code> 接口，并标记 <code>Serializable</code>，再将外部参数，通过 <code>ElasticSearchSinkFunction</code> 子类的构造函数传入（这里还需要注意避免使用 <code>static</code> 属性）。类似的，还有 <code>PatternFlatSelectFunction&lt;IN, OUT&gt;</code> 和<code>IterativeCondition&lt;T&gt;</code>，对于外部传入的实例，如果因为序列化，也可能会出现 <code>NullPointerException</code> 异常。这时候，就算通过实现<code>Cloneable</code> 接口，对外部实例进行 <code>clone</code>，也会无法避免。因此，需要在 <code>PatternFlatSelectFunction&lt;IN, OUT&gt;</code> 或<code>IterativeCondition&lt;T&gt;</code> 内部，重新初始化实例，才能解决该问题</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ElasticsearchSinkFunctionWithConf</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">ElasticsearchSinkFunction</span>&lt;<span class="title">T</span>&gt;, <span class="title">Serializable</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String hbaseServerLogIndexName;</span><br><span class="line">    <span class="keyword">private</span> String hbaseServerLogTypeName;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ElasticsearchSinkFunctionWithConf</span><span class="params">(String hbaseServerLogIndexName, String hbaseServerLogTypeName)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.hbaseServerLogIndexName = hbaseServerLogIndexName;</span><br><span class="line">        <span class="keyword">this</span>.hbaseServerLogTypeName = hbaseServerLogTypeName;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(T element, RuntimeContext ctx, RequestIndexer indexer)</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (element == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">if</span> (!(element <span class="keyword">instanceof</span> HBaseServerLog)) <span class="keyword">return</span>;</span><br><span class="line">        indexer.add(indexRequest()</span><br><span class="line">                .index(hbaseServerLogIndexName)</span><br><span class="line">                .type(hbaseServerLogTypeName)</span><br><span class="line">                .source(((HBaseServerLog) element).toJSON()));</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="The-implementation-of-the-IterativeCondition-is-not-serializable"><a href="#The-implementation-of-the-IterativeCondition-is-not-serializable" class="headerlink" title="The implementation of the IterativeCondition is not serializable"></a>The implementation of the IterativeCondition is not serializable</h3><h4 id="描述-3"><a href="#描述-3" class="headerlink" title="描述"></a>描述</h4><p>　因为 <a href="https://yuzhouwan.com/posts/20644/">Flink</a> 和 <a href="https://yuzhouwan.com/posts/4735/">Spark</a> 一样，无法在集群范围内，共享一个全局变量（即便是 Spark 的 <a href="https://spark.apache.org/docs/latest/rdd-programming-guide.html#broadcast-variables">Accumulators</a> 也只能做到全局的累加器），所以对于中间结果，一般地需要用类似 <a href="https://yuzhouwan.com/posts/2129/">Redis</a> / Memcached / MongoDB（三者的比对，详见我的另一篇<a href="https://yuzhouwan.com/posts/2129/#技术内幕">博文</a>）的第三方存储来保存中间结果</p>
<p>　然而，JedisCluster 却无法做到序列化，因此报错 not serializable</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">org.apache.flink.api.common.InvalidProgramException: The implementation of the IterativeCondition is not serializable. The object probably contains or references non serializable fields.</span><br></pre></td></tr></tbody></table></figure>
<h4 id="解决-3"><a href="#解决-3" class="headerlink" title="解决"></a>解决</h4><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 因为，无法序列化 JedisCluster，所以不能作为 IterativeCondition 的变量保存下来</span></span><br><span class="line"><span class="comment">// 但是，又不可能在每次 event 处理的时候，都重新构建 Redis Cluster 的连接池</span></span><br><span class="line"><span class="comment">// 所以，考虑就算无法通过序列化分发到各个 task 中，但是也要做到每个 task 中，只初始化一次</span></span><br><span class="line"><span class="comment">// 因此，我们用 `Object redis` 作为一个变量，但是并不做任何赋值，作为存留第一次初始化 Reids 连接池的对象引用</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Object redis;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">RedisMiddleStatusStore redis;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.redis == <span class="keyword">null</span>) {</span><br><span class="line">    redis = <span class="keyword">new</span> RedisMiddleStatusStore(DP);</span><br><span class="line">    <span class="keyword">this</span>.redis = redis;</span><br><span class="line">} <span class="keyword">else</span> redis = (RedisMiddleStatusStore) <span class="keyword">this</span>.redis;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="org-apache-flink-types-NullKeyFieldException-Unable-to-access-field-xxx-on-object-null"><a href="#org-apache-flink-types-NullKeyFieldException-Unable-to-access-field-xxx-on-object-null" class="headerlink" title="org.apache.flink.types.NullKeyFieldException: Unable to access field xxx on object null"></a>org.apache.flink.types.NullKeyFieldException: Unable to access field xxx on object null</h3><h4 id="描述-4"><a href="#描述-4" class="headerlink" title="描述"></a>描述</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">java.lang.RuntimeException: Could not extract key from null</span><br><span class="line">  at org.apache.flink.streaming.runtime.io.RecordWriterOutput.pushToRecordWriter(RecordWriterOutput.java:104)</span><br><span class="line">  at org.apache.flink.streaming.runtime.io.RecordWriterOutput.collect(RecordWriterOutput.java:83)</span><br><span class="line">  at org.apache.flink.streaming.runtime.io.RecordWriterOutput.collect(RecordWriterOutput.java:41)</span><br><span class="line">  at org.apache.flink.streaming.runtime.tasks.OperatorChain<span class="variable">$BroadcastingOutputCollector</span>.collect(OperatorChain.java:575)</span><br><span class="line">  at org.apache.flink.streaming.runtime.tasks.OperatorChain<span class="variable">$BroadcastingOutputCollector</span>.collect(OperatorChain.java:536)</span><br><span class="line">  at org.apache.flink.streaming.api.operators.AbstractStreamOperator<span class="variable">$CountingOutput</span>.collect(AbstractStreamOperator.java:891)</span><br><span class="line">  at org.apache.flink.streaming.api.operators.AbstractStreamOperator<span class="variable">$CountingOutput</span>.collect(AbstractStreamOperator.java:869)</span><br><span class="line">  at org.apache.flink.streaming.api.operators.StreamMap.processElement(StreamMap.java:41)</span><br><span class="line">  at org.apache.flink.streaming.runtime.tasks.OperatorChain<span class="variable">$CopyingChainingOutput</span>.pushToOperator(OperatorChain.java:528)</span><br><span class="line">  at org.apache.flink.streaming.runtime.tasks.OperatorChain<span class="variable">$CopyingChainingOutput</span>.collect(OperatorChain.java:503)</span><br><span class="line">  at org.apache.flink.streaming.runtime.tasks.OperatorChain<span class="variable">$CopyingChainingOutput</span>.collect(OperatorChain.java:483)</span><br><span class="line">  at org.apache.flink.streaming.api.operators.AbstractStreamOperator<span class="variable">$CountingOutput</span>.collect(AbstractStreamOperator.java:891)</span><br><span class="line">  at org.apache.flink.streaming.api.operators.AbstractStreamOperator<span class="variable">$CountingOutput</span>.collect(AbstractStreamOperator.java:869)</span><br><span class="line">  at org.apache.flink.streaming.api.operators.StreamSourceContexts<span class="variable">$NonTimestampContext</span>.collect(StreamSourceContexts.java:103)</span><br><span class="line">  at org.apache.flink.streaming.connectors.kafka.internals.AbstractFetcher.emitRecord(AbstractFetcher.java:228)</span><br><span class="line">  at org.apache.flink.streaming.connectors.kafka.internals.SimpleConsumerThread.run(SimpleConsumerThread.java:385)</span><br><span class="line">Caused by: java.lang.RuntimeException: Could not extract key from null</span><br><span class="line">  at org.apache.flink.streaming.runtime.partitioner.KeyGroupStreamPartitioner.selectChannels(KeyGroupStreamPartitioner.java:61)</span><br><span class="line">  at org.apache.flink.streaming.runtime.partitioner.KeyGroupStreamPartitioner.selectChannels(KeyGroupStreamPartitioner.java:32)</span><br><span class="line">  at org.apache.flink.runtime.io.network.api.writer.RecordWriter.emit(RecordWriter.java:88)</span><br><span class="line">  at org.apache.flink.streaming.runtime.io.StreamRecordWriter.emit(StreamRecordWriter.java:85)</span><br><span class="line">  at org.apache.flink.streaming.runtime.io.RecordWriterOutput.pushToRecordWriter(RecordWriterOutput.java:101)</span><br><span class="line">  ... 15 more</span><br><span class="line">Caused by: org.apache.flink.types.NullKeyFieldException: Unable to access field java.lang.Integer com.yuzhouwan.hbase.monitor.server.log.data.model.HBaseServerLog.flumeId on object null</span><br><span class="line">  at org.apache.flink.api.java.typeutils.runtime.PojoComparator.accessField(PojoComparator.java:181)</span><br><span class="line">  at org.apache.flink.api.java.typeutils.runtime.PojoComparator.extractKeys(PojoComparator.java:329)</span><br><span class="line">  at org.apache.flink.streaming.util.keys.KeySelectorUtil<span class="variable">$ComparableKeySelector</span>.getKey(KeySelectorUtil.java:185)</span><br><span class="line">  at org.apache.flink.streaming.util.keys.KeySelectorUtil<span class="variable">$ComparableKeySelector</span>.getKey(KeySelectorUtil.java:162)</span><br><span class="line">  at org.apache.flink.streaming.runtime.partitioner.KeyGroupStreamPartitioner.selectChannels(KeyGroupStreamPartitioner.java:59)</span><br><span class="line">  ... 19 more</span><br></pre></td></tr></tbody></table></figure>
<h4 id="解决-4"><a href="#解决-4" class="headerlink" title="解决"></a><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.3/dev/stream/process_function.html">解决</a></h4><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 不使用默认的 Tuple，而是自己构建 KeySelector</span></span><br><span class="line"><span class="comment">// KeyedStream&lt;HBaseServerLog, Tuple&gt; keyed = events.keyBy("flumeId");</span></span><br><span class="line">KeyedStream&lt;HBaseServerLog, Integer&gt; keyed = events.keyBy((KeySelector&lt;HBaseServerLog, Integer&gt;) log -&gt; {</span><br><span class="line">    <span class="keyword">if</span> (log == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    Integer flumeId;</span><br><span class="line">    <span class="keyword">if</span> ((flumeId = log.getFlumeId()) == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> flumeId;</span><br><span class="line">  });</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Task-xxx-did-not-react-to-cancelling-signal-in-the-last-30-seconds-but-is-stuck-in-method"><a href="#Task-xxx-did-not-react-to-cancelling-signal-in-the-last-30-seconds-but-is-stuck-in-method" class="headerlink" title="Task xxx did not react to cancelling signal in the last 30 seconds, but is stuck in method"></a>Task xxx did not react to cancelling signal in the last 30 seconds, but is stuck in method</h3><h4 id="描述-5"><a href="#描述-5" class="headerlink" title="描述"></a>描述</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">A fatal error occurred, forcing the TaskManager to shut down: Task <span class="string">'KeyedCEPPatternOperator -&gt; Flat Map -&gt; Sink: MULTI_EVENT (2/8)'</span> did not react to cancelling signal <span class="keyword">in</span> the last 30 seconds, but is stuck <span class="keyword">in</span> method:</span><br><span class="line">   java.util.regex.Pattern<span class="variable">$GroupTail</span>.match(Pattern.java:4717)</span><br><span class="line">  java.util.regex.Pattern<span class="variable">$Curly</span>.match0(Pattern.java:4272)</span><br><span class="line">  java.util.regex.Pattern<span class="variable">$Curly</span>.match(Pattern.java:4234)</span><br><span class="line">  java.util.regex.Pattern<span class="variable">$GroupHead</span>.match(Pattern.java:4658)</span><br><span class="line">  java.util.regex.Pattern<span class="variable">$GroupHead</span>.match(Pattern.java:4658)</span><br><span class="line">  java.util.regex.Pattern<span class="variable">$Curly</span>.match0(Pattern.java:4279)</span><br><span class="line">  java.util.regex.Pattern<span class="variable">$Curly</span>.match(Pattern.java:4234)</span><br><span class="line">  java.util.regex.Pattern<span class="variable">$GroupTail</span>.match(Pattern.java:4717)</span><br><span class="line">  java.util.regex.Pattern<span class="variable">$GroupTail</span>.match(Pattern.java:4717)</span><br><span class="line">  java.util.regex.Pattern<span class="variable">$Curly</span>.match0(Pattern.java:4272)</span><br><span class="line">  java.util.regex.Pattern<span class="variable">$Curly</span>.match(Pattern.java:4234)</span><br><span class="line">  java.util.regex.Pattern<span class="variable">$GroupHead</span>.match(Pattern.java:4658)</span><br><span class="line">  java.util.regex.Pattern<span class="variable">$GroupHead</span>.match(Pattern.java:4658)</span><br><span class="line">  java.util.regex.Pattern<span class="variable">$Curly</span>.match0(Pattern.java:4279)</span><br><span class="line">  java.util.regex.Pattern<span class="variable">$Curly</span>.match(Pattern.java:4234)</span><br><span class="line">  java.util.regex.Pattern<span class="variable">$GroupTail</span>.match(Pattern.java:4717)</span><br><span class="line">  java.util.regex.Pattern<span class="variable">$GroupTail</span>.match(Pattern.java:4717)</span><br><span class="line">  java.util.regex.Pattern<span class="variable">$Curly</span>.match0(Pattern.java:4272)</span><br><span class="line">  java.util.regex.Pattern<span class="variable">$Curly</span>.match(Pattern.java:4234)</span><br><span class="line">  java.util.regex.Pattern<span class="variable">$BmpCharProperty</span>.match(Pattern.java:3798)</span><br><span class="line">  java.util.regex.Pattern<span class="variable">$Curly</span>.match0(Pattern.java:4272)</span><br><span class="line">  java.util.regex.Pattern<span class="variable">$Curly</span>.match(Pattern.java:4234)</span><br><span class="line">  java.util.regex.Pattern<span class="variable">$GroupHead</span>.match(Pattern.java:4658)</span><br><span class="line">  java.util.regex.Pattern<span class="variable">$GroupHead</span>.match(Pattern.java:4658)</span><br><span class="line">  java.util.regex.Pattern<span class="variable">$Start</span>.match(Pattern.java:3461)</span><br><span class="line">  java.util.regex.Matcher.search(Matcher.java:1248)</span><br><span class="line">  java.util.regex.Matcher.find(Matcher.java:637)</span><br><span class="line">  com.yuzhouwan.hbase.monitor.server.log.analyse.condition.IterativeConditionMultiWithDP.matchAndStore(IterativeConditionMultiWithDP.java:95)</span><br><span class="line">  com.yuzhouwan.hbase.monitor.server.log.analyse.condition.IterativeConditionMultiWithDP.filter(IterativeConditionMultiWithDP.java:79)</span><br><span class="line">  org.apache.flink.cep.nfa.NFA.checkFilterCondition(NFA.java:633)</span><br><span class="line">  org.apache.flink.cep.nfa.NFA.createDecisionGraph(NFA.java:610)</span><br><span class="line">  org.apache.flink.cep.nfa.NFA.computeNextStates(NFA.java:421)</span><br><span class="line">  org.apache.flink.cep.nfa.NFA.process(NFA.java:241)</span><br><span class="line">  org.apache.flink.cep.operator.KeyedCEPPatternOperator.processEvent(KeyedCEPPatternOperator.java:56)</span><br><span class="line">  org.apache.flink.cep.operator.AbstractKeyedCEPPatternOperator.processElement(AbstractKeyedCEPPatternOperator.java:170)</span><br><span class="line">  org.apache.flink.streaming.runtime.io.StreamInputProcessor.processInput(StreamInputProcessor.java:206)</span><br><span class="line">  org.apache.flink.streaming.runtime.tasks.OneInputStreamTask.run(OneInputStreamTask.java:69)</span><br><span class="line">  org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:263)</span><br><span class="line">  org.apache.flink.runtime.taskmanager.Task.run(Task.java:702)</span><br><span class="line">  java.lang.Thread.run(Thread.java:745)</span><br></pre></td></tr></tbody></table></figure>
<h4 id="解决-5"><a href="#解决-5" class="headerlink" title="解决"></a>解决</h4><p>　分析日志，得知 Task 被阻塞在某一个方法里面了<br>　因为程序已经运行了一周，一直未出现这种情况，所以考虑到可能是某一条异常数据导致的<br>　因此，增加数据清理逻辑，避免过长的字符串；另外，根据当前的场景，使用 <code>Matcher.matches()</code> 替换了 <code>Matcher.find()</code> 方法，使得正则匹配的性能提高了无数倍（我们的场景下，压测结论是 5000 倍的性能提升）</p>
<h4 id="补充说明"><a href="#补充说明" class="headerlink" title="补充说明"></a>补充说明</h4><h5 id="Matcher-常用的三种查找方法"><a href="#Matcher-常用的三种查找方法" class="headerlink" title="Matcher 常用的三种查找方法"></a>Matcher 常用的三种查找方法</h5><ul>
<li><p><code>Matcher.matches()</code></p>
<p>对整个字符串进行匹配，只有整个字符串都匹配成功了，才返回 <code>true</code></p>
</li>
<li><p><code>Matcher.lookingAt()</code></p>
<p>从字符串的起始部分进行匹配，只有字符串的前缀满足模式，才返回 <code>true</code></p>
</li>
<li><p><code>Matcher.find()</code></p>
<p>对局部字符串进行匹配，匹配到的字符串可以在任何位置（因此，性能会有下降很多，除非特定场景，否则尽量避免使用）</p>
</li>
</ul>
<h2 id="社区跟进"><a href="#社区跟进" class="headerlink" title="社区跟进"></a>社区跟进</h2><h3 id="Pull-Request"><a href="#Pull-Request" class="headerlink" title="Pull Request"></a><a href="https://github.com/apache/flink/pulls?utf8=%E2%9C%93&amp;q=is%3Apr%20author%3Aasdf2014%20">Pull Request</a></h3><h3 id="Issues"><a href="#Issues" class="headerlink" title="Issues"></a><a href="https://issues.apache.org/jira/browse/FLINK-6868?jql=project%20%3D%20FLINK%20AND%20reporter%20in%20(%22benedict%20jin%22)">Issues</a></h3><p>　详见：《<a href="https://yuzhouwan.com/posts/19631/">如何成为 Apache 的 PMC</a>》</p>
<h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><h3 id="Doc"><a href="#Doc" class="headerlink" title="Doc"></a>Doc</h3><ul>
<li><a href="http://flink.apache.org/downloads.html#all-releases">Apache Flink Documentation</a></li>
<li><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.3/dev/libs/cep.html">FlinkCEP - Complex event processing for Flink</a></li>
<li><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.3/dev/connectors/kafka.html">Apache Kafka Connector</a></li>
<li><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.3/dev/connectors/elasticsearch.html">Elasticsearch Connector</a></li>
</ul>
<h3 id="Blog"><a href="#Blog" class="headerlink" title="Blog"></a>Blog</h3><ul>
<li><a href="https://enjoyment.cool/archives/Flink/">Apache Flink 说道系列</a></li>
</ul>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt=""></a></td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>大数据</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>JVM</tag>
        <tag>Apache Cassandra</tag>
        <tag>ElasticSearch</tag>
        <tag>Apache Flink</tag>
      </tags>
  </entry>
  <entry>
    <title>Real-time ML with Spark</title>
    <url>/posts/4735/</url>
    <content><![CDATA[<h2 id="什么是-Spark"><a href="#什么是-Spark" class="headerlink" title="什么是 Spark?"></a>什么是 Spark?</h2><p>　<strong>Apache Spark</strong>™ is a unified analytics engine for large-scale data processing.</p>
<h2 id="为什么要有-Spark"><a href="#为什么要有-Spark" class="headerlink" title="为什么要有 Spark?"></a>为什么要有 Spark?</h2><h3 id="分布式"><a href="#分布式" class="headerlink" title="分布式"></a>分布式</h3><p>　具备经济、快速、可靠、易扩充、数据共享、设备共享、通讯方便、灵活等分布式所具备的特性</p>
<h3 id="高层次抽象"><a href="#高层次抽象" class="headerlink" title="高层次抽象"></a>高层次抽象</h3><p>　<strong>RDD</strong>（<strong>R</strong>esilient <strong>D</strong>istributed <strong>D</strong>atasets）提供 一个可以被并行计算的 不变、分区的数据集 抽象</p>
<h3 id="快速计算能力"><a href="#快速计算能力" class="headerlink" title="快速计算能力"></a>快速计算能力</h3><p>　内存计算 基于内存的迭代计算框架，能够避免计算结果落地，磁盘 <code>I/O</code> 所带来的瓶颈<br>　Machine Learning、Data Mining 等都需要递归地计算，因此非常适合实现这些算法</p>
<h3 id="高效性能"><a href="#高效性能" class="headerlink" title="高效性能"></a>高效性能</h3><p>　<strong>DAG</strong>（<strong>D</strong>irected <strong>A</strong>cyclic <strong>G</strong>rap）利用有向无环图，构建优化任务中 父 RDD 和 子 RDD 的依赖关系</p>
<p><img data-src="/picture/spark/spark_dag_process.png" alt="Spark DAG"></p>
<p>　其中，依赖分为两种，一个为<strong>窄依赖</strong>（Narrow Dependencies），如 <code>map</code> / <code>filter</code> / <code>union</code> 等；另一种为<strong>宽依赖</strong>（Wide Dependencies），如 <code>groupByKey</code> 等</p>
<p>　在划分依赖时，<code>join</code> 需要额外考虑 <code>co-partitione</code>：</p>
<ul>
<li>如果 RDD 和 <code>cogroup</code> 有相同的 数据结构，将会确定一个 <code>OneToOneDependency</code></li>
<li><p>反之，则说明 <code>join</code> 的时候，需要 <code>shuffle</code>（<code>ShuffleDependency</code>）</p>
<p>因为，宽依赖只有等到所有 父 partiton 计算完，并传递结束，才能继续进行下一步运算，所以应该尽量减少宽依赖，避免失败后 recompute 的成本</p>
</li>
</ul>
<p><img data-src="/picture/spark/spark_narrow_dependencies_and_wide_dependencies.png" alt="Narrow Dependencies and Wide Dependencies"></p>
<center>（图片来源：<a href="https://spark.apache.org/" target="_blank">Spark</a>™ 官网）</center>


<h3 id="容错性"><a href="#容错性" class="headerlink" title="容错性"></a>容错性</h3><p>　Lineage 血统，能在计算失败的时候，将会找寻 最小重新计算损耗的 结点，避免全部重新计算</p>
<a id="more"></a>
<h2 id="Spark-核心组件"><a href="#Spark-核心组件" class="headerlink" title="Spark 核心组件"></a>Spark 核心组件</h2><h3 id="主要概念"><a href="#主要概念" class="headerlink" title="主要概念"></a>主要概念</h3><h4 id="物理层面"><a href="#物理层面" class="headerlink" title="物理层面"></a>物理层面</h4><h5 id="Master"><a href="#Master" class="headerlink" title="Master"></a>Master</h5><p>　Master 负责分配资源</p>
<h5 id="Worker"><a href="#Worker" class="headerlink" title="Worker"></a>Worker</h5><p>　Worker 负责监控自己节点的内存和 CPU 等状况</p>
<h5 id="Driver"><a href="#Driver" class="headerlink" title="Driver"></a>Driver</h5><p>　在集群启动时，Driver 向 Master 申请资源</p>
<p>　运行时 Driver 能获得 Executor 的具体运行资源，Driver 与 Executor 之间直接进行通信，Driver 把 Job 划为 Task 传送给 Executor，Task 就是 Spark 程序的业务逻辑代码</p>
<h5 id="Executor"><a href="#Executor" class="headerlink" title="Executor"></a>Executor</h5><p>　Executor 接收任务，进行反序列化，得到数据的输入和输出，在分布式集群的相同数据分片上，数据的业务逻辑一样，只是数据不一样罢了。然后由 Executor 进程中的线程池负责执行，执行的结果汇报再返回汇报给 Driver 进程</p>
<h5 id="Task"><a href="#Task" class="headerlink" title="Task"></a>Task</h5><p>　Task 就是 Spark 程序的业务逻辑代码</p>
<h4 id="逻辑层面"><a href="#逻辑层面" class="headerlink" title="逻辑层面"></a>逻辑层面</h4><h5 id="Row"><a href="#Row" class="headerlink" title="Row"></a>Row</h5><p>　<strong>Row</strong> 表示关系运算中一行输出，本质上来说就是一个数组</p>
<h5 id="Dataset"><a href="#Dataset" class="headerlink" title="Dataset"></a>Dataset</h5><p>　<strong>DataSet</strong> 和 RDD、DataFrame 一样，都是分布式数据结构的概念。区别在于 DataSet 可以面向特定类型，也就是其无需将输入数据类型限制为 Row（还可以使用 Seq、Array、Product、Int 等类型）</p>
<h5 id="DataFrame"><a href="#DataFrame" class="headerlink" title="DataFrame"></a>DataFrame</h5><p>　<strong>DataFrame</strong> 相当于是 Dataset[Row] 的别名</p>
<h5 id="Encoder"><a href="#Encoder" class="headerlink" title="Encoder"></a>Encoder</h5><p>　<strong>Encoder</strong> 是 Dataset 中的关键组件，用来将外部类型转化为 Dataset 的内部类型 InternalRow</p>
<h3 id="Spark-SQL"><a href="#Spark-SQL" class="headerlink" title="Spark SQL"></a>Spark SQL</h3><p>　同时支持 <code>HiveQL</code> / <code>UDFs</code> / <code>SerDes</code> 等多样性的数据源，并采用 <code>JDBC</code> / <code>ODBC</code> 等标准化连接驱动，保证其通用性（整个流程的入口是 <code>org.apache.spark.sql.SparkSession#sql</code> 方法）</p>
<h3 id="Spark-GraphX"><a href="#Spark-GraphX" class="headerlink" title="Spark GraphX"></a>Spark GraphX</h3><p>　支持在 <code>graph</code> 或 <code>collection</code> 中查看数据，并提供丰富的 图形处理 API</p>
<h3 id="Spark-Streaming"><a href="#Spark-Streaming" class="headerlink" title="Spark Streaming"></a>Spark Streaming</h3><p>　将数据流 按 时间间隔 Duration 划分为一组连续的 RDD，再将这些 RDD 抽象为 DStream<br>　随后，通过对 DStream 这个 high-level 抽象的操作，实现对底层 标记了<code>时间间隙</code>的 RDD 组的操控</p>
<h3 id="Spark-MLbase"><a href="#Spark-MLbase" class="headerlink" title="Spark MLbase"></a>Spark MLbase</h3><p>　提供了对 Machine Learning 的易用、高效的实现<br>　总体的结构，基于 Spark，自底向上分别是，<code>MLlib</code> / <code>MLI</code> / <code>ML Optimizer</code></p>
<ul>
<li>MLlib 这一层，设计了 本地 / 分布式 的矩阵，对稀疏数据的支持，多模型的训练，提供了 计算模型 和 逻辑的 API</li>
<li>MLI 主要任务则是 提供 表针采集器 和 逻辑规则，并进一步对 高层次 ML 编程抽象成接口</li>
<li>ML Optimizer 则是通过自动构建 ML 的 pipe 管道路径实现 ML 优化器的作用。同时，该优化器还解决了一个在 <code>MLI</code> 和 <code>MLlib</code> 中 表征采集器 和 ML 逻辑规则的搜索问题</li>
</ul>
<h2 id="Spark-实时机器学习"><a href="#Spark-实时机器学习" class="headerlink" title="Spark 实时机器学习"></a>Spark 实时机器学习</h2><h3 id="什么是机器学习？"><a href="#什么是机器学习？" class="headerlink" title="什么是机器学习？"></a>什么是<a href="https://en.wikipedia.org/wiki/Machine_learning">机器学习</a>？</h3><p>　Wikipedia 给出的定义是，一个计算机科学的子领域，由 模式识别 和 人工智能 中的计算机学习理论 演变而来<br>　探索 结构化的、可学习的规则引擎，如何用来对数据 进行训练 和 预测</p>
<h3 id="什么又是-Real-time-机器学习呢？"><a href="#什么又是-Real-time-机器学习呢？" class="headerlink" title="什么又是 Real-time 机器学习呢？"></a>什么又是 Real-time 机器学习呢？</h3><p>　一般性的 机器学习 的对象 是一堆 offline 的训练集，通过对这些数据的学习，来确立模型<br>　如果数据是快速变化的，这时就需要将 新数据 分配好权重，加入到目标训练集中；之后，将预测出来的结果，再次反馈到 数据模型中去</p>
<h3 id="Real-time-和-No-Real-time-的本质区别在哪儿？"><a href="#Real-time-和-No-Real-time-的本质区别在哪儿？" class="headerlink" title="Real-time 和 No Real-time 的本质区别在哪儿？"></a>Real-time 和 No Real-time 的本质区别在哪儿？</h3><p>　因为 实时模型 是动态更新的，实现算法上，比 非实时的 ML 需要考虑，如何避免依赖 将 新数据 和 旧数据 整合在一块再计算所带来的性能问题<br>　更多时候，长期积累的数据，是很难再做到全量计算（比如，多项式贝叶斯 Multinomial naive bayes，用于处理 dataset 过大，而内存不足的情况）</p>
<h2 id="利用-Spark-实现-Real-time-ML"><a href="#利用-Spark-实现-Real-time-ML" class="headerlink" title="利用 Spark 实现 Real-time ML"></a>利用 Spark 实现 Real-time ML</h2><h3 id="源数据流"><a href="#源数据流" class="headerlink" title="源数据流"></a>源数据流</h3><ul>
<li>利用 <code>java.util.Random</code> 产生满足高斯分布的随机数据，再通过 <a href="http://www.scalanlp.org/">breeze</a> 放入到 <code>vector</code> 中，作为<strong>特征值</strong></li>
<li>在 <code>generateNoisyData</code> 中，将这个 <code>vector</code> 做 <code>inner product</code>, 并加入一点噪声数据，作为 <strong>label 标签</strong></li>
</ul>
<figure class="highlight scala"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> <span class="type">MaxEvents</span> = <span class="number">100</span></span><br><span class="line"><span class="keyword">val</span> <span class="type">NumFeatures</span> = <span class="number">100</span></span><br><span class="line"><span class="keyword">val</span> random = <span class="keyword">new</span> <span class="type">Random</span>()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generateRandomArray</span></span>(n: <span class="type">Int</span>) = <span class="type">Array</span>.tabulate(n)(_ =&gt; random.nextGaussian())</span><br><span class="line"><span class="keyword">val</span> w = <span class="keyword">new</span> <span class="type">DenseVector</span>(generateRandomArray(<span class="type">NumFeatures</span>))</span><br><span class="line"><span class="keyword">val</span> intercept = random.nextGaussian() * <span class="number">10</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generateNoisyData</span></span>(n: <span class="type">Int</span>) = {</span><br><span class="line">  (<span class="number">1</span> to n).map { i =&gt;</span><br><span class="line">    <span class="keyword">val</span> x = <span class="keyword">new</span> <span class="type">DenseVector</span>(generateRandomArray(<span class="type">NumFeatures</span>))</span><br><span class="line">    <span class="comment">// inner product</span></span><br><span class="line">    <span class="keyword">val</span> y: <span class="type">Double</span> = w.dot(x)</span><br><span class="line">    <span class="keyword">val</span> noisy = y + intercept</span><br><span class="line">    (noisy, x)</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>通过 <code>socket</code> 将数据 发送到指定端口</li>
</ul>
<figure class="highlight scala"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (args.length != <span class="number">2</span>) {</span><br><span class="line">  <span class="type">System</span>.err.println(<span class="string">"Usage: &lt;port&gt; &lt;millisecond&gt;"</span>)</span><br><span class="line">  <span class="type">System</span>.exit(<span class="number">1</span>)</span><br><span class="line">}</span><br><span class="line"><span class="keyword">val</span> listener = <span class="keyword">new</span> <span class="type">ServerSocket</span>(args(<span class="number">0</span>).toInt)</span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">  <span class="keyword">val</span> socket = listener.accept()</span><br><span class="line">  <span class="keyword">new</span> <span class="type">Thread</span>() {</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">run</span> </span>= {</span><br><span class="line">      println(<span class="string">"Got client connected from: "</span> + socket.getInetAddress)</span><br><span class="line">      <span class="keyword">val</span> out = <span class="keyword">new</span> <span class="type">PrintWriter</span>(socket.getOutputStream(), <span class="literal">true</span>)</span><br><span class="line">      <span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">        <span class="type">Thread</span>.sleep(args(<span class="number">1</span>).toLong)</span><br><span class="line">        <span class="keyword">val</span> num = random.nextInt(<span class="type">MaxEvents</span>)</span><br><span class="line">        <span class="keyword">val</span> data = generateNoisyData(num)</span><br><span class="line">        data.foreach { <span class="keyword">case</span> (y, x) =&gt;</span><br><span class="line">          <span class="keyword">val</span> xStr = x.data.mkString(<span class="string">","</span>)</span><br><span class="line">          <span class="keyword">val</span> content = <span class="string">s"<span class="subst">$y</span>\t<span class="subst">$xStr</span>"</span></span><br><span class="line">          println(content)</span><br><span class="line">          out.write(content)</span><br><span class="line">          out.write(<span class="string">"\n"</span>)</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">      socket.close()</span><br><span class="line">    }</span><br><span class="line">  }.start()</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="实时-Machine-Learning-模型"><a href="#实时-Machine-Learning-模型" class="headerlink" title="实时 Machine Learning 模型"></a>实时 Machine Learning 模型</h3><ul>
<li>指定 <code>spark-master</code> / <code>interval</code> 等参数，创建 StreamingContext（此处可以利用 local[n] 快速开发）</li>
</ul>
<figure class="highlight scala"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (args.length &lt; <span class="number">4</span>) {</span><br><span class="line">  <span class="type">System</span>.err.println(<span class="string">"Usage: WindowCounter &lt;master&gt; &lt;hostname&gt; &lt;port&gt; &lt;interval&gt; \n"</span> +</span><br><span class="line">    <span class="string">"In local mode, &lt;master&gt; should be 'local[n]' with n &gt; 1"</span>)</span><br><span class="line">  <span class="type">System</span>.exit(<span class="number">1</span>)</span><br><span class="line">}</span><br><span class="line"><span class="keyword">val</span> ssc = <span class="keyword">new</span> <span class="type">StreamingContext</span>(args(<span class="number">0</span>), <span class="string">"ML Analysis"</span>, <span class="type">Seconds</span>(args(<span class="number">3</span>).toInt))</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>获取到发送过来的 源数据</li>
</ul>
<figure class="highlight scala"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> stream = ssc.socketTextStream(args(<span class="number">1</span>), args(<span class="number">2</span>).toInt, <span class="type">StorageLevel</span>.<span class="type">MEMORY_ONLY_SER</span>)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>利用 <code>DenseVector.zeros[Double]</code> 创建全零的初始矩阵</p>
</li>
<li><p>使用 <code>StreamingLinearRegressionWithSGD</code> 创建 流式随机递归下降的线性回归 模型</p>
<p>目前 MLlib 只支持 Streaming（<code>KMeans</code> / <code>LinearRegression</code> / <code>LinearRegressionWithSGD</code>）in <a href="https://github.com/apache/spark/">Spark 1.4.1</a><br>Streaming MLlib 和普通的 MLlib 没有本质上的区别，只是输入的训练集是 DStream，需要使用 <code>foreachRDD</code> / <code>map</code> 进行 <strong>训练</strong> / <strong>预测</strong></p>
</li>
</ul>
<figure class="highlight scala"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> <span class="type">NumFeatures</span> = <span class="number">100</span></span><br><span class="line"><span class="keyword">val</span> zeroVector = <span class="type">DenseVector</span>.zeros[<span class="type">Double</span>](<span class="type">NumFeatures</span>)</span><br><span class="line"><span class="keyword">val</span> model = <span class="keyword">new</span> <span class="type">StreamingLinearRegressionWithSGD</span>()</span><br><span class="line">  .setInitialWeights(<span class="type">Vectors</span>.dense(zeroVector.data))</span><br><span class="line">  .setNumIterations(<span class="number">1</span>)</span><br><span class="line">  .setStepSize(<span class="number">0.01</span>)</span><br><span class="line"><span class="keyword">val</span> labeledStream = stream.map { event =&gt;</span><br><span class="line">  <span class="keyword">val</span> split = event.split(<span class="string">"\t"</span>)</span><br><span class="line">  <span class="keyword">val</span> y = split(<span class="number">0</span>).toDouble</span><br><span class="line">  <span class="keyword">val</span> features = split(<span class="number">1</span>).split(<span class="string">","</span>).map(_.toDouble)</span><br><span class="line">  <span class="type">LabeledPoint</span>(label = y, features = <span class="type">Vectors</span>.dense(features))</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>利用 模型 进行 <code>train</code> / <code>predict</code></li>
</ul>
<figure class="highlight scala"><table><tbody><tr><td class="code"><pre><span class="line">model.trainOn(labeledStream)</span><br><span class="line"><span class="keyword">val</span> predictAndTrue = labeledStream.transform { rdd =&gt;</span><br><span class="line">  <span class="keyword">val</span> latest = model.latestModel()</span><br><span class="line">  rdd.map { point =&gt;</span><br><span class="line">    <span class="keyword">val</span> predict = latest.predict(point.features)</span><br><span class="line">    (predict - point.label)</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>通过 <strong>MSE</strong>（<strong>M</strong>ean <strong>S</strong>quared <strong>E</strong>rror）均方差 和 <strong>RMSE</strong>（<strong>R</strong>oot <strong>M</strong>ean <strong>S</strong>quared <strong>E</strong>rror）均方根误差 对模型的性能进行评估（这里也可以使用 RegressionMetrics 来实现）</li>
</ul>
<figure class="highlight scala"><table><tbody><tr><td class="code"><pre><span class="line">predictAndTrue.foreachRDD { (rdd, time) =&gt;</span><br><span class="line">  <span class="keyword">val</span> mse = rdd.map { <span class="keyword">case</span> (err) =&gt; err * err }.mean()</span><br><span class="line">  <span class="keyword">val</span> rmse = math.sqrt(mse)</span><br><span class="line">  println( <span class="string">s""</span><span class="string">"</span></span><br><span class="line"><span class="string">              |-------------------------------------------</span></span><br><span class="line"><span class="string">              |Time: $time</span></span><br><span class="line"><span class="string">              |-------------------------------------------</span></span><br><span class="line"><span class="string">                  "</span><span class="string">""</span>.stripMargin)</span><br><span class="line">  println(<span class="string">s"MSE current batch: Model : <span class="subst">$mse</span>"</span>)</span><br><span class="line">  println(<span class="string">s"RMSE current batch: Model : <span class="subst">$rmse</span>"</span>)</span><br><span class="line">  println(<span class="string">"...\n"</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>启动 Spark 上下文</li>
</ul>
<figure class="highlight scala"><table><tbody><tr><td class="code"><pre><span class="line">ssc.start()</span><br><span class="line">ssc.awaitTermination()</span><br></pre></td></tr></tbody></table></figure>
<h2 id="一劳永逸了？Not-at-all"><a href="#一劳永逸了？Not-at-all" class="headerlink" title="一劳永逸了？Not at all!"></a>一劳永逸了？Not at all!</h2><p>　一个优秀的 Machine Learning 模型，是要结合具体业务，从对数据流入的清洗，特征值维度的考量，模型类型的选择，到最终的性能的评估、监控、持续优化，都需要仔细地考究，最终才能打造出高效、稳定、精准的数据模型</p>
<h3 id="数据"><a href="#数据" class="headerlink" title="数据"></a>数据</h3><p>　对目标数据集进行处理之前，首先就是对数据的类型进行归类，是数值型、类别型、文本型，还是其他一些多媒体、地理信息等<br>　针对不同的数据，分别采取不同的处理手段，对于类别型常用 <code>1-of-k encoding</code> 对每个类别进行编码<br>　对于文本型，则会采用 分词、移除 <code>stop words</code>（的、这、地；<code>the</code>/<code>and</code>/<code>but</code> …）、向量化、标准化（避免度量单位的影响）</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line">np.random.seed(<span class="number">42</span>)</span><br><span class="line">x = np.random.randn(<span class="number">10</span>)</span><br><span class="line">norm_x_2 = np.linalg.norm(x)</span><br><span class="line">normalized_x = x / norm_x_2</span><br><span class="line"><span class="keyword">print</span> <span class="string">"x:\n%s"</span> % x</span><br><span class="line"><span class="keyword">print</span> <span class="string">"2-Norm of x: %2.4f"</span> % norm_x_2</span><br><span class="line"><span class="keyword">print</span> <span class="string">"Normalized x:\n%s"</span> % normalized_x</span><br><span class="line"><span class="keyword">print</span> <span class="string">"2-Norm of normalized_x: %2.4f"</span> % np.linalg.norm(normalized_x)</span><br></pre></td></tr></tbody></table></figure>
<p>　还有还多常用的数据处理方式，如 平均值、中位数、总和、方差、差值、最大值、最小值<br>　针对时间的处理，还可以加上 “时间戳” 字段</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">assign_tod</span>(<span class="params">hr</span>):</span></span><br><span class="line">    times_of_day = {</span><br><span class="line">        <span class="string">'morning'</span> : range(<span class="number">7</span>, <span class="number">12</span>),</span><br><span class="line">        <span class="string">'lunch'</span> : range(<span class="number">12</span>, <span class="number">14</span>),</span><br><span class="line">        <span class="string">'afternoon'</span> : range(<span class="number">14</span>, <span class="number">18</span>),</span><br><span class="line">        <span class="string">'evening'</span> : range(<span class="number">18</span>, <span class="number">23</span>),</span><br><span class="line">        <span class="string">'night'</span> : range(<span class="number">23</span>, <span class="number">7</span>)</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> times_of_day.iteritems():</span><br><span class="line">    <span class="keyword">if</span> hr <span class="keyword">in</span> v:</span><br><span class="line">        <span class="keyword">return</span> k</span><br><span class="line">time_of_day = hour_of_day.map(<span class="keyword">lambda</span> hr: assign_tod(hr))</span><br></pre></td></tr></tbody></table></figure>
<h3 id="特征维度"><a href="#特征维度" class="headerlink" title="特征维度"></a>特征维度</h3><p>　常见的一个影响模型的因素，便是没有对特征 进行标准化</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">(element-wise - the preceding mean vector from the feature vector) / the vector of feature standard deviations</span><br></pre></td></tr></tbody></table></figure>
<p>　利用 StandarScaler 完成标准化工作</p>
<figure class="highlight scala"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.spark.mllib.feature.<span class="type">StandardScaler</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> scaler = <span class="keyword">new</span> <span class="type">StandardScaler</span>(withMean = <span class="literal">true</span>, withStd = <span class="literal">true</span>).fit(vectors)</span><br><span class="line"><span class="keyword">val</span> scaledData = data.map(lp =&gt; <span class="type">LabeledPoint</span>(lp.label, scaler.transform(lp.features)))</span><br></pre></td></tr></tbody></table></figure>
<h3 id="调整模型"><a href="#调整模型" class="headerlink" title="调整模型"></a>调整模型</h3><p>　首先需要在众多的模型 和 对应的算法 中找到最为适用的选择<br>　模型的类别主要有，<strong>推荐引擎</strong>、<strong>分类模型</strong>、<strong>回归模型</strong>、<strong>聚类模型</strong> 等<br>　相应的实现算法，又有（线性 / 逻辑 / 多元）<strong>回归</strong>、（随机森林）<strong>决策树</strong>、（朴素 / 高斯 / 多项式 / 伯努利 / 信念网络）<strong>贝叶斯</strong> 等<br>　在选择的时候，更多会考虑 特征值是否<strong>多维</strong>（可以尝试降维），目标类别是 <strong>multiclass</strong>，<strong>binary</strong>，还是 <strong>probability</strong>（连续值）</p>
<ul>
<li>根据 数据集的 稀疏程度 对正则化（Regularizer）进行调整</li>
</ul>
<figure class="highlight scala"><table><tbody><tr><td class="code"><pre><span class="line">zero: 没有任何正规化操作</span><br><span class="line"><span class="type">L1</span>:   <span class="type">SGD</span>（<span class="type">Stochastic</span> gradient descent，随机梯度下降）</span><br><span class="line"><span class="type">L2</span>:   <span class="type">LBFGS</span>（<span class="type">Limited</span>-memory <span class="type">BFGS</span>，受限的 <span class="type">BFGS</span>）</span><br><span class="line"></span><br><span class="line"><span class="type">L2</span> 相比 <span class="type">L1</span> 更为平滑（同样，<span class="type">L1</span> 可以让 稀疏的数据集 得到更 直观的模型）</span><br><span class="line">还有其它 求最优解 的方法，如 求全局最优解的 <span class="type">BGD</span>（<span class="type">Batch</span> gradient descent，批量梯度下降）</span><br><span class="line">但是，由于每次迭代都需要依据训练集中所有的数据，所以速度很慢；</span><br><span class="line">以及 <span class="type">CG</span>（<span class="type">Conjugate</span> gradient，共轭梯度法），但还没有被 <span class="type">Spark</span> <span class="type">MLlib</span> 所支持，可以在 <span class="type">Breeze</span> 中找到它</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>可以通过 <code>setUpdater</code> 将模型的 规则化算法 设置为 <code>L1</code>（默认为 <code>L2</code>）</li>
</ul>
<figure class="highlight scala"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.spark.mllib.optimization.<span class="type">L1Updater</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> svmAlg = <span class="keyword">new</span> <span class="type">SVMWithSGD</span>()</span><br><span class="line">svmAlg.optimizer</span><br><span class="line">  .setNumIterations(<span class="number">200</span>)</span><br><span class="line">  .setRegParam(<span class="number">0.1</span>)</span><br><span class="line">  .setUpdater(<span class="keyword">new</span> <span class="type">L1Updater</span>)</span><br><span class="line"><span class="keyword">val</span> modelL1 = svmAlg.run(training)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>当然，还有举不胜举的优化方式，详见文章最后的 <a href="https://yuzhouwan.com/posts/4735/#整体知识树">Spark 思维导图</a> :-)</li>
</ul>
<h3 id="性能评估指标"><a href="#性能评估指标" class="headerlink" title="性能评估指标"></a>性能评估指标</h3><ul>
<li>针对不同的业务，对性能评测的手段，也需要相应取舍，毕竟有些 “宁可错杀一千” 的变态 防护系统，就需要对 <code>recall</code> 有较高的要求，而 <code>precision</code> 则相对宽松些<ul>
<li>这时便可采用 <strong>ROC</strong>（<strong>R</strong>eceiver <strong>O</strong>perating <strong>C</strong>haracteristic）curve 评测引擎：</li>
</ul>
</li>
</ul>
<figure class="highlight scala"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// binary classification</span></span><br><span class="line"><span class="keyword">val</span> metrics = <span class="type">Seq</span>(lrModel, svmModel).map { model =&gt;</span><br><span class="line">  <span class="keyword">val</span> scoreAndLabels = data.map { point =&gt;</span><br><span class="line">    (model.predict(point.features), point.label)</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">val</span> metrics = <span class="keyword">new</span> <span class="type">BinaryClassificationMetrics</span>(scoreAndLabels)</span><br><span class="line">  (model.getClass.getSimpleName, metrics.areaUnderPR, metrics.areaUnderROC)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>如果是 <strong>贝叶斯</strong> / <strong>决策树</strong> 的数据模型，则可以用 <code>0.5</code> 对其进行划分，转换为 <code>binary</code> 分类问题</li>
</ul>
<figure class="highlight scala"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// naive bayes</span></span><br><span class="line"><span class="keyword">val</span> nbMetrics = <span class="type">Seq</span>(nbModel).map { model =&gt;</span><br><span class="line">  <span class="keyword">val</span> scoreAndLabels = nbData.map { point =&gt;</span><br><span class="line">    <span class="keyword">val</span> score = model.predict(point.features)</span><br><span class="line">    (<span class="keyword">if</span> (score &gt; <span class="number">0.5</span>) <span class="number">1.0</span> <span class="keyword">else</span> <span class="number">0.0</span>, point.label)</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">val</span> metrics = <span class="keyword">new</span> <span class="type">BinaryClassificationMetrics</span>(scoreAndLabels)</span><br><span class="line">  (model.getClass.getSimpleName, metrics.areaUnderPR, metrics.areaUnderROC)</span><br><span class="line">}</span><br><span class="line"><span class="comment">// decision tree</span></span><br><span class="line"><span class="keyword">val</span> dtMetrics = <span class="type">Seq</span>(dtModel).map { model =&gt;</span><br><span class="line">  <span class="keyword">val</span> scoreAndLabels = data.map { point =&gt;</span><br><span class="line">    <span class="keyword">val</span> score = model.predict(point.features)</span><br><span class="line">    (<span class="keyword">if</span> (score &gt; <span class="number">0.5</span>) <span class="number">1.0</span> <span class="keyword">else</span> <span class="number">0.0</span>, point.label)</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">val</span> metrics = <span class="keyword">new</span> <span class="type">BinaryClassificationMetrics</span>(scoreAndLabels)</span><br><span class="line">  (model.getClass.getSimpleName, metrics.areaUnderPR, metrics.areaUnderROC)</span><br><span class="line">}</span><br><span class="line"><span class="keyword">val</span> allMetrics = metrics ++ nbMetrics ++ dtMetrics</span><br><span class="line">allMetrics.foreach { <span class="keyword">case</span> (m, pr, roc) =&gt;</span><br><span class="line">  println(<span class="string">f"<span class="subst">$m</span>, Area under PR: <span class="subst">${pr * 100.0}</span>%2.4f%%, Area under ROC: <span class="subst">${roc * 100.0}</span>%2.4f%%"</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>然而，如果是一些推荐系统，更多的希望能够了解到 大体的预测精度，则可以采用 <strong>MAP</strong>（<strong>M</strong>ean <strong>A</strong>verage <strong>P</strong>recision）平均精度均值 进行评估</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">MAP 同时还解决了 precision，recall，F-measure 中存在的单点值局限性问题</span><br></pre></td></tr></tbody></table></figure>
<h2 id="踩过的坑"><a href="#踩过的坑" class="headerlink" title="踩过的坑"></a>踩过的坑</h2><h3 id="spark-任务使用-UGI-之后，实际-task-在生成中间文件的时候，没有感知到外层设置的-UGI-信息"><a href="#spark-任务使用-UGI-之后，实际-task-在生成中间文件的时候，没有感知到外层设置的-UGI-信息" class="headerlink" title="spark 任务使用 UGI 之后，实际 task 在生成中间文件的时候，没有感知到外层设置的 UGI 信息"></a>spark 任务使用 UGI 之后，实际 task 在生成中间文件的时候，没有感知到外层设置的 UGI 信息</h3><h4 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ hdfs dfs -ls /user | grep yuzhouwan</span><br><span class="line">  drwxrwxrwx   - yuzhouwan yuzhouwan          0 2018-04-24 14:27 /user/yuzhouwan</span><br><span class="line">$ hdfs dfs -ls /user/yuzhouwan</span><br><span class="line">  drwxrwxrwx   - user_A user_A                0 2018-04-24 14:27 /user/yuzhouwan/user_A</span><br><span class="line"></span><br><span class="line"><span class="comment"># 代码中，需要将数据，写入到 /user/yuzhouwan/user_A 中，但是报错权限不足</span></span><br><span class="line">UGICache.doAs(<span class="string">"user_A"</span>, () =&gt; {</span><br><span class="line">  sparkContext.parallelize(Seq(1 to 10), 1).saveAsTextFile(<span class="string">"/user/yuzhouwan/user_A/seq"</span>)</span><br><span class="line">})</span><br><span class="line"></span><br><span class="line">org.apache.hadoop.security.AccessControlException: Permission denied: user=user_A, access=WRITE, inode=<span class="string">"/user/yuzhouwan/user_A/seq"</span>:yuzhouwan:user_A:drwxr-xr-x</span><br></pre></td></tr></tbody></table></figure>
<h4 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> <span class="variable">$HADOOP_HOME</span>/logs</span><br><span class="line">$ grep <span class="string">"/user/yuzhouwan/user_A/"</span> hdfs-audit.log | grep -v <span class="string">"getfileinfo"</span></span><br><span class="line">  2018-04-23 19:04:34,764 INFO org.apache.hadoop.hdfs.server.namenode.FSNamesystem.audit: allowed=<span class="literal">true</span>	ugi=user_A (auth:SIMPLE)	ip=/10.10.10.1	cmd=mkdirs	src=/user/yuzhouwan/user_A/2018-04-23/940_2018-04-23_user_A_68673976_0/_temporary/0	dst=null	perm=user_A:yuzhouwan:rwxr-xr-x	proto=rpc</span><br><span class="line">  2018-04-23 19:04:35,353 INFO org.apache.hadoop.hdfs.server.namenode.FSNamesystem.audit: allowed=<span class="literal">true</span>	ugi=yuzhouwan (auth:SIMPLE)	ip=/10.10.10.1	cmd=create	src=/user/yuzhouwan/user_A/2018-04-23/940_2018-04-23_user_A_68673976_0/_temporary/0/_temporary/attempt_20180423190434_0723_m_000000_737/part-00000.deflate	dst=null	perm=yuzhouwan:yuzhouwan:rw-r--r--	proto=rpc</span><br><span class="line">  2018-04-23 19:04:36,017 INFO org.apache.hadoop.hdfs.server.namenode.FSNamesystem.audit: allowed=<span class="literal">true</span>	ugi=yuzhouwan (auth:SIMPLE)	ip=/10.10.10.1	cmd=rename	src=/user/yuzhouwan/user_A/2018-04-23/940_2018-04-23_user_A_68673976_0/_temporary/0/_temporary/attempt_20180423190434_0723_m_000000_737	dst=/user/yuzhouwan/user_A/2018-04-23/940_2018-04-23_user_A_68673976_0/_temporary/0/task_20180423190434_0723_m_000000	perm=yuzhouwan:yuzhouwan:rwxr-xr-x	proto=rpc</span><br><span class="line">  2018-04-23 19:04:36,040 INFO org.apache.hadoop.hdfs.server.namenode.FSNamesystem.audit: allowed=<span class="literal">true</span>	ugi=user_A (auth:SIMPLE)	ip=/10.10.10.1	cmd=listStatus	src=/user/yuzhouwan/user_A/2018-04-23/940_2018-04-23_user_A_68673976_0/_temporary/0	dst=null	perm=null	proto=rpc</span><br><span class="line">  2018-04-23 19:04:36,060 INFO org.apache.hadoop.hdfs.server.namenode.FSNamesystem.audit: allowed=<span class="literal">true</span>	ugi=user_A (auth:SIMPLE)	ip=/10.10.10.1	cmd=listStatus	src=/user/yuzhouwan/user_A/2018-04-23/940_2018-04-23_user_A_68673976_0/_temporary/0/task_20180423190434_0723_m_000000	dst=null	perm=null	proto=rpc</span><br><span class="line">  2018-04-23 19:04:36,083 INFO org.apache.hadoop.hdfs.server.namenode.FSNamesystem.audit: allowed=<span class="literal">false</span>	ugi=user_A (auth:SIMPLE)	ip=/10.10.10.1	cmd=rename	src=/user/yuzhouwan/user_A/2018-04-23/940_2018-04-23_user_A_68673976_0/_temporary/0/task_20180423190434_0723_m_000000/part-00000.deflate	dst=/user/yuzhouwan/user_A/2018-04-23/940_2018-04-23_user_A_68673976_0/part-00000.deflate	perm=null	proto=rpc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过查看 HDFS 的 audit 审计日志，可以看到创建 deflate 中间文件的时候，使用的 UGI 是 yuzhouwan，而不是 user_A，导致到最后一步，使用 user_A 用户 rename 的时候，报错权限不足</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h4><p>　首先，需要保证用户 user_A 不需要写入的数据，只能由它自己才能查看。一方面，如果权限控制不在 spark 任务中，而是交给上层应用来控制，则完全可以使用 yuzhouwan 用户权限写入到 HDFS 中；另一方面，也可以先使用 yuzhouwan 用户权限写入，然后再通过 chown 赋权到 user_A 用户下</p>
<h3 id="saveAsTextFile-不传入压缩类型，也对输出文件进行了压缩"><a href="#saveAsTextFile-不传入压缩类型，也对输出文件进行了压缩" class="headerlink" title="saveAsTextFile 不传入压缩类型，也对输出文件进行了压缩"></a>saveAsTextFile 不传入压缩类型，也对输出文件进行了压缩</h3><h4 id="描述-1"><a href="#描述-1" class="headerlink" title="描述"></a>描述</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ spark-shell --master <span class="built_in">local</span></span><br><span class="line">  scala&gt; sc.parallelize(Seq(1 to 10), 1).collect.foreach(<span class="built_in">print</span>(_))</span><br><span class="line">    Range(1, 2, 3, 4, 5, 6, 7, 8, 9, 10)</span><br><span class="line"></span><br><span class="line">  scala&gt; sc.parallelize(Seq(1 to 10), 1).saveAsTextFile(<span class="string">"/user/yuzhouwan"</span>)</span><br><span class="line">    18/04/24 11:22:01 WARN DefaultCodec: DefaultCodec.createOutputStream() may leak memory. Create a compressor first.</span><br><span class="line"></span><br><span class="line">$ hdfs dfs -ls /user/yuzhouwan</span><br><span class="line">  Found 2 items</span><br><span class="line">  -rw-r--r--   3 bigdata yuzhouwan          0 2018-04-24 11:22 /user/yuzhouwan/_SUCCESS</span><br><span class="line">  -rw-r--r--   3 bigdata yuzhouwan         45 2018-04-24 11:22 /user/yuzhouwan/part-00000.deflate</span><br></pre></td></tr></tbody></table></figure>
<h4 id="解决-1"><a href="#解决-1" class="headerlink" title="解决"></a>解决</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 发现依赖的 Hadoop 配置文件中，已经开启了压缩</span></span><br><span class="line">$ vim <span class="variable">$HADOOP_HOME</span>/etc/hadoop/mapred-site.xml</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;mapred.compress.map.output&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;<span class="literal">true</span>&lt;/value&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 需要设置 spark.hadoop.mapreduce.output.fileoutputformat.compress=false</span></span><br><span class="line"><span class="comment"># 或者 spark.hadoop.mapred.output.compress=false</span></span><br><span class="line"><span class="comment"># 前者，是负责往 hadoop 和 hive 里面写的时候，会设置压缩；后者，是负责往 json / txt / csv 里面写的时候，设置压缩</span></span><br><span class="line"><span class="comment"># 一个是面向 目标系统类型，另一个是面向 目标文件类型</span></span><br><span class="line">$ spark-shell --master <span class="built_in">local</span> --conf spark.hadoop.mapreduce.output.fileoutputformat.compress=<span class="literal">false</span></span><br><span class="line">  scala&gt; sc.parallelize(Seq(1 to 10), 1).saveAsTextFile(<span class="string">"/user/yuzhouwan0"</span>)</span><br><span class="line"></span><br><span class="line">$ hdfs dfs -ls /user/yuzhouwan0</span><br><span class="line">  Found 2 items</span><br><span class="line">  -rw-r--r--   3 bigdata yuzhouwan          0 2018-04-24 11:41 /user/yuzhouwan0/_SUCCESS</span><br><span class="line">  -rw-r--r--   3 bigdata yuzhouwan         37 2018-04-24 11:41 /user/yuzhouwan0/part-00000</span><br><span class="line"></span><br><span class="line">$ hdfs dfs -cat /user/yuzhouwan0/part-00000</span><br><span class="line">  Range(1, 2, 3, 4, 5, 6, 7, 8, 9, 10)</span><br></pre></td></tr></tbody></table></figure>
<h4 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h4><figure class="highlight scala"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// saveAsTextFile 方法的第二个参数可以指定压缩类型，可以覆盖全局配置中，已经存在的压缩配置</span></span><br><span class="line"><span class="comment">// 需要注意的是，压缩算法只支持 CompressionCodec 接口的实现子类，包括 DefaultCodec、BZip2Codec、GzipCodec、HadoopSnappyCodec、Lz4Codec、SnappyCodec etc.</span></span><br><span class="line">sc.parallelize(<span class="type">Seq</span>(<span class="number">1</span> to <span class="number">10</span>), <span class="number">1</span>).coalesce(<span class="number">1</span>, shuffle = <span class="literal">true</span>).saveAsTextFile(<span class="string">"/user/yuzhouwan1"</span>, classOf[org.apache.hadoop.io.compress.<span class="type">GzipCodec</span>])</span><br></pre></td></tr></tbody></table></figure>
<h3 id="无法判断-spark-session-中临时函数是否存在"><a href="#无法判断-spark-session-中临时函数是否存在" class="headerlink" title="无法判断 spark session 中临时函数是否存在"></a>无法判断 spark session 中临时函数是否存在</h3><h4 id="描述-2"><a href="#描述-2" class="headerlink" title="描述"></a>描述</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 获取 session state 中判断临时函数 FunctionIdentifier 是否存在，但是仍然不行</span></span><br><span class="line"><span class="keyword">if</span> (!sparkSession.sessionState.catalog.functionExists(yuzhouwanIdentifier)) {</span><br><span class="line">  sparkSession.sql(<span class="string">"CREATE TEMPORARY FUNCTION yuzhouwan as 'org.apache.spark.sql.hive.udf.YuZhouWan'"</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="解决-2"><a href="#解决-2" class="headerlink" title="解决"></a>解决</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!sparkSession.catalog.functionExists(<span class="string">"yuzhouwan"</span>)) {</span><br><span class="line">  sparkSession.sql(<span class="string">"CREATE TEMPORARY FUNCTION yuzhouwan as 'org.apache.spark.sql.hive.udf.YuZhouWan'"</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="补充-1"><a href="#补充-1" class="headerlink" title="补充"></a>补充</h4><p>　目前，Spark SQL 中 <code>IF NOT EXISTS</code> 的语法只支持创建 DATABASE、TABLE（包括 临时表 和 外部表）、VIEW（不包括 临时视图）、SCHEMA 的时候使用，尚<a href="https://issues.apache.org/jira/browse/SPARK-24077">不支持</a>临时函数</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ spark-shell --master <span class="built_in">local</span></span><br><span class="line"></span><br><span class="line">scala&gt; org.apache.spark.sql.SparkSession.builder().enableHiveSupport.getOrCreate.sql(<span class="string">"CREATE TEMPORARY FUNCTION IF NOT EXISTS yuzhouwan as 'org.apache.spark.sql.hive.udf.YuZhouWan'"</span>)</span><br><span class="line"></span><br><span class="line">  org.apache.spark.sql.catalyst.parser.ParseException: mismatched input <span class="string">'NOT'</span> expecting {<span class="string">'.'</span>, <span class="string">'AS'</span>}(line 1, pos 29)</span><br><span class="line"></span><br><span class="line">  == SQL ==</span><br><span class="line">  CREATE TEMPORARY FUNCTION IF NOT EXISTS yuzhouwan as <span class="string">'org.apache.spark.sql.hive.udf.YuZhouWan'</span></span><br><span class="line">  -----------------------------^^^</span><br><span class="line">    at org.apache.spark.sql.catalyst.parser.ParseException.withCommand(ParseDriver.scala:197)</span><br><span class="line">    at org.apache.spark.sql.catalyst.parser.AbstractSqlParser.parse(ParseDriver.scala:99)</span><br><span class="line">    at org.apache.spark.sql.execution.SparkSqlParser.parse(SparkSqlParser.scala:45)</span><br><span class="line">    at org.apache.spark.sql.catalyst.parser.AbstractSqlParser.parsePlan(ParseDriver.scala:53)</span><br><span class="line">    at org.apache.spark.sql.SparkSession.sql(SparkSession.scala:592)</span><br><span class="line">    ... 48 elided</span><br></pre></td></tr></tbody></table></figure>
<h3 id="控制-spark-结果文件数量，并返回唯一的文件路径"><a href="#控制-spark-结果文件数量，并返回唯一的文件路径" class="headerlink" title="控制 spark 结果文件数量，并返回唯一的文件路径"></a>控制 spark 结果文件数量，并返回唯一的文件路径</h3><h4 id="解决-3"><a href="#解决-3" class="headerlink" title="解决"></a>解决</h4><figure class="highlight scala"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.net.<span class="type">URI</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.<span class="type">Configuration</span></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.{<span class="type">FileSystem</span>, <span class="type">Path</span>}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将数据写入到某一个文件下，会产生两个文件 _SUCCESS 和 part-00000-126ddb4d-22a8-4c3d-88cb-52a59da4c66a.json</span></span><br><span class="line"><span class="keyword">val</span> exportDir = <span class="string">"/user/yuzhouwan/export"</span></span><br><span class="line">sparkSession.sql(subTaskSql).limit(<span class="number">1000</span>).coalesce(<span class="number">1</span>).write.json(exportDir)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 排除掉 _SUCCESS 文件，拿到 json 文件的全路径</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getSingleExportFile</span></span>(exportDir: <span class="type">String</span>): <span class="type">String</span> = {</span><br><span class="line">  <span class="keyword">val</span> sourceFS = <span class="type">FileSystem</span>.get(<span class="keyword">new</span> <span class="type">URI</span>(exportDir), <span class="keyword">new</span> <span class="type">Configuration</span>())</span><br><span class="line">  <span class="keyword">if</span> (sourceFS == <span class="literal">null</span> || !sourceFS.exists(<span class="keyword">new</span> <span class="type">Path</span>(exportDir))) <span class="keyword">return</span> <span class="string">""</span></span><br><span class="line">  <span class="keyword">val</span> filesStatus = sourceFS.listStatus(<span class="keyword">new</span> <span class="type">Path</span>(exportDir))</span><br><span class="line">  <span class="keyword">if</span> (filesStatus == <span class="literal">null</span> || filesStatus.length &lt;= <span class="number">0</span>) <span class="keyword">return</span> <span class="string">""</span></span><br><span class="line">  <span class="keyword">for</span> (fileStatus &lt;- filesStatus) {</span><br><span class="line">    <span class="keyword">if</span> (fileStatus.isFile) {</span><br><span class="line">      <span class="keyword">val</span> path = fileStatus.getPath.getName</span><br><span class="line">      <span class="keyword">if</span> (!path.contains(<span class="string">"SUCCESS"</span>)) {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">if</span> (exportDir.endsWith(<span class="string">"/"</span>)) exportDir.concat(path) <span class="keyword">else</span> exportDir.concat(<span class="string">"/"</span>).concat(path)</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="string">""</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> singleFilePath = getSingleExportFile(exportDir)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="KafkaUtils-createDirectStream-报错-OffsetOutOfRangeException"><a href="#KafkaUtils-createDirectStream-报错-OffsetOutOfRangeException" class="headerlink" title="KafkaUtils.createDirectStream 报错 OffsetOutOfRangeException"></a>KafkaUtils.createDirectStream 报错 OffsetOutOfRangeException</h3><h4 id="描述-3"><a href="#描述-3" class="headerlink" title="描述"></a>描述</h4><figure class="highlight scala"><table><tbody><tr><td class="code"><pre><span class="line">&lt;scala.short.version&gt;<span class="number">2.11</span>&lt;/scala.short.version&gt;</span><br><span class="line">&lt;scala.version&gt;${scala.short.version}<span class="number">.8</span>&lt;/scala.version&gt;</span><br><span class="line">&lt;spark.version&gt;<span class="number">2.1</span><span class="number">.0</span><span class="number">.5</span>&lt;/spark.version&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.spark&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spark-core_${scala.short.version}&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;${spark.version}&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> kafkaParams = <span class="type">Map</span>[<span class="type">String</span>, <span class="type">String</span>](<span class="string">"metadata.broker.list"</span> -&gt; brokers)</span><br><span class="line"><span class="keyword">val</span> messageHandler = (mam: <span class="type">MessageAndMetadata</span>[<span class="type">Array</span>[<span class="type">Byte</span>], <span class="type">Array</span>[<span class="type">Byte</span>]]) =&gt; (mam.key, mam.message)</span><br><span class="line"><span class="type">KafkaUtils</span>.createDirectStream[<span class="type">Array</span>[<span class="type">Byte</span>], <span class="type">Array</span>[<span class="type">Byte</span>], <span class="type">DefaultDecoder</span>, <span class="type">DefaultDecoder</span>, (<span class="type">Array</span>[<span class="type">Byte</span>], <span class="type">Array</span>[<span class="type">Byte</span>])](ssc, kafkaParams, fromOffsets, messageHandler)</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">Caused by: kafka.common.OffsetOutOfRangeException</span><br><span class="line">    at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)</span><br><span class="line">    at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:57)</span><br><span class="line">    at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)</span><br><span class="line">    at java.lang.reflect.Constructor.newInstance(Constructor.java:526)</span><br><span class="line">    at java.lang.Class.newInstance(Class.java:374)</span><br><span class="line">    at kafka.common.ErrorMapping$.exceptionFor(ErrorMapping.scala:86)</span><br><span class="line">    at org.apache.spark.streaming.kafka.KafkaRDD<span class="variable">$KafkaRDDIterator</span>.handleFetchErr(KafkaRDD.scala:184)</span><br><span class="line">    at org.apache.spark.streaming.kafka.KafkaRDD<span class="variable">$KafkaRDDIterator</span>.fetchBatch(KafkaRDD.scala:193)</span><br><span class="line">    at org.apache.spark.streaming.kafka.KafkaRDD<span class="variable">$KafkaRDDIterator</span>.getNext(KafkaRDD.scala:208)</span><br><span class="line">    at org.apache.spark.util.NextIterator.hasNext(NextIterator.scala:73)</span><br><span class="line">    at org.apache.spark.storage.memory.MemoryStore.putIteratorAsValues(MemoryStore.scala:215)</span><br><span class="line">    at org.apache.spark.storage.BlockManager$<span class="variable">$anonfun</span><span class="variable">$doPutIterator</span><span class="variable">$1</span>.apply(BlockManager.scala:957)</span><br><span class="line">    at org.apache.spark.storage.BlockManager$<span class="variable">$anonfun</span><span class="variable">$doPutIterator</span><span class="variable">$1</span>.apply(BlockManager.scala:948)</span><br><span class="line">    at org.apache.spark.storage.BlockManager.doPut(BlockManager.scala:888)</span><br><span class="line">    at org.apache.spark.storage.BlockManager.doPutIterator(BlockManager.scala:948)</span><br><span class="line">    at org.apache.spark.storage.BlockManager.getOrElseUpdate(BlockManager.scala:694)</span><br><span class="line">    at org.apache.spark.rdd.RDD.getOrCompute(RDD.scala:334)</span><br><span class="line">    at org.apache.spark.rdd.RDD.iterator(RDD.scala:285)</span><br><span class="line">    at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</span><br><span class="line">    at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:323)</span><br><span class="line">    at org.apache.spark.rdd.RDD.iterator(RDD.scala:287)</span><br><span class="line">    at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</span><br></pre></td></tr></tbody></table></figure>
<h4 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h4><p>　该问题是因为 Kafka 的 topic 中，数据因为长时间未消费，超出了 <code>log.retention.[hours|minutes|ms]</code> 时间（默认 <a href="https://kafka.apache.org/documentation/#brokerconfigs">168</a> 小时，也就是一周）。此时，broker 会将这部分数据清除掉，并更新 offset 信息（offset 变小了）。但是，程序中仍然用的是之前的 offset 信息，所以就会报错超出了现有 offset 的范围</p>
<h4 id="解决-4"><a href="#解决-4" class="headerlink" title="解决"></a>解决</h4><figure class="highlight scala"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 使用不指定 offset 的 createDirectStream 重载方法，并重启 spark streaming 程序</span></span><br><span class="line"><span class="type">KafkaUtils</span>.createDirectStream[<span class="type">Array</span>[<span class="type">Byte</span>], <span class="type">Array</span>[<span class="type">Byte</span>], <span class="type">DefaultDecoder</span>, <span class="type">DefaultDecoder</span>](ssc, kafkaParams, topicSet)</span><br></pre></td></tr></tbody></table></figure>
<p><br></p>
<h2 id="整体知识树"><a href="#整体知识树" class="headerlink" title="整体知识树"></a>整体知识树</h2><p><strong>至此，相信你已经对 Spark 这个生态圈有了大致了解了，下面就是一步一步地 在 实践 和 深入学习中，体验大数据的乐趣啦 O(∩_∩)O~~</strong></p>
<p><img data-src="/picture/spark/spark_ecosystem.png" alt="Spark EcoSystem"></p>
<center>（利用 <a href="https://www.xmind.net/" target="_blank">XMind</a>™ 绘制而成）</center>



<h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><h3 id="Blog"><a href="#Blog" class="headerlink" title="Blog"></a>Blog</h3><ul>
<li><a href="https://github.com/summerDG/spark-code-analysis">Spark 源码分析</a></li>
<li><a href="https://blog.csdn.net/oopsoom/article/details/38257749">Spark SQL 源码分析系列文章</a></li>
<li><a href="https://databricks.com/blog/2015/04/13/deep-dive-into-spark-sqls-catalyst-optimizer.html">Deep Dive into Spark SQL’s Catalyst Optimizer</a></li>
<li><a href="http://hbasefly.com/2017/04/10/bigdata-join-2/">SparkSQL – 从 0 到 1 认识 Catalyst</a></li>
</ul>
<h3 id="Book"><a href="#Book" class="headerlink" title="Book"></a>Book</h3><ul>
<li><a href="https://www.amazon.com/PySpark-Recipes-Problem-Solution-Approach-PySpark2/dp/1484231406">PySpark Recipes</a></li>
<li><a href="https://www.amazon.com/Advanced-Analytics-Spark-Patterns-Learning/dp/1491972955">Advanced Analytics with Spark</a></li>
<li><a href="https://www.amazon.com/High-Performance-Spark-Practices-Optimizing/dp/1491943203">High Performance Spark</a></li>
<li><a href="https://www.amazon.com/Fast-Data-Processing-Spark-Third/dp/1785889273">Fast Data Processing with Spark 2, 3rd Edition</a></li>
<li><a href="https://www.amazon.com/Apache-Spark-Beginners-Rajanarayanan-Thottuvaikkatumana/dp/1785885006">Apache Spark 2 for Beginners</a></li>
<li><a href="https://www.amazon.com/Spark-Data-Science-Srinivas-Duvvuri/dp/1785885650">Spark for Data Science</a></li>
<li><a href="https://www.amazon.com/Spark-GraphX-Action-Michael-Malak/dp/1617292524">Spark GraphX in Action</a></li>
<li><a href="https://www.amazon.com/Pro-Spark-Streaming-Real-Time-Analytics/dp/1484214803">Pro Spark Streaming</a></li>
<li><a href="https://www.amazon.com/Machine-Learning-Spark-Rajdeep-Dua/dp/1785889931">Machine Learning with Spark, 2nd Edition</a></li>
<li><a href="https://www.amazon.com/Apache-Spark-2-x-Cookbook-Cloud-ready/dp/1787127265">Apache Spark 2.x Cookbook</a></li>
<li><a href="https://www.amazon.com/Learning-Spark-Lightning-Fast-Data-Analysis/dp/1449358624">Learning Spark</a></li>
<li><a href="https://www.amazon.com/Big-Data-Analytics-Spark-Practitioners/dp/1484209656">Big Data Analytics with Spark</a></li>
<li><a href="https://www.amazon.com/Spark-Python-Developers-Amit-Nandi/dp/1784399698">Spark for Python Developers</a></li>
<li><a href="https://www.amazon.com/Mastering-Apache-Spark-2-x-DeepLearning4j/dp/1786462745">Mastering Apache Spark 2.x, 2nd Edition</a></li>
<li><a href="https://www.amazon.com/Apache-Spark-Processing-Rindra-Ramamonjison/dp/1784391808">Apache Spark Graph Processing</a></li>
</ul>
<h3 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h3><ul>
<li><a href="https://github.com/zhuyiche/awesome-anomaly-detection">Awesome Anomaly Detection</a></li>
</ul>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt=""></a></td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>大数据</category>
      </categories>
      <tags>
        <tag>Scala</tag>
        <tag>机器学习</tag>
        <tag>Apache Spark</tag>
      </tags>
  </entry>
  <entry>
    <title>Redis 实战</title>
    <url>/posts/2129/</url>
    <content><![CDATA[<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><h3 id="基础环境"><a href="#基础环境" class="headerlink" title="基础环境"></a>基础环境</h3><h4 id="用户"><a href="#用户" class="headerlink" title="用户"></a>用户</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 增加用户，并赋予其密码</span></span><br><span class="line">$ adduser redis</span><br><span class="line">$ passwd redis            <span class="comment"># ur password for redis user</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 赋予用户可以 sudo 的权限</span></span><br><span class="line">$ chmod u+w /etc/sudoers</span><br><span class="line">$ vim /etc/sudoers</span><br><span class="line">  <span class="comment"># 找到 `root ALL=(ALL) ALL` 这行，并在下面添加 redis 用户</span></span><br><span class="line">  redis    ALL=(ALL)    ALL</span><br><span class="line">$ chmod u-w /etc/sudoers</span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换到 redis 用户</span></span><br><span class="line">$ su - redis</span><br></pre></td></tr></tbody></table></figure>
<h4 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/redis</span><br><span class="line"></span><br><span class="line"><span class="comment"># 存放软件目录 &amp; 安装目录 &amp; 日志目录 &amp; 持久化数据存放目录</span></span><br><span class="line">$ mkdir install &amp;&amp; mkdir software &amp;&amp; mkdir logs &amp;&amp; mkdir data</span><br></pre></td></tr></tbody></table></figure>
<a id="more"></a>
<h3 id="分布式集群"><a href="#分布式集群" class="headerlink" title="分布式集群"></a>分布式集群</h3><h4 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/install</span><br><span class="line">$ wget http://download.redis.io/releases/redis-3.2.9.tar.gz</span><br></pre></td></tr></tbody></table></figure>
<h4 id="解压分发"><a href="#解压分发" class="headerlink" title="解压分发"></a>解压分发</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ tar zxvf redis-3.2.9.tar.gz -C ~/software</span><br><span class="line">$ <span class="built_in">cd</span> ~/software/</span><br><span class="line">$ scp -r redis-3.2.9/ redis@yuzhouwan02:/home/redis/software/</span><br><span class="line">$ scp -r redis-3.2.9/ redis@yuzhouwan03:/home/redis/software/</span><br><span class="line">$ ln -s redis-3.2.9/ redis</span><br></pre></td></tr></tbody></table></figure>
<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/software/redis</span><br><span class="line">$ make -j8</span><br><span class="line">  <span class="comment"># 输出如下信息，表示 make 成功</span></span><br><span class="line">  Hint: It<span class="string">'s a good idea to run '</span>make <span class="built_in">test</span><span class="string">' ;)</span></span><br><span class="line"><span class="string">  make[1]: Leaving directory `/home/redis/software/redis-3.2.9/src'</span></span><br><span class="line"></span><br><span class="line">$ vim ~/.bash_profile</span><br><span class="line">  REDIS_HOME=~/software/redis</span><br><span class="line">  PATH=<span class="variable">$PATH</span>:<span class="variable">$HOME</span>/bin:<span class="variable">$REDIS_HOME</span>/src</span><br><span class="line">$ <span class="built_in">source</span> ~/.bash_profile</span><br></pre></td></tr></tbody></table></figure>
<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ mv redis.conf redis.conf.bak</span><br><span class="line">$ vim redis.conf</span><br><span class="line">  <span class="built_in">bind</span> 0.0.0.0</span><br><span class="line">  port 6379</span><br><span class="line">  <span class="comment"># 启动 Redis 服务时，存储进程 pid 的位置</span></span><br><span class="line">  pidfile /home/redis/software/redis/redis.pid</span><br><span class="line">  logfile <span class="string">"/home/redis/logs/redis.log"</span></span><br><span class="line">  <span class="comment"># 持久化文件存储目录</span></span><br><span class="line">  dir /home/redis/data</span><br><span class="line">  <span class="comment"># 开启集群模式</span></span><br><span class="line">  cluster-enabled yes</span><br><span class="line">  <span class="comment"># 集群模式下的节点配置信息</span></span><br><span class="line">  cluster-config-file nodes.conf</span><br><span class="line">  <span class="comment"># 集群中各节点间连接超时时间</span></span><br><span class="line">  cluster-node-timeout 5000</span><br><span class="line">  <span class="comment"># 允许数据持久化追加</span></span><br><span class="line">  appendonly yes</span><br><span class="line"></span><br><span class="line">$ scp -r ~/software/redis/redis.conf redis@yuzhouwan02:/home/redis/software/redis/</span><br><span class="line">$ scp -r ~/software/redis/redis.conf redis@yuzhouwan03:/home/redis/software/redis/</span><br></pre></td></tr></tbody></table></figure>
<h4 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ nohup redis-server redis.conf 1&gt;/dev/null 2&gt;&amp;1 &amp;</span><br><span class="line">$ ps -ef | grep redis</span><br><span class="line">  redis    12781  9204  0 10:15 pts/0    00:00:00 redis-server 127.0.0.1:6379 [cluster]</span><br><span class="line"></span><br><span class="line">$ redis-cli -c -p 6379</span><br><span class="line">  127.0.0.1:6379&gt; cluster info</span><br><span class="line">  cluster_state:fail</span><br><span class="line">  cluster_slots_assigned:0</span><br><span class="line">  cluster_slots_ok:0</span><br><span class="line">  cluster_slots_pfail:0</span><br><span class="line">  cluster_slots_fail:0</span><br><span class="line">  cluster_known_nodes:1</span><br><span class="line">  cluster_size:0</span><br><span class="line">  cluster_current_epoch:0</span><br><span class="line">  cluster_my_epoch:0</span><br><span class="line">  cluster_stats_messages_sent:0</span><br><span class="line">  cluster_stats_messages_received:0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 因为 redis 集群至少需要 6 个节点，所以如果只想部署在 3 台机器上的话，可以考虑在每一台上，启动两个 redis 进程，对应端口、日志路径、存储目录，则需要依次更改</span></span><br><span class="line">$ <span class="built_in">cd</span> ~/software &amp;&amp; mkdir redis2 &amp;&amp; cp redis/redis.conf redis2/</span><br><span class="line">$ mkdir /home/redis/data2</span><br><span class="line">$ vim redis2/redis.conf</span><br><span class="line">  <span class="built_in">bind</span> 0.0.0.0</span><br><span class="line">  port 6380</span><br><span class="line">  <span class="comment"># 启动 Redis 服务时，存储进程 pid 的位置</span></span><br><span class="line">  pidfile /home/redis/software/redis2/redis.pid</span><br><span class="line">  logfile <span class="string">"/home/redis/logs/redis2.log"</span></span><br><span class="line">  <span class="comment"># 持久化文件存储目录</span></span><br><span class="line">  dir /home/redis/data2</span><br><span class="line">  <span class="comment"># 开启集群模式</span></span><br><span class="line">  cluster-enabled yes</span><br><span class="line">  <span class="comment"># 集群模式下的节点配置信息</span></span><br><span class="line">  cluster-config-file nodes2.conf</span><br><span class="line">  <span class="comment"># 集群中各节点间连接超时时间</span></span><br><span class="line">  cluster-node-timeout 5000</span><br><span class="line">  <span class="comment"># 允许数据持久化追加</span></span><br><span class="line">  appendonly yes</span><br><span class="line"></span><br><span class="line">$ scp -r ~/software/redis2/redis.conf redis@yuzhouwan02:/home/redis/software/redis2/</span><br><span class="line">$ scp -r ~/software/redis2/redis.conf redis@yuzhouwan03:/home/redis/software/redis2/</span><br><span class="line"></span><br><span class="line">$ nohup redis-server redis2/redis.conf 1&gt;/dev/null 2&gt;&amp;1 &amp;</span><br><span class="line"><span class="comment"># 如果启动不了，但是没有任何日志，需检查 redis2/redis.conf 是否和 redis/redis.conf 有路径、端口的冲突</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="集群配置"><a href="#集群配置" class="headerlink" title="集群配置"></a>集群配置</h4><h5 id="安装-Ruby"><a href="#安装-Ruby" class="headerlink" title="安装 Ruby"></a>安装 Ruby</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Debian / Ubuntu</span></span><br><span class="line">$ apt-get install ruby</span><br><span class="line"></span><br><span class="line"><span class="comment"># CentOS / Fedora / RHEL</span></span><br><span class="line">$ sudo yum install ruby</span><br><span class="line"></span><br><span class="line"><span class="comment"># Offline</span></span><br><span class="line"><span class="comment"># 下载 https://www.ruby-lang.org/en/downloads/</span></span><br><span class="line">$ <span class="built_in">cd</span> ~/install</span><br><span class="line">$ wget https://cache.ruby-lang.org/pub/ruby/2.4/ruby-2.4.1.tar.gz</span><br><span class="line">$ tar zxvf ruby-2.4.1.tar.gz -C ~/software</span><br><span class="line">$ <span class="built_in">cd</span> ~/software/ruby-2.4.1 &amp;&amp; mkdir ../ruby</span><br><span class="line">$ ./configure prefix=/home/redis/software/ruby</span><br><span class="line">$ make -j8 &amp;&amp; make -j8 install</span><br><span class="line"></span><br><span class="line">$ vim ~/.bash_profile</span><br><span class="line">  REDIS_HOME=~/software/redis</span><br><span class="line">  RUBY_HOME=~/software/ruby</span><br><span class="line">  PATH=<span class="variable">$PATH</span>:<span class="variable">$HOME</span>/bin:<span class="variable">$REDIS_HOME</span>/src:<span class="variable">$RUBY_HOME</span>/bin</span><br><span class="line">$ <span class="built_in">source</span> ~/.bash_profile</span><br><span class="line"></span><br><span class="line">$ ruby -v</span><br><span class="line">  ruby 2.4.1p111 (2017-03-22 revision 58053) [x86_64-linux]</span><br></pre></td></tr></tbody></table></figure>
<h5 id="安装-Redis-插件"><a href="#安装-Redis-插件" class="headerlink" title="安装 Redis 插件"></a>安装 Redis 插件</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Online</span></span><br><span class="line">$ gem update --system</span><br><span class="line">$ gem install redis</span><br><span class="line"><span class="comment"># 如果下载速度过慢，可考虑使用国内的 ruby 源</span></span><br><span class="line">$ gem sources remove http://rubygems.org/</span><br><span class="line">$ gem sources -a https://ruby.taobao.org/</span><br><span class="line"></span><br><span class="line"><span class="comment"># Offline</span></span><br><span class="line">$ <span class="built_in">cd</span> ~/install</span><br><span class="line">$ wget https://rubygems.org/downloads/redis-3.2.2.gem</span><br></pre></td></tr></tbody></table></figure>
<h5 id="redis-trib-创建分布式集群"><a href="#redis-trib-创建分布式集群" class="headerlink" title="redis-trib 创建分布式集群"></a>redis-trib 创建分布式集群</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ redis-trib.rb create --replicas 1 192.168.1.101:6379 192.168.1.102:6379 192.168.1.103:6379 192.168.1.101:6380 192.168.1.102:6380 192.168.1.103:6380</span><br><span class="line">  &gt;&gt;&gt; Creating cluster</span><br><span class="line">  &gt;&gt;&gt; Performing <span class="built_in">hash</span> slots allocation on 6 nodes...</span><br><span class="line">  Using 3 masters:</span><br><span class="line">  192.168.1.101:6379</span><br><span class="line">  192.168.1.102:6379</span><br><span class="line">  192.168.1.103:6379</span><br><span class="line">  Adding replica 192.168.1.102:6380 to 192.168.1.101:6379</span><br><span class="line">  Adding replica 192.168.1.101:6380 to 192.168.1.102:6379</span><br><span class="line">  Adding replica 192.168.1.103:6380 to 192.168.1.103:6379</span><br><span class="line">  M: 4c0fb081525a5f1893479225576b75f03cca065d 192.168.1.101:6379</span><br><span class="line">     slots:0-5460 (5461 slots) master</span><br><span class="line">  M: 4f9fc4536f6e4e30666264738d632b1bb54799f0 192.168.1.102:6379</span><br><span class="line">     slots:5461-10922 (5462 slots) master</span><br><span class="line">  M: 4dde95537b69d2b23f2f9a4cd2a357a1e4af756e 192.168.1.103:6379</span><br><span class="line">     slots:10923-16383 (5461 slots) master</span><br><span class="line">  S: 6ffea478b1e5d1187b85adc5b0bd11b6601dd556 192.168.1.101:6380</span><br><span class="line">     replicates 4f9fc4536f6e4e30666264738d632b1bb54799f0</span><br><span class="line">  S: 1213855d2c0d1b35020895af45dcd734da50ef2c 192.168.1.102:6380</span><br><span class="line">     replicates 4c0fb081525a5f1893479225576b75f03cca065d</span><br><span class="line">  S: 94478f8642d5a0cef1a989a620f132221e35fc8a 192.168.1.103:6380</span><br><span class="line">     replicates 4dde95537b69d2b23f2f9a4cd2a357a1e4af756e</span><br><span class="line">  Can I <span class="built_in">set</span> the above configuration? (<span class="built_in">type</span> <span class="string">'yes'</span> to accept): yes</span><br><span class="line">  &gt;&gt;&gt; Nodes configuration updated</span><br><span class="line">  &gt;&gt;&gt; Assign a different config epoch to each node</span><br><span class="line">  &gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster</span><br><span class="line">  Waiting <span class="keyword">for</span> the cluster to join...</span><br><span class="line">  &gt;&gt;&gt; Performing Cluster Check (using node 192.168.1.101:6379)</span><br><span class="line">  M: 4c0fb081525a5f1893479225576b75f03cca065d 192.168.1.101:6379</span><br><span class="line">     slots:0-5460 (5461 slots) master</span><br><span class="line">     1 additional replica(s)</span><br><span class="line">  S: 6ffea478b1e5d1187b85adc5b0bd11b6601dd556 192.168.1.101:6380</span><br><span class="line">     slots: (0 slots) slave</span><br><span class="line">     replicates 4f9fc4536f6e4e30666264738d632b1bb54799f0</span><br><span class="line">  M: 4dde95537b69d2b23f2f9a4cd2a357a1e4af756e 192.168.1.103:6379</span><br><span class="line">     slots:10923-16383 (5461 slots) master</span><br><span class="line">     1 additional replica(s)</span><br><span class="line">  S: 1213855d2c0d1b35020895af45dcd734da50ef2c 192.168.1.102:6380</span><br><span class="line">     slots: (0 slots) slave</span><br><span class="line">     replicates 4c0fb081525a5f1893479225576b75f03cca065d</span><br><span class="line">  S: 94478f8642d5a0cef1a989a620f132221e35fc8a 192.168.1.103:6380</span><br><span class="line">     slots: (0 slots) slave</span><br><span class="line">     replicates 4dde95537b69d2b23f2f9a4cd2a357a1e4af756e</span><br><span class="line">  M: 4f9fc4536f6e4e30666264738d632b1bb54799f0 192.168.1.102:6379</span><br><span class="line">     slots:5461-10922 (5462 slots) master</span><br><span class="line">     1 additional replica(s)</span><br><span class="line">  [OK] All nodes agree about slots configuration.</span><br><span class="line">  &gt;&gt;&gt; Check <span class="keyword">for</span> open slots...</span><br><span class="line">  &gt;&gt;&gt; Check slots coverage...</span><br><span class="line">  [OK] All 16384 slots covered.</span><br></pre></td></tr></tbody></table></figure>
<h5 id="redis-cli-集群状态检查"><a href="#redis-cli-集群状态检查" class="headerlink" title="redis-cli 集群状态检查"></a>redis-cli 集群状态检查</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 至此，大功告成~</span></span><br><span class="line">$ redis-cli -c -p 6379</span><br><span class="line">  127.0.0.1:6379&gt; cluster info</span><br><span class="line">  cluster_state:ok</span><br><span class="line">  cluster_slots_assigned:16384</span><br><span class="line">  cluster_slots_ok:16384</span><br><span class="line">  cluster_slots_pfail:0</span><br><span class="line">  cluster_slots_fail:0</span><br><span class="line">  cluster_known_nodes:6</span><br><span class="line">  cluster_size:3</span><br><span class="line">  cluster_current_epoch:6</span><br><span class="line">  cluster_my_epoch:1</span><br><span class="line">  cluster_stats_messages_sent:376</span><br><span class="line">  cluster_stats_messages_received:376</span><br></pre></td></tr></tbody></table></figure>
<h4 id="关闭"><a href="#关闭" class="headerlink" title="关闭"></a>关闭</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ pkill redis</span><br></pre></td></tr></tbody></table></figure>
<h3 id="遇到的坑"><a href="#遇到的坑" class="headerlink" title="遇到的坑"></a>遇到的坑</h3><h4 id="cannot-load-such-file-—-zlib"><a href="#cannot-load-such-file-—-zlib" class="headerlink" title="cannot load such file — zlib"></a>cannot load such file — zlib</h4><h5 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gem install -l redis-3.2.2.gem</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果出现如下报错，则应该先安装 zlib-devel</span></span><br><span class="line">  ERROR:  Loading <span class="built_in">command</span>: install (LoadError)</span><br><span class="line">      cannot load such file -- zlib</span><br><span class="line">  ERROR:  While executing gem ... (NoMethodError)</span><br><span class="line">      undefined method `invoke_with_build_args<span class="string">' for nil:NilClass</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ yum install zlib-devel</span><br><span class="line"><span class="comment"># 离线环境下，推荐先在有网环境中，使用 --downloadonly 的方式，把依赖包直接下载下来（也可在 https://www.rpmfind.net 里面找，但比较低效）</span></span><br><span class="line">$ yum reinstall --downloadonly --downloaddir=/opt/software/zlib zlib-devel zlib libc.so.6 glibc-common glibc libfreebl3.so zlib-1.2.3-27.el6 -y</span><br><span class="line">$ ll /opt/software/zlib</span><br><span class="line">  -rw-r--r-- 1 root root  4558520 Feb 18  2016 glibc-2.12-1.166.el6_7.7.i686.rpm</span><br><span class="line">  -rw-r--r-- 1 root root 14887196 Feb 18  2016 glibc-common-2.12-1.166.el6_7.7.x86_64.rpm</span><br><span class="line">  -rw-r--r-- 1 root root   118976 Nov  9  2011 nss-softokn-freebl-3.12.9-11.el6.i686.rpm</span><br><span class="line">  -rw-r--r-- 1 root root    73604 Sep 26  2011 zlib-1.2.3-27.el6.i686.rpm</span><br><span class="line">  -rw-r--r-- 1 root root    73864 Sep 26  2011 zlib-1.2.3-27.el6.x86_64.rpm</span><br><span class="line">  -rw-r--r-- 1 root root    44728 Sep 26  2011 zlib-devel-1.2.3-27.el6.x86_64.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可能存在 "循环依赖" 和 "依赖冲突"</span></span><br><span class="line"><span class="comment"># 前者，可以通过 force 强制安装好，其中一个</span></span><br><span class="line">$ rpm -ivh glibc-2.12-1.166.el6_7.7.i686 --nodeps --force</span><br><span class="line"><span class="comment"># 后者，可以通过 nodeps 不删除被依赖包，进行卸载</span></span><br><span class="line"><span class="comment"># 【注意】/lib64/libz* 需要提前备份好，否则卸载掉 zlib 之后，会因为缺少 libz.so.1，导致 yum/rpm/ssh 等命令均失效！</span></span><br><span class="line">$ rpm -e --nodeps zlib-1.2.3-29.el6.x86_64</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装完成之后，将 Ruby 重新编译安装一遍，即可</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="ERR-Slot-0-is-already-busy"><a href="#ERR-Slot-0-is-already-busy" class="headerlink" title="ERR Slot 0 is already busy"></a>ERR Slot 0 is already busy</h4><h5 id="描述-1"><a href="#描述-1" class="headerlink" title="描述"></a>描述</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 执行 redis-trib.rb 遇到</span></span><br><span class="line">ERR Slot 0 is already busy (Redis::CommandError)</span><br></pre></td></tr></tbody></table></figure>
<h5 id="解决-1"><a href="#解决-1" class="headerlink" title="解决"></a>解决</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 通过 cluster reset soft 命令解决</span></span><br><span class="line">$ redis-cli -h 127.0.0.1 -p 6379 cluster reset soft &amp;&amp; redis-cli -h 127.0.0.1 -p 6380 cluster reset soft</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">OK</span><br><span class="line">OK</span><br></pre></td></tr></tbody></table></figure>
<h4 id="ERR-Invalid-node-address-specified"><a href="#ERR-Invalid-node-address-specified" class="headerlink" title="ERR Invalid node address specified"></a>ERR Invalid node address specified</h4><h5 id="描述-2"><a href="#描述-2" class="headerlink" title="描述"></a>描述</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 执行创建 Redis 集群</span></span><br><span class="line">$ redis-trib.rb create --replicas 1 yuzhouwan01:6379 yuzhouwan02:6379 yuzhouwan03:6379 yuzhouwan01:6380 yuzhouwan02:6380 yuzhouwan03:6380</span><br><span class="line"><span class="comment"># 报错 ERR Invalid node address specified</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="解决-2"><a href="#解决-2" class="headerlink" title="解决"></a>解决</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 目前为止，只支持 IP，不支持 Hostname，因此将主机名替换为 IP 即可（PR#2323 中准备解决该问题）</span></span><br><span class="line">$ redis-trib.rb create --replicas 1 192.168.1.101:6379 192.168.1.102:6379 192.168.1.103:6379 192.168.1.101:6380 192.168.1.102:6380 192.168.1.103:6380</span><br></pre></td></tr></tbody></table></figure>
<h2 id="Jedis-客户端"><a href="#Jedis-客户端" class="headerlink" title="Jedis 客户端"></a><a href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-bigdata/yuzhouwan-bigdata-redis/src/main/java/com/yuzhouwan/bigdata/redis/conn/RedisClusterConnPool.java">Jedis 客户端</a></h2><h3 id="连接集群"><a href="#连接集群" class="headerlink" title="连接集群"></a>连接集群</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(DynamicPropUtils DP)</span> </span>{</span><br><span class="line">    Object clusterListObj = DP.get(PROJECT_NAME, <span class="string">"redis.cluster.list"</span>);</span><br><span class="line">    String clusterList;</span><br><span class="line">    <span class="keyword">if</span> (clusterListObj == <span class="keyword">null</span> || StrUtils.isEmpty(clusterList = clusterListObj.toString())) {</span><br><span class="line">        String error = String.format(<span class="string">"Cannot get [%s-redis.cluster.list] from Dynamic PropUtils!"</span>, PROJECT_NAME);</span><br><span class="line">        _log.error(error);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(error);</span><br><span class="line">    }</span><br><span class="line">    String[] hostAndPort;</span><br><span class="line">    Set&lt;HostAndPort&gt; jedisClusterNodes = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (String clusters : clusterList.split(<span class="string">","</span>)) {</span><br><span class="line">        hostAndPort = clusters.split(<span class="string">":"</span>);</span><br><span class="line">        jedisClusterNodes.add(<span class="keyword">new</span> HostAndPort(hostAndPort[<span class="number">0</span>], Integer.valueOf(hostAndPort[<span class="number">1</span>])));</span><br><span class="line">    }</span><br><span class="line">    JedisPoolConfig conf = <span class="keyword">new</span> JedisPoolConfig();</span><br><span class="line">    conf.setMaxTotal(<span class="number">1000</span>);</span><br><span class="line">    conf.setMinIdle(<span class="number">50</span>);</span><br><span class="line">    conf.setMaxIdle(<span class="number">100</span>);</span><br><span class="line">    conf.setMaxWaitMillis(<span class="number">6</span> * <span class="number">1000</span>);</span><br><span class="line">    conf.setTestOnBorrow(<span class="keyword">true</span>);</span><br><span class="line">    pool = <span class="keyword">new</span> JedisCluster(jedisClusterNodes, conf);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="集群操作"><a href="#集群操作" class="headerlink" title="集群操作"></a>集群操作</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Long <span class="title">putSet</span><span class="params">(String key, String... values)</span> </span>{</span><br><span class="line">  <span class="keyword">return</span> pool.sadd(key, values);</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getSet</span><span class="params">(String key)</span> </span>{</span><br><span class="line">  <span class="keyword">return</span> pool.smembers(key);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="资源释放"><a href="#资源释放" class="headerlink" title="资源释放"></a>资源释放</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> throw IOException </span>{</span><br><span class="line">  <span class="keyword">if</span> (pool != <span class="keyword">null</span>) pool.close();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="过期事件回调"><a href="#过期事件回调" class="headerlink" title="过期事件回调"></a><a href="https://redis.io/topics/notifications">过期事件</a>回调</h3><h4 id="配置集群"><a href="#配置集群" class="headerlink" title="配置集群"></a><a href="https://raw.githubusercontent.com/antirez/redis/2.8/redis.conf">配置</a>集群</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 通过 redis-cli 进行动态配置</span></span><br><span class="line">$ redis-cli -h localhost -p 6380</span><br><span class="line">  CONFIG SET notify-keyspace-events AKE     <span class="comment"># AKE: 意味着通知所有事件</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 redis.conf，并重启集群使其生效</span></span><br><span class="line">$ vim redis.conf</span><br><span class="line">  notify-keyspace-events AKE</span><br></pre></td></tr></tbody></table></figure>
<h4 id="服务端验证"><a href="#服务端验证" class="headerlink" title="服务端验证"></a>服务端验证</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ redis-cli</span><br><span class="line">  127.0.0.1:6379&gt; <span class="built_in">set</span> yuzhouwan01 blog</span><br><span class="line">    OK</span><br><span class="line">  127.0.0.1:6379&gt; expire yuzhouwan01 3</span><br><span class="line">    (<span class="built_in">integer</span>) 1</span><br><span class="line">  127.0.0.1:6379&gt; ttl yuzhouwan01</span><br><span class="line">    (<span class="built_in">integer</span>) 0</span><br><span class="line">  127.0.0.1:6379&gt; ttl yuzhouwan01</span><br><span class="line">    (<span class="built_in">integer</span>) -2</span><br><span class="line"></span><br><span class="line">$ redis-cli -h localhost -p 6379 --csv psubscribe <span class="string">'*'</span></span><br><span class="line">  <span class="string">"pmessage"</span>,<span class="string">"*"</span>,<span class="string">"__keyspace@0__:yuzhouwan01"</span>,<span class="string">"set"</span></span><br><span class="line">  <span class="string">"pmessage"</span>,<span class="string">"*"</span>,<span class="string">"__keyevent@0__:set"</span>,<span class="string">"yuzhouwan01"</span></span><br><span class="line">  <span class="string">"pmessage"</span>,<span class="string">"*"</span>,<span class="string">"__keyspace@0__:yuzhouwan01"</span>,<span class="string">"expire"</span></span><br><span class="line">  <span class="string">"pmessage"</span>,<span class="string">"*"</span>,<span class="string">"__keyevent@0__:expire"</span>,<span class="string">"yuzhouwan01"</span></span><br><span class="line">  <span class="string">"pmessage"</span>,<span class="string">"*"</span>,<span class="string">"__keyspace@0__:yuzhouwan01"</span>,<span class="string">"expired"</span></span><br><span class="line">  <span class="string">"pmessage"</span>,<span class="string">"*"</span>,<span class="string">"__keyevent@0__:expired"</span>,<span class="string">"yuzhouwan01"</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="连接集群-1"><a href="#连接集群-1" class="headerlink" title="连接集群"></a><a href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-bigdata/yuzhouwan-bigdata-redis/src/main/java/com/yuzhouwan/bigdata/redis/conn/RedisClusterConnPool.java">连接</a>集群</h4><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getClusterList</span><span class="params">(DynamicPropUtils DP)</span> </span>{</span><br><span class="line">    Object clusterListObj = DP.get(PROJECT_NAME, <span class="string">"redis.cluster.list"</span>);</span><br><span class="line">    String clusterList;</span><br><span class="line">    <span class="keyword">if</span> (clusterListObj == <span class="keyword">null</span> || StrUtils.isEmpty(clusterList = clusterListObj.toString())) {</span><br><span class="line">        String error = String.format(<span class="string">"Cannot get [%s-redis.cluster.list] from Dynamic PropUtils!"</span>, PROJECT_NAME);</span><br><span class="line">        _log.error(error);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(error);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> clusterList;</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">private</span> JedisPoolConfig <span class="title">buildConf</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// org.apache.commons.pool2.impl.BaseObjectPoolConfig</span></span><br><span class="line">    JedisPoolConfig conf = <span class="keyword">new</span> JedisPoolConfig();</span><br><span class="line">    conf.setMaxTotal(<span class="number">1000</span>);</span><br><span class="line">    conf.setMinIdle(<span class="number">50</span>);</span><br><span class="line">    conf.setMaxIdle(<span class="number">100</span>);</span><br><span class="line">    <span class="comment">// conf.setMaxWaitMillis(6 * 1000);</span></span><br><span class="line">    conf.setTestOnCreate(<span class="keyword">true</span>);</span><br><span class="line">    conf.setTestOnBorrow(<span class="keyword">true</span>);</span><br><span class="line">    conf.setTestOnReturn(<span class="keyword">true</span>);</span><br><span class="line">    conf.setTestWhileIdle(<span class="keyword">true</span>);</span><br><span class="line">    <span class="comment">// conf.setTimeBetweenEvictionRunsMillis(1);</span></span><br><span class="line">    conf.setNumTestsPerEvictionRun(<span class="number">30</span>);</span><br><span class="line">    <span class="keyword">return</span> conf;</span><br><span class="line">}</span><br><span class="line"><span class="comment">// 这里不要使用 JedisCluster，因为 cluster 模式下，jedis 只会连接一个节点，会导致监听不到其他节点上的事件</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initPools</span><span class="params">(DynamicPropUtils DP)</span> </span>{</span><br><span class="line">    String clusterList = getClusterList(DP);</span><br><span class="line">    pools = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">    String[] hostAndPort;</span><br><span class="line">    <span class="keyword">for</span> (String clusters : clusterList.split(<span class="string">","</span>)) {</span><br><span class="line">        hostAndPort = clusters.split(<span class="string">":"</span>);</span><br><span class="line">        pools.add(<span class="keyword">new</span> JedisPool(buildConf(), hostAndPort[<span class="number">0</span>], Integer.valueOf(hostAndPort[<span class="number">1</span>])));</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="回调监听器"><a href="#回调监听器" class="headerlink" title="回调监听器"></a>回调<a href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-bigdata/yuzhouwan-bigdata-redis/src/main/java/com/yuzhouwan/bigdata/redis/notification/RedisNotification.java">监听器</a></h4><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">try</span> (RedisClusterConnPool pool = <span class="keyword">new</span> RedisClusterConnPool(dp, <span class="keyword">true</span>)) {</span><br><span class="line">    List&lt;JedisPool&gt; jedis = pool.getPools();</span><br><span class="line">    JedisPubSub jedisPubSub = <span class="keyword">new</span> JedisPubSub() {</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPSubscribe</span><span class="params">(String pattern, <span class="keyword">int</span> subscribedChannels)</span> </span>{</span><br><span class="line">            _log.info(<span class="string">"onPSubscribe {} {}"</span>, pattern, subscribedChannels);</span><br><span class="line">        }</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPMessage</span><span class="params">(String pattern, String channel, String message)</span> </span>{</span><br><span class="line">            _log.info(<span class="string">"onPMessage: {}, Channel: {}, Message: {}"</span>, pattern, channel, message);</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line">    <span class="keyword">for</span> (JedisPool j : jedis)</span><br><span class="line">        j.getResource().psubscribe(jedisPubSub, <span class="string">"__keyevent@*__:expired"</span> <span class="comment">/*"__key*__:*"*/</span> <span class="comment">/*"*"*/</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a><a href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-bigdata/yuzhouwan-bigdata-redis/src/test/java/com/yuzhouwan/bigdata/redis/notification/RedisNotificationTest.java#L22">测试</a></h4><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">pool.put(<span class="string">"yuzhouwan01"</span>, <span class="string">"blog01"</span>);</span><br><span class="line">pool.expire(<span class="string">"yuzhouwan01"</span>, <span class="number">2</span>);</span><br><span class="line">Thread.sleep(<span class="number">2100</span>);</span><br><span class="line">assertEquals(<span class="keyword">null</span>, pool.get(<span class="string">"yuzhouwan01"</span>));</span><br><span class="line"></span><br><span class="line"><span class="number">2017</span>-<span class="number">07</span>-<span class="number">26</span> <span class="number">16</span>:<span class="number">18</span>:<span class="number">56.045</span> | INFO | onPMessage Pattern: *, Channel: __keyevent@<span class="number">0</span>__:set, Message: yuzhouwan01 | com.yuzhouwan.bigdata.redis.notification.RedisNotification.onPMessage | RedisNotification.java:<span class="number">61</span> </span><br><span class="line"><span class="number">2017</span>-<span class="number">07</span>-<span class="number">26</span> <span class="number">16</span>:<span class="number">18</span>:<span class="number">56.045</span> | INFO | onPMessage Pattern: *, Channel: __keyevent@<span class="number">0</span>__:expire, Message: yuzhouwan01 | com.yuzhouwan.bigdata.redis.notification.RedisNotification.onPMessage | RedisNotification.java:<span class="number">61</span> </span><br><span class="line"><span class="number">2017</span>-<span class="number">07</span>-<span class="number">26</span> <span class="number">16</span>:<span class="number">18</span>:<span class="number">57.064</span> | INFO | onPMessage Pattern: *, Channel: __keyevent@<span class="number">0</span>__:expired, Message: yuzhouwan01 | com.yuzhouwan.bigdata.redis.notification.RedisNotification.onPMessage | RedisNotification.java:<span class="number">61</span> </span><br></pre></td></tr></tbody></table></figure>
<h2 id="实战技巧"><a href="#实战技巧" class="headerlink" title="实战技巧"></a>实战技巧</h2><h3 id="匹配删除"><a href="#匹配删除" class="headerlink" title="匹配删除"></a>匹配删除</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ redis-cli flushdb</span><br><span class="line">$ redis-cli --raw -n 1 keys <span class="string">"yuzhouwan*"</span> | xargs -L1 -I{} redis-cli move {} 0</span><br><span class="line">$ redis-cli</span><br><span class="line">  127.0.0.1:6379&gt; keys yuzhouwan*</span><br><span class="line">  (empty list or <span class="built_in">set</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以安装使用 redis-utils-cli（https://www.npmjs.com/package/redis-utils-cli）</span></span><br><span class="line">$ redis-utils del 127.0.0.1 yuzhouwan*</span><br></pre></td></tr></tbody></table></figure>
<h3 id="数据容灾"><a href="#数据容灾" class="headerlink" title="数据容灾"></a>数据容灾</h3><p>　主从热备 + 二级缓存 + 从库 AOF（主从切换）</p>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><ul>
<li><a href="https://segmentfault.com/a/1190000002906345">Redis 持久化</a></li>
<li><a href="http://www.cnblogs.com/chenmh/p/5578376.html">Redis 哨兵模式实现主从故障互切换</a></li>
<li>《Redis in Action》 第 4 章</li>
</ul>
<h3 id="全局流控"><a href="#全局流控" class="headerlink" title="全局流控"></a>全局流控</h3><h4 id="流控方案"><a href="#流控方案" class="headerlink" title="流控方案"></a>流控方案</h4><h5 id="Leaky-bucket-漏桶算法"><a href="#Leaky-bucket-漏桶算法" class="headerlink" title="Leaky bucket 漏桶算法"></a>Leaky bucket 漏桶算法</h5><p>　桶内水溢出时，可以把消息放到队列中等待</p>
<h5 id="Token-bucket-令牌桶算法"><a href="#Token-bucket-令牌桶算法" class="headerlink" title="Token bucket 令牌桶算法"></a>Token bucket 令牌桶算法</h5><p>　桶内令牌不足时，可以把消息放到队列中等待</p>
<h4 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式"></a>实现方式</h4><h5 id="Guava-RateLimiter"><a href="#Guava-RateLimiter" class="headerlink" title="Guava RateLimiter"></a>Guava RateLimiter</h5><p>　Guava 无法做到全局流控</p>
<h5 id="Redis-Expire-机制"><a href="#Redis-Expire-机制" class="headerlink" title="Redis Expire 机制"></a>Redis Expire 机制</h5><p>　如果设置的超时时间过长，可能对内存有一定的损耗</p>
<h5 id="Hystrix-限流"><a href="#Hystrix-限流" class="headerlink" title="Hystrix 限流"></a>Hystrix 限流</h5><p>　支持 自动降级、熔断与恢复、依赖隔离、异常记录、流量控制、实时监控，不过会存在一定的 代码侵入 和 性能损耗 的问题（1%~5%）</p>
<p><img data-src="/picture/redis/redis_hystrix_hystrix_dashboard.png" alt="Hystrix"></p>
<center>（图片来源：<a href="https://github.com/Netflix/Hystrix/wiki" target="_blank">Hystrix</a>™ 官网）</center>

<h4 id="参考-1"><a href="#参考-1" class="headerlink" title="参考"></a>参考</h4><ul>
<li>单机版<ul>
<li><a href="https://www.cnblogs.com/moonandstar08/p/5440555.html">高并发场景下的流控管理</a></li>
<li><a href="http://ifeve.com/guava-ratelimiter/">Guava 官方文档 - RateLimiter 类</a></li>
</ul>
</li>
<li>分布式<ul>
<li><a href="https://www.zybuluo.com/kay2/note/949160">基于 Redis 的限流系统的设计</a></li>
<li><a href="https://redis.io/commands/INCR#pattern-rate-limiter">Redis Doc: Pattern: Rate limiter</a></li>
<li><a href="https://github.com/nereuschen/blog/issues/37">限流技术 #37</a></li>
</ul>
</li>
<li>Hystrix<ul>
<li><a href="https://github.com/Netflix/Hystrix">Hystrix: Latency and Fault Tolerance for Distributed Systems</a></li>
<li><a href="http://www.jianshu.com/p/d72b96a7ca31">Hystrix 入门研究</a></li>
<li><a href="http://www.iocoder.cn/categories/Hystrix/">Hystrix 源码解析</a></li>
</ul>
</li>
<li>理论基础<ul>
<li><a href="https://en.wikipedia.org/wiki/Little's_law">排队理论</a></li>
<li><a href="https://en.wikipedia.org/wiki/Leaky_bucket">Leaky bucket 漏桶算法</a></li>
<li><a href="https://en.wikipedia.org/wiki/Token_bucket">Token bucket 令牌桶算法</a></li>
</ul>
</li>
</ul>
<p>Tips: Full code is <a href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-bigdata/yuzhouwan-bigdata-redis/src/test/java/com/yuzhouwan/bigdata/redis/rate/limit/GuavaRateLimiterTest.java">here</a>.</p>
<h2 id="技术内幕"><a href="#技术内幕" class="headerlink" title="技术内幕"></a>技术内幕</h2><h3 id="缓存穿透-vs-缓存雪崩-vs-缓存失效"><a href="#缓存穿透-vs-缓存雪崩-vs-缓存失效" class="headerlink" title="缓存穿透 vs 缓存雪崩 vs 缓存失效"></a>缓存穿透 vs 缓存雪崩 vs 缓存失效</h3><h4 id="缓存穿透"><a href="#缓存穿透" class="headerlink" title="缓存穿透"></a>缓存穿透</h4><h5 id="场景描述"><a href="#场景描述" class="headerlink" title="场景描述"></a>场景描述</h5><p>　一般的缓存系统，都是按照 key 去缓存查询，如果不存在对应的 value，就应该去后端系统查找（比如 DB）。如果 key 对应的 value 是一定不存在的，并且对该 key 并发请求量很大，就会对后端系统造成很大的压力，我们称之为<strong>缓存穿透</strong></p>
<h5 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h5><ul>
<li>对查询结果为空的情况也进行缓存，缓存过期时间设置短一点（避免消耗太多的缓存空间），或者该 key 对应的数据 insert 了之后清理缓存</li>
<li>对一定不存在的 key 进行过滤。可以把所有的可能存在的 key 放到一个大的 Bitmap 中，查询时通过该 Bitmap 过滤</li>
<li>排查是否是自身程序或者数据的问题，亦或是外部恶意攻击或者爬虫，导致大量访问不存在的 key 值</li>
</ul>
<h4 id="缓存雪崩"><a href="#缓存雪崩" class="headerlink" title="缓存雪崩"></a>缓存雪崩</h4><h5 id="场景描述-1"><a href="#场景描述-1" class="headerlink" title="场景描述"></a>场景描述</h5><p>　<strong>缓存雪崩</strong>，是指当缓存服务器重启或者大量缓存集中在某一个时间段失效，这样在失效的时候，也会给后端系统（比如 DB）带来很大压力</p>
<h5 id="解决方案-1"><a href="#解决方案-1" class="headerlink" title="解决方案"></a>解决方案</h5><ul>
<li>在缓存失效后，通过加锁或者队列来控制读数据库写缓存的线程数量。比如对某个 key 只允许一个线程查询数据和写缓存，其他线程等待</li>
<li>不同的 key，设置不同的过期时间，让缓存失效的时间点尽量均匀</li>
<li>做二级缓存，A1 为原始缓存，A2 为拷贝缓存。A1 失效时，可以访问 A2。A1 缓存失效时间设置为短期，A2 设置为长期</li>
<li>保证缓存层服务的高可用，后端组件做好限流措施，并提前预演缓存层失效的场景</li>
</ul>
<h4 id="缓存失效"><a href="#缓存失效" class="headerlink" title="缓存失效"></a>缓存失效</h4><h5 id="场景描述-2"><a href="#场景描述-2" class="headerlink" title="场景描述"></a>场景描述</h5><p>　<strong>缓存失效</strong>，是指缓存集中在一段时间内失效，DB 的压力凸显</p>
<h5 id="解决方案-2"><a href="#解决方案-2" class="headerlink" title="解决方案"></a>解决方案</h5><p>　这个没有完美解决办法，但可以分析用户行为，尽量让失效时间点均匀分布。大多数系统设计者考虑用加锁或者队列的方式保证缓存的单线程（进程）写，从而避免失效时大量的并发请求落到底层存储系统上</p>
<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><p>　当发生大量的<strong>缓存穿透</strong>，例如对某个失效的缓存的大并发访问就造成了<strong>缓存雪崩</strong></p>
<p>　<strong>缓存失效</strong>的同时发生<strong>雪崩效应</strong>，对底层系统的冲击将会非常大。这时候，可以使用双缓存机制，在工作缓存之外另外维护一层灾备缓存</p>
<h3 id="双缓存-vs-二级缓存"><a href="#双缓存-vs-二级缓存" class="headerlink" title="双缓存 vs 二级缓存"></a>双缓存 vs 二级缓存</h3><p>　一般的，用 Keepalived 做双机热备，而用 <a href="https://my.oschina.net/tinyframework/blog/538363">J2Cache</a> 来做二级缓存</p>
<p>Tips: Full code is <a href="https://github.com/asdf2014/yuzhouwan/tree/master/yuzhouwan-bigdata/yuzhouwan-bigdata-redis/src/main/java/com/yuzhouwan/bigdata/redis/multi/cache">here</a>.</p>
<h3 id="为什么-Redis-一致性算法使用-Raft，而不是-Paxos？"><a href="#为什么-Redis-一致性算法使用-Raft，而不是-Paxos？" class="headerlink" title="为什么 Redis 一致性算法使用 Raft，而不是 Paxos？"></a>为什么 Redis 一致性算法使用 <a href="https://yuzhouwan.com/posts/31915/#Raft">Raft</a>，而不是 <a href="https://yuzhouwan.com/posts/31915/#选主机制">Paxos</a>？</h3><p>　没有应用场景上的区别，主要是因为 Raft 算法更为<strong>简单</strong>、<strong>好懂</strong> 和 <strong>易实现</strong></p>
<h4 id="协议上的简化"><a href="#协议上的简化" class="headerlink" title="协议上的简化"></a>协议上的简化</h4><p>　最后主要 RPC 只有两个，其他协议的二阶段、三阶段也都变成 看起来像是一阶段</p>
<h4 id="Term-概念的强化"><a href="#Term-概念的强化" class="headerlink" title="Term 概念的强化"></a>Term 概念的强化</h4><p>　看起来似乎 Paxos 也有重选 Leader 的机制，但是强化概念，并增加一个 Term，包含有一个 Leader、Entry 与 Term 相关的属性等都大大简化了流程</p>
<h4 id="Log-只会从-Leader-到-Follower-单向同步"><a href="#Log-只会从-Leader-到-Follower-单向同步" class="headerlink" title="Log 只会从 Leader 到 Follower 单向同步"></a>Log 只会从 Leader 到 Follower 单向同步</h4><p>　实现一下，会发现减少了很多问题，代码实现的复杂度也下降了很多</p>
<h3 id="Redis-vs-Memcached-vs-MongoDB"><a href="#Redis-vs-Memcached-vs-MongoDB" class="headerlink" title="Redis vs Memcached vs MongoDB"></a><a href="https://db-engines.com/en/system/Redis;Memcached;MongoDB">Redis vs Memcached vs MongoDB</a></h3><h4 id="性能"><a href="#性能" class="headerlink" title="性能"></a>性能</h4><ul>
<li>都比较高，性能对我们来说应该都不是瓶颈</li>
<li>从 TPS 的角度来看，Redis 和 Memcached 差不多，要略优于 MongoDB</li>
</ul>
<h4 id="操作的便利性"><a href="#操作的便利性" class="headerlink" title="操作的便利性"></a>操作的便利性</h4><ul>
<li>Redis<br>丰富一些，数据操作方面，Redis 更好一些，较少的网络 I/O 次数</li>
<li>Memcached<br>数据结构单一</li>
<li>MongoDB<br>支持丰富的数据表达，索引，最类似关系型数据库，支持的查询语言非常丰富</li>
</ul>
<h4 id="内存空间的大小和数据量的大小"><a href="#内存空间的大小和数据量的大小" class="headerlink" title="内存空间的大小和数据量的大小"></a>内存空间的大小和数据量的大小</h4><ul>
<li>Redis<br>在 2.0 版本后增加了自己的 VM 特性，突破物理内存的限制；可以对 <code>K-V</code> 设置过期时间（类似 Memcached）</li>
<li>Memcached<br>可以修改最大可用内存，采用 LRU 算法</li>
<li>MongoDB<br>适合大数据量的存储，依赖操作系统 VM 做内存管理，吃内存也比较厉害，服务不要和其他的放在一起</li>
</ul>
<h4 id="可用性（单点问题）"><a href="#可用性（单点问题）" class="headerlink" title="可用性（单点问题）"></a>可用性（单点问题）</h4><ul>
<li>Redis<br>依赖客户端来实现分布式读写；主从复制时，每次从节点重新连接主节点都要依赖整个快照,无增量复制，因性能和效率问题，所以单点问题比较复杂<br>不支持自动 sharding，需要依赖程序设定一致 hash 机制<br>一种替代方案是，不用Redis本身的复制机制，采用自己做主动复制（多份存储），或者改成增量复制的方式（需要自己实现），一致性问题和性能的权衡</li>
<li>Memcached<br>本身没有数据冗余机制，也没必要；对于故障预防，采用依赖成熟的 hash 或者环状的算法，解决单点故障引起的抖动问题。</li>
<li>MongoDB<br>支持 master-slave、replicaset（内部采用 Paxos 选举算法，自动故障恢复）、auto sharding 机制，对客户端屏蔽了故障转移和切分机制。</li>
</ul>
<h4 id="可靠性（持久化）"><a href="#可靠性（持久化）" class="headerlink" title="可靠性（持久化）"></a>可靠性（持久化）</h4><ul>
<li>Redis<br>对于数据持久化和数据恢复，Redis 支持（快照、AOF）：依赖快照进行持久化，AOF 增强了可靠性的同时，对性能有所影响</li>
<li>Memcached<br>不支持，通常用在做缓存，提升性能</li>
<li>MongoDB<br>从 1.8 版本开始采用 binlog 方式支持持久化的可靠性</li>
</ul>
<h4 id="数据一致性（事务支持）"><a href="#数据一致性（事务支持）" class="headerlink" title="数据一致性（事务支持）"></a>数据一致性（事务支持）</h4><ul>
<li>Redis<br>事务支持比较弱，只能保证事务中的每个操作连续执行</li>
<li>Memcached<br>在并发场景下，用 CAS 保证一致性</li>
<li>MongoDB<br>不支持事务</li>
</ul>
<h4 id="数据分析"><a href="#数据分析" class="headerlink" title="数据分析"></a>数据分析</h4><ul>
<li>MongoDB<br>内置了数据分析的功能（MapReduce），其他不支持</li>
</ul>
<h4 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h4><ul>
<li>Redis<br>数据量较小的更性能操作和运算上</li>
<li>Memcached<br>用于在动态系统中减少数据库负载，提升性能；做缓存，提高性能（适合读多写少，对于数据量比较大，可以采用 sharding）</li>
<li>MongoDB<br>主要解决海量数据的访问效率问题</li>
</ul>
<h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><h3 id="Doc"><a href="#Doc" class="headerlink" title="Doc"></a>Doc</h3><ul>
<li><a href="http://redis.io/commands">Redis 命令集</a></li>
</ul>
<h3 id="Blog"><a href="#Blog" class="headerlink" title="Blog"></a>Blog</h3><ul>
<li><a href="http://www.cnblogs.com/qunshu/p/3196972.html">Redis 数据类型详解，以及 Redis 适用场景场合</a></li>
<li><a href="http://www.cnblogs.com/alephsoul-alephsoul/archive/2013/04/26/3044630.html">Cassandra、Mongodb、CouchDB、Redis、Riak、Membase、Neo4j、HBase 最佳应用场景</a></li>
<li><a href="https://github.com/huangqian/note/blob/master/Redis/redis-quantitative-analysis.md">适用场景和量化分析</a></li>
<li><a href="https://github.com/huangqian/note/blob/master/Redis/redis-datastruct-select.md">数据结构的选择</a></li>
<li><a href="https://github.com/huangqian/note/blob/master/Redis/redis-ops-optimization.md">调优与运维</a></li>
</ul>
<h3 id="Tool"><a href="#Tool" class="headerlink" title="Tool"></a>Tool</h3><ul>
<li><a href="https://redisdesktop.com/download">Redis Desktop Manager</a></li>
<li><a href="https://github.com/sohutv/cachecloud">Redis 私有云平台</a></li>
</ul>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt=""></a></td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>大数据</category>
      </categories>
      <tags>
        <tag>Redis</tag>
        <tag>Paxos</tag>
        <tag>Raft</tag>
        <tag>Jedis</tag>
        <tag>Guava</tag>
        <tag>Memcached</tag>
        <tag>MongoDB</tag>
        <tag>缓存</tag>
      </tags>
  </entry>
  <entry>
    <title>如何成为 Apache 的 PMC</title>
    <url>/posts/19631/</url>
    <content><![CDATA[<h2 id="关于本文"><a href="#关于本文" class="headerlink" title="关于本文"></a>关于本文</h2><p>　本文主要是为了，记录给 <a href="https://yuzhouwan.com/posts/5845/"><code>Apache Druid</code></a> / <a href="https://yuzhouwan.com/posts/39683/"><code>Apache Eagle</code></a> / <a href="https://yuzhouwan.com/posts/20644/"><code>Apache Flink</code></a> / <a href="https://yuzhouwan.com/posts/45888/"><code>Apache HBase</code></a> / <a href="https://yuzhouwan.com/posts/26002/"><code>Apache Kafka</code></a> / <a href="https://yuzhouwan.com/posts/743/"><code>Apache Superset</code></a> / <a href="https://yuzhouwan.com/posts/31915/"><code>Apache ZooKeeper</code></a> &amp; <a href="https://yuzhouwan.com/posts/31915/"><code>Apache Curator</code></a> / <a href="https://yuzhouwan.com/posts/42737/"><code>TensorFlow</code></a> / <a href="https://github.com/alibaba/DataX"><code>Alibaba DataX</code></a> <a href="https://yuzhouwan.com/posts/19631/#其他">等</a>开源项目贡献代码，尽自己一点绵薄之力的过程</p>
<p>　文章最后，总结了一些经验之谈，期冀能帮助到同样<strong>热爱开源</strong>、也想成为 <a href="http://people.apache.org/committer-index.html#asdf2014">PMC</a> 的小伙伴们</p>
<a id="more"></a>
<h2 id="开源贡献纪实"><a href="#开源贡献纪实" class="headerlink" title="开源贡献纪实"></a>开源贡献纪实</h2><h3 id="Apache-Druid"><a href="#Apache-Druid" class="headerlink" title="Apache / Druid"></a><a href="https://github.com/apache">Apache</a> / <a href="https://yuzhouwan.com/posts/5845/">Druid</a></h3><h4 id="Pull-Request"><a href="#Pull-Request" class="headerlink" title="Pull Request"></a><a href="https://github.com/apache/druid/pulls/asdf2014">Pull Request</a></h4><div class="table-container">
<table>
<thead>
<tr>
<th>Title</th>
<th>Status</th>
<th>Create Date</th>
<th>Merge Date</th>
</tr>
</thead>
<tbody>
<tr>
<td>Some code refactor for better performance of <code>Avro-Extension</code> <a href="https://github.com/apache/druid/pull/4092">#4092</a></td>
<td>Merged</td>
<td>2017-03-22</td>
<td>2017-04-25</td>
</tr>
<tr>
<td>Explain Avro´s unnecessary EOFException (#4098) <a href="https://github.com/apache/druid/pull/4100">#4100</a></td>
<td>Merged</td>
<td>2017-03-23</td>
<td>2017-03-24</td>
</tr>
<tr>
<td>Improve <code>collection</code> related things that reusing a immutable object instead of creating a new object <a href="https://github.com/apache/druid/pull/4135">#4135</a></td>
<td>Merged</td>
<td>2017-03-30</td>
<td>2017-05-17</td>
</tr>
<tr>
<td>Increment the resource of <code>JVM</code> and the number of threads in <code>Travis</code> instead of default <a href="https://github.com/apache/druid/pull/4139">#4139</a></td>
<td>Closed</td>
<td>2017-03-31</td>
<td></td>
</tr>
<tr>
<td>Update outdated RLE paper and improve some code refactoring <a href="https://github.com/apache/druid/pull/4286">#4286</a></td>
<td>Merged</td>
<td>2017-05-17</td>
<td>2017-05-19</td>
</tr>
<tr>
<td>Fix bug in SegmentAnalyzer.analyzeComplexColumn() <a href="https://github.com/apache/druid/issues/5939">#5939</a> <a href="https://github.com/apache/druid/pull/5954">#5954</a></td>
<td>Merged</td>
<td>2018-07-07</td>
<td>2018-07-10</td>
</tr>
<tr>
<td>Remove redundant type parameters and enforce some other style and inspection rules <a href="https://github.com/apache/druid/pull/5980">#5980</a></td>
<td>Merged</td>
<td>2018-07-09</td>
<td>2018-07-28</td>
</tr>
<tr>
<td>Add IRC#druid-dev shields.io into README <a href="https://github.com/apache/druid/pull/6002">#6002</a></td>
<td>Merged</td>
<td>2018-07-13</td>
<td>2018-07-22</td>
</tr>
<tr>
<td>Add the ‘—fail-at-end’ option to maven command for ‘strictly compiled’ part <a href="https://github.com/apache/druid/pull/6078">#6078</a></td>
<td>Merged</td>
<td>2018-07-31</td>
<td>2018-08-01</td>
</tr>
<tr>
<td>Fix missing exception handling as part of <code>io.druid.java.util.http.client.netty.HttpClientPipelineFactory</code> <a href="https://github.com/apache/druid/pull/6090">#6090</a></td>
<td>Merged</td>
<td>2018-08-02</td>
<td>2018-08-11</td>
</tr>
<tr>
<td>Make time-related variables more readable <a href="https://github.com/apache/druid/pull/6158">#6158</a></td>
<td>Merged</td>
<td>2018-08-12</td>
<td>2018-08-22</td>
</tr>
<tr>
<td>Add maven.exec.xxx.skip option for exec-maven-plugin <a href="https://github.com/apache/druid/pull/6162">#6162</a></td>
<td>Merged</td>
<td>2018-08-13</td>
<td>2018-09-25</td>
</tr>
<tr>
<td>Fix assertionError at testCheckpointForInactiveTaskGroup in KafkaSupervisorTest <a href="https://github.com/apache/druid/pull/6192">#6192</a></td>
<td>Merged</td>
<td>2018-08-19</td>
<td>2018-08-22</td>
</tr>
<tr>
<td>Fix wrong counter getFailedSendingTimeCounter method <a href="https://github.com/apache/druid/pull/6793">#6793</a></td>
<td>Merged</td>
<td>2019-01-02</td>
<td>2019-01-02</td>
</tr>
<tr>
<td>In addition to special cases such as avoiding deadlock, make sure that the current thread has got the connectionLock object lock when accessing the statements object <a href="https://github.com/apache/druid/pull/6903">#6903</a></td>
<td>Merged</td>
<td>2019-01-23</td>
<td>2019-01-28</td>
</tr>
<tr>
<td>For performance reasons, use <code>java.util.Base64</code> instead of Base64 in Apache Commons Codec and Guava <a href="https://github.com/apache/druid/pull/6913">#6913</a></td>
<td>Merged</td>
<td>2019-01-25</td>
<td>2019-01-26</td>
</tr>
<tr>
<td>Add “REVERSE” / “REPEAT” / “RIGHT” / “LEFT” functions <a href="https://github.com/apache/druid/pull/7334">#7334</a></td>
<td>Merged</td>
<td>2019-03-23</td>
<td>2019-04-10</td>
</tr>
<tr>
<td>Fix broken links in api-reference.md <a href="https://github.com/apache/druid/pull/7670">#7670</a></td>
<td>Merged</td>
<td>2019-04-16</td>
<td>2019-04-16</td>
</tr>
<tr>
<td>Bump httpcore from 4.4.4 to 4.4.11 <a href="https://github.com/apache/druid/pull/7870">#7870</a></td>
<td>Merged</td>
<td>2019-06-12</td>
<td>2019-08-10</td>
</tr>
<tr>
<td>Optimize images by ImgBot <a href="https://github.com/apache/druid/pull/7873">#7873</a></td>
<td>Merged</td>
<td>2019-06-12</td>
<td>2019-06-25</td>
</tr>
<tr>
<td>Bump jmh from 1.19 to 1.21 <a href="https://github.com/apache/druid/pull/7876">#7876</a></td>
<td>Merged</td>
<td>2019-06-13</td>
<td>2019-06-17</td>
</tr>
<tr>
<td>Bump RoaringBitmap from 0.8.0 to 0.8.6 <a href="https://github.com/apache/druid/pull/7906">#7906</a></td>
<td>Merged</td>
<td>2019-06-17</td>
<td>2019-06-17</td>
</tr>
<tr>
<td>Bump commons-cli from 1.2 to 1.3.1 <a href="https://github.com/apache/druid/pull/7966">#7966</a></td>
<td>Merged</td>
<td>2019-06-26</td>
<td>2019-06-26</td>
</tr>
<tr>
<td>Bump jaxb-api from 2.3.0 to 2.3.1 <a href="https://github.com/apache/druid/pull/7978">#7978</a></td>
<td>Merged</td>
<td>2019-06-27</td>
<td>2019-06-27</td>
</tr>
<tr>
<td>Bump commons-validator from 1.4.0 to 1.5.1 <a href="https://github.com/apache/druid/pull/7987">#7987</a></td>
<td>Merged</td>
<td>2019-06-28</td>
<td>2019-06-28</td>
</tr>
<tr>
<td>Bump commons-codec from 1.7 to 1.12 <a href="https://github.com/apache/druid/pull/7995">#7995</a></td>
<td>Merged</td>
<td>2019-06-29</td>
<td>2019-06-29</td>
</tr>
<tr>
<td>Bump rhino from 1.7R5 to 1.7.11 <a href="https://github.com/apache/druid/pull/8008">#8008</a></td>
<td>Merged</td>
<td>2019-07-02</td>
<td>2019-08-10</td>
</tr>
<tr>
<td>Bump JUnitParams from 1.0.4 to 1.1.1 <a href="https://github.com/apache/druid/pull/8017">#8017</a></td>
<td>Merged</td>
<td>2019-07-03</td>
<td>2019-08-21</td>
</tr>
<tr>
<td>Hide descriptive comments in <code>pull_request_template.md</code> <a href="https://github.com/apache/druid/pull/8313">#8313</a></td>
<td>Merged</td>
<td>2019-08-15</td>
<td>2019-08-16</td>
</tr>
<tr>
<td>Fix missing format argument <a href="https://github.com/apache/druid/pull/8331">#8331</a></td>
<td>Merged</td>
<td>2019-08-19</td>
<td>2019-08-19</td>
</tr>
<tr>
<td>Fix resource leak <a href="https://github.com/apache/druid/pull/8337">#8337</a></td>
<td>Merged</td>
<td>2019-08-19</td>
<td>2019-08-20</td>
</tr>
<tr>
<td>Add grade shield <a href="https://github.com/apache/druid/pull/8344">#8344</a></td>
<td>Merged</td>
<td>2019-08-20</td>
<td>2019-08-21</td>
</tr>
<tr>
<td>Fix unused format argument <a href="https://github.com/apache/druid/pull/8345">#8345</a></td>
<td>Merged</td>
<td>2019-08-20</td>
<td>2019-08-21</td>
</tr>
<tr>
<td>Fix result of division may be truncated <a href="https://github.com/apache/druid/pull/8355">#8355</a></td>
<td>Merged</td>
<td>2019-08-21</td>
<td>2019-09-04</td>
</tr>
<tr>
<td>Reduce the size of images with lossless compression <a href="https://github.com/apache/druid/pull/8358">#8358</a></td>
<td>Merged</td>
<td>2019-08-21</td>
<td>2019-08-22</td>
</tr>
<tr>
<td>Suppress index-out-of-bounds warning from LGTM about loop unrolling <a href="https://github.com/apache/druid/pull/8380">#8380</a></td>
<td>Merged</td>
<td>2019-08-23</td>
<td>2019-09-04</td>
</tr>
<tr>
<td>Fix inconsistent equals and hashCode <a href="https://github.com/apache/druid/pull/8381">#8381</a></td>
<td>Merged</td>
<td>2019-08-23</td>
<td>2019-09-04</td>
</tr>
<tr>
<td>Fix alerts from LGTM about python files <a href="https://github.com/apache/druid/pull/8383">#8383</a></td>
<td>Merged</td>
<td>2019-08-23</td>
<td>2019-09-07</td>
</tr>
<tr>
<td>Add docker shield <a href="https://github.com/apache/druid/pull/8403">#8403</a></td>
<td>Merged</td>
<td>2019-08-26</td>
<td>2019-08-27</td>
</tr>
<tr>
<td>Fix missing space in string literal and spurious Javadoc @param tags from LGTM <a href="https://github.com/apache/druid/pull/8491">#8491</a></td>
<td>Merged</td>
<td>2019-09-09</td>
<td>2019-09-16</td>
</tr>
<tr>
<td>Fix resource leaks and suppress an incorrect LGTM alert <a href="https://github.com/apache/druid/pull/8589">#8589</a></td>
<td>Merged</td>
<td>2019-09-25</td>
<td>2019-10-11</td>
</tr>
<tr>
<td>Fix NPE for subquery with limit <a href="https://github.com/apache/druid/pull/8775">#8775</a></td>
<td>Merged</td>
<td>2019-10-29</td>
<td>2019-12-18</td>
</tr>
<tr>
<td>Exclude .asf.yaml from the configuration of the rat plugin <a href="https://github.com/apache/druid/pull/9088">#9088</a></td>
<td>Merged</td>
<td>2019-12-21</td>
<td>2019-12-24</td>
</tr>
</tbody>
</table>
</div>
<h4 id="Issues"><a href="#Issues" class="headerlink" title="Issues"></a><a href="https://github.com/apache/druid/issues/created_by/asdf2014">Issues</a></h4><p><a href="https://github.com/apache/druid/issues/created_by/asdf2014">All issues in Druid</a><br>Open / Close / Total : 0 / 5 / 5</p>
<hr>
<h3 id="Apache-Eagle"><a href="#Apache-Eagle" class="headerlink" title="Apache / Eagle"></a><a href="https://github.com/apache">Apache</a> / <a href="https://yuzhouwan.com/posts/39683/">Eagle</a></h3><h4 id="Pull-Request-1"><a href="#Pull-Request-1" class="headerlink" title="Pull Request"></a><a href="https://github.com/apache/eagle/pulls?utf8=%E2%9C%93&amp;q=is%3Apr%20author%3Aasdf2014">Pull Request</a></h4><div class="table-container">
<table>
<thead>
<tr>
<th>Title</th>
<th>Status</th>
<th>Create Date</th>
<th>Merge Date</th>
</tr>
</thead>
<tbody>
<tr>
<td>[<a href="https://issues.apache.org/jira/browse/EAGLE-981">EAGLE-981</a>] GC overhead limit exceeded <a href="https://github.com/apache/eagle/pull/896">#896</a></td>
<td>Merged</td>
<td>2017-03-30</td>
<td>2017-04-18</td>
</tr>
<tr>
<td>[<a href="https://issues.apache.org/jira/browse/EAGLE-982">EAGLE-982</a>] The log length has exceeded the limit of 4 MB in Travis <a href="https://github.com/apache/eagle/pull/897">#897</a></td>
<td>Merged</td>
<td>2017-03-30</td>
<td>2017-04-18</td>
</tr>
<tr>
<td>[<a href="https://issues.apache.org/jira/browse/EAGLE-992">EAGLE-992</a>] HBase Naming that unify <code>Hbase</code> and <code>HBase</code> into <code>HBase</code><a href="https://github.com/apache/eagle/pull/905">#905</a></td>
<td>Merged</td>
<td>2017-04-06</td>
<td>2017-04-18</td>
</tr>
<tr>
<td>[<a href="https://issues.apache.org/jira/browse/EAGLE-1009">EAGLE-1009</a>] Fix <code>return</code> inside <code>finally</code> block may result in losing exception <a href="https://github.com/apache/eagle/pull/920">#920</a></td>
<td>Merged</td>
<td>2017-04-18</td>
<td>2017-04-19</td>
</tr>
<tr>
<td>[MINOR] Fix some project construction problems about <code>test sources</code> <a href="https://github.com/apache/eagle/pull/922">#922</a></td>
<td>Closed</td>
<td>2017-04-19</td>
<td></td>
</tr>
<tr>
<td>[<a href="https://issues.apache.org/jira/browse/EAGLE-1012">EAGLE-1012</a>] Some language level problems <a href="https://github.com/apache/eagle/pull/925">#925</a></td>
<td>Closed</td>
<td>2017-04-19</td>
<td></td>
</tr>
<tr>
<td>[MINOR] Fxi sprk/egle issues in JPM module <a href="https://github.com/apache/eagle/pull/943">#943</a></td>
<td>Closed</td>
<td>2017-06-07</td>
</tr>
</tbody>
</table>
</div>
<h4 id="Issues-1"><a href="#Issues-1" class="headerlink" title="Issues"></a><a href="https://issues.apache.org/jira/browse/EAGLE-981?jql=project%20%3D%20EAGLE%20AND%20reporter%20in%20(%22benedict%20jin%22)">Issues</a></h4><p><a href="https://issues.apache.org/jira/browse/EAGLE-981?jql=project%20%3D%20EAGLE%20AND%20reporter%20in%20(%22benedict%20jin%22)">All issues in Eagle</a><br>Open / Close / Total : 4 / 5 / 9</p>
<hr>
<h3 id="Apache-Flink"><a href="#Apache-Flink" class="headerlink" title="Apache / Flink"></a><a href="https://github.com/apache">Apache</a> / <a href="https://yuzhouwan.com/posts/20644/">Flink</a></h3><h4 id="Pull-Request-2"><a href="#Pull-Request-2" class="headerlink" title="Pull Request"></a><a href="https://github.com/apache/flink/pulls/asdf2014">Pull Request</a></h4><div class="table-container">
<table>
<thead>
<tr>
<th>Title</th>
<th>Status</th>
<th>Create Date</th>
<th>Merge Date</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://issues.apache.org/jira/browse/FLINK-6868">FLINK-6868</a>[build] Using <code>scala.binary.version</code> for <code>flink-streaming-scala</code> in <code>Cassandra Connector</code> <a href="https://github.com/apache/flink/pull/4087">#4087</a></td>
<td>Merged</td>
<td>2017-06-08</td>
<td>2017-06-25</td>
</tr>
<tr>
<td><a href="https://issues.apache.org/jira/browse/FLINK-7369">FLINK-7369</a>: Add more information for <code>Key group index out of range of key group range</code> exception <a href="https://github.com/apache/flink/pull/4474">#4474</a></td>
<td>Merged</td>
<td>2017-08-04</td>
<td>2017-08-04</td>
</tr>
</tbody>
</table>
</div>
<h4 id="Issues-2"><a href="#Issues-2" class="headerlink" title="Issues"></a><a href="https://issues.apache.org/jira/browse/FLINK-6868?jql=project%20%3D%20FLINK%20AND%20reporter%20in%20(%22benedict%20jin%22)">Issues</a></h4><p><a href="https://issues.apache.org/jira/browse/FLINK-6868?jql=project%20%3D%20FLINK%20AND%20reporter%20in%20(%22benedict%20jin%22)">All issues in Flink</a><br>Open / Close / Total : 0 / 3 / 3</p>
<p>Tips: <a href="https://flink.apache.org/contributing/how-to-contribute.html">How to Contribute to Flink</a></p>
<hr>
<h3 id="Apache-HBase"><a href="#Apache-HBase" class="headerlink" title="Apache / HBase"></a><a href="https://github.com/apache">Apache</a> / <a href="https://yuzhouwan.com/posts/45888/">HBase</a></h3><h4 id="Pull-Request-3"><a href="#Pull-Request-3" class="headerlink" title="Pull Request"></a><a href="https://github.com/apache/hbase/pulls/asdf2014">Pull Request</a></h4><div class="table-container">
<table>
<thead>
<tr>
<th>Title</th>
<th>Status</th>
<th>Create Date</th>
<th>Merge Date</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://issues.apache.org/jira/browse/HBASE-18470">HBASE-18470</a>: Fix a bug in <code>RetriesExhaustedWithDetailsException#getDesc</code> describe<a href="https://github.com/apache/hbase/pull/56">#56</a></td>
<td>Merged</td>
<td>2017-07-28</td>
<td>2017-08-03</td>
</tr>
</tbody>
</table>
</div>
<hr>
<h3 id="Apache-Kafka"><a href="#Apache-Kafka" class="headerlink" title="Apache / Kafka"></a><a href="https://github.com/apache">Apache</a> / <a href="https://yuzhouwan.com/posts/26002/">Kafka</a></h3><h4 id="Pull-Request-4"><a href="#Pull-Request-4" class="headerlink" title="Pull Request"></a><a href="https://github.com/apache/kafka/pulls/asdf2014">Pull Request</a></h4><div class="table-container">
<table>
<thead>
<tr>
<th>Title</th>
<th>Status</th>
<th>Create Date</th>
<th>Merge Date</th>
</tr>
</thead>
<tbody>
<tr>
<td>[MINOR] Improve runtime / storage / metrics / config parts <a href="https://github.com/apache/kafka/pull/4525">#4525</a></td>
<td>Merged</td>
<td>2018-02-05</td>
<td>2018-02-14</td>
</tr>
<tr>
<td>MINOR: Catch null pointer exception for empty leader URL when assignment is null <a href="https://github.com/apache/kafka/pull/4798">#4798</a></td>
<td>Merged</td>
<td>2018-03-30</td>
<td>2018-11-17</td>
</tr>
<tr>
<td>MINOR: Remove magic number and extract Pattern instance from method as class field <a href="https://github.com/apache/kafka/pull/4799">#4799</a></td>
<td>Merged</td>
<td>2018-03-30</td>
<td>2018-04-09</td>
</tr>
</tbody>
</table>
</div>
<hr>
<h3 id="Apache-Superset"><a href="#Apache-Superset" class="headerlink" title="Apache / Superset"></a><a href="https://github.com/apache">Apache</a> / <a href="https://yuzhouwan.com/posts/743/">Superset</a></h3><h4 id="Pull-Request-5"><a href="#Pull-Request-5" class="headerlink" title="Pull Request"></a><a href="https://github.com/apache/incubator-superset/pulls/asdf2014">Pull Request</a></h4><div class="table-container">
<table>
<thead>
<tr>
<th>Title</th>
<th>Status</th>
<th>Create Date</th>
<th>Merge Date</th>
</tr>
</thead>
<tbody>
<tr>
<td>little code refactor in models.py <a href="https://github.com/apache/incubator-superset/pull/2124">#2124</a></td>
<td>Merged</td>
<td>2017-02-07</td>
<td>2017-02-07</td>
</tr>
<tr>
<td>Fix werkzeug instance was created twice in Debug Mode (#2135) <a href="https://github.com/apache/incubator-superset/pull/2136">#2136</a></td>
<td>Merged</td>
<td>2017-02-08</td>
<td>2017-02-14</td>
</tr>
<tr>
<td>Fix ExtDeprecationWarning (#2137) <a href="https://github.com/apache/incubator-superset/pull/2138">#2138</a></td>
<td>Merged</td>
<td>2017-02-08</td>
<td>2017-02-09</td>
</tr>
<tr>
<td>Some code refactoring <a href="https://github.com/apache/incubator-superset/pull/2139">#2139</a></td>
<td>Merged</td>
<td>2017-02-08</td>
<td>2017-02-09</td>
</tr>
<tr>
<td>Using the time zone with specific name for querying Druid <a href="https://github.com/apache/incubator-superset/pull/2143">#2143</a></td>
<td>Merged</td>
<td>2017-02-09</td>
<td>2017-02-10</td>
</tr>
<tr>
<td>Aggregate data outside of topN into a single category <a href="https://github.com/apache/incubator-superset/pull/2176">#2176</a></td>
<td>Closed</td>
<td>2017-02-15</td>
<td></td>
</tr>
<tr>
<td>Fix UNKNOWN option in setup.py <a href="https://github.com/apache/incubator-superset/pull/2199">#2199</a></td>
<td>Closed</td>
<td>2017-02-17</td>
<td></td>
</tr>
<tr>
<td>fix timezone issues in slices (#2354) <a href="https://github.com/apache/incubator-superset/pull/2370">#2370</a></td>
<td>Closed</td>
<td>2017-03-08</td>
<td></td>
</tr>
<tr>
<td>Fix unicode issues (#2308 #2282) <a href="https://github.com/apache/incubator-superset/pull/2401">#2401</a></td>
<td>Merged</td>
<td>2017-03-14</td>
<td>2017-03-15</td>
</tr>
<tr>
<td>Fix rst grammar problems <a href="https://github.com/apache/incubator-superset/pull/4116">#4116</a></td>
<td>Merged</td>
<td>2017-12-26</td>
<td>2017-12-26</td>
</tr>
<tr>
<td>Fix invaild gitter url <a href="https://github.com/apache/incubator-superset/pull/4125">#4125</a></td>
<td>Merged</td>
<td>2017-12-27</td>
<td>2018-01-05</td>
</tr>
<tr>
<td>Hanization <a href="https://github.com/apache/incubator-superset/pull/4126">#4126</a></td>
<td>Merged</td>
<td>2017-12-27</td>
<td>2018-01-13</td>
</tr>
</tbody>
</table>
</div>
<h4 id="Issues-3"><a href="#Issues-3" class="headerlink" title="Issues"></a><a href="https://github.com/apache/incubator-superset/issues/created_by/asdf2014">Issues</a></h4><p><a href="https://github.com/apache/incubator-superset/issues/created_by/asdf2014">All issues in Superset</a><br>Open / Close / Total : 0 / 21 / 21</p>
<hr>
<h3 id="Apache-ZooKeeper"><a href="#Apache-ZooKeeper" class="headerlink" title="Apache / ZooKeeper"></a><a href="https://github.com/apache">Apache</a> / <a href="https://yuzhouwan.com/posts/31915/">ZooKeeper</a></h3><h4 id="Pull-Request-6"><a href="#Pull-Request-6" class="headerlink" title="Pull Request"></a><a href="https://github.com/apache/zookeeper/pulls/asdf2014">Pull Request</a></h4><div class="table-container">
<table>
<thead>
<tr>
<th>Title</th>
<th>Status</th>
<th>Create Date</th>
<th>Merge Date</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-2784">ZOOKEEPER-2784</a>: Add same <code>sid</code> config problem check <a href="https://github.com/apache/zookeeper/pull/257">#257</a></td>
<td>Closed</td>
<td>2017-05-18</td>
<td></td>
</tr>
<tr>
<td><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-2789">ZOOKEEPER-2789</a>: Reassign <code>ZXID</code> for solving 32bit overflow problem <a href="https://github.com/apache/zookeeper/pull/262">#262</a></td>
<td>Open</td>
<td>2017-05-23</td>
<td></td>
</tr>
<tr>
<td><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-2815">ZOOKEEPER-2815</a>: 1. Using try clause to close resource; 2. Others code refactoring for PERSISTENCE module <a href="https://github.com/apache/zookeeper/pull/283">#283</a></td>
<td>Merged</td>
<td>2017-06-16</td>
<td>2017-06-26</td>
</tr>
<tr>
<td><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-2816">ZOOKEEPER-2816</a>: Code refactoring for <code>ZK_SERVER</code> module <a href="https://github.com/apache/zookeeper/pull/288">#288</a></td>
<td>Merged</td>
<td>2017-06-20</td>
<td>2017-06-26</td>
</tr>
<tr>
<td><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-2817">ZOOKEEPER-2817</a>: Using <code>Collections.singletonList</code> instead of <code>Arrays.asList(oneElement)</code> <a href="https://github.com/apache/zookeeper/pull/290">#290</a></td>
<td>Closed</td>
<td>2017-06-22</td>
<td></td>
</tr>
<tr>
<td><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-2821">ZOOKEEPER-2821</a>: 1. Fix spell issues; 2. Remove unnecessary boxing / unboxing; 3. Simplify <code>return</code> clause; 4. … <a href="https://github.com/apache/zookeeper/pull/293">#293</a></td>
<td>Closed</td>
<td>2017-06-27</td>
<td></td>
</tr>
<tr>
<td><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-2822">ZOOKEEPER-2822</a>: Wrong <code>ObjectName</code> about <code>MBeanServer</code> in JMX module <a href="https://github.com/apache/zookeeper/pull/294">#294</a></td>
<td>Merged</td>
<td>2017-06-27</td>
<td>2018-11-27</td>
</tr>
<tr>
<td><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-2823">ZOOKEEPER-2823</a>: 1. Fix spell issues; 2. Standardize <code>StringBuilder#append</code> usage; 3. Using <code>try</code> clause for … <a href="https://github.com/apache/zookeeper/pull/295">#295</a></td>
<td>Closed</td>
<td>2017-06-28</td>
<td></td>
</tr>
<tr>
<td><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-2824">ZOOKEEPER-2824</a>: <code>FileChannel#size</code> info should be added to <code>FileTxnLog#commit</code> to solve the confuse that reason is too large log or too busy disk I/O <a href="https://github.com/apache/zookeeper/pull/296">#296</a></td>
<td>Merged</td>
<td>2017-06-28</td>
<td>2018-02-02</td>
</tr>
<tr>
<td><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-2825">ZOOKEEPER-2825</a>: 1. Remove unnecessary import; 2. <code>contains</code> instead of <code>indexOf &gt; -1</code> for more readable … <a href="https://github.com/apache/zookeeper/pull/297">#297</a></td>
<td>Merged</td>
<td>2017-06-29</td>
<td>2018-01-31</td>
</tr>
<tr>
<td><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-2826">ZOOKEEPER-2826</a>: Code refactoring for <code>CLI</code> module <a href="https://github.com/apache/zookeeper/pull/298">#298</a></td>
<td>Merged</td>
<td>2017-06-29</td>
<td>2018-01-31</td>
</tr>
<tr>
<td><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-2835">ZOOKEEPER-2835</a>: Run server with <code>-XX:+AlwaysPreTouch</code> jvm flag <a href="https://github.com/apache/zookeeper/pull/301">#301</a></td>
<td>Closed</td>
<td>2017-07-04</td>
<td></td>
</tr>
<tr>
<td><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-2837">ZOOKEEPER-2837</a>: Add a special START_SERVER_JVMFLAGS option only for <code>start</code> command to distinguish … <a href="https://github.com/apache/zookeeper/pull/302">#302</a></td>
<td>Closed</td>
<td>2017-07-04</td>
<td></td>
</tr>
<tr>
<td><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-2840">ZOOKEEPER-2840</a>: Should using <code>System.nanoTime() ^ this.hashCode()</code> for StaticHostProvider <a href="https://github.com/apache/zookeeper/pull/303">#303</a></td>
<td>Open</td>
<td>2017-07-05</td>
<td></td>
</tr>
<tr>
<td><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-2892">ZOOKEEPER-2892</a>: Improve lazy initialize and close stream for <code>PrepRequestProcessor</code> <a href="https://github.com/apache/zookeeper/pull/361">#361</a></td>
<td>Merged</td>
<td>2017-09-06</td>
<td>2018-02-07</td>
</tr>
</tbody>
</table>
</div>
<h4 id="Issues-4"><a href="#Issues-4" class="headerlink" title="Issues"></a><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-2784?jql=project%20%3D%20ZOOKEEPER%20AND%20reporter%20in%20(%22benedict%20jin%22)">Issues</a></h4><p><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-2784?jql=project%20%3D%20ZOOKEEPER%20AND%20reporter%20in%20(%22benedict%20jin%22)">All issues in ZooKeeper</a><br>Open / Close / Total : 10 / 8 / 18</p>
<hr>
<h3 id="Apache-Curator"><a href="#Apache-Curator" class="headerlink" title="Apache / Curator"></a><a href="https://github.com/apache">Apache</a> / <a href="https://yuzhouwan.com/posts/31915/">Curator</a></h3><h4 id="Pull-Request-7"><a href="#Pull-Request-7" class="headerlink" title="Pull Request"></a><a href="https://github.com/apache/curator/pulls/asdf2014">Pull Request</a></h4><div class="table-container">
<table>
<thead>
<tr>
<th>Title</th>
<th>Status</th>
<th>Create Date</th>
<th>Merge Date</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://issues.apache.org/jira/browse/CURATOR-523">CURATOR-523</a>: Fix ByteBuffer’s compatibility issues <a href="https://github.com/apache/curator/pull/321">#321</a></td>
<td>Merged</td>
<td>2019-08-01</td>
<td>2019-08-23</td>
</tr>
</tbody>
</table>
</div>
<hr>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><ul>
<li><a href="https://github.com/alibaba/DataX/pulls/asdf2014">Alibaba DataX</a></li>
<li><a href="https://github.com/aliyun/aliyun-tsdb-java-sdk/pulls/asdf2014">Aliyun TSDB Java SDK</a></li>
<li><a href="https://github.com/helm/charts/pulls/asdf2014">Helm Charts</a></li>
<li><a href="https://github.com/crate/crate/pulls/asdf2014">CrateDB</a></li>
<li><a href="https://github.com/elastic/elasticsearch/pulls/asdf2014">ElasticSearch</a></li>
<li><a href="https://github.com/grpc/grpc-java/pulls/asdf2014">Grpc-Java</a></li>
<li><a href="https://github.com/theme-next/hexo-theme-next/pulls/asdf2014">Hexo Theme Next</a></li>
<li><a href="https://github.com/httprunner/har2case/pulls/asdf2014">HttpRunner</a></li>
<li><a href="https://github.com/hankcs/ID-CNN-CWS/pulls/asdf2014">ID-CNN-CWS</a></li>
<li><a href="https://github.com/lensesio/kafka-connect-ui/pulls/asdf2014">Kafka Connect UI</a></li>
<li><a href="https://github.com/apache/lucene-solr/pulls/asdf2014">Lucene</a></li>
<li><a href="https://github.com/OpenTSDB/opentsdb/pulls/asdf2014">OpenTSDB</a></li>
<li><a href="https://github.com/tensorflow/tensorflow/pulls/asdf2014">Tensorflow</a></li>
</ul>
<h2 id="初衷"><a href="#初衷" class="headerlink" title="初衷"></a>初衷</h2><p>　需要提前说明的是，大家不能为了成为 PMC 而去成为 PMC。我们的初衷应该是认可开源，热爱开源，乐于和全球的开发者一起努力，做出来一些有意义的东西。换句话说，如果一行代码都还没贡献，就开始到处找攻略或捷径，则是很不可取的。当然有这个目标是很好的，但是正常情况下，成为 PMC 不是一蹴而就的事情。需要我们付出足够多的心力和汗水之后，才会水到渠成地收到来自 ASF 的邀请函。</p>
<h2 id="技巧"><a href="#技巧" class="headerlink" title="技巧"></a>技巧</h2><p>　如果说成为 PMC 这件事完全没有任何技巧，也是不可能的。下面就来说一些大家需要注意的事项，尽量地少走弯路：</p>
<h3 id="选择项目"><a href="#选择项目" class="headerlink" title="选择项目"></a>选择项目</h3><p>　第一步当然是寻找一个合适自己的项目，能和自己的兴趣或工作内容相关的项目，自然是最好不过了。另外，也要从是否有商业公司在背后主导，是否有长期活跃的 PMC，是否具备和其他同类产品的核心竞争力，是否在架构上存在重大缺陷，是否对新代码贡献者很包容 等等角度来判断，这个项目是否值得你去付出大量的精力。</p>
<h3 id="代码贡献"><a href="#代码贡献" class="headerlink" title="代码贡献"></a>代码贡献</h3><p>　按理说，任何的代码提交，都已经先建立 issues 发起一次讨论。一方面，可以让社区里的其他代码贡献者，知道你想要做什么样的事情；另一方面，也可以听取其他人的意见，包括你要做的这件事的必要性，以及是否有其他更好的实现思路。如果刚开始对某一个项目进行代码贡献，则可以从认领一些 issues 来开始。比较好的开源项目，还会在 issues 上打上类似 <code>Contributions Welcome</code> 的标签。</p>
<h3 id="代码评审"><a href="#代码评审" class="headerlink" title="代码评审"></a>代码评审</h3><p>　很多小伙伴会认为只有 Committer 才能对其他人的代码进行 review。其实不然，任何你想到的有价值的意见，都可以提出来。并且，在帮助评审他人代码的同时，还能学习到别人解决问题的方式方法。尤其是在一些有争议的地方，可以看到不同的贡献者，针对同一个问题从不同角度的思考，对自己的思维开拓也是大有裨益的。</p>
<h2 id="代码提交的几个注意点"><a href="#代码提交的几个注意点" class="headerlink" title="代码提交的几个注意点"></a>代码提交的几个注意点</h2><h3 id="通用技巧"><a href="#通用技巧" class="headerlink" title="通用技巧"></a>通用技巧</h3><h4 id="保持-Diff-信息最简"><a href="#保持-Diff-信息最简" class="headerlink" title="保持 Diff 信息最简"></a>保持 Diff 信息最简</h4><p>　PR 中不应该做无关的 Code Format（import / 代码缩进 等）</p>
<h4 id="保持-PR-的相关性"><a href="#保持-PR-的相关性" class="headerlink" title="保持 PR 的相关性"></a>保持 PR 的相关性</h4><p>　不做无关的 代码优化，尤其是对其他不相关的类（可以另起 PR 进行优化）</p>
<h4 id="保持-代码风格一致"><a href="#保持-代码风格一致" class="headerlink" title="保持 代码风格一致"></a>保持 代码风格一致</h4><p>　关闭 IDE 自动优化 import 合并为通配符 <code>*</code> 的功能（如，<code>import java.io.*</code> 等）</p>
<h3 id="因地制宜"><a href="#因地制宜" class="headerlink" title="因地制宜"></a>因地制宜</h3><h4 id="Apache-Druid-1"><a href="#Apache-Druid-1" class="headerlink" title="Apache Druid"></a>Apache Druid</h4><p>　遵照 Apache <a href="https://yuzhouwan.com/posts/5845/">Druid</a> 编码规则，比如 参数列表，需要分行写 等</p>
<h4 id="Apache-Eagle-1"><a href="#Apache-Eagle-1" class="headerlink" title="Apache Eagle"></a>Apache Eagle</h4><p>　Apache <a href="https://yuzhouwan.com/posts/39683/">Eagle</a> 需要 squash PR 中的 commits 等等</p>
<h4 id="Apache-HBase-1"><a href="#Apache-HBase-1" class="headerlink" title="Apache HBase"></a>Apache HBase</h4><p>　Apache <a href="https://yuzhouwan.com/posts/45888/">HBase</a> 是以 Patch + Jira 为主的代码维护模式，Github 里面只是代码镜像，所以提交代码不需要创建 PR</p>
<h4 id="Apache-Superset-1"><a href="#Apache-Superset-1" class="headerlink" title="Apache Superset"></a>Apache Superset</h4><p>　Apache <a href="https://yuzhouwan.com/posts/743/">Superset</a> / <a href="https://yuzhouwan.com/posts/42737/">Tensorflow</a> 之类的 Python 项目，需要注意 <a href="https://www.python.org/dev/peps/pep-0537/">PEP</a> 规范</p>
<h4 id="Apache-ZooKeeper-1"><a href="#Apache-ZooKeeper-1" class="headerlink" title="Apache ZooKeeper"></a>Apache ZooKeeper</h4><p>　参照官方给出的提交代码的文档即可 <a href="https://cwiki.apache.org/confluence/display/ZOOKEEPER/HowToContribute">How to Contribute to ZooKeeper</a></p>
<h4 id="ElasticSearch"><a href="#ElasticSearch" class="headerlink" title="ElasticSearch"></a>ElasticSearch</h4><p>　除了遵循 <a href="https://github.com/elastic/elasticsearch/blob/master/CONTRIBUTING.md">CONTRIBUTING.md</a> 文档中提及的内容，还有一些不成文的规定，例如 <a href="https://yuzhouwan.com/posts/22654/">ElasticSearch</a> 的 Committer 对于 <code>varA == false</code> 这类冗余的写法很是赞同，认为可以减少丢失 <code>!</code> 的风险</p>
<h3 id="好的习惯"><a href="#好的习惯" class="headerlink" title="好的习惯"></a>好的习惯</h3><ul>
<li>在提交之前，先更新 master 分支，并通过 <code>git rebase -i master</code> 命令，将自己的提交<strong><a href="https://github.com/apache/druid/pull/4135">置顶</a></strong>（主分支，也可能不叫 master，比如 Kafka 的主分支是 trunk）</li>
<li>保证自己的代码，能够被单元测试覆盖到。如果原本的测试用例，无法覆盖到，则需要自己编写对应的<a href="https://github.com/apache/zookeeper/pull/257">单元测试</a></li>
<li>提交<strong>性能提升型</strong> PR，需要自己写好 benchmark，并贴出<a href="https://github.com/apache/druid/pull/4092">压测结果</a></li>
<li>提交 PR 的时候，在标题的前面增加 <code>[JIRA]</code>（对应的 Jira 号）、<code>[MINOR]</code>（微小的改动）、<code>[WIP]</code>（未完成的修改）和 <code>[Benchmarking]</code>（性能测试中） 之类的标示，可以帮助 Committer 更高效地处理 PR</li>
</ul>
<p>Tips: 关于 Git 的相关操作，详见我的另一篇博客：《<a href="https://yuzhouwan.com/posts/30041/">Git 高级玩法</a>》</p>
<h2 id="那么成为-Apache-PMC-有什么好处？"><a href="#那么成为-Apache-PMC-有什么好处？" class="headerlink" title="那么成为 Apache PMC 有什么好处？"></a>那么成为 Apache PMC 有什么好处？</h2><ul>
<li><p>可以拥有一个 @apache.org 的邮箱</p>
</li>
<li><p>在任何一个 Apache 项目中发言都将标识 Member 徽章</p>
</li>
<li><p>可以免费使用 IDEA 全家桶中的所有产品</p>
<p><img data-src="/picture/pmc/pmc_idea_license.png" alt="JetBrains All Products Pack license for ASF Committers"></p>
<center>（对 <a href="https://www.jetbrains.com/idea/" target="_blank">IntelliJ IDEA</a>™ 的截图）</center>








</li>
</ul>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt=""></a></td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>开源社区</category>
      </categories>
      <tags>
        <tag>Apache Kafka</tag>
        <tag>Kubernetes</tag>
        <tag>Helm</tag>
        <tag>Apache Druid</tag>
        <tag>Apache ZooKeeper</tag>
        <tag>Apache Flink</tag>
        <tag>开源社区</tag>
        <tag>Git</tag>
        <tag>Github</tag>
        <tag>Apache Eagle</tag>
        <tag>Apache HBase</tag>
        <tag>Apache Superset</tag>
        <tag>TensorFlow</tag>
      </tags>
  </entry>
  <entry>
    <title>如何运用 JVM 知识提高编程水平</title>
    <url>/posts/27328/</url>
    <content><![CDATA[<h2 id="什么是-JVM"><a href="#什么是-JVM" class="headerlink" title="什么是 JVM?"></a>什么是 JVM?</h2><p>　A <strong>J</strong>ava <strong>V</strong>irtual <strong>M</strong>achine（JVM）is an abstract computing machine that enables a computer to run a Java program.</p>
<h2 id="为什么要有-JVM"><a href="#为什么要有-JVM" class="headerlink" title="为什么要有 JVM?"></a>为什么要有 JVM?</h2><h3 id="跨平台性"><a href="#跨平台性" class="headerlink" title="跨平台性"></a>跨平台性</h3><p>　JVM 的存在，使得 Java 程序 能够轻易地在多平台上移植，基本上脱离了对硬件的依赖性（这也满足了 <a href="https://en.wikipedia.org/wiki/David_Parnas">David Parnas</a> 的 “<a href="https://en.wikipedia.org/wiki/Information_hiding">信息隐藏</a>” 准则）</p>
<h3 id="多语言性"><a href="#多语言性" class="headerlink" title="多语言性"></a>多语言性</h3><p>　因为底层 JIT 编译优化、高效 GC、JUC 对多线程并发编程的支持，以及社区中海量成熟的库 等优点，使得<a href="https://en.wikipedia.org/wiki/List_of_JVM_languages">很多语言</a>都开发出可运行在 JVM 上的版本</p>
<p>　同时，多语言混合编程成为一种趋势，在需要快速开发、灵活部署 和 针对特定问题的 DSL 等场景下，选择恰当的 JVM-hosted language，可以最大化原有代码的价值</p>
<p>　<strong>那么，在日常的开发过程中，究竟应该如何运用 JVM 的知识，来逐步提高实际编程水平呢？ 上下而求索后，找到了以下几个层面作为出发点</strong></p>
<a id="more"></a>
<h2 id="编码层面"><a href="#编码层面" class="headerlink" title="编码层面"></a>编码层面</h2><h3 id="递归-vs-尾递归"><a href="#递归-vs-尾递归" class="headerlink" title="递归 vs 尾递归"></a>递归 vs 尾递归</h3><h4 id="循环调用"><a href="#循环调用" class="headerlink" title="循环调用"></a>循环调用</h4><figure class="highlight scala"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">inc</span></span>(i: <span class="type">Int</span>): <span class="type">Int</span> = i + <span class="number">1</span></span><br><span class="line"></span><br><span class="line"># <span class="number">10</span> 亿次 <span class="keyword">for</span> 循环调用</span><br><span class="line"><span class="number">0</span>: aload_0                                                                                 | 从局部变量 <span class="number">0</span> 中装载引用类型值</span><br><span class="line"><span class="number">1</span>: getfield         #<span class="number">29</span>  <span class="comment">// Field i$1:Lscala/runtime/IntRef;                               | 从对象中获取字段</span></span><br><span class="line"><span class="number">4</span>: getstatic        #<span class="number">33</span>  <span class="comment">// Field com/yuzhouwan/jit/Inc$.MODULE$:Lcom/yuzhouwan/jit/Inc$;  | 从类中获取静态字段</span></span><br><span class="line"><span class="number">7</span>: aload_0                                                                                 | 从局部变量 <span class="number">0</span> 中装载引用类型值</span><br><span class="line"><span class="number">8</span>: getfield         #<span class="number">29</span>  <span class="comment">// Field i$1:Lscala/runtime/IntRef;                               | 从对象中获取字段</span></span><br><span class="line"><span class="number">11</span>: getfield        #<span class="number">38</span>  <span class="comment">// Field scala/runtime/IntRef.elem:I                              | 从对象中获取字段</span></span><br><span class="line"></span><br><span class="line"><span class="number">14</span>: invokevirtual   #<span class="number">42</span>  <span class="comment">// Method com/yuzhouwan/jit/Inc$.inc:(I)I                         | 运行时按照对象的类来调用实例方法</span></span><br><span class="line"><span class="number">17</span>: putfield        #<span class="number">38</span>  <span class="comment">// Field scala/runtime/IntRef.elem:I                              | 设置对象中字段的值</span></span><br><span class="line"></span><br><span class="line"><span class="number">20</span>: <span class="keyword">return</span>                                                                                 | 从方法中返回，返回值为 void</span><br><span class="line"></span><br><span class="line"># 被调用的累加方法</span><br><span class="line"><span class="number">0</span>: iload_1                 | 从局部变量 <span class="number">1</span> 中装载 int 类型值入栈</span><br><span class="line"><span class="number">1</span>: iconst_1                | <span class="number">1</span>(int) 值入栈</span><br><span class="line"><span class="number">2</span>: iadd                    | 将栈顶两 int 类型数相加，结果入栈</span><br><span class="line"><span class="number">3</span>: ireturn                 | 返回 int 类型值</span><br><span class="line"></span><br><span class="line"><span class="number">10</span> 亿次循环，大约 <span class="number">4014</span> ms</span><br></pre></td></tr></tbody></table></figure>
<h4 id="递归"><a href="#递归" class="headerlink" title="递归"></a>递归</h4><figure class="highlight scala"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rec</span></span>(i: <span class="type">Int</span>): <span class="type">Int</span> = {</span><br><span class="line">  <span class="keyword">if</span> (i == <span class="number">1</span>) <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">  rec(i - <span class="number">1</span>) + <span class="number">1</span>  <span class="comment">// change 1 to i, then counting...</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: iload_1                                      | 从局部变量 <span class="number">1</span> 中装载 int 类型值</span><br><span class="line"><span class="number">1</span>: iconst_1                                     | <span class="number">1</span>(int) 值入栈</span><br><span class="line"><span class="number">2</span>: if_icmpne       <span class="number">7</span>                            | 若栈顶两 int 类型值前小于等于后则跳转</span><br><span class="line"><span class="number">5</span>: iconst_1                                     | <span class="number">1</span>(int) 值入栈</span><br><span class="line"><span class="number">6</span>: ireturn                                      | 返回 int 类型值</span><br><span class="line"></span><br><span class="line"><span class="number">7</span>: aload_0                                      | 从局部变量 <span class="number">0</span> 中装载引用类型值</span><br><span class="line"><span class="number">8</span>: iload_1                                      | 从局部变量 <span class="number">1</span> 中装载 int 类型值</span><br><span class="line"><span class="number">9</span>: iconst_1                                     | <span class="number">1</span>(int) 值入栈</span><br><span class="line"><span class="number">10</span>: isub                                        | 将栈顶两 int 类型数相减，结果入栈</span><br><span class="line"></span><br><span class="line"><span class="number">11</span>: invokevirtual   #<span class="number">24</span>  <span class="comment">// Method rec:(I)I     | 运行时按照对象的类来调用实例方法</span></span><br><span class="line"><span class="number">14</span>: iconst_1                                    | <span class="number">1</span>(int) 值入栈</span><br><span class="line"><span class="number">15</span>: iadd                                        | 将栈顶两 int 类型数相加，结果入栈</span><br><span class="line"><span class="number">16</span>: ireturn                                     | 返回 int 类型值</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> 万次递归，耗时 <span class="number">1</span> ms，速度低下的同时，超过一定数量（≈<span class="number">14940</span>），还会报错 <span class="type">StackOverflowError</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="尾递归"><a href="#尾递归" class="headerlink" title="尾递归"></a>尾递归</h4><figure class="highlight scala"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@tailrec</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tailRec</span></span>(i: <span class="type">Int</span>, iterator: <span class="type">Int</span>): <span class="type">Int</span> =</span><br><span class="line">  <span class="keyword">if</span> (iterator &gt; <span class="number">0</span>) tailRec(i + <span class="number">1</span>, iterator - <span class="number">1</span>) <span class="keyword">else</span> i</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: iload_2                | 从局部变量 <span class="number">2</span> 中装载 int 类型值入栈</span><br><span class="line"><span class="number">1</span>: iconst_0               | <span class="number">0</span>(int) 值入栈</span><br><span class="line"><span class="number">2</span>: if_icmple       <span class="number">16</span>     | 若栈顶两 int 类型值前小于等于后则跳转</span><br><span class="line"></span><br><span class="line"><span class="number">5</span>: iload_1                | 从局部变量 <span class="number">1</span> 中装载 int 类型值入栈</span><br><span class="line"><span class="number">6</span>: iconst_1               | <span class="number">1</span>(int) 值入栈</span><br><span class="line"><span class="number">7</span>: iadd                   | 将栈顶两 int 类型数相加，结果入栈</span><br><span class="line"></span><br><span class="line"><span class="number">8</span>: iload_2                | 从局部变量 <span class="number">2</span> 中装载 int 类型值入栈</span><br><span class="line"><span class="number">9</span>: iconst_1               | <span class="number">1</span>(int) 值入栈</span><br><span class="line"><span class="number">10</span>: isub                  | 将栈顶两 int 类型数相减，结果入栈</span><br><span class="line"></span><br><span class="line"><span class="number">11</span>: istore_2              | 将栈顶 int 类型值保存到局部变量 <span class="number">2</span> 中</span><br><span class="line"><span class="number">12</span>: istore_1              | 将栈顶 int 类型值保存到局部变量 <span class="number">1</span> 中</span><br><span class="line"><span class="number">13</span>: goto            <span class="number">0</span>     | 无条件跳转到指定位置</span><br><span class="line"></span><br><span class="line"><span class="number">16</span>: iload_1               | 从局部变量 <span class="number">1</span> 中装载 int 类型值入栈</span><br><span class="line"><span class="number">17</span>: ireturn               | 返回 int 类型值</span><br><span class="line"></span><br><span class="line"><span class="number">10</span> 亿次尾递归，大约 <span class="number">1</span> ms</span><br></pre></td></tr></tbody></table></figure>
<p>　通过以上 <a href="https://yuzhouwan.com/posts/18651/">Scala</a> 代码 和 对应的 Bytecode 可以分析得出，<a href="https://en.wikipedia.org/wiki/Tail_call">尾递归</a> 作为递归的一种特殊情况，既保证了 代码的 <strong>简洁性</strong></p>
<p>　也因为，尾递归的调用处于函数的末尾，之前函数累计下的所有信息都可以抹除掉。不需要像递归一样，在每次调用之后，都要存储 寄存器值、返回地址 等信息，从而可以避免 栈空间上的消耗，即同时保证了程序的 <strong>高效性</strong></p>
<p>Tips: Full code is <a href="https://github.com/asdf2014/yuzhouwan/tree/master/yuzhouwan-hacker/src/main/scala/com/yuzhouwan/hacker/jit">here</a>.</p>
<h3 id="并发编程"><a href="#并发编程" class="headerlink" title="并发编程"></a>并发编程</h3><h4 id="ReentrantReadWriteLock-锁的公平性"><a href="#ReentrantReadWriteLock-锁的公平性" class="headerlink" title="ReentrantReadWriteLock 锁的公平性"></a>ReentrantReadWriteLock 锁的公平性</h4><p>　提到并发编程，里面可以涉及的东西，包括 线程、锁、多线程、互斥同步、并行、并发（模型）、线程安全、内存模型 等等，足以写成好几本书。但是，这里我们只就一点来讨论，ReentrantReadWriteLock 锁的公平性</p>
<p>　首先，我们需要明确 公平锁（Fair）和 非公平锁（Nonfair）两者在锁机制上有什么区别？前者，加锁前检查是否有排队等待的线程，优先执行已经在排队等待的线程，保证先来先得；后者，则是加锁时不考虑队列中等待的线程，直接尝试获取锁，获取不到再加到队尾等待</p>
<p>　因此，重入读写锁默认的 <strong>非公平锁</strong>，可以避免 ReentrantLock 独占锁带来的吞吐量问题</p>
<p>　那么，进一步思考之后，新问题来了：在什么样的场景下，ReentrantReadWriteLock 的公平锁反而会是更佳的选择呢，为什么，又该怎么做？</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReentrantLockFairness</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> Lock FAIR_LOCK = <span class="keyword">new</span> ReentrantLock(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">static</span> Lock UNFAIR_LOCK = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Fairness</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>{</span><br><span class="line">        <span class="keyword">private</span> Lock lock;</span><br><span class="line"></span><br><span class="line">        Fairness(Lock lock) {</span><br><span class="line">            <span class="keyword">this</span>.lock = lock;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) {</span><br><span class="line">                lock.lock();</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    System.out.print(Thread.currentThread().getName());</span><br><span class="line">                } <span class="keyword">finally</span> {</span><br><span class="line">                    lock.unlock();</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 公平锁，很少会连续获取到锁</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 0 0 0 0 0 1 2 4 3 1 2 4 3 1 2 4 3 1 2 4 3 1 2 4 3</span></span><br><span class="line"><span class="comment"> * 0 1 0 1 0 1 0 1 4 0 1 4 4 4 4 2 2 2 2 2 3 3 3 3 3</span></span><br><span class="line"><span class="comment"> * 1 0 2 4 3 1 0 2 4 3 1 0 2 4 3 1 0 2 4 3 1 0 2 4 3</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fair</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    Thread thread;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) {</span><br><span class="line">        thread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> ReentrantLockFairness.Fairness(ReentrantLockFairness.FAIR_LOCK));</span><br><span class="line">        thread.setName(i + <span class="string">" "</span>);</span><br><span class="line">        thread.start();</span><br><span class="line">    }</span><br><span class="line">    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">}</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 相比公平锁，非公平锁 能经常性地连续获取到锁</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 0 0 0 0 0 3 3 3 3 3 1 1 1 1 1 2 2 2 2 2 4 4 4 4 4</span></span><br><span class="line"><span class="comment"> * 0 0 2 2 2 2 2 4 4 4 4 4 1 1 1 1 1 0 0 0 3 3 3 3 3</span></span><br><span class="line"><span class="comment"> * 1 1 1 1 1 4 4 4 4 4 0 0 0 0 0 2 2 2 2 2 3 3 3 3 3</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unfair</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    Thread thread;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) {</span><br><span class="line">        thread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> ReentrantLockFairness.Fairness(ReentrantLockFairness.UNFAIR_LOCK));</span><br><span class="line">        thread.setName(i + <span class="string">" "</span>);</span><br><span class="line">        thread.start();</span><br><span class="line">    }</span><br><span class="line">    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>　实际在使用的时候，公平锁 只需要在构造参数中设置即可，内部 <strong>AQS</strong>（<strong>A</strong>bstract<strong>Q</strong>ueued<strong>S</strong>ynchronizer）中，利用 相对 ALock 而言空间复杂度更低的 <strong>CLH 队列锁</strong> 来实现公平性</p>
<p>　同时，共享锁 和 独占锁 分别实现了 读写操作，从而读操作之间是没有竞争冲突的，因此 ReentrantReadWriteLock 的最适场景是 <strong>读多于写</strong></p>
<p>Tips: Full code is <a href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-hacker/src/main/java/com/yuzhouwan/hacker/algorithms/thread/lock/ReentrantLockFairness.java">here</a> and <a href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-hacker/src/test/java/com/yuzhouwan/hacker/algorithms/thread/lock/ReentrantLockFairnessTest.java">here</a>.</p>
<h4 id="synchronized-的性能之争"><a href="#synchronized-的性能之争" class="headerlink" title="synchronized 的性能之争"></a>synchronized 的性能之争</h4><p>　在低并发的情况下（$threads \lt 4$），高版本的 JDK 里面 synchronized 实现同步的性能更高。超过 15 个线程之后，则建议使用 <a href="https://yuzhouwan.com/posts/27328/#并发编程">ReentrantLock</a> 可重入锁进行并发控制</p>
<p>　如果可以使用 <a href="https://yuzhouwan.com/posts/31130/#ConcurrentHashMap-如何实现线程安全">ConcurrentHashMap</a> / <a href="https://yuzhouwan.com/posts/31915/#LongAdder">LongAdder</a>（分段锁）实现的应用场景，则尽量避免使用 synchronized 进行实现</p>
<p>　另一方面，synchonrized 方法适用于重复 “释放锁，又获取锁” 的场景。我们可以利用 synchronized 的方法块使得锁，一直被持有，从而提高性能。例如，下面这个 StringBuffer 的场景，增加了 synchronized 块之后，可以使得性能与 StringBuilder 几乎无异</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">StringBuffer buffer = <span class="keyword">new</span> StringBuffer();</span><br><span class="line"><span class="keyword">synchronized</span> (buffer) {</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">9999999</span>; i++) {</span><br><span class="line">    buffer.append(i);</span><br><span class="line">    buffer.delete(<span class="number">0</span>, buffer.length() - <span class="number">1</span>);</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>Tips: Full code is <a href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-hacker/src/test/java/com/yuzhouwan/hacker/algorithms/thread/sync/StringBufferTest.java">here</a>.<br>Tips: ConcurrentHashMap：Java 7 基于分段锁，Java 8 基于 CAS</p>
<h2 id="参数调优层面"><a href="#参数调优层面" class="headerlink" title="参数调优层面"></a>参数调优层面</h2><h3 id="TimeSort"><a href="#TimeSort" class="headerlink" title="TimeSort"></a>TimeSort</h3><h4 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h4><p>　这里，列举技术群（群号见本文末尾）里讨论过的一个问题：ResourceManager crash because TimSort [<a href="https://issues.apache.org/jira/browse/YARN-4743">YARN-4743</a>]</p>
<h4 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h4><p>　依据报错信息，可定位出 Yarn 中 MergeSort 存在问题。随后，怀疑是 JDK7 中为了修复 JDK 本身的漏洞：比较器里面比较的两个值时，如果这两个值同时为空的话，则传入的顺序将决定比较的结果，因而破坏了比较器的 “传递性”。从而，使用 TimSort 替换了默认的 MergeSort 增强了 Comparator 的实现约束。更多可参见 Oracle 官网上已修复的 bugs 的归档列表：<a href="http://bugs.java.com/bugdatabase/view_bug.do?bug_id=6804124">JDK-6804124</a> : Replace “modified mergesort” in java.util.Arrays.sort with timsort</p>
<h4 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h4><p>　最快的解决方式，便是屏蔽 JDK7 中新增的 “传递性” 检查（其实是一种倒退）。具体方式为，在 JVM 中配置 <code>java.util.Arrays.useLegacyMergeSort=true</code>，或者，在程序中设置对应的环境变量 <code>System.setProperty("java.util.Arrays.useLegacyMergeSort", "true")</code></p>
<h4 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h4><p>　最终，该问题在 Hadoop3.x 中得到解决，官方修复了传递性问题，使其满足 TimSort 的规范</p>
<h3 id="G1GC"><a href="#G1GC" class="headerlink" title="G1GC"></a>G1GC</h3><p>　详见：《<a href="https://yuzhouwan.com/posts/31915/#G1GC">ZooKeeper 原理与优化 - G1GC</a>》</p>
<h3 id="LongAdder"><a href="#LongAdder" class="headerlink" title="LongAdder"></a>LongAdder</h3><p>　详见：《<a href="https://yuzhouwan.com/posts/31915/#LongAdder">ZooKeeper 原理与优化 - LongAdder</a>》</p>
<h3 id="AlwaysPreTouch"><a href="#AlwaysPreTouch" class="headerlink" title="AlwaysPreTouch"></a>AlwaysPreTouch</h3><p>　详见：《<a href="https://yuzhouwan.com/posts/31915/#swappiness">ZooKeeper 原理与优化 - swappiness</a>》</p>
<h2 id="语种层面"><a href="#语种层面" class="headerlink" title="语种层面"></a>语种层面</h2><p>　在不同应用场景下，我们要如何选择出合适的 JVM 语言，来满足各种各样的开发需求呢？</p>
<p>　一方面，我们可能需要 Java、<a href="https://yuzhouwan.com/posts/18651/">Scala</a> 此类静态编译的语言，通过编译时检查，来保证代码的安全性和一致性；而另一方面，则希望能够借助 JPython、Groovy 此类的动态语言，快速开发出我们想要的功能。下面，我们举两个比较常见的场景</p>
<h3 id="Scala"><a href="#Scala" class="headerlink" title="Scala"></a>Scala</h3><p>　其一，利用 Scala 的表达性来编写 <strong>Scala Tester</strong>，使得单元测试的代码，更具有可读性</p>
<figure class="highlight scala"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">DefineA</span> </span>{</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) {</span><br><span class="line">    bigMistake()</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="meta">@DefineAnnotation</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">bigMistake</span></span>(): <span class="type">Unit</span> = {</span><br><span class="line">    println(<span class="string">"bigMistake..."</span>)</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">UnitTestStyle</span> <span class="keyword">extends</span> <span class="title">FlatSpec</span></span></span><br><span class="line"><span class="class">  <span class="keyword">with</span> <span class="title">Matchers</span> <span class="keyword">with</span> <span class="title">OptionValues</span> <span class="keyword">with</span> <span class="title">Inside</span> <span class="keyword">with</span> <span class="title">Inspectors</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">class</span> <span class="title">DefineATest</span> <span class="keyword">extends</span> <span class="title">UnitTestStyle</span> </span>{</span><br><span class="line"></span><br><span class="line">  <span class="string">"DefineA's bigMistake method"</span> should <span class="string">"output a information"</span> in {</span><br><span class="line">    <span class="keyword">new</span> <span class="type">DefineA</span></span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>Tips: Full code is <a href="https://github.com/asdf2014/yuzhouwan/tree/master/yuzhouwan-bigdata/yuzhouwan-bigdata-spark/src/test/scala/com/yuzhouwan/bigdata/spark">here</a>.</p>
<h3 id="Groovy"><a href="#Groovy" class="headerlink" title="Groovy"></a>Groovy</h3><p>　其二，利用 Groovy 的简洁语法、开放类特性等，来完成 <strong>DSL</strong></p>
<figure class="highlight groovy"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> invokeMethod(String name, args) {</span><br><span class="line">  print <span class="string">"&lt;${name}"</span></span><br><span class="line">  args.each {</span><br><span class="line">    arg -&gt;</span><br><span class="line">      <span class="keyword">if</span> (arg <span class="keyword">instanceof</span> Map) {</span><br><span class="line">        arg.each {</span><br><span class="line">          print <span class="string">" ${it.key} ='${it.value}' "</span></span><br><span class="line">        }</span><br><span class="line">      } <span class="keyword">else</span> <span class="keyword">if</span> (arg <span class="keyword">instanceof</span> Closure) {</span><br><span class="line">        print <span class="string">'&gt;'</span></span><br><span class="line">        arg.delegate = <span class="built_in">this</span></span><br><span class="line">        <span class="keyword">def</span> value = arg.call()</span><br><span class="line">        <span class="keyword">if</span> (value) {</span><br><span class="line">          print <span class="string">"${value}"</span></span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">  }</span><br><span class="line">  println <span class="string">"&lt;/${name}&gt;"</span></span><br><span class="line">}</span><br><span class="line">html {</span><br><span class="line">  head {</span><br><span class="line">    meta {</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  body {</span><br><span class="line">    table(<span class="attr">style:</span> <span class="string">'margin:2px;'</span>) {</span><br><span class="line">      tr(<span class="string">'class'</span>: <span class="string">'trClass'</span>, <span class="attr">style:</span> <span class="string">'padding:2px;'</span>) {</span><br><span class="line">        td { <span class="string">'http://'</span> }</span><br><span class="line">        td { <span class="string">'yuzhouwan.'</span> }</span><br><span class="line">        td { <span class="string">'com'</span> }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>Tips: Full code is <a href="https://github.com/asdf2014/yuzhouwan/tree/master/yuzhouwan-hacker/src/main/groovy/com/yuzhouwan/hacker/dsl">here</a>.</p>
<h2 id="内部机制"><a href="#内部机制" class="headerlink" title="内部机制"></a>内部机制</h2><h3 id="实时-GC-的原理"><a href="#实时-GC-的原理" class="headerlink" title="实时 GC 的原理"></a>实时 GC 的原理</h3><p>　首先，需要明确定义什么是实时 GC（RTGC，Real-time Collection），即真正的 RTGC 要求对 GC 中 Mutator 赋值器的中断进行精确的控制</p>
<p>　常见的回收器 和 实时 GC 调度策略，有如下实现：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">回收器 Collector</th>
<th style="text-align:center">工作机制</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">万物静止式回收器 Stop-the-world collector</td>
<td style="text-align:center">Mutator 在内存分配，发现内存不足时，发起 GC</td>
</tr>
<tr>
<td style="text-align:left">增量式回收器 Incremental collector</td>
<td style="text-align:center">要求 Mutator 不仅在内存分配时，还需要在 访问堆（<a href="https://zh.wikipedia.org/wiki/%E5%86%85%E5%AD%98%E5%B1%8F%E9%9A%9C">利用 “读写屏障” 的部分有序 来提高性能</a>）的时候检查是否需要发起 GC</td>
</tr>
<tr>
<td style="text-align:left">并发回收器 Concurrent collector</td>
<td style="text-align:center">GC 与 Mutator 的工作 并发执行</td>
</tr>
</tbody>
</table>
</div>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">GC 调度 Scheduling</th>
<th style="text-align:center">调度机制</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">基于工作的调度 Work-based scheduling</td>
<td style="text-align:center">按照 Mutator 的每个工作单元分配 GC 任务</td>
</tr>
<tr>
<td style="text-align:left">基于间隙的调度 Slack-based scheduling</td>
<td style="text-align:center">实时任务的调度间隙完成 GC</td>
</tr>
<tr>
<td style="text-align:left">基于时间的调度 Time-based scheduling</td>
<td style="text-align:center">预留出独占式的 GC 时间</td>
</tr>
<tr>
<td style="text-align:left">整合式的调度 <code>税收与开支</code> 策略 Tax-and-Spend</td>
<td style="text-align:center">允许不同的线程可以有着不同的 Mutator 使用率，通过线程分配的弹性，尽可能地减少线程中断</td>
</tr>
</tbody>
</table>
</div>
<p>　实际上，对吞吐量的提高 和 时间窗口、延时的缩小，在 Tax-and-Spend 调度策略 应用到 <a href="http://researcher.ibm.com/researcher/files/us-hindm/Bacon.pdf">Metronome 回收器</a> 之后，得以证实</p>
<h3 id="沙箱"><a href="#沙箱" class="headerlink" title="沙箱"></a>沙箱</h3><p><img data-src="/picture/jvm/jvm_sandbox.jpg" alt=""></p>
<center>（利用 <a href="https://github.com/staruml" target="_blank">StarUML</a>™ 绘制而成）</center>





<h3 id="ClassLoader-隔离"><a href="#ClassLoader-隔离" class="headerlink" title="ClassLoader 隔离"></a>ClassLoader 隔离</h3><p>　初步了解 JVM 沙箱的原理之后，我们便可以尝试解决一些安全性相关的问题了。下面以大型项目中，经常会遇到的依赖冲突问题为例。介绍一种以 ClassLoader 隔离来解决该问题的方式</p>
<h4 id="场景描述"><a href="#场景描述" class="headerlink" title="场景描述"></a>场景描述</h4><p>　<a href="https://yuzhouwan.com/posts/5845/">Apache Druid</a> 中 com.sun.jersey（1.19）和 Dataflow 中 org.glassfish.jersey（2.25.1）冲突问题</p>
<p>Tips: Dataflow 是自研的、类似于 <a href="https://yuzhouwan.com/posts/26002/#Kafka-Connect">Kafka Connect</a> 的框架</p>
<h4 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h4><h5 id="方案一"><a href="#方案一" class="headerlink" title="方案一"></a>方案一</h5><p>　Apache Druid 中升级 Jersey（但是大面积改动开源社区的代码，不利于后期升级与维护）</p>
<h5 id="方案二"><a href="#方案二" class="headerlink" title="方案二"></a>方案二</h5><p>　降级 Dataflow 中的 Jersey（后续再接入其他的组件，Jersey 又不一样了，又该如何协调；降级后，可能部分功能不支持；改造的工作量也不小）</p>
<h5 id="方案三"><a href="#方案三" class="headerlink" title="方案三"></a>方案三</h5><p>　使用其他的 RESTful 组件（Dropwizard / Ninja / Play / RestExpress / Restlet / Restx / SpringBoot / RestEasy 等）</p>
<p>　简单调研后，首选 RestEasy，不像 SpringBoot 那么重，比 Jersey 性能更好</p>
<h5 id="方案四"><a href="#方案四" class="headerlink" title="方案四"></a>方案四</h5><p>　把 Dataflow 里面的依赖，都用 shade 隐藏起来，可以彻底解决和其他接入组件的依赖冲突的问题，避免后续又发现除了 Jersey 其他的冲突</p>
<p>　同时，因为 glassfish 里面存在类似 <code>public static class Builder implements javax.ws.rs.client.Invocation.Builder</code> 全限定名的写法，是无法被 shade 的，所以只能 shade 去隐藏 <code>com.sun.jersey</code></p>
<p>Tips: Shade 插件的具体使用方法，详见《<a href="https://yuzhouwan.com/posts/2254/#Shade-插件解决-Jar-多版本共存">Maven 高级玩法</a>》</p>
<h5 id="方案五"><a href="#方案五" class="headerlink" title="方案五"></a>方案五</h5><p>　使用 ClassLoader 或者 OSGi 进行隔离（同时，还可以将 Dataflow 里面的 K2H / K2ES / K2D 组件做成 <strong>热部署</strong>）</p>
<p>　另外，前不久刚 release 的 Java 9 中的模块化，也可以完成组件隔离的工作。不过，考虑到需要保证生产级应用的 SLA 要求，暂不采用（截止 2018-6-5 <a href="http://www.oracle.com/technetwork/java/javase/downloads/java-archive-javase9-3934878.html">JDK 9</a> 最新 release 版本为 v9.0.4）</p>
<h4 id="优缺点"><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h4><div class="table-container">
<table>
<thead>
<tr>
<th></th>
<th>优势</th>
<th>劣势</th>
</tr>
</thead>
<tbody>
<tr>
<td>ClassLoader</td>
<td>实现简单</td>
<td>复杂功能，实现相对困难</td>
</tr>
<tr>
<td>OSGi</td>
<td>OSGi 规范有很多成熟的框架；<br>轻松实现模块化，插件式加载卸载组件；<br>支持热部署</td>
<td>框架过重，容易引入风险</td>
</tr>
<tr>
<td>Java 9 Module</td>
<td>从 JVM 内核层面对模块化进行支持</td>
<td>目前尚未成熟</td>
</tr>
</tbody>
</table>
</div>
<h4 id="编码实战"><a href="#编码实战" class="headerlink" title="编码实战"></a>编码实战</h4><h5 id="组件拆分"><a href="#组件拆分" class="headerlink" title="组件拆分"></a>组件拆分</h5><p>Tips: 如何利用 assembly 插件对项目进行组件拆分，详见我的另一篇博客《<a href="https://yuzhouwan.com/posts/2254/#Assembly-插件">Maven 高级玩法</a>》</p>
<h5 id="判断是否为父子类关系"><a href="#判断是否为父子类关系" class="headerlink" title="判断是否为父子类关系"></a>判断是否为父子类关系</h5><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 如果是由不同的 ClassLoader 加载的，即使是父子类关系，仍然无法做类型转换</span></span><br><span class="line"><span class="comment">// 不过可以通过 序列化 / 反序列化 的方式，绕过这个问题</span></span><br><span class="line">assertEquals(<span class="keyword">true</span>, A.class.isAssignableFrom(B.class));</span><br><span class="line">assertEquals(<span class="keyword">true</span>, B.class.isAssignableFrom(C.class));</span><br><span class="line">assertEquals(<span class="keyword">true</span>, A.class.isAssignableFrom(C.class));</span><br><span class="line">assertEquals(<span class="keyword">true</span>, A.class.getClassLoader().equals(B.class.getClassLoader()));</span><br><span class="line">assertEquals(<span class="keyword">true</span>, B.class.getClassLoader().equals(C.class.getClassLoader()));</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">A</span> </span>{</span><br><span class="line">}</span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">implements</span> <span class="title">A</span> </span>{</span><br><span class="line">}</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> <span class="keyword">extends</span> <span class="title">B</span> </span>{</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>Tips: Full code is <a href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-hacker/src/test/java/com/yuzhouwan/hacker/jvm/ClassTest.java#L18">here</a>.</p>
<h5 id="子类强转为父类"><a href="#子类强转为父类" class="headerlink" title="子类强转为父类"></a>子类强转为父类</h5><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">boolean</span> failed = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">try</span> {</span><br><span class="line">    B b = (B) C.class.newInstance();</span><br><span class="line">} <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">    failed = <span class="keyword">true</span>;</span><br><span class="line">}</span><br><span class="line">assertEquals(<span class="keyword">false</span>, failed);</span><br><span class="line">failed = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">try</span> {</span><br><span class="line">    C c = (C) B.class.newInstance();</span><br><span class="line">} <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">    failed = <span class="keyword">true</span>;</span><br><span class="line">}</span><br><span class="line">assertEquals(<span class="keyword">true</span>, failed);</span><br></pre></td></tr></tbody></table></figure>
<p>Tips: Full code is <a href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-hacker/src/test/java/com/yuzhouwan/hacker/jvm/ClassTest.java#L35">here</a>.</p>
<h5 id="对不同-ClassLoader-下的类进行类型强转"><a href="#对不同-ClassLoader-下的类进行类型强转" class="headerlink" title="对不同 ClassLoader 下的类进行类型强转"></a>对不同 ClassLoader 下的类进行类型强转</h5><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">currentThread().setContextClassLoader(newClassLoader);</span><br><span class="line"><span class="keyword">try</span> (ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">     ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(baos)) {</span><br><span class="line">    oos.writeObject(clazz.newInstance());</span><br><span class="line">    <span class="keyword">try</span> (ByteArrayInputStream bais = <span class="keyword">new</span> ByteArrayInputStream(baos.toByteArray());</span><br><span class="line">         ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(bais) {</span><br><span class="line">             <span class="meta">@Override</span></span><br><span class="line">             <span class="keyword">protected</span> Class&lt;?&gt; resolveClass(ObjectStreamClass desc) {</span><br><span class="line">                 String name = desc.getName();</span><br><span class="line">                 <span class="keyword">try</span> {</span><br><span class="line">                     <span class="comment">// 这里需要覆写 resolveClass 方法，否则默认会在 readObject 的时候，</span></span><br><span class="line">                     <span class="comment">// 用 sun.misc.VM#latestUserDefinedLoader 对 Class 进行解析判断，</span></span><br><span class="line">                     <span class="comment">// 并报错 “无法进行类型强转”</span></span><br><span class="line">                     <span class="keyword">return</span> Class.forName(name, <span class="keyword">false</span>, newClassLoader);</span><br><span class="line">                 } <span class="keyword">catch</span> (ClassNotFoundException ex) {</span><br><span class="line">                     <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(ex);</span><br><span class="line">                 }</span><br><span class="line">             }</span><br><span class="line">         }) {</span><br><span class="line">        <span class="keyword">return</span> newClassLoader.loadClass(DataflowBase.class.getName()).cast(ois.readObject());</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h5 id="自定义-ClassLoader"><a href="#自定义-ClassLoader" class="headerlink" title="自定义 ClassLoader"></a>自定义 ClassLoader</h5><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.net.URLClassLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PluginClassLoader</span> <span class="keyword">extends</span> <span class="title">URLClassLoader</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String JAR_POSTFIX = <span class="string">".jar"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String URL_PROTOCOL_FILE = <span class="string">"file"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> {</span><br><span class="line">        ClassLoader.registerAsParallelCapable();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PluginClassLoader</span><span class="params">(ClassLoader parent, String... jarPaths)</span> </span>{</span><br><span class="line">        <span class="keyword">super</span>(<span class="keyword">new</span> URL[]{}, parent);</span><br><span class="line">        <span class="keyword">for</span> (String jarPath : jarPaths) loadJar(jarPath);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PluginClassLoader</span><span class="params">(String... jarPaths)</span> </span>{</span><br><span class="line">        <span class="keyword">super</span>(<span class="keyword">new</span> URL[]{}, <span class="keyword">null</span>);   <span class="comment">// MUST NOT: set parent classLoader as null!</span></span><br><span class="line">        <span class="keyword">for</span> (String jarPath : jarPaths) loadJar(jarPath);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; loadClass(String name) <span class="keyword">throws</span> ClassNotFoundException {</span><br><span class="line"><span class="comment">//        System.out.println(String.format("Loading class: %s...", name));</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.loadClass(name);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.findClass(name);</span><br><span class="line">        } <span class="keyword">catch</span> (ClassNotFoundException e) {</span><br><span class="line">            <span class="keyword">return</span> PluginClassLoader.class.getClassLoader().loadClass(name);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadJar</span><span class="params">(String dirPath)</span> </span>{</span><br><span class="line">        File dir = <span class="keyword">new</span> File(dirPath);</span><br><span class="line">        <span class="keyword">if</span> (!dir.exists() || !dir.isDirectory()) <span class="keyword">return</span>;</span><br><span class="line">        File[] files;</span><br><span class="line">        <span class="keyword">if</span> ((files = dir.listFiles()) == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">for</span> (File file : files) {</span><br><span class="line">            <span class="keyword">if</span> (file == <span class="keyword">null</span> || !file.isFile() || !file.getName().endsWith(JAR_POSTFIX)) <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="keyword">this</span>.addURL(file);</span><br><span class="line">            } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line"><span class="comment">//                e.printStackTrace();    // skip failed url.</span></span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addURL</span><span class="params">(File file)</span> </span>{</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">super</span>.addURL(<span class="keyword">new</span> URL(URL_PROTOCOL_FILE, <span class="keyword">null</span>, file.getCanonicalPath()));</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(String.format(<span class="string">"Cannot add url [%s]!"</span>, file.getAbsolutePath()), e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h5 id="主体逻辑"><a href="#主体逻辑" class="headerlink" title="主体逻辑"></a>主体逻辑</h5><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 通过 ClassLoader 的反射进行对象初始化</span></span><br><span class="line"><span class="comment">// 并使用对象流，避免不同 ClassLoader 之间类型转换的问题</span></span><br><span class="line">(String type) -&gt; AccessController.&lt;AbstractBean&gt;doPrivileged(</span><br><span class="line"> (PrivilegedAction) () -&gt; {</span><br><span class="line">     ClassLoader old = currentThread().getContextClassLoader();</span><br><span class="line">     <span class="keyword">try</span> {</span><br><span class="line">         Class&lt;? extends AbstractBean&gt; parse = (Class&lt;? extends AbstractBean&gt;) AbstractBean.parse(type);</span><br><span class="line">         <span class="keyword">final</span> PluginClassLoader plugin = PluginUtils.CLASSLOADERS.get(type);</span><br><span class="line">         currentThread().setContextClassLoader(plugin);</span><br><span class="line">         <span class="keyword">try</span> (ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">              ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(baos)) {</span><br><span class="line">             oos.writeObject(parse.newInstance());</span><br><span class="line">             <span class="keyword">try</span> (ByteArrayInputStream bais = <span class="keyword">new</span> ByteArrayInputStream(baos.toByteArray());</span><br><span class="line">                  ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(bais) {</span><br><span class="line">                      <span class="meta">@Override</span></span><br><span class="line">                      <span class="keyword">protected</span> Class&lt;?&gt; resolveClass(ObjectStreamClass desc) {</span><br><span class="line">                          String name = desc.getName();</span><br><span class="line">                          <span class="keyword">try</span> {</span><br><span class="line">                              <span class="keyword">return</span> Class.forName(name, <span class="keyword">false</span>, plugin);</span><br><span class="line">                          } <span class="keyword">catch</span> (ClassNotFoundException ex) {</span><br><span class="line">                              <span class="keyword">throw</span> <span class="keyword">new</span> FmException(ex);</span><br><span class="line">                          }</span><br><span class="line">                      }</span><br><span class="line">                  }) {</span><br><span class="line">                 Object readObj = ois.readObject();</span><br><span class="line">                   <span class="keyword">return</span> (AbstractBean) readObj;</span><br><span class="line">                 <span class="keyword">return</span> plugin.loadClass(AbstractBean.class.getName()).cast(readObj);</span><br><span class="line">             }</span><br><span class="line">         }</span><br><span class="line">     } <span class="keyword">catch</span> (InstantiationException | IllegalAccessException | IOException | ClassNotFoundException e) {</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">     } <span class="keyword">finally</span> {</span><br><span class="line">         <span class="keyword">if</span> (old != <span class="keyword">null</span>) currentThread().setContextClassLoader(old);</span><br><span class="line">     }</span><br><span class="line"> });</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断传入的 type 类型是否是合法的</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; parse(String type) <span class="keyword">throws</span> FmException {</span><br><span class="line">    Type subType = Type.OTHER;</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        subType = Type.valueOf(type.toUpperCase(Locale.ENGLISH));</span><br><span class="line">    } <span class="keyword">catch</span> (IllegalArgumentException ignored) {</span><br><span class="line">    }</span><br><span class="line">    String className = type;</span><br><span class="line">    <span class="keyword">if</span> (!Type.OTHER.equals(subType)) className = subType.getTypeName();</span><br><span class="line">    <span class="keyword">return</span> PluginUtils.parseType(type, className, AbstractBean.class);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 依据 type 类型加载指定目录下的依赖包，并加载对应的 class</span></span><br><span class="line"><span class="meta">@SuppressWarnings("unchecked")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Class&lt;?&gt; parseType(String type, String className, Class&lt;T&gt; base) <span class="keyword">throws</span> FmException {</span><br><span class="line">    ClassLoader oldClassLoader = currentThread().getContextClassLoader();</span><br><span class="line">    ClassLoader systemClassLoader = ClassLoader.getSystemClassLoader();</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        PluginClassLoader pc;</span><br><span class="line">        <span class="keyword">if</span> (!CLASSLOADERS.containsKey(type))</span><br><span class="line">            pc = <span class="keyword">new</span> PluginClassLoader(<span class="comment">/*oldClassLoader*/</span>systemClassLoader,</span><br><span class="line">                    getPluginPathByTypeName(type), getCommonPath());</span><br><span class="line">        <span class="keyword">else</span> pc = CLASSLOADERS.get(type);</span><br><span class="line">        currentThread().setContextClassLoader(pc);</span><br><span class="line">        Class&lt;?&gt; baseClazz = pc.loadClass(base.getName());</span><br><span class="line">        Class&lt;?&gt; subClazz = pc.loadClass(className);</span><br><span class="line">        <span class="keyword">if</span> (baseClazz.isAssignableFrom(subClazz)) {</span><br><span class="line">            CLASSLOADERS.put(type, pc);</span><br><span class="line">            <span class="keyword">return</span> subClazz;</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(String.format(<span class="string">"Class %s is not a child of %s!"</span>, className, base.getName()));</span><br><span class="line">    } <span class="keyword">catch</span> (ClassNotFoundException e) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unable to load type: "</span>.concat(className), e);</span><br><span class="line">    }<span class="comment">/* finally {</span></span><br><span class="line"><span class="comment">        currentThread().setContextClassLoader(oldClassLoader);</span></span><br><span class="line"><span class="comment">    }*/</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>Tips: Full code is <a href="https://github.com/asdf2014/yuzhouwan/tree/master/yuzhouwan-hacker/src/main/java/com/yuzhouwan/hacker/jvm/classloader">here</a>.</p>
<h3 id="内存模型"><a href="#内存模型" class="headerlink" title="内存模型"></a>内存模型</h3><p>　内存模型中，主要的组成分为 <strong>主内存</strong> 和 <strong>工作内存</strong> 两部分（线程访问工作内存，工作内存通过 8 种原子性的操作，来和主内存交互），特性包括 <strong>原子性</strong>、<strong>可见性</strong> 和 <strong>有序性</strong>（其中，有序性 由 volatile / synchronized / happens-before 原则 来保证）</p>
<p><img data-src="/picture/jvm/jvm.png" alt=""></p>
<center>（利用 <a href="https://products.office.com/en-us/visio/visio-online" target="_blank">Visio</a>™ 绘制而成）</center>



<p><br></p>
<p>　相信熟知 JVM 相关知识，对于提升日常编程水平，还有很多方面可以探索。限于本人有限的水平，暂时只能总结出以上几点。希望此文能起到抛砖引玉的作用，期待各位精彩的观点和建议 ^_^</p>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt=""></a></td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>语言</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Groovy</tag>
        <tag>Scala</tag>
        <tag>JVM</tag>
      </tags>
  </entry>
  <entry>
    <title>梳理微积分知识体系</title>
    <url>/posts/200726/</url>
    <content><![CDATA[<div id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">
  <div class="hbe-input-container">
  <input type="password" id="hbePass" placeholder="" />
    <label for="hbePass">Hey, password is required here.</label>
    <div class="bottom-line"></div>
  </div>
  <script id="hbeData" type="hbeData" data-hmacdigest="aa63deffb6311d754c10dc4e27c461d6f530bc23bb18e778d7ec1ae6fc6a5ac8">167d41afdf7bb91ee34f3a44a7674c2b774a024a8748dcf1d2f48061d7e36831cfc203cef7d24de7beebc3667b3552ffb42ef7c6dc9d618dd8c787e501806a862f2633fdf8a9742ad9a2e0e296303b77787d595399f7bdd306717bc82359b9c79c770df0ebee54540fa3a0760dd7ebd367b779ab32007d8999f32024fe1bae19c506031d0cb1eb1a6fd35ccf9f57c35f1749c6997c6fa926e5f3513c2427867f06352ada9ec52e096506daff5506bb204c079b3e494ebdf08c2f3b653a566e44fd60165bc66c4ff7b016cd7ca004c1c56cc6f13ee2cc3cc51b42999c8c0f3664019b8b6630d8bef895a1d4ed6ea77c7986664e550964bc274054411302047129bb50a8f832660c188bfa7b8b64db0f659443284b57daa4fa25dee127541870de6fa42072d5e8b6bd8e98cba237c7d4070e6e2b6c2e4c6514576ee694cb9210fc08cf7573ae34e0c78c7601b8d86036ca37d2d80f756853ebc75103e4a2af4b60f622ec3f9f6a86878a1eb40a8cdbad0524f77163b3842f002cdf921322630fb0b810d79a7a8d9ca380c36bf1c1128f6386b444765a35de1d5b222e52ed3d81e61f99b40f60610debea3f8046259d850c71b016f6c440cfc2e60edb5ebc6ae502e7bf11f1a5a07f03005cd723ac0938101883c694eddfb70c9b0ce2c678410a1fb5a1a79c0bbf1da94bfc0016d229deca1ba20973de8f1ad58c55eb3b05b9df9be8bf185f7d21651f83ed4888b3cbf86e2389659f43dbcf6824f748bdee1c57f2c395853819628bf16fd572f0b1bc89c598026c6cc9725c582d2bc2f6ecfba7b41a54e2c1d717dd447788d3199fd14d55af89cc67b2d7584b79b861ccbb5cbc7256806dc658930c7a54a7ab4f8da610a8d56f49b1f9190f92e64f345062f48f0d48d1d192c01b7fa956650babab311afe34c25c5247d61d78f6171f9fde732daa98cf5d7b4b7c61a75eeee7369163c2e7897092b7bc133b2959a9e21e5c3f434c7b346b97363ac2ad7c59d799673e8f89999436405724302e735b6d08604097745ba50e5ca562f4ccd0edc9d819f0023877fdad713b462092ed8dc4944e721febb2ed61c3f21cef2ed862d29fce77731d79f50712b13bbb83d93b80ad1cdac13fd45db1b771f2352c51bc6e2be70bed76c58a778a4de5558d24e01447dd17a32c2b71787bf59a03222d179d6b278bdbdb019206273075e69152c913228df8509efe2c6269807a34ed959554a43fc128ef457f7a20defdddf3ea5a3733155917a262bf451e19d3e586d052670ffdbaf4495d1b7457cdeb8759bfb527aed40ace63c3e97ff6ade4fd01bc6331872ed9f2b1983ee2d06fed2237f76ab0ef298588a724f7a0009176c01c1112ea335dd4bd05e1a26f265393d48da16aba6d0559905a7f076c8056af3dea39f0c5658151363fc5d1547fa665d8bd108ecfae3c3a8d3a5ad521c5c6a40ee2b6ddad7e8cc24a37e0675bf6162151e37b185c5182b375ebe50ae7c353adf14520e92eb0ad2219e92df1839bee72429024bc9215896601e016c5faaaadeb945edfa14d8dd3e1796a8c05efece8e1a85f2cfd93fdb9c5335543b8c57512be42baa326d11bead992cba302a6558ce89907b3715df2086f5716ac08547bddb4bd27e87a3ccc845f3ec59bb4ef58210571624aad9f9dd472c63ea562839ace384cdebed2f2a69412248a44158c19389e986b4ac7a9c5564117cce4a329bd5daccfaa6311c6543f9931c2271cd1cedf251b962c56398e419ecaffba90b9411f5e4e41ba9aa91d9cbdd4543ee8b6ad2bb222259b4408d7215291f9553b49da1fbbb9183ed325532fa293fd232bbcfca75b88111a5fb4b4c01880eebea749904f5dac14f99f4edd7759bf9b6f61c461ff418f568958fa26ae3ff8e37fc7ee9041e71567b22bd444e0181d2ccac6cafc512a15956a71c583eabf73c0403d334f2a0d68fa67b375ed31dee869eb638442dcc8a3d3b7b68cc8a7182b007e9f286a6be7660d268a4c4c34d985a32fcea62f7d858199dd93415f545be57394c186aa64c54fe0490abf08d1ccf32128b9639e840fa932e26a9da562fd9bfaf9e542fb729e5027eea0078989c44896414ce7c566721a081267eb9879012054143b937d44ffe2a5b076f05c5b77a79d8ea9ee643d4e102c1601671f41165de2a45b111c0c0442fcc6d1bfa3068f07e5848663e140d9e07c65ed46a4d7b60341c7f927ccdb31968a2db2efd6d6c3c4416aac9b3d92d6131d5698e713607e9199b036fc135fef25a0b9833701788384c9b3e430950abc370fa269509cedd20b0b190af92adcbe3f4c6dfd44961e1dddea79388514ced05ef9a2cb00aa7a4cc4290f53ac9878981100cb4dc50c65b95b6186c14413dd50620ea511aa61be0ccf5974bf9706f9377b1a584e6e39309c91dbd021560ae95465af9f57fb0f4920edb6a7902455eb12059246691c7bfd118255229c2df69a87993e1a466dfb149834538b212f312552d3390120f45c8df38892281b4032b9634880ac58093d988820b7a669b338ea933587d73e869c1c354dca445868395e695e4ffcab90f40acf305a10c22906b6f695415150fd7d1f5b971f7e058a3f823f566982ba2183ae67b1992dfb938744d2e5fa2026bf0b5f95dd1930feea84d2221d6981d3784e3a8b9d44118da05816acbdde79b07f56c20fca36f9b14d3c4ecdaf25bade2455b66422c18f3f07a1a7c0a43dd7fb86b8750445434cf7fd3cf957bf7b987e3c26c252ed64b31c312a63825c6753dfe014aa67c98056850ed2bf742a23cbaa5285e14883841d5bfb68478a0bcac817d881c4e1fd0920653a2864d1d36ec1bb841b4f419b23cf2f6efe3db4493054a1d6c9e5aa38d5da69bf7a1257725bcd20c834f47b3c4a1767dd0e4335e64a1ede605f772a5fc0a75e6cc0756a86e2ace64533c18d283d300aab9a3dfdb6b79ce4e1b0dd658b34623c281059cabccba859b81f5f906d36f47fc2715d12f90bfa67aa8d979c337f81e7ee1b4d29d20e6faeacecdf6c3e947fe678f0daa2142874f11f35e536c08a52d18c2cd8e4562d7e20e7262d6f469ea1085c960366a1ce144662364c6bf7a126605b96eda28ff6400199c0ba39f0bec50a6df7ac9c4008015efebb5fff43d55fd145a1fba871ab7e0f481026cafef4674bd29cb47858c9073eda9d69f129f9895f552c983801e454fd3c27f585eea934c994d5371c96da328246ed34ea1c111953a938d05fb7d9b4739151a1f9b8aca3033fc9ce480e4bd44704276cc320449763e80063ee7ded50d5aed971ae3056e6c09dc4f3e9193c58763598cfeb0b5f4f3ce125603fd63f29dc07e1b2bb6c8d7a1d3aeafbf3ddf85137eb5071e7379d458c9ba2660ce5b0d10c347a223ceca19537c395ab3e48afc509fe076206af4ce841300a6a36e50eaac25312d27c97064844057cf36ac6302a5d7b3b5ef2d1a727983794642b820a88e763ee17cbf12e5c7c6f2047b5134ee70f5af5ecc3f9d58cbb6d35dc722fec268ab6116658cffe2072ddf714c172520854209523b34c6a4e75c73a0399dba92c306099f7a52024677fae2ab0996ce52bc7c392cb68feefd8f4523c750b3d2aa7c7e91316517430f68806155a14d256c2b6e09a528712fcc18ee545a3668c85cca615d5f31e3d68b68c0e5d1e30b184afd56b5e28820cd752ab5c9bb2c83d9b1718c6acf8468f978192f41434be01d17dba98a84d13c22f1fbb4d5de5fcdef2ca31655bb5e1896bdb5d42899d8a753e7c3ebabd934b55fa4686de0f168edcc4ab8a82b2250b23906e3457504c0f17ce61948edd3d473c6ea6e11620459c795a5ca72bb326f81503f8bb4387088ced569cb05efaed03e66c74b1a871bf72f8bda250bf26776e5b629ee759fc50281f6564d3619027ef9156a68caf1a0c6424c4e7da0164d5c8e2b3c3fc6e2c54a1187d5d8fa76e6af4d1ba796f674d01ed9f7e2ae27d34af97b8d864f1b3d20476011897f441a8a685e02251046fbd9c9bb21f97683ca3f15849ac8f31d781817c42a4e4310ce0178fb6a415288c971f958fc763de6dd839fd83469179bace14fdb3ada172bce7b89913124c555dbf1902256eb2da509b82cf04a9b373f29d6c9f22a347917ae4f624465af1c6fcd27274d2d3fe2ba05ee7afa0b1208bbbaf0359e8c3732b2fc410ed57f4d03a49173e300adddda59502656022f8ea272d1a18ae992da6abac8e372270124e6e41843e9bb3bbff6b449bb71950d9134c939bb126117cbb37b21b61e7730156aaa6a411e61962eeae69d88afacd3f307a2c89688f29e131cc8a2c0deae58bd75be0b141d27d1fed616b38cc1c9db1ac6b26a468b6de2ead3ead71230af94132a676d6a6f70f6850525438bada5c3cc023a06b8530638bc272e35b028b260877d99ebecdb0cff05ef6f9c4266c51a5862e62b8815dc60ab32d6cfbca6e523882e995cfacfb65bb65c6df86a57ce39686e2d298bc41dd501579579151d6baf6c911998fe42bbd91b0f54abffa446c7759c6e15356344b9c6de9dc889dede280dc933c72b307e5df0cee895d20bde9bd8926f18b18c7e0327ec19c2fdbc9450444e419d9b596b52ec701451f3748a41793ba4536edb8d78901ec832cbd6b593015668aee7fdc80526c7b59d4d7a97213d878e5607dbf0fc8c22728a5a6d40bc39fd93602cf3af82c3138fea20478bdaa4fd0b0640ca3f27a2be1847eb8afce396784c91713df0c149d1bdff393db7e1cb26f56bdc480ecb2e3ad8ce927ac25ff81166785ce457a08eec13cc0f099219b9d3dee5fc9865d8aed1927f290efb164ecac4f6f5b6a31734c9525d180dfbc648a3269b0c498b159c596a5ec32ff3c6552a973df4f98c5cb2a035c14f04c129aca5c96edc3549be47f85945cbe69e4856041d84ffe77b16672fd24c00d17aa16c411057b60d059d2487ed7790df1bb10486df6d6903601afddf62a5ef5bd55a48d704a07e643d6e59fcff493fecaa8934e60ada23bed4ef188c88a54c78937ca298d79422a8319d50a27925c315a857ec8664481fa34dbdcef91a495a5b8a5160bdd1863390ef10afc589ef92b93c1a572093c813dbfc1667a65d3bb4f1613790d31929695e6c8aa24d836152d3d084cd9bf694cbed5a5cb1612a1fc55af8dda56d13a64359122379cf35a8d8e26d25b3ecf8ce0bb10a4842a173f44c6692a7a82cfd99cfa66e686c7d91aae2c903aae2b51b69e3b1413a3ac4a0ab0e075785f76cd6650cdf7eaa56bb7a55ac3a600cbb9e35fc67e088e5531a430b78aa7a26a0c0116acbc7f57a0c5f985e6cf474fe9d63be4e403107a0131edd226ba5182a1577935ad2d6674e6c6b2336dcaab8ac1a4c0cdc562f07f2a4e3223c3047364eda6302aaba18f0b11d4eddf4196969b6ffcfc7b8717e5cf56e798d6f4733b9baff5af20714000415196e8b52877f84847004a3cc131e8898177dae0b6a42a8bffc686df769bcabb0bd9d7d9d6a09e681d9db9d2d7b62bc30cdabb83b7c7ef06abdcfbd94edb242fa0468d03528891455479e1ae3812b413aed23e555980674bdffbc28444e23d423fdbc38c2d451fc7918b18c67b251f40b0e07c1aceebf04e2d734c3fc2c465cc97f3cecb28ebad4886b0cff7deb0f9af5b96466491bec0404b56f15ebfae01b8c7e3072e31c94af8f308c4b21a52b67f23070bc206423428fd7de5b6ff69ade9ae5d82943fe3dffd0300219953b09acdd77567d6ece964a082aa555e92743d9befa52f1f676d4c416f57d4aef363c7c6998e023bedaf645711b197bc892bc23d92f18bcd131ce8923878633ee5ed93cc89baa4e50e3b97904a79ab569811e7bd0556efdf8f31a957aa69883983fc8d350795b0f4c7face181ae4d923452876a4e6a5911a8ddbfe0e6cbfb2699a67ada7e9b01b79a769f411780e6066f4e981778296f318c536a68f5fd4b7cd084c9e263afd22395e6edfbf5939654a2264cf64fecdb4dd01901817492db98844e867d33193ed5fcf87f5e7f8ec739c4e39940172217dcd0de70f46c80dfdcde5df0336a7b1c0016beea96c2f557dd7f225c0d441d6a2bd81ad17b25d3424dc0761d2bc6d9f3e7da583cb9e3395eac2926f27e6a13f7c8da81f06018186512e3347b43aad6b987b12383a24f6d4fe8a9ded329211d41c904bc379d0d57da5ae9c80b382d13c51a33f4f218c1c23bdab104849335b5c0b1f663aca6d04c6dc9d5906fe6288abf72defb7088b56e21b86c09547f9225af95d0acaae81987ca5cd6a1716e676d56d7b524f78f92d93478373431a96778d1df24b68229a31943a98736aec2bb2d7a9ba00af606f5e95eb223b24e7eb37aa83ff9a873c452a4bd98e7dd08316f7ab9a8bdfbc25e8430bd5a8983b3821eab4b09d26eb5d14681d6b00a8057f3169ab5010a27953c27fa855537d7b874e48dcd397a195936825a995965e956d46513e207088a420889125f07b5ae196786b9f8ce17e1711448f718f64cb69b437ec6120a726cea16b17cf5fa80f82a9816710ae809a613b2b86d8a05952cdb08cd1bc7c176c3fe18ff51ee01c91f3653ae7217385c7fdd3b932e0bbe96ed8b57849d04531315fb63906bd1998fa2032606fb263e07923797f31d12eec81ad39b7b0369545d081a26638584ee10a35421c35a17a14b89ce7a327a89a8706469a527b4c215c300fb269c8f67b2dda411e2ec572f70bc5e9922a4c955de4446ebf7f2192a2117b66a283cb42920a3e69fb36ba15db0b22cbed759de05facd80c0f876bc47e1b6229bcd0afb471f299aa85640f56a30926eb2324727c27aad966aebe864aeb6679f8683fb5b61f05a6209880b58faf9d833145cfd58fadc6b4cdd2bd0f38ea4025c96774635da3610161a0520bc1990957645a9600ff293bc0c0d2d5383d2bf20c77752f476fa54afa099238d1a77a42c8ec5ad66f314296db2b03ddd7bc893cd62af27dd660aed0e82c2342f6cd4bc381f3ea2abcd60f85dbe480ccca66fe39b2cad474a44cc2a03f02e266f161fbdb9bb0f1696308addc4e7d4516ce844d82e6cead9f0308b3324842617c278d2d1b2b58c7c427192b279c8c062509f606114994e8a55647e01f873b699abd5988bf50b923a50ecc5e9653fd837368b80f5ae974ba692a565c703ff68107ed05c6b5800d708503fbdd621b09ad3be99d4a0c4a5bef018ac54a38ff9940cc67c6737a2195353ba73ff32076df30dddcbc7962f038e595e7e942dd40dd689718b2509ae553b852bf248ca3e6ee5122d8b7c650ae33177f7bbd4ff8ef93050d8d9ba1246ab7143fa2402ba49121da6c5fc568991dc8f6ff1711e5bc98fdb55e0668292c3ec690548219d19bcd7530cb64e081bc5e6ba6e7df9f91780acdc072981d289abbed5902dc7235109ef3becb1c8eec6b4e1a38c5c8531d0e90f047629e716d6222e9092f46b93413142d4ce115356293719bcf148be8a1c145d2ec32989f11822f69bdf6e5e8f704260278c3fd2e7a00329ac54738732f996f55c2d563b89b65c93c03898b3e8fe137489d6c2a7d31a4380e22c78843bf9d218f4364036841d1618dd470077e4ffc4e6b9e5cf1442f6bcb28e676b79cb6691aab88366cf976b0ad7c942fb163eafc2ed76bc44a15611614b9a6064c4ae932351ae42edad4349228e8ca9b33802de0983f89222bbaf76a2d78f420d08a953d1254337941f8e56abb1ef3fb243bd480a968b647a29492b92a116539ac9f041f0389a2bd886c5458f8678c8a7aa2a16319bdd689fc1121f8856fbb857850113b3993571d6449c5d2c73361fc45f6ac65c8f992c1c51dc5182101b29dba0de2d072de487d53c25e945e005ab1ad74dbd61ed89cd2e7a3863a3778c0459a4318900b870d07281f5b9e465effc33ecea6a64fa6ed6831c092627fa80c65791fdb0fb8bc9fb38fd5196784cc1d6052158521557139ca505830a9984ac891bb6caf6a88f643c490b77da2959980977843745e98ac755d808cc055806e4ee9537d3dd5b096b7819e354f496dcde0d3ecd3e2f0b1afee4ee8dc83bdfe049b782511d0ede709c1157ca46a19826ee5a316bdbb7533c066ef11b6eca34444f133075b79c62d304985d13a730a9000f2da5ec5ba0d55e74ae009fda9a0bee4f29dc6ac66f1c271a8228dd9cdf51055a8b0bdf13456fb499842b524ff940a79ba143981e9fa00a27220bca4f43989a4ed8f19c2444ffdba05232a8902d9c83f048864a2cc5b5adb67f58831520c49a77a58e995f216e052ed0ba69a0d7307d52df69140faa05d97c5444924bfb69cea5bfce30bd1981497beb7b33e1ef35faea6c7444906868c96f8c458ff7caf6d4f6531d06e07c96bbaafaf3f87d2ae0329578a5171e1fbc0364f0b519e129cead72f8cd454dc940f97c0633c33207c1c08327e202323103b2f0e66f95f8b044f7c9f701187bfb199eb6e8ede87ebd02ea5e2d95cd6c1e459e4caf30f35b403db73fc0f3d6b8be4a6a270980f805229b382be74dd89b9c1daa569f291845c86b109bac77ae0c18c3817c7fec685806b31acc3c7c00a97ee91990691f4e3ce874f1379586cff1f46598f34b437e47cffd8f800172ca77f7db674de5fae3caf578ff36318011473cb57ce400d06bb74e2d5417ddc795c6b72645422a95271ee1b5b1f6d66aa084c9e537f8f7defd933408ef02bc40a9c9d60b8979f1e24f31514793790368731a2e6bb2118971364f8e203dc6cc0133b37f4346fb5d8139d58097df4135fb85f96fafcc9042e9364c25c977f3af677e46a23abf25c91c79a472b7ad3fc9068e4460ecf9b808753863b05ef1076d51e6f19b431666213959b1c2b6206c5d26a74385f5ed9bae1ea97f5943c03e4ad57954d43a39de6302718022338c11748e5f7635337976adf1eefd67927902a87dffdb6290c52b3cab59ced7e548b1da201a33becf50e7fd920f374496881e9738823bee924574c353d2c91929ce45e80a44632aee09ae7372f25559e695d786516aebb687ffb250536cedc4d7658249e42a2c3fdd326644419e5831cf1f77d3b8011aca8449d569a50da572ebff90a3a5c9db4bf81061b65ec3f0b065fcf3e17d4df90eac8c44e18fb03e7a99a25fc8c7e5273f7427ae0eec879f863c278aa6fc85f6b3c869e762b6a90a8d5d9dab9d644ba6cb995f6eb09399ccd1812ec80931744ca4fa487af275b44af2fe09439eb8edc648f9b9fe4860bb357ecd45e015ebf3dcb86ed34e316241c1f21b095da4905792d15406978d6f4e435a9fdbc1524bbc6836d9682a94035c3e1577cea5a22ae52cb2751dfd33a089788030c231b8120cb39bc96019a9aca0fdc5620d2e67475c93fa6a28f14c739021b10fca041f65f75e6df0cf0ac2d41cb7a3323a0a4c93feb6f319425df19a653a844f7267906b56a51ebdbc26b544c4f9f74bde76ea7d00293ba44f88a13675700c1cda01dd1b1551db58e5aaba3eec874cbe2763bf8d3790fed8038b23e4ddc8deb8bfa22a008a5da57b2c5bf71b32b7dcc24822df26eab46a98724877bf3eceeea53ab889a69c278d415aca783d3747e86b3ce714a746a9485dad84c3ab1e8d4354d1664f6fa7bf439e8aebc25e03890572929483eb21572653143843330f2be46fb91f612bd7bcb18b9ebe5d4ecc2a470b52871c8ee13109e45f11cf1e6335ff850affb4f526808b14cd1b67f321690ddb55f65885b8fe6654771a3495790d0709518bc01977dd2c058e445caeecfce7c0f054b03e2c8fa8f19f3ea1175fb011f1d95a8e8ca49bebfc0029f47afdf654fd3b6db224a13d8d9d676a70769e5038bd04c152acbd2eb8ba738bb3f1f2f2ad65187b865dd21498e1282206a49f8b32eafe35f3b3759afde360bde5b40bb84d258342eda499c4e0c9760fabf5409350614e8d17e3e09cb912b80855de1e073feffa32d049f2177ff0045ba18f627a5922a88c524dec249bc1efd2094849594607111cbff3a7ed974d270d0471ab8da92727a6f4da8978724e761db2a5cd58902ae2debba4616a06b3a1d462bf8a0f4501ff32832450c4cb4d109fc0e92cda1d715b23adf17b2237a10261b35b52d0daeaf98320d078c5e186b4ae0f0ec121841fe09176d16f0934e534f00b97b2f993a2fec70efda3ad429cfee67971a9dd93d2a6296a690dc2dad430f96ca48361aa700e889f28f30d3460c297600b930c971059450ee63860fbacd35adcb4c8fd46f1bc188e48f941cd181f0ebf5577d20a6058f1287f27aace810a5ee9e270f894fed15a29ea7504b21375ada4c4b8bd24a7a78eca8ae659c018036c8995c33719e071e9c11371c569ad824e38201e88f4780617fc55bdda10ae93451331ec14274eaf99c9b06fd5b971d6877eda6cf7e74a604f86d93608c4d2bb1d99be3087f3d5b321de259a430aa7cc7079756bac34311adc7ea97d479cfc698ebca111b0e379fb7f65a949a458895b896cd5d227ca9b8de7271b0c06bbf4831bceae2b2ed052cbe540afbf0bb0248db941a2270e9fddde321d60a8eec996c0894fb5a2a2661306baf0fc41b1b32e92e10c5eec103b229f437e897c02e3ae1eff24a114fbc86ff2a76f96e9f0266aea7f06bd6250850e9d0cd2a3f4742bc93315e52764c532fdb858763f9d8e4a2578af14d95299ea50ec5138c06db43a383d3af86ec53d16996c6e73887cf79f8a7d3aa9486a55f46b91317d7f2e6840390ab547e7193953d66f0d3c428b48bb4c6efced08761272f7c6dade3fe6d9ff47b9361641c4077a3fd382d3e1b46ee54c637135d8d0110cccd1141a7bf38c3d740dc04792c459f81099ee448db30d060f42d97950e7b96e651a40cd9417c824757acc58693db2eff779afa006958e80ae7baaad134228b30df3406a420db672761cc2c94028b27541db6ce5b3bf95a7a446bc7bad93e188338ebcf9fe1fdc03d854065360ddb5d3839dd57090b4256f701bf6e4ee28823b78118bfc4852744d47a80ddd54667fe9d51f1fd335b6d155d82758d709857bb1fac6635f11610e596c5afa6b6d43bce2aee8606d0f5a243b80f0ba99729c980e132ac4cd3a999fc1bc2a74bfc6e319562b489f42912b41a2f4e40ccb8c39b815fc55308747f0a609fe1ddbaa080e93ed642f95d7a6df0c4ac3741b58778e0eb34f9cd05104c06cb0d9d1a62f97ab0ccd1ab604555778e98f5cf72ff3f988a2f972083ddf2bbb1faf31be8c54a5401990b975a0ae9902703939d0819b3f0fe8c35ab519fe72e707bd35d0e370bdc028cfac15c511110cac81f97555294ba66403999e5225bd04c58037c56af6b5f590b2cda0ac288ad258b3b2446878b024401ae65873e181ee03ceb29edc3804dfd67d7e99066c7b16e9d920e1d8021477c352472934a96219b16671a8c7e2295ec9dc1041bc66e837eaea7355fc6928c6b64056c9435667b105e64ef5e6897f9173fd70c7f2b9300f27c96af5205c2e5eeee6fd7b4f7e8782c20ad1d9f5cf36b11bb1f9bc1faafaa010d90bd54be0b8579a2c1b04eba4f8606cb12e4ac81b768dca5fcccf51526f1b2d3d28249e116721770d58a18e159574c8517b061597c0f55dc1936e54e4cc3c4a4910f5d12c5853d85944e7bac2fb8a5396901e017da3d0decb6c55194f79df99265d9253862d072e3d0b5695c9411dcfb306d58aa352c091804e3bfb66f924421a50cccbb053259a1421e4d4d22a6ef11f1e17abbd10333a6ae338d391cf2746303718f65554b581d6963eaa176b2e2ac0a9ec35df7fdbc94348243c42f62c67162189f56e030789beca46c7ecdee132c301047219c45dc63fd36cf70ce9b2a73c817d0b9713cfe5b104473b4f997acbbc38204e06861c2ecea8247f6f725ed21ad73e86565b6c88930f4a3b6b9e8dd735e667d3ad34948c5e5cfc5ce3c79b1247604aa5a84a557bf02060aaedcb6ae8b6652c7a71b4485857fea82db6b994c82bb8fc0a3488c24ee12d7fc021023cb5fb73441be07ea5cd0df467296690fad7ca6ca43ae84d9283724d9d559b83bdab7bc9a1f7934bcf446ffb7d2ec82f45e096638c2993d494d5504429119dd026612e1f5040e5a2392e507af5e8d7504efe669166e73c69829a1191a909889550e1b2df8e76f361cbbb3cd110aa4a349a47ae9357decb2d70f421f2c6c35d8f66299079d4486e3a42a440760bb7af9b880ac315756f463a73af60b566be0aa5606cb4c956d5b58caa018654aeaca8fdcb963bd05a3076f934061b2e4ba717acf28c8c79bf88a1aac5c8dbd5e1c0f0243f828b0890dff40f2b1405e70e05111bf2aa585a0828f84d3ce6d2c4c248ac1f4c53726fc14366793e2ff37e68fae437fd15b66298ef06fd8aac35359f5f36e4a1fa717bfcda4454ba5f26ed93570b3000d377b636c1455b6292a61c60b90d623c677ad0a4621139de01ba2e7dcc8c7f747651e1277a4fa20c41ba99e2fb490dfe8bca0415fae7deeb2450d7a9b24ff129ad99ed20a0c70e494eef68e5d8292e3805e12876647fe8572abe9d7536203fe403bff2d9515a6c27b557972d89c2389533a194dcd9363088177af1cb55156ad572d3027ab4f2f62129d0b65ac4c3e9286f268a46e41af8f4ec79d5146bb0d1cca1a2669859bf81b3dc385374c3ecc4eb28f5c12da96e17f3e3ab9a9b69b46a1b98420d0cffa724551f464decdcaacb6b3095d7352d5d376e993655a84486da4b0601a88475128b4aba0fb00f6c336401b6e61f2e3e2e8eeeb3c0c0b156df8eb47649e6b8c8a5ae99a7a11d28e82ea879bea0a45c5664ba615345b3d84e3f714148a270ef85c37af58aa1d6037f5812791c1b34d6cd4c6f5340f4d1c66c4873f788b7bc99a06161cd0315c4341deacd84a537cc5168721203e3153a8f792e18e3a7298743083090af79e840f01d89cd72b6f73fd8820b5a9b5431e00d456c052f4984ad4ba0faecdea862963dd967288127af58251f501da9394a5ae8139f9f54b7969cbc0ea43e8eaedd62f912e5bd031d6a4bd033141663c7f549304d8484d46d2c2cf6a374bea697efa5931a71de63c3a5e4a97d451056b0684b78bfa9f3e33099c66359093338036a1f417ce2e6e0989c88d62653d3a51bfa4a9523311aae23408afab64329f7687b9591a981924800b78cb6ba6527b12d31a746492bfa84c2341918a5722aa813633f7a859d5c4be5c3c1e1bac1e5017045fc05eb592029136a0dc601f4ec435a186dd67b86cfe07935fe319be3612e36c127c107332aa404bd2808bf0d17f36e847b4f898e377ebe4727f8b3e4d8681f796ae4fb80beacb460e937c330c93690551fe549ba46cd0cdad326fc893869648b403e782b27aca43d0c56607e75b7891e097d32423a6b77536f008832b863a09668f827647a6f4cbd2b99e102829bcba22d267419b7691b76446e8b493e4a9bc52013374e35d8be04cbee0a18771b567975bf88fb2ca3c14664cc85989c3830385f8572a2e35522c2618021b2403bfe8b0e28c2c5bcc8cf465c967f786fe735aaa379b963c147b4cc3d003275547470208091131c462eaa7d1586aa0d06706cec9955b77a16e44c1176638c1e7a0c146286da51a067dbbe58e21ee6988eadc0d57608d5c1159b4bf54e2aeaa20d76e03efcebdb8354dc04ff9ddf617b9a14f0fa55738addd846cf3867249d14086f65c7b5505e1848f22e4acae80c5d89d083d55687bdccae69014ab5a77a5ca1e29abab10fc1050d4b6944bb19e408512efa2efc97d447c339ffc0d910002aab2d587782fef80006dc7e1157720ee2fa486ef61fac07e519523ac51e747c299bd1e1c74b35df0e9ea0cc2c065760d5499020f1986d92aedf0915ce9130b635cefeb26c5249392149ad3eceb1a100c3cabba6f2f3f33f5428212170ffd7a497ac9a90378d956f390a882b04038805e9792ac624660373ff59f08b18325e8b2288f0b2ce0d6c6cf322bffc9ef98956ecb5694d04c163cdc15b409338768fbcae5a2a5bbf71b3ae351c30d61e48e38e9371401a8be9321bc60a78abe84bc95f6ee80f52600f3860053dfd8fcec1f10f8dc6fd3d2b11e33fa425f14e8af1387a4932e2ab77ba214481aec4b92b82272bca2decfca49e4200d68c331a419efefe0e89e50ec9550a3a3cf55634c83164c6192d4497da0b0232ff9d37814107bd6825b4dccf342a385b52ab7b3feb84c8cb31db87cf77b0dccfdc3e4a07e7aafc26bd58357d7147f4307f2ca3479521cf421c04b5a81e6603c7f8bf63031acf9e2a460eb15db9b645a404fd03c700db32568b697ebe0309829decdc27dbc5ca5b31f469e1c24389ba904f841710ad62fbd1fc1f66f05b25c72b04638e71f9d71d0dbcfc72e1b05b0ac8b68950ce90dce0061f1b375d5b65952e422b60e9767e6781b882e967a67682b97a2ab9862f76c8f34aa1ae6d9772c6562fa3a2f7f4626b9b6b1c0b83642889e1035a7f2ef75def1526c58b9928019c5017013987f85f95bf197976dc0d03f5eca2256c90e7e8cd4a28b9d8afb99021230a9b8cc8b9b591fbd84b36d13d5f763b83509cd7872e8e3f3145feab836893cfc8c8b55d0f9cc7b2808b2413fe3a0a39442144a9d4303bfd34ea760445a54afe48d474d42565371790d7ae060d5f71e444b3ac48f06b75160ff1fc1845f8f6d55b6bf262b49c0844ac522e17b54cf4665dcd7e03a0fd73fb0f910dd4bee3f2e7b64da71db518abcf37246909ef25ebf052b1211f348dd3e3eef4b7eaf4fc751122b74fc7e85f6ebc8fc1b0515351ffb9344160b3f93f26a3f6daa7fad6cd2e758454828bd4f3c1add333a804cc8156cd2bf02b0e958f0585224dea06c7546c54378220061eb19a90376b958113cdc2e547765b3249f0d2f0cca072670f38d4c171e3414573755964aed46c6bf614921271b74693e6086c1320f1873592dd32b1da8661ad7ceec1e39aa1e7019abfa56436b33da635f4c6aad3c1fa62b0c029670c25ed33dca342ac8fe2980c3b9340cd33a80ddc67d30e43a1b4cd5e3c19b288e78303587618696d33c56db4b943c4a35ce73ed0151745120cee1a68c973a6255684f72d3f85f48ad4001143c7da771fcff76d619d7b8fb40c23aa0f515e490f914d4690629fd49f835530b5825b4a295bfb482957b0cf2ea701a212ec6c2eec86d37614c9d1cf7e6fd4072824198fa26809395640e955c5ba9fdf552dd7acc5a616fcf8006766eb7dfd10b18e8e2be550ea116e71c86999fd5528e13cc90e3e093c3bb6b50cb08ca8121261a645fa1ae90ac95a1d5e2e3ab06306109e3f35d33bcc2319fc7dc94f60795566e53939a1f5a298bfbad6f142e10600e8cd8c3123e3a7a7be50de3ea8d3c7a6baa13eeab29784726123303e6847c07787cb519b12ccf44588ed45e9dd9c81c59d5e47bbfbddc0a00868da60f2ec4c53df489781aecad6234ce26cf9c979dddabc5519dcf7885deb789107128f9d61162273ae2a15f63e4ad696d3bde71e181bc4b0bb1c34cef1f6272a9be28fc1428ea813207b2b7237e6dcd1e2762f94382f6600428220429767c5719b2e6e25a90bb896c046185bc4ed22551cca71f977a93c4e03a0ebea98abab8a2a90861de97d561a989d13ac5fe408fe01ce82f0a22568c656f5216ec1422bc26c579081a5ba8252aad314802e0da19b757a2a5433e0ae9d717d04bf55f7bd7a58f9f3c26ff0df6b06f8b1ca6810be8449751775cdd23d04d6fada256b31ce0341cf8b0bdd2ff8807fc1bf56526d6a5dcfdb1ba30df79a72c445640938de55e67b31839b2f1d9ba530cdd366474fbcb5f4314d4720652dadebaf1f135d97e2e63849cb1c12ccdab235ba530ad02ea507a0c588886c8c6b44a57f5601894b3a64d02401a66546eebcc72b8d150229f341a38f43108bea3e6b8fc0a9bb10b839061b58007a6687a8d336e0d827ffa0d3f81842524f734e1de1a6cf062b470d0507b630139a0f9a15ca9ffd1b525aa496de626c1149515e60cde6bfad3e5700743f48e6c11ba88a1ffbe7a3ddd79f2c3262b7ccb8394ac449cce744cec6956654a7be359e3c93d661ea61ebc5d2bd550357c6da11c3a1d56f3b07cb58963be65bab22d4f6d14349a1395c478dc19c26479131e655c79653ac353255dc0362b20ab703ee3dc9ebae8de6f2129067f410c5b28a76cd39f43297bf970a2986bcb94e6b1454e2b92fac862cd0c11f07bedc949752df1c4f71dc9d3ad26b40028f85e71d7258c9d371b49a8805a262e1b07b4c100f971da035845a9bf3abcee327efa40686936df9ff4080c827210905223e0459eb840cd1687c632bd96f57bc6405a39918c68c8709b3287b4346409caaee6541fc73f26f1169d3d948afdfc069652d2b2f295ee5a8d19fa91f68ad7322a6e9329bddae39f1495ebe722b68eef3915336ef28dae77eb54bc72d34b8a288a6183236709759506ddfd27b93331ba8c47736bd717c96e34f3330d2c87531e7a80efbed18100c10fb3779ad57b9ea364b4d430eb84d72a0e87428af8fd00bfca81c1dda4d9552606e850b27c9d3a342b4b2840d024c5b1d88622b0b5c23072a693152c0560982f6285c9af8d0ede758df7c8dcfc502a19572e2afcb5a5b71a021dd811b22a2f26c0609d43b8d501b2e3cbab75a81fd145e1891f41e8cc0f78b2dfd7e6f680cc44da14229e5cb36f338416c8187d0ed18c4358de58ce50384b87fbe8e47b78e5ce9bde7cfbb903623689866b3147b5f033428245e45dc042bb1d51f785a981faf20ac7dd1cb8a4d320dd2e689c90a3c6b9d7217be76259aa4341b672b17812a4b7c783f07c31cb7a0cc2b85aaa7d67b6865f4f1951d693b48247ffb7b63e522e732744dbc28e2d30d5e938cb6f1a9379483011221852391de096862914ede90aeef9bea1a49e56ca53b106443bacacfc50f9eb1d18598b80de9ff3e77c55b3aa62787036f4c56f6b49ad3c28d5bf8f1d89fe517b80e684b46167dfe598351b9c584a1ada087df82f0e4e8914f1a7ebeda47bc1adc19499ff15bcb886b7665ed4bfb1b43c754bd72ed0208666c83e2e92a52e0277fd372bbfc2cafd74852f03891ec72edfe9189db41b04ac6b7949c1596f35ee7ccceae7d7e8abd4310ec0d6ae83a644a24fd1cfc84627b81060bea41855649fcbb99399e81460a47cfbedd60c35234dc45a95eb25e34ded9efce5be55dc81c5697bb2cb6523db140b9f5dbd1446720edf825eaea1cec54f7892473d91a163468086224c35100305de348fcc573185769e91513137e4ee98cae19462b7ede2ecf5cc0681414bc691353632c22bdb50cf9b5eb10413f3f6d142896f659b58efd85c8bc7c08c4e8d089d38a82b5c55828c78c62cd41bf7aa6468ffc88f078f1885774df7670fcc2a9c84e8fd3b39dbbf200d6cec8bb0fa8d864f051a8e22d2ca56a74c79fdad431fe130dc2c64c8088f40cad68fd65f3675bb7b21c3cd77f0f0b984a248f26ba0b5626d1b208d978b474d877bb011bcd52c570856a3371d5259432b3ddf594d4d8b0bb74fa2831c0fba394bdeea43404446fac3503bbc172df74b141a07fe253bd28e874750ccf2fb27e87e5dc3ed29c7545c37fc5a54bb386ae82279039f93ea4cf6f7db941ba6adbd2bb91d4984cab2d4170ba70f4aceb63f591e20ac957c86a31924fe26040e781f76b95b6eb9a8d22dbd7a4f4709e927e51853324a084eef8f82c99b37de90f1945b248217f3d7bb13b6aadc6b616eace10aa7ac15e97b106dc139a09a20af3f5717f931b2239db67e8099feeae41837a9bcd56059efcebd3dd64a4299cc258c8e8f40df0b000fb1567cbc4e8c7a3dd92f09d9c5e647dbac21b857a51ce22a31fb109376fbeaf655ca3565c1cda7beb96a1a3a5e682877bd2d57d9a073c42e1e019f2326e40b7417160eb7802670af25c0726ccd5740fa51284482b3310092074430cfcfee747afab34e82f71497b21f9747c5e7cbd34802ed1c7d7c0ecc38e9414ff55842ebdb1817a367c75314750e945e2334bf09d12db95612338c92f01ef16cc17168eeabc33fa4bf7877ca46a4bc17914b8ec8cb91c7cf2a7afa50e302550f8abc86f05605cdd3cdaf443d1f34c01650996b00a24026b6ec14b7cbaa041f8de2a815787d9b17ecff6998d498b935ba010d4e75464a94a60a89d3ce778c80b3aa3b53e2218d44d508023f997d5b4778ca877cda8280daf153fe87226c3bff3adfebb9c7eed29d10350e3d7e3269bd4fb34b50721594b9956fa0d008f247e5f8e829401f000156aba0fbd6f6f5ab8350e4bc7a752045112ecd187e80f237b3bf20c2912629a06f78e28e9e5b819d0a6ce4504745e95530581dac72e7b4685601b34727b6bd33ee42e673a1efe0e137bb87511528b37a1e5274ef4fc372361a34b68f770895a219adfb3c4df39371ff6e8c627e44d4d7cb227e18c78ba2299f75b3cb60f9483857c162facd8a680d8f2474525f9004365ac8e702ecf046bea7145966abbcb4889a0c7b6ff4e062aa68f0c55ef61cacc5e6897c2463c0be5197918d2c56c53a76bc23548b0c13a4a049e62e8d3c3016e9667496c9c39f9f0bceef17589b6406b7d1ebb98500e481be4a688dd4a555e53d14cf9cc467ea67279319caa52d5070eb214a7a5b354230b6d73b24aafb6eaf614d610ffa5d62e073f6385a9e612a3011b632016dd4e697bb673c312283da121f116ad36567d18da6de1ae06e0b96a492df1e0385a14b74ed12f5195603b43ea74c59636353de5fe831a988296d7a0207798b6e592f43a7e76440295e30bca68e0a1823da2c8ca7f6e5ef9917247bba2fc12a94bee045db083a2b0aab5f8232c32c856bf20432b3c51e1e4a42cd9859471fa925ae6f1dc64bf39e34f763c797cb8f178a6c322ea7b1a1e1de9f223501a14c23568d21589c0a3705d34aa06da680ff59c3d5f5378a259526e4849a5b20a92fbe8ae562904d0018cf9ea325084fb893331bd370293b4b39266ab8512312f8b176bf44de5b721a63dafa7006d97832cafef308e26a8738ccff59412f61fc6334482bc1205e5925c04bc84b4843c97c945fd9ac1f39ab4cee028e23d0d80f31da3dec6110e4600dbad1173caaefadd3646f05669934bad3ae1d3da6af6c8d16887106b91842ab3bc17dc8dfa42f8807f376db888c0d043b3f4dd3960376603cebd5f04bd185f41ae27ecc5648d3cd442c7e9377544937726d33d26374268509ca043ed7699f79c64aeb557d4f3bb20f4d0f5911409f3f88bce59f55c9f3177c1eff64aa02ce88cc03327396b5a17411e3dc7b25607304aa47512a046a187b60f00d206946c97121e6f48ea8b8916b8f7555213765474dab3734dd67c02722bcde90260b99ba35cb7001fd1178f80f210c2e26c240526f42e4cb91a2285478558e62863b18beb0362537159778e6e5d425330081a133ec586b40b062e8f233cc1d109b42607358e356c5f3f14c10b623afee028c8df229c47c794d630a770a6198270e75bf455874a7c8645abad8c1256fc9001ce768e959876f8f6574844cee5fbdc39975a52f536b7716fa7d156f89f576f1ad1599d9357c400f65b299bc8ba821080cf2a7976d09145bf99c424b4ac14b727648a91dbb3f1029bbfed2e634f1c280c6be50ab2680face46efb36ef4769c82b29e3de970d4d9943b70cf54bde6d78d101c162168352f4eb13eb6241ac1cfd022e6b6470e6517e8d1298a9b55a6a1a3b31329e61ad1a0146b65cccdcd559e4ab74fc964fe1f5ef11d7e13f535ebf79878f66c0cfa423570e14bd79e329817dc386ffa387d42959b713f45dd638929e9f49f0d6d1fcb8b75b3c0af235471d47d30603d5cf550b5019cea07f3533e2703a0bedbb8dcb11aa37f70476e2f97ae3d7c252139243a7e2e0e51c8c5e2c0bfc19be5970a2fa5bd3d5f10823a4cab9fe1ddcef29228d7f6789ed8003c160131b1edd37deebd9740fedf0cf5821f05eb6b3e10c1e685bfedc91165975c5526b502bd520f55bf3ef006ef555266858303a89839444728e41d30d55f50ea1ed5c27427c42e0ed6631ff1e7cc0ea84e7c603d1d0d91e04bc0f6b2cb1d7e3a5a148b15ac9a99f2f0ffc57293509c3a016f5824cf02810141fdf4a582fe40525889ee473767fcada2f4150610d50b7a99e2ecb6a7720373d45d8ad28fbcd29fdd846f122dc3db8ed0153d10de5ef8f91c18797086d1d4148c8b8694231f5756625c293d2f19431693ce76f5ef3adcd6fdc42c1492aaa9ec9afd697ec1c70220bdcaaf831d0b3f307c763c9ae8b2a689e2f89b225b64186fafa333b7ef11d5e189a028959bde7c49b15c5797e5caf80cda5b0789ebabdee5667368e2c06b7b2907a8aa3f1484740392c6ad7516db5b83645e7dc1c358f067ba8084f9e3ad133b4521f9a5a0891161f973a407316496e6e299025e35eca3ae3cbc427ddbcb407a4992b6195ad85d8cd695a4c022fa084caa60323c5f34e77f3cf19fe026aab22d5a25e83cf3c36bdb252afcafd3166e226bf0bb16c872985a8727930ad91783d53ee0f13970eefbe5b4c7a97d3ae5e9c4f9489e34c75d1034c9943a11781e38df5166c0fd349edbcbc55657666b0174ae17757a600054d91644eafc299ed082dce6aefd8aefa45869d16a2f4d590f1ecc36f1768a005474ae741ef731474066a421d66023653d76ce22e1f9e6401c57f5268b6c80fb9b25835220606f2c4cec46542f9bf053eed162f67350f972faed4e096596ea5952f9a18066cbebacc9c19b2425d849f0e9f47ce7af72afbd0c7ff1312b3c6d4c201238c08cc7b89ab50c9c5bfafaf2de6e1576be9061a46f64c057cfb195005693cf91419e41732722e808ddbc9a7016498ae6d2e33a804d2dcd5c34232ec40f9f3f43f6282a3590715616406eb0f46e2299a939da06b6422f83a1e7adc11708f2dc9478ccb9c62912edbf16efe0d6e5c7b5d433eafc1ffd8130ce724ed1f3a1553a4b10cd5fb656b39c2e0eb4033ac7efeaf39e69631b3a2b0f6fa99a16bacd4010afb14fdf52127db0ff0b462b2fe9fdf2428a9954fb571f484e158261ec518fcbc459d117503db7e27824edf8258586c54c66aa72ac9114e226dde0b77ce3010b96876ba8422b1f3910fbc9b8b385edb6b91111ca1fad94973341a58c34188c4c4720b0b28765ab058b58a23e972d74b76a9d7deb39c7a556b462e526ae762a6ae0f09a020f074b8ef1744d989bb91b662c421aa824e984594446d19cb94146b6d2de172ea5aeba4c24ed57266c16b79a5ac08aa8a116e570f0983f43edd0c11cbb929e0739628d26e91c8572599545b71b2c9273ecdd478e160b1f4e9665327ea1a0c4aac3a8c97566c0ad5f4b804ed7a9e087748ba757cb50aa796d69d281864f069c8419925652612b604af04f70dce0cc01d90bddadc1950ab607f077ed9261523e9207d84f8c5a41d580badd26eb2e9d813821f6ecab451fe3aca075b9a01d2cf7ad3ac319e6441cfd2ff1a78c7c211955dc0b0c1ce5727c813824238f354cecadbb96bf55cf1a687ebca07511cfa3f0108291b169ad3b9579afb7a1d8059858a99b8e6ed51e603d761d3c4126398cfaad567fb87f65057d80fd4ed5e8603abcdc25ec97eba1c20f70295e08be0cdc7484df46ef74072b873f89cde98bb4f96c7fca6e4502e4bfaaf8923e548dec35a7044ee40205365edfff5d66f110f78bca256b4aa6e4d33f27f027930f786e6b13a3d2ee5f6edc6276152b73021e5af9605b8b6deb681737417205c1d480f22b3f9bac18e789db57d577482a0883bde408e998012cb10efa7e80d3b3d301952b373cf3fedbfac0acb9691f28a220dfe3ea8f47426820eccebc6389e3897dfe4a400ef5ce2ac0d6b5d90637e1a1ea163bf6af1b948d1d2a6a225b9c4784ea1680960705943ceecf9381a2fdb4cf6acd02cf378994480e2dc8e69b0cb72eb1c7e8406e54ea874406bdb2f086297aeeabfcd22942d869e5958b94f72dbbf2c826a23e00f3a3798c43257b37ea3755b0b7c97aa514f25167072d765a648620ffd6ddffa5603b2cce9a1163c5fce3d200ac26153fd885ff0e818f16e8acc939bca015e0fa17bc05990fd3def5dcde47a81478c32c0446612085e0608185e4d95ad1f88501d0e310850dc92faa9c50df04b4d17426eee91ee7637e8649fca47bc35c87cba4d55ba8ad03100677535f4f1bb53d92d335352d4038a2ca43495ff785d2ecd29ecae5f2092042155c15e5c6f7c1b02d4c6a2a22cc8057f63e257b5f6173e6440da406400620cf971019846401fd31404696dedf757bac199096573f0732af5c2425a9183e1824ee2f82556871a0f2a9e85103ebd4ca4e2f6a56859ea872fcc5e88af8908cd0a8cf69b5bf27c0745d24c598d2853fbad3629688f131dae7c3995da6b70e4f1ff2c95cf48bf48af454a79e5071f5e6bf55baca9f6a231022683a83c10f397a9a7c7c8aad0840796697ee153280e5af40549d4176a7db0244ede244b397598eba97690be81b2389ac248426de2bb9ec9f1271441b1494c684449593022ec1bc2be3ee7272495e3045c4317e981a6714e041204d1a374965b69ee60bb0b0db2cb29359498aecf6cfd642cdc5da2456415c802b09c71b62e3e49fe0a02dc55a6b5f3ed2d33e3f7a31ef7f64a511f65ffc87c3dae64baf79199d527a9def3c3727e2b4415e6bf5985d33808715b26a49512bbfc65bb0da6fdfd4aa9ac9af61a65123105fb386d34f0dccefe54c849538485fdae30b31f78ae74e5dc9f3068d0ac60f154ef1abec4dbb6f824e226e8ce9af6606fda02b43e9ee327ac8695121d1e1dfa5c5f120dec516b4de5c0499ca813174130272b239949fcc8a91c9c5f2c66000ee48a77a74cfdbd0be91796d3a1fe47316ef60cb58da93c405ff84d1c9655b1b00172af03a84236ddb32537a0459da3c9d6ad3cfb142f74da43426dd0a01f805c44d0f42547cb330140252220ce688ecfec9663d2895af99a4939e5f84fdf644bc37abdccde177a6dcb2af5d08e6a684b2df0cd4eb452c9409d2bf84f781849aeb3c588563321318f25f4e32eff5db1a4ed75385e635c3e83618738383031a829ef8ac72bb5419c5bb19fc71c2dd090294d287475e5f863e457b511a4eddf25ced6a5dc14abbbbe5798098645ebe43652ad6679d00c6440e8df3ebada89f230a3e5eec517f85a9b6e3f64ef74fedbf4311813e3445c06392bcf1f34eb8fed9d01f0f2fe00a4fb43e5d405c3da267857231a7414cdd2bcfeb0c0c20334e9ed5e4c6fc35e98ffb21604975f8d21e548b9a0faab30eb8911db0714fd4d385c384e551cc5a0edecbb6a687fe3d48cc84f6cc56f50e35af2ed31254fd5340cf93c84d368b53d9e8e4b032ed05465ae687b8b02385053e5d48579713bbc28951d093e1677686c296d7281ce0cb1437e56a2c34f7153829e39837f1b2207cdc7d4dece1efe2625c5d11399e4c418d57163a17cdd3e0026dd4e198b6eef1eb0099c36ae97a726c28e9d761dde8bd058381a377a55dd892f6c5ad6aa528fe3dc2f1066a054a011f17e4489f6a7af84b3a1326e71dde54c3328367e414e9721f136bbed89aa0e5b66be1d3ee88dc46a5a2b6d0cb476db315da02ce0a54ab3ec5a00982c656724c4c4c5b23c6910f9bcb8a6a5c9d822ae40a20960a8c027e59d6dda023647cd5eff7ff7f0907e5cae79fa1954f36f35e4d56b41b670a62bbdab105f64a3809d2d56da7db81eaf1b4c169c4c989d4df628bc11ad40dc11a65ed1b379f4dbd6e0ee0978640bf36fc99fb584a302dc1b68f35995892cbb093533e50b4b32e458e83b7d9e4372b7c9ba82653b0d0f64c01b467167eaade6422b9614027390d5cecf94fb2fa8baa0327451d0f496c8b4dc0427ec215fa73097357694bdaf9b8424be92dc370fdf56c8696ecbd2745b82a0c320b4e39ccaf73b3326cc7d26395d3f35e02a424866deebc201ed113ad6075b1b3df90c6d8385c2b88fe418f65ae6b183df680687674902082503a07ef95911f56a4b2c4112b5005caa569c6b0b7027940cf640577fe23046151d58781ba5903e151af46bb64fab295d3775e9ab35c5e45bcd087616c3c6e3984860b18e43837f504b1fd0ff51a37c1004ae2fc72f179577ef4a1bd1e6c4e7d6a421416f7e10f15405733d7af592bdf9b8e527d4bd06d042a3cb2e60d0c3546f154d4a25b5325962eaccd99c2851f57e5159640bda7e28a0ed9aa65147713a14a4d00e4177fa9c9666f203b4829e6acaa39245a929af514a6933b459d991086001029d0e1d9c02be16d362880c1ed7159a9d14336c4bb4c3c806f3d55773af0ae63abb60f47e81fea8dba5029a9d8c64a79660eb7843f7fd4048d07af87a159e99b8fdf00f6f956235744cb0825fb05d9c8415af19030b081c6a08059695423548beef6314277b68e15dcc478cc7f6045441b30a66f1204528b5453cdb78eebed651f888e80246828ad0c02fd5faa1b4600e3234ab7c02f9f48ffdb4adaf68cc51ef8c4ad8120cfb18e46451df99fcadbc99f2737cc43251b1afa8e52eb2772d13909b4a7b88e2046ebe39aaba3f4e9aa10bcf31b5751bdff7993a7cc0ffdc3a7529181359937bdbcf874aa9cb70562bfaf0c514a89d84db3eac2fac1b19e379e0caf1d080a3d9d0ed373ae8ff4e35aa2cd4f836081af0d8186be211d3eeadc08b99aac8f07aac788a6171bda053a9c0a6c4f547ad05ca574115e78791640302a3645aa6f2f9b6099d8776d0f228c115af6257f257dd745d252d9cb8ae2499352e6f487901e273fbf9c3d6a99886f54a579161d7f2aa8ac4d4d1c4dec7f0df9255178317803492ed1a03536ecb62847e3a9a25b465bf268223fbe58da4b7394f4b5843bf9e1275edde85315bdc4e76904de0fa66b1c792f5e1d69921e067ecd0e6e16d0c6d5aaafd47ae7c5ac5d61a544192c101ee986e5d0b03299321eb2cc15e259c8fcb206bd1425194bb47e3b3ab049c11598dcc82ff80a96d8441a4fdb2a805ef9264d8d2ae60e506c719bf89eeebf86e0cdd868248a4c38f7dad5f78f9f1179eb4712377299c5ea25e4729e982eb2ed2fd64cd75b2d880c8092e7250ffa294056cf6fd86c5abbf52bcdbdf57eea936e4296afe090961e36bf78c9a386a1632b54456de3f0704c4985f5a4f7834d035a107d7014d91d47a9c11a334f87653b746e7ab436ab42d9d31620332dfb51097a32bc67c4b37f709181d200fb2e227e39aac713e73a4ba846d14024d7a74effb00c9bc2352ccf022af3b978c949299c1454e60ee1e93c9d4c4065291aaee278b9aa7b67ef140e4bedab74f0f20b30f11f4ae78eac428f5770fbb28c4e658e574d1b8c25861cdc44173762dda3a319312adc4c350898644f191bbfa58474520deeac2c571242d8a39e26b1fac3f831f8106dc3d76e49f04b26c000473ad0748caef9372657fd1d5c1fd0a29a875098d1f9a79ea98cdf42b160d2f521c80b13754bb55aa7f0caaa60c9f86c91f66ff4a9562e6c03d9d965b86b9915b802fe2daf4927f7bcd81fcedaa2e84856e939e6a586add53fdc54e230dad05adcbdf5fa2158883d16d5d4a11dfc86a0069d54e6eb6152cf7904dbf397d7d8ef7f89037fbaceebaf0000a0fed9054a9e2e7f6ecca5a40e942ff553a10fe8f6bcf1499991cc4b95fbfd94d200b261d6d4307b8e06bdc2100a33380a888850b54285a73ad97d79e56c2892275b3d46b488608565e0d3e949bb1997bc149b7582089db98632b70a527571f2eb361a966fd7397edc113257148e074543b3f60d7fe70ef9ab587a862cd793d9b8b2085d99544e81f5eff904980e700cac7ac0eb5a57eb424c5511667447512bdfd2fddba80d7adb16dac99fab32fffa15408ba7181b2df0f240c4cd1e43d31aac344f6bdfc3c18324b58cfbec5b924d58aaebb0809fbe7a59cab058f92f2f7da49cc7c6003fd4749015fbaddf5aebee434f0d59c9b6f5825f021e67b00b46f86b9a233eda0be355c876b632305732abbd492ff44a6d9b3b5b54c29df60035182514e381887df1a04bc7d32b95de3049a291d5568af0d12c35407d46bbae2c5e49c783b446f3f051348ef43b77c6c4286f664cc67751a3f9988e1ba81dfde987bd9c204dddf7595d1b3a4c9a8353b05a88151c971ae59e17325947157c898d5819f5bd5dcb4e4681a59e231166af5d13054be1f219be7f7728c9ac71031dc3aab290efac96d0be9d78fddc9e6ad630e4b3e55edf4449b23f086cf54b50c636b5660694df02c2472977d9b0ae6f2e6b113f8e81511c97e6add37ab24749528487171837177a0e0865882678aae4d3619933c7ba33420d573c4e8040b012867cbe2807c9c124e4f30247883ff0902fa00d2dc44f8b9175e27fddb450f1815dc65217eec766afa17d0410d5055aa033b5201de5b530973cd28cde7ff2e4371fa5eda68d016d70b0965c85615de447a2d8fdd2c0a1dcdd7090ef95842a145c59ad706e5516428320ff7c88ee453382e8e28128b4c9935d86b637bf14f424aaa2bed1b1a7293d03cfbf2d54cc1ecf6ed3b66405b4550a842a4f631b8d7711a7d5cda4897eecf25582ad24a6e17767ab04f1d3d310454b46b259739495dee66361bb44bc6971c7b6c54592913cec23e63115977da1d4b9d05755faa1feff9e983819a4a2114cdf2432d7cc7c3d28eb05aae07ec8f800e183f324ed03bb52625fafcd9aa52b19b7ac8d12413d7a2dd306a668e9b807dcdfe3ec1310a5f081fae6e3462f73c69a49ef4883ac6690e3eb54a1e7873ae0396a06a34672b42dc284ea09fca30596b668da1b9f67fd667b77d748a84181ff39e36b2c536cc90cc1bd50dbb0ff8759a212b12f57b8b97a4fbaef6da5b56ec90283ca7895e9feafb6215103b0ce69d98b9f673e6125caafccebcce841e79185571a0f4d790a2eb45eefa906bcb391f3d12fd78e69e596e1fca76505a359ea07684f17ed249f4e9a13404b5444bb5f39e206ac89344979b8db4b06f6c22fb8df47b5a82edb5ecaeda3b70c992a8da48d0cf656dc9cbf3d11115f1af4eadb8540c6b9f7d8fd65a753efe08e61e04282db4cc465c584ec727c1aed6733db3f8590cfc2627fc6a6fee41bc10363837e9bc34926a2e54521330e3704b65803ed0a84e3bdfd3e0ac84d9e1c795379fa51551a5fde7a37df8e4b8a82e18a3be11e22562f0398d351e38c5a47f16f21a398aee90653a1f05ad682d119b5532ca07f988809868963962ca0acb21e971e19c5b47d3cc8cfe53fa285755a207f53e529ddff92ff210f7b05a1df0e547e00778da1dfb9dac20008622b4f4965029d9d967ecd6473514564b45d8ff0733d18e9d7f87a529a8d7506a7739577cd12c0df9db025b5f3a76206e7e72d0854db1588ac57846bb3a9cd663905a03444dbb7f199710ff950bafde0a0b5c12b86cb02962e7846abc21913389248b968e1335a876275d6af824bc141d99a6cf0003a6114c1398d2a0bbb8ef2f67e363dc2601bd63893085333fb48d9056cb66c3bf01e46b4c8a6dc86416a10a2e646be92ae4450d351bd096f0c31387f8372c4d5902d44fa09dc44574b76c10651cdd4aab75ebcf656cb65c05aacc5456409ce2662ffe7396d697efef42a71174c608baf382c388ba1e7da6137abe95d3431a32f078901f74c0a4c422e0e11881b71b1e8f08b45587a456496b2bc2e98cb31dd6a4d612ab2734c27f28c3c6bd5aab7d8c16d449951fe106f0126a03014af39ccc99da9e76c23a3351e421007505ed30df0b044e3d82ca04bac192f6ce2b45041795731be92e04807f57926a1c004e07cd7c1daac0f6282d5d3911692a2df947dcd4d6c801bb7d51183ac9a8299200ee7a4e46ff2f1c4182684eaad8cba157d2f64f94f80a2b2b0818fd2986d6b6c84c7d2ef5c41d628e3800565a85aa4a96e07aecea31e7911c59f3a4a6dbc5c474cc1596fad11b55412539585ebc36c5566604a54e243a00827a9f216b97a21ddca3703f599c084b8651874fff9a24a130fc9519dd44235020b69d26bda561c58e6e4fc638f1a8733b4743c9a30bdfbd8a791391d283ebf5bf524d19b2ce3da1593a1b2abe116ab828b289972be352360269556aeaae976ef128160a0315706281bcc10f3aa3b984d1c6e667e075190b8e157969ecf204b250ebed5f4bd62ae1b713e93c57d45b030a2ded287f4dcb1320d963ae55794003bbc00f3b321f367bc367723484db7ceb032d7fd0dc1ed86d988997502a8204d9f3d00a8b9a1f8c7952cd415d2677c7486242eb2e24609c846c884b455812c214c452490f42b3567958c86613b0962606b94a13a5bf9494c8c7adb36ae58f355d071f61ca219836bcf0811f2b6b441176cd4c7a03c119ced5d0192df02e7fb353c8d5b90dbdcbe70368be5c59dbfb4f39e0dd03d9caf95b8a880c95064ef695fb635947fedcdd39486d4f45bb731a93b2065ea48b2bff98a86109a2cae26f3c450ea5043e58e50ba6dc82452421f869ec4786087b2cbeeea30e4f98e013e9ee3819d6a7ffd3b73e9df1f9da6b558d71e8fc636090d6b17c2eaaf6082d7575a857ce6c4c76e71c5c0a3c3dba826be0dafb99818fef5b81a7743dccf3cefa0a2393e3361218ce8a978be601c338444cb8403dd8e00c2d73cbb979984bf873ac403f853e54317e5a548305f3aec89c9c6b821cdcd1cb4cf885df3e29622da881f8c4fa10df46dd2c41bb2d2879bc679259bb143ceb4114c55d652793c7a5fed25f3717e82aad418a14be81f6fb0b2bf69b94816063b31b9da5b4d43b3c5efb274497ba7bd49ea0a88ae57196c68b936a4da2ed31c85f3c2c86edcab441ac74449d83cc6cad7d72ed68af5a297e72718a866792656fc5c76ae072a39315d0fa078e72494a649848e12a461042dea45c87e5da733d2309e23249746c9c1dc42040fa2330a87d0ff0829401e60e5ad0d5a1fe68ca7108b1e6f3f2a642cd5f713257bbe5ce07517ab62732254af22f8fef304a632b9cec30472932f786ecc9340729a8a91474eaa428b9fabdbe7d25697e9fa6c60feb657a3929d84f5bd374c82343b4d0195f432eed3d61d697ea0266a796046bbbfdfce12eef78920e4e0bc0b67aad0925760adfd1d5b7d989d5e2abdb930aeaf5bfbce3d54f611ba64e59aaf1501d90aacb37b48b3041226d973d3c6c0566662509b435a76a029ef92d08c8934d950f55eca918bfc91adbc1f4c8df19284ebab9f0fc37e08ffc189a4dfa742abb6003a47a67bb758717a3dcc93505125be96af783e143476523577b9f37bdd12b43024b13b4fe44c5369760cac4420ef63045624c959407b9f3a698fe9620367429520d182cc2808093a89abf6b3f3584a9a71bbd6c043b79ec91359e99d43c18b308cae4f4f861532621ca1baadac1175e0ac86c5fb45e153d4cd9b83166518887cd7a7adc5f3c752194daea075737d69e5e74569b028b8b2d9f801bf566da4e053a9912e6b413064a07679496fb9f72ca07dbe7e38eb9a3d46f0ff3d39cf71c64196888da53bca8975c5ed1df39399b9eb1d8f1bf9c0358e2d5011d1e3e478d09bc6cf38295a3676f1d78eddc28b6b4fcfb7b084b4329bc8361304a1276334fbaa435de3673f1db2b708b007054d9e068ccb3e490f11fead607600bfe5493d415e13b8abc25e45aabfba914c48e6c31e78f26a4164a8bcb96248dbe818e979678c21887fbbb82edc29f8a6e2bf6ccc1f942c4a997c3b46fe828ce8e7de9ae34a6c7f8aa032de330c11dca3e8f0d6a780c0a07ae0ee7459eb8e7dc09ac1272ed80c8ac6be7f4f89eddc1ea18e71b3ab87c90cb2ddd07cd1faa75f7b53919416a99c6abbc007958fd443f101ed4037d847fdd8aa3cd48a41c03295393eac18c513b13a29d33d691ac21c5eea3ed80a740f52c351b57edc83a2c94ec737fa078a75e456223b22447fa4c6ccc78cb4011892e972b59c2cccc2a5cc1711ef22123ba4a75a5a482d7d325b1c2f8bf8848e916b14ab5608f7c2ef9386b42eb08e1de6427856a6a0633e937c1b156cbf9ebd5176ca8c0126757d3fe8b103efe243d4679e5cc1c0ede6d5c69dc457b634cab53f4c6a612eae6d609accae0d6067a8654d22dcb19726568e8daefc43b4c0515cce1ba149258772d6bf64c31a36cf2161f9081c0dac053a69c6494b0f9f639f3032f487763abd2b81f6ce113bdd26c62ceea5c638ec0b972159960315c7e85f7e49442b4d49d0d08052bb90df56198f5d3acbc042396d80f3953939f76d7fbbf963383a5dddd7ea8c7366681bd3fa99962ed94b7989931d9886a18a2a236c6571aef85bbe9d0277d51368e1b9db458179cf443312c1423c403238496b83bd194c04f2d37757f4357af2cb9cc1489c5546f8dc69c5f6f5dec8f42a7b67c2f0dcaa91dfb7c9cd5125148f99b4931c06d740ef9083eb579dd72dcbfbbb75fa0dae122bf91d2cddfbc7241ed0b14dcfeee56f8cc9884d50ca68cddf4675039999f43b082fb28ede14ccbc14a5120691adc3dc603e10454e9879a9f85661a87300e553b4475a0a041cb5227d4712ef387accdbf08bd6b1c87df37e2872f818201e139fb228bd5e4eb221c96949d5e20e6b3c15960b22522f9d603df73c75a34c4e8a46da1efdc85c80f761e2f18db7ecc628567423f6236cc8199f74a2da2281bebe2b21ddbc00ce7b077e3ec1b3bf7d9d0cb223368daeeeea645f95b16666f5555338c7dfe351c47da8b54f798ef3a519881ac5eb056dd5ce1676cd392f311132d0dd16437d345c76fc66a605d3a1473959dc47f7296acbdb6bb46593958a6ce0310d6e99e92acb596ca4f17bb00be7c8479f64464c48cf4bb8af01608a95c7878a1371fb94c500ebf02c7acf441f927972039057df6ebb6dd26745e47165c66ee4ee09469579c4d6f05a6d79cd133fb64456acd415fa9713070a1ebddbe783dac23b4df66af293ac04b7a41e4d4a668d3a50e553646238b594329076745c4269d1e6c760e62af07add3041c84a2836a677d80a081121dd336ab929bbcfd6c4235af78b381369a995f5a0943c88fc71a540a1e9915020e8577128ffb5a9b0992c99eaf4ed9e8f75136190da5ee95f2c388809f64b80968457258b15b598140da0f66b647b6f2ab201e2ab8c1d5c1dd03f7b20483f7441dfbe8f6115658c5e7b43b19cfb7ec1b96789eff153fa141168a9563c31509bccc35aa794eb75f993e300b2227b27692040cdadd656b232b43542a5b65f810f33f8c57d777d6d20303080033f2b24a6a7746086ee3dce8f7eae64cf182e1e4a267e786a91acdbaf74d67e765fe946f3285ac5300e4d3f6d5fcf936e61289fc292c5c3c469bc125e72446b7d2ac7446fe916f73046ae02d40742a795ba983c91378300da87f836207084f8b40e21c6a89cab6e6e5f35d001792c5d0edbb24f4e97d9c345d0dd728dba53b61601ab36aea87aef01b12a07c5125d092e48b8c48f5a62511c149927a044541d108f977585ddb3c082a3bcbcabbfa9c92e2a18b92ac738220d95b073f8c7a428405c30a95c858fe2a770c00d000477ac3305f70fc72357e8314f2eb9fe63dae1ad82dd9abdbb94a84a4e27897431e36c10ef13e99e142a01d79055d611112405b49e97f365416674059ccdee8cce3dbec40c9a8944bdfe8bb4867498fb0e8f61a7529065f74118a99840a04f007f75b1feeb670298d00d32cfd0307097a7f88c2071dc69793fc27c9411721518b816adff543d1ef93b8e8800ffe609aed4e4c077315b3f31d999fb643a3f098f398b6023b540168dd53f65ab8efd31c43a5b3aa32a87fb5a6db35ef1da315ed4a4fbaff8ddd264bf49ea3499d697d029665572a7c8b266cd1df7ac6d217285afe6bc115fb4f0932d492eb3b1aad8ecd3b52ab4b106d072c572075c54a2dd48205eef4754431771264d430872d699ebdfabbe9ec4fecd28e41126863ced02f10758e780f8f66305b7d4e84a26a42a72ce6487c40fe31297a4c77ef0fd32f9feac9a95523916986748225b946486950473fee94b0c4f1d2fb3f3e75554cb4d7dcd197fd8567f0cdf65c67259f9ffd442953872c8af6e7789593477b27f7fef241e19e482b915b1c84df8667d17c2101fc49173283a2991705f58ec27343b5ec8fc4b8df2084225f054f57ce56ea6f523d45e7ce0ced705c3d3e958e7c5be0f93d9f2fdb4e20c7900e5cb466c45f8f07d1f170fb68df2bf8e7d6e5964c3f7b6268984c02c609bee16ab42126d816d77fb76afde448348dbae111f91ab1018f65f7e182e4231b5f2fe468c541d050d0edf76deba3893b5dde1f65573170e114eb1bc5ebf8b1d3dfd238f85468cb29cf1b79e0b3979700a1d2a53e31dd6e015df4d8df5849aeff3e5a74073a62b65fca09b3001142d946c9f7404e9f691fbb18ad3a66edd574b0879158f8aaccdbfcfd9311c016072c0088fff5e60b4b2dcb1d7884530391facd5c844255edbbc8fea3049397908468760c9041c76bb813126fe36bfd21bf874d63350a726d744b10f07e07588932a0f49b20be9c1e6a65169dd1daba1e1857d97ecc46321314e311aec883de084c686dd05238c824d282b94788f110e629c66c55ae27fc40e2f11bf4391e08e392bf7111f802eb6d40ae88e9e04550fab1bc1ec06a73b60b6baa42b5f8f6cf266821e84382455eab9d2e46c2c44130a382a8da5e2e9471748977698f4fb160e86abd0ad93be1e2d945da23cc3a29695834ecb78a9150ec246a774545803cf64988c9925614e630fa53302fe98161609948d894e669044ea9d1248022c62a14da3b05ec691ef2d76f011c1b6844e8c31c4bd553f95faafc0bf3485944e091e99a4936385fb8805a7548d715cab9d91060a6f647a2a90cbc8261161c2898788f65975856358d30c9d7d2117d4bf225dc80312e02d3b1ff3ae04fd0746f42fbff9cf9bc8817a1bf3ad10cf31d38a16f152d5fd05a56f297720604f3a0f5cc69903c37609d665bd2fffee2845fedb137a054b0a80792a8b784b2fdfeacd0b0c40a74750f29e0c1b7b5b0dfe324d6bf3d99eee9b999464c12611b623312a517e2c69e221d902db9fae43ac3a6159c6d2da4e5dc3feed239225b5e418063429e7b8cf6ebab3e8f325174e332cdaacb9eb96fd99424222db5878f35846b7f214c684137c8126a42ece73715ee7cfaa7a97b6a91aa270fffb3ef9dc37766ee1a6dd36b27a1526d05924e4513f8f22972e1e97d7ae9ef5129647676e696208cb24817efb915744d132a4b24d85d7c39da6a1371a72ee8101507322ac7a7cbedea08923da79e5585d8768cb2f3c2d3101ef5dde43239fdffa6587459d1802ecf63de61a4d98e4a2075412d5bcf9a3d912bc4c148b05866f402a0b283c62cbc83f35058479d3e701efc0be9fcbd868d8c3ed5acadb3b2779867b75a3e6f982036a2c673ab73eae3abd550a9e4396860110f536733920368433a81942714db629b865564d5d1b0b8df1ed68f20ce43d96ef111726e2e8a2bb4e66ed0cb4fae55e74706f05e122873184071f0998922d30cab4c8f4f0ac41dc1da9bdce787016be9a0a93bdb764c58b7d08f1ec16ef77f5fde5d8e8c57648e231c7e6a727ba21008875c88307b3b02595b88db1c9fbef0cfc69124b3bb9b3cec2213934a4f18b86178263d31a898572dfc5b440e661a72073f66d55c4e83428a8b3af0c6f56726127dd866a4ab8fee7a8768d7ae31afe5bf817cbd3b4b998ea9917ca397e06e6330b14d2c5dc19e1b9b3b57dc2014b3ad2ff62308f087c088060f164285f4b0199d205480cd863e12e76aadaa1c71e78f1b3c5be7c5bf73b24d697acac91c2ad640af6679526a9a118c5c9d635b6c5abf923f7879dcd72001f49b42d94cf8d8aa0194a36912ab2fc1d30ae4c3be38b04ab30cbd020c7dee4d2c7c20a0d0cb14f0e7f0ecb87ccc322fe88ea07c019019a938b3adde77ea96e8f39593eb0833ae6e1b195ebb883966b488a10eb592ed3425006af7c3d57907dc3f142227c1246e03c4435b1b8e153e9b142d45bf1c41928dda2fdbac1e82d5919718fc99aaaede8fab9631ec148bcc81bc567a8cf75207bdeccce0fc4cf856445f2e62ac81189ba10dae56be7bf3354a33907c4e3578adca82808382aaebc3c317123a4a130b1c8e67286099af0b558ca0337fd3a613fe512c83d05509c3569a1a28c69831c0c95fa9d2a93b51c3675a1f3b2398082042006c35c6265ab62281d98dceef0ba2d6c6d2f7dd6e8db948734d1de30d929e34c5fdb6544f83a56b76391352475d71d1a336456bd4c1c3a8dd64d6e40dd5fa9f0268d1e0ed9d500e97331baf0a704bc2c3755d2907c5edc570463611f31e9dd33cda757c31545755d776f36baffd3af9423e89aba043a115efa78592585efefd24a24ab721e15c97fb4904808146d382ec301e736599dd9385d605ae18f4687d9890079cf31085792e5733df61ba501d3683f3a578032bb8ea248440aab7e8eefa502d82322616d38afb6b3227d6c0fd018fb22dd929c7186aa2125e3b96494c81d43488c1da08299bc8037c265a65cd181f44fc2d6bbbf2fa4cfd2a62b7e869b7a03f40a563aec8b89deddc7289569948a27e8bc9255a851c5e42b566ebf84753af5705fb78ac131c9bf23cc3eecc710fcf32313ef836ab6273cac3f438620eadc169d51c4390fdcdde3007283ed67dab124b87a951da278de8632d8c80de13237a9b10330855b395bd75dfd038336d52b30bf6e9dc5fae2aef4ea5171f9eac9414193e75786719a0f7a415fdb9af7c7627845a78edee340c1bdc1d8e18079323c6fc312bfcc410eeb7bcb64f9f08d930285f574b229f98c50ebeed874029a5b734a997a37e94a40598da8d3932e5158ece88083cd0008cc96e4a646b11bb0673a357a71faed463912b80203ee3b32a100257f39f79d1da395a2357840ec393164ebc6b24cd56f042fc357384cd877afa6e0eccddee67475229882cbdeb3e1883d64b08d1aed254511fe08d9e0cedcda7464f023370fc8df11cc117ad30df856906041e6049bc5544b6da21d1bf498a739e319582e72127465c981400806287c1d09e2ea98f9c93fc7f0c0c6c39fd7004730ad526db90f041d9ff328469b8242d354c0172ce91bb01eda146504fd82e065dcdc1165cb5ff0a856b69ffbaa9b6c17821c803d1866d1617f8d051bc12467ba051eabc23429553d179b88cade6fd6cce9045a8b7e660b2e9a40240c4a68c3d0dd237f61e2f21f90eb7689019babf7f319ac7c9a7c773401938aba5603ee6709610b17e4a43cb4c4beaba8d6f9654df581327c06c63cca3709f41575817ac24eef2ca1783d471ed013aad6ec1c1504124f85806cd08ae33aebec522a32ab50ce43f27a545d8f0025b28ae8d148048f00921cdebc7c1846a0d7d8032d4649e9b15f8d4a88e20b55a306f4f08e8100402ce837e109bd4339c28b4bd8fa68423596f32d080a277729a5aec8728ce65936cef9a4779aca35c9487783154e5967656636dbe6e5f17461a44ec54a0acf2769ea81ee0820b7da753a17535a6872744e6dc4be481b2298308c4a7685b2b8f0ec57b41c2ac565d61f69c708f3561674e8692109fd9793ad03d65e3d4bb75022bf05226871ca72ea348fe3973f7c05640aa71755155aa7dbab3e0b4b7f46b2947a9a594b557d2800ab5481bb0a2e1745fd66cdb86d376751a337035dfc007c9669d38fe5b575c01c6a9f6618cd84e218f41fc48b5f91982c4a5be9d693e06700b1ad35b6c10ed48fc18d932082d0375e00257fe03b0078983b390d59bb6ce4feaa0ff94acf6c15d59979cf0060b359bcd7bb813f733e8f3ad192f1ef7236e404d3a2e02f9dbd38deef9c2f28915bb596a94214c1d430ac84b001d1573b433941822753dc6cd1f83e5fbfc5b356becd7f141dfcb383f9f6bc18df2528ac3f55731fe1024a5de1837639985cb0fe387fdff198f93042f85056147200bf8cc81398efa02d2750ef49ccd1bbac9bd913701dd061b5e6f9b8f1af2144f34e044274f7fb6bf406d55248de23135cfa4d8375fb2fa3f0ec6eeac6f059a60c2c0becc9da95c24c669abbd9ff52e43b6b0c6f8df27401f15759d915ce10868b97142a7f464ed223a51645b3a39b017b3c08870cab6baf20405bd1dc36918e58318721fd3671d212f195366fd4201f46423230b776917d826f75f9832948c134c1cc42cbc4092bedc049eef04d55f30222d91ce1d460af6c0227ee0b2411cbeb056d5478f18bc738a5936afbc44c9c9cc2c6e80f7295305f503e7cfc987fc6d5d8c2c6d874487a5f314d66c081210e20222aaa2d5b8820e2c5509f839203d66fbb3498916b81347d3cc7b43e314e890f967918a719bf6057ef9973759f07ad7d9c8e979538f2ac3965cbc10161cfa92a936bd92f9f5bfbb3a99f54c0ae2d9bd252cc713b18120301ac9144cd325d69a2cad47af5f682316e0805879544ebf1b4e89385adf9e33554ca074dd166eed854ae0aaaa7515d2077ff7deea9f3afd1ab2d16a6054ef65fd631ae29789a69ca1630a57f7869e80b9d7720c1da8e76bd06e4e6932701fe7e360403fe1778d4684d6ece35f26d67cf24f5cb20789859349fce385c79b32564197fdac82fd387aa3d774f4ca422ce8cf928c995dc37c00f2226f1e42a2a708c73d54fbe64308417fb4d02744b3647787b83ca5a2d69660dfe8ea054d43f6dddfbadeef0879a43b51503c4adb89e4657c5e158ea9037f47b6468be4a90114a1d8454926f0967e8667cec2153034aa06862af5aa3ffeece3dd4c5ff93aaeb5f8f1ce35d7f94286e60c8f36345f7261c114dd7d09ea3d5ec796a9402286b16b423e9754a01178ad1307861d1edeef7519849265e09f0ce7e4ba1fb51751d990cbb1f19d715058259fa04526e37bdadad64b861283cb31af1ce6ba48f35542b03de18c89495e643ed37e33db6d313dfb0770f588fe5024a5c0c698216e2084e366aad4bcdccfddb282b4e7cedc5e5d9574eaf8aaeb17746eb3902c77da4d4ef0afc315265093af1c3cae74aa2e5b2c9876041df1f267b096346d01123274168fb64bbf3dc2bde81211efa11cb4c00d7a62ff8920cecbdd5afd29a488156ace56b92d52d09e29bc83fc5d1a3efd771a94559da06bf9b28289620231ac3ca1095ea535d23099321beb04b62fb5c31884fb879b3a8e52356efafe5d7b1e22692868464018e79c54cc4049b19585a8ee196e4a8ec835efdaad17120b6d7e33bcbb66dd17b7e18dd83cca71bbcc1e360b2b5f1d4e959580b9af1fec1cfee4144c3a3169019307103bfe74f40100183007537548c8d16c5cb8f12f458b2ade78eb3ee4a7b3a254db9ac00f9108c7b8cfc6d994b4c80c413534d81fd371f1bba76df0eb72d46bb372ad6cd8fb866a1beb9e579bbd0534fccddab9a7265a53469c5bfafd537370d512f5d77ed263ab2407ccb5713442a096933d8f7aa89bfa2533e0027afc6681f65b418f0514b73a7f54d52927666471cc6cee6f4d74b08094477b302571ba10a61f41dbfa504e4c2b7be137bc64b7a16c7f562a6f2f2defec8e1f1d2a1e3a4d211fb3cfda836302ecfb9fc620152b5992fa4bf4c6c9939eeb43eb5983d8a585c38e01e234675c2cce33d2bf36722dc1fe24a79609a46b591b7bb730de91bdd3f680e0feca2695ad7459fbf2c4451cc13a9331e2fc67e8d838feae8a4eb39670a7776010a9cf7058b7dc75a8888a6650915b030b5b4a399d535839630a8689c4b429dd8dd8bc34506c140a659d579c6a8f2fee0d9d783dc0b60085f24046d8629c32d51484f5ffbc16f9989e61e0cb0c4d427a8515f425051d74bca65d798e6c88036f6244400434b2f0c54d8bb414e09654b709c0aaae20d333fb7828f128e67b9a4b83f0bf325b0e9b873fe18a16a0f2cf3d07355b4d13677e85dd0dc3ab65c6e7a32fcbc5a965fb984ca8c50ea00faf260583c20ff0a7eb89229aace9255d72ab17c48dfad656e8a57e4ccd2496f53b0163d0cb2f7a865e2e8826215d614860c2da9fc7131fc06bd488e6cf6bd1c4cf0babc9ad1aff0edbf46e6dc9f8518375f5346863473363f9e18565431c09eb25c0aa225ac919dd7b94379a109ba4cdc73895c49f0ea28ee607687a7fb1a83caba93ba8a8c0bc511b194f940b11d344a76cf273e39f72c3b2ab60192baf3cc4590610f34a229c2a8a1977d0afd736b862811e6db9552df70980215513e285955d9eecd1b02daf733669f3c8c46b2d0a9d7420f5198853a4afa5c3620a211cedbdffdec6ea2dbd7b4697c018ad78df6e93cb8d467bea186940dae078aeca7d54f5f1d4276131b6477fd22c0dce669de1f93dd905d0c4ad423b9e3dc68da89ca88ec1b8cafd51855d07b89a61db12122381ada40e112336eca0a9de6ed624929ff5b2f9938f866f96f463c5abb35c18adcaa990c2f3b67c3d96266bc5dba9b48620430172f86f600a560fb83298116b3952a25aeeac2af5a25cfeb0923d4b5eff12de3a7f7c326479dd4f8dc4c7076eed557db092bdafb7f80fcb4776e05310576805775b0419bc582f9ce3c9b6bc8bb0243f2d7732cefae4dfeb97bb2e4b5b376bba8fe96e2432cb8ec89597cfc2799e6d71fbef84dc70aaf4732370d8017c80e866a6503de5d1a99ac381b4b2cc0128c9ee2ac3f639c9234a14e87b873772fe8da03694c953101a3c9c1c4f17526dd3c98fe9f99bf08f6e3c2bf8898fc08d3cc0180923d8a4e8c6dc517f89efa9c116c31a91aca93301da346c9350f5e3385cf6fa9b60a19e5542cef38a4dbd3fec6e0739e37b82318c4c450bec1a43c851c74f65c19448301c7504c71f4989be0d23e088649f5283b0089281ad8647fc01650e797aa3bf73111880165850b3b7e7a1bdc030d85ba61f03d27ff0b235dbcb1f46eb944a639b8d6506615f87fbb0b6e4f564d85a2aad8e8585d563dd43174245eb34aa3235bab017873f030a48137cf47da2c7f122db6679ad6837eec95e91ebe352f84633cb1255314ecd369bd8f69ee49cdeb77f7cb1384dac0d02a824e82a8981c2a616fc7da8e91dfc59b9d561e5a70bbd68a245df78431e2383e28e57a6c55be723fc65d9e4ba3a26897fcd8fe8cf8a3be6e81b60edc2920ad3d91aa85783c6d57d03708b2b90f4f73006ea1197dd35533101b010cbde20e25fc7e96d534597d098430514b6894ba52508ad68b586764c1228397335859cfdc38eb46d3467e354bfbd90634a6f11c5fa273b45da495c2245628bac0ba0961794341334b275a34c532d61e6bda44bba5428068e9a6cde0e7b717e2d0ba5a8089838747f20f9acd49808ae63828f1b98dc07b5f2a3ebefc123b4723b80773816c11cdf27f1fe557dbabb6571ae238f1a08c1189df4bafa1135a55ff328b88315a471aa05c0c474d2862aaf5473c1d43d1a910a7a460e86825c938ede75b4a8879b660df7811444af152055b53fde5557c3c21022bea878eba91005e56f259dc569756fa597cd2a21c2c5d3d5537b1f100a32345d82d37db39ffa06183dcac252aa43837e54e4398fc3da3ecdb0a542f28bca73711e36aaab14aad8dabcf209eb5917dd74e27400f50d38a3e7cc0ec0445a858f43e7688ed2d77b850d011c9b85924e0255764cee1e2e423c242e4df73da60e637c5852a4158b34d5dd3c5c8a058b4081a858502b07ab3141535422217d59e9a8a77f2cd2df8a3e8d1abf689dc131d5da3f12f1efe82e6b31169cef11924a5147d41f14cc214f57fb1a3f8931dde6c5ff55c99d90bd8f1de1b1d212bb2626ee0029375adf410c01e1750069217724c171c868cdcd15c847ff5981536bce50657d9ebf440da0ec4cefb8f4b932e4eef6442749c5fa3aa55346bf39497813a81ee9b13b89636cab667dab4290c4f1b9304bbb883075a0cfa88a40595f590d311f2daf5d964a1030a8f8943530a6d49aa0ac9dba39846cd7573b052416978f2b702d9df9231e1168ccf71068ff069b26f7f787a2c8a42bd81d0ea48d3da1461fb5b6442a3e79b78aa71c9bf22b1d12312747e1e7994153c65c30f7fb283d571ced64e4532832a36989821b3d230760b2527454ca187505144c76df8871cf574a34d15e1db3f1c5f5e852fa07debbca35610ff4f551f93926d8db8c00a530c3dea0e211e4e0c0b5aa0ee0dcdd62b5d7e7e458a66b8342a8464be7c942135600761ff8ea3b8e5122a6564f66480c64a583d4b9e0f0c1b7b9268fa97519cf408b6346d68daea640d468a3746c7aa77406d795a87722b789a54815a04f615bd5d38d33a1f86a97e5a02884e364bceca213c10f6de3f395ed2ba5e1b4f80aee2465de1f725bf5f1ec52eff93366274b2a9ea95d883abedf702b3e53fedbc012ecac13f6fbe7559daf14d9d55798eb64a2c044a761b8830cbcfa9c9b39194291c5ae5cffa7c6d543df397e30adac03b314af28e7d84bf27d522d9e60bab33e7a86b62c5166b7eeb52cebdc7b814cf8e45f660d55467a053b4d0dacaff900795b6694ed4f572d3a9d3b95ce3e41b50f98a36a2638b7bbea7ae1a3855e92cd7f81bd5b8139c871388d7d32364b602594d4e3588bf2c50089c4e5ad5304517f0b054766c20535baeedcea172ec40bec6fabd1494e1c31dfeef3828c02758d9c71d22d3ee6ddf8a2f6b203f3ddd5cb8aefcd19d02e28d0852364945c7252cd8f6dc0e67e2e8ffb820ae58a96c2986fccbdf364870fb08982f6a559e4bbe0505ba041d85d46361f2fbb4622fe886415b6ec8f90b7e5394f66a52789cdf8a8ddc3109f93725c7e83e391786749f3bab364718e5746a89577ef2b82822c277b9cf2e290700848fbe62205fdc3d0e27f10a6cc8d25073c4c61eb2b0de8649350d71c097d1af35cb13e90afb360b265be5a9a6280ce81621bd13a7fccf6f137b6bbd2b7cb29307d3888f54d818f42189889d3cdccad225ae470467805c24dd78587a58dd54dc329d331d525945262134b44b9f54ed67659abe35004e88f73e2960f94298a74d397f0091992fd3844ff69c347a26a23c56086ef6d5de4c70191155e6affc1ae5b27bf2d6ee267a1db295074ac8e1c327cabf24b384669758e3733c8e31fddac00168bb7acc442a1071f74f0e156d302dbaa18233be2dbde1a7d54175fb3ecff803b509351b4a0b88aef3f751778210b142ca429efb8ecf8023139415fc75c093de7ce1ce760956182b4236fab83e36e64702d65366fb8c8ac2db792f9a696e91c609e8463052770bd03a7aaf4a85a364928138ed80e68d5b43bfab6fd70c797bf3fa175db91b72b5a513e59469ec22f125f710be21ff397f4b0b7de59259a6d0cd63b9acc509b2ac24c37f93c34c7430773c8227c37124a52a800c4a0dc2db3f2013705348dc18591bf4f04dd0634be9763727769650f1e13aff780100b08f71a90d9f16d4eb81d98fd0e9932f440143596b7fe0d11bd30adbd60d21cb1b28e7b546dc613cb898ad0f6e6b1022b8ad025174a95e0089ccc6010db7c4a9bd3582b1d31c227beab9c51d27f8817dc40bd57eeb307ed9806e0432a20d331550fd19c475419bd12c8d741cac020d0b42198fa838829630422e27e4dca9d89cbe4a8a87979533cc5632492411ec0a54e3af1a317e245cb2cd2b0512ed707a9b18ccd1623c47b1d7540b8e76b4aa4799880ecc0de36649f13000c373eae2e40eeccf2a7fe33f0af53e41d91b77c5245f99c35a3353989b9f01880c3c2f2671b886b67baaa1b2301455b1b52efdd506c1bcaa5c7e925aafabd877732e4b1d92fb20355bc87464a28c0db0b3b09cd4aa53137bbea6cc30a480fbb9a7142256255635951d5088ff6c2c7994e151bc25688058fb98d1462206d0a1f0890cf6fbb238d11bd4741ddda2be497e1cbb51067982a93bdb83e591135154c101e914353d8790190409b2e0a5b48b3790e80574357d649cc705c1cd42da1ccff993dd0b16bcd76605710ef1a6c5278345dd2b5001327ed0fa4c95835a86e39dea005c3639e97548724bcf2f061a39e4769d3ecacf4e1a2b4d831061b4334fcf64ed346812789294511dbf7a6f9e901b75b2eb67d23a862ae1807ae15eb3fe8f4a0fa9b976b091ac7d03f87bf187f73c12481be167c48661595c2974b79e6f1116c37b1509ec1432c629b313db3393170450980015309ba5a9813d36d45fd786efb0897940255aaf0aa9cbb3c405ded8171cf8ddea38a2127ad89734fed4de59c0b47ae3c9b2fb2cb4bcf488e978a904d68e0d7b5f893067db7940f172bb94c665a31966a6447429b101ddcb5a1c617cc47f350ef37c323100c20161a31e17f93a1790f10f4b37a238c81b341fa2ceb8f90a1ae6cf9709eb748ac5be867b0f15a48d49d3d2b010812e971975e866c0a97a35a99da681281f4bfb0455646ea58041faa9aa1ac36e652f92bf2d95361bad9f0486bf3c1edd19cda49108b15f5f3a438ba9c5763ebc9a010f2e08b26ad5274cf9f19b570f3878f05a826a9447508c87858743d3c77c4ebb7d25b673e871c5330257bd77bb71ddfceb97f4e7895b354c3ab2c0ee7470f631f0ed31a84484691291093c2ea223b58b0a8d820786af35f7f477a671f8bd3a19f72a3306266a672d8c214fe896cfd5aebb3d5863122c4519fba0c59c78b05f3eb7682b83a4d88dd199dff00a3ace29312e63d32f03324e11c990e16c87990b10c90347e27bbfb4267b439d656e99f34e1527cb16a2a25358dd2928edab2edda2952274f5488493bb41f76afbb6d225d1183646b1781dcabb610299b98dce34244c454b76bd3877e8cf2462b5ad209cea9a052a030513c5ce152b5d96e951fa8ff56bd65ebb5c2b7e0a4166d401b11435207901f245ce6c43e38e9b3e708506ca122e9df19d8e5e484d1a326ad73b485eac1bb9d84abddf054681f3bc70bf3d15e2312164e2626efee15187405bdfaa694905f01b2a51063ffd24fe35095eacc4cd9c2bb99841d9c8dcb513bbcb03510d6ae103f98d05178b5cc611881cccc6232094f37a24d85833ec9ad68cb1efc308ba08cc144ab6544a23beb164e86f76738b414b54f0cba0088ce958b9b0cfb0edcd8aab5ba2875a698801d31c12ab957af16bbc5896560cb2215566f56ab57a0ede4d92a8fd3c6fe732ad30255040ec01be4d44f2d80dd64afeae2d9835e46307b4a07258155af97c71d6a56ecace40625858d156f5f92107ce4db9b589e27a9338ebd8349ac9f663033bdaa219a8f1a06e1d8db17e3d314fe7e0e170155e63ab983cb6007cf64336f9220058881c6159eb038b0bc31047d77404f4344c6f8ba4c1548e59f3d31fbf999c4f22de9b2667266c50bcd211be0cecd4c95a1d53dfcbab9235fc05c0b6784cbdeea46f121a19f58305ecdc590d6a8c777d36042bf31c6cbd28e4724e778a9b062a56aa5d0137095e3b90c055adbed8a9438c7ea2ce712ef2c40a03f7706c310e3f0bf6f33eada18d04f296ab1185d1fe6367b5f3c614cb7776d8d749434f77a3aeb26508bf66607f594e3371ae2911e8ed2d9508df461428225cc6f291ed70d0fd6ae7de5c2449b55602fd7ce6c25c9a6c12666493f97b4da6f6ba7cae254f888b6e03b68cef0fa732c9a8f725149b4b0f028b58acd8dfe5fce31e6c6cdbb949b84196255af1acdd0850f364983a9679467e1881c306f10caf17816ce07299aee87f1e0d18cf3274e63fc716a0bb9515eeaa48fe412b7317fc80ec835428745b3fdea34eb43ebc3ee718e28c2bb03cf2b87b0acb3db32c0b1abd578d532b39eb65b2ec03f0674342cd64efc27c9d9a1057f645335d03a2c105d04c0f9c2e0caa5c31103148aa87d067ebe6a33d51491b1554acc73702b4733d0b0eaaf4b5a9543e860f9a5bf61187fdc78c08b5b9ea40637a64e18f5637554e3b6c6e5115a31db95824391494a265d5112fe00c1d15587fd29b7485db823e313a04eb61fbfbb994c08711ec2a4cb7cf04ba469f002a1da58d84b7a18ec32004c209cc926b321f34438892ead254da5752f5e3e6acb6cb7b60c96de8b6efea93b50c901315228a613954610637e3c4cebdb2203a6f26b74cc60db9bd344b8b9387f3f3efbd696b3fd66a9c1ea7deff74fc039f252daf94c0d1104c9622610380bf9f3eb76ee2142f4797d0c7249a1f986aede828c69345d194c70b4f6be1b13490fc2eb9b2d580fee249977fe859a25ec856da200e9aab3fc024f9875c64b43f809043b643cb89fbeb8479b8f3b6fee391d95cc216d3eec69631556a4e947ae2a05cdd75c475f32bf912e7265c11e68b27061da629fffdb60104b1559c4a2bea905f05fdb7559a4686ed3e43e7505f5cdc57cf4567d14838140da8fbf904556a023314bfc53df532bab24fcf3aa2271bbd3b243f95e5ee7a8729a110ee1fb04d6a05d51f6fd451104eb02fa1749cf4d37519326b3a985d5cabbdb098747f49ff984fb82b5e3cd141e98241cf70af1039627988bd44e1f2f92ca32208054931fbf9cf076aa752d18bc8482c8496a0bb3873395a05d8194363337a0fb8c54f353da5fc4997b19603f8b121672056831ae1eee061c3f304e8b2ae9f46c2eb63cd65b3712d9b928d9c7a90e96bdd07b501db6f12d86cf0b87ea83ff3890492ac2c81d15aa171a0fd99ce9c88b5a47509af73ac7b75787ba4abfde34db034d4fbb790b97d698463138060bdeb109ed5997aa98477da7b4c72c282bb333e8185413f194b9e894d432daa011e53ff18ceadaaefa3f5a1d87040c10688fce7b6b2b3ae7b0c2d97b3ef9a4c13f84d12ed78c7c74bcc7ae55fd600bc258309fdb6dcd458a9b69753719986d959a6b6a029d3a62705196cc8985e295cbcc95b5eeae797a6472662ac9d3fbc9104d7271a6fddf8c6a80f5b51f6163d49dd2fb0e755c0a1d98e8b6dbba8f31645e5fec8858244219325d9ced249370e97d87eff778cc1f00f75831578fa08af07849e84491245ab73307534ab87be7584b786fbee4b9c77d27c4f28b8959dc41ae9a74797abb3b79af1460646616d4ddd636f3bcca470b654f9e7a49c27ab5bd618555138f0eb88659297d2f10ced11fb3c93c4eed1fca0657b29b8f4bd6ba67190d230f2b56fd3a9e6efac1055d98ee9ac12fdd7a213f614800cb3a14f1acd798d4cdcf09fe883a4c3bdba3c140de23de3f4085fad08cdb547574174a6a4f781ad3bdda8fd7156a85f0f8b785681f33c17c6d61baa775bc5c1bd2d98d7ec64fa01d8d5467e8e9a421983f39e1afd6b59f724d04a53c35285b877eef3ddbedb1a962f78526867cf52611c946e804b582e6c45d057de77665026281e773fc9d8b4b62b991c937bf4bd5638dfdce218f6ac33ad712d546ef931b1d6475ee464ca61f5732306280f83b516762d7507dd6e50bc37013b55c5c437921872742de269e54488446a534c90c5063a73b71ccfa4f7e54af4254ffcb2c787af8e7c10d40038eedee86684ffba8af81fd8ed428b7538cb1e5c7e474e3801acb761e78e1f6d28231628ad7c8d690562287cff662f6210520a746cd6af585e81d0806c2e42dc153dc90e77e4b023a8bb4d15173da77e0f8dcc4b9fe8b2358eafaf1303cb87aa13df90d5bc09d59f08c2fc96be6b99651887c5f443915117c6b7757d77a987ccade7b7757a4ac472f1c5998176853ab6072c0a6ec50ec0a3e0128c6003e5055db60085eeaafe625625c0ea08d99bd4184d3a12e2f1a0797933d317c3eea9a53ad19c4988b6076a4638f931f5404f395da497799cec3271e5f699dfaa56d24131671f4847fed5967d1eac8e9756d50eed133ff988b756dcbf9605b53523edee036c4bff066b83bf2343d892b74c9ebb0462ee109e0f76a2f19bc39c97d50c84a144e43e0c20fbe694190fba1a0d434f9b8c651aefc0e8bc552bd786b14e56bbb42b472c76580676bcc6a0e4388be216c72addd75a90d5a3f76c3d18cf3b9748463a94c29262a45a6d49fd54907d1a00c26e7dabcc30a4cc0acb1c9a08cdc2b922bda0cad94f6ac88b0d8f60a8f80bba03f62ff71d0bfde25048cae9d7858214b9dcd86526e710ba3f1c57017deb45c24822de6d2b299cc170d27a7a84721269bcb22fe0235e2410c4b813927871dda8c369eeabf3b4e3f253ae2dc9e35b656edff7282b0a3ece64c2b10bd64fb0ebc3b940ae9e9fa614425e7d72ad62586037504774678ded222668f3b01765391f70ee336baf65d3f4420df1c0b5e2c4cbd6c265b0d878c4032a54aa82a880f0684cc5f9a1b3de15aedeab95b052827fde60829b58d513796227b9a2f6f6ea24fe664356fea02439ef49e3ec01999e219b65746c089ae31d4702fb4ae9da30936d4d37dfddfad366336d612cdd</script>
</div>
<script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
      <categories>
        <category>数学</category>
      </categories>
      <tags>
        <tag>Math</tag>
        <tag>LaTeX</tag>
        <tag>数学</tag>
        <tag>微积分</tag>
        <tag>Mathematica</tag>
      </tags>
  </entry>
  <entry>
    <title>Apache HBase 全攻略</title>
    <url>/posts/45888/</url>
    <content><![CDATA[<h2 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h2><h3 id="Coprocessor"><a href="#Coprocessor" class="headerlink" title="Coprocessor"></a>Coprocessor</h3><p>　<code>Coprocessor</code> 其实是一个类似 <code>MapReduce</code> 的分析组件，不过它极大简化了 <code>MapReduce</code> 模型。将请求独立地在各个 <code>Region</code> 中并行地运行，并提供了一套框架让用户灵活地自定义 <code>Coprocessor</code></p>
<h4 id="编程技巧"><a href="#编程技巧" class="headerlink" title="编程技巧"></a>编程技巧</h4><h5 id="充分利用好-CellUtil"><a href="#充分利用好-CellUtil" class="headerlink" title="充分利用好 CellUtil"></a>充分利用好 CellUtil</h5><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 直接使用 byte[] 进行匹配，效率会更高</span></span><br><span class="line"><span class="comment">// Bad: cf.equals(Bytes.toString(CellUtil.cloneFamily(cell)))</span></span><br><span class="line">CellUtil.matchingFamily(cell, cf) &amp;&amp; CellUtil.matchingQualifier(cell, col)</span><br><span class="line"><span class="comment">// 同理，应尽量使用 `Bytes.equals`，来替代 `String#equals`</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="发挥好协处理的并行计算能力"><a href="#发挥好协处理的并行计算能力" class="headerlink" title="发挥好协处理的并行计算能力"></a>发挥好协处理的并行计算能力</h5><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 某些很难使得表数据分布均匀的场景下，可以设置好预分区 [00, 01, 02, ..., 99]，并关闭自动分区（详见：常见命令-分区），则可保证每个 Region 上的只有单个 xx 前缀。这样，导表数据的时候，轮询地在 rowkey 前加上 xx 前缀，则可保证无热点 Region</span></span><br><span class="line"><span class="comment">// 在协处理器的程序中，则可先获取到 xx 前缀，并在构建 Scan 的时候，将前缀加在 startKey/endKey 前面即可</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> String <span class="title">getStartKeyPrefix</span><span class="params">(HRegion region)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (region == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Region is null!"</span>);</span><br><span class="line">    <span class="keyword">byte</span>[] startKey = region.getStartKey();</span><br><span class="line">    <span class="keyword">if</span> (startKey == <span class="keyword">null</span> || startKey.length == <span class="number">0</span>) <span class="keyword">return</span> <span class="string">"00"</span>;</span><br><span class="line">    String startKeyStr = Bytes.toString(startKey);</span><br><span class="line">    <span class="keyword">return</span> isEmpty(startKeyStr) ? <span class="string">"00"</span> : startKeyStr.substring(<span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">(<span class="keyword">final</span> String s)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> s == <span class="keyword">null</span> || s.length() == <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h5 id="处理好协处理器程序里的异常"><a href="#处理好协处理器程序里的异常" class="headerlink" title="处理好协处理器程序里的异常"></a>处理好协处理器程序里的异常</h5><p>　如果在协处理器里面有异常被抛出，并且 <code>hbase.coprocessor.abortonerror</code> 参数没有开启，那么，该协处理器会直接从被加载的环境中被删除掉。否则，则需要看异常类型，如果是 <code>IOException</code> 类型，则会直接被抛出；如果是 <code>DoNotRetryIOException</code> 类型，则不做重试，抛出异常。否则，默认将会尝试 10 次 （硬编码在 <code>AsyncConnectionImpl#RETRY_TIMER</code> 中了）。因此需要依据自己的业务场景，对异常做好妥善的处理</p>
<h5 id="日志打印"><a href="#日志打印" class="headerlink" title="日志打印"></a>日志打印</h5><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 只能使用 Apache Commons 的 Log 类，否则将无法打印</span></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.logging.Log;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.logging.LogFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Log log = LogFactory.getLog(CoprocessorImpl.class.getName());</span><br></pre></td></tr></tbody></table></figure>
<h4 id="加载协处理器"><a href="#加载协处理器" class="headerlink" title="加载协处理器"></a>加载协处理器</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 先上传 coprocessor 处理器 jar 包</span></span><br><span class="line">$ hadoop fs -copyFromLocal /home/hbase/script/coprocessor-0.0.1.jar hdfs://yuzhouwan/hbase/coprocessor/</span><br><span class="line">$ hadoop fs -ls hdfs://yuzhouwan/hbase/coprocessor/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 卸载旧的 coprocessor</span></span><br><span class="line">$ alter <span class="string">'yuzhouwan'</span>, METHOD =&gt; <span class="string">'table_att_unset'</span>, NAME =&gt;<span class="string">'coprocessor$1'</span></span><br><span class="line"><span class="comment"># 指定新的 coprocessor</span></span><br><span class="line">$ alter <span class="string">'yuzhouwan'</span>, METHOD =&gt; <span class="string">'table_att'</span>, <span class="string">'coprocessor'</span> =&gt; <span class="string">'hdfs://yuzhouwan/hbase/coprocessor/coprocessor-0.0.1.jar|com.yuzhouwan.hbase.coprocessor.Aggregation|111|'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过查看 RegionServer 的日志，可观察协处理器的运行状况</span></span><br><span class="line"><span class="comment"># jar 路径后的 111 指的是 coprocessor 执行的优先级 {@link Coprocessor.Priority}</span></span><br><span class="line"><span class="comment"># 最后一个分隔符后面，可以传参给 coprocessor，多个参数用逗号分隔 (e.g. k=v,k1=v1)</span></span><br></pre></td></tr></tbody></table></figure>
<a id="more"></a>
<h2 id="环境部署"><a href="#环境部署" class="headerlink" title="环境部署"></a>环境部署</h2><h3 id="集群搭建"><a href="#集群搭建" class="headerlink" title="集群搭建"></a>集群搭建</h3><p>　网上相关资料很多，这里就不过多介绍了，可以参考另一篇文章：<a href="https://yuzhouwan.com/posts/39683/#HBase-部署">《Apache Eagle 深度调研 - HBase 部署》</a></p>
<h3 id="连接远程-HBase"><a href="#连接远程-HBase" class="headerlink" title="连接远程 HBase"></a>连接远程 HBase</h3><h4 id="基础环境搭建"><a href="#基础环境搭建" class="headerlink" title="基础环境搭建"></a>基础环境搭建</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim ~/.bashrc</span><br><span class="line"><span class="comment"># AuthParam 后的值，是通过访问 JDK 的 archive 页面，登录 Oracle 账户后获取到的</span></span><br><span class="line"><span class="comment"># https://www.oracle.com/technetwork/java/javase/downloads/java-archive-javase8-2177648.html</span></span><br><span class="line">$ wget https://download.oracle.com/otn/java/jdk/8u191-b12/2787e4a523244c269598db4e85c51e0c/jdk-8u191-linux-i586.tar.gz?AuthParam=1662888566_e28ea6d8c6365f1157471fa9369ee4e1 -O /opt/jdk-8u191-linux-x64.tar.gz</span><br><span class="line">$ tar zxvf /opt/jdk-8u191-linux-x64.tar.gz -C /usr/<span class="built_in">local</span>/</span><br><span class="line">$ ln -s jdk-8u191/ java</span><br><span class="line"></span><br><span class="line">$ wget http://archive.apache.org/dist/hbase/1.4.9/hbase-1.4.9-bin.tar.gz</span><br><span class="line">$ tar zxvf hbase-1.4.9-bin.tar.gz -C /usr/<span class="built_in">local</span>/</span><br><span class="line">$ <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/</span><br><span class="line">$ ln -s hbase-1.4.9/ hbase</span><br><span class="line"></span><br><span class="line">$ vim ~/.bashrc</span><br><span class="line">  <span class="built_in">export</span> JAVA_HOME=/usr/<span class="built_in">local</span>/java</span><br><span class="line">  <span class="built_in">export</span> HBASE_HOME=/usr/<span class="built_in">local</span>/hbase</span><br><span class="line">  <span class="built_in">export</span> PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$HBASE_HOME</span>/bin:<span class="variable">$PATH</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">source</span> ~/.bashrc</span><br><span class="line">$ java -version</span><br><span class="line">$ hbase version</span><br></pre></td></tr></tbody></table></figure>
<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 首先将本机 IP 设置到远程 HBase 访问白名单中，并通过 telnet 命令，检查是否能访问到 zk 的 2181 默认端口</span></span><br><span class="line">$ telnet yuzhouwan_zk_01 2181</span><br><span class="line"></span><br><span class="line">$ vim conf/hbase-site.xml</span><br><span class="line">  &lt;configuration&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">      &lt;name&gt;hbase.cluster.distributed&lt;/name&gt;</span><br><span class="line">      &lt;value&gt;<span class="literal">true</span>&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">      &lt;name&gt;hbase.zookeeper.quorum&lt;/name&gt;</span><br><span class="line">      &lt;value&gt;yuzhouwan_zk_01:2181,yuzhouwan_zk_02:2181,yuzhouwan_zk_03:2181&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">      &lt;name&gt;zookeeper.znode.parent&lt;/name&gt;</span><br><span class="line">      &lt;value&gt;/hbase&lt;/value&gt; </span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">  &lt;/configuration&gt;</span><br><span class="line"></span><br><span class="line">$ hbase shell</span><br></pre></td></tr></tbody></table></figure>
<h3 id="踩到的坑"><a href="#踩到的坑" class="headerlink" title="踩到的坑"></a>踩到的坑</h3><h4 id="lib-ld-linux-so-2-bad-ELF-interpreter-No-such-file-or-directory"><a href="#lib-ld-linux-so-2-bad-ELF-interpreter-No-such-file-or-directory" class="headerlink" title="/lib/ld-linux.so.2: bad ELF interpreter: No such file or directory"></a>/lib/ld-linux.so.2: bad ELF interpreter: No such file or directory</h4><h5 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h5><p>　缺少 ELF 解释器的问题，只有在 64 位系统上才会发生。原因是系统中缺少 32 位库，而有些脚本或程序需要用到它们，所以报错</p>
<h5 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># For yum</span></span><br><span class="line">$ yum install glibc.i686</span><br><span class="line"></span><br><span class="line"><span class="comment"># For apt-get</span></span><br><span class="line">$ apt-get update</span><br><span class="line">$ apt-get install ia32-libs</span><br></pre></td></tr></tbody></table></figure>
<h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><h3 id="集群相关"><a href="#集群相关" class="headerlink" title="集群相关"></a>集群相关</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ su - hbase</span><br><span class="line">$ start-hbase.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># HMaster    ThriftServer</span></span><br><span class="line">$ jps | grep -v Jps</span><br><span class="line">  32538 ThriftServer</span><br><span class="line">  9383 HMaster</span><br><span class="line">  8423 HRegionServer</span><br><span class="line"></span><br><span class="line"><span class="comment"># BackUp HMaster    ThriftServer</span></span><br><span class="line">$ jps | grep -v Jps</span><br><span class="line">  24450 jar</span><br><span class="line">  21882 HMaster</span><br><span class="line">  2296 HRegionServer</span><br><span class="line">  14598 ThriftServer</span><br><span class="line">  5998 Jstat</span><br><span class="line"></span><br><span class="line"><span class="comment"># BackUp HMaster    ThriftServer</span></span><br><span class="line">$ jps | grep -v Jps</span><br><span class="line">  31119 Bootstrap</span><br><span class="line">  8775 HMaster</span><br><span class="line">  25289 Bootstrap</span><br><span class="line">  14823 Bootstrap</span><br><span class="line">  12671 Jstat</span><br><span class="line">  9052 ThriftServer</span><br><span class="line">  26921 HRegionServer</span><br><span class="line"></span><br><span class="line"><span class="comment"># HRegionServer</span></span><br><span class="line">$ jps | grep -v Jps</span><br><span class="line">  29356 hbase-monitor-process-0.0.3-jar-with-dependencies.jar    <span class="comment"># monitor</span></span><br><span class="line">  11023 Jstat</span><br><span class="line">  26135 HRegionServer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">export</span> -p | egrep -i <span class="string">"(hadoop|hbase)"</span></span><br><span class="line">  <span class="built_in">declare</span> -x HADOOP_HOME=<span class="string">"/home/bigdata/software/hadoop"</span></span><br><span class="line">  <span class="built_in">declare</span> -x HBASE_HOME=<span class="string">"/home/bigdata/software/hbase"</span></span><br><span class="line">  <span class="built_in">declare</span> -x PATH=<span class="string">"/usr/local/anaconda/bin:/usr/local/R-3.2.1/bin:/home/bigdata/software/java/bin:/home/bigdata/software/hadoop/bin:/home/bigdata/software/hive/bin:/home/bigdata/software/sqoop/bin:/home/bigdata/software/hbase/bin:/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/root/bin"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ java -XX:+PrintFlagsFinal -version | grep MaxHeapSize</span><br><span class="line">    uintx MaxHeapSize                              := 32126271488     {product}           <span class="comment"># 29.919921875 GB</span></span><br><span class="line">  java version <span class="string">"1.7.0_60-ea"</span></span><br><span class="line">  Java(TM) SE Runtime Environment (build 1.7.0_60-ea-b15)</span><br><span class="line">  Java HotSpot(TM) 64-Bit Server VM (build 24.60-b09, mixed mode)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ top</span><br><span class="line">  top - 11:37:03 up 545 days, 18:45,  5 users,  load average: 8.74, 10.39, 10.96</span><br><span class="line">  Tasks: 653 total,   1 running, 652 sleeping,   0 stopped,   0 zombie</span><br><span class="line">  Cpu(s): 32.9%us,  0.7%sy,  0.0%ni, 66.3%id,  0.0%wa,  0.0%hi,  0.1%si,  0.0%st</span><br><span class="line">  Mem:  264484056k total, 260853032k used,  3631024k free,  2235248k buffers</span><br><span class="line">  Swap: 10485756k total, 10485756k used,        0k free, 94307776k cached</span><br><span class="line">  <span class="comment"># Memory: 252 GB</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># `hbase classpath` 可以拿到 HBase 相关的所有依赖</span></span><br><span class="line">$ java -classpath ~/opt/hbase/soft/yuzhouwan.jar:`hbase classpath` com.yuzhouwan.hbase.MainApp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Usage</span></span><br><span class="line">Usage: hbase [&lt;options&gt;] &lt;<span class="built_in">command</span>&gt; [&lt;args&gt;]</span><br><span class="line">Options:</span><br><span class="line">  --config DIR    Configuration direction to use. Default: ./conf</span><br><span class="line">  --hosts HOSTS   Override the list <span class="keyword">in</span> <span class="string">'regionservers'</span> file</span><br><span class="line"></span><br><span class="line">Commands:</span><br><span class="line">Some commands take arguments. Pass no args or -h <span class="keyword">for</span> usage.</span><br><span class="line">  shell           Run the HBase shell</span><br><span class="line">  hbck            Run the hbase <span class="string">'fsck'</span> tool</span><br><span class="line">  hlog            Write-ahead-log analyzer</span><br><span class="line">  hfile           Store file analyzer</span><br><span class="line">  zkcli           Run the ZooKeeper shell</span><br><span class="line">  upgrade         Upgrade hbase</span><br><span class="line">  master          Run an HBase HMaster node</span><br><span class="line">  regionserver    Run an HBase HRegionServer node</span><br><span class="line">  zookeeper       Run a ZooKeeper server</span><br><span class="line">  rest            Run an HBase REST server</span><br><span class="line">  thrift          Run the HBase Thrift server</span><br><span class="line">  thrift2         Run the HBase Thrift2 server</span><br><span class="line">  clean           Run the HBase clean up script</span><br><span class="line">  classpath       Dump hbase CLASSPATH</span><br><span class="line">  mapredcp        Dump CLASSPATH entries required by mapreduce</span><br><span class="line">  pe              Run PerformanceEvaluation</span><br><span class="line">  ltt             Run LoadTestTool</span><br><span class="line">  version         Print the version</span><br><span class="line">  CLASSNAME       Run the class named CLASSNAME</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># hbase版本信息</span></span><br><span class="line">$ hbase version</span><br><span class="line">  2017-01-13 11:05:07,580 INFO  [main] util.VersionInfo: HBase 0.98.8-hadoop2</span><br><span class="line">  2017-01-13 11:05:07,580 INFO  [main] util.VersionInfo: Subversion file:///e/hbase_compile/hbase-0.98.8 -r Unknown</span><br><span class="line">  2017-01-13 11:05:07,581 INFO  [main] util.VersionInfo: Compiled by 14074019 on Mon Dec 26 20:17:32     2016</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ hadoop fs -ls /hbase</span><br><span class="line">  drwxr-xr-x   - hbase hbase          0 2017-03-01 00:05 /hbase/.hbase-snapshot</span><br><span class="line">  drwxr-xr-x   - hbase hbase          0 2016-10-26 16:42 /hbase/.hbck</span><br><span class="line">  drwxr-xr-x   - hbase hbase          0 2016-12-19 13:02 /hbase/.tmp</span><br><span class="line">  drwxr-xr-x   - hbase hbase          0 2017-01-22 20:18 /hbase/WALs</span><br><span class="line">  drwxr-xr-x   - hbase hbase          0 2015-09-18 09:34 /hbase/archive</span><br><span class="line">  drwxr-xr-x   - hbase hbase          0 2016-10-18 09:44 /hbase/coprocessor</span><br><span class="line">  drwxr-xr-x   - hbase hbase          0 2015-09-15 17:21 /hbase/corrupt</span><br><span class="line">  drwxr-xr-x   - hbase hbase          0 2017-02-20 14:34 /hbase/data</span><br><span class="line">  -rw-r--r--   2 hbase hbase         42 2015-09-14 12:10 /hbase/hbase.id</span><br><span class="line">  -rw-r--r--   2 hbase hbase          7 2015-09-14 12:10 /hbase/hbase.version</span><br><span class="line">  drwxr-xr-x   - hbase hbase          0 2016-06-28 12:14 /hbase/inputdir</span><br><span class="line">  drwxr-xr-x   - hbase hbase          0 2017-03-01 10:40 /hbase/oldWALs</span><br><span class="line">  -rw-r--r--   2 hbase hbase     345610 2015-12-08 16:54 /hbase/test_bulkload.txt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ hadoop fs -ls /hbase/WALs</span><br><span class="line">  drwxr-xr-x   - hbase hbase          0 2016-12-27 16:08 /hbase/WALs/yuzhouwan03,60020,1482741120018-splitting</span><br><span class="line">  drwxr-xr-x   - hbase hbase          0 2017-03-01 10:36 /hbase/WALs/yuzhouwan03,60020,1483442645857</span><br><span class="line">  drwxr-xr-x   - hbase hbase          0 2017-03-01 10:37 /hbase/WALs/yuzhouwan02,60020,1483491016710</span><br><span class="line">  drwxr-xr-x   - hbase hbase          0 2017-03-01 10:37 /hbase/WALs/yuzhouwan01,60020,1483443835926</span><br><span class="line">  drwxr-xr-x   - hbase hbase          0 2017-03-01 10:36 /hbase/WALs/yuzhouwan03,60020,1483444682422</span><br><span class="line">  drwxr-xr-x   - hbase hbase          0 2017-03-01 10:16 /hbase/WALs/yuzhouwan04,60020,1485087488577</span><br><span class="line">  drwxr-xr-x   - hbase hbase          0 2017-03-01 10:37 /hbase/WALs/yuzhouwan05,60020,1484790306754</span><br><span class="line">  drwxr-xr-x   - hbase hbase          0 2017-03-01 10:37 /hbase/WALs/yuzhouwan06,60020,1484931966988</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ hadoop fs -ls /hbase/WALs/yuzhouwan01,60020,1483443835926</span><br><span class="line"></span><br><span class="line">  -rw-r--r--   3 hbase hbase  127540109 2017-03-01 09:49 /hbase/WALs/yuzhouwan01,60020,1483443835926/yuzhouwan01%2C60020%2C1483443835926.1488330961720</span><br><span class="line">  <span class="comment"># ...</span></span><br><span class="line">  -rw-r--r--   3 hbase hbase         83 2017-03-01 10:37 /hbase/WALs/yuzhouwan01,60020,1483443835926/yuzhouwan01%2C60020%2C1483443835926.1488335822133</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># log</span></span><br><span class="line">$ vim /home/hbase/logs/hbase-hbase-regionserver-yuzhouwan03.log</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># HBase 批处理</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">"&lt;command&gt;"</span> | hbase shell</span><br><span class="line">$ hbase shell ../script/batch.hbase</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># HBase 命令行</span></span><br><span class="line">$ hbase shell</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 连接远程 HBase 集群，需要把远程 HBase 的 ZooKeeper 地址配置到 hbase-site.xml 中</span></span><br><span class="line">$ vim hbase-site.xml</span><br><span class="line">  &lt;configuration&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">      &lt;name&gt;hbase.zookeeper.quorum&lt;/name&gt;</span><br><span class="line">      &lt;value&gt;remote-yuzhouwan-01,remote-yuzhouwan-02,remote-yuzhouwan-03:2181&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">      &lt;name&gt;zookeeper.znode.parent&lt;/name&gt;</span><br><span class="line">      &lt;value&gt;/hbase&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">  &lt;/configuration&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ status</span><br><span class="line">  1 servers, 0 dead, 41.0000 average load</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ zk_dump</span><br><span class="line">  HBase is rooted at /hbase</span><br><span class="line">  Active master address: yuzhouwan03,60000,1481009498847</span><br><span class="line">  Backup master addresses:</span><br><span class="line">   yuzhouwan02,60000,1481009591957</span><br><span class="line">   yuzhouwan01,60000,1481009567346</span><br><span class="line">  Region server holding hbase:meta: yuzhouwan03,60020,1483442645857</span><br><span class="line">  Region servers:</span><br><span class="line">   yuzhouwan02,60020,1483491016710</span><br><span class="line">   <span class="comment"># ...</span></span><br><span class="line">  /hbase/replication: </span><br><span class="line">  /hbase/replication/peers: </span><br><span class="line">  /hbase/replication/peers/1: yuzhouwan03,yuzhouwan02,yuzhouwan01:2016:/hbase</span><br><span class="line">  /hbase/replication/peers/1/peer-state: ENABLED</span><br><span class="line">  /hbase/replication/rs: </span><br><span class="line">  /hbase/replication/rs/yuzhouwan03,60020,1483442645857: </span><br><span class="line">  /hbase/replication/rs/yuzhouwan03,60020,1483442645857/1: </span><br><span class="line">  /hbase/replication/rs/yuzhouwan03,60020,1483442645857/1/yuzhouwan03%2C60020%2C1483442645857.1488334114131: 116838271</span><br><span class="line">  /hbase/replication/rs/1485152902048.SyncUpTool.replication.org,1234,1: </span><br><span class="line">  /hbase/replication/rs/yuzhouwan06,60020,1484931966988: </span><br><span class="line">  /hbase/replication/rs/yuzhouwan06,60020,1484931966988/1: </span><br><span class="line">  <span class="comment"># ...</span></span><br><span class="line">  Quorum Server Statistics:</span><br><span class="line">   yuzhouwan02:2015</span><br><span class="line">    ZooKeeper version: 3.4.6-1569965, built on 02/20/2014 09:09 GMT</span><br><span class="line">    Clients:</span><br><span class="line">     /yuzhouwan:62003[1](queued=0,recved=625845,sent=625845)</span><br><span class="line">     <span class="comment"># ...</span></span><br><span class="line">     /yuzhouwan:11151[1](queued=0,recved=8828,sent=8828)  </span><br><span class="line">    Latency min/avg/max: 0/0/1</span><br><span class="line">    Received: 161</span><br><span class="line">    Sent: 162</span><br><span class="line">    Connections: 168</span><br><span class="line">    Outstanding: 0</span><br><span class="line">    Zxid: 0xc062e91c6</span><br><span class="line">    Mode: follower</span><br><span class="line">    Node count: 25428</span><br><span class="line">   yuzhouwan03:2015</span><br><span class="line">    ZooKeeper version: 3.4.6-1569965, built on 02/20/2014 09:09 GMT</span><br><span class="line">    Clients:</span><br><span class="line">     /yuzhouwan:39582[1](queued=0,recved=399812,sent=399812)</span><br><span class="line">     <span class="comment"># ...</span></span><br><span class="line">     /yuzhouwan:58770[1](queued=0,recved=3234,sent=3234)</span><br><span class="line"></span><br><span class="line">$ stop-hbase.sh</span><br></pre></td></tr></tbody></table></figure>
<h3 id="增删查改"><a href="#增删查改" class="headerlink" title="增删查改"></a>增删查改</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ list</span><br><span class="line">  TABLE</span><br><span class="line">  mytable</span><br><span class="line">  yuzhouwan</span><br><span class="line">  <span class="comment"># ...</span></span><br><span class="line">  20 row(s) <span class="keyword">in</span> 1.4080 seconds</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ create <span class="string">'yuzhouwan'</span>, {NAME =&gt; <span class="string">'info'</span>, VERSIONS =&gt; 3}, {NAME =&gt; <span class="string">'data'</span>, VERSIONS =&gt; 1}</span><br><span class="line">  0 row(s) <span class="keyword">in</span> 0.2650 seconds</span><br><span class="line">  =&gt; Hbase::Table - yuzhouwan</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ put <span class="string">'yuzhouwan'</span>, <span class="string">'rk0001'</span>, <span class="string">'info:name'</span>, <span class="string">'Benedict Jin'</span></span><br><span class="line">$ put <span class="string">'yuzhouwan'</span>, <span class="string">'rk0001'</span>, <span class="string">'info:gender'</span>, <span class="string">'Man'</span></span><br><span class="line">$ put <span class="string">'yuzhouwan'</span>, <span class="string">'rk0001'</span>, <span class="string">'data:pic'</span>, <span class="string">'[picture]'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ get <span class="string">'yuzhouwan'</span>, <span class="string">'rk0001'</span>, {FILTER =&gt; <span class="string">"ValueFilter(=, 'binary:[picture]')"</span>}</span><br><span class="line">  COLUMN                                              CELL</span><br><span class="line">  data:pic                                           timestamp=1479092170498, value=[picture]</span><br><span class="line">  1 row(s) <span class="keyword">in</span> 0.0200 seconds</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ get <span class="string">'yuzhouwan'</span>, <span class="string">'rk0001'</span>, {FILTER =&gt; <span class="string">"QualifierFilter(=, 'substring:a')"</span>}</span><br><span class="line">  COLUMN                                              CELL</span><br><span class="line">  info:name                                          timestamp=1479092160236, value=Benedict Jin</span><br><span class="line">  1 row(s) <span class="keyword">in</span> 0.0050 seconds</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询某一个 CF，并限制只查询 10 行数据</span></span><br><span class="line">$ scan <span class="string">'yuzhouwan'</span>, {COLUMNS =&gt; [<span class="string">'c'</span>], LIMIT =&gt; 10}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询某一个 CQ</span></span><br><span class="line">$ scan <span class="string">'yuzhouwan'</span>, {FILTER =&gt; <span class="string">"QualifierFilter(=, 'substring:a')"</span>}</span><br><span class="line">  ROW                                                 COLUMN+CELL</span><br><span class="line">  rk0001                                             column=info:name, timestamp=1479092160236, value=Benedict Jin</span><br><span class="line">  1 row(s) <span class="keyword">in</span> 0.0140 seconds</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 倒序查询</span></span><br><span class="line">$ scan <span class="string">'yuzhouwan'</span>, {COLUMNS =&gt; [<span class="string">'com'</span>], REVERSED =&gt; <span class="literal">true</span>, LIMIT =&gt; 10}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 按照 timestamp 进行查询</span></span><br><span class="line">$ scan <span class="string">'yuzhouwan'</span>, { TIMERANGE =&gt; [0, 1416083300000] }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># [rk0001, rk0003)</span></span><br><span class="line">$ put <span class="string">'yuzhouwan'</span>, <span class="string">'rk0003'</span>, <span class="string">'info:name'</span>, <span class="string">'asdf2014'</span></span><br><span class="line">$ scan <span class="string">'yuzhouwan'</span>, {COLUMNS =&gt; <span class="string">'info'</span>, STARTROW =&gt; <span class="string">'rk0001'</span>, ENDROW =&gt; <span class="string">'rk0003'</span>}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># row key start with 'rk'</span></span><br><span class="line">$ put <span class="string">'yuzhouwan'</span>, <span class="string">'aha_rk0003'</span>, <span class="string">'info:name'</span>, <span class="string">'Jin'</span></span><br><span class="line">$ scan <span class="string">'yuzhouwan'</span>, {FILTER =&gt; <span class="string">"PrefixFilter('rk')"</span>}</span><br><span class="line">  ROW                                                 COLUMN+CELL</span><br><span class="line">  rk0001                                             column=data:pic, timestamp=1479092170498, value=[picture]</span><br><span class="line">  rk0001                                             column=info:gender, timestamp=1479092166019, value=Man</span><br><span class="line">  rk0001                                             column=info:name, timestamp=1479092160236, value=Benedict Jin</span><br><span class="line">  rk0003                                             column=info:name, timestamp=1479092728688, value=asdf2014</span><br><span class="line">  2 row(s) <span class="keyword">in</span> 0.0150 seconds</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ delete <span class="string">'yuzhouwan'</span>, <span class="string">'rk0001'</span>, <span class="string">'info:gender'</span></span><br><span class="line">$ get <span class="string">'yuzhouwan'</span>, <span class="string">'rk0001'</span></span><br><span class="line">  COLUMN                                              CELL</span><br><span class="line">  data:pic                                           timestamp=1479092170498, value=[picture]</span><br><span class="line">  info:name                                          timestamp=1479092160236, value=Benedict Jin</span><br><span class="line">  2 row(s) <span class="keyword">in</span> 0.0100 seconds</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">disable</span> <span class="string">'yuzhouwan'</span></span><br><span class="line">$ drop <span class="string">'yuzhouwan'</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="行列修改"><a href="#行列修改" class="headerlink" title="行列修改"></a>行列修改</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 修改表</span></span><br><span class="line">$ <span class="built_in">disable</span> <span class="string">'yuzhouwan'</span></span><br><span class="line"><span class="comment"># 添加列</span></span><br><span class="line">$ alter <span class="string">'yuzhouwan'</span>, NAME =&gt; <span class="string">'f1'</span></span><br><span class="line">$ alter <span class="string">'yuzhouwan'</span>, NAME =&gt; <span class="string">'f2'</span></span><br><span class="line">  Updating all regions with the new schema...</span><br><span class="line">  1/1 regions updated.</span><br><span class="line">  Done.</span><br><span class="line">  0 row(s) <span class="keyword">in</span> 1.3020 seconds</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 CQ</span></span><br><span class="line">$ create <span class="string">'yuzhouwan'</span>, {NAME =&gt; <span class="string">'info'</span>}</span><br><span class="line">$ put <span class="string">'yuzhouwan'</span>, <span class="string">'rk00001'</span>, <span class="string">'info:name'</span>, <span class="string">'China'</span></span><br><span class="line"></span><br><span class="line">$ get <span class="string">'yuzhouwan'</span>, <span class="string">'rk00001'</span>, {COLUMN =&gt; <span class="string">'info:name'</span>}, <span class="string">'value'</span></span><br><span class="line">$ put <span class="string">'yuzhouwan'</span>, <span class="string">'rk00001'</span>, <span class="string">'info:address'</span>, <span class="string">'value'</span></span><br><span class="line"></span><br><span class="line">$ scan <span class="string">'yuzhouwan'</span></span><br><span class="line">  ROW                                                 COLUMN+CELL</span><br><span class="line">   rk00001                                            column=info:address, timestamp=1480556328381, value=value</span><br><span class="line">  1 row(s) <span class="keyword">in</span> 0.0220 seconds</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除列</span></span><br><span class="line">$ alter <span class="string">'yuzhouwan'</span>, {NAME =&gt; <span class="string">'f3'</span>}, {NAME =&gt; <span class="string">'f4'</span>}</span><br><span class="line">$ alter <span class="string">'yuzhouwan'</span>, {NAME =&gt; <span class="string">'f5'</span>}, {NAME =&gt; <span class="string">'f1'</span>, METHOD =&gt; <span class="string">'delete'</span>}, {NAME =&gt; <span class="string">'f2'</span>, METHOD =&gt; <span class="string">'delete'</span>}, {NAME =&gt; <span class="string">'f3'</span>, METHOD =&gt; <span class="string">'delete'</span>}, {NAME =&gt; <span class="string">'f4'</span>, METHOD =&gt; <span class="string">'delete'</span>}</span><br><span class="line"></span><br><span class="line"><span class="comment"># 无法细到 CQ 级别，alter 'ns_rec:tb_mem_tag', {NAME =&gt; 'cf_tag:partyIdType', METHOD =&gt; 'delete'}</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除行</span></span><br><span class="line">$ deteleall &lt;table&gt;,  &lt;rowkey&gt;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="清空表数据"><a href="#清空表数据" class="headerlink" title="清空表数据"></a>清空表数据</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 清空表数据</span></span><br><span class="line">$ describe <span class="string">'yuzhouwan'</span></span><br><span class="line">  Table yuzhouwan is ENABLED</span><br><span class="line">  COLUMN FAMILIES DESCRIPTION</span><br><span class="line">  {NAME =&gt; <span class="string">'data'</span>, DATA_BLOCK_ENCODING =&gt; <span class="string">'NONE'</span>, BLOOMFILTER =&gt; <span class="string">'ROW'</span>, REPLICATION_SCOPE =&gt; <span class="string">'0'</span>, VERSIONS =&gt; <span class="string">'1'</span>, COMPRESSION =&gt; <span class="string">'NONE'</span>, MIN_VERSIONS =&gt; <span class="string">'0'</span>, TTL =&gt; <span class="string">'FOREVER'</span>, KEEP_DELETED_CELLS =&gt; <span class="string">'FALSE'</span>, BLOCKSIZE =&gt; <span class="string">'65536'</span>, IN_MEMORY =&gt; <span class="string">'false'</span>, BLOCKCACHE =&gt; <span class="string">'true'</span>}</span><br><span class="line">  {NAME =&gt; <span class="string">'f5'</span>, DATA_BLOCK_ENCODING =&gt; <span class="string">'NONE'</span>, BLOOMFILTER =&gt; <span class="string">'ROW'</span>, REPLICATION_SCOPE =&gt; <span class="string">'0'</span>, COMPRESSION =&gt; <span class="string">'NONE'</span>, VERSIONS =&gt; <span class="string">'1'</span>, TTL =&gt; <span class="string">'FOREVER'</span>, MIN_VERSIONS =&gt; <span class="string">'0'</span>, KEEP_DELETED_CELLS =&gt; <span class="string">'FALSE'</span></span><br><span class="line">  , BLOCKSIZE =&gt; <span class="string">'65536'</span>, IN_MEMORY =&gt; <span class="string">'false'</span>, BLOCKCACHE =&gt; <span class="string">'true'</span>}</span><br><span class="line">  {NAME =&gt; <span class="string">'info'</span>, DATA_BLOCK_ENCODING =&gt; <span class="string">'NONE'</span>, BLOOMFILTER =&gt; <span class="string">'ROW'</span>, REPLICATION_SCOPE =&gt; <span class="string">'0'</span>, VERSIONS =&gt; <span class="string">'3'</span>, COMPRESSION =&gt; <span class="string">'NONE'</span>, MIN_VERSIONS =&gt; <span class="string">'0'</span>, TTL =&gt; <span class="string">'FOREVER'</span>, KEEP_DELETED_CELLS =&gt; <span class="string">'FALSE'</span>, BLOCKSIZE =&gt; <span class="string">'65536'</span>, IN_MEMORY =&gt; <span class="string">'false'</span>, BLOCKCACHE =&gt; <span class="string">'true'</span>}</span><br><span class="line">  3 row(s) <span class="keyword">in</span> 0.0230 seconds</span><br><span class="line"></span><br><span class="line"><span class="comment"># 0.98 版本引入的命令，可以清空表数据的同时，保留 region 分区</span></span><br><span class="line">$ truncate_preserve <span class="string">'yuzhouwan'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># truncate 会进行 drop table 和 create table 的操作</span></span><br><span class="line">$ truncate <span class="string">'yuzhouwan'</span></span><br><span class="line">$ scan <span class="string">'yuzhouwan'</span></span><br><span class="line">  ROW                                                 COLUMN+CELL</span><br><span class="line">  0 row(s) <span class="keyword">in</span> 0.3170 seconds</span><br></pre></td></tr></tbody></table></figure>
<h3 id="改表名"><a href="#改表名" class="headerlink" title="改表名"></a>改表名</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 注意 snapshot 的名字 不可带 ':' 之类的字符，也就是说，不需要特意去区分 namespace</span></span><br><span class="line">$ <span class="built_in">disable</span> <span class="string">'yuzhouwan'</span></span><br><span class="line">$ snapshot <span class="string">'yuzhouwan'</span>, <span class="string">'yuzhouwan_snapshot'</span></span><br><span class="line">$ clone_snapshot <span class="string">'yuzhouwan_snapshot'</span>, <span class="string">'ns_site:yuzhouwan'</span></span><br><span class="line">$ delete_snapshot <span class="string">'yuzhouwan_snapshot'</span></span><br><span class="line">$ drop <span class="string">'yuzhouwan'</span></span><br><span class="line">$ grant <span class="string">'site'</span>, <span class="string">'CXWR'</span>, <span class="string">'ns_site:yuzhouwan'</span></span><br><span class="line"></span><br><span class="line">$ user_permission <span class="string">'yuzhouwan'</span></span><br><span class="line">  User                                                Table,Family,Qualifier:Permission</span><br><span class="line">   site                                               default,yuzhouwan,,: [Permission: actions=CREATE,EXEC,WRITE,READ]</span><br><span class="line">   hbase                                              default,yuzhouwan,,: [Permission: actions=READ,WRITE,EXEC,CREATE,ADMIN]</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">disable</span> <span class="string">'ns_site:yuzhouwan'</span></span><br><span class="line">$ drop <span class="string">'ns_site:yuzhouwan'</span></span><br><span class="line"></span><br><span class="line">$ exists <span class="string">'ns_site:yuzhouwan'</span></span><br><span class="line">  Table ns_site:yuzhouwan does not exist</span><br><span class="line">  0 row(s) <span class="keyword">in</span> 0.0200 seconds</span><br></pre></td></tr></tbody></table></figure>
<div class="note success">可以通过 org.apache.hadoop.hbase.snapshot.ExportSnapshot 将 snapshot 文件导出，以实现跨集群的数据迁移</div>


<h3 id="改表属性"><a href="#改表属性" class="headerlink" title="改表属性"></a>改表属性</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">disable</span> <span class="string">'yuzhouwan'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># versions</span></span><br><span class="line">$ alter <span class="string">'yuzhouwan'</span>, NAME =&gt; <span class="string">'f'</span>, VERSIONS =&gt; 5</span><br><span class="line"></span><br><span class="line"><span class="comment"># ttl（注意，超时属性是针对 CF 的，而不是 Table 级别的，且单位是 秒）</span></span><br><span class="line">$ alter <span class="string">'yuzhouwan'</span>, NAME =&gt; <span class="string">'f'</span>, TTL =&gt; 20</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">enable</span> <span class="string">'yuzhouwan'</span></span><br><span class="line">$ describe <span class="string">'yuzhouwan'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># alter 操作的耗时，主要在 Region 的 close 和 open 两次操作上</span></span><br><span class="line"><span class="comment"># 耗时时长主要取决于 Region 的数量</span></span><br><span class="line"><span class="comment"># alter 操作本身不会导致 服务不可用，但是业务量过大，HBase 可能会抖</span></span><br><span class="line"><span class="comment"># alter 属于 HBase 常规运维操作</span></span><br><span class="line"><span class="comment"># 函数入口在 `HBaseAdmin#modifyTable`，属于异步调用，timeout 耗时由 `hbase.client.sync.wait.timeout.msec` 控制，默认 10min</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="压缩算法"><a href="#压缩算法" class="headerlink" title="压缩算法"></a><a href="https://quixdb.github.io/squash-benchmark/">压缩算法</a></h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 压缩算法为 'SNAPPY' 报错，ERROR: java.io.IOException: Compression algorithm 'snappy' previously failed test.</span></span><br><span class="line"><span class="comment"># 尝试 LZ4（低压缩比，高速，在 Spark 2.x 中已作为默认压缩算法）</span></span><br><span class="line">$ create <span class="string">'yuzhouwan'</span>, {NUMREGIONS =&gt; 15, SPLITALGO =&gt; <span class="string">'HexStringSplit'</span>}, {NAME =&gt; <span class="string">'v'</span>, COMPRESSION =&gt; <span class="string">'LZ4'</span>, BLOOMFILTER =&gt; <span class="string">'NONE'</span>, DATA_BLOCK_ENCODING =&gt; <span class="string">'FAST_DIFF'</span>}</span><br><span class="line"></span><br><span class="line">$ describe <span class="string">'yuzhouwan'</span></span><br><span class="line">  Table yuzhouwan is ENABLED</span><br><span class="line">  COLUMN FAMILIES DESCRIPTION</span><br><span class="line">  {NAME =&gt; <span class="string">'v'</span>, DATA_BLOCK_ENCODING =&gt; <span class="string">'FAST_DIFF'</span>, BLOOMFILTER =&gt; <span class="string">'NONE'</span>, REPLICATION_SCOPE =&gt; <span class="string">'0'</span>, VERSIONS =&gt; <span class="string">'1'</span>, COMPRESSION =&gt; <span class="string">'LZ4'</span>, MIN_VERSIONS =&gt; <span class="string">'0'</span>, TTL =&gt; <span class="string">'FOREVER'</span>, KEEP_DELETED_CELLS =&gt; <span class="string">'FALSE'</span>, BLOCKSIZE =&gt; <span class="string">'65536'</span>, IN_MEMORY =&gt; <span class="string">'false'</span>, BLOCKCACHE =&gt; <span class="string">'true'</span>}</span><br><span class="line">  1 row(s) <span class="keyword">in</span> 0.0280 seconds</span><br></pre></td></tr></tbody></table></figure>
<h3 id="权限控制"><a href="#权限控制" class="headerlink" title="权限控制"></a>权限控制</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># ACL</span></span><br><span class="line"><span class="comment"># R - read</span></span><br><span class="line"><span class="comment"># W - write</span></span><br><span class="line"><span class="comment"># X - execute</span></span><br><span class="line"><span class="comment"># C - create</span></span><br><span class="line"><span class="comment"># A - admin</span></span><br><span class="line">$ grant <span class="string">'benedict'</span>, <span class="string">'WRXC'</span>, <span class="string">'yuzhouwan'</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">"scan 'hbase:acl'"</span> | hbase shell &gt; acl.txt</span><br><span class="line">  yuzhouwan column=l:benedict, timestamp=1496216745249, value=WRXC</span><br><span class="line">  yuzhouwan column=l:hbase, timestamp=1496216737326, value=RWXCA</span><br><span class="line"></span><br><span class="line">$ user_permission                  <span class="comment"># 如果不接 &lt;table_name&gt;，将从 'hbase:acl' 表中获取全部</span></span><br><span class="line">$ user_permission <span class="string">'yuzhouwan'</span></span><br><span class="line">    User                                 Table,Family,Qualifier:Permission</span><br><span class="line">   hbase                               default,yuzhouwan,,: [Permission: actions=READ,WRITE,EXEC,CREATE,ADMIN]</span><br><span class="line">   benedict                            default,yuzhouwan,,: [Permission: actions=WRITE,READ,EXEC,CREATE]</span><br><span class="line">  2 row(s) <span class="keyword">in</span> 0.0510 seconds</span><br><span class="line"></span><br><span class="line">$ revoke <span class="string">'benedict'</span>, <span class="string">'yuzhouwan'</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="分区"><a href="#分区" class="headerlink" title="分区"></a>分区</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># splits</span></span><br><span class="line">$ create <span class="string">'yuzhouwan'</span>, {NAME =&gt; <span class="string">'f'</span>}, SPLITS =&gt; [<span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'3'</span>]                      <span class="comment"># 5 regions</span></span><br><span class="line">$ alter <span class="string">'yuzhouwan'</span>, SPLITS =&gt; [<span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'4'</span>, <span class="string">'5'</span>, <span class="string">'6'</span>, <span class="string">'7'</span>, <span class="string">'8'</span>, <span class="string">'9'</span>]        <span class="comment"># not work</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭自动分区</span></span><br><span class="line">$ alter <span class="string">'yuzhouwan'</span>, {METHOD =&gt; <span class="string">'table_att'</span>, SPLIT_POLICY =&gt; <span class="string">'org.apache.hadoop.hbase.regionserver.DisabledRegionSplitPolicy'</span>}</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 Master 是否去平衡各个 RegionServer 的 Region 数量</span></span><br><span class="line"><span class="comment"># 维护或者重启一个 RegionServer 时，会关闭 balancer，会导致 Region 在 RegionServer 上的分布不均，这个时候需要手工的开启 balance</span></span><br><span class="line">$ balance_switch <span class="literal">true</span></span><br><span class="line">$ balance_switch <span class="literal">false</span></span><br></pre></td></tr></tbody></table></figure>
<div class="note success">预分区可以配合自增 ID 的二进制翻转，来解决写入热点问题</div>

<h3 id="命名空间"><a href="#命名空间" class="headerlink" title="命名空间"></a>命名空间</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># namespace</span></span><br><span class="line">$ list_namespace_tables <span class="string">'hbase'</span></span><br><span class="line">  TABLE</span><br><span class="line">  acl</span><br><span class="line">  meta</span><br><span class="line">  namespace</span><br><span class="line">  3 row(s) <span class="keyword">in</span> 0.0050 seconds</span><br><span class="line"></span><br><span class="line">$ list_namespace</span><br><span class="line">  NAMESPACE</span><br><span class="line">  default</span><br><span class="line">  hbase</span><br><span class="line">  <span class="comment"># ...</span></span><br><span class="line">  50 row(s) <span class="keyword">in</span> 0.3710 seconds</span><br><span class="line"></span><br><span class="line">$ create_namespace <span class="string">'www'</span></span><br><span class="line">$ exists <span class="string">'www:yuzhouwan.site'</span></span><br><span class="line">$ create <span class="string">'www:yuzhouwan.site'</span>, {NAME =&gt; <span class="string">'info'</span>, VERSIONS=&gt; 9}, SPLITS =&gt; [<span class="string">'1'</span>,<span class="string">'2'</span>,<span class="string">'3'</span>,<span class="string">'4'</span>,<span class="string">'5'</span>,<span class="string">'6'</span>,<span class="string">'7'</span>,<span class="string">'8'</span>,<span class="string">'9'</span>]</span><br><span class="line">$ alter_namespace <span class="string">'www'</span>, {METHOD =&gt; <span class="string">'set'</span>, <span class="string">'PROPERTY_NAME'</span> =&gt; <span class="string">'PROPERTY_VALUE'</span>}</span><br><span class="line"></span><br><span class="line">$ drop_namespace <span class="string">'www'</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="手动-Split"><a href="#手动-Split" class="headerlink" title="手动 Split"></a>手动 Split</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ create <span class="string">'yuzhouwan'</span>, {NAME =&gt; <span class="string">'info'</span>, VERSIONS =&gt; 3}, {NAME =&gt; <span class="string">'data'</span>, VERSIONS =&gt; 1}</span><br><span class="line">$ put <span class="string">'yuzhouwan'</span>, <span class="string">'rk0001'</span>, <span class="string">'info:name'</span>, <span class="string">'Benedict Jin'</span></span><br><span class="line">$ put <span class="string">'yuzhouwan'</span>, <span class="string">'rk0001'</span>, <span class="string">'info:gender'</span>, <span class="string">'Man'</span></span><br><span class="line">$ put <span class="string">'yuzhouwan'</span>, <span class="string">'rk0001'</span>, <span class="string">'data:pic'</span>, <span class="string">'[picture]'</span></span><br><span class="line">$ put <span class="string">'yuzhouwan'</span>, <span class="string">'rk0002'</span>, <span class="string">'info:name'</span>, <span class="string">'Yuzhouwan'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Usage:</span></span><br><span class="line"><span class="comment">#   split 'tableName'</span></span><br><span class="line"><span class="comment">#   split 'namespace:tableName'</span></span><br><span class="line"><span class="comment">#   split 'regionName' # format: 'tableName,startKey,id'</span></span><br><span class="line"><span class="comment">#   split 'tableName', 'splitKey'</span></span><br><span class="line"><span class="comment">#   split 'regionName', 'splitKey'</span></span><br><span class="line">$ split <span class="string">'yuzhouwan'</span>, <span class="string">'rk0002'</span></span><br><span class="line">  <span class="comment"># Name                                                            Region Server        Start Key   End Key    Locality    Requests</span></span><br><span class="line">  yuzhouwan,,1500964657548.bd21cdf7ae9e2d8e5b2ed3730eb8b738.        yuzhouwan01:60020                rk0002     1.0         0</span><br><span class="line">  yuzhouwan,rk0002,1500964657548.76f95590aed5d39291a087c5e8e83833.  yuzhouwan02:60020    rk0002                 1.0         2</span><br></pre></td></tr></tbody></table></figure>
<h3 id="手动-Compact"><a href="#手动-Compact" class="headerlink" title="手动 Compact"></a>手动 Compact</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 触发 small compaction</span></span><br><span class="line"><span class="comment"># 只是发送请求到 RS，具体还要看是否满足触发的条件</span></span><br><span class="line">$ compact <span class="string">'yuzhouwan'</span></span><br><span class="line"><span class="comment"># 触发 major compaction</span></span><br><span class="line"><span class="comment"># 只有 major compaction 操作才是肯定会被执行的</span></span><br><span class="line">$ major_compact <span class="string">'yuzhouwan'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># small compaction 的 scan 类型为 org.apache.hadoop.hbase.regionserver.ScanType#COMPACT_RETAIN_DELETES</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="Phoenix-命令"><a href="#Phoenix-命令" class="headerlink" title="Phoenix 命令"></a>Phoenix 命令</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 执行外部 SQL 脚本</span></span><br><span class="line">$ sqlline.py &lt;hbase.zookeeper.quorum host without port&gt;:/phoenix sql.txt</span><br></pre></td></tr></tbody></table></figure>
<h2 id="实战技巧"><a href="#实战技巧" class="headerlink" title="实战技巧"></a>实战技巧</h2><h3 id="Hive-数据导入（Bulkload）"><a href="#Hive-数据导入（Bulkload）" class="headerlink" title="Hive 数据导入（Bulkload）"></a>Hive 数据导入（Bulkload）</h3><p>　Bulkload 就是 依据 Hive 表的 schema 解析 RCFile，然后通过 MapReduce 程序 生成 HBase 的 HFile 文件，最后直接利用 Bulkload 机制将 HFile 文件导入到 HBase 中。也就是 直接存放到 HDFS 中。这样比调用接口一条条的导入，效率会高很多（一般的，Hive 的数据入库到 HBase 中，都会采用 Bulkload 的方式）</p>
<h3 id="集群间复制（CopyTable-Replication）"><a href="#集群间复制（CopyTable-Replication）" class="headerlink" title="集群间复制（CopyTable + Replication）"></a>集群间复制（CopyTable + Replication）</h3><h4 id="相关命令"><a href="#相关命令" class="headerlink" title="相关命令"></a>相关命令</h4><div class="table-container">
<table>
<thead>
<tr>
<th>Commend</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>add_peer</td>
<td>添加一条复制连接，ID 是连接的标识符，CLUSTER_KEY 的格式是 HBase.zookeeper.quorum: HBase.zookeeper.property.clientPort: zookeeper.znode.parent</td>
</tr>
<tr>
<td>list_peers</td>
<td>查看所有的复制连接</td>
</tr>
<tr>
<td>enable_peer</td>
<td>设置某条复制连接为可用状态，add_peer 一条连接默认就是 <code>enable</code> 的，通过 disable_peer 命令让该连接变为不可用的时候，可以通过 enable_peer 让连接变成可用</td>
</tr>
<tr>
<td>disable_peer</td>
<td>设置某条复制连接为不可用状态</td>
</tr>
<tr>
<td>remove_peer</td>
<td>删除某条复制连接</td>
</tr>
<tr>
<td>set_peer_tableCFs</td>
<td>设置某条复制连接可以复制的表信息</td>
</tr>
<tr>
<td></td>
<td>默认 add_peer 添加的复制连接是可以复制集群所有的表。如果，只想复制某些表的话，就可以用 set_peer_tableCFs，复制连接的粒度可以到表的列族。表之间通过 ‘;’ 分号 隔开，列族之间通过 ‘,’ 逗号 隔开。e.g. set_peer_tableCFs ‘2’, “table1; table2:cf1,cf2; table3:cfA,cfB”。使用 ‘set_peer_tableCFs’ 命令，可以设置复制连接所有的表</td>
</tr>
<tr>
<td>append_peer_tableCFs</td>
<td>可以为复制连接添加需要复制的表</td>
</tr>
<tr>
<td>remove_peer_tableCFs</td>
<td>为复制连接删除不需要复制的表</td>
</tr>
<tr>
<td>show_peer_tableCFs</td>
<td>查看某条复制连接复制的表信息，查出的信息为空时，表示复制所有的表</td>
</tr>
<tr>
<td>list_replicated_tables</td>
<td>列出所有复制的表</td>
</tr>
</tbody>
</table>
</div>
<h4 id="监控-Replication"><a href="#监控-Replication" class="headerlink" title="监控 Replication"></a>监控 Replication</h4><h5 id="HBase-Shell"><a href="#HBase-Shell" class="headerlink" title="HBase Shell"></a>HBase Shell</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ status <span class="string">'replication'</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="Metrics"><a href="#Metrics" class="headerlink" title="Metrics"></a>Metrics</h5><p>源端</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>Metrics Name</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>sizeOfLogQueue</td>
<td>还有多少 WAL 文件没处理</td>
</tr>
<tr>
<td>ageOfLastShippedOp</td>
<td>上一次复制延迟时间</td>
</tr>
<tr>
<td>shippedBatches</td>
<td>传输了多少批数据</td>
</tr>
<tr>
<td>shippedKBs</td>
<td>传输了多少 KB 的数据</td>
</tr>
<tr>
<td>shippedOps</td>
<td>传输了多少条数据</td>
</tr>
<tr>
<td>logEditsRead</td>
<td>读取了多少个 logEdits</td>
</tr>
<tr>
<td>logReadInBytes</td>
<td>读取了多少 KB 数据</td>
</tr>
<tr>
<td>logEditsFiltered</td>
<td>实际过滤了多少 logEdits</td>
</tr>
</tbody>
</table>
</div>
<p>目的端</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>Metrics Name</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>sink.ageOfLastAppliedOp</td>
<td>上次处理的延迟</td>
</tr>
<tr>
<td>sink.appliedBatches</td>
<td>处理的批次数</td>
</tr>
<tr>
<td>sink.appliedOps</td>
<td>处理的数据条数</td>
</tr>
</tbody>
</table>
</div>
<h4 id="完整步骤"><a href="#完整步骤" class="headerlink" title="完整步骤"></a>完整步骤</h4><h5 id="CopyTable"><a href="#CopyTable" class="headerlink" title="CopyTable"></a>CopyTable</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 明确迁移时间</span></span><br><span class="line">2017-01-01 00:00:00(1483200000000)          2017-05-01 00:00:00(1493568000000)</span><br><span class="line"><span class="comment"># 这里需要转换时间格式为 13 位的 毫秒级 unix timestamp</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">"`date -d "</span>2017-01-01 00:00:00<span class="string">" +%s`000"</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">"`date -d "</span>2017-05-01 00:00:00<span class="string">" +%s`000"</span></span><br><span class="line"><span class="comment"># 这里不用担心出现 边界问题 [starttime, endtime)</span></span><br><span class="line"><span class="comment"># 源集群执行（不限制 starttime，可以增加参数 --starttime=0）</span></span><br><span class="line">$ hbase org.apache.hadoop.hbase.mapreduce.CopyTable --starttime=1483200000000 --endtime=1493568000000 --peer.adr=&lt;aim zk address&gt;,&lt;aim zk address&gt;,...:&lt;aim zk port&gt;:/&lt;hbase parent path&gt; &lt;table name&gt;</span><br><span class="line"><span class="comment"># 检查数据一致性（在两个集群分别执行，比较 RowCount 是否一致）</span></span><br><span class="line">$ hbase org.apache.hadoop.hbase.mapreduce.RowCounter &lt;table name&gt; --endtime=1493568000000</span><br><span class="line"><span class="comment"># 进一步检查数据一致性（在两个集群分别执行，比较 字节数 是否一致）</span></span><br><span class="line">$ hadoop fs -du hdfs://&lt;base path&gt;/hbase/data/&lt;namespace&gt;/&lt;table name&gt;</span><br></pre></td></tr></tbody></table></figure>
<div class="note info">如果是拷贝至自身集群，则可以使用 new.name 参数，以创建新的表</div>
<div class="note info">如果是统计列数，可以使用 CellCounter</div>



<h5 id="Replication"><a href="#Replication" class="headerlink" title="Replication"></a>Replication</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 小集群上执行</span></span><br><span class="line"><span class="comment"># 预先进行 list_peers，避免 peer id 冲突</span></span><br><span class="line">$ list_peers</span><br><span class="line">$ add_peer <span class="string">'&lt;peer id&gt;'</span>, <span class="string">"&lt;big cluster zk address&gt;,&lt;big cluster zk address&gt;,...:&lt;big cluster zk port&gt;:/&lt;hbase parent path&gt;"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 开启表的 REPLICATION_SCOPE</span></span><br><span class="line">$ <span class="built_in">disable</span> <span class="string">'&lt;table name&gt;'</span></span><br><span class="line"><span class="comment"># 1: open; 0: close（default）</span></span><br><span class="line">$ alter <span class="string">'&lt;table name&gt;'</span>, {NAME =&gt; <span class="string">'&lt;column family&gt;'</span>, REPLICATION_SCOPE =&gt; <span class="string">'1'</span>}</span><br><span class="line">$ <span class="built_in">enable</span> <span class="string">'&lt;table name&gt;'</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="Trouble-shooting"><a href="#Trouble-shooting" class="headerlink" title="Trouble shooting"></a>Trouble shooting</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 源集群执行</span></span><br><span class="line">$ hbase hbck</span><br><span class="line"><span class="comment"># 出现问题后 hbase hbck --repair</span></span><br><span class="line"><span class="comment"># 没有问题后 `hbase shell` 中执行</span></span><br><span class="line">$ balance_switch <span class="literal">true</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="关闭自动分区"><a href="#关闭自动分区" class="headerlink" title="关闭自动分区"></a>关闭自动分区</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ alter <span class="string">'yuzhouwan'</span>, {METHOD =&gt; <span class="string">'table_att'</span>, SPLIT_POLICY =&gt; <span class="string">'org.apache.hadoop.hbase.regionserver.DisabledRegionSplitPolicy'</span>}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="JMX-获取部分指标项"><a href="#JMX-获取部分指标项" class="headerlink" title="JMX 获取部分指标项"></a>JMX 获取部分指标项</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 语法</span></span><br><span class="line">http://namenode:50070/jmx?qry=&lt;指标项&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 例如，只返回 NameNodeInfo 指标项</span></span><br><span class="line">http://namenode:50070/jmx?qry=hadoop:service=NameNode,name=NameNodeInfo</span><br></pre></td></tr></tbody></table></figure>
<h3 id="提示已经被删除的表，仍然存在"><a href="#提示已经被删除的表，仍然存在" class="headerlink" title="提示已经被删除的表，仍然存在"></a>提示已经被删除的表，仍然存在</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ hbase zkcli</span><br><span class="line">&gt; ls /hbase/table</span><br><span class="line">&gt; rmr /hbase/table/<span class="variable">${table_name}</span></span><br><span class="line"><span class="comment"># 重启 HBase 集群即可</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h2><h3 id="Compaction"><a href="#Compaction" class="headerlink" title="Compaction"></a>Compaction</h3><h4 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h4><p>　一般的，我们会在一张 HBase 表中定义少量的 CF。而随着数据不断地写入到同一个 CF，为了避免 HStore 中单个的 HStoreFile 文件过大（默认 10G），会触发 Split 操作进行分裂。而对应于 Split 切割 HStoreFile 的行为，就是 Compaction 合并 HStoreFile 的操作。Compaction 的作用也是显而易见的，通过合并小的 HStoreFile，避免产生过多的小文件。同时 Compaction 操作小文件的时候，也不会带来严重的 IO 放大问题。另外，众多的业务场景，每个业务的数据分布的情况也不尽相同，因此 HBase 定义了 <code>CompactionPolicy</code> 接口，以便扩展选择 HStoreFile 的策略</p>
<h4 id="Date-Tiered-Compaction-Strategy"><a href="#Date-Tiered-Compaction-Strategy" class="headerlink" title="Date Tiered Compaction Strategy"></a>Date Tiered Compaction Strategy</h4><h5 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h5><p>　HBase 2.x 中新的 Compaction 策略 DTCS，同样也是扩展了 <code>CompactionPolicy</code> 接口。主要是针对时序数据的场景，解决了默认策略无法针对时间维度进行 Compaction，导致一次查询命中过多的 HStoreFile 的问题，如下图所示：</p>
<h5 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h5><p>　如下图所示，整个时间轴被一个个时间窗口分割开，每 4 个时间窗口会被 Compact，从而组成一个大的 Tier（由 <code>hbase.hstore.compaction.date.tiered.windows.per.tier</code> 指定，默认值为 4；窗口的大小由 <code>hbase.hstore.compaction.date.tiered.base.window.millis</code> 指定，默认值为 6h）。时间轴最右边是最近一段时间写入的数据，刚形成的 HStoreFile 不会立即被 DTCS 选中，需要等数量达到一定阀值的时候（由 <code>hbase.hstore.compaction.date.tiered.incoming.window.min</code> 指定，默认值为 6），可以减少不必要的 Compact 数量。为了避免 Compact 已经写入很久的数据，则可以指定一个阀值，来控制距离当前时间多久的数据不被 DTCS 选中（由 <code>hbase.hstore.compaction.date.tiered.max.storefile.age.millis</code> 指定，默认值为 <code>Long.MAX_VALUE</code>）</p>
<h5 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h5><ul>
<li>通过基于时间分层的存储结构，优化了针对时间范围的 Scan 查询请求</li>
<li>减少了 Compaciton 操作的开销</li>
<li>优化了 TTL 的处理效率</li>
</ul>
<h5 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h5><ul>
<li>不适合非时序数据，并且如果时序数据完全乱序写入的话，还是可能会退化到默认的 Compaction 策略</li>
<li>频繁的更新和删除操作，性能会比较差</li>
</ul>
<h2 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h2><p><img data-src="/picture/hbase/hbase_performance.png" alt="Apache HBase Performance"></p>
<center>（利用 <a href="https://www.xmind.net/" target="_blank">XMind</a>™ 绘制而成）</center>



<h2 id="踩过的坑"><a href="#踩过的坑" class="headerlink" title="踩过的坑"></a>踩过的坑</h2><h3 id="Table-is-neither-in-disabled-nor-in-enabled-state"><a href="#Table-is-neither-in-disabled-nor-in-enabled-state" class="headerlink" title="Table is neither in disabled nor in enabled state"></a>Table is neither in disabled nor in enabled state</h3><h4 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h4><p>　执行完正常的建表语句之后，一直卡在 <code>enable table</code> 这步上</p>
<h4 id="解决-1"><a href="#解决-1" class="headerlink" title="解决"></a>解决</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 检查发现 table 既不处于 `enable` 状态，也不处于 `disable` 状态</span></span><br><span class="line">$ is_enabled <span class="string">'yuzhouwan'</span></span><br><span class="line">  <span class="literal">false</span></span><br><span class="line">$ is_disabled <span class="string">'yuzhouwan'</span></span><br><span class="line">  <span class="literal">false</span></span><br><span class="line">$ hbase zkcli</span><br><span class="line">$ delete /hbase/table/yuzhouwan</span><br><span class="line">$ hbase hbck -fixMeta -fixAssignments</span><br><span class="line"><span class="comment"># 重启 active HMaster</span></span><br><span class="line">$ is_enabled <span class="string">'yuzhouwan'</span></span><br><span class="line">  <span class="literal">true</span></span><br><span class="line">$ <span class="built_in">disable</span> <span class="string">'yuzhouwan'</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="No-GCs-detected"><a href="#No-GCs-detected" class="headerlink" title="No GCs detected"></a>No GCs detected</h3><h4 id="解决-2"><a href="#解决-2" class="headerlink" title="解决"></a>解决</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 从 JDK6 开始 默认开启偏向锁</span></span><br><span class="line">-XX:+PrintSafepointStatistics -XX:PrintSafepointStatisticsCount=0</span><br><span class="line"><span class="comment"># 但是不适合高并发的场景，Cassandra 中已默认关闭</span></span><br><span class="line"><span class="comment"># 详见，https://github.com/apache/cassandra/blob/trunk/conf/jvm.options#L116</span></span><br><span class="line">-XX:-UseBiasedLocking</span><br><span class="line"><span class="comment"># 关闭偏向锁之后，JVM 默认使用轻量级锁</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h4><div class="table-container">
<table>
<thead>
<tr>
<th>锁</th>
<th>优点</th>
<th>缺点</th>
<th>适用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td>偏向锁</td>
<td>加锁和解锁不需要额外的消耗，和执行非同步方法比仅存在纳秒级的差距</td>
<td>如果线程间存在锁竞争，会带来额外的锁撤销的消耗</td>
<td>适用于只有一个线程访问同步块场景</td>
</tr>
<tr>
<td>轻量级锁</td>
<td>竞争的线程不会阻塞，提高了程序的响应速度</td>
<td>如果始终得不到锁竞争的线程使用自旋会消耗 CPU</td>
<td>追求响应时间，同步块执行速度非常快</td>
</tr>
<tr>
<td>重量级锁</td>
<td>线程竞争不使用自旋，不会消耗 CPU</td>
<td>线程阻塞，响应时间缓慢</td>
<td>追求吞吐量，同步块执行速度较慢</td>
</tr>
</tbody>
</table>
</div>
<h3 id="十六进制无法在命令行被识别"><a href="#十六进制无法在命令行被识别" class="headerlink" title="十六进制无法在命令行被识别"></a>十六进制无法在命令行被识别</h3><h4 id="解决-3"><a href="#解决-3" class="headerlink" title="解决"></a>解决</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 只需要用双引号包起来就可以了</span></span><br><span class="line">$ put <span class="string">'yuzhouwan'</span>, <span class="string">'rowkey01'</span>, <span class="string">'cf:age'</span>, <span class="string">"\xFF"</span>  <span class="comment">#255</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="社区跟进"><a href="#社区跟进" class="headerlink" title="社区跟进"></a>社区跟进</h2><p>　详见：《<a href="https://yuzhouwan.com/posts/19631/">如何成为 Apache 的 PMC</a>》</p>
<h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><h3 id="Doc"><a href="#Doc" class="headerlink" title="Doc"></a>Doc</h3><ul>
<li><a href="https://hbase.apache.org/book.html#hbase_metrics">HBase Metrics</a></li>
<li><a href="http://hbase.apache.org/book.html#ops.date.tiered">Date Tiered Compaction</a></li>
<li><a href="https://hbase.apache.org/book.html#hbase_mob">MOB: Medium-sized Objects</a></li>
<li><a href="https://www.cloudera.com/documentation/enterprise/5-9-x/topics/admin_hbase_filtering.html">HBase Filtering</a></li>
</ul>
<h3 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h3><ul>
<li><a href="https://issues.apache.org/jira/browse/HBASE-15181">A simple implementation of date based tiered compaction</a></li>
<li><a href="https://issues.apache.org/jira/browse/HBASE-19215">Incorrect exception handling on the client causes incorrect call timeouts and byte buffer allocations on the server</a></li>
</ul>
<h3 id="Blog"><a href="#Blog" class="headerlink" title="Blog"></a>Blog</h3><ul>
<li><a href="https://issues.apache.org/jira/browse/HBASE-7266">[89-fb] Using pread for non-compaction read request</a></li>
<li><img data-src="/picture/hbase/hbase_test_caching_limit_small.jpg" alt=""><center>（图片来源：<a href="https://issues.apache.org/jira/secure/attachment/12602275/test%20results.jpg" target="_blank">issues.apache.org</a>™）</center></li>
<li><a href="https://issues.apache.org/jira/browse/HBASE-9488">Improve performance for small scan</a></li>
<li><a href="https://issues.apache.org/jira/browse/HBASE-17917">Use pread by default for all user scan and switch to streaming read if needed</a></li>
<li><a href="https://blog.csdn.net/caoli98033/article/details/44650497">HBase scan setBatch 和 setCaching 的区别</a></li>
</ul>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt=""></a></td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>大数据</category>
      </categories>
      <tags>
        <tag>Apache HBase</tag>
        <tag>Apache Hive</tag>
      </tags>
  </entry>
  <entry>
    <title>Git 高级玩法</title>
    <url>/posts/30041/</url>
    <content><![CDATA[<p><img data-src="/picture/github/github_octocat.png" alt="Github Octocat"></p>
<center>（图片来源：<a href="https://github.com/asdf2014" target="_blank">Github</a>™ 官网）</center>

<h2 id="Git-Blame"><a href="#Git-Blame" class="headerlink" title="Git Blame"></a>Git Blame</h2><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 查看文件中，每一行的修改人和最后改动时间</span></span><br><span class="line">$ git blame pom.xml</span><br><span class="line">  ^e81ccde3 (BenedictJin 2018-06-04 11:16:19 +0800   1) &lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span><br></pre></td></tr></tbody></table></figure>
<h2 id="Git-Branch"><a href="#Git-Branch" class="headerlink" title="Git Branch"></a>Git Branch</h2><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 克隆当前分支，以此创建新的 branch，并切换</span></span><br><span class="line">$ git checkout -b &lt;branch&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重命名 branch 名称</span></span><br><span class="line">$ git branch -m &lt;old_name&gt; &lt;new_name&gt;</span><br><span class="line">$ git branch -m &lt;new_name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 恢复删除掉的 branch</span></span><br><span class="line"><span class="comment"># 查看你上一次 commit SHA1 值</span></span><br><span class="line">$ git reflog</span><br><span class="line"><span class="comment"># 恢复</span></span><br><span class="line">$ git branch &lt;branch_name&gt; &lt;sha1&gt;</span><br></pre></td></tr></tbody></table></figure>
<h2 id="Git-Cache"><a href="#Git-Cache" class="headerlink" title="Git Cache"></a>Git Cache</h2><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 添加 .gitignore 文件之后，可能有些文件报错 `ignored tracked with git`</span></span><br><span class="line"><span class="comment"># 需要用 `git rm --cached` 进行删除</span></span><br><span class="line">$ git rm --cached &lt;file&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 部分动态文件可能报错文件内容不一致 `the following files have staged content different from both the file and the HEAD`</span></span><br><span class="line"><span class="comment"># 需要增加 `-f` 参数进行强制删除</span></span><br><span class="line">$ git rm --cached -f .idea/workspace.xml</span><br></pre></td></tr></tbody></table></figure>
<a id="more"></a>
<h2 id="Git-Cherry-pick"><a href="#Git-Cherry-pick" class="headerlink" title="Git Cherry-pick"></a>Git Cherry-pick</h2><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 指定某一次提交，合并到当前分支中</span></span><br><span class="line">$ git cherry-pick 5738c801c</span><br></pre></td></tr></tbody></table></figure>
<h2 id="Git-Checkout"><a href="#Git-Checkout" class="headerlink" title="Git Checkout"></a>Git Checkout</h2><h3 id="checkout-的同时，创建新的-branch"><a href="#checkout-的同时，创建新的-branch" class="headerlink" title="checkout 的同时，创建新的 branch"></a>checkout 的同时，创建新的 branch</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ git checkout -b &lt;new_branch_new&gt;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="撤销某个文件的修改"><a href="#撤销某个文件的修改" class="headerlink" title="撤销某个文件的修改"></a>撤销某个文件的修改</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ git checkout -- &lt;file&gt;</span><br></pre></td></tr></tbody></table></figure>
<!-- echo "backup..." && now_branch="`git branch | ccat | grep "*" | sed 's/* //g'`" && echo "now: $now_branch" && new_branch="${now_branch}_`date +%Y-%m-%d_%H%M%S`" && echo "new: $new_branch" && git checkout -b "$new_branch" && git checkout "$now_branch" && echo "done." -->
<h2 id="Git-Clone"><a href="#Git-Clone" class="headerlink" title="Git Clone"></a>Git Clone</h2><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 只下载最后一次 commit 版本的代码</span></span><br><span class="line">$ git <span class="built_in">clone</span> --depth 1 https://github.com/asdf2014/yuzhouwan</span><br><span class="line"></span><br><span class="line"><span class="comment"># 此时，是不可以直接 push 代码的，需要下载剩下的历史 commit 记录，否则会报错 shallow update not allowed</span></span><br><span class="line">$ git fetch --unshallow origin</span><br></pre></td></tr></tbody></table></figure>
<h2 id="Git-Config"><a href="#Git-Config" class="headerlink" title="Git Config"></a>Git Config</h2><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ git config --global user.name <span class="string">"asdf2014"</span></span><br><span class="line">$ git config --global user.email <span class="string">"asdf2014@apache.org"</span></span><br><span class="line">$ git reset .</span><br><span class="line">$ git add -A</span><br><span class="line">$ git diff --staged</span><br></pre></td></tr></tbody></table></figure>
<h2 id="Git-Commit"><a href="#Git-Commit" class="headerlink" title="Git Commit"></a>Git Commit</h2><h3 id="Allow-Empty"><a href="#Allow-Empty" class="headerlink" title="Allow Empty"></a>Allow Empty</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ git commit --allow-empty -m <span class="string">'yuzhouwan.com'</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="Commit-Merge"><a href="#Commit-Merge" class="headerlink" title="Commit Merge"></a>Commit Merge</h3><h4 id="常规操作"><a href="#常规操作" class="headerlink" title="常规操作"></a>常规操作</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ git <span class="built_in">log</span> --pretty=oneline</span><br><span class="line"></span><br><span class="line">  651cc60d971aba93bdde645b6331c33068462645 Merge branch <span class="string">'master'</span> of https://github.com/asdf2014/superset</span><br><span class="line">  415610958494446ccd37c0c87da98eba56af42ac Merge branch <span class="string">'temp'</span></span><br><span class="line">  b881140282893fa4add183a2b3f2637968f95069 Merge branch <span class="string">'master'</span> into master</span><br><span class="line">  f2bf3160583533bd0dc5004f248f81251aa8c57e Add NUMERIC num_type (<span class="comment">#2127)</span></span><br><span class="line">  6a0fefdbd542da4ea313313a191eadd1efe58faa Using the time zone with specific name <span class="keyword">for</span> querying Druid</span><br><span class="line">  9cd38fa1eda63152c27b76c29dd948f29444b686 little code refactor <span class="keyword">in</span> models.py (<span class="comment">#2124)</span></span><br><span class="line"></span><br><span class="line">$ git reset --soft HEAD~2 &amp;&amp;</span><br><span class="line">$ git commit --edit -m <span class="string">"<span class="subst">$($ git log --format=%B --reverse HEAD..HEAD@{1})</span>"</span></span><br><span class="line"></span><br><span class="line">  [master fd41c16] Add NUMERIC num_type (<span class="comment">#2127)</span></span><br><span class="line">  1 file changed, 1 insertion(+), 1 deletion(-)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更改之后的 commit 信息</span></span><br><span class="line">fd41c1608579408fcd26d0dd03adf0d461599101 Add NUMERIC num_type (<span class="comment">#2127)</span></span><br><span class="line">6a0fefdbd542da4ea313313a191eadd1efe58faa Using the time zone with specific name <span class="keyword">for</span> querying Druid</span><br><span class="line">9cd38fa1eda63152c27b76c29dd948f29444b686 little code refactor <span class="keyword">in</span> models.py (<span class="comment">#2124)</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="踩到的坑"><a href="#踩到的坑" class="headerlink" title="踩到的坑"></a>踩到的坑</h4><h5 id="Failed-to-push-some-refs"><a href="#Failed-to-push-some-refs" class="headerlink" title="Failed to push some refs"></a>Failed to push some refs</h5><h6 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">Username <span class="keyword">for</span> <span class="string">'https://github.com'</span>: asdf2014</span><br><span class="line">To https://github.com/asdf2014/superset.git</span><br><span class="line">! [rejected]        ext_deprecation_warning -&gt; ext_deprecation_warning (non-fast-forward)</span><br><span class="line">error: failed to push some refs to <span class="string">'https://github.com/asdf2014/superset.git'</span></span><br><span class="line">hint: Updates were rejected because the tip of your current branch is behind</span><br><span class="line">hint: its remote counterpart. Integrate the remote changes (e.g.</span><br><span class="line">hint: <span class="string">'$ git pull ...'</span>) before pushing again.</span><br><span class="line">hint: See the <span class="string">'Note about fast-forwards'</span> <span class="keyword">in</span> <span class="string">'$ git push --help'</span> <span class="keyword">for</span> details.</span><br></pre></td></tr></tbody></table></figure>
<h6 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 强制提交</span></span><br><span class="line">$ git push -u origin ext_deprecation_warning --force</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Commit-Remove"><a href="#Commit-Remove" class="headerlink" title="Commit Remove"></a>Commit Remove</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ git reset --hard &lt;sha1-commit-id&gt;</span><br><span class="line">$ git push origin HEAD --force</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Commit-Change"><a href="#Commit-Change" class="headerlink" title="Commit Change"></a>Commit Change</h3><h4 id="只修改最后一次提交"><a href="#只修改最后一次提交" class="headerlink" title="只修改最后一次提交"></a>只修改最后一次提交</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 格式</span></span><br><span class="line">$ git commit --amend</span><br><span class="line">$ git commit --amend -m <span class="string">"New commit message"</span></span><br><span class="line">$ git commit --amend --author <span class="string">"Author Name &lt;email@address.com&gt;"</span></span><br><span class="line"><span class="comment"># 示例</span></span><br><span class="line">$ git commit --amend -m <span class="string">'remove warnings.simplefilter from cli.py into superset for PEP (#2137)'</span></span><br><span class="line">$ git commit --amend --author <span class="string">"asdf2014 &lt;asdf2014@apache.org&gt;"</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="修改之前的提交信息"><a href="#修改之前的提交信息" class="headerlink" title="修改之前的提交信息"></a>修改之前的提交信息</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ git rebase -i HEAD~2</span><br><span class="line">  pick xxxx</span><br><span class="line">  reword yyyy</span><br></pre></td></tr></tbody></table></figure>
<h4 id="修改提交的日期"><a href="#修改提交的日期" class="headerlink" title="修改提交的日期"></a>修改提交的日期</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 查看当前时间</span></span><br><span class="line">$ date -R</span><br><span class="line">  Mon, 07 Jan 2018 11:12:55 +0800</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改最后一次 commit 的提交日期</span></span><br><span class="line">$ git commit --amend --date=<span class="string">"Mon, 07 Jan 2018 12:00:00 +0800"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新提交日期为当前时间</span></span><br><span class="line">$ git commit --amend --date=<span class="string">"<span class="subst">$(date -R)</span>"</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="Reset-into-Specific-Commit"><a href="#Reset-into-Specific-Commit" class="headerlink" title="Reset into Specific Commit"></a>Reset into Specific Commit</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># It will make your local code and local history be just like it was at that commit. But then if you wanted to push this to someone else who has the new history, it would fail.</span></span><br><span class="line">$ git reset --hard c14809fa</span><br><span class="line"></span><br><span class="line"><span class="comment"># It will make your local files changed to be like they were then, but leave your history etc. the same.</span></span><br><span class="line">$ git reset --soft c14809fa</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Squash-Commits-into-a-Single-Commit"><a href="#Squash-Commits-into-a-Single-Commit" class="headerlink" title="Squash Commits into a Single Commit"></a>Squash Commits into a Single Commit</h3><h4 id="常规操作-1"><a href="#常规操作-1" class="headerlink" title="常规操作"></a>常规操作</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 查看哪些 commits 需要进行合并</span></span><br><span class="line">$ git <span class="built_in">log</span> --pretty=oneline</span><br><span class="line"><span class="comment"># 合并最后 11 个 commit</span></span><br><span class="line">$ git rebase -i HEAD~11</span><br><span class="line">  pick xxxx yyyy</span><br><span class="line">  pick xxxx yyyy</span><br><span class="line">  pick xxxx yyyy</span><br><span class="line">  <span class="comment"># 将需要压缩的 commit 之前的 `pick` 替换为 `squash`</span></span><br><span class="line">  pick xxxx yyyy</span><br><span class="line">  squash xxxx yyyy</span><br><span class="line">  squash xxxx yyyy</span><br><span class="line"></span><br><span class="line">$ git commit --amend -m <span class="string">'The log length has exceeded the limit of 4 MB in Travis'</span></span><br><span class="line">$ git push origin travis_log --force</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如需解决冲突后，继续进行 rebase 操作，可执行</span></span><br><span class="line">$ git rebase --<span class="built_in">continue</span></span><br><span class="line"><span class="comment"># 如果想中断 rebase 操作，则执行</span></span><br><span class="line">$ git rebase --abort</span><br><span class="line"><span class="comment"># 更多细节</span></span><br><span class="line">$ git rebase --<span class="built_in">help</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><h5 id="回滚"><a href="#回滚" class="headerlink" title="回滚"></a>回滚</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ git reset --hard ORIG_HEAD</span><br></pre></td></tr></tbody></table></figure>
<h5 id="回滚上一次操作"><a href="#回滚上一次操作" class="headerlink" title="回滚上一次操作"></a><a href="https://stackoverflow.com/questions/927358/how-to-undo-the-most-recent-commits-in-git">回滚上一次操作</a></h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ git commit -m <span class="string">"Something terribly misguided"</span></span><br><span class="line">$ git reset HEAD~</span><br><span class="line">&lt;&lt; edit files as necessary &gt;&gt;</span><br><span class="line">$ git add ...</span><br><span class="line">$ git commit -c ORIG_HEAD</span><br></pre></td></tr></tbody></table></figure>
<h5 id="指定-commit-number"><a href="#指定-commit-number" class="headerlink" title="指定 commit number"></a>指定 commit number</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ git rebase &lt;commit number&gt;</span><br></pre></td></tr></tbody></table></figure>
<h5 id="合并-branch-改动到-master-中"><a href="#合并-branch-改动到-master-中" class="headerlink" title="合并 branch 改动到 master 中"></a>合并 branch 改动到 master 中</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 会将 branch 里的 commit 排到 master 的顶部，避免带 Merge 信息的 `空 commit` 出现</span></span><br><span class="line">$ git checkout &lt;branch name&gt;</span><br><span class="line">$ git rebase -i master</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果已经在当前 branch 执行了 git merge master，并解决了冲突，可以直接执行下面这行命令，完成 rebase 操作</span></span><br><span class="line">$ git rebase --root --onto master --preserve-merges</span><br><span class="line"></span><br><span class="line"><span class="comment"># 万一出现太多的问题，难以解决，可以采用如下暴力的方式（在意 commit 信息的，请预先备份好）</span></span><br><span class="line">$ git rebase --abort                <span class="comment"># 首先 abort 之前的 rebase 流程</span></span><br><span class="line">$ git checkout code_refactoring</span><br><span class="line">$ git checkout -b re2</span><br><span class="line">$ git branch root bbb61e638b391d29  <span class="comment"># 以当前 branch 未做任何修改之前的 commit 为基础，创建 root 分支</span></span><br><span class="line">$ git checkout re2</span><br><span class="line">$ git diff master &gt; ../123.patch    <span class="comment"># 当前 branch 相对 master 已经做的修改打出 patch 文件</span></span><br><span class="line">$ git checkout master</span><br><span class="line">$ git checkout -b r2</span><br><span class="line">$ git apply ../123.patch            <span class="comment"># 以 master 为基础，apply 分支上做的修改</span></span><br><span class="line">$ git diff master</span><br><span class="line">$ git status</span><br><span class="line">$ git diff --name-status | wc -l    <span class="comment"># 确认修改的文件数 是否正确</span></span><br><span class="line">$ git add .</span><br><span class="line">$ git status</span><br><span class="line">$ git diff master</span><br><span class="line">$ git commit -m <span class="string">'Improve `collection` related things that reusing a immutable object instead of creating a new object'</span></span><br><span class="line">$ git status</span><br><span class="line">$ git push origin r2:code_refactoring -f</span><br></pre></td></tr></tbody></table></figure>
<h2 id="Git-Diff"><a href="#Git-Diff" class="headerlink" title="Git Diff"></a>Git Diff</h2><h3 id="Git-diff-two-commits"><a href="#Git-diff-two-commits" class="headerlink" title="Git diff two commits"></a>Git diff two commits</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ git diff 1285c982 b0aaa7de &gt; v3.4.6_vs_v3.4.10.patch</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Git-diff-two-branchs"><a href="#Git-diff-two-branchs" class="headerlink" title="Git diff two branchs"></a>Git diff two branchs</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ git diff branch_1..branch_2</span><br></pre></td></tr></tbody></table></figure>
<h2 id="Git-Fetch"><a href="#Git-Fetch" class="headerlink" title="Git Fetch"></a>Git Fetch</h2><h3 id="Normal"><a href="#Normal" class="headerlink" title="Normal"></a>Normal</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Github 上对某一个开源项目进行 fork</span></span><br><span class="line">https://github.com/apache/superset</span><br><span class="line">https://github.com/asdf2014/superset (forked from apache/superset)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 本地获取 fork 出来的 asdf2014/superset</span></span><br><span class="line">$ git init</span><br><span class="line">$ git remote add origin https://github.com/asdf2014/superset.git</span><br><span class="line">$ git remote -v</span><br><span class="line">  origin  https://github.com/asdf2014/superset.git (fetch)</span><br><span class="line">  origin  https://github.com/asdf2014/superset.git (push)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 发现并没有 airbnb/superset 的 origin/master，可以在直接往 asdf2014/superset 提交，然后在 github 上进行 pull request 的创建</span></span><br><span class="line">https://github.com/apache/superset/pull/2136 (Fix werkzeug instance was created twice <span class="keyword">in</span> Debug Mode (<span class="comment">#2135) #2136)</span></span><br><span class="line"></span><br><span class="line">$ git fetch https://github.com/apache/superset.git master:tmp</span><br><span class="line">$ git diff tmp</span><br><span class="line">$ git merge tmp</span><br><span class="line">$ git branch -d tmp</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Fetch-all-tags"><a href="#Fetch-all-tags" class="headerlink" title="Fetch all tags"></a>Fetch all tags</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ git fetch --tags</span><br><span class="line">$ git checkout tags/release-3.4.6</span><br><span class="line">$ git checkout master</span><br><span class="line">  Previous HEAD position was 1285c982... ZooKeeper 3.4.6 release.</span><br><span class="line">  Switched to branch <span class="string">'master'</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="Git-Merge"><a href="#Git-Merge" class="headerlink" title="Git Merge"></a>Git Merge</h2><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 如果不希望 PR 中的 comment 信息被冲掉，可以使用 `git merge` 替代 `git rebase`</span></span><br><span class="line">$ git merge</span><br><span class="line"><span class="comment"># 如果存在冲突，解决后，执行如下两个命令</span></span><br><span class="line">$ git add .</span><br><span class="line">$ git merge --<span class="built_in">continue</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="Git-Apply"><a href="#Git-Apply" class="headerlink" title="Git Apply"></a>Git Apply</h2><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 指定 --reject 强制打补丁，会生成 .rej 文件，需要手动解决冲突</span></span><br><span class="line">$ git apply --reject yuzhouwan.patch</span><br></pre></td></tr></tbody></table></figure>
<h2 id="Git-Reflog"><a href="#Git-Reflog" class="headerlink" title="Git Reflog"></a>Git Reflog</h2><h3 id="恢复-git-reset-hard"><a href="#恢复-git-reset-hard" class="headerlink" title="恢复 git reset --hard"></a>恢复 <code>git reset --hard</code></h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 找到 reset 操作的</span></span><br><span class="line">$ git reflog</span><br><span class="line">  2a93709d (HEAD -&gt; yuzhouwan, origin/yuzhouwan) HEAD@{0}: reset: moving to 631cc5233063bb014587a9caf0c9e3095fe6a60e</span><br><span class="line">  b5b67779 HEAD@{1}: commit: Something important</span><br><span class="line"></span><br><span class="line"><span class="comment"># 回滚到 reset 操作前的一次提交</span></span><br><span class="line">$ git reset --hard b5b67779</span><br></pre></td></tr></tbody></table></figure>
<h2 id="Git-Remote"><a href="#Git-Remote" class="headerlink" title="Git Remote"></a>Git Remote</h2><h3 id="Change-remote-url"><a href="#Change-remote-url" class="headerlink" title="Change remote url"></a>Change remote url</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ git remote <span class="built_in">set</span>-url origin &lt;url&gt;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Pull-specific-tag-from-remote"><a href="#Pull-specific-tag-from-remote" class="headerlink" title="Pull specific tag from remote"></a>Pull specific tag from remote</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ git pull origin release-1.7.7:release-1.7.7</span><br></pre></td></tr></tbody></table></figure>
<h3 id="同时-push-到多个仓库"><a href="#同时-push-到多个仓库" class="headerlink" title="同时 push 到多个仓库"></a>同时 push 到多个仓库</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ git remote <span class="built_in">set</span>-url --add origin git@github.com:asdf2014/draft.git</span><br><span class="line">$ git remote -v</span><br><span class="line">  origin  https://git.coding.net/BenedictJin/test.git (fetch)</span><br><span class="line">  origin  https://git.coding.net/BenedictJin/test.git (push)</span><br><span class="line">  origin  git@github.com:asdf2014/test.git (push)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="删除远程仓库"><a href="#删除远程仓库" class="headerlink" title="删除远程仓库"></a>删除远程仓库</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ git remote rm origin</span><br></pre></td></tr></tbody></table></figure>
<h2 id="Git-Reset"><a href="#Git-Reset" class="headerlink" title="Git Reset"></a>Git Reset</h2><h3 id="回退某一个文件的修改"><a href="#回退某一个文件的修改" class="headerlink" title="回退某一个文件的修改"></a>回退某一个文件的修改</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ git reset HEAD^ yuzhouwan.txt</span><br></pre></td></tr></tbody></table></figure>
<h2 id="Git-Revert"><a href="#Git-Revert" class="headerlink" title="Git Revert"></a>Git Revert</h2><h3 id="创建某一个-commit-相反的-patch"><a href="#创建某一个-commit-相反的-patch" class="headerlink" title="创建某一个 commit 相反的 patch"></a>创建某一个 commit 相反的 patch</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ git revert &lt;commit number&gt;</span><br></pre></td></tr></tbody></table></figure>
<h2 id="Git-Rm"><a href="#Git-Rm" class="headerlink" title="Git Rm"></a>Git Rm</h2><h3 id="清理缓存"><a href="#清理缓存" class="headerlink" title="清理缓存"></a>清理缓存</h3><h4 id="描述-1"><a href="#描述-1" class="headerlink" title="描述"></a>描述</h4><p>　某些已经被加到 <code>.gitignore</code> 的文件提示，ignored, tracked with git</p>
<h4 id="解决-1"><a href="#解决-1" class="headerlink" title="解决"></a>解决</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 单个文件</span></span><br><span class="line">$ git rm --cached &lt;file&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 整个项目</span></span><br><span class="line">$ git rm -r --cached .</span><br><span class="line"></span><br><span class="line"><span class="comment"># add 变更内容，并切换到 tmp 分支，commit 后，再删除 tmp 分支</span></span><br><span class="line">$ git add .</span><br><span class="line">$ git checkout -b tmp</span><br><span class="line">$ git commit -m <span class="string">'Remove ignored files'</span></span><br><span class="line">$ git checkout master</span><br><span class="line">$ git branch -D tmp</span><br></pre></td></tr></tbody></table></figure>
<h2 id="Git-Stash"><a href="#Git-Stash" class="headerlink" title="Git Stash"></a>Git Stash</h2><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 查看当前分支已经存在的改动</span></span><br><span class="line">$ git status</span><br><span class="line">  On branch exception_governance</span><br><span class="line">  Your branch is up to date with <span class="string">'origin/exception_governance'</span>.</span><br><span class="line"></span><br><span class="line">  Changes to be committed:</span><br><span class="line">    (use <span class="string">"git reset HEAD &lt;file&gt;..."</span> to unstage)</span><br><span class="line"></span><br><span class="line">          new file:   a</span><br><span class="line"></span><br><span class="line"><span class="comment"># 临时保存当前分支的修改</span></span><br><span class="line">$ git stash</span><br><span class="line">  Saved working directory and index state WIP on exception_governance: d5062a04 Govern old error codes and their exceptions</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看已经临时保存的改动</span></span><br><span class="line">$ git stash list</span><br><span class="line">  stash@{0}: WIP on exception_governance: d5062a04 Govern old error codes and their exceptions</span><br><span class="line"></span><br><span class="line"><span class="comment"># 已经看到修改已经被隐藏了</span></span><br><span class="line">$ git add .</span><br><span class="line">$ git diff --staged</span><br><span class="line"></span><br><span class="line"><span class="comment"># 再次从 stash 中恢复出之前的修改</span></span><br><span class="line">$ git stash pop</span><br><span class="line">  On branch exception_governance</span><br><span class="line">  Your branch is up to date with <span class="string">'origin/exception_governance'</span>.</span><br><span class="line"></span><br><span class="line">  Changes to be committed:</span><br><span class="line">    (use <span class="string">"git reset HEAD &lt;file&gt;..."</span> to unstage)</span><br><span class="line"></span><br><span class="line">          new file:   a</span><br><span class="line"></span><br><span class="line">  Dropped refs/stash@{0} (a88e4f6d681eb59b9b22e800f2c00f4c9e22d529)</span><br></pre></td></tr></tbody></table></figure>
<h2 id="Git-Tag"><a href="#Git-Tag" class="headerlink" title="Git Tag"></a>Git Tag</h2><h3 id="Create-tag"><a href="#Create-tag" class="headerlink" title="Create tag"></a>Create tag</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 创建简单的标签</span></span><br><span class="line">$ git tag v0.0.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建带有附注的 tag</span></span><br><span class="line">$ git tag -a v0.0.2 -m <span class="string">"v0.0.2"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 展示 tag 信息</span></span><br><span class="line">$ git show v0.0.2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 给指定的 commit，打 tag</span></span><br><span class="line">$ git tag -a v0.0.3 6d23400</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Submit-tag"><a href="#Submit-tag" class="headerlink" title="Submit tag"></a>Submit tag</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ git push origin v0.0.2</span><br><span class="line"></span><br><span class="line"><span class="comment"># push 本地所有标签</span></span><br><span class="line">$ git push origin –tags</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Pull-with-specific-tag"><a href="#Pull-with-specific-tag" class="headerlink" title="Pull with specific tag"></a>Pull with specific tag</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出 tag 列表，并 checkout 到指定的 tag</span></span><br><span class="line">$ git tag -l</span><br><span class="line">$ git checkout tags/&lt;tag_name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># checkout 到指定的 tag，并创建一个新的 branch</span></span><br><span class="line">$ git checkout tags/&lt;tag_name&gt; -b &lt;branch_name&gt;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Delete-tag"><a href="#Delete-tag" class="headerlink" title="Delete tag"></a>Delete tag</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 删除本地 Tag</span></span><br><span class="line">$ git tag -d v3.4.6.0</span><br><span class="line">  Deleted tag <span class="string">'v3.4.6.0'</span> (was 0e48a03a)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除远程 Tag</span></span><br><span class="line">$ git push origin :refs/tags/v3.4.6.0</span><br><span class="line">  To http://github.com/asdf2014/zookeeper.git</span><br><span class="line">   - [deleted]           v3.4.6.0</span><br></pre></td></tr></tbody></table></figure>
<h2 id="Git-编辑器切换为-Notepad"><a href="#Git-编辑器切换为-Notepad" class="headerlink" title="Git 编辑器切换为 Notepad++"></a>Git 编辑器切换为 Notepad++</h2><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 命令行设置</span></span><br><span class="line">$ git config --global core.editor <span class="string">"'D:/apps/Notepad++/notepad++.exe' -multiInst -notabbar -nosession -noPlugin"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改配置文件</span></span><br><span class="line">$ vim ~/.gitconfig</span><br><span class="line">  [core]</span><br><span class="line">    editor = <span class="string">'D:/apps/Notepad++/notepad++.exe'</span> -multiInst -notabbar -nosession -noPlugin</span><br></pre></td></tr></tbody></table></figure>
<h2 id="Git-代理"><a href="#Git-代理" class="headerlink" title="Git 代理"></a>Git 代理</h2><h3 id="通过命令设置"><a href="#通过命令设置" class="headerlink" title="通过命令设置"></a>通过命令设置</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ git config --global http.proxy <span class="string">'http://192.168.1.101:8888'</span></span><br><span class="line">$ git config --global https.proxy <span class="string">'https://192.168.1.101:8888'</span></span><br><span class="line">$ git config --global http.proxy <span class="string">'socks5://127.0.0.1:1080'</span></span><br><span class="line">$ git config --global https.proxy <span class="string">'socks5://127.0.0.1:1080'</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="通过配置文件设置"><a href="#通过配置文件设置" class="headerlink" title="通过配置文件设置"></a>通过配置文件设置</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim ~/.ssh/config</span><br><span class="line">   [http]</span><br><span class="line">     proxy = http://192.168.1.101:8888</span><br><span class="line">   [https]</span><br><span class="line">     proxy = https://192.168.1.101:8888</span><br><span class="line"><span class="comment">#  [http]</span></span><br><span class="line"><span class="comment">#    proxy = socks5://127.0.0.1:1080</span></span><br><span class="line"><span class="comment">#  [https]</span></span><br><span class="line"><span class="comment">#    proxy = socks5://127.0.0.1:1080</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="踩过的坑"><a href="#踩过的坑" class="headerlink" title="踩过的坑"></a>踩过的坑</h3><h4 id="SSL-ERROR-SYSCALL-in-connection-to-git-coding-net-443"><a href="#SSL-ERROR-SYSCALL-in-connection-to-git-coding-net-443" class="headerlink" title="SSL_ERROR_SYSCALL in connection to git.coding.net:443"></a>SSL_ERROR_SYSCALL in connection to git.coding.net:443</h4><h5 id="描述-2"><a href="#描述-2" class="headerlink" title="描述"></a>描述</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ git push origin master</span><br><span class="line">  Counting objects: 9, <span class="keyword">done</span>.</span><br><span class="line">  Delta compression using up to 4 threads.</span><br><span class="line">  Compressing objects: 100% (9/9), <span class="keyword">done</span>.</span><br><span class="line">  Writing objects: 100% (9/9), 1.05 KiB | 1.05 MiB/s, <span class="keyword">done</span>.</span><br><span class="line">  Total 9 (delta 6), reused 0 (delta 0)</span><br><span class="line">  error: RPC failed; curl 35 OpenSSL SSL_connect: SSL_ERROR_SYSCALL <span class="keyword">in</span> connection to git.coding.net:443</span><br><span class="line">  fatal: The remote end hung up unexpectedly</span><br><span class="line">  fatal: The remote end hung up unexpectedly</span><br><span class="line">  Everything up-to-date</span><br></pre></td></tr></tbody></table></figure>
<h5 id="解决-2"><a href="#解决-2" class="headerlink" title="解决"></a>解决</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 先确保 git 和 curl 版本不能过低，如果 git &lt;2.60 或者 curl &lt;7.29，则需要升级到最新版本</span></span><br><span class="line">$ git --version</span><br><span class="line">$ curl --version</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打开 git 命令的 trace 日志</span></span><br><span class="line">$ <span class="built_in">export</span> GIT_CURL_VERBOSE=1</span><br><span class="line">$ <span class="built_in">export</span> GIT_TRACE_PACKET=2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 再次执行出错命令</span></span><br><span class="line">$ git push origin master</span><br><span class="line">  // ...</span><br><span class="line">  error: RPC failed; curl 7 Failed to connect to 127.0.0.1 port 1080: Connection refused</span><br><span class="line">  fatal: The remote end hung up unexpectedly</span><br><span class="line">  Everything up-to-date</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过日志分析，定位出是 proxy 的问题，关闭 proxy 即可</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="Git-中文乱码"><a href="#Git-中文乱码" class="headerlink" title="Git 中文乱码"></a>Git 中文乱码</h2><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ git config --global core.quotepath <span class="literal">false</span>          <span class="comment"># 显示 status 编码</span></span><br><span class="line">$ git config --global gui.encoding utf-8            <span class="comment"># 图形界面编码</span></span><br><span class="line">$ git config --global i18n.commit.encoding utf-8    <span class="comment"># 提交信息编码</span></span><br><span class="line">$ git config --global i18n.logoutputencoding utf-8  <span class="comment"># 输出 log 编码</span></span><br><span class="line">$ <span class="built_in">export</span> LESSCHARSET=utf-8                          <span class="comment"># `git log` 默认使用 `less` 分页，所以需要 `bash` 对 `less` 命令进行 `utf-8` 编码</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 让 `ls` 命令可以显示中文名称</span></span><br><span class="line">$ vim %GIT_HOME%\mingw64\share\git\completion\git-completion.bash</span><br><span class="line">  <span class="comment"># 在文件末尾处添加一行</span></span><br><span class="line">  <span class="built_in">alias</span> ls=<span class="string">"ls --show-control-chars --color"</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="Github-加速"><a href="#Github-加速" class="headerlink" title="Github 加速"></a>Github 加速</h2><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Ctrl + R（管理员权限运行）</span></span><br><span class="line"><span class="comment"># notepad "%SystemRoot%\system32\drivers\etc\hosts"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># https://asm.ca.com/zh_cn/ping.php</span></span><br><span class="line">192.30.253.112 github.com</span><br><span class="line">151.101.56.133 assets-cdn.github.com</span><br><span class="line">192.30.253.116 api.github.com</span><br><span class="line">192.30.253.121 codeload.github.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 中国 - 香港特别行政区（hkhkg02）</span></span><br><span class="line">192.30.253.112 github.com</span><br><span class="line">151.101.100.133 assets-cdn.github.com</span><br><span class="line">192.30.253.116 api.github.com</span><br><span class="line">192.30.253.121 codeload.github.com</span><br></pre></td></tr></tbody></table></figure>
<h2 id="Patch"><a href="#Patch" class="headerlink" title="Patch"></a>Patch</h2><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ git diff &gt; patch.diff</span><br><span class="line">$ git apply patch.diff</span><br></pre></td></tr></tbody></table></figure>
<h2 id="SSH-免密"><a href="#SSH-免密" class="headerlink" title="SSH 免密"></a>SSH 免密</h2><h3 id="常规操作-2"><a href="#常规操作-2" class="headerlink" title="常规操作"></a>常规操作</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 如果没有 .ssh 隐藏文件，则需要先打开 `git bash`，并执行</span></span><br><span class="line">$ mkdir ~/.ssh</span><br><span class="line">$ chmod 700 ~/.ssh</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> ~/.ssh</span><br><span class="line">$ ssh-keygen -t rsa -C <span class="string">"asdf2014@apache.org"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 ~/.ssh/id_rsa.pub 中的公钥加入 github/gitlab</span></span><br><span class="line">$ ssh -T git@github.com</span><br><span class="line">  Hi asdf2014! You<span class="string">'ve successfully authenticated, but GitHub does not provide shell access.    '</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># http -&gt; ssh</span></span><br><span class="line">$ git remote -v</span><br><span class="line">  origin  https://github.com/asdf2014/yuzhouwan (fetch)</span><br><span class="line">  origin  https://github.com/asdf2014/yuzhouwan (push)</span><br><span class="line"></span><br><span class="line">$ git remote <span class="built_in">set</span>-url origin git@github.com:asdf2014/yuzhouwan.git</span><br><span class="line"></span><br><span class="line">$ git remote -v</span><br><span class="line">  origin  git@github.com:asdf2014/yuzhouwan.git (fetch)</span><br><span class="line">  origin  git@github.com:asdf2014/yuzhouwan.git (push)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="如何在代理环境下，同时支持-github-gitlab-coding-的免密操作"><a href="#如何在代理环境下，同时支持-github-gitlab-coding-的免密操作" class="headerlink" title="如何在代理环境下，同时支持 github / gitlab / coding 的免密操作"></a>如何在代理环境下，同时支持 github / gitlab / coding 的免密操作</h3><h4 id="场景介绍"><a href="#场景介绍" class="headerlink" title="场景介绍"></a>场景介绍</h4><ul>
<li><code>github.com</code> 和 <code>coding.net</code> 需要走代理访问</li>
<li><code>gitlab</code> 是自建的私服</li>
</ul>
<h4 id="PAC-配置"><a href="#PAC-配置" class="headerlink" title="PAC 配置"></a>PAC 配置</h4><p>　在任何 git 相关操作之前，需要先配置 PAC 文件，来保证本机网络的畅通</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">var domains = {</span><br><span class="line">  <span class="string">"coding.net"</span>: 1,</span><br><span class="line">  <span class="string">"git.coding.net"</span>: 1,</span><br><span class="line">  <span class="string">"github.com"</span>: 1,</span><br><span class="line">  <span class="string">"ssh.github.com"</span>: 1</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line">var proxy = <span class="string">"__PROXY__"</span>;</span><br><span class="line"></span><br><span class="line">var direct = <span class="string">'DIRECT;'</span>;</span><br><span class="line"></span><br><span class="line">var hasOwnProperty = Object.hasOwnProperty;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> FindProxyForURL(url, host) {</span><br><span class="line">    var suffix;</span><br><span class="line">    var pos = host.lastIndexOf(<span class="string">'.'</span>);</span><br><span class="line">    pos = host.lastIndexOf(<span class="string">'.'</span>, pos - 1);</span><br><span class="line">    <span class="keyword">while</span>(1) {</span><br><span class="line">        <span class="keyword">if</span> (pos &lt;= 0) {</span><br><span class="line">            <span class="keyword">if</span> (hasOwnProperty.call(domains, host)) {</span><br><span class="line">                <span class="built_in">return</span> proxy;</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="built_in">return</span> direct;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        suffix = host.substring(pos + 1);</span><br><span class="line">        <span class="keyword">if</span> (hasOwnProperty.call(domains, suffix)) {</span><br><span class="line">            <span class="built_in">return</span> proxy;</span><br><span class="line">        }</span><br><span class="line">        pos = host.lastIndexOf(<span class="string">'.'</span>, pos - 1);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="SSH-配置"><a href="#SSH-配置" class="headerlink" title="SSH 配置"></a>SSH 配置</h4><p>　在配置 SSH 之前，同样需要保证 ssh 命令使用的网络代理是正确的</p>
<p>　首先，找到 <code>connect</code> 命令安装路径</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">which</span> connect</span><br><span class="line">  /mingw64/bin/connect</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">which</span> connect.exe</span><br><span class="line">  /mingw64/bin/connect.exe</span><br></pre></td></tr></tbody></table></figure>
<p>　其次，修改 <code>~/.ssh/config</code> 文件</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">Host github.com</span><br><span class="line">  User git</span><br><span class="line">  Port 22</span><br><span class="line">  Hostname github.com</span><br><span class="line">  IdentityFile ~/.ssh/id_rsa  <span class="comment"># 这里也可以填写绝对路径</span></span><br><span class="line">  TCPKeepAlive yes</span><br><span class="line">  IdentitiesOnly yes</span><br><span class="line">  ProxyCommand /mingw64/bin/connect.exe -H 127.0.0.1:1080 %h %p</span><br><span class="line"></span><br><span class="line">Host ssh.github.com</span><br><span class="line">  User git</span><br><span class="line">  Port 443</span><br><span class="line">  Hostname ssh.github.com</span><br><span class="line">  IdentityFile ~/.ssh/id_rsa</span><br><span class="line">  TCPKeepAlive yes</span><br><span class="line">  IdentitiesOnly yes</span><br><span class="line">  ProxyCommand /mingw64/bin/connect.exe -H 127.0.0.1:1080 %h %p</span><br><span class="line"></span><br><span class="line">Host git.coding.net</span><br><span class="line">  User &lt;email&gt;  <span class="comment"># coding.net 这里比较特殊，需要填写注册的邮箱地址</span></span><br><span class="line">  PreferredAuthentications publickey</span><br><span class="line">  IdentityFile ~/.ssh/id_rsa</span><br><span class="line">  TCPKeepAlive yes</span><br><span class="line">  IdentitiesOnly yes</span><br><span class="line">  ProxyCommand /mingw64/bin/connect.exe -H 127.0.0.1:1080 %h %p</span><br><span class="line"></span><br><span class="line">Host yuzhouwan.gitlab.com</span><br><span class="line">  User git</span><br><span class="line">  Port 22</span><br><span class="line">  Hostname yuzhouwan.gitlab.com</span><br><span class="line">  IdentityFile ~/.ssh/id_rsa</span><br><span class="line">  TCPKeepAlive yes</span><br><span class="line">  IdentitiesOnly yes</span><br></pre></td></tr></tbody></table></figure>
<p>　然后，生成私钥、公钥，并分别拷贝公钥到 <code>github</code> / <code>gitlab</code> / <code>coding</code> 服务器中，具体操作见上文描述</p>
<p>　最后，验证</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ ssh -T git@github.com</span><br><span class="line">  Hi asdf2014! You<span class="string">'ve successfully authenticated, but GitHub does not provide shell access.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ ssh -T git@yuzhouwan.gitlab.com</span></span><br><span class="line"><span class="string">  Welcome to GitLab, BenedictJin!</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ ssh -T git@git.coding.net</span></span><br><span class="line"><span class="string">  Coding 提示: Hello BenedictJin, You'</span>ve connected to Coding.net via SSH. This is a personal key.</span><br><span class="line">  BenedictJin，你好，你已经通过 SSH 协议认证 Coding.net 服务，这是一个个人公钥</span><br></pre></td></tr></tbody></table></figure>
<h2 id="保持从-fork-端更新代码"><a href="#保持从-fork-端更新代码" class="headerlink" title="保持从 fork 端更新代码"></a>保持从 fork 端更新代码</h2><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 申明 fork 端的仓库地址</span></span><br><span class="line">$ git remote add upstream git@gitlab.yuzhouwan.com:asdf2014/yuzhouwan.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># check 是否添加正确</span></span><br><span class="line">$ git remote -v</span><br><span class="line">  origin  git@gitlab.yuzhouwan.com:asdf2018/yuzhouwan.git (fetch)</span><br><span class="line">  origin  git@gitlab.yuzhouwan.com:asdf2018/yuzhouwan.git (push)</span><br><span class="line">  upstream  git@gitlab.yuzhouwan.com:asdf2014/yuzhouwan.git (fetch)</span><br><span class="line">  upstream  git@gitlab.yuzhouwan.com:asdf2014/yuzhouwan.git (push)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新所有的分支</span></span><br><span class="line">$ git fetch upstream</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定更新某一个分支，这里以 master 分支为例</span></span><br><span class="line">$ git fetch upstream master</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 fork 端的 master 分支进行 rebase</span></span><br><span class="line">$ git rebase upstream/master</span><br></pre></td></tr></tbody></table></figure>
<h2 id="代码风格配置"><a href="#代码风格配置" class="headerlink" title="代码风格配置"></a>代码风格配置</h2><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">Intellij Idea</span><br><span class="line"></span><br><span class="line"><span class="comment"># download: http://www.arminalter.com/public/img/attach/checkstyle/eclipse-java-google-style.xml</span></span><br><span class="line">File - Settings - Editor - Code Style - Schema - Manage - Import - Eclipse XML Profile</span><br><span class="line">File - Settings - Plugins - <span class="string">"CheckStyle-IDEA"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># download: http://www.arminalter.com/public/img/attach/checkstyle/google_checks.xml</span></span><br><span class="line">File - Setting - Other Settings - Check Style(+)                        <span class="comment"># 如果这里使用的是 带有变量的 xml 文件，需要正确指定对应的 value 值</span></span><br><span class="line">File - Settings - Editor - Inspections - Checkstyle real-time scan(√)   <span class="comment"># 开启实时 check code style</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 一般的，项目中都会给出 format.xml 文件，如 hadoop(hadoop-format.xml) / druid(druid_intellij_formatting.xml) etc.</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="换行符"><a href="#换行符" class="headerlink" title="换行符"></a>换行符</h2><h3 id="Auto-CRLF"><a href="#Auto-CRLF" class="headerlink" title="Auto CRLF"></a>Auto CRLF</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 提交时转换为 LF，检出时转换为 CRLF</span></span><br><span class="line">$ git config --global core.autocrlf <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提交时转换为 LF，检出时不转换</span></span><br><span class="line">$ git config --global core.autocrlf input</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提交检出均不转换</span></span><br><span class="line">$ git config --global core.autocrlf <span class="literal">false</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="Safe-CRLF"><a href="#Safe-CRLF" class="headerlink" title="Safe CRLF"></a>Safe CRLF</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 拒绝提交包含混合换行符的文件</span></span><br><span class="line">$ git config --global core.safecrlf <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 允许提交包含混合换行符的文件</span></span><br><span class="line">$ git config --global core.safecrlf <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提交包含混合换行符的文件时给出警告</span></span><br><span class="line">$ git config --global core.safecrlf warn</span><br></pre></td></tr></tbody></table></figure>
<h2 id="整合持续集成"><a href="#整合持续集成" class="headerlink" title="整合持续集成"></a>整合持续集成</h2><h3 id="Travis"><a href="#Travis" class="headerlink" title="Travis"></a>Travis</h3><h4 id="travis-yml"><a href="#travis-yml" class="headerlink" title=".travis.yml"></a>.travis.yml</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">language:</span><br><span class="line">  - java</span><br><span class="line">  - scala</span><br><span class="line">  - python</span><br><span class="line">  - groovy</span><br><span class="line"></span><br><span class="line">os:</span><br><span class="line">  - windows</span><br><span class="line"></span><br><span class="line">jdk:</span><br><span class="line">  - oraclejdk8</span><br><span class="line"></span><br><span class="line">scala:</span><br><span class="line">  - 2.11.8</span><br><span class="line"></span><br><span class="line">python:</span><br><span class="line">  - 2.7.12</span><br><span class="line"></span><br><span class="line">groovy:</span><br><span class="line">  - 2.3.11</span><br><span class="line"></span><br><span class="line">before_install: sudo <span class="built_in">echo</span> <span class="string">"MAVEN_OPTS='-Xmx2048m -Xms1024m -Dorg.slf4j.simpleLogger.defaultLogLevel=error'"</span> &gt; ~/.mavenrc</span><br><span class="line"></span><br><span class="line">script:</span><br><span class="line">  - mvn clean install -B &amp;&amp; mvn clean -B</span><br><span class="line"></span><br><span class="line">env:</span><br><span class="line">  global:</span><br><span class="line">    - MAVEN_OPTS: <span class="string">"-Xmx2048m -Xms1024m -Dorg.slf4j.simpleLogger.defaultLogLevel=error"</span></span><br><span class="line"></span><br><span class="line">sudo: required</span><br><span class="line"></span><br><span class="line">cache:</span><br><span class="line">  directories:</span><br><span class="line">    - <span class="variable">$HOME</span>/.m2</span><br></pre></td></tr></tbody></table></figure>
<h4 id="效果图"><a href="#效果图" class="headerlink" title="效果图"></a>效果图</h4><figure class="highlight markdown"><table><tbody><tr><td class="code"><pre><span class="line">[<span class="string">![Build Status</span>](<span class="link">https://travis-ci.org/asdf2014/yuzhouwan.svg?branch=master</span>)](<span class="link">https://travis-ci.org/asdf2014/yuzhouwan</span>)</span><br></pre></td></tr></tbody></table></figure>
<p><a href="https://travis-ci.org/asdf2014/yuzhouwan"><img data-src="https://travis-ci.org/asdf2014/yuzhouwan.svg?branch=master" alt="Build Status"></a></p>
<p>Tips: Full code is <a href="https://github.com/asdf2014/yuzhouwan/blob/master/.travis.yml">here</a>.</p>
<h2 id="设置编辑器"><a href="#设置编辑器" class="headerlink" title="设置编辑器"></a>设置编辑器</h2><h3 id="在-Mac-下设置-sublime-作为编辑器"><a href="#在-Mac-下设置-sublime-作为编辑器" class="headerlink" title="在 Mac 下设置 sublime 作为编辑器"></a>在 Mac 下设置 sublime 作为编辑器</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 修改 git 配置文件</span></span><br><span class="line">$ vim ~/.gitconfig</span><br><span class="line">  [core]</span><br><span class="line">    editor = /Applications/Sublime\\ Text.app/Contents/SharedSupport/bin/subl -n -w</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者通过命令行配置</span></span><br><span class="line">$ git config --global core.editor <span class="string">"/Applications/Sublime\ Text.app/Contents/SharedSupport/bin/subl -n -w"</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="GitHub-CLI"><a href="#GitHub-CLI" class="headerlink" title="GitHub CLI"></a><a href="https://github.blog/2020-09-17-github-cli-1-0-is-now-available/">GitHub CLI</a></h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ brew install gh</span><br><span class="line">$ gh version</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">gh version 1.1.0 (2020-10-06)</span><br><span class="line">https://github.com/cli/cli/releases/latest</span><br></pre></td></tr></tbody></table></figure>
<h3 id="首次获取-issue-列表时需要进行赋权"><a href="#首次获取-issue-列表时需要进行赋权" class="headerlink" title="首次获取 issue 列表时需要进行赋权"></a>首次获取 issue 列表时需要进行赋权</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gh issue list</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">Notice: authentication required</span><br><span class="line">Press Enter to open github.com <span class="keyword">in</span> your browser...</span><br><span class="line">Authentication complete. Press Enter to <span class="built_in">continue</span>...</span><br></pre></td></tr></tbody></table></figure>
<h3 id="这里以-Apache-Druid-为例"><a href="#这里以-Apache-Druid-为例" class="headerlink" title="这里以 Apache Druid 为例"></a>这里以 <a href="https://yuzhouwan.com/posts/5845/">Apache Druid</a> 为例</h3><h4 id="获取-issue-列表"><a href="#获取-issue-列表" class="headerlink" title="获取 issue 列表"></a>获取 issue 列表</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gh issue list</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"></span><br><span class="line">Showing 30 of 925 open issues <span class="keyword">in</span> apache/druid</span><br><span class="line"></span><br><span class="line"><span class="comment">#10525  Incorrect results (including nulls) when querying string column with ...  (Uncategorized problem report)     about 1 hour ago</span></span><br><span class="line"><span class="comment">#10523  Historical server fails to load segments in kubernetes                    (Helm Chart)                       about 1 hour ago</span></span><br><span class="line"><span class="comment">#10522  Ingesting to same Datasource from 2 different Kafka clusters with exa...  (Uncategorized problem report)     about 9 hours ago</span></span><br><span class="line"><span class="comment">#10521  Druid Lookups Auditing                                                                                       about 10 hours ago</span></span><br><span class="line"><span class="comment">#10520  Druid UI Load Data -&gt; Edit Spec text area redundant reinsert              (Area - Web Console, Ease of Use)  about 23 hours ago</span></span><br><span class="line"><span class="comment">#10519  When I use topN query, the results are very different.                    (Uncategorized problem report)     about 1 day ago</span></span><br><span class="line"><span class="comment">#10516  Bad/outdated documentation on "S3 permissions settings"                                                      about 5 days ago</span></span><br><span class="line"><span class="comment">#10513  Averaging timestampdiff output yields MAX_INT                             (Uncategorized problem report)     about 5 days ago</span></span><br><span class="line"><span class="comment">#10512  A java.lang.ClassCastException Error in druid cluster 0.13.0              (Uncategorized problem report)     about 5 days ago</span></span><br><span class="line"><span class="comment">#10509  build from source with 0.19.0 failed                                      (Uncategorized problem report)     about 7 days ago</span></span><br><span class="line"><span class="comment">#10508  Kill task launched from web console is stuck                              (Uncategorized problem report)     about 8 days ago</span></span><br><span class="line"><span class="comment">#10501  Druid 0.18.1 DSQL                                                                                            about 11 days ago</span></span><br><span class="line"><span class="comment">#10498  Tasks fail without and there are no error logs for it                     (Uncategorized problem report)     about 9 days ago</span></span><br><span class="line"><span class="comment">#10497  [BUG] [Indexing Task 0.16.0] Update metadata failed after indexing ta...  (Uncategorized problem report)     about 7 days ago</span></span><br><span class="line"><span class="comment">#10494  Remove redundant `IncrementalIndex.Builder`                               (Design Review, Proposal)          about 12 days ago</span></span><br><span class="line"><span class="comment">#10493  Avro Union type support                                                   (Feature/Change Description)       about 12 days ago</span></span><br><span class="line"><span class="comment">#10477  When we choose to delete all the data of the specified datasource, de...  (Feature/Change Description)       about 15 days ago</span></span><br><span class="line"><span class="comment">#10468  Posible druid template for Openshift/Kubernetes                           (Design Review, Proposal)          about 18 days ago</span></span><br><span class="line"><span class="comment">#10462  [DRAFT] 0.20.0 Release Notes                                              (Release Notes)                    about 5 days ago</span></span><br><span class="line"><span class="comment">#10455  User Impersonation in Druid                                               (Feature/Change Description)       about 21 days ago</span></span><br><span class="line"><span class="comment">#10444  Better handling of different servers having different versions of bro...  (Area - Querying, Bug)             about 7 days ago</span></span><br><span class="line"><span class="comment">#10443  Druid middleManager jvm's InterpreterRuntime::throw_ClassCastException    (Uncategorized problem report)     about 23 days ago</span></span><br><span class="line"><span class="comment">#10442  Why druid expects data files to be available on all data servers                                             about 21 days ago</span></span><br><span class="line"><span class="comment">#10439  Druid Auth doesn't limit the permission                                                                      about 24 days ago</span></span><br><span class="line"><span class="comment">#10434  Show Unused segment count in Druid Console Summary page                   (Feature/Change Description)       about 26 days ago</span></span><br><span class="line"><span class="comment">#10423  Post metadata operation information to ingestion log for a Kill task      (Feature/Change Description)       about 27 days ago</span></span><br><span class="line"><span class="comment">#10415  Druid is on yarn ?                                                                                           about 29 days ago</span></span><br><span class="line"><span class="comment">#10411  StatsD emmiter just emit native queries count in druid/query/count me...  (Uncategorized problem report)     about 23 days ago</span></span><br><span class="line"><span class="comment">#10409  Documentation for SQL ARRAY to use [] instead of ()                                                          about 1 month ago</span></span><br><span class="line"><span class="comment">#10403  Kafka ingestion sometimes produces rows that aren't aggregated            (Uncategorized problem report)     about 1 month ago</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="获取-PR-列表"><a href="#获取-PR-列表" class="headerlink" title="获取 PR 列表"></a>获取 PR 列表</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gh pr list</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"></span><br><span class="line">Showing 30 of 71 open pull requests <span class="keyword">in</span> apache/druid</span><br><span class="line"></span><br><span class="line"><span class="comment">#10524  Kafka dynamic scale ingest tasks                                                           zhangyue19921010:kafka-dynamic-scale-ingest-tasks</span></span><br><span class="line"><span class="comment">#10518  Add grouping_id function                                                                   abhishekagarwal87:grouping_id</span></span><br><span class="line"><span class="comment">#10517  Fix compaction integration test CI timeout                                                 maytasm:IMPLY-4796</span></span><br><span class="line"><span class="comment">#10505  WIP: Avro union support                                                                    josephglanville:jpg/avro-union-support</span></span><br><span class="line"><span class="comment">#10502  0.20.0                                                                                     0.20.0</span></span><br><span class="line"><span class="comment">#10499  support for vectorizing expressions with non-existent inputs, more consistent type han...  clintropolis:vector-nil-expr</span></span><br><span class="line"><span class="comment">#10495  Added Request log updates for status change on cooridnator / overlord…                    senthilkv:requestlog</span></span><br><span class="line"><span class="comment">#10484  improve retention rule management with import rules                                        kroeders:ft-import-retention-rules</span></span><br><span class="line"><span class="comment">#10478  Refactor AppenderatorConfig to inherit from TuningConfig                                   liran-funaro:pr-tuning-config</span></span><br><span class="line"><span class="comment">#10467  Fix bug in TimedShutoffInputSourceReader where a timeout does not close all registered...  maytasm:REQ-1314</span></span><br><span class="line"><span class="comment">#10464  Improved exception handling in case of query timeouts                                      a2l007:timeout_status</span></span><br><span class="line"><span class="comment">#10458  Fix the config initialization on container restart                                         valdemar-giosg:feature-fix-docker-entrypoint-config-overwrite</span></span><br><span class="line"><span class="comment">#10448  Added CronScheduler support as a proof to clock drift while emitting metrics               miqdigital:cronScheduling</span></span><br><span class="line"><span class="comment">#10428  allow server selection to be aware of query                                                kroeders:ft-query-aware-selectors</span></span><br><span class="line"><span class="comment">#10427  ServerSelectorStrategy to filter servers with missing required lookups                     kroeders:ft-lookup-aware-server-selector-ext</span></span><br><span class="line"><span class="comment">#10421  Improve lookup state update to avoid query failures                                        yuanlihan:improve-lookup-state-update</span></span><br><span class="line"><span class="comment">#10420  Add ingestion merge count metric                                                           jon-wei:merge_metric</span></span><br><span class="line"><span class="comment">#10418  Support to show leader of coordinators in `Services` web console view                      FrankChen021:show_leader</span></span><br><span class="line"><span class="comment">#10414  Applying modification pattern in #10025 to DataSegmentPusher#getDefaultStorageDirWithE...  T45K:related_to_10025</span></span><br><span class="line"><span class="comment">#10412  prometheus metric exporter                                                                 adobe:feature/prometheus-metric-exporter</span></span><br><span class="line"><span class="comment">#10408  Web console: single instance of axios for all network requests                             AshishKapoor:axios-single-instance</span></span><br><span class="line"><span class="comment">#10407  emit processed bytes metric                                                                pjain1:processed_bytes</span></span><br><span class="line"><span class="comment">#10400  optimize_getPendingSegmentsForIntervalWithHandle                                           xiangqiao123:optimize_getPendingSegmentsForIntervalWithHandle</span></span><br><span class="line"><span class="comment">#10396  Update index.md                                                                            tlblessing:patch-1</span></span><br><span class="line"><span class="comment">#10383  Fix ingestion failure of pretty-formatted JSON message                                     FrankChen021:json_parse_bug</span></span><br><span class="line"><span class="comment">#10376  Live reporting system for parallel task                                                    jihoonson:live-metrics-system</span></span><br><span class="line"><span class="comment">#10365  Inject ObjectMapper instead of manually setting it for TaskReportFileWriter                jihoonson:inject-mapper-report-writer</span></span><br><span class="line"><span class="comment">#10363  fix injection failure of StorageLocationSelectorStrategy objects                           FrankChen021:bug_10348</span></span><br><span class="line"><span class="comment">#10339  Security overview documentation                                                            sthetland:security-doc-revamp</span></span><br><span class="line"><span class="comment">#10335  Configurable Index Type                                                                    liran-funaro:config-index</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="切换到某一个-PR-中"><a href="#切换到某一个-PR-中" class="headerlink" title="切换到某一个 PR 中"></a>切换到某一个 PR 中</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gh pr checkout 10524</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">remote: Enumerating objects: 44, <span class="keyword">done</span>.</span><br><span class="line">remote: Counting objects: 100% (44/44), <span class="keyword">done</span>.</span><br><span class="line">remote: Total 110 (delta 44), reused 44 (delta 44), pack-reused 66</span><br><span class="line">Receiving objects: 100% (110/110), 43.63 KiB | 269.00 KiB/s, <span class="keyword">done</span>.</span><br><span class="line">Resolving deltas: 100% (45/45), completed with 27 <span class="built_in">local</span> objects.</span><br><span class="line">From https://github.com/apache/druid</span><br><span class="line"> * [new ref]               refs/pull/10524/head -&gt; kafka-dynamic-scale-ingest-tasks</span><br><span class="line">Switched to branch <span class="string">'kafka-dynamic-scale-ingest-tasks'</span></span><br></pre></td></tr></tbody></table></figure>
<div class="note success">使用该命令后，会自动下载并切换到 PR 所对应的 branch 中</div>

<h4 id="查看-PR-的-diff-内容"><a href="#查看-PR-的-diff-内容" class="headerlink" title="查看 PR 的 diff 内容"></a>查看 PR 的 diff 内容</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gh pr diff</span><br></pre></td></tr></tbody></table></figure>
<h4 id="合并-PR"><a href="#合并-PR" class="headerlink" title="合并 PR"></a>合并 PR</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gh pr merge</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">? What merge method would you like to use?  [Use arrows to move, <span class="built_in">type</span> to filter]</span><br><span class="line">&gt; Create a merge commit</span><br><span class="line">  Rebase and merge</span><br><span class="line">  Squash and merge</span><br></pre></td></tr></tbody></table></figure>
<h2 id="英文缩写"><a href="#英文缩写" class="headerlink" title="英文缩写"></a>英文缩写</h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">缩写</th>
<th style="text-align:center">全拼</th>
<th style="text-align:center">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><strong>ACK</strong></td>
<td style="text-align:center"><strong>A</strong>cknowledgement</td>
<td style="text-align:center">同意（改变 / 概念）</td>
</tr>
<tr>
<td style="text-align:center"><strong>AFAICT</strong></td>
<td style="text-align:center"><strong>A</strong>s <strong>F</strong>ar <strong>A</strong>s <strong>I</strong> <strong>C</strong>an <strong>T</strong>ell</td>
<td style="text-align:center">据我所知</td>
</tr>
<tr>
<td style="text-align:center"><strong>AFAIK</strong></td>
<td style="text-align:center"><strong>A</strong>s <strong>F</strong>ar <strong>A</strong>s <strong>I</strong> <strong>K</strong>now</td>
<td style="text-align:center">据我所知</td>
</tr>
<tr>
<td style="text-align:center"><strong>AKA</strong></td>
<td style="text-align:center"><strong>A</strong>lso <strong>K</strong>nown <strong>A</strong>s</td>
<td style="text-align:center">也称作</td>
</tr>
<tr>
<td style="text-align:center"><strong>ASAP</strong></td>
<td style="text-align:center"><strong>A</strong>s <strong>S</strong>oon <strong>A</strong>s <strong>P</strong>ossible</td>
<td style="text-align:center">尽快</td>
</tr>
<tr>
<td style="text-align:center"><strong>BTW</strong></td>
<td style="text-align:center"><strong>B</strong>y <strong>T</strong>he <strong>W</strong>ay</td>
<td style="text-align:center">顺便一提</td>
</tr>
<tr>
<td style="text-align:center"><strong>CC</strong></td>
<td style="text-align:center"><strong>C</strong>arbon <strong>C</strong>opy</td>
<td style="text-align:center">抄送</td>
</tr>
<tr>
<td style="text-align:center"><strong>FWIW</strong></td>
<td style="text-align:center"><strong>F</strong>or <strong>W</strong>hat <strong>I</strong>t´s <strong>W</strong>orth</td>
<td style="text-align:center">无论如何</td>
</tr>
<tr>
<td style="text-align:center"><strong>FWIAW</strong></td>
<td style="text-align:center"><strong>F</strong>or <strong>W</strong>hat <strong>I</strong>t´s <strong>A</strong>ll <strong>W</strong>orth</td>
<td style="text-align:center">不管有没有用（FWIW 含义一样，且 FWIW 更常用一些）</td>
</tr>
<tr>
<td style="text-align:center"><strong>FYI</strong></td>
<td style="text-align:center"><strong>F</strong>or<strong>Y</strong>our <strong>I</strong>nformation</td>
<td style="text-align:center">供你参考</td>
</tr>
<tr>
<td style="text-align:center"><strong>IANAL</strong></td>
<td style="text-align:center"><strong>I</strong> <strong>A</strong>m <strong>N</strong>ot <strong>A</strong> <strong>L</strong>awyer</td>
<td style="text-align:center">我不是律师（但是我发现了一个问题）</td>
</tr>
<tr>
<td style="text-align:center"><strong>IIRC</strong></td>
<td style="text-align:center"><strong>I</strong>f <strong>I</strong> <strong>R</strong>ecall <strong>C</strong>orrectly</td>
<td style="text-align:center">如果我没有记错的话</td>
</tr>
<tr>
<td style="text-align:center"><strong>IMHO</strong></td>
<td style="text-align:center"><strong>I</strong>n <strong>M</strong>y <strong>H</strong>umble <strong>O</strong>pinion</td>
<td style="text-align:center">以我浅见</td>
</tr>
<tr>
<td style="text-align:center"><strong>IMO</strong></td>
<td style="text-align:center"><strong>I</strong>n <strong>M</strong>y <strong>O</strong>pinion</td>
<td style="text-align:center">我的想法是</td>
</tr>
<tr>
<td style="text-align:center"><strong>LGTM</strong></td>
<td style="text-align:center"><strong>L</strong>ooks <strong>G</strong>ood <strong>t</strong>o <strong>M</strong>e</td>
<td style="text-align:center">在我看来很好</td>
</tr>
<tr>
<td style="text-align:center"><strong>NACK</strong> / <strong>NAK</strong></td>
<td style="text-align:center"><strong>N</strong>egative <strong>A</strong>cknowledgement</td>
<td style="text-align:center">不同意（改变 / 概念）</td>
</tr>
<tr>
<td style="text-align:center"><strong>OTOH</strong></td>
<td style="text-align:center"><strong>O</strong>n <strong>T</strong>he <strong>O</strong>ther <strong>H</strong>and</td>
<td style="text-align:center">另一方面</td>
</tr>
<tr>
<td style="text-align:center"><strong>PTAL</strong></td>
<td style="text-align:center"><strong>P</strong>lease <strong>T</strong>ake <strong>a</strong> <strong>L</strong>ook</td>
<td style="text-align:center">请看一下</td>
</tr>
<tr>
<td style="text-align:center"><strong>RC</strong></td>
<td style="text-align:center"><strong>R</strong>elease <strong>C</strong>andidate</td>
<td style="text-align:center">正式发布前的候选版本</td>
</tr>
<tr>
<td style="text-align:center"><strong>RFC</strong></td>
<td style="text-align:center"><strong>R</strong>equest <strong>F</strong>or <strong>C</strong>omments</td>
<td style="text-align:center">征求意见</td>
</tr>
<tr>
<td style="text-align:center"><strong>SGTM</strong></td>
<td style="text-align:center"><strong>S</strong>ounds <strong>G</strong>ood <strong>t</strong>o <strong>M</strong>e</td>
<td style="text-align:center">听起来不错</td>
</tr>
<tr>
<td style="text-align:center"><strong>TBD</strong></td>
<td style="text-align:center"><strong>T</strong>o <strong>B</strong>e <strong>D</strong>one</td>
<td style="text-align:center">尚未完成</td>
</tr>
<tr>
<td style="text-align:center"><strong>TBH</strong></td>
<td style="text-align:center"><strong>T</strong>o <strong>B</strong>e <strong>H</strong>onest</td>
<td style="text-align:center">老实说</td>
</tr>
<tr>
<td style="text-align:center"><strong>TBR</strong></td>
<td style="text-align:center"><strong>T</strong>o <strong>B</strong>e <strong>R</strong>eviewed</td>
<td style="text-align:center">准备被审查</td>
</tr>
<tr>
<td style="text-align:center"><strong>TL;DR</strong></td>
<td style="text-align:center"><strong>T</strong>oo <strong>L</strong>ong; <strong>D</strong>idn’t <strong>R</strong>ead</td>
<td style="text-align:center">太长懒得看</td>
</tr>
<tr>
<td style="text-align:center"><strong>WDYT</strong></td>
<td style="text-align:center"><strong>W</strong>hat <strong>D</strong>o <strong>Y</strong>ou <strong>T</strong>hink?</td>
<td style="text-align:center">你怎么看？</td>
</tr>
<tr>
<td style="text-align:center"><strong>WIP</strong></td>
<td style="text-align:center"><strong>W</strong>ork <strong>i</strong>n <strong>P</strong>rocessing</td>
<td style="text-align:center">进行中</td>
</tr>
<tr>
<td style="text-align:center"><strong>WTF</strong></td>
<td style="text-align:center"><strong>W</strong>hy <strong>T</strong>he <strong>F</strong>ace</td>
<td style="text-align:center">你懂的</td>
</tr>
</tbody>
</table>
</div>
<h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><h3 id="Doc"><a href="#Doc" class="headerlink" title="Doc"></a>Doc</h3><ul>
<li><a href="https://github.com/logos">GitHub Logos and Usage</a></li>
</ul>
<h3 id="Emoji"><a href="#Emoji" class="headerlink" title="Emoji"></a>Emoji</h3><ul>
<li><a href="https://gist.github.com/AliMD/3344523">All github Emoji (Smiles)</a></li>
<li><a href="https://gist.github.com/rxaviers/7360908">Complete list of github markdown emoji markup</a></li>
</ul>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt=""></a></td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>Git</tag>
        <tag>Github</tag>
        <tag>CI</tag>
      </tags>
  </entry>
  <entry>
    <title>Kubernetes 实战</title>
    <url>/posts/200919/</url>
    <content><![CDATA[<div id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">
  <div class="hbe-input-container">
  <input type="password" id="hbePass" placeholder="" />
    <label for="hbePass">Hey, password is required here.</label>
    <div class="bottom-line"></div>
  </div>
  <script id="hbeData" type="hbeData" data-hmacdigest="255be37cd2dc572b718277a4246f8acb4ef69a74aa4c77f18ea55bb59ca7c44c">4bd31e7e35dc4f3f0682caaeb14be19da149cfa31dbd15ca17d0008f21b10d924df9ab43826b4598b0fb142b5a958b1ab32ad02429e66857b956d1ed0fd5561046a769ead9feffb23ce1f1898881c9023fc3dcab78adc8b56317c55b9b37f32bb591fbf818fe112069b9c30a31c9b6ea1232f64a8c563aa6410f6e1aad995a6ca84b18b59169e35ca649761ba25acce2768fd5bb35c929aa6503bc99852320bd045ddddf2010b204b745dbc60062af4b17d98a121de3a854009dc15aa6df14f14c22d0a93b48bcb8fe16d6b63782da6d9c20dab92b74d8cdb3d5642efcdb0fb6204bced75fa543081d2f66f12dfff31ddd989fd24229527833ca9071176f7d6d8328b507589144b5335b45c0299f7d79790f16db4fcf06c11a60ad67ed9a11d5258def933604f96f0a7eb01694dc32ed23fe3e92877632baf129689a3c0b790bb6e4f0398e8da3190f92e9671612701f064eb34d47babab23fcab616656353ccf52d56b47a40ce2c825edce8418e514c423bc9172ab6cf04d2b328dc376e0fceaaef9123d61a8658eb4eaedd2af3725cce9baa3f703719873c3f23a525be55d0d03d87eed2c1008561222105d5da1e614102678d36681494966c1039a45472720e07a5b7294e6881147a6f6b1aa56073dfda537a52c309ff933d25ccd1e7442e34c1c471fd44b54fe5eff75d034d5d515f631a75aad2cc2b83f7cb835b89b30d0fa92c646e7dadc2248f81bec5da6272c0c9b81836146a2607f33f357030296a17a12b6e12d86c3fd79503e983663934cf87ccb53e87233e184b68a53808c0b8516e676c1ff75772ec96c4c056f9d53ab240e6edaf9dbeeb7a65a2c665ffa12cd1e479993834748a7accebeda8f162ced3453a0b26770f08b8d4a35f0f435e5af0d57e46a11e7ff95f5d9a91be2c8ce40d9c66ec86103896e83771723408045d3a69082345a422ab3d710d25c50bec4b3026f8bb96d13e0e2a4729863603b427c71c4ad21435f4cbac8731dcce22bbb74d206d99446d037c86d7ab183c031e0ae31545f11b0f16dd44a030c49bcdbf19d3827fd1293560b7cd1da8dc279a4b93299e07224ffa49085d356b47d99046510fa8d23a7aac051f2fd29e465b926fb793bed65b8eafb9f79c03b2757c20ad54cf647ee6341ab7f27eaf0c3caf784cf6bcf11b92d3db9dda3b313537cb7ce23bec6927e4a61a15b52503a614349a10bcff23a6b8dee51739cbe01b65faeecd594a84cc4b6dc160c6c6f131293a8f0ecb371dff98c0936c88817eff705ceef0081c18c67e886a4c97dd0d68a4b479283dbd8c1e0b611b3aeb88c81ae2bf49af3f6c846457ad7e06de5feedf3e7ff6c254d00fd9ad49867c9b5e59eb879f4bbb9139bcc4b7143acdeae4288c11017eb28e0c879f133f234c2d90bd2c102314f48adca7c4691a82c42c9e0caf179b52171089eeba0bf8cd8a8f1b4c725cd928c96d6448be2fd4ff35ae4a32e778aee1710cb1cb2e9dff54906e165bc66821a29c7d34eddcf2c54dd4dabee75e919f905344dfd52c452f8f593f269b18258e3761f990ed8bf8fcc33d0c9e6d7531c52e9e5cc53f6cbf449d5ebc03707f96bd4aa1ff527293012956ab2f665c60abd6c18de90a0982eb82230a720d305e3d6ef6b0094c8896e2bf4ba26ada19a852bbbc8bd38eab2c93fc32302eace00e83958f14202a9d4318bd785cc0eb1508328e64f4ee28b7f96bd0f3ee6e9ac81fe1089e437c3cb2b33b7c092419b984ea8b632f19f67b3ee7c58838e2588bb4088e760e5a7423af1d6c72c19a912034df9c37d2e546b11ed4dbebb7257c1670c5ad26a9669ea4abb6868af3eba81dd5fb7f2a3d869803182b27e41499a6abe3fe34dcfce99c090bc11fc4bedd7aeee9391a12a7d96bab671a7f464835c3483ddd43ef3d0c05859df0478306f45d71a105bdb91e47767e83655c47b1689b3f503f6ea8fe26b7a20d1d6e45b23353466ac47c246cdbffe7e6f76ef333d53f4013ae36f66bf1ffabe835ecd258e7a370cab64fb06d948eef0e6680a78ea281723b38dbcd248bcce5f407019015b5f11df20058208c7c0dd3d1e351643b91d1f255526ed181d19ffcd20625ccabe57d5c79fe2cbdfc6aa4dc233e8fce2798f54f1cf3028f52d15a2eb2953042aed96160b76e89bbce84c1dd193475cb339b9c2d37bc9a4c6f26829589bc3c66c4d1295ed49526a472bb5e5253a0574e9590853c9bd6e0c58fd449d20ef1cf1c2e6e9e85a55eb637291ccdbadc785403bf3cee45dc3129784cc0d2d6d7444600e13586a0f92c3ac158a186c410017d7dca75e2977a6d0994ae6b5baced27a9838d29190a02e0c91a933940644ac534bda91d9be66163789a2f8b51014c4e5de06bd381458ee426869bb18f2d32cbafd9fc630ef8cf6ea9494a961b9a18be359d1978a8f94133becd5b818ff8810ade0949b2e3022883a3413219c3c1de3d90ba464716ac1236a33065579b5a5f3fe6170c3eed7eabbf79566a57b036ae40f5a22e026f7593d5843c8e98399f859b6b831219fb2bf11101eb7623ff6979d0eed2f9d4c4b6a7d51137544f80887ff774a8b9fb9a61679b866ffc3f76f71a96d109b84ba40479047768b150588be0d0778a1e9fa8f8b4c7f393d95ad9cefc0237f5450b2ffb908a121c8a21e64d3d62ec6f3978f948475796facf62acb51d98e74f355f8aad7700d7af6467db3158bcfda9cdb2a31a8fdec0005cc6007fc37f164131a48494b13bc02a1f23a694be71fff5a715aa7b10787cbd90ce25111ea789b6d24ec796404a797456039123cc86b0318dfbef635b029c5e48824574462758b5ca23dff424c943bf7c82e3e212eb9d1603a6e9d8974a4b911e900158095b832b7f9c42d9d5e484920aa37720113f2584cbbd8e5efce9faa8c9dd9a720c15d04c6ed9ced0c7fdf43dfff700743224a353f2be4af18db1e0e5c41b75500cd46e7ed707f74599d309dda723edc2dbbcbb6c627a90767295e65c418daee132330703673f474b1cfd333ba8d6628d9b44e6d8962b5962fb746ea42e42bca8f1bb19e76540548bd2b77d7803f4a39c711a480d7cf32b3a4169a6a902afcdb8ef203bfb5c10f1141974a6e4a18440f86924a6f0e969427e10e5439196980f230179d71507d73d79f3e8b4346159056f8cd3f33e84b2435ef7f412db4b1945ddff551e8b74eb3937fb26b2c1a20cb56b7aacae60b5a34487cbe31ead404deccc1f95bfbf5a61f4dbd04772d38caa321460a007fed7f936363c5a89bd81c574b1fb1495ab1064f98a09bf37b038fdf99df3ea5397ed581ba6587d79217585590e08a10941c6e95907e9604af2886606475ed1cb9adfba7a6032c84d34c2d4eb663961fb8c4ec139bdea49a07daf259aa7c4038f9db6636273c14a52909fdaf74658a38b83e3d5738e69c957aeb676e7a5d20d7c75dac7cda6505d1b9d55c2688a29eb9f5147a4a6781f7ff9b14281f8eaf343070ef6129e3346f88e4642ea29d00600e4be525a9cf926d8954d917b806f6cb16ada4b50f8dbc14def773163b59610ce3b86dec310f429e072049f414f697eb06ceb2dcbc7281a2372d00185d42aa8b0c4b9d59e56e927010af687f9492d83b832eea7a76c0c170370c2bfd50b77bf95aea1028a4199e7cbb7c4cad0f8a3d13bd1fb38ca9fa447f67bbe098366eb429e6f736b138a39fd7e14c0c213b46a44720e9e8e39202a6eeed84317d520fb86784efca708eb412b251ca877667e546fdc9306d664677662479e4ac03b9ad5151ff64253b92bf77ab39c4968c882d3830268ab5cfb8f9a29727406ebb5a9c5f2feae9edc0ce7f28f50059a885dc8634fb4592933bdedf5013950c555dc4da9b459009513cc72d9388992beb783d3e63f2f78a2bfab5f8c601a4ace367386649ed291664d73a25cc584a74707bfac697759845bc89c7929eb39634830574aaafe005d3f571f8e11b982ae2a97b59dc38c1729493cba87f2295cc0b8dbd265c0afc9d84b69dcb8a4993574da9c63dfd33678736197877607ee25055f723ca916bc92ea5059735b1d2b63a105259ec3613bc1e8e1bcf790da372748b9bf9cbc1a40a815a3767c6d9a201978722221d706c01673a38fe064b541b2bd4f2c3d71b7b6c2dd8b2a3e2740deb0b1003747d18a9c55b84a46cab86c81723ced1be532df5392ff3dac257bb5872d33592f71aadf314f0a444ebb87bef8be968f9242449ad8d9e38aa6e509369ebbe8e3d4d1f2d40fc09404bd7bd0b686ff01ba560c8f3ebb981e7fc834052344bed9833c203d015e4ca0601295bb45997e61a0e04e26c44354db97445285551bd56c984acb905b66e9be9c27ada626719cddfb84c235b55fb83ae15368f55d3b75b29e4139d765ee83ed01243008303bb7302c2b07c93512d20dcd8518c93b576ed8dce7880840cb7e33006ab7dc74de7d0efee7d0777d40cbf9c0f1143592fa418e1c05020556690dbacaf88b173914be8e397091cb73e2ed5a5cc41a15b9f4a15a59d169b8409490abc6862f1370f5b472153aee2f9738e52b865393fd9afa055e7107701d54e758225fbe5714727841e173a949a12a45d56626f5da5f3e79d38201faff070680d97689c3d9b0817b31b4ac1441d35df096def436cd014b82ff6b2ac4c89fd875e480b763fa77aa6ba17214e6c917cd5bb1c17bd18be614f7e10800932f63c439174395f8358a9375e98b52604a814895f21edae88279c6e3d3cf7e29f32bb6b6ce7a29923c3db22086124cfea927424d352d5ba87a5f5e28074f9e4149488f5e9731cc68adb6897393a1c5e9fd1fc0bd162ffc906928d5edb42ee0915b28c1e4df1924a080e14aa0d46e5ce6d173e9fdb7e61f07a6e7f669125979f910ced71765606a14503f98521ffffa8ab85d95453264ab628c478d85df3fcccc24bf07f5f00e4f4734cca73713455ce22e6b675264b7a2e09d472ec6ae5c046c93e7448b5a9509c3f0508cf37301aa0f842191eb362ee4609c1c5127beb6a7ac1fb34d4ec16fcd298c60be839344cb39cb51c1ae36c35737280e0dc97bbf3308a7151cc403df4df27bc97e51d993607d0f6ddfd4c671467e5fd61e82e0f5708b58efb93bc11e27093624a97f5f50568127a6edaeb357ac8998648a1c46773d83a7d8b8d3058670f85515a3b94ecf06d8e9fc9b9675ded9562bfd54308d97eb1aa502af336c07bd451a5d92b27336555831e37dde6f92462e0e12a0ded5f29bf2e8c1c76d46631acfc66a25c7ff8c1ee90808ec8e744cbaf6bd225f4c20e8ffda967897f2bafc0d508de5e84b78f79396582a7b0d9d85c1b8cd809364998b828fd0c551688449833ad9b91fe0eb7c596fcae5acf896a2655c99c1cc6e5ef6ad9bb7ba203ce7868ad4e8a220a82b86d293c5cc77ba7128e39fa87437c67d3c3a35d193fc24b9c9223dbf9e71fecf52955e1b1fdb37c827c8f04c765c0b49b4c1bcac9298d634f1a90f6833c964deef42c2e491ab38c496c14fd8cbf2342ab630632c36492df8bb6287e917689fc07e98a16abb3e77f7e8dadf828f2ff2aa76ac6e5bbe1fee564296d68ddb68c58212ed09b57da25ff6d91d18561fc0ed95ff3bf7a53300c3276e42b77a73aa515a6623a29f6cd99f4f9c16ca3ff6a624127d4d214dc53fa5522108df9c415b8a9bc5047cea7e468f12a41dc3468e80d6bd7ea80d71d90d6bbba0ac2358169c4b9343d8c1e37ee9770b7d660daf75a24f75dedd7d2d8dd1d3c32378ab33ea492315ebffc8bee2b5df22dbda22cb4cadd808039b8e063ef4f7dbcab7d1e18082b6fa23d9a2c73785bbb793b17cdffc9160985c5685a3e002d3686e29dccb05d3d97155e8214c87a0d45e85d8db39d5b500e41e832df5e4a260d6629a4b97585b509b8d8dc3a3b3dbf42613d094eab90c326ebf3712f46452a1339effbd5c30b0f1768564ae22cdc2d60b39a94241f710178be9290b91d77aa1f9b3368590448eae87c9919b1784a6e1b69938495b93c67b9e60810b54de5dcd0bcf0397819c874172a70baa8028e5550efa8fc971cca16e8e16e05e6d3c717cc9ef7eaafdbc430be842c84ba2787e8107fe72262d29d431699e729ca184c0e671725f339f43474cced200f0ede5d2b5a4b07e4e0b46a70b085f75713cfe25cf4d56fe0d4a0c85fed72acadf974187479dd8dc0b952f78cea3eae72fdd1b62dfe3aed76092f14a7d83b52743153377ae0334ee19fe4f764998191456b22b9aa4bbbfadfde202ddd06ff3f9f84890e417ebbd20d1ca04b560f3d05a2bc3732b873aeea208ea36911042af8ef2486f1b6f5400c313f5153341b5e4993126977ff6d364a10bb571346705ed39ed9528bb730f91fc91c58a0208441f123741cd1d9958a4df33134b4001ed69f0c203c12885bcd86c31a62b28de8ee44c368dc0ecd58fb1a022232d7a10b75a33dfc42c060cf4c18745a3482fb0cb8eaad9cee8d009e779d6e2c8c7f36f65170b63528bdb906662754f7fa25e2d243d492d3b57d0bd74f3cb6ecf7375955a137380b1fd430e1c189f2409689668294a6b911c4b8f5bb1f5c0d55946afbcfc35a52c2717c0574d2c957c5cf63edb47207de5d9f999ff416a6400b8256afef1e5f7b23ed351a22cefbcffa99bcea5145397ea349688ce7f5cca5b6d8c019304fc2dc96366297d52bff209676ab0c62d16c5dd073ccdb412af61f3e612c2b76f2d219edccf899b6d1eb4d277e026cdece69f6791e6196c0360c160fd1e00eb84c14ac41036da68e86a9febcbba683abf5ed732fc193ad80a1169be7e36ba689f3d1aefe26bdc2dddf49a1e435b98513f2bc3e9965fc16e9f31032a7256c347246b52bef18c3fa8c2eaa5265aeff0b69e1ecf645ce9c650d896fa9f969341126005d7b8291e1ea16819140e3373682175a0bfecd8793bd18244767b0d425396b51597ba96b4f45122e670b128926a05f623bb446a12885922d3028391387e9fce15e5bfbd1a33cedefd402b452294c4ab6f8325f85854266636ea333b34bfe5241f48c50b0cf13aed79be9d334c7d29f69051b2626220e57c3682c2b8d44ebfa516d8ced1db71d21a7d728f1409611f68e699da112b5a34f9532744a385e76f5fbc52af3de2f3fcf8d0257b90147156f913f089f178ffc420321ee0d89f8566c37b550b230541e7f834daa68e07ad4a88841f5791a640bf8865fbb0f2ed91e02cea3ef1a930b20e60fd74e1f96dc2c1f5dedbdce4fbada25681e8b3ae75f9dc41cb3f98fc1340ce674c7d3ef0aee2cc9d0d97662d0a88ab0c3aa6b5eb8f6703bc39624a85be7e9f108b06f4ef3083bcb701064c9c42831287aeaa6ac8aabf7f763c8e7e9e72b6c1784e1cfe3cfeb7a002bd01d224c7ef2cab1729460833f6449730cdc9285f62ef69450b7f1dff18f4284ce69ea20cf7d99cf70054453fa0a84797db13d54fd592c24cfd7906ab11a86c21149c6520affe5e83f6e34db401f2af703fe962f225549443e5b0addac808a721411362b8b414b0c5799860598bd68dceca88269654a3b681b53afc6a4026314f5ed01ccb101e66c0e892a8d6d9fbc1a6807cd5867403c1ea0a8b9005e1347cf28749b07be8aeb41473619df10d4fd88dee03869a73f7fb42ef4fb6051e558b9fda667627d274f7e7594d869eaf2ec03c8c98e493c5987c69b02298d74b714f8298e30685367f557c5a7166b4d64a5c6e7039877451fd2e527ac93850d8290ac89d523de147967b5065241351a7bd4b681028a0b0a710e2cae3bc2de5194989fa465090ec36ff3aa5bd598001d3d6170abbb19ad0dafd31395f40e16a3c5147c514025e45511dc28078e0fdd5cc00f5fa1565c53db79e4a8f7abd2687d91282d1637ed97691ab659073ecde7f8d32fc845ac054c6323ec8e16f4aefbedd38d51d11bb429c9d9d7361f4ae0f72dcf262ee8c1d57653bb22e5489585ed9a5f82be058ead6e6dfa6e794e04e4227057c00bb859fc8316d8dde527a0f0a61ce4a2588b3b8a02e4bd22a60c6639496407f9213753a6f32e0280078fb8ed4853fb523ef8a9dd910a5a45bfd1a404d176571aff944b0eea2f20332bc4af398400e334ab5fa130669fc6ad047376e362de9e67564064e48c691ae33a82d4a1510d6ce9020c7a91b760db8c622f2eb24bee945a70af2b6af4b93ca44447aa4b1b5470448b67a71b994fade88b3dceba11a3df290955476964b5b297b7abf88508cd84bfaa93756c6bdbf469e78ae2fa571ffa399cec5c6c4b4abbee9282b40abd6ced4ffea751c18253bdc021ee1482ebe3576d42b58299866702a596ad0e31cd2055f244a80d6efaa0a06323cadad54743cf5507e9919d44a29917aa2e1929fd30bfbe7e4f2c638114fc1eb7c790a07f218934401ceeca66f96025fb15d65a021d75166672add92127729e675a2422a55354ac5754393dfbd0ea53aae4b989c372f46a74d09a72db68c6e0d14631207094311123744dfb19a41a5202cbe98101210727b6a4b81657bda2754cea850f6fbc21e664f7dbd13339aeca6395f557bfabc0dca7b963bc436aadd8a84107bb079f5aa3c3971b3387929203a6191973bb7e99a90bd0a4075475bc4351115a6881e2fe9bbc8008e2bdfe791552bffe8988333ba4e97544e3701c4c85877fcde7c6cc872390bf91ac7a779d395badab682b80742ee22405fb1b29e7eaf3f7d400d891a5610227f10fbcde6e018cdfc206c88d0d6faff4aad6d5b3b16241e6ea7a5fc0955367372647b8f621b6a0ae27726610ff1906b9c155d36a096fc0b3e79d69e68d431494acf1dc7f6aecc5c2a449dcc7439e1fd828c64f944f0f7509c9a44a4ff24de38cbae8773bdaa5437a622c90ea735049e78125960a91d02c64409fba5864320b4777c63e22a2aae38abf56c9ba0eeaad0e339145189fe80b06ca46a1996728764ecf6d88537e41c065b1cd31862a439c7eac0a17847aa9c82b82e19f5eb1a94659c7e5032a6b895ef4e0afe1c00a24d24126031e7239a980ff3cf1f32e447c4e463ebd4342b3ea276acbf0c4bd8bd571cc6af35ef1531d85eba35f7217f24b92b0cb5411a92092a77c4fcef02c54c19e73b17aad2ded0b57534231c71856987fec3bba9b8260a5e2622da8574a7670bb32c3cfc735e7719b2c790ae904859bec4a71a105224f764e8974abe2d1e0edd9f5bfb5eec073769ad3ae28f92800830d4a5288f77d76407908e9fb7237581c2cbba5f7981883162bd424072c32f8e0deeac04c2b2b0d75df3690fb1fe8c029bf9ab1c08c9b8220524bd4b4de6a4ee55362099944cac909948791c75e2470067432b14136f70cc39da5f6376ff7a0fd9178bbbbd1543f33213155c94d3217d1b5d97f3f4c7086d8a4dc47427104ef6017d4b64c1e3dc6f8ad563fab1657b2b6e870be49f8eb8d2682285665ff9fe885d5912e6d07fcffef1aa1323de3b564925139b5a9ce7afe73dada68bb00df8cd32118ac2213ca67a501ba367182fe6b272180e1ddbb71a35617abfd476f1af7e616e699607284dcea1605e4e0c7a081fe0495bad2dc7c531e04a6c10563098619fde752f735b8a7298ca10496af0d637e6018475bdec14ebd825b4cb54882911d1ec9459949ecdcaf5b43af37497a4f062220dfdfcccbff5a6a34309b397aa1637baab55bf97dbc83409302e77fed7eaed8b1c0a8370ccb9242b8f3744010d3040686b3523c8ef16ebe95e91bcd0c7765357fa3e5f3be0c565d2dcb509ab31b7070840cf4d1c744449bf7fb28dd0e96cf0b67bd0b0582512ad2ecc6a68fab7e096f39edc4144bd8262d376e7f2928aa43a6b799a24606df9128430b20a1bb57f3a7225467fb69335cc8c3c06471489c940e1d58b74a472ef4f46f982abeabf4a9907dab457b0338ba70e76557f898adb7a5a726ed02427642b3c99136674d27abcb77b0eaeea8b94dc35258b61eecbf1d7de93bc1b1350d768b90b8e62635b5d19c890888df732878392aa9d1807fbfe266d1fa0253df0f7743b31318dcb1311e88f2a8e844c8658f39fc37ec6e56a167658e11a48e7f3578ac87774e1e4c6ac387d3fbcf444b6f9fb99760cc271303557917adebf0ab9ddd58ef1734916bda9776407e179f2ac6bcefe4120f72c1272ac4957772b1bc7c88e09567b271d641b6be654b507b5a171ea6ffeed6d18e8c4200d7221b4cda3092bc6262ca014e22e16c9f9f5fbab7479b55c993e43d655b3124fe789c664f622955aa634bc492c7cc6295d2188f53fc0a655c5022e0819c4f5719ddc544dc2b6e1ceeee4a7c3bc19211217fdbbf9fa304f5f38ef16c712b256bd05c200eaca35eacabb33b31da39fbbd2135410cf8f4b8a57a88bbb85b82b598b627a60fdec337228b46848fbafb71d0b9502ee77769326a88e494d4dcfd9354cce220bb38f51d0e4261d6ca10e1c109596fc38ab46a7c4811e238bc11bfd07079696d175be9b0989923e87f04c3d0ea31f65837c8bda16330d7394c47f0acaf42ce2932fa1454bd197713fe8becb1fe2fae6a43857777a04f0e2ee16fd115602027a34f8856163375a6abe99d76d8ec5cb4bbefd50f4f0d538a57d9e93a273c81ee26ca56010d7f313a85d934d89a14ff0b47a4926f98d824779db0005c757f55012b536df3d15bd2247fd89b781c2500f535f09568634bfeee6ca7dc963acae0547949234ca87b1b1bb51537c3c4634fb499a34afaf9527d431cb4fa083bad468caa12ceb276dcec5d2fb2f709f10d7481e8f11b0afbd7a125affbe1a29372f2348c52a372a6da76a4687265eacc173c6fcc08b885294840fb842e4db15daef0fcc30d3f291c6d4bddd8677fa72e79d047b982bb8f914deea940a98c1f9f0da630324883995ac60fc8740407426647bed9e7a278e1952017ebac1df0914045621b3f189788cc157882f760d0463b6aac63e3d9201f0a9d3f9e801875cf665b246cd775c4a2a8d15551f0ab8c38cfa64b69ec5a4380059f083aab6e452de930411e62ebd872e05084fc45a695210d70e54d86ade7868c12adf8285777bb73ce4f323890504f480b2e1d93fef5b4331ea38ae2963e8cc1ae6dd2c2dbe1717460a46df98f3130c108e58f5d74349aee3b56d3c11b567ad9dc83c78e698f065348c5ac50fd76727146b086d6ec95b43448a25eb96c694fa19aba55d85f6b4665ee6ea57264b1329abe8b0c60c670efbea9e3820c094eb772528d2e6abe856ed5fcdec70f970b5399512780000ba86b35b4ad474f63bea03e03d85a5c4766645b7469410b4500a64f50708b0920fcf238c95c425d51fb88f7ad3799bdc43960e84b0da41f5ea83d6ad5ad24aee69efabcb7d5b38b5c3217fa7162c5a15ea2c5333f559cee95d17cc196df688438f0ec5f8280833790bcb8a99c193b1eb84bc535ab9592549729fca73ede6f03d18ff90396b909d20b2c86d6da166c0ec19ead23906b783cced6a9a785c8328bc4d709b3a4c4e3ebb0475229d69864341bc02aff119ca1454e425407bac14dfec961a1373f278dee06326ad4360333d2f4c55949585649b90e07f67ae00093918862bb6caa83b250f04f24f378e8dac5bce3ca37770233ce70a6ecf3d26b5bdf7fd533d2810011271972f0243db0a9d845fccff569f742269045f8760ee7bc1d26825c918fd0ac0b69b6d3a9edd8ebec84314d0d28637582b95a7ecdf5722edacbee9d2bbb63abb57ab596d0dc594b0a0b6abb53d12ba0bf81728d80e967104fb6a3fd915aa4ddfd34c95b5a874d27082413bdc23e894a7b12e3789a69df0cb7b313284ba66fb585d1c4f01e3c7a41f57ec9c840740002c8f23ea7692cc928512f2842cc30ccbb5bbcbed293904c23614fe3b2366d3acb62e1f409cecfcb66e5c73bda8205e9b6437994adf70ea92d235d4a16a470b28e1429db139026420475a5ebab00f3bd76e92ce678c370c70b5a214dd59496954fbcb204a85551ca8bc7b8ad4e13fa74715d90056775171f43b40c3e3aeebd7a596f55ba313df744715ca519b87bd4a8719e99500d231e182953387b188b5b197ea7c68531a3c5dcfdfda5beb76ba528943369ccd5a883a29c65e679c48bc7b31bae110f1637e8bee1249b4164ae89e8394848928cd8856dba24b9649bdf8c4b5cc33514384dd68a7de47e8f12e956352a5891405bc3717618e014336495ce67731e1c46493a8a121554c7645e11ded8a4df5869bdb06f122fca935f775ba3eff04c75aecfb319d6a7b3075e0f68ecd07f910aac1b2b0f7d7a987a579ad9089634ef11733a1bbceb0c494a7c9adedcae29b4a3083ead972dd55860f64f0159e4cfc9993ba830ae1d25a1b171a644f45addf0c50a944fa851dff32f603daa2511ca28db36b53a8b04450d73abf62012659a3c0536ae017b360ae8bf66bb6526d190983b5c5a728318d6ccd1a21ca9bb9a1af0bfb31858ef80d90e45b6d1f0fff2a180275d029918d9724bd47ecc77589e3c0f6ebeb1a8b163fa6ea6a3adff92597bedd7b2438a14fa92dff785c1bf61a7b6dab3f30f21d7cb96110754140c81f8aab65e2dc586e831c4edfed72632a10e7e1a32ef8e01bd07fc0a76adf6f054f8a5b9372606227fa5050d404264c0eac38781006ab16d2b77a5cd126cab1d8eecd7bb85c1295ba4957d7c04e30ab8330308904d6a74e4b4a8526df8f7b8735256c8566677aaf0c496299113bcdcab572454247119692f751e6c80ca67157985dc910419f69573bcb19fc4dea6ef0c457351c2610f3be8af496263e13c1b97c7cb46d8b0b3437d6a2168f250aa819a9bf9c30feaae1ec1b1ad1d46c718e1ac74497176c897e2cc382e6127713c31c3769f17b07c3d08fc2338db8862ec2bd1ab608ec3c07d596b1650489f5d929f1e9734b079a59c792af3bd83faade04ace3a366aa4cbbc0c5e436d6fab6ccd6a343b75611d2d24097b7d89d36a8ba070b98b25c5ede569bcf3c5511b5d333c73365e09c7429e69fe092e44d7a9a07ee527af164d6cd42ef9e18067354e2448acc459037ad9bf89f5c2a7aed7aad393844f1955e925c5ad7e4b382833e477aa15f5bddb40ff483418286fe9ae7d83ecd3fc71a31240f2a866ba143b686d23246d4bb721a9f725b9550a4c69f439d51877b3e1c39fb25ad0fb36dd26acfcf2adddc64a86a0dd6a36a1c76025e6faa8bba58d8b7bcf20e617b9a554361e5e0d1739194448e9f2e0a34ecb8215b19b5d26cd39d6228704660f5a5b4a187392d3e1eb0476f9f24b9bf76d8abfee3ac9a9d592eda7dab243edd47d17cac5470af41ad12ae833c7419d2a2183222239f44f1fcf194a2db29a5aea0747305724cfd8558ae8a50cf4c786e6edd8b4f9bf711b16d0355cf0071dce6cf06969433887e3e819a8d888054598c49a4ac44e8b86235a7443cda8a9648972bded7c2be8b244d8e6ee855fd23f177d9313f092260dd1e3bc6305eb13a0e08b507ed247a9b4418e9efff8583e01f7cbee420da19b321c6ab77e82e1636e5da68e17e60373a6b0ecd443840b483c210da013f9ff32d4c8b13f6261ea087b364e7d6a241b2b3e0e7d7de1660584b9fd74fedf3e6d7444dfcddb67298081af679e24424c867a58536d686a04942f783c517969ecc106a2114cee0d92c68a3041ee82e4810d0dfc7320f65c1d4d78df295ba137dcc92dd599fe1f4b1dfbca24b0f74b7a11191f2b3f33a76c6a5e39354d3fc3df34ec93589728b4b482e337ee1243f48b64a189721d31483396f18e4384e45fda54dbec3aeb0491623bd9ce77b756711e25d0040197f8d7ff53b0401720967f763d592802fd421d7c46899f4c1579c9150807ace80460ffb74a82cd0f0975ceae8390a8c03893e6aa4b1e7e46a8c3abdb99df00f862df78182a3e48050dfa3f0e0f732a13e96cd5ad4ae388ce10cc7e40f30771f2d9941c3fc24554acbd9e69c2c395b0183ebb0362914c12f44058f7023a34a6f51e741f2fecb140d04e383ba1df28a1ab3fcfb709e37baa8f6707901164e626fb207ac5d0fff3f66272ef09995304100df1a8435a43e11a9e92646ceda5f0cf7b825a99c684d9bc43db4677f6e36d6d00f8e3788f81d0e02b21a8f5208063cb15861cc35897def2f5c7854fd809c8db82835e50405ec6505f15f8b65d805419a039fc41c9ad57eeccd089325db744e526b9144a3ae0be0d42e610feb0d42dd06b0723b39fe1ec8d35d59dcea8856ce92e4014a26cf1f4592235a65f0c9f21a8ed1a386de5645ff6acf8cdc37fcb037a5b3e2b024d421e06170a409665ceb1bc7853a4437545d0eb2292a538937729b44e19522916829c5d86a4644ad9dbff89156a5d06e4b929660f8ce36ab45622c22d9094ecd5511d90916901e0964e109f86e6b49b847f506dab3fec9dcd9cf44d1a9f235ab3c08f2f1d2609722c7c52a2ad8604737957c1a54750a4516e0996f173aa14a6951e44d521a86a268e6137d1fa0b8f5de6a2658e9fa8fc7a77e91a934ed70e0cd5ad62f5819ab31b9c40cbd1e0887279f2328705e02ed2b4a071c8cef9b26ab4ef07f44f9162231e96dfbb600249e38e7a2c1429e338a854f3657d45b5f65a166c64b90dbd503cb74d6d26bd8d288d467d672afaafe719e39f883f888a5324e76b4da69f66a09c2b0e30352997a17ce5ca23c6d497743171a8425db767e5f89b93244d5c269528b01fa340ce506b303d543b158c329fa735151a3b2f9b9a94e9e5149face0671b67a637f12665637abab844d83eb76d2284a34e8b74640d0fce4aa19285ed06d63f985751d2212b490775df31c31dabb8c516e3f5517ab46b410005a35a1d05591d037cff665bd8b29bc51e54a41a28d9e80990c4042870702a866249e7555363904479b2a77431d1c1d6b56fa33f6d057117cb909760d2415d48f4b2afe43ab350fb77657bff89006a88ada6aa788278f1b853af0eb38deeff65cbb83a38f46d6c8ab6062a2ce8fdb10ceed7011914089c17a0a72c7b37c2a954ecb118c6d4a9baa9e08c7d58cb2ad9da7cbd1ae9966ebec6c59cf55fa07d546fe4c1d694d8ce9c055bbfbd0a79c60aa52fe0db399c81d727ec6fc3469c4b23a1e3717958e15258eb52578b60be8371c159c3981031110f5189b021b58a3c21f39abac3575c1ce2bcb298d2758e414dfd52e61f6ed974ab2e44035bb9d0d84a350c7efedd354da9ce91e4387f3b118a56b98ea21eac4de2e85eba6976c8bf6a1bd91f644a82afd8042e7c16d4b39b84fbc193ddef16af111f956bcb2a815f61d81de62fa3819a7ced0c25df5ced2f8842afc08edca69f5a9cdc7df8f1af73fc69598156395b1964d1ca28aba5f177f6a819014610cb3075e2ce55a68a54b59b7fe6dcf270c6246260dbadf11b33801f9adf3b2d1ec7c154a7d79add8aa1f0df1643295d0f677ce23da2b6f5b2c13c82dccbf6251748b2fe724d7866ef6b298eccfca7504550e554f7f9b2ec4bd4129763f20a6a36362f824f4a3f77b9deb1108c22c3e9c3478cbb384cae32f75ce4c709c595942636aa18b4d328f59254840ce50c5f4a0c77804ef6b0c1ae7aae4dfe6e6e6124139e2a3855cef94534d5ab8a00396f2be0d14ed895c61aa7560cbece28d1399601edb6246092b5a9f8ab700479d06a94592f19ce3d5cafd1b7bc7c466437b9c3381ed769f7b6f23671db7c771141a441b0fef964d08efa142d79393d6fc608210af9b6b9ee1c161e6bba0d049fe49607d8260b07d902b826a6c47a9859dd47940a5a5bc7d6d3db58664e033751cdb4a56e719c5ffc42dfb760d2e184bab66e734669df53d189916ffe8a060845065a28750331cfeb153b083c95c04680b4ee640629c90dae32a15dbf91d6a88c961e3b9e03b44fc741b4b97c112d6b29b2edc19fb9e5d5a55bac9f6ad3e21840f455b5028deac1c194de3ec8cc6fb126e65ef273a79be75df1d40fe69e32a4a9a0121bc6ea1f15e6248b2d80b74e8797d65a38146be253c56646c2b4ec7ec2d8f46dde1246d45aa0f0a046b46fe1bbc426d5affe935813b3557fde17c5ba99af3ea5722837af01b8870329717b87dfc96357b78d9696a659f8cf991dba2daa555adc386ab60d806e536173e5a8f8a96e31c8801581121e9fd063bbfdc69c3cd374582c0fad1f40e28c7fac4f65579d1d91e226e6eb6e11fe00f2bad229d54abf6324b73628c4553d6bccfbf8c680cec256bb61a8a458fc832d80c3dcb678244fe2d32c70c45169c12ad60b2289b64f00797564a14b367945986fc194e98a3b471fa4490e92cfd649282a127fa9367a2a0be535474b5f83d78b514df8897373915f552624f403144aa672b7686ca7aa01c481a012adc81a6e890700659d8f7d3ed478412f3f7d1d3f2b34cf1d8f7a12517ece05b1c5bf9bcd08cda8dbe2055f2f520ba7f72ff11d7066096034d666106ae61092616476b857b81771f016b4d95ed924d7092c247b8fb0fef21cc141763bf6478b7a546e119b90745f99fd7cca97f854d3005c42c9922b603e3642ad4acc52932fec89d1141c4d8592f077527ec428ffdf6b0818faae8710c287550249197ce622498e4e88f864b4bedf707a4017106fd543696ef56ea6921427d97b2632afe7eb9f132d93cdf616c86deb9e8e4571f2c593641d9e3623635947478c145040421e10687869aefb511e73ad7b9c56f910035bb885c50b483c6a5b3d3a0fe93e1c1e3cd5d949e941777abfe32e18c296d9880a1672cf881dffe09acc811be1d2e97b01aa7be57e486f3abd04b9574e2d8a3606ae3db8ba570f117fb675d940a728c5d418f244bdf7b4e2bad9ac3f9440dc2f8e42f163ade56e061b56e5db6c7c3c98e2e605e9636bc927efdaafa5631cff9664595461b684010982c7068479809142d3d24ffc44ae9ac32b69f41025335e60ba2d34ca63e31b15969a2028e33e19027b22225e4423b9b9cdc282040e3aa05563cc7255d89ba60a8d43fbbe9f358268b3bc09f68b3d681b720565431d9bcdde6a9cf8cf7387862cf564b38797829fedb7e3c59a6c3e178d9c393735039e5680d49e71b928309ecc0190e1021098bb01f2c7646314fb89a20cf53ec635fa736997de9e278934d473018c7a67392bf59ef8e6d4d38ac5d0cfde05464d1c2feb89b13f9be908db1033211f778f0a661717cc1987dcb833f8ef5994653d95629bac1a64683407ca23ee1b506ff031a5b4aa805494ef369c678f44e602a921e53afb94c52ef6bf7803f7014e05e949b2931051153ea98185d68fb532f6b00fb86b15e975ab6938e49f7864f837d49fa1d704d193d55a733b040cb857a4e600fb33f02ababe2d11fe2b6f99a61607ee7173e721382595502b08c9ceb02493ff72615b755a03d3bae06063379c7e83eb4a40173fa84739e11d974053f7d2b10498a6b62464cd560a307d036ffbb780af30e7c476f9d4295c0884574055fdb8d76a89f3216f64b2d9ef7a7299f98275a448e0f14bed28579bad8f9804e7854963606a4be55e6e193c1845d09b58ecde20b52d0e3ca3025b72531609565e80b13cbf3a7ccabfe36ded9b105754a6a2b787192b013e69e059ac508d86f4eb0cc217ba90be2f9d3ab4d2b7cb7521a3b9e224fed9749f23ff2c901bb66ca1af17510166b8792fef8e280ddccc38e31727e8f49d3d32ca47ca9f0e06733019026499acee357a9612b392aebd1bf397ec993e40fe7acd59d3f2172c0422502dc927cd6ba4d5a3e8f267ecf67fddcbf9c1b40eea7d651e32975636d49085ffe3b3280f74cabfe02327da1f324b8015a8fe51e6e146533952b2d3d93f232b5edf29dbd97d1d61d000a5f5144afa9e6477e4ad15d1a0845f1ca45828d40da23907ccadb610fcd654388692ca6a9966e75a47ca1657c71b69f05a025e96cbe560299dffe448e3058a6a7761d95931ec778f3ec5a238cba49417a6e037336874dced3ff12e575a989300e3bddf486ff88c4cece8bcfe7accee0ab2dafb279c66b0dd0f114f1b4d896428a21a5aa5af8cf06d65fc9c7023cb35a11c2ce5968838fd62822e861be90d81d7adf0a853121dccf69eab5081dc09ac6e77083d86c435d70848842c3ff631a9eb5c00ab732d82da67edddf26c7b6681de81e1875aaa8d2dac3f225aed9f32511422c1b574bb54ea4841145995dc528324a03453e39342dd3cd07b6d4741a0e6dfa69d29e13d25ccd724b3cb984c4ff27d13f9376f66aede448f7714c6525ca8bca67927abf724b9eee47fc3c698aa0210408303afa0f9304cb8ecbff0239d0c0b81fab6b526b36b630c87c3de13fa25b027f997c82d688e72f273de0fa71bcdd40181e0bb9ed1597ef7256c96e585192d1bc7c992d6d830ccd06b97b6617578a102794eaf6797113cb33408d344c507453ef8adfc8aa4ce0396eae5f6b9042a7994b0c5978b52254b0aa066f691e3673589ccf4db1261d5d5ae7964d84886872019386b5ae3f33151056cc710c8736ec4e1ccb144571953bfe2791d6a0b8941e8e8835e9554ca221ed70372d15df1fafae832ba0d5158f86e1c04efcff26bf4f0b9d54a12e7cd53ac95558678aaca157a156c7573b08a62fc93830308a84fb4147086cbf2a903722e83807ba9cce5654a69f5378b77e3c574a5bbdfcf97a30c3aa2f92369bf19a744c57817abaa3ad3e23d5bdda0ea8131fc42ed285f9c0287705d7b9037883bd700ca44c8390f8496d15bd979b2e64e14d7e1b85988e74e7c95ff805d18ea88fb659e17b6b16f7e196f2e2a5d3bcd6f5c35c688f92a3fa6111e81bd5b504791c47726fb840caf6559562a22662342df58d1ae09478524fa0c48de55e2ef1f43ab4baf48c0dafa714932fa906db5e16824a72dd43566d65518eb4b6956a7917499a05f11a18d1f91967b07f088088d2880572ec06c7ea6c903f12a5c039d205b29b9d51f2ca363b0b21b60fa06ee61388bfe2853e50d877d07b5652b7eb146a196598678241bcdbee57b5f9cde3037061f76c964b490924d3fd28e6836ff1659615e3a4c5d6745a85936bce92b5b413102bfc3cf8a3b88b253c0c95c967f46de32a095fe69a5995623779db74e70f27a1bcd1ae013af6d34025ecd92f98d41e612e3160fb6ef3dbc04ebfccb52c1b6907488ed9f23b0c7db002ae7961a397ccc4fc5e8fab1dc2aa2d8f5fe71c62ded9f84a31e559f6200ebcd81f87959742b63a88f712f43743dec8d9b67f470d435855da0f02b6dd7fa882095bd972889a9c3c260e23491f75bf9ad61698d469a6f162c6385cf8f88a26578c742cf117041ed1ece93a3a6f5244077a6d6731c649fa7acfd75f3b17a2a6650e0dc35d09d42b318104eae8108a7e514c320654187826f2503412eec0bdd3e8cd4ed5da3bef4becadaf139b872cba48cd16b37bb317f29c15eda70647a2297560ca5cf583a098e4acb433e8c2c04bbad42204706be4e4c588a77032460bf70b10ff96e25c84e5e9dc4541242ac5dbbd0f21e33c292b502d16e7878ccd430d4fad81de172105f9d43407998b8880ba934524c0ba20a6c11749b9ba67b41330969f7e74e12b79deade6525d003d996dec6bbc80f9912edeeec1e127d4b7af0596da1cbf2dc1b935be6c0c42ee0a7331aa06dc9e71b1daacc55bbd86b2f050a8eb3338cf217532c393969435b7d1a06681562e9e4931a368ffccbc8991b5ac03dcb4326d16c31b8324b6c2f427da930c9402f8d019ec69ac3440e4403d628d452dee24afe376925a2ac6518f5d3a44774198ccb7612130674037d36a1a1bd2a032a4741efefec6501a7c26afb6dcc1ce3c0826dc9472e14f2f70e129a9fd26c261bd00934083f456f63820593b5ea59344c46675ced32fd39453caf67b74a95b25c49724cb551accd7a646391457e3e27ebbb142ad1f40c16071164311c0aad99423468d5cba247ea33bf6b0e219f551f40a5a49a392e2c3451cb2d1e02ba33572cded7c7ba5777dad470663974bdb3cff518f74cb580ee8b7e0b0f9e030cf7aa7095951a0b84cc08ba3f4325979dfb29a7bb1d1ae7ed5678a1c8933248fd87a266b654f9467b688bb89edbde8c475b9e221e835d30cc6206772babe9ae3d5bd80c6481057a1a15e4d3dc518991de0b4c89fcda41b8b2ce8232f744a261447135aba2b249679af1fcf4d3401e98694f7ef3d2ccdddb78e39f3a0a2bde057390109a10fa359dfbf9c66bf51600aabdead864ee1b28a732759248092a83f44da1ffe770f92e0cd779174b5f23b4b451742fd3790f1e5fbe1154361f0848d766aec15a6897b6f3b02cf8e8941d64609365a48e3838a0f649b0bedd75625ba39ef6affb835a86fa214e02dbc99a01a384584dc3e9f1e2c99380f7abb335f80ea7bb70a40348e7cf301aa69d6f591c837c27b2d3c27d5c13601258825e459da37e69d5ab04f594691913f7b552213200ef504497f3a36f1911d64d5facb3d984e6b2fe640cbf65a08b397ccc929b9774f37e5ff79eb1beb2f79fbad3922564f510060abd6654e2e4f5d669c9f00e638ca7ef9c11c87b62233f380f23650ed540b1f498e2bb1274aff401eec7b968d324ef6b46a648cadd72e91f2e02880d586d52162044ce0c03a58db34f76979166815e683e00e4220a741111537eda454225c6f250dad9e647df37614a49591a6f859839f763734c38b3433bd819286f6b3ee1f6fa844bdd7a40106570fe48cbc1b8b78529f8a4ad8adeaed57d0c31a99f213ba20cdd355c95cdb90ab6bdea81d85d46b8d3c9a3ab72699e36dae4f4e43ae9481c807f2ffd1508240056ca7350c2c6003017c076b39086c38e346ca7405f0abfc1f990e88c9e9e509db06813e5a251396f85c80e166fa6734570207b9823dd827e981165ac2c19ecfbf0de951520e1cffd59b9f7364c06e1ae6691a902697a88ea42d322bc9047fb194ce5c2ac8fcc2d564cb0d3e93866d0062ca8c6d97d0afffb8317e8c35abc8dbf5aaafae1d586f94521c607abd01008f68ae17000a81ee71f9d54669feea664e8be1edc61e1c50c7a4381ac80459e7798f2bea97fb8fb3d89cd744cc1e31f21c417e0046ef747ebed22ce802e0c6149d3e532e5939624197bef40dd06922daaddf9590f64c5b5c2a8ae2f6d76e791124fb7909ff69c4fbf65817fb74adcf8b6ed59afe7f02639c146a8d4998a1e01573f3e3afae13ef7e3b83eb23c2c2326b89f069198922e0d478f9798f52d9651cbbbbc839c1cd763c703e8e586c2bdd82d4dbf4debf55de68433f59b91d2331fb68678934fbc4cbad9117e1984e3d51a33b323791218a70a0a3f34d1b0d28b805b58f4b4a37e5b3ab1d93a119dac9ee00b22328d097c75fcf64d01760d1a34447a5d8212434315a5e8f1609f851b2cf112b80f257e9a4ac2e84eeb16d470f39f8d7c8b5abd7305f057c73acbb142b5799030b06288d1b50259df3ad24d6f75e7d67d5bd68da40d8f7afe54cb9354c83196060957922c3eef54232307edef705f35f6bf6c91296d2a3b740f74ca080d42cd76d487b92ef267f370d42646c6588a203243262e5541208b83bf8f096e40d0d5922234d5257c11b76f7eab1ea858b52a87a36890863b600e1b96bf6a2bd7be546b11ea4adc82b7d61c4aa77b948dfe8b68dbd7ccc27f0f5cb3eed121f27041036f64fc3739ec0c7686fb5945c67e90b8e2a0a8ba7803f7518dac938fb61901e2cf9a368226c9f1e69fe3757062cdb9bbd29a2d56741eae9984a4613445477b89a8fb99c8cf2611fccdcd26387684c5b62e4b524813ce13dd3c9fc8e69f93c9c8b684e0f0eeb8b971068bc3b0d7d9cbf5c05bd99c1b7db3e60b38165bb1f73394cb152b56530531b1ffab92714c8eb27f26783285000b770c2f7781d9e234d6aa1421fa052ac2d43c182598bcd9a7c7e57e2eb7eb20bc52d1ec195131b243eab9ae7c1bf29a98077f520ff43b31490f1cace4e71296c2585440f620ca9e98365dbadf795be090760e91c3edaf5c48cc7bb780a75d3c9699e9953c5c4df8b10b3eb20c18d192d99c72f38551eeb1220ce33306c93b80b639bc898917a0dab6cda9abbd5ce3a14961a382223863115535ded487c0d24b62bb3827fac85982c8f09a9bf49c6030487f67936bbd7e27921b22213ef8e6375aa947acd0abadf69f2abb9d6ac8d8f90bcf375cd5dea9d8817cf809245e7d11117068f31c9c6771bf10f5df2958571576b016558100d4b4b4a9990fdc59b5992d79407553805fc508510a28e47c0d9ef6534884e5ce5a5da94103ccc227496211e93b2f059eba874c52ae68d935e0fe2925d1cb2a1a4c8c2bb9d4bc5c96241826384795a27b90f293c1bcfa20d8ef42ea33a7c15c233846250181395d7ec7c6341418fa1acdaead79dd039cb1b7a2bb9ac31956aa781c70de69eabe92ccf87d81b8207f99618a96708593a609740add4008852f6558a0ce63a2f303bdabf6d582de9c7c12aa80f0438a10958d56abf5b583b05230fbc3f7b58e300bc494f3b28f666df397aa674fc77399c1438448672f4fedcdf717146cec48522cee87ea728c9e71d8ffebded87ca46946f1a4e799b6b6062e336363c5470c511a3b7f38f45c1038cafd17ce4cef94bf0c5bb92228250f1f48b8da27c8051bc6e4d6e6d8f79bf137c95d167f914b23e2e1177ac4cfe6187b2bce79fa10931c6c9ec1ed1b19d532cb2adb121a0b700741b917d4a60e228565aba320253ed8267e8a5c9693fc0cdd8b07eed7439f57f4ec896d801f67b0d0100c5d91343f3d8162d5ec05f2829e1729984360177dc6bc8b37b739af25439b6638d8aac64e9e90252eaccfc41c98260648d899af592cf5a32195a587d3a70aea907cf4a9307aa8cdb72bdc8b809e0439944e2125bc7018c68373fd2cf172f1535a09644cb1f30d5281ba4043192f0daa8b9c53684e5bdd5cb0cd181bdad26affe6ac07df7da079cd9ec18a25b16a5a5a8d8238216c5fb5ab33f908153a0270a895a2b3996545e892a49da4fbe77d49f9f9a23f9d2076d21196f08c701c0c8f29e3192f76f8b1ce3f4f7beaa105aed911443810021bacc96080ce77645f2cf73e37b83853f3f0187bc040bd52b123cfc7c1c005aad8775b85ec81ba1e1a2848a0d58c2f85a7eb41731fc28d2d327526cb8c7606536d3515a9507717a26c342cae1ed2819cae6967796af598e3babc69459d72eea42889b27b50367c355bc5ed5b92caa62ed7d6a3aecfe041e855a168728713f47d8eac39f5ccc1234726295664ccca6cfb3c69a8d34313abb9efa1506a40e5cda54fb9892274c2d8b54543a36dfa9889285bf0ddc3cc7520089e192e30da7bc245f1ee6eb2a4bd9ca3161b5cf34c1f1ebad7a5357e3e0532925feff9de8b193a2ec69cf88b14032d8a14fc97b6c08d1d8028eb610440a33e6160a29065ef0906670cabb25a7a9e76d5f6855b8245928160b3441c054971d0ae35191f658cf01a8172b527dd32fa7e46af49bacf5da927f3172e38f72c7df3cd3df79c43c57030a29281937f6e0725dedda2432cf4f32fc5856921b329a1ad93be5320491466c08361074d9ddcb2f6f6c87465d696cfa6939da885161cb1315d5aa16d4c50a661d707db7357b687662dcbe7167bf0dd0617572007d6dad6c823debee73c3e3a6c2f3d014646e0208e053984139a6e5d1ee2b25281602ea5b6447e529fc9ed8e73a42a5e3f577eb4abd03fbb9de7509025849b7fda33e0c23bfaa757677564551ea0b009ba7288174221d628a1f3662db9921cdd40d9f028f0134c35173a31c0449a20639ade5360c7d1f2bf662700dc868a403312b77a19d2d5db1c24694eec4931dae1768a03a06247c3822b2e518e7345013f6d786808e580761f851b2147bfd69e28a277ae7cfb655bb904d94a93cdf773ba4bf15df05606bcaa8c6cf7e2865741eb60493b6630452cc2b29010970646db4d0d062f72810b4a88b1ef21f5cba9307e3dfe799fd139713088eeaffdc5ef061c8344bac290b1147345da138353c54c57ed7c735fd721784622a59b52d9449fc820f66ecc7e8074216f6c8a89e2526c3697e4f5e0371cde7e1308b6045c08741f5b15eecda6ddeacca01b7c5d59f7f8928ae6c7ffc7572c9396dec278a486757e144d74842f9642b8d4ca0996bcd9a7e43d11971ff2aa0370dfde958f15c05ef85e2377d47e6ad6c87e8ce99662ce0bee6e5ea01ef8d1258518f022b4bfc1320382a6ba2fbdb8fd9a9038fa2b71cb67c15cfe7924ed1fb672886e36b487d4efaca0ea24daba65d28e1641d67805bb102f12eb41dd5130928dd1359250c8abf5c48519e2ec3936644fe7f56a4d8251919793d6a8f12df76e324a0fdc8839f1088584a6fb655494d416ee2610eab224c625d0f968b7af7aba9c29be009d1eef5115b03c6d5d33c9745b90cf25aef61eb9be9b4a6cb30d3b4dbb7b0cc28d52a0ecb6e6b897f49bcf583a8be37ff16ca41d18cccf2916cf203b8014459201780c51b12ac925d43f710cdfac44d6ab857c21523423dc109bbc889d7117be15feff2fafb9579f939d0c1467710a44aaa46ac1c9bc67e47d7476769618a296ea7dce103a881d2abbf04151c1b88dbc5af7ad410fe45ff2cf8b9b00b2b545f68aba5f858a14c3de71b5eee8d88429a5f0b459de7b66f3df2d354b12d17c01d3cb2e634466d46670f7d09fac8710d4b15ffaf6af2355ed8fa7968bb004fb550d357d652dec9b916f0b1eaea0295f159dd4cee447fabcd1e014a5e096e72c58ee81f1ec7449ff4fa2211c9482a79c7ada984757648a7d9bf00756b119e51900893460362dedb907b924e696ab8e5e6728633fe319c405beaa9e0eddd81f449f06000275bc585a2e294fa4be232de81b027abdbe0c88e8f73a4bc44efdec4e428142d355cf810c5bfd10e517fe6c5f869939cfb28f5caff6f1b814bcf0487413d18993db77b7e11d6d32bc9229371f0d7048c9e9438d7326864a10b934108ce28c8492858e888dd08dbdd50ce2f36e01d91a7c42f22739a8485bb7047ee80a6ee94cbb76a011e84db689a17e69104ceb64c9575b83e2501d840a82c714a6caaf1b58d581b0a060df7b7ba0826cfc5cc567a77f28e5ffcc7d070b207cc5c9890556c978c583f762a442b941e86459a23dedf44b33bdc7f10517d855034cf02f3b108fd0f95dcfe4b5dddb67a5c704dc40a7de152bee4b26a84a600b69b351aa3b5cd72f9865bd770da4b924e3217560ecc44efb7f4f453d76b6272fc22817dfb9b86e86bc80b8c3316a64cf6014ccdbfbfa81708dcd3a23675280a4f2bd64a3f57806eff745a6247d1a9abd684eba29fe114a4d47c737ddce839590e4d6ad2db0343799c483a6ecc0d28227014ab7cc440de84080f0dfccceaa63f5d791356ff63e4807327a5751857d25069842a8afe38133fa490d2e018af8952dd59378fb2748c074452e3ddb738c21a31fc60385e7e1346afbbcc1053a9930b5c4f7cfc2958f0b5fea654b6c36600c151b1fc6425b1d4ea1e43a351b05a62eeee0bceea8520ea3b55092a376706e24c0e1623e32b9b9e9d818b9aa94d1d9dfe7a0367cfdaefd907188ab8b150ee2a430d9ca5b580eb7b2d4c3f3532a0596736cc3f59eb3d079158b4080b4f89647d5fe4abb8f3ef62387dc6c78ddb39fff5cb594114a5cd9d54191a94d7f1131aa9b845a7f721e4450ac74ecc13fc3834bd59e80fc1ce0791cbc962895eb845878a7c84ed39b941586cdbabe815388c09ded8aed52513e41c14fb71927f54d6e808d91c3f804dd50831f9c9cddd16c3563f9f27b9fd2c92024739907a9f8f48c9659789e3ab7a5b26069bdd46e54758a8730002d53ae1d171b61b38a85957ed74077211d3d13cc7ebd08ad8bb7c5163ca27fc119e4c169d90bf3ee168bff930176035add265288049ebb80294e2d9f7827a582175c6bac8fe73a83638474454a9205c0806e81c602fcb391ff0b7eff3fb0afdabafb861a9499bc040f51a02206ed789ca260684f9001fdb70ed5bf957109846f8d6a3c3b90427d3e67773c62f96972d10221affc0bb54f40c7a0e7bf2146ef7e0ff3af634984b53b21831edfaa87a8786356dadc171c4e046718a1b555202625738714c88db14efbd17d0c86b1af481b73c99e38da39cee5eb9b7e66fc112169eff7c53bfd32ac952708916ed78b07e426e78ec574d098a89938603d9ddddd63e302abde67b007e8202568f1eb92023b2f6db6bf47a3b8e15149a3952889f82752c952fafd49c387c5a15935a53fd641e8a9781e97725ffdb3c1d1d4e07f37f3e2a129f248db5f20f94f337f75d1f1f19bd10da585ab43c7b18ac3455bebb4282717eaa482c421683395d3285bc5e0dbd565fea359db2e5eec20226fd2dac6592034fbad4601f5a2fd7c944a9fc55b6ec478831473c41682d689f19f9b2dd6ab3516c76518f9c23b1b2b157575f40dd22eb70789ff934e8cf81d81d0fb1b613a09ddc4d33d834a6bf9b524bc149bfec7347a3e0cccc514d205340bd1455ea4da1707fc374bff75e7db038fe1027f597e6f7735b71d1b2baf3b43cbb15b363c16d33ba60b998dd7fc7d57ecc52726a4211558177343c4ac96f5a8fb1682a08364248ed93342e7319f7fbdbd842f43ec7be9904898caddecf1126b045603e0dea4543a15a8471e21984a851ceea0967ae979808196aec6ad39ceba04c7d5abe086d6813c47b2fa63052575cce31d74b56768ae6d5eb299fc05e854d8a69f1d26c6001a51502cae5bcc6d39a7be716c63cd5d541df98d9db410bc867a44f87656cfa44231b130cc4f50d124d20bc6c5c8fbe4996fb730412d7144c931fcdd12d24ebc3498e87a6944db3b17394518c691ceea5f5cbeb3418c8c71aa8b6b8432a71332d2b427fbeba8b622c8b9d9155a52c5440ccaded26c514da5251de94c8baf6bdcb994cc69b26d2e127fa5b48016290a6d05f1030a46aa1435a1ab64bec68c0aa96a11b11c0f6a3fa6398f6c4105ce9224324c46a8a1de5bf8c015d94aea377f3dacf22e7105f41ef619ccd507aed2448014be937c86cabbe6d4804b3b219c93d77fe6c9cf403748af72d6998e3915de83fca5f91ba6791d64e53b4976fde5752c1cc400265a3990888dc7a6bc7e5be8621b36b017fb746d94e22828cbbc00ae9c0d2eb3717159f8fd265731b9db64187d56a36513cd680a7406bc3fc98d658951692efde5bc063ed26849b8f276fbe97236c0b822eeb19be314fe7a43100c3722327cd1c96962e5aa4bad1884ac48fab3fe8b2e97002d361f65b2f57c335d5a3fbeacd5a18ea19cbcc6fbd499544aba74e71e62626b44417d3073a348b1cd04a7da94fd8ee789e27dfa1bada5b8d369b97ac94b4b7e78d3d86eeb20fc3b36c14b4bf6d00b6bd2009540d8bdb10cbb7e26ab8dcecea0abc81b740c1b63a4d66fed6945f6322f91010e94ff25603845bfcf50779115eb5ad8747820e924fa7f427073421ec03c4a4904006c32d7e6853e2eaa60b713a2adb4f683843b23e0130fcce6bb0542b8d107423754586a1f386d6bea02173be9c16982a40ea2dc1a0c86d4ecd54909ec8a8ca13420f0cff6be16c23bf817944a8f24cf823befe549be3cd119c5fdf0cdd3995a34e20ff58c5d29bca0d1c545689ee4c90d6b54077fb16e782fec8e10a2cdb319914d0ae3a2da7d54c18b118559c5e58fc6522d3e76ff8ce15320694c871c6dc82e62f68aba3d33a22b8ce0ae59e547ec9f60d84bd5caad26a494b92c274b25c83ed73dc5339df9207e26b4c3822f189bfc0a8402d926ad1e1107ba5c6604980acf643c5b0dfbd2e8117af32bb35ff3ff2b9c74db7499b3e09ed52558a6a7556557d62a9380cb62509a9a1e36e8b1f2a0c8403b12442507a8ebce4da9b5a7a8190f6c7088ac7246accd87839bf0dcabafd6ec9412962d6c91572a4c04cb2de436db2bab067eb824768e908fc3f711fc055094b4c66269f29e4a80c9d355eead0afd27a62cbc87a2f23a25e1424397acd25a5c64c4254c1b6c020a6a195f9ff6aca2c41ecb4dde0efffb6c0c6aea27841bf2b4e1dcb6591fbcf54e8a1d695d6f6eea2ed602f586b18e2cd6ba827d4cc77ab9671b460c01833e5c4c3f567d6811cc9b466f0943c1495ed1910d8bc1f9f385b8ec70dc3d6911f8dcbc8a955689d058b6b88b60b2da0776a88403a545d71b16773f484501a4769de844ce9d3b0b3b452957437ed4b9386bacc19dd6e07668028d55c52900c0437947c11b41fd26fec10b0c77c7a306d752c6acbdba3a6c12063466a9d86d2f08b3619eb483f3976a63b9334c7b4d004455bba095bff84402980266df00039fea7cb8c45fa5c7cc22d63ca813326cf9638b9964706f0f1cdd69ecf82b8ac3729b040a8185da76b146b8e32a209d4d38e050eccae36f077aec06c8b9600adf57d165d82d2e43f2b0b098f25e3f33556e0b4d813d867a8eb9462ae0cfd9ce075be73b1950f7d07bbd6597e483e1c0dbb278348cf327ce4dd90cdfbaaf9bef7b57ca74b9d96147147dadd15da0f47d0fd3ef57bbe2e284caf6f5ca61403aea39492f1947335d4124c4c9fdb5440fb6d7c897105eb66ce2395ab563b3224a798ec9b087f65a136fc9ffa96700c9a386b5b5f43232f959f1ee1cb6954574c1f00de94d2235a815bd3df5a74c545ebe0acb62c0c1478845a2208b462d13dceca87590d8ee7328491d21d8cd6a1e76c1dba984f3dd3af8cb281e07b37028544ed8a3250013f127a9127b5e7b20baad9b8c1d48c3a6bd4059582b96b70edf81feb0314dc611e4091639c23f223e2bea0ba508a0faed722370b7dfa3ce8ddbab4446ec9da0e3adc34b29b4c7983720d84ca0a687cc04d6120f23dfe0e0efe46f60666b4374f55184c4f2a327f12ecf26fd0ec736d209150a9e5a23aa782b2bb4e4b8ad9b635a23494fe20ffef7180fff888bacb4b2122fcb41179ff71efbf4b8c649586b428235835a1d57a7af7c7ec0d38a5ded01329b8dbe74fe45b56497265b5e254b2a301e426c7e8bdb3950208fc7a7ef82049298f1708e23d8028ddcb2768e37c9efae39d0fe286265063f0eecbcb39fdf90f4df78f1ba299c3a69b30f798f53e21e95e646daee1a7bd7bde197fa348c71b719dbc0a2cb68da26218c0ae91b52dc888d8676cda8f844d15623d5cc1778bc854d602d7dc8f0cf19a2b5e89addf246d51c4b89f686e6d6dba43085b69c414f7350285ac3ce6c7a3ea67403570323265bc037f0a2c1f81b13da35e5fc7081fd3b8f8675be284170a21639361db1fbc7f9d2ca669f9b73b7d5b15b4a9e7c89c19211085400b158d1779f7605379ff3aac9db7e24e01f6b94e30af4051ccc1fdb494ce9da9c4546c3184a0f079397992a06521734eb20936dbd8635f5b5eac8896fde191c0bef1be3c12cccde62b64f35ee7632a8955cdc9d90843598fbef45e147b45abc4a31e819e5abc722b786783fe5836760df1848e8fce345973f84534d96eb37a842557d558594d94036f476d6ab4ad810baf97bc1c75636b2c4d7c53d12049be91d95493cf7f239885dc829b57a29d03008d1c646d20cb09df0ca130d105d2f96538ab0f1e2f56fe3513268a0e92dedabaa672c56446549b82693ea322cdb187562402875d6ddbd9a1765c0f361c3ffd921dea4cd5f64fadfa1eaa9101999787406a7613eedbfe7ae07e76f0ea26029353ccd4fc2c2e8893b837a9693f5b83a3ebb61c90867bf9aa4a6924d69eee41c27b9e06b36b31aedb2ab9e6a3a5d0a26cbd95c4c35501a537e3ba8ffe92cd72b8673a0766536dda604610a8b55611b36d38c2d06e9e4e7ae17a48714ebf9bc98223fd4e1ecc098e638458a29dc24319efa8c6fb95b20c2629365cc5e05886d54930bd3df8ed8f2f0e2c179816f24840e05cb286e1832721258ace2f429bdbb28a24022b83d6c9f815e44ba781185ce92b34fb675643eb2d8b87cfffda0dbc6e07b4e34b612ab0a9b02b5208754745c579d53d7711b5792731711abce1c534e5569bc85b131bfecf746edafe210a693e2449004ddcf5897e3e0357236b61f66d3ea47cb7d93bed534de9a3b512257ef3711fe268d9916a0ee49b5e8e4ae264d2df76a4f0344ea734fea7c66c9d2e952889d99046f866aea0eb3585ad76051cadf8a0032259ab039a95f8256f0adc128f5a4d2bad021afdb477d1deeedc1ece257a9ffbd3beb31f93cff325d21391c9a0a88e44c3b39daea7377b652b2c37b1e38f24505b7cbf260b558268a080fd5bc18fe3ed50ede3f747453910b54b12c6bf0178c2396bec81fc60b7a084c00cfad3945f2f3de5850f0a4df6439f270776d964ed4cc5a07e5a599d287d7fea8fa7416a666ee47b4cfd6bf62688be0ae9a293300757cbe783ee1abfd8972fda31c1a57ab499662129db81e56d437d43088e5b982c3f3f65b56ebe03d7a27dc3bb8a006b1e4bfc3d67298f2714a29b9f7885fc2496cb707bf2d831c61d9fb330f3f3a972270ab098f2d7cc0af1601053bf537575bf380273094b034235a161c626bb1ab1597b2e174b305f9f9b83f10041f708a9dc57eef74dfa70e126655d3c340770d7ad04ce03209ba34a3f74b57ec7ea364bcfc5e2b90e1e9c9f027da1c977c8cdd02cf3100a39b2170701384bd7d26514bd8815ed7d3573011277a094caeef62fca3026f988879c4f7c77bf013124eb5ff0ba6c3d1caa0afaf57526080dde0a2470989939e6aaf2755d35d06ab50be2cca5bc744bfef75397eb6fcde1305893eb425d75740d6222c56b7edd625fc63a30b9642a093336c66f9e4db05fe2c595f0e4bb7a70c3a0595ccbf28d1c46c5ae099bb1cf6c1916e863c8f83f0d85bd04bc34cac9eddb02e14088f1d032b780b18daa454934f746a7500a0d587d7e791c7f523b772ff75bf849f524fd6b9c725428af8cb762173d173963ac92120183db4b46127c5bf07aa4bfa34291e11f93990c36544e2fa1dab08c91c685e005cbe056c053c645f9ac93cfb8402764ad9b4602cbe48eb4727979d4420a0844984a0c8ea4ea9508a2c370aea06727110b49237e9ad9def3bf662a2b66e7f7a9d59f79e20282d5ef47dc0d31abc3a92ae88e27cb1f192728566f6b5c3accb08447c8d01635ebf2a592879704d7e0e803d6b45d63b04373fd3d5f2645cd624db521b5d4ca77491361df9695076ad686b5afafc62a58c329da259975814e91b67202c47a51666476cfe7496032e69e9c0105517a3249dc1f068447c41e3d5a81a153b0a0cb953bab56a3114c437bded8fa7298488ebedaad46c831725660296157d66653765dbe8b18734bedce18437a6606526012869ef0a13afc23e97acdf50b5e877e48ba87d00cc6e8f0bd8f66073b16b969afc02e8454c099919ebc94b4140fcc24e532377fdb2aea62207f7aaa7cdcdd90cbfe4dd565073194ac0a8ef80804a8fbce46422f7156f12ec17d05c0fa6a984a7e52c242ae7d192b9d16cba6129a13f5d07a61ac330cf39d2539d8976a4a5649117b073a2bb45ca439d73b66c27fa8ef053fa11c224f8e74830fbd2b2677a9e788e03e833096561178437903aa71dc2f25d5cf2559f957a2486da0947ff12aae242709a8163ae068266c6d3e5493d9d11e8b617088d27b855c7454ebbe13718d2d78d36919bf523824a490cfe9f4bc22879d1df57d88cae9b431af80af080cbba545686a988771e5285ec9dc42e5717c8c2e72f36276775c9b508820ffd36ad77d9b4515b07536184e0198a89d0336901918c37da31d96700b4d128f7914125fa687c47d863088196bf435077177ea3e57877a54fd94ce579a7a3757f229ef434b5eb0a79e8d94c53365c047589da7b69ebb7cafb94ede70db005179060391fc591141be53786bd07ce590a18d8176cc745a41931613d78e2e955ec728bcd2a57596eb2cfe4e67dbef936e20349c9e3aaa2ab66c2a00681621a52aa7f3782c72186a0cfef098a897f0127d8949a77f6c2a6b189435d8e7ec31ed6d5591ab051e33f9bf196e43229278788d6fa9cc538ceebf5b3537036d1ce948e134e6a2697dcf09521b6a49191470a9fe92ef67a7fd548ead9e59ca703874ebf1b7fe0ca02acbaae9036b342d0f4c40676ad1a273104ce3f28bf59550d82f2d143843f745b86e7ccca5c9f0c9773fc57a28f1ed54e5999c8b5ab76636f4715d91994a12e68b3ad65b9fde488f35d31779ba52e14915961dbf67429094e0bb79a6e07a7adb397563f1009bf3181adffa26754818a9340259f54e5c3cd4bbe93028cfffc31be733196dafda1a5e6d18c77de59dcfb170df7315ba35e9ff124dd377cda4ae2527e6cdc3de98b5de5b9a0d94777b5ca8880b8a203f9b3941e37100e3942049597093c358fc84bc0ba401cbca7a10bb16f4409b22902735da86c3a396a4074592a75703c57257407ce309ea467bc69c7fb3fbf523c6c5350d1e655893e350b6c6d279b35bb19f61ffbefc332f5be00c78275559a5247126a104594577d337d3715c5e9c8702421f34ac1a25b6254c98e609ad1ffdd4661be8cc6fb5244f6bdc43bdd40f68a8f7c778d67c5a71beceab9aee7e8bf40f03fc6e1a6edec6465ebd78fb94a0146afec41f041803bfecf9477df6f76f00e1403ee612376be7f588db08d193fdd48eea1a59d3f0eaea1e84c21addf84a5d267033ae1815e1b808c7669a988b17d762200aec3bfd88466956a698104477a9d013e263e5f2f1b7bc70b61dc5a3fe99e9a07e86e7c0d0e6cd11565af32a2113f228138de849e5c273b1d6854ed1400f6f8bacd8fd27cf37de555584b128ecefd7b76009badb3dbf9a4caf2c48b1db9d2f80a67a685ee255d52763821a5385a424acea7c08869dd1602e4ecb5a4d2797f81699b138a77b79a0b23ce13520112f5748fd8bb3271cec0c5d6953e45555a4c69ba110031c9cf19f38e35aa2e9ecc58d04acc936e670dcb85331bc0b30f06bc63147d99632ca77bf0f90a02b319d98519d7be1fc4c97b9a898dac791b551c79aecb7783dbdae5bb6a96ed90654c2d725d06c427d7f5ab52485f0407c1cab10ffeca053f47c6fb22324f7be7c300efa1e9df07611532a7d3ddb53883b67ba145c343aa3fd6c9999ff712ce93237252b1406b089dea1dbc1b7e1f7484ad76fdec7dc94d035869ba6d1712713a0697136a08800fe461cd3e7951962032b6d73c84c9f8b07b58dab41d37db6216e6374776f347d7fb1959daa795fb081a3406cdbdfc3ec94b43576e303c0cfc9fc08f5a8ecab4a69d3cf75722febf81b7332079773bf2579812752af07fee0d12c5252138532674e771e7b17c2b597a94fa62e06acd54254f1b21db4985043ca445cb7b4f1c16c50ac5576c884c56d043449ab4b6803cce7b7f76dc9934190432cf765a1684945f89a674e59316ae0384fc5e379c7aadb8888be11a303333233bc6e2c782851d36493cbe26e54d2bbff573128ef7cc37cd9f0d3d848ab0e649843973a2efa114473e810c05a3b89f3e5f8209a002ff0066c3c15fad6065873b0d3c040bd15a9d80448e59267b9eae3eca6f64b3755e255439b1c2b2b2ae234ab411e5615db73792ef7f377ef254c89f5e82213266976cbf062bd2b479c3b13aa1cdf0e49523f16d782c7d1f7c827f73e2649a93f9aab82dad5a9f3c6b7cde676b9cfe2e8807c9a37ef486a2dd49850c1e526e300b602a52e2f45c1a2836312971179e1f087c43963326058eb08ab2d9cff476076b5907b313d9407ae8f0040ecb8190afb29e739d083e89d00405089bf65279433de5f8d2d00cca74d13706f97398a7f4b1c04690aee3a5ebb97a5a21d3cc27345c2cecb25a06dc559fb4e4a407319c3db2c466d975ed62b16abd08dca70bee68e6ab9bfea7fc80563d8fd322712d556c8c3fe07dd1edf37fd7abbee3d770ceb5e399db1140593d730e8e55bf0e21a6e6592f4dbacd26903f5cbe562ec746c491181b2f0f2125a7fc44e1a4aed193f32bc9927724d5d2e03792f4527028b5771cbeb56ee73511df556628afba701c70950e728a4b94422aab3ca99a2a7966a6961e77a2c3ca07604f27d3df181a9f8577252da2550b9c2eaa40317dc58ac178de507ef11a9d4191362274d2812f38e28ad12198a64a70b34518fb538b8c35050f263416a365a34c9bfe99acdd51cb80a354c1c3e908ab26fcf5338e2ab43ce757d178c38d5f68fdf29c4ef7675b672af94fe43c1223f5c9f8020c3f3c0cc4a811d60db20b435d3df9675c8aaff1114731b6a2660af8558ba1ecc02be29ae2651f653f935c0a5925607e6579ff067fc240a62f8af483a86d3e4369f1008294ea51869761ee792a1f4bea7c3018289d5e5921d3a0b5ea55cfcd9d4cc934c5d28e52a0b36e080c0b65b5e7e19446eefdf360778d7adf1022adca28df56accbf4d0c18f2eb781178ee3177b9dd54de36377d2ca0199668c4c8126755e38f14c05b0157e663815ac2e942e6f972e75864c42115e68f61d8f87f80fb5ce1abf7daff1d1617b176db320cd9e5005799de7e6720cd6e2dff759f8e4c96aa43c7b76428416aa0fef6f4bd2dad26fbe478b05082c7e3c8d2dfe34a9580ac7c95c4e9117c837fafa0b36f34e9116e4d783b5f1f0e03d5c7e4836e561570f7d691706d15502772ef7e6d9eace7208ee98c47bf45dad2d6389b02bd0bc7f56a2fd945abb8e4873dca2cda9ecd13d012e7f46e2eef77e11693a91ef9de8b45ede66db9ca20ffedbe1044e37e68a94e348fdd5a2f81f6e6b1f046fd52f26a886e4a6edcf2bb353cf886b9a6f68748cf06dfeccc2f588913f0812681426f89c790c7737f33225f50cc2e428dc99020fdaf10f0f3216bf5d13f7cb831734c13fce85a6a893c75138e31d4d468958b4e2285967030bc307440c32678bacbcb558b268c55a0d2bd05779f6898bb34166b071c26edad7f4058b21a774b22e00f2c2814d10cecb41bcee83c5ebbedf1e01cb94b1d7befe6796525de8b6fc25999502808c92aa9781aa5fbcbc20bd57d181ea8505d2b4859cce4873097ac391f3f2d4f2552c4073eccef39ad4e45c70dcba30d46c1090f7eef8d458c8e996efaf678dc97d0df9486fd0cfd784aaefa82da6ef60b973c4158d176ea21f375c58db68c37f934c54cce9d08db303119839de82df9d1aa298cc50de542c50a542b26217fd8290d028966ff5c9c9d8b5cc6931392d45e357a435449c9046e82f93c2930a79f2449f54c9db7c753fb785192128f6ba9fcba1c30a9b4ed0ff3b78b2b68dedca7ced060432a175c4e00267727be60805b5eb66b955e955b25e4451a21afba9ec07dd17492ddd70ce740a147b1321d529d3c1da9b73ac0a64b785c48a375401729620e25add0e06a432d2b935ad568be90ed3b9cfda32291b5d76b45e3db7d0b7a582ea1dec2ff83b214baabe965cb57b82474680d0e7443989f8759fbda28141a71c1e087ac2ce4fc7a62f2c3da6afd27a17dd47fbcfe83b0dad7faf8ca6cb3c90dfdd1051b2327de2fb175d74c06731327335dbd2964cd0ce5d11ae9d6d95a3e9721380348c48828886dab8bb33178db56c220396193dde3f1237f771228df4a6cdbfb238edd7249eaf59637f12d15c0f9eb01f74c8445baab2e217016f8d134af171fb91e3370a16e31fb814cb1865546167695dd6669aa3cfa5b91101910c548a4ed07098b559de0c4f27c901b86169805fcc09bb394ddcc7c2fe2a44c8e4367351bbb2d47986bc1ad6afaac01f22eea17dc21997be6382e24cc6dda64538efbbb8986920e0fc025b87defcf78509da98fcb7caa1e1de6560be46a0f2dcc28fcb03fe9f11246490fcc34cfd89508e1542cdf59a4bf77b265dfb4bb222d4e96e6f7413dd6e5f2ac8da69d9785e780c3f21c1c987930e59f7cfba315976d956ef216e517fd7fe55a83e384d3d8440b11f8a5195e8b77e765e55c3f53d16600d823026e932533d3782f593f999b913dd4bdddbde9358b814d3c80edd42c49c4976253ac6b9c85c242177d19f2f7c00db3413aaa99ed65dd16243ca0e9b5eb6fd1ce96870bd69f437c6ba98d6484d74d8bf05ce74370b4c962ed5bfb78310a828094d032d3c86f9b156647e28f386c40a788bd59f58c31d757de0d4bd909ee1eb828ea0bcf06464e16ef6e596ec4ad6d2655d93df2bf46797202b4bafaf939f719cf0c5cd65afaec3fbccdb07d68d3e7ed39d7fe6b478ddf41ba63db804c0b5acbf482838426654948d6ee711f7a5bda396dec28ebaf90816916e04bae06b83eb51f7b4892bb94b086840246d788ed094b273a2042362dd2848b9dfcbdca0f12efe2123b72f7a094ef3f751604b9ebd9729bfacb398991eca9b98faaeed527cbdc499cc126d34510335630459d69be9f87c6129d3dd5613539ad4f980e7f07840e608200f4fc3f92dd1e4d5ca7eb600b0fc259ebbd75820f27a58b898714798e7001675a7c473f4244b7e24798b171b081745245c592d2e8e16d452f2da66dd77fb37d764c061a0cf4d61f3516f389f4c53ba1bfdc14a25eb2d9ff02f1a0a084a645e3c0a692002e79e65c7d582b8221ef0f375f9c0c0d55351ed85628db11b7f5d47a3de1a33d40583d8e45afbb1b8af44f07eea53dd701ea579e373ce8e1a692f1573fb21e5a6b66f0c014c7b7e88e22d3da19d78878aae412374db6483aaf9062f9a1dcf01ffb2ddfdb7bf7ef725299b3735eeb7af50cd9241ec0dea6d21ed33bbf256b19bdad7727e1b8068cee6792347f79189654eea14baf867fd493834e2bf841d322c2cab37de6489ed8b9d4fe47b67f1f801b600b66de8b140885bf72467e138da1431f6c6320d3448f6b7d60b3ae0b0dcb018259c1a6a5d9af61ec66c06a2d2edd6486de5b0e6e53acd805d89b8ed08fc9022dee3714ef8bec720b0b8faf09694bacc26cb28c3881a36e7cd9f78da36d9c1f1b1b227c9e33c6d854a9e541695b6aac1e2d45a863e2b2663e9d86c8de250640fd7bc4400289b5f1f87cbf20c4859d067b99af1960cea311d86fe1ee2f6e9bb56017e46cdb670a500349416a60b6689267b7b7bdf59aef309f00871cc9dd2068a4fb3809f9425874b08a9f308d72c7e0603adf3936195271c60e85b0ac23540e518d8533f3d4ddcb53e71ebae831fb37cb2b9b17dd8deeba3de3a09cac711f7910fd83228407242b2b2c97a3998b80c1e02105a56c3819a68e0191285cf93ce5196a5c40d3f47229f056db47afc124024e3348d8e7741194d2198fabd69221614d59ba26f3914221c2f4b19b4fe3712d803a01dd863171f56029988fa3a83153ba710a6d9540094576851ffcc17e3e661ccbed700163e169096aad6c7c266c691c4b6bf26be0c01fbf54a90fda7ecff2f9a5573cf69b70aa57a7415b7cd02ca9e17a3b37f3d6c64deecc182f801b1e574b67da1eb8f932285f8a62e801d682c2a6556d84a399e4cc4005af8f77b63c9de506860676553ab8a42792e0137a705ce340e0b368594ce3ad6516f4ff0cfc740c5b2fccfb3fa7a6e61f123042e1a75041aff7ae81e9e9e265d808797bc948b359496bad147af1adf35a7c9f2dbea4667160843cd73874205e39a56c68d40ab5bd1acf1f813e15334d6c8aba9363180fb9a1d80e4106fe229214a89c0e6de88e914b00f95104019ec8d52bd212517f41bdf6b9cacb02161c865cc2de0c0974a40e6c330fc9f20de4b9b556aa3d87d858d0086924e1e42e18521ec0bd692874bb8e091629ca71d513563eefb16253f68081a41627372491a332b3f006ba3c491c2173fe8de719ee43e569a4ecb7e52b1f80ffb3edc8ac6e04f92f2439ecd9b244ee43777cd95dae090b846ec00cb9d72586dea647b27000408394e154a129929e3877f51f856b5f515edaac37a6473ae725fb6b15ddce59ce3f13c448cb9c03e246ffa03188030773aedcc4c6a644fa7d74b28bfb0f167328646d4cbd2f750b260b5fd429f098c67ea44ada11f06ef1a840695fa306287f6813b7b2b78f93d2b53378538324ae10fc857d89245b631389da15f58f8575b2bcea183218dcab3060923d371f01b2cc365d28eed012ed8cf35756f1cc5c4be5ddf52482b9d848afd17cf0f76a033356044933a286668f3603f7eaaeee50230cedfd425f19867c96f4da42e8c33f8a271542897a558fc857fd839cabb51db6c0963a0f939da43dcb3dc29088fa4761a0e732b736943940fcdf4a41eed67b3c7c911aba149c72724dd9e869b9883338c57f8bb7dc4c3e6fce33069a456d4b85aad047bfb75aabfba988df543016579d1e96f896964695952f1aa9d26c7e57adb3d7b726d23cb3888297e4c145d1ba9ef03502a81c9b44c8f995cb0ac70a9a19d9d8da406a5fc93c45ca0fd9a917a894f4d702476a26d1cf34a7538d8e33fbddd7a31e36cd1923d82d3c87b88b9f3761655c88fdb0c2850600b12a87473cc86cbbed4e3cbbac2a8bac257f3f1129a6f5c5b72308a8431f8cf05e744d8f929817ab43604e2b4b8db91d6336bcaef9ca65b7779f0409db061ec26446516f6ff7920c3af9186ea820b206d45486bdbeca38d2136d0bfbb76433c57c36fede2194c9055d6ae452731d3bb7b4776171b7063bf9fc42db22f5023c2dee3fa1837cc17e1dbbb6d661c55b96918b24ea2d30b2385ccde233a02ee8b1069a492440fa5ee111b2a8d8381507658e0669e4b7dacd9688e608a48b363c6c742cb701170b508c73f22479574b4bb8c6403ca515a06bb77f8b97db3444c2f691a5c3df7a148823e2464f7a26f8ba0d6abb80e036254c27c8b05410c1b283c9c6397338a40e809a13fa62f4b8b5c83d3727a47671b89b8ffc1e83a2c7079646fe9334305120cfa04ed19ab1ba1aa920ab406c53bcfc2dc3d01f5b3db0e500a3b13ef6121e74aec9b2dfebdcc6d13bbc5730fff04ac044025a597cc9fb77f2752765877b4c7041ddaf908847abddd4f350f341ca14501d59c7ac57c42bce2e873206ce7f3de52b64df6dc219c0148280a416cc5ade3a7373d479e7e3236b69129b14c7db3628aa0f9a8f4779a7ef5fd1e3d01b7e117aade4dfb9a8876fe5b14c7f811152ee93f07dea87a7898e355686f03e7e40b4420f7fbb99ea3417734c417293bfe64901eac8940f6f9d3fc8c3d350d4ec490d6f8201dd25d1f7c16bef272344da93b1396da17c3f0cc10213f2bb6b561c81682833f620fd8653abb9e517d9223109a33e635d7b7e541c67af21ad50449e83f7c31ad5ce7e73734735c9a76a424b8ba994598541b99f28e893a79b4fbacf80f129f975d6290b8ac2cc2e3ba18eecb3220caf0e8b5b340009147045933f69a86fb1bac46384f681e07cfd578652c86d9e9393ec8f579087e6ab9ebd7b09412784490f5314bb5cbc42af2c5d06e4bf7f990951e652d5747fc15f29a52fa488f50d890b255d0b9ec1bb9bfe766e7cbdc807c63a37b442628cc69a9aa8166e3ef3eef0935e9cb7b7fbd67542b26341f4ca3b4f56fe89d96e9aa4156d43dc7cc2c84edd3c2e4564ec206ab91cf994da1abaeecb63f5c98d52f124d33e5ee3c4d407f0ef707c1f942cbf38e843bc11be2636a9654d9f9ad48539bfa6f5180cdcd3061610a38409d47cba7efbd54622aad1743085f430427217bf13c962d11363ab8d1ce7bb17e95b4183decd8dddd9d99aabf382be0659fd781b2104bb17aaf0db10da75d5e04a5afa18b82a52462bad71f62621a0b5e0ce14023caf74337240905d4346a41c2f7bc5323baa475a7927fd7451791d7f3f06f1d289aec19c86615728b305de4173cb0fa7cd4e422adb8954e9929a0c91c17053a00cd2a2a4219d1843fa30eddcc25c1ceb8c0bb571b9608a91f31cde426acdeccd38359191a4b96d9ebc891361210d7f59392afde26305689be7516bb2c48c6c1f0a97445b093998ff8baebb09c1312e5c0592ab4de511626d0463b97985f61ee8e2a9bad9292f2412aa7079102e98e0605d907b453fa71b49b7a960221e1d1ae8fc42101b6b5c61e7c7774acdd9eff12b9efa82ed3ae1055ff11751c363aef747a45a349f01677eeb3e6ae21f03f787a174b40366a84f47434690911a4b208861e35227a1645b63618dc9c45b6e400098f766cf23ac9ff0bab605f0bb25b49ef50bbc8d20051385a6067917625bcacfd4a74c994d07d8065e9be0f746052837131b479aa7789aac121cba96d808fceaee5c68b6238e89934610194c9d4919d839183e6787ccb5eb3196fe9643d066c1a7b2705b478c8d178b22545e654e3440ccead0a10d219e8e20ed507f4c5098c50e1c436f5126604920b6fcd3fb89bbded3d78c475439b6ebd033183ea5d2b3ad2058a5884d21d0920c458eca0dfacb6dca5cd7f3da50541d5c9da9e75e0b63c26947edd85238b9660f958d8b7b78fcec4e24b6b2cd1b5adcdcd40713ff4c2885467cff6e7c666bc399eaa8e548c446e38aa726e797860a099f037c11b3a0471ac7604b37cfeb1175d556315d38949c5b6c00a49a763a20f21de0ac2b5ca8dd2a9ca95b104eac9cf288605328a8ffbe6494b17f09e965b8d190003072d31561305f119b7390986fdc40a2065563661fbacc2125d9aee01626a3fb8a4f4678cd02428e7ada56d1e06476c8c4749e0c51fbc4ab05ff1a76f27c866785b67df1b25153c5359bd311708d01084cb503e72fb100d98bef19f15d483cf4c172f9965d3687bfed8ccbe03ee795119c58aca8636105681395fc9f12d4c38f161a4bfe243671f3bd57a443bab892539cd0490172805cd9d95498fab4e0459f7a62a53066cf14d642aa7f6b4aa5c476eab83382e75b0d7346a415e4e45a3356b6d252a56d0ce72cee10c9f93823cfd8aaf927db0cec81cc897d3fa8afc5a073f131eba62a2ca3b5f1435513f498fd787713783f165d096dbba12a40ff88cd74c4f697d0e61a6d8183a3ed071e2ff44d46fa085461690983e1a6265123541fd64b5410693ea1c55072bc50933ec6cddccf491ce5e4f052c45dae8aa914b2df42fd618664aa9334ec607cac996095860eb61f435a5bb3a41c99a9806d913cc14d14def297ea39c7f391619c5015f15ee21db52120e6815c6ec4b9f780371a1980349d77d1840cfb6a802157899cf29deb95135a5a71d639717d8df61c3ed1bf410e09f016fab81f5fb815555a28ee5ac724f0852671c6afcc8bcb215a672fbe7953a6eda5aa4ff797a178c52bf1e38d4d013415bdc5e955f1604edf51b99dffafe5a7dd1c49106eec9f911ed568b58cf662d8b2d6513781b01ed0206c5eef2e83b3fae04b11b6f45a1b3f290bbfdf18570553b7dd53a302d9af1f276dc11a80e756a01bd7cba84a24035e1fd53feb0063540e6e1319f54c8ce197ce5a229a45199d3a0140d3dc4f1a4e58a90e628ae25e22bef51a815a204781bb324bf7e36593540f65c478dac402108e600b48764bb7f2f3b2511760a4b9fcfacb342dc8b75ac22458850f27b3cd7ccf51ff834724ae043c6bf68d639effcf0aeaf90e9e948a99d784a75b0cacc1df05f317c93016b10d6dfd0aa8d7b41c59bcab9468fcaacc7c8ac02e8cb028d110ed90bf8da8471976e466d5f4d72c7565f0f94e94f69daf6365f8a60f2ed61fa6fa3c04b0512b5421227b913c474f46cc858f5e840c373c124209c5cd231906dfb83d3a7289a4e0211325e58c872765f9f7d918d512600fc589557e273c3577cd8831f717021340c1e7512b73f435c2b9fb89eef73803187079a56b657db3c678ee724cd89cdd8bb5e216a224104a9701045e1705091ba11a487084cb25c231152308039dadcb39ddd0755421afcc28a07dc4715438aa30f7bec30343fb995649816f22534a6051626077251a8e38a770a33d240fa85e97c25ea269cb6bfb08038d5e6a0b61c6fd8d863ab723a18cf90776129a7d8fd2413b321de9a9a220aa29f9318e2eba4e224726bd0a01444c6b4371e7bfe550e15444f3bdf0f0859a05e94f784a0e7f5687f16a88cc7cd6dae9cc3c1a833d0126b15c74c62aaf7e973009fc57a65910742bec69c1db56726a2a3c78252d515c0e170f8341df93c243a30ccac4f6d18875caff7ba6ac04da157fd4622f52c678e36edaa46000184bf55025d157e809adce7e724a41f09b674b31377a9c63d940410fcea7701ef8f0e87859d20b6efcf33efc1e8e7aba150d5227934ffee807888d3d77f132aa1800d0d782cda22a0ecd4e07dc3b855a674e61769e10581560041d3ec146b19df080692e67f9e880f4bf06855d48266960fb5029033246a2d343576be4112ae0ab0ed763cbe516a2c979386de2e38322d3c2036c0a7c31888c9ca1fc0b17012891520a2b750047be932eaeb8ee07c0a8f042754d087256d39c1c84accafa4244487a0f72420cb3f96ef52b8d452a57ee9b188e0cf2bc590b6698825131f64be7723694e17fb02b8c4db595278612271eca6b50ecdb442c290063bd205d6638a486b1647bd4dc193b15beaedfa4b444d79f574c23297945983d69a9827128c1b918ec3b21e431657b79de41b974374b3f4a2ad9a22a5f74e10f8cb2e35bb6a03e6df6e699abbea3a38f48bb7c5e983848f1314a598d16b872fbcdff667854844af20e42a2e87cf6bb5fe6065e23893b48330b79e41a8831caa683570b35a6832cb7cf52d972609e7249e785f085de6317fe93dc00ce03f2a07ba2db0c27b93463209bf21a6d1f8cf759a804799b7ec3fce7a39587a6a242873ec47975d669ec29b19fd1314dda11dd51d4bafcf1cfea40bbf49f63d8bd3e7fc0f1ca9d1fa8e73d679e3d2740bdd6316ea11dc0ac9bc2b1269ae8b2b9bb3b7e6366f7a157e887f600f5beb8529f4e8acbac9c370440cbf3d2b7fe306896567faa5b81cd8fd036c2030b8d015c7dd9dfbe0f2da965301db23404b3061cb121ba60d4e9a26406e296631c27e26e9e4b928de0992262c27ead2843a85fe71e6c84aa84d6acdb3820e1ee8330b037badd1060b02b9f98baf75409b93695e9841a167d56e63649289f6914a151eb450258fd29cfb9662160d713d633544a1780d22ea44f4946bc358e12b2ae17396ec26509540fd5fd167140d46790fe7283dcc8e93aa4a11bf8e93cd2b0a79c88bd74f436291bd89415f5fa81933623160cac3086906bf8db871ec33cd8dda4755b35eaa3a7ec58845b2f1bbef7970226809c47b3bc8bfd263e371ec778a08a30dd3472661c21ec760e00f5bb55d40905b06a54b4b2897d8afe2e030e92e552e41351b64c42117678399f847fdaf6e9e8ee6e5d69a5541140110f7d26febc927276af140f7cda31e68911a0834252643a8b63cf948de179eec0f09432e83f9f721d64e07532a4b4941e6d7785ab81e3edd69ebbff1c3d7adb50869c95d4cfcb075a29e96ab51acfa06e65a5deca29652f789a68c651d922a015474a2e439ac9cf3d44b342f62540c5fce2112a386aeb4fbe7461eae4ab0f64402f9276c34306c8142b77f59094e48abb12bca7a58db0b8a24e1043499104a3491ab6e19d0837114418711428a7f1e56d6a4e6122c49fe5cc0dc3a632fd2253583c090ed632f7b551db55a9f4045b666cd0094d455c3c5462530bc7a5c357deaf3da95b55339a1633a3d0ae8ed1e76c1380a36ad7ccf2bf1a811f6a6ff0379a9561a6b866fecf8352ab6a02e89387d3cf5c2d26617f654ea319d378421e271cd2b9265d6943cd6fae1bc8f23b3e4465325f5a60dc5cdfde768bdb70e62d0cdc3d48e1e36011a71d1a2bcdb0897428c80ebc1703b97168817d8da5df0f3ef44728f518e328acf5e551298468f2eeb25d32275934200ab2f7395ab79ec47ed3d4dc618f3851d80f9bc1d0280ec3b511328e53402a188d1669b79a51531816f2015a15c9d1ff0b996a8e64f00e4d4e2e5e83b62dc830d014d9a2fee60e1bdf027ab171d035873fa54fc787203c8dd05166b0cc56f7cb045e1a7413307d897817a919f3c1e6fd1b27b98f23dc873872bf937ef293a168c82b452841211a376f111bd48c88ea7066e6c9e5cdb04d6186623890a838faa14dd98da936c374696420e194995b48ba4a3a7961a3574457b7ed1ac196e2ba69eda037f6b60084397e408e2a01e2eb50026a4b0874dc88e4be10275cea6f1b4eb6f89936894c16333a6171d25c3ebc344ac0b31b226622455827d576ce2677734292e6a2efaf403d02df4b33bfd72549bddd422883cc3c15e31d5cfe8dc528985ffe759f6f6851a43d8c238128ea91ef4830f43c76498c3ff58eeede2156a14eb2db82a617d7554f24252daaa6f92f1937aa303910d43bd046b33ecef2ad56e01c82f844d3144872bd10a03ad8c9fa349d963e21c826a74f8f8228f43de9476316a46d61a3256c4ea115b9b020fc09a0e0c501515cc784d3d9889e36c916195d4b6692566893884e8a0ffb64b7165ac63922a12591f478e12f8d95e473372bfd243d4cb90ed0ba2a12d27ebab40e712acfd2e583fb3caa684cf799495019c84ada4232687b51acca401644c9157c9f7507876ba7bdf64a5cb4faddd9b7954afb6c21be9bd19edbc25caf56ed856387c4cdf2f4eb7871b624af3d7d750b3e7ea3dbb0c300961c86723117b97ce0c2c2e60d3f48cd973cfd7b3359b12920da1bac57e23d813f8d4f85083a7636b06bea9d5c1bef4e9085125dd75ffae896e0738bb2f84dc07bb181395ae8c90586bf70f900dc340e2a02930766a382842395b59193d1f7e7cfaa059b9a3634ff6ac946cffb89d787ee0d3eb7aedb1c7404049b6b04a0beec8f711e8631a62e2c0e21ccfbba370ec0ee69b3340a31ef5340d43a777c655f426fa5c4a7cebfd43083660efe384c5c7c55f05961a4b359e4b56c9f541feed27b87caa9fda232faea52676da6d23098ef3f22ba841cd37f315db4ca828eb20ed05f65a9bf8e02f345b5a5325d04cb09471f3260c83170a2740b41123d1dac7f250333353f8ef20f7958855563cc6dc6ad177241ba1853c1b2e8bfb092ec0cd750219feef808304d2ea27e518488fdd631d1d49eaedb71ea3ec956317cc4be2c085724ea94e1261779b98ef891f4b1018af29795ed1a6957dcdd89c57ef55ab5a51864f12781c77b1902b853b24eb906f62d9e02fa62f90e797fbf7076bcc4e809cbe556fffe4dd8f98bdcef23ed54c6d706872f339bbf872b051220e561e1de34a4fff8528f02563184c53b9308ecc6493cad44b2af380b74d1cfcdff8aada9b7416194b895c8c2bd08c86f590b64a0ec59469e735c55ba4fc8533e0d95b7597711ac125787f64d22816330ee1723a81aeb677eca67814b3669e0055d9f109a7647e6d6c9bbe331ddab07fbeee72aefd4c70a7a374a2bc6d4ea1464722188db6b5b6c7667f20434c957a9dc8d63c44b07687ba2bd2ac7902c908e229b2f14b9040c5a2c7b44bdd2172bc3cbac8ba3d789536a8b4315995f11bc72237c3eb34ad433d4551909d5d40b23b1ac2f087f094e68a766dc6f12cafb9e49e51936f158e68fc3bb5b6fb48d3bc057d8d54e840170158737baddfdc7d7f728d4098d1884939d3ba03ee208da76122c9dbf3cf685237f2ea2733f5651f7c93ee4f36267d49725360fcbc774d6f80270f3d5e9a6859bcbb9a9a650e08609c3626c7135e53eaeefa78c3e91e97e800ab1cee7bbc3085a75490bc983ef69bf892db1c15cd3908c96fb27cd8ca496aaf7796a353796af147d83ffc68c063fd1720754292998d8fc89d64909570a203025e2114558f65d97de97255e03934b255804f774506bcd4a40113b1cb5a4323088563e6a22ee3eea8adf29075d00889c1958c916331bfdfda4dbdfb65b65710ea7f7839bf46727e9a20142968a54dbdfdfc6f8b8abf256c9c0358527cfca9c899303846df6b6592773d00a6fce1ffdd4188b6a1703214ac22b4de7acbca534f9139d9a81a8d0fd2938e8b152ea4c63ac36673797902a515989e0a0e04a8395b07500eebffedb2d748cff2c3598f0390fa0a88049110833511f9bfb92fbe6b4b478e29d291288f4bc39609d3ddfae8fefbde36a1226a00b33bba7efb9b6f918fdb249bdedd36a65a228114185079c86ad7d623475c39d068bd5b6778964203be24ae45db99464e36aa07e3d0528c411538a953cf7808a5128d9d3d0a3a42b65917dd69d7bee27def2e69dbfda7c0904fe329fac97e2caee64681b057d8781454807a14e8479606a74798c7fc0de37b16460eaaeda83ff1742c94073631771df9d552d58c90ed3d871f5e0efce6285ea52cb48b9e5f240c894a41b59103e46512783f17f4e57c8d963cc30593e9517e991212601feea17638cd3eb0c5c522dbcd96a831835e65e4742aafa4c836883adac18176eaa0d5bc6e8dff325df8f9831ab5656d5ccdd20bcfdd1d57ca37829025270a355be249c6fa39703939badff80e779351e2de9fc013c82e4818856b8f45ff173c635e4dc5ff1e7f92c622ec24a68184e074837dbd353f7b17b2a11d10b20ff79f27f439f5f8e08f417d49cd65058f35371e5339be3057ecc6d057fc2ca356b3965d22d04916215e7b0ce0c4261319ece57f76e8322a6ed64d4b8aca4651eabcb433f0e65aea0a56955126761fdb5d781abb3c21306cdd42f347c4625bdec5a881e9df72c1073e6931134fb0e6a431a26be67e6afe5f45d56623e81cab451eb5e860a275153cae1354049d5208d81ac8f52c6877866d1473a1fba31f1fa05ce71a4b0a548c83d6a488f4126c83cb94694c9f97eb43d04336a08e32c8bf4b21fcd8d3ae5dcd66a657c5ac0e4e82507ef5c06cf480d8f9186a30ea1d89f006fcab22f4d55deb74e35d3617815206c671c803cbaee20240eec781a121262a155649a8e96d4ef6d5b4304a55981578f3785e89161e619e6956e9a6accc4eb9b7f080b45cea99c5785192f0d3e95483591a6cbed9aa571ca5bf74f893084b906b48fbc61fab8004d5b617ddb71075374f6bfc876fdd196e40c2d383a2fda3567e11fc8a0d7cd9d2098fa22248e3e70d5bc3eb9ed865f3c41e7218fb7692fe98d5cc1d4ac4797c2e0ddc9b0be488a544d545c8f00690cac98ee4745b1c17a5892f35f30fde031e0f53131901ad4e1d489fa6b4e612bc2776ab27289fd486b552c051b553ed98736331b28715591c9892a8dd9abb071d61f4b7d74a72ee938bff434c2acc123e0c33952174b39089aff4c7dc0a43fae7e94b566a20c5d2be1b808435a0657e3c77d3e1f558b02e704a76fb8501bea629bd28cb3c2ea515d6b1351620f25cb81ce7cfb36ceacfb4c952c64fc3ff3a8ca86f26112864fc48bc00405d79ad4f7513f5589ebff7cfaa71e45befc8dae91f2df7ef45c76f03f9c332881c41d9527f9e1151fec0ca120c2e65f1d2def6ccd79af34e490a48d9dccc0f6d455a263b1500269f5312bdc48a7c37d5292e8611df7ecc69ad7a47e586b4f399de1eb0f7576f648bce115e48af41bbb754318a6aab8eeb016e49726ca8754021fe783c6ad0b4ea11a15170c266485d21d36a9298fb486fd0a565688f8a56ff93675eddff189787783103e245f5aaadcfee298b557486c8b8b550123a868ad57a2ddc4287d032b56544a13fc217662a0a7683eda697a51ceb69f2389f88a6d5dc1296cb594441bfa23d2e304fd8783ed69a1af7781148c712b64cc112ff62e7e3a40ad0cfb9365b6e25ceb6ddeb591b18785392acec80878c73e19ee3dd42a967cc496adaa181a9b5b41998f7acc58cad16073437486ae1f9cf753076540dae992270a00cc642e2e7d450844195ddf0e3a7f521ee3658643985604aa707f059f1f6f5f03313d5a0a70165fd5dcbbba7b2ccf84fed550e0e2c2540e4f3b2a7de557cd1e3bae6b64579cc832735c0d69c9f47e2d79da2af08236622905934c3b9b178dd2e65e7796ea6e060d9ff2a1ae9ef123f17436e90461662412526f105e6150092fd49c76da315845dad804d85f63c8ae8a5a4273723aea2e49721a40cb77a6d80347d71d6325af478891c6bfa75890876d0f2261c835da7718729d58e9096a122ecfd7cd159ac5c7418ea1157af907250df6cfb82f75b138145d0f4c6960621c15f5e79f550df4b041c861bbc48724dca30ba628f69682e3a2248854a017dfd6409bc7e1a5619bd0b645c0e394341522e6dbc5b29aefc227df43576bb6856e98e5b1da36104973cfb34b252407f534547a9f56bc5f18c7b71aa255a21333a819e6468d2cd25a8a9007799cf65e4e2519fdfa58e4f555251b67fc4a23d28fcdd0e197ec64feec4b92ee61905237ffd961058704ac8fa522a090618713850eb3612adbb93e630d47ca4641d7b85416c88a07e0ee24a15398aabfea40e8f88f8067a614eb19c18071fbd419277e158e0e27ed7c32c58f667bf0390cd626aef0a9d99b8d9257206578a6407d35a8eeb65d83553a21848368caa319767320393e714cd55296e3a997c96663468dff7444b0e579b0f98b4754fb82ce3ec0d53dd37f275b4030b2d3e06f5552104bee4a15413ac11da22279d3d331df6f5677370c6cb1eecc222df4dc47e0319da8648051a14200ba768b37fb63fa86b8953ca48a968c4d82a0d16f7f39e1d3bdab325db1208598c9c756bb01ee075c07932fb4ebfa40d4aa0679042be7e4deb0467f71b67cacd24c2158460242950102d2ea7e513b3bbcef9f7680b3c01041f0fc2c00892b6c673f003c6c106c963d742a2351f48f033657bbef7ce45c842abebbfb01be54a1d55ead736f0311b1ed195a9e0968ad469759896fac2abe6456f29c594fed695a2fa360cf20d8f7a44a559689b1026839c7f35645cd430612092dd5a1c7cd87e18152afe1df3a7c1749cdda84a2f1332560f909c0e33c57e66da54f2ce8bf19330b459e238c809e864c3274816ae9ace42591ca55d50782cd3cb7edc4ec10b0def080a619d98d0a4e99380d29aa41340162a416afd96fd286e2ba400a69694c4f2e72029f1fbb085b010611ea2682ebb949b9555596492f30895cfa9500699c15b5ef67523d61203ba2ee5b2b96eac0b5f64ae4a701b945e3feda09aa5a4505d24b4e5b801f3fadcec16e96d940feb3d6e4bd0a31ad6de721046257af9fc097790fd644b1747d9e785d40fbb774777be00a3ac0b32814a9e2498b207a54c61697a1bc2bedb9c5a184baa0da4e4e4d11acf901a82fc79105a8aaf2c82b6bb7806106c70b068bd784e0e375735f32c56f9ad1d44e86a6a501925b534539cc5af46b03534fb28c0b7a91249589d2797b2406d1550a4ccc34396564698e0783a32c54db7db9b3ea9d99b20a65cf164b0521cddfd04ebd7d55e3e62a6644cae2eadc4bd8cd69458d7aeb16b67d9909f5a10f6c3f4a109c70173ee64f7173f10443b07678104bdef33a459f85380618bce61e6568ba9658817d6cde59b75f31bf33f9ec9bcbc1703c329ac67dbf5e55898998ab8820cb058a1a0b76aae44998afcc37fee96ad47449e64df64c0fd39f074826ef3c9cac85bb32dd0a8521347e96ea48f88e0f61f97e4cbe0caeba3879db263a30aca41e608fc353c0abe93193ff43ecb3f7479835c7b9c3dcd6415059a4169d05a5de23d332daf5ebe41c48fdd5c2ce39a58aa11964adcffde4365827bcf3e29a2169c41720c6b3c1e2f04a31fa03d8ec656d06d0cad04d2d203e8c91211e3e16e4fb2ff1877c82e714e3949805d630a31c241d2ed8d27c862ec19e296dac755b230420ab7a57559d6a91820a8adb75babad28e2ab8167313944f195e7908dc9631cd84fe7c16e93c0fbbaede961af1a0ded4601af4dc73df82cd95d64b8d369d34af7c5231a025246724dadd93baece1cd653fad454cc2e78f31e6e095b1192ba2f43a94e6e5267850b12411d6afb49e47ee1bf29eebfc619c2cbf9217757f64e7de918977eab1ac28c5a7c3509cf5d03b690fcfc1ac5f86668d09ecf6e816126c40a68c9f8a61e8e36b53f2fe60edaa6c115d964d254e78b07dd14527ea855984a1a394f92d30088652c2310529872d23d91c09375de9666b8cc4dc694d8b57f4d8a594b1b4db57291073ac89360522475a757fbac01052cac59319511adb2cbc9e88a9f302a5371024ba048ac72eec353ee4f8c04f5c3c357397b708315c0026c8e222169071d0e12adf0455cad27fe018c7e90c9c2151cf059925bdba0ea97b71bb95256c1cde4ceaa403a915269a20d764b09788b65754f44c3753bd3475594b79e0c791ca20357978e6c3871e1598c8f2b45f2c28ebc4eff35fdcd86fd8f04e7d8d42a546b4238391ea32fcd3acaf947d999834c61ede401a8217383714c70d1d102e3fe4cbb08cac766fe9d3a17a5dab15ed610014a21045d07a660a4a3ef064106f9d10c6ec542dd9f0a954a8c3784aeb4a56567bb47c4ba17948109216fb02955b2d78cb5f2ffdd7c691a795915d89d7e75369e48c0d39f5529578f2df34f61d996feb70bc4ed1a1960e5bac54b6b776d649e3a07c68bc71b7302101d7412df3141cb01692dff42ca64bb81ff99d257cf062db246a44dcdb6a4ab8826abdbf4cae41a8561e68acf9c5daadc7895d8a2108fb98a9355c6cbe929f2727982d1c8c80b50c1ee19c7c73d4c5fe4853662778a607661fa11bd4ef3eda738c6c0e301fa2cd57795242c39c9354d1af0e3ae96202803c48c7892b797cfb652766b4a877e563bb4ea6f13384688427db633159c04df1b2e92f95c271db9adf6ca25b054a3fd31468822a70d05670f55ba6c9642e9751946b604e9692246196af0ac611aa48e38586d95d2a7cd0cfb1a2491f7ce5e27cce02edbc8296020bbd499d44619c0a6836c9fb4e73c00a0fd4affa5669ba85e07437417a12db34241f2dd118074a4ec607b885d2d4f20f78ab0945a8feb3d0a697f4dfc9166a4e26bb7a40a86f7ad6f733d7dbb47f287e8fbc8b8a5cd559b2bf47e457ae462b2a2b9ea0ff8840987af26c29e426ab6c0e5ebc830329510013bd51c499142ecdfa87243e7f741d1322f9cbc84ab28037954d6d79c77e8a53a21ad005094d4b6de7c5997b09bc1b0fcfbceee9394861531a0f425a9d3e0d67267225e52bb4304eaeebb01d233f19125c84be1114482697c8fead71b49d38627c44616c47d9d83cca14247ef632adf9d82abfe9c29a94609c79f6977db28b3c129c83c065fe714ce59896f7fda12dcdf1d73f316d7283ef656eb55b820d51a13e205163a14983ea3e00317e0c06fbb69e4f651547aaf44e59aae0995ea111104a8c482c6b839078bc16b6d571c693545e61d5284b2a039eb77a02fcef54c212f398dbc5d1b43dfd3a5302f28ec531695c8252fb9d332358cdab2e09e76c4ab0ec65ab60fb3e3d4dbd8fa958e18a3d7cd7e3a7a39a9135ff22dc402bf9c907f0dc385acb37d2587bc692d3ba7b6e32d124660652d61c925ca983427ee054d9b9c8ac6144214dd7b14f262d32d83419510288c4e47ee97df51a64d11d1bb81d1f3cc009eab5c07f5e7ca1e1f352ea27f5975d4c0901a32e8a94b56d92d5f782b66bcacd0e06606eb104aef230069f95bcc235c423883bae96bb974dae04b79862238e49fe18eb5cde88b15d629e99ed2a43101708cef3e8566aa0564513e88ed0d78b64f96668bbc98940621646eb96a0c6b6ad134425b5c69e16784c60584e857a0ae9a627fc63c9109e19560b27d368d89bd566ed791ac5903b6b8fcadf9994199135b0fefcf168fa5e1caf88f7ef480cc8e210a49db6be4ffbc7510e780e1c7667cb3ac0f1c6da2d09760774393e28939d0e6135202173f14bf8f241eeb2856e1b0d75014e15f0cbfcc9bbdd2ad810890857fcfb9740884551d675facd90ed56878a48bc1a54c3e0f944430229933b663ab244a4bada7dea1a495a5ce08b3a273f97a75e61c9609ebb5f8d92e4398ec6285c2871bda5e07bae0b9a8a10484de8344267f453387d49ecf29ff0dc1aa26145f364b884a0454ad8b55796ece66c6b2747b8415f75b0a04d6570bc944616aed7a8079d9a9d200ce088052fc2aceddd5976d88603e15973fa838d5a94de5f639bcfec3663ad416196bb751950ade8b2f56efc25b5370fb4823039893fc88f453f2a5c66a203deb481e323228f14288214641a492acba785370f52a24a52be3d05a0bb79a40081b6f4dae7ca2003cc370e76a410af2f41c155a15cb46c9fb3a2ba26d57a1f0e06f904e55ccfa89370a8cc8c376faecec8fd0e2dfbbe474b69a3fb80242d7d92febe4f0edf5ee06d62a376fd73567aff202e41d9703fa39c8bd601ac226d51668b1646954841ac5c87128c4ab974b91088b3b1ce02a2ea298cc16b7e90f8d46f43c400c6cb826b2f986d2da7256cb339df3c7ad03a6799d7b305f71b2cc167c9a411a2170cb68fd0b6205951d37b74dbb03334e2347977d301e85d6abb855d68e7aa416e627954fbd318a8471dd67377fefc4dd6ff76a16bbe3a762dcf75acc9ab237e54788bee2bc6efbc56ac4738219e7fa48a83c7e87dc159bf92ae714d96ed7e696e6e2b21ae37a4a1d7f69791f0125a376cff25f133e065ddec5f7eb17e42b8829e5f0bfe41426dc850be05edbc748c0be6ca191810c764d62a8c42ca73da2476762d019b3b518875c2dbbcb417cd2525727905ac8b9d581284035dde5a0c37448625ace3650f52b9c8763e0f85ca2732eb655a1ff580563a63ff05581f33933283aca4bde20abb8b3263cfef04710d6e8c5cb9cdbdbf155632224f41daf0c55e79f14c6ca24d21430dec19e399fe1e896fb9fe9bd92bb4754235ebb4cf0b177d2d1654912622b3f9ecf259b21cf8f8189426387c5f1a6cade26c755a5a7ed251a6d6c3dd5c84b28fb8317dbc7d4bf42dd32c355071d4fbbe48e33e099c2d9bfec5f7817c188bae9744745ae12cedbc46df103bcdb374ae430df1019c664fe742cfbdc2d435ac44f218f7c2c47142fb05528cb8172188bdfd81ae3fa1ca83bfdad5590d44fe0d14d84d6f0c76785489ea77cd4017def6ec6cf751b6146ba950a0234ac44907312c6b168e3ca355d78d8ebac62e5b8e6e62396b4f28282ad90c16f9793551a2677998664828464dfd7c73a4015e00d1fb2edce168c38d05519eb261bf056619de821fab71e9e3e4eab5a4561052d710700ad9872221981221c77757481e38fa5a9f4123399d24d89ca0b0d6385ce86bec400b18bfc6df8f1abd778f43bd9fe22c5bad410546730cc860db5232336877c73b2626fcfc44f0de1da367aa673ec31218ad182a5f47c7d7bbccd0a137d8f7a8870ce8f586687ce7efc1cd4b793381273edc8c2f06bdaa5f609b7e813cd3e6281aa233935627e3e2f29de2866487232e8c8175f262c07fd8b8ade7d31711e9cfd38d4e779b032d37d8e18e9dfb2503c3ce4dbef687e98609be61a2264099d07ff49b65c38c9bb26cd7079d7f480271a2ba0cb319afc46dbd67eb99eea1f59d63b7fd0fce90b349bfd6c64e58bd95091683a5c8f47ac08fbbbdec47de5f200e501e8d23b016d50e94ea67533cfc72d34220b9f2b4c58777e0366e07fe6ecb3f0cd40d91d5025594f7f8cd6efd813d5690d86afb062f5b74e917e580e46dc5eeca9fdb2194fe55bd88327082c07427b4f97c2f8669e1fad930ca61c797ea3bb08eb031e5c89a3ec584dd014f4806287bb9873a532ffa4d496f98f14cb836c5ba655b2f1486f1466037b018625b6c04dc1d4d6046f7caeb6c76c3b4ce6e6136cc8c5aa3259de9e78cf39ea273b240ae074928ef33f65012e795b50d8d211faf927f8fccac0284ac15b83f8e29e8b5be5bcaa8994f9aad0fb4fa454d45b7bacce1e2dae4ec1ca67dba3af43d1db21a004d10779ad207424a0de839c278462b245dfa5a539e16172435cd4efee33374504b608b30196223c3e7b94271ae39de96c97d864533dcdd0dc947c3a71c823e14e0952c1296696eb8be31b1e9eb2fa187502d475283b68e62357e9bb05c62e736b9771e523c312ec6e6404c65319453e069be971074a6cc1c230d68738248efedf0ae6720dea19e9667c5746f3e0ec6514936e60b8c152f066dabdafed95a4fc8fc9967fae1687e4d4ed39f2294d2732dbcfe4d42b4deedb7f1b508f73d94fb1241d501c95aefee1623182de2e7e20dd5e6b53df3f0b7ccace935df97982c7b45378876931c32c791382d84cc93c0b29dd64175988310cc5f2eb9ee4d248c58bc7763107493db8fa79a334f56364692e606a277941a9eb9e80ec361c67ad50973e8266e6735b2ec74145695d4d6b087595b20b4fd2849650095d1b32f9378bb8e3617d3b22313bffb330d99295a8dd729131755889de4d9a18685f4e5c82645c1f83efb599e1e8284d88bf9b4b368b7c7ad7a216eee8f013b3ca637f2e9e4d7f4983b2ab6434f05aa4f84b41cc7ac65321a135cb5a25866d368cfbd2053a04272d83964d6f639966cbe0756800290cd95e7232dc9b7db928994f3468c6b40e8f202979819ffa8790fe3e0fbd1d6bdf5ad43ad90013b08f2c0e0c6b2f05ff9c28d4c97a28525d7a522210b6df9bdaed0a6929cb766bdcc68894d9033ae7f1f6c4874941f2192625fc18c8e477032753984bf1bc75eae53487f2474ac059c8de57eb5359b7c242763691a3dc29b3b43b20d8ec5e3435955deca60bd4fc7866d3cab26385fd69de05bb37ba614e13afe1750089b8b30ea7e4d150e4faeb6c2a7e7991a44a8688db89a408dc461bfc21cca7a30e8370db44167a131831acc031bc72fc47085b7abf8c7b6e19e78abe813dc3f7c86f687dfe9e8a154c4b278dab360eecea25fa712dbbf0a26a98035a1e9a339667ddfba4811928fb0c4247ac7e03004e1ee6cf3840fa1d43330ed4115564ad58384ade66b2dcc1ffb4de23a39283ce662c9704c847cbcb2c4e5df3e8ddd9349007c059615b936f6d6c8bbde79a9cdae297820bcbf93785bbc5c5540a9b4f133d129f1b3c290c115305c15a8c15b4f0071efb346473f6d6769785ef2ecfe53a4542ee10dcd6d5e836276f53b8b3c978370e2880232494bbd54498ff0a968803d53b0207efc9ac6b5d73f0a9c3c232da1ae947dd3407ec3c7aea4b7fc41bbdb66954e38aa4ab5a1b4a9bcf4b1eaa6b131d19c096954f74f51c31cd62d0336db893d14c36a42d25486ca87a055ac5c66e5c9961fd58fa66dcce058ae37b8ce310d16cd2262725c90ea6053d951cae4a48097283913d039688a49f4b75a1676aebba0f4ec3c98373b1dbc87141f3b7c65101b512f4da3f04992c01ab3457210473a94507bc79d46a11ca828704c14eabcf13a6b950a565e6d3ea3b3b748f1abe62aa0974f82c7c5df2576aebc5c659c761bd7df19e6a5cfe37398d1b15636a4ee290ed136829a274eec147b6ee4e7bfa05727aeae05ebc1c01f7a95422ca01e7eedeec84c88c00e4137cbf5fd9dc8f39904a396631590de5d8e9426acd3a6e5df21edb3273b7a83c5f9b89d90e5a4942c1947703894c66de9b60109d27baa2b832b3fe6d7bdf31b860375ea4046fe7dbd6cf7915160c7bc889d0f649fa5144b5e12337588c4a90d9728ff60cbd02d9ba9a31dd4708e92b3232b2de954edcf4d98e32680b9401fbba0f9338194b420dbe6b9ceedbc29758d98f8d433b511c23b3bbad9be3a1858213178c885f1ef59729d31dce21577c6569be0a8be89ce766326ca19ed7c6bd9e48ff903c3dde34f94d4483fdcaea4c84f47e6f28d762ba139e157809047c791ea100adb9ec5aaf8a914277790c0fa78ce4890c1f5edb285958f715455eb537e44ed24d372b333d6fa572bc0d8bb33821213170134c13bcf58e2f00ee0c7b879b3428d103de75678e3e7148aac70bbdab87559ab870ef30fb27d1eb66c91ef8aaefaf50331abe9d823ed3c1739bb88ced566ccd5c21124fddf616d1105d1e5c680005c83569d3056c77920956174cd5bc5ffc143b5a7891728dbe1c609ba7d09f78e17e4691c720b02e2ef7e44cb141a0522f5206b8cbd6e1f12967ee88de4480e41b30b4ba34e78e1bdb67fa78919bf66f2a6a1c8a9c4f684d3610274c685c2c669c76f1365dc68b2317edbb766dcf003fc168846727f55d29ca2b2b8874897e3477774be75a8ae2faa740f60a9d304b350e69d23ee9b891ecf25006fc013107d75ab5c5637a42317a2150f36c8bfd7c597555ae28a7258e35ca3a109060eaa5f3b8eafe66941e69a5d8826e6e29b0446d250b413944e904cb45e74f2610c722f9513c3f6e1b1a33c432efdf1153ad97215070fcb1a6c0e588d7f9ec2cdf1dae83a7c71e364f1674f267bfe6f1fce9788b8834ad2a3c967a3ba2c0508ce9bf2dc9724a4d2e13d475289ff18f5a0ee2c6eeff607bc779cd130d092b0f238c857d0d78708bd44cadb28a00d1aa5cb9396c32d0a7ade5153c2d288a97e5df1db3030c80958f12639326fa4087cd97a86b70db43675c6b8683654924fe9adb71d0713ee73a370336b52647c3d6f3adb3f70fca64ec37aca393dc258888225d5486c9fe08906c992c31e6f75370265d5ba41e4ea75528120d7f86284281586fc79c2444d8ed42d9ce78cc2c5cd089a2c5b47af1d6cc848ee8e7c539a80cf75a39c768cc5c0abf21b0a43150a7601e6e822a8bf27fb8820ec22e46e35b7564362857f082f3e654fc9b9a0448d35f4d7f1fc884239fafb355a165eab9c289fb0a4df20a552ac3eb4a706ff4aca70dffad5a6505f77169b52e51bd5a64a38986bf7ff8e2e8fe9610ab01bc56b5e6ccbc8df2f97b7a39bfbc72c550f45f17f5e8f5c9f439373bb444816557a58cc330f2f4efb5c37719c22d0243c4966c4b514feff2eb4027540d77a85d23a43e981998bb83ea76fe8e42039e5b58d6bd837a37e607ab37ed54fdca98e5f6c876885b3d38e27466bd8f7b49e5d700d3b073fd456001ca6a01962417e92a882459e964d2320e02b362ce7dfff575fb209bfef4c5bc39da04045a78bc56575b2cc14a83c54f22f4062d0623e9fb6c48567e04797c47a6d6992d42e09bbcb777f585a12b30ceb949564ea57481414d8d4f1f3aacff49a18915a7b524f93f6fe39a759aea5423cd66440450e2d0fc1e9a02efee698eba3139408ec4a8f2f70d8e5f55f51594d28e1b2f15b2c4e1385859c8bcec603e657eb7615c58d4cdb943b23f48476a2c9e902e6bc4f17115d25ff88babc41f8b7a1b6d5885434125ec0baba55f5abca89ae4e2542d89e8adc9c9c74de0cb33a6e11870ac1f2f3b3b5cf8d397a544eb1d9a61c8299e07bd6c097260b044ee967b47c2ed163aa67b9ff31fd8c36d719e4f69f2ee680e84112a711254bc557a4d0a39ed5e5e4b269f15637607f6f6ea70fc1725a4d6d7c1aa73513c3a06e95f02a7464bd812e30acee9ef3b31268afbaa6f34829d0bec419afb2084dd20ddfe227b17fbc74b7506d08da11e143c90e310a655b35c3478bd106fbccb7c959816b2b649ee908607ce7621f36ddd161f85231e816d92b7ceb7a823b5c53a2dda11037f818574129013ac4f28a7884422bc3f3812ac27e87b7fe3c7d3bb02ab76010f927fc6f2e7d76b24717def0bb2c80d36a1052446ea9b8a68ac13a9b3a0beeffcd23fce519fdc131ee67037407acb4adb9210e2118648b4c2e190e246e636ff0d2262f92f3feabf51b6b0616748d7105b237c37d9a6c23984d8f5278fbf7e1048ba7e176e3beadf946c173c2e9db94b626346cf99db7cba45610b354750be3dbc90034577b87a6128ec4d93ec618e9fd3a70a2d0d086f80b3c0b20af757905f7c987d2c3cf7c4280f264c8d3748908dc1e7a55607efd965bf74e718e002736fe051b6c400760517e375518e46060e7a6bacc6a93e23fb2bf4a19c80fd1ad5ada70c18a142d961a61baff6ad63ff6e3f302c4ff552f87477ed02f058ac74b2777c1577d2b5649ece97e0f75e858ce602ca4026bb07cac930d1b6cdc9e4927d12824fe8ad886d73220dd49e1401b7d3ba0e84a399a554cf0d0e87044a2e9d1400d72d82eae59e459fd16a71b7cd62b6864720eff56db004d861897e3aec5693b379d08e2dbd2323152e5ea68e4a0ec082ac686c5e90d6ec80ed28192294ed990a81c69c10e6cc021001be76dea94aab865991a6bc9478cb0f7046a538d83f79b7059cc4e7d88d546cfda4800b3af256164abcdfc4bc65a808fc0ae5e7a2b0f2156c1f9e5bfb2c69b03ea8e2a72f3a4458e12594204599c452f8a7f911ca78287ecbb603a976bc6ce49c6e655f2207b8c7fcb24519507a4c431518c980e83eed9880f020d206c976b0a660743cb561c21ac5b4ee385b15ba206e414dc1f0b59cfca49829c19836f7bc6094733f0d65b8553cec2ab03a7638a8ac689ada91c41ba32bcad81bcd7111d2120cfb0febb92484380a5fb99401546e2e93e0e0c46f3e00bb72489fedf622c1e9721819e847020238f77d444561e94c2421d011cea0c76493b7a4dff9574fa135633113a40ea7ff923417269edce5b2ab74a28c832625df75ad4cb14b4d68efc5d9c2a4fbf2adc591fede7e4c3336f1d748a2b0ba253ae090b808218f531fbb959093f5ee2511388a3ac8e4c1a6ebc4ed13e5b55c34b48fe54459dcd98cd424932f45e3b95883a29edb16d3a467ca1859c8b39f6db384c4ffc1eabc354839f9c0970bbd45402ba3999507fd9ec287c918430ceaba54dd61c0537e7b740602d608e459f62500dc10d4d8c73348be728d01e07f1910c396dce9c96912298c2e1cb6a993b59369ac5bf858ee09acc4dcc5d9e1718f1d222559c40a26413229c0bb9a7dde9bc1b3c100c9d27c39c7e2b9d4dc3da7178aa2c1727fbb06c0d4b1bf97670904ea94f3d0a0cb6e7e80e6e9ce23aefe712f9ec896727de739525d8944d2874f2ae5b71ff6d4b54e9ae85943f76af20e1eed464cd0e0f314bd58f48ce8be5b1d6ebd70362d372d0438546db2727081c20f6a619b086f5342e81c39ed38f6572343b8b580f37d4dd4370b40a0c44b2497bbcc53bb1e0c29794a2f0c30b43b3986c84e7ee94f660d0427cfadc88591cdd8ea835cff04ec4ee42505ba90ce2266b38ea0a2df11cef07be01e2d77777f350f4bee466a0734f473b7a258add4297a0b14da626043cc339ac9110d3063a850089bc867f4c6d0b62856f7d16dca07cdb9007181be9606fb285e6af94b560e297dcf60f00b1ccf60f59030ce124bd0ee56fbf39f44b7d83d0bd877ab3f376d433122c1c30dc71679be3738fb232a813381f51fd55c331f107f803684286be5c0869ed66f8cb9571406e5bb34ca18aa6cd28d31d2b0bea91fa047360e5b0dee5b2659078404bcdfeaa9fbcd1ad6e302d3d558509a601e46ca1f35d08d8cca52dffaa60dc87bceefacae22aa885821ed5cbe60bd186a99146f0bee7304ac07439f7aa143e542b8a843f819f331895da3a78297e86470c2579bff33277ab4f1349b2e4ac31629bbebda9c01ccf8f423d95d16a46165c081549aa45306a839d256dae790fcebb22dc9879abcbaf3c21197e975dff31c86a1e490b4cc1b8d0f45799c361c4eaae3b35d82da71369410e7a7f5c2dcdacb84ad1631fa0f0fc94998e8ae0c73cd674f5b17578045d4091418c1788fac3a19fdec0c5c87770d3ac145ef1f275f88ebb5cc77e4aa0e247e0d4d4feec358de935045b611903c1b3c943798bb046a7ef95f53ea27b9fc62af5aea6b6702a897ccf1acf0c515fda0ab9379b4d6f83c218e6895e2a5af95f388be9daaab0a24a176d1368464f34e90e40c39c28120f3967249c3c6889deeb7587d45f962e361e032a48015263113a503610e15d3b8be0a46d1f564c7ee44c3a29a2f0097bd48427ca742cd50d39396d8222761247a2d441da17b055b53e38dc33ef3e7c3f9c4ffe14d9af6589ea0436150931a62ccfb6e2041fb4f0803607c2b1555f062dd1996610e6a8db7dcd885ad3706d7613a094763fcd7c6870ec58a5553d2558200dc0cd2efe30001264d71f99e2130f37f567f0cb5dd21aabd17339a2fd55ef63f47f0efc5ec82ca23628a6203afd545934bcaa7d1ef71aa65f4729f2bb5e256e47138273bbb01be8b421ef05599f5280bdc64f8d9fe0fb10d8239e7668853fb2f6e44ff7dd11ac3f8932de071f6102ea616dd200535943d3112c56856a0234aa05e5a1e24b35ea54a4b7f2f66f7a766f2f202a277c10185b97ecaf7096cc87e5d49268fbaa221752dff4f62ef319d2ed5c9f5d1f44d2c97f4a8192b7f7ac41ea6d7ecb7eb46dfddb17104362d73c96985632b9d1aee2b60c34d95bf6a8b145628ae1d280cf947c78f0dbd2038ec3fb03156022a122f5bf4a283a319b64a2d3073fbbbe48b46d09459588e0c8f03adb959af7aa95f83db48b1665f0515752097d9f9fe49ea910c43f8b06a45dfca21f4190184c85bd0cff23df781c5a81bea8b362729e775137f62cfdc4ff3a43b9060a94ae61b65bbd19437f1b4daac558651cb17569045bf616d838011ced157b4f75c797ccfa0bd11fd39e02a59aac0c67266ac26be46c2872a10d9e6abb6aa6f77a9cd3986400e91f5fc60c007ac64d661385abd7ca34453067db9ad7a8f2f50bb14d5c642d466e7e6256a9d9f28c34a270ec774480fcb7fcf48d36bd80abcbefd57f51875d2f6d88365d2db7dda3f894094eaafebca684ab3e37f38d7f4dc25ffec6b283025af96de74aff750f8354729963d193ae9b2087f1b5cf6e9e842a3147badabba363790c607e772440993f8a56d6b689fd6f987990c3a8662ad1fa91490b72b3ed0dc5723040ce0e6afa2ece5b923fc485f4286ad705c73a6b0e6af7716d8f504d354123bb63c55087d316dc3329c89bbdee2d328a496e6bd30b7cc5b3a32c37bfa1fc3e7c2929a4cbde77e8fbe9b8fcf41d55735714779b7453a45286945766291d341e41298b9b373300347f8cab6244fed0e73ca6c3926b07cfe5c3eeac1eb082339493aab7db176a9316d236eeadaf7edadc96299fb3117d939b46f7a3fc2ab2d9928e93de0611e93f52b07e1286eeea79d4c8b0606f390a370eadd4a3c2d6cda76436451ec4bd568b245759ca9b6b882bba4d5834224bb3bd6d46c05943228fd37073f77accb0fe3552219b4c83f41ec9dfc6d3110422a321178d4e8921fa618041d4d8748b46208ef53ee28f56d4373a64ceefdb5c9ca711d1acc76a141b738dc052ec3799d136e6c6bd71d72feae3ebb30a5c81c38cdfbaab71bf9d9431f82b73fdce03017b4cf0febb96bace7a70bb03332e8099921f1a0ac7b20d99c1b39ef745eef526013604188ed2cd9df0b85a5136b8424af8caff8e553a88f34bfed21139fca6d22d3ea90be1ab4c69134dd5daf7d3f6b66e4ebfe81b5bea23b63e48442f5cc8a362432b9a74ba1eaf96e953a715856d0ee2e11668ca4c9361599eaafdf9436f0fcea9f509489e586a44644ac1116e06efe59f1e91bf39dc43289742b5944af67137c23f16d768771cdcc7797d6e9571fb6db663d440ac6d81a03194cc8feb8d160cbc0003e83ea6b6ebe11d6af29efc8ad7d5191ff4a7d5010de721abb9b3725b6292e4f2e552a5fa973312be699a84f8433b390eea189315ff1b411301d388b657899c0b1c01a2e9e4be555a066381ef84f530a7697a408f9af070bdf20ea172197fbe9208051eaa25f7304b577a0cf292fd8d8559b4231edf25c65f58a5cfdc90c23b2a5a7186d7c71f0637c687f0629c3491fb45890f38bcee627905779c68cd3add037a36eda569e64279083907c0af1397dcbae992830789a7d5fdde336f62a3dc66c8743cb35bb8fcdf5a806dc103c716ea9ba425061028dbed6f6acfbf3259f1839d9e4102e2f9686920294a0412286d97cc19e35f5c06fe8ec25d4e7cb60452751fb3ecefc5e29cbd854249b9b7187de3ffc7bce96075120ea03d2e4d3ba2a1ce9feb360d77ec390cdc137933324dc6e9f60403403cd015d651dd310c0919179e828cb0382e3375eb6c47d9b8fe20537d1aed3a240688382b6396062846740dd49cd9616914c0fcc58a7895ad6a63ce2957069a382b0253d4a6bdd3900743ba9dbc736713d389917c8852a34b931e44e0c9da2ebceb14f5d8ff40727b7e81fe582b465ff1bf93fa703a49c5a674331112364304a5477f2cde3da96467ad2d655363ccbc1bc73dfb93f11f31328405996c8a99ea7f2e7223be85aeef6ff9949912df9db5c67088234484218f02c4917c09618dfc2afa9f0387ad28a8deff0fcafdd05d022aa13d2376505f73763d098aa1910638e0b7fddde22c39567b6d30e44bbfffc1307b0d4fb27158a4509285fd4c2fc06a57befdaef29227ae232cd8a0b332976cc5af27d331a86940061c12a5ff3dc79cc78506f867ab4bc7d7238a9a8246756ba6f61c5cce55d2307fc3705fed9ed1904cf1bc44cb4919b8f93ad055a45af303de0c0ce2d03f6e2a2200bdd2b5677ddbd5601ebc4582b6a583b9a44d7220147344bac41c9534b7792afaa0a25d337df4aafc5b784cf92841f88b45c66761c64af2d87a8a1660fb708a2afb80706a746353be9eef7e57f8f68c36636192054e618c1f2c642d71d7cb967ce4032d236ddfbba14114aafdd4fd67c202c0c53d2cd9bcc2895f98fd5e76d1c32298aba83c38f7a75b3653181559171e4227e279f3345bf3cc134b128db39cbe7fff6cba0e96dcf792ef96a10361a272fcb6841baf6c9729d3cfdac9ae8a832f81a1972bbd9d7af40fdf4e390b93475132dde36e665f3df03ff90e3a9329a1b06138d053e316fad77bff05db5d13f354096d37096eb1d157782533baa456d103c4af271ec3ca93d40e9ccc938555ab622a731eca1d2e7170db592e8dc6ed996e707170ff5d874775b775cfa8766c4ab176bf52baf48c94c0df0e82adc5d5feb15918e03b8b24b1b045e8350e42868237999448a6b252b2fc44b1014613a3d5c717edadccb7109c667bd846a6ba77da5a9b4750d07eaef267ea1c156d853bfbc788815ab6600625875d22d3d19cbc7ef8687eb6ee85c1958dbb5892f5a8395e4e6c16c15c1059f948b213a7b2451ae464d7297aa0ee69a2a727f3074521dec92f3d9e4cb87087a760e891a6fa07f0df30dede43160fa57e071fbc17cd11e492ba1cb992fbb3b20c7c55ab9ad0517458f0550f3a24df4144b71bc98a172cf887f5843f3e91f637c30d21bc5b25911b13bd2a84768b3911860da7ac2b270c0a091fab657bea6c1a768862903d0999efb71fda18c40f5ea026f2a683b5f5c5f15abc0832ed3b8757fdf3eb58ded31df985d150633fff96b7e1c576f58ed4449023856970f678cc566496260a9c9c114ab1282e8b6741b3be7129b69b7891065b265c3859f33025ed778780298bc7f5153eb20559ee62af49acbe490f21febc0bd10dd1272066e65cc80bc9a4c7cbee743328249e93af82d4fbe7d19b42d59058f9877dbe8196c85d248074e00259c52d772440c1d2e4db62d45b2f5ec72f601d2d04496a2351ba0c9859b59bba9a7f5bde1df3296ae097e3b7c2a9ff05681348c552269c68e3f5820e3c7c3140690a9552f34014fbcfbfbcbce7f428d8513644bc38692a34436e18c566e4f3cac35527e38486669c25935d7b278cbdb93f4cb115e37da60c101fe82f2011b49a72d50698c3970a6af85c821615cb16ef1c483b0a2d37247f22aec7552f44b1e087ddad9a360a19b7f07049a5e68ae91fd27e19ab3a0441d0e891040a22ec095462e923f55d53fe5ed9572312a94e7656789978839634884f298ee577da5c23c9efbb31e76d2b7c2e46f1a605633a4452a1c041c29995bafdd159fe3ae8152e25d957fc737db9ba3dfbfd15173d8ef68b43fb4d2081f5a6bddb1c6e7bb1f086a9a87901fa66573b2b55db85e4f6466d0bc694c72b6445091f8960aa5b7a8b949dc5dff281ccca6d34d8517a77b8dd148b5fd517b2ee2cb3ff0a8c2068fdb674ef938e2ee393972164bfce554f9892207d778f678cf17d125ceb01daaa1d97d568311bd21a96177abd4e1b14f0e070b0a72e276427ab6f76556b93a5b8b91ca6c40ba6c5d0ce1b7c1929dc75680bc7fb0913c7cb2f0a51677a95825b4049b1d68a6f45d9aa709d49bb62aa1aa60c1a1f0f25b1f837e9043f844d2998ef5e6a769ac0d5c4894b028fbabb8886e6340c591bdbceff028c04243e140cb335b32a7553e262086340551e056b7a06c8604b1747ba5c7895ab8076778009ef4e6ce40d65000b5b09510d6ee09fefbd478cc5ed6027de16ad1cc4542e4beaded5367ac02196d05b278fd316943325e9648af1901b04b280a412b45bd16d8c96cbaf26f91b902c5aa9c087be2376aa714b59e52b808b184e50adbf1c3e5b3946d8fb6ee3e6b3e266bc774ba039f10083201ea058efaae68c04eaa56e86a033381b477e09c2664100624b18e1ae3693f2dfa469eddea02b77416790dc4292a73d6b8edef7971e7b8f9a7578112a6500207d15400410cd2bb2e5677df351b2387fac422d9e888714b5d510af49d93f4fe9feb9ed87a8660d788809e2d5ffe845b4c9f033f8dba6b203563879e101fb39d507fc30ca696b9db269bd74f3c1e04c36e95f7f607c9ba2564f5b5c25ece75f8d816a4aaa89efad3c452ba90ef342dc0b067e6be8d51635a12f70492fbe3b8859f25dc1895068a25db719f75da13f96b2e884de5ed032385e2f2b317772a0c0afee5cf60918e3ce5a44ec66d75ae4f22deceaa99c3dd427eb5284660c812976b24dbbb94d7ed3dc4ce18bcad981717e7dd321e5bb3be45e94f8d4fb031ee06236b13f8321287f6b74d792f8d65b8d700158a85ce43d812164daef63acddc714a204fe64b489b848b1cc4d4f757f4748fad525a031b9f12639f78c347884d0d06af197da0893308e8ac0560cc975509d93852097586a0be9be5f0a3e70ad582ded8517dcd240fbb7223a4c40de7de5c0ee83c2621784060f35a9fb935ae27b7326dd0b99c16dd6ae9cacfab945a4db9161b9c0510e6010f801601e0faaf8398699d2bcb7d60387d5cdd6533be8913399211c41ff7989e880c36610de0f303bb26b605d40f6f3148db0fa1108709a3a04142d4414bde514db51f80cd13fe4f5291e70b5e2b695c64bee4c4b3217465270e158c35fd9ff4bdccad304a0aad12e0d24be3e70836420c6d6ab7518ae7006bf16dc7fda5c98ebe079e0cf39fa93f9c5c496f8fc48db25feeee7851d2224c976fd61ae6be0418bb6f97b637ea73a60feb5d4137e2686a45db30c17c8f129ee051d3fc7241660e6eb6b14162bbcd3f9daed0e91802d07eda71867cadfb4434973d328ce928f076f89426210ef463c879b2e2e762edcecf385709ce7270a80a60e170cf02580f80a3e36cdfd7f9282222d78691bde34a61106e6bf935000e4dfcdcfcb5c5f1c5e40f0d7eca4a3db67bbb91ff60a0afe5b8f6b7fa77e7f4d84e27f1d1547e803ea2dd838d48047cea2246fbd5586bbeaad0158bedb801d841750573e37ab95b9373ce13cd89aab2bef32d6d77ad10b158e564049a91a3a254dc78d57b77187c26c130f6a126a376658641e414c18a9cccc67e51f06e3aef4d49a1b8b9135541e2762f41e261e5304f51bccefe9dd508162057811c4dde16748d29cb458b66210ab58cb5734866f67570c559bb23d67fbbc8c336d4b7d9a4068d71fb5efbf8b240367268321249741e2f91d8a222dae135947a2262aa6e60d19e14027b6023947b7ff86a038f426b045009781826c31488cfa99e288a18d179379fec201fb61adfc85e7a4ed76f4c8401b5944866522ff7fd914a58467b88695c8d3b6df67f7c1a99d9821803517fe5caf714603379ed2944499bd710627d58529d95fdd76248b6ab16c9e4087a7806ac3b7ea6f2cc460991d8aa6917be57bcf8f811f5d56ffe5b8d66934c8a47879579cc58ebbb62b07b2a5a9900979be93667735713f8787859d36db7ae313fef0e05f6a18d8286bf898d19b50fe47aecb6faa559ebcffde3800f61671801dd9eddb139110b95aa12c995bb87930ddf99d9c6a865a85d515cea1582f54f1a3b8f77aa00a8be99104ab9c6741ecf9d80d5e617961b1b7282b615ba45ccae6d7bb92d4600b28b400e942d8b35d58f608962a46c43bcc4ed7e17888980e5a2c93ac3611fb0be8ee4d054100349ed0b682492ae7d2f51e1ff99975bb8afc8d9eb4e90ec45cebc6b4f688bfddb0aeed27e906b0915617b34be8d30ffdf2b65ceb369e45789848967c6d4534588afe2435c84797597176ee95ebf85926c98fef2850f390bca68fe2794db5c8d3c5816024d9c3a6d75662c9bbf5e1ea24bc24ca2a30a79820288525ed145c030f69d1a516866a39c99c74a9624388293a087828cf7377be7efeb3dbe603cd814368f07536ef22c8a6067cf35160017228d9f7181148659c2347be430e6f6295bc6f4b0550d4afb94ead69dc4debdc779d8e5c5a14e0223acf5e7429b472fa7b02e3d3d1b0c3579d22f520b1cf5a28fd2e9b7de784f245aec1a6b34a5d5c63e728eab915c6624b7816f5ad0fd3a9ace6507cbcc1f3c6df835a201051f57ba440cd162f37437e4dee8f8e4a60a2b498c31b4ff091b940e02d893c3916251301f48dae9104afeeb5f1db382c4c6ac3c74c5352258f71b403ad8845140811bf9463abb17677817a0f7f9d7ee8d0c759fb13ddb0e0d41310879742070133ee8f0477980f07751e077dc76aa757f40967c6c121f6241c9736f7d86ebf1ba23de20d29637607645a72737dcf384cd2c04a3a8a9212d63ab7adf1c26eef77d6b94ed8abaaf7a4683cc457aaf7387e4489a0cad391e185f8ce66ab02d5accb214230d94d19013557a7d3f48625b817316bc2e87090c9212df081fc4a0ae764f5a3ef8248fc68f4da18b62052cf65699e857a878493bc5c41f8cabbe60bb720ad8fdc2e24883ab478eb08b6db28d2bed77ab536872710a2e0cd44c4c2b5be5ee706c4b403fdd2cc004cd7df12219ca83bcb4e069def36ece563f30bef02858b1f85ed3e21b45fe8ae4d7a4f877c528c5f6719f36b6fd970050b01510459b154954bb77befe4f0a90c6ca3faac12163a197bd98a4506e572dd1f39116e2aac793b921cc462326523970f659cabfd14833a656a3abee378a1bba73a05f895d2ef23b3193270ef9cf1c58409f819fbddafaf3ef19a8d06dc7a68a6764377ea5b0ff345a838d697427c7e802aa0a08c69edf3636ac186aa0ee4db307f10786b2fd92325ca793bbf291cf07752ad6f704700670c4f0f6fda84994ab60feb3ed8e3f03c4ef5c63720d7aee331e74842c462d7e5559c603a7ba7d1403bb43cb3696c4e1be12d37852aa2a5b9bc6c472c23989b271e19b7b30a60aef73426aee9974ac3baa21ddbd06fcaff12e2e07cc04fbaa9faadbd785b5fa49d13dcb8a70b356dff2340093e84e400a804a238a9a84489bc89ae83d8afa58a4c4e0c4a0a3ae63600c9e4418d760005fdc3b1c741bc1ab30c2fece4d2026fd6e6960c45db638eb7b6ebd4229cbef3d312f79ab9b9c547a42c80e17dbd35ab048c4cf01c832ac45bdce8932ae833a1cb38ee7164dcc6c11bd6de8918fcd8e8c34d7ceccec00ff055c8b35ba282b3a30cc3648a18027804fa8b2a1884b0f5c422df1b9ceccd98b77773283cfa66d682ac8ebe881e5e813a6823196a7526fb4e251423c1ec42572f9735ff9ff4b4198283cfb99bbdd0d80ae7a8b24ae83d536bcd480ac7f08b786a09b1b50b90ba29825aa1bf28212ba97d56fa63bf66453707b2f2beaaf4cd415aa9726890053f6b33c3f98d26bd8abb7632d75f7a79ff197def0d864efc7d26629b5c9b4d3658c82a15c4230577f452759d14bb7a41b7aee2cfe977ecdd84fc2a614e8b9688870354e20d9fe1ceb11ef729f46fa01dbf781d94e88728873571786f9d202fdb56c3409368a2cfe492b0d485816206eb13a9a63928d359d3e082afd10667dc9523314e30ca84afbd9201c61b558a6e11ba19516c5e40ebe30aeac2a68812ccd325e9fbc96f92231ef6d530eab12b303dcc7e55f8ebbcf5ecbb1e2291eb48980c7db91730ee3138983c68c3729c7cf2d4f75755138045886e592d6905f9d340d71744700bfd2ceb579fce89c7f07776441e411bf07243ce86da7514ec8e9a36579b01772cf2e4eb31994ea9adeb86100d1e0e3106fc6a4ea9606de815a4b9fb438f2b3567635a37c92cd637e4474dcb0b6185c95dbf51168808212633515bd7a8a8c54fa99cdd72e584ea4aff7c84184e5e68828667a00f04d8ffef7a6f96620adfa9ba78451b1c5912280dddc69a4653b10e49d3407ee6e83daf1696981564a25e2c2d1f53f5dc2bf04ff2891f259b327b635c4a26fd7a717742879d40ffd1434ad2565e934bc489d1d681da1ef9d9758bebcd3b738f9d1da025785346fdec54e33f97c0a9400165f010d8a4f74d2bda9d0a53a607c9b41785a0ff6061f79b89ce632dad0d9fc553656854c12e517fe8f6a4a5ed1b6f3b28707855999d23c6cd7f283a00ac6571d0a2ad25e633e402e57ab7aadb15e3074470f5d7a8b97a43661a7cb9061bd7deb37f8f9b6871a3dec372ccf36ad54095a4a8f02aa1836c7060c44ef300fc0eca245ceb0fcb468abe3b940776f5166cdc7349b0925eb1d8356c122444fee95c347f9aa30ca189b912ce1585565fd4df58f95d68a7b7961caa215e3945359d6c823ea3ee74f6e37c2dff69ebec3b2d785a86d392c14395fb1fc90b7a693b40fe5a7bbb46c69251d3cc406fda89b5006858771cd07f17964d15b410eee7f7c25071a64e274461c2c09b79561c8d109bcfcdf6e712d207f9a2c91c69e123d8b35ee098470c894fc10a53b8f9c4d799b49b954c02dfda534025a427a1cf8565e978af68788ea25da249452af7d904c788b015deaaa39fa2fc30381a34ea082869f31dc05e75e4778666e85d47981125959f014f77ffe55feac37b447c25a37780c6ca362904c9a1d8f9f54e60998b8c7c6be887251ba6bff9ea52ac699e3bb09829cfb59a1d96df86acfd523d12c92259b554612eac4a79c24e5603d6c87bd4e7511a3f7275b65d23d8da8dbe77f4256b63e8f7e079460f470bc7eb5e210b7e43a56255aa358252132144b46e19ca9c9e39aa7bf0abae527b509bea1ecccff19ebb987877ee224b2064dec9691388ecce314c80c08c31688c14ab48ae1c10b7a49ec6587b563452747c0ef713860812a0dc29e27044d928835ee25a9bfa4f368af3fde979a1ab9cb2b924fba79c4690b2c32c106848b10388297f5ea00441476e2467a09b69e385d575bed8fe6440df967e0766ba101295e070a72cc1d3f8f763da52f3a5e05471b3432d2116f432a1546077c0060eb8f255ec4444de79e00305de08b878410522808913fc31a80bc4e5924c1e5764588b4a2f42d0c6e5394b17a9024d944f51b0459ba395e442b1d4fe7a9b8c6cfcee840a44c679b3a417917a750f66f4f90fc7a16d97b90ec584927093ad38c12b0b28c94c2901e92282885f246ada115552a41bac5fa9a8f213d373966415d81de639474e6c1494a4b86ce0703436e81cb259e5cca219efa268f3d21425785b37fbb38634c14c02a7f777190554571bdfdd0e733a649c6c30db0f0eb9f8ff0cefe3002fd3b1c99891c2ffd80031e09eeaf1db029d9355c2cf5498901d9b9d50a0290d0caa05c09520be7d606e4e7af4ebcb76d91ee2d9bc45edde3dfe51864e7737b1b381b65a0fdbd42a3c64808c9988db0c4f80861f0ba3fcb8804f184618bbaf4389fcf7f507785c200672ba8e0bfd0afbf77451459e8a12f7fa443d55691e4f298134d23c5e1ec145cdc42b132d6f60b2cab60d988ef9c5eba7a27d9e6101e6f82307ddf305e13d4a21c7421a1eecfbbde944159833d3cde8a6f1056c8356a7725be576a39f93fb2b087e9fc8f06ba9db9c71df64d71059b2d8222ab048e50188454469dab8c84f78348f81d0d32c46622ac6e2d187e66061ac547de5bcd5128bd0e1554959f80dd6bd5bbe2ea54213d3c7611426b69baa8409a82ec23e0414501a0883d42d87dedf15e92e801e717567898f2a122168dd346115366a921467b82f89ec14eee346905c3a069ac8e7893f520f45260a66f04613fb8231ea4555b72f9646993105b3d2d772638d14d7a06e79b1ec7ab33534c1caab22e2c33bba784bc7a4b7946e451ea8c2902cbba35727e545b5d7fc0a31e299dd368e20ce4ac0f73f016ae3a292526aef087d2ce5fa45d07a5e8de806a7a0fa434694e2e13a02ece1728ef4a577c73b8947d6411f7e4a84d8642e3737a12f3901b3b7134998d725644ca2713960158f76a9cf8d2ff94f4fa14f566c0ac9a441b987d42ae200bf3926d10cd4fc192f08a27e12b801a8b8d5ecb21f3c3c82fe442326c73749297447f0c19a6eb5d66937af37be40a3a1406bd574c6c619967f0d840741a5313e3b2cb5a7da1e2e75dd25f4d246f62cd97beb357347469ad184f641eff27547a54fe2070d72cb0ff727591dbd3f0df7938f7eb03bb462a426c88c875f82373ecaa3bfd2666320c88c8943de0e29b07ae81facd4da2c53839d9912e5e78a0b3d5585401ca7d508fad238d809cb55b20160e59a9bf42c9ef485f148c69223a073b89268dc4f4165bc2106a4f3a72035115a9adcad8a581a94c000ef9381923ea93cff3fe8f7bd734b6286b57833c109de9db8048fb558f4472c25704fe6a6bcf0f23822041bf5b70dddeb4080288d4697a6cfd41534fc5c4f5591f2ab83528e57b9e7648054536be41588953bb9156592ae3971492096fad2f970d3fe30df0f245d993d249830616a8dbe940dd76dce31c788dcb5e28a34a9e5b052eb7fe66df7990ae7f2a0fb066020a6fda9d0e9490173b97e7238e20e9512a2819ef7768365ffe7138f33c355a71bf463576149fd6fd9642e299fb28189da0be4e02f129133d85d87f712bbe891092e23cda1d4cb6749e9d0e626e6773a67ef3019cad839657e9cf6e565bac0070228aa2fbf4d8f0032576c1ca95c5e64fefa01a83e7131da69322b50c4a32b5e323389a3b116b3fc89b65b4e600bf137e6e8f35558dca7c6104aab667c6ad79a009e20a94ffd5a8e669d542de6d60d0341a6811f929a29a3d246774b2cfe55d139bf4385390743a8dc40ace60caeed5d86d7766e55ee9909b53365887a6597c501cb05f92c03fe9074245a63649d06519e9b3b3b42a15fe048475bd0e38b4331c2a0672201bcb9ee7b3d46e2ef27fa10be116e1385819725db2657ae70c0e4a3cd547a1b7ac992092fab0853f41559a04ab90f5edcc27ccb1bd1a8def34f3f5b234e65bc16da361ea298a4c2af09213bdcab38192a60239a679b17f1e3fbac3983be3b348494dbcb8ee753ca2feae144c642085f308db56bc9ad4962137e9df1a1c8d17357c5c501da2cab46cbfe4b0ce64405bbd1dcb6ee72c8d513ecfd974949ce718c08c91c69ca1e7a30ffb13b0c52ba139c1aef504981dad81c51d717dc44163c21ff35434f0f14c7d9cd6f3da93d311f38f2f057822b70c52164dbd901d003b872db6906c330bc6b974834d7c5daf40e567373ecd1d31c3700f70c2ab68ea5b36794ceb8c2e6513ae95d46ce81f3f52ecd8e4b33cb9486d4b45440bffd586fffc9fefb09b4976d010142b71fe68fa870174224043c4dedf90242d7ee35a1b6d18d3269407259c7b68d07bdf1a9ab3e3879596f500136b3b36f60ba5059c2ac2f705febaedc21ae15be544d93c6df5dee5a5cd70cb4b3f9376ffc44e769b64464650cb7cca0cace69131b50c7831ea1c8c99b625c2596f097fc6c71728c0ada9e6968cb97df251a9fe3e80d042be13e9403b1010f27a9f316d93047a8900b8a3afd73aad9676c7d775a11e39946357799ebbf83f9a6e9b74e98a7ac7f70813619a65204ad4dd3837694d65953fc8fe7ec483754bb1a7b6b824549fcc89148795d2afa20630fb5f4d558c1a42378b8214fbb0d817a80e829ee8b735d6e27bc5771083e99e83a95b2ef462d102adbc1aade9edb1932eabff3781e618ed39d853427e762494f659d9f65059de9cf3383f88baefd24961097c0e13b9b90995c6a56be9e9cf40fb56fc7c9fe0123d40ec9239ad9a09e1c33a7d7b8fb7ca6f31a63a5b0f983784822fd559e1c99c8695c1ef99ec643591230a884642d80bf5173e1b980e4aebf7de495011299b1687c21e1e90823b4814e1c094075874345df0a6e971cb65806388536dc344d44d48f7651909e27065c2c489dfaf9494cf2541ecfbe4ea8fcf75e6a4318a69772d67ad1518d077b0891540c986284ac304ec6e4be58d1377942080b2f8f1c20d67c8e5cd32a0d84d7519eddbc438df839c28b514018288699bb35bf433e3bfa513471519ab6d9988ef32ae56b93c0ca4fb33bf031c3bdfff772111c61352f101953dde585dbca0e8009bf4601007d3f7b6396d49bdbb0184e8e22f0c6fa374da4b1b49321e8a6be972525044a48c88bf775a60c88a52f58d654166a429382160a3e40bf4ca115288a10c481814d1b59467bce7047019474c9db21fdd17b1882bfba9cb45941ece03ed55a4e90d77d16f720b611ea423ef19ae5889fd67a35dab792446a8fc4f894f93fbdfb37f1059de777228cbb738bf50dddc4b946eea37843ee873f621bcb862461443c1ae3654a6dc8fd857f15b7a2b5f08555544f0fb7e8462ce0779c183ecc3f9c9cf3df2b6558217496a968b9caa75a8d2711a94af18937ce6cb41176e1e6c1366989ce0d6b4684e42ef0546b3afef89e2b12ffa4cde6f8a659afc16fd242dc2147a510bc4eb5bd8b69aaf7b6c8dfcd2aba11abdec0be7edb84e5931656f5f7006a7d3f9e2d75183002ca4762ecbedd82196f1dfdb1760483b4070e62d95ce0d01815d17600ce616173a6352813a70d5ee1265a83e5741ae185d999b13dfa6684c1ac892ed2f62b844ec35a5567de1960d109d161efab003977c73fe1e6a123a7b3cb59a5c3572a3807f372f053785c2797068f5388aa270e63813e40ecbb59d0944864b99abbe68bd5e33f035377caa0fb97362a954c6f1358d51bf09dbde323b1f59b49bc38cb2d3061a2f07fa178e8003a979120e098b4c312a056d1d9e9bac62f3d35119c926764d029d01edf1291a6a54f9366364d7483ddb88bd45fca5c7b2a3c94fff129d168284dcdd755e96f6ef529f831bc1b6733d66bb625f916eaf7ad22e134eb94e0e532ebbe8ae65d6aedd84deada045633d46af1200c8f9b58ca07394448dc8996f23fc50deedb3d85982256d91d560e94b7d82109a2f17efa26b17771d7f6939f854052e157d09ecdeff7dc3f0a1b0561a83f3f2bdc0aa6a6eb4ac8b4d579f32e492e9b60b4bc34d9ec537a5e8a40db02deb4414514a1022eb679517d31ff07dd879a7d7bd23b284290504ad7aef92a51a8f64ec36006b9283dbb5af39065c20bb02c73e688c70e83d50054aff0b98b351f30f88815f045f5512b96c527b9371cd1ce65f4e220b1b6028f3b13b38ba5d062a724137ccf5b87943bca12d56f6ff889405e264a7d5f783374962491917a6ae316532414dcc7444f564676e5bf07c701c977cf930b159aed1d9455adf379c33a3f198fd2b0aaa735ddffaea0e0c86c2740787c39729ac951181c9b71bb7d40ab14c7644cd2c91a6cdd1f95647d1ebba9c3d64daf2e8886c078fc8eec4ff995fe7fe76d5e19de84d1c72bf0af4ab130db354b4a11373c8167dd6f3fdb95c08b0994345f9eca4fb5d71074ca6b9052b1b1be1864c5d8f9fde950e325979e534b621ced5ab5b86283aaab1c1c126013b43396df3abb2abc2c36a3d7b38e8c4b678ea6008344f3850c802fa998eac2fce1a563a3d98eb86b7082ae59898e9461547c523fdd91043e4454c346e576b4b42d7ed851b8fcee7c9e744a2906243b540e820d966c42485a6d0771529fba15904ad1db4b83138f0227a8e19b4037367c066bda5f079ad2bc3733509e4c1630bad8401815bb7fc3d92887f9f4f1333ac7d612630fa6f31c59eec045be10f1f8c46767ed20593d7e88991c5db41e77fcabbb1577e81b36b5bff652ef6ae52854488d99a88b8812ab85ff739f1dbadf274759e0231d700a3a750037572000d43b316986dabf413ba8f9bce3a6015fc97178967e186acb2fed3b3f48acd12ad2edbb5e17e5d503d35e3c44c102e2bbbd8389970d4195dd515068fa5fe993ba6df61fb0b42cc837ef89a964b224b2fff5f9263ceb10a907f27667c8dd4c145efcf0e3a65d08f00621ae31f7cfdb9f80e63e27500466b18230224a9259a93d2d49c524856319563fe76b3187fe120002e9a64800a81603bc46cbb2d45fa5c4ce94ccc1eaa81402839488fe6ff2dde5a8e1a4e91dc206b52455abcef5cee2a525ebed689577b4c968d162043e9d24b3d61f51f8289ed6e879866129b34eef5baa773b3ff222c078ea887c919c9323ef69864e86af906f786bba63263b3b3f9ed9df44cec453687fa3bfb87103b28901676d8d6aae043226b9b0147e0bdfc962e3462685cafc519c47d578783e82e0b832d4d232483cacb7ad275c0aad303366b26cd7b4ab35e7336d7eb8b62e3ee3d98d268adbb77f8a69c8a47d86014690701850c8fa871f25931769b3fece24edac1a25c9a3aaeda9019cbb9a7708b7f7ad76f0764a4b1101937a590cfe15154d6f36db889d092c460f52d7998c907b28e42e393b218a69380c15b651b19c720ad3b61061770424ed092aed2a2717a219e371afd04b97cd8145baef7530e6bbb32f13f17dd0037fe65db553a3a06ed6499c980be74aa3614e2a4e590060ad7b00cbc8893d9569c530a0fe7416f5cca1030e62ed584b1663da24e7a9704b68254e9269ded686984ec9c188ba5c54e1ca861b6b2b23751c05ca86fbfa72ca55ad499b56a8fb8d5e6f8762e91972544f049a134879adf4c667910f02b3d059bfbb200e17bcf220cf7dfd83487749643ad4fc21fdc149b3ae086a6eb11ed12796c8d5dd0b0d9b621364c23e778b9e3620e468ff49921565a662c42fe3d9eccd5d80661846daa6ef3db2fa9505ffb66ac213a013738eead2d6f064139f95e0f16199f3eeea8b4ecc8f16cbd543493a9f674df8e717b9fb70ed537da9a75599578abfa3fffbf21325ca4d204b1a56b4201397cd7de3d3a49db5053572166dd523cf2ed52f6ab446d48e9709e9bb24bd65a21ef341f14c1b4b0720dbbb01241ccfde2007eb3333ba89afcaff1ba790a5250093a6e5494bd0274ffd94e83eaef096e8d1a3571b769ace5c2226b2b479e934e4551a179699e71e80325d1902a692f79dbdc08af07b32173007e9686dcc607ffb53e59eb5abcfb417a4b22e7bdc72ff3f8785376de651c7712186e5153c4596fe77488ad289de6209ebff4864539cfb3f1a871f9a6dfb32152e8ae8548ad8e41ef2c281f7ee408dad0e51f2cb02b12d8d790aec73f7d59549e69ead89e0473dfec8d76a84f4103b8cc4adc17e601d2f7c77aea0c6aebc426f76cb18b1845d51d6075f86dbc8b5c0d96b427014c95bbd488bec7e03429180134bfa4f5dc447dbe1cb744a5604aa6be56301b6e287a1437871ea7f8261d38e1413c29073ef54ac0a883ec7f8431a952c5b5ecd337c8bb417a0fb057bb78a56e448302f24789b35b35607778c8b822bb2e843c0befa29eed409586ea48eac491be8dd53f6541be46f5700bd75ab392ccae1ad1126e482328a62a32b8a76b889ce884daf2ec8dec3a4b52887535aaef9778caa72341121a99dd5a4d7fb90971b88f54b4c7757cb098900fd1f49186d3b7c45b4f7311a5cefbf7095adad9c840dac9b1f3869af011bc17546c4150edab430d44d5aa2b60b83a5c1f804239c2089faa4216a9fac19395ab48cb0353936cb9383aaf579a20a23f724b12c43094a8800030bb7eacb97db0298af08305199233a47fb3a3a2c452a9b7031ed0c9d27d1da92a316cc04f031445d49bee6c1f697de5d855cbd3069e060bbf4c6bd78193f83184a6d444ed7f662f2d34e1524ff26d528e6d36daf7837431cf4800193eb1c62425f9a2f3e08cc5fa53e293cbcec462bed63655b60effbb950750deefb0d6f9e0b507adfb246d3a0ce0722618fef267266f76ae31d5982d0f16944fdf727e333366e506e9ee8dea8d000dcb9c0d99177cebbbf5655441a61f5c9a874a23678cc0d7c386099b80478fda65e3e54d84aa06496bb9db62703d5f0b7c6b9877882968d2428d9493cd4ebf4701784f4ec3a946e42b305ff996a2e3f14580d61348a56dbe63be716c9d7257971398004d32899ff7da2473ff1026abdb0f284ea06f648ff4940a2493a02de63beb52d6f653af607a0f206f2d9caacbaae0f26a540d56831362ce8fa801079dd5ceecfbfc756b9bdfd87548d1520e9370b0745179b9a93dd30f351730a29d90563fbff4e8376b9b316fb858043a09dfb36ca28cfb880a90b411b253da5843921ec0014507806a98f259b0ae886a9c7d5b80b7fab331e9d4f3a9a03cb2b5bd1943f3ca8348528e76d92f821cd7b1b0ea246107e3ece07ef0abd9b02890cd27204759515d02c9f9db760ad83dcef3b47e507f3324c295f3ce39d7c11cd071e7c5e3bcc0bac02ecb916d89bc03324f89cb821d50fa5f6480254abf9b49cf19c8c0bac0352ec4f0413803ad2ccb8400936a0af25e554f1ae5ff193bc5b0c3da8b0f5d7c8037e8534a9c3fecafd2562f345ff121009bd402d7cdf9c1a1da588b4c9b7533105202629f169e70f8e40a60ed222ddb74df129021440f4ab9f4b33cd9f49c967e221678877c60a6f53b1e1e6e97f56f44f20dd0c43e593a060f4c42d95d8545c39e085b449336b6338b6ab99a4c3a0109038ad7a52abce20a261ee9707f1bddc873c9b1d7499c54fb91dc1851e0a24f0f0cffda7f5443607e37a7a26c0e2d90d4c8ceea525c74fc22144c36c670f89cd09f815c1f3d39f4c50c15c6b10d812a91ab2f297df6824035586a63afac079e2b762c62b6606f0728dc7037df0c464509b3de48c960129f926e8f730ee7d6ae124cc56d5b759896f78fa330bc33169d8ee7ea58c0642ab4ecda75f175c4de0feb876ac7b76f563e6dafe2fee4d0148b0b00ff58a45fb380819eb53ca535000c19e546014d07a6dc6bb57c50f5353f44112d3afa8c2f694e53e434995269fb70dac7989a56a140c7402afc120e11b53ec232b32f0dd086fe495805e0fa056d0091c20ec7e39e35b01b56e4285207607c52ddc8d87f71aaa3628a136e843aa54dd78ebcbf665c4a31725c6376b0a00b2b6cbcff94ca40e65a016788e019d25ec7a2edd9ae48a1f4bf3465bd59a1e2bf79eb7d285e3b7479f863e9d326d4f8904987ea97bc3eda31488b7b85967a546015444c85036e48d740a30197b5df7c4e14089b59766d8b7fed8251aff6175b8302bf78e8c9002b3da67307d80c73066005bb7561a8647b286fd5b3e4e58252af327377894da005a17e46e1645dc5a8244bd1759551817b5a59450bf387c727ce1e0ab7862623ba692e3c24d60504739c3bdebca306fe5ee7bb2f0995aeec4eeb041be0526fddc5686f998b9bdf0437f5b293e33c68ccae78871e2d80e59b8729da4032405a8a1116552cc44c09e6dd9cba599809b997d626d414701eb3f570892625ad24075e0dea6320cdb65f1b65e3915d8a2c6c5b975a77aea0ebdc61dc6232423c991cc921fc60db869eb31763f750035517359890d379e98770f55f875decdcc27289f478248a2d085a9092be5a6761269f84b504344e0445677e0db57ed60139b25349655c0625a2b7262b8599b5b2b531f8181daa65a68fd621dda9bb99885d7bb6871b459486cec104eb5076bcfeb8954e099fc45ee851bc59f7f9aa82f878e0f3aa3dd67b2f3e32aedb2a0168d8b78070d435dcbf08b2a7195a3e87d79bec57c929367f0d32627f4f0e4ea99a8b255f58b8cec1c26f3737233f9b449bda793e6f5f18e22424c8433c80d444e896edef86ea3b8ec085c24f9109a7ecd7455baab2a26e237345837eb159d0519f0cd62a9a309c7a4d06f7a2bfb12f23cd4f4d7d23a9aec272199241f0b5d4e52f86ee340f725d74d5d29454c76c08042f6cebc7c3ec922d8e46d959df6e780af2ee65504ec2f91d9e556af6cdb15f31b073a12d7d0675ed4f69669d5da73569a230108690d0e183e009ac455a91c7d3ace9796571a7b92f882c712a0ed3f1caa995c292cca34bbc21ec07f033dd0cccdad73f8b4fc4daa9d062d9a656f01856f3225f17c57d321a2e5a811ed621b29558cd7794551de989b5da3937ff9374ef173e11ba34753f51b547b6ca5615cbcd297bcf673f9fcf9c4106bdd7129c4d857f2a4c75a4bafcbb8404d39d77763288c8b653bcbe05393ba1051751b2b83d57e583091ac331644c74f58798707af2232bc50f54a9a06dcd2b1f1cb25925bb113b049b2a8b4bf009439ee883b450c467828303eb41bd3e77ee7b3d670697678d939606a62cf65ccf4e6a2c3d98462f107d287bb168192a0c1d9c4f2cb847e60623296bdc733fc3fe509555e703ee58bca89f156e05e1a4d248292f366d8a9d26d0a07a590d9fb624b070cda1299520f8b02a7ba4f3e89f1d476f957a7f02dbd85ed79cb48458d953fd49ee97af80518f1b0b1344b5b78e9ea72d87b1b9efd854da15c40bcf905271cf9906ccd2a592e664f941efaa331667713ac13bcd1e64cf9eac8a3e885ce7879b26697c379819dbfc5b94abedce184607d6a91d08b8e21acfe03902033f755085cfddfac6550e3a9e66f7f929dd7b24dfaf298ec2622e374e82df506cc149b0ebfd5c1f018b3e1dd6897766178f61f43bf8275feed0543bce87901582e28375f72c14ec226e5b3140637bd06b9af0af1ab77699d2f687e9fc8e9e795b6e376d4f7d1c3742dbd65cbb5b2ecc4d110b6184a1f7c0cabe0b5676879e8314c9832e01af999bf442b888c6dc51eca7fbcbb1db53317695cc2f4812a79616c700ca4379d56b2fd6608af76eb1dd609015c50423ce4ddacf455877dd37e610620f6faad739a038b473f11f043648be89bc61bd147bfb101d3e51c67a85897783447081a39b639f4ded6cf884f3ff0cffc26d58de5c1af192ed80cd6702a60ac3223f8950917b04dd67c51fff286941a85e8912af308efff2c8eb36e61c4307c5564771feddd8c26b90ff37cebd7999eb5685ec75af645abc1401b150375b525bced789aca71e4ee1f585547f9b5e6bb87342b02f313768151d401938db8f437bfeeea9779211a742b19f3507b6c2ffbaa40662e1af508258b501904bbcc46c0f9486c926eca2c3b8da873cdc106efaefb983e69cbf37b86377ceddbee3fa88fe6840d29ee67bdeb2fd9fe9bc127ed766c8c86eeb7b98619baaa592f3382d246b5478f66e638e77f58fd0106ed8d16d0852104dab6ed0f25fca6921382180ec0f692d55fccedbb8549ece6d5a12b9c706e0cd9b24da2f7ba6650e7aa6efb9024a2a49d85c760b66e927e6bc996681e48020e71b14312b7848cf8e0c2d297f08955bab99a5c89bedf4c318f8fc022a9533a1502da4077b00ae2af75da2a1da323fc6887303a411afd780f9d055a7d8b625d55ddb693460c124835887703f739c4fed65fbc9e4fb62d3c0466ab62b84bd5306aa6084c3f098bd291f102695cd85fd310b371ac93de94fd23c863523b4146dd2bce06584d7c7548f295023eeaee506d5b1c21c2ecffbc79655ca89077da0cb53b37802b145fc2eb734105af9d26dd2a49dfdc3227644c9af53f4554e63a2272b0cbc3dad1d2ceeda518af38365e7bf88f2dc5163aaba268f1fe8c8aa33e11e6213e8376a3a3a3e2ea1cc3a520e8bcc59774bb410ee7bb6c976a76420703466418211590f191cfaf8a1a784906d6f5098e994ee0ecb24842a30f2f6ded7de191e5b0c784c5e39f9f44cc9f74339d7ac7e731ae4d009e3945a6c3c396752718348f18342f419335898cd108f086e1519c999eb1c7066e0d1bdc4c3459703270543345180eb17958ee491fbc19a258595f1ae521a65363a4faf79a6f6ed8e5a45db3aeebf0c73f3e7dd34ae529ae9e7e66a23fce943300811d2fd13a966bb763813a1184ae3db2bb2fbb8a9b90e8be96fc108646a242c8eba629ca27243b4f2f71ec2449745256472e009737a2f828b9d68140d6a36428e9369bcbf38727b8bdca29c9eb3798a945c7a3d5a4b374cc5f5bb0d261f552245a8a7c5c97211179c8ff3f4c2343d8131c23a2d303f297a88b92026862a271d864dc2a968cd75e4f369ff8f16c3d1a65ba842e7b5742b01fbebfc6b9918d0f723f86f88b4b0fbff5ede817fe302571e4b47ceaa89367c6198f80d790d80d160ce7ca5da691b5a58bbef608a08ecb24ec7fc1f811dfea780e7b957a851c981b869ac9693d1110d9b3cde3875728ccb32faffd6cc06b0c81719408dbde0dca944688968106de5cb3116d9026a94cd0de3f737bb98a0b4443986ca4991965cb37f4f4a2846eb951bdfa12eb0093e4db18198f152595cf67452be03b284267c97b325444536b0c5c33bb1bfad488f3d1fdf0544c2a898208f32e44e5069f389cf7732f82c35a056bb10bf4fbb02cd7135c3d371bf584f09c360a0ec4ebbf1b84b62b0c5bc18abf9ac9b376c11b556cfc82f2108f8eeaf6fe99a4502fefee9878d4067099d57f4aea6b466d5c495d201b1b55e1fd5ab392a1cff2645d42cf6cdcae6914abb40ebdbb7aefc5d464a91856bcbf9586aa3d3c649861c981eb341b609240438f4487ebc13ce04de8dfa06591d7f0f672efb88d7c488866060b9fe39f1d679e4690e6344b03d32a54508458b18eeb4cef8e993bcd3de3aaf6c4c2f6ed35c55e571fec5a2a18ea7e9ea21bffe847903a3ae68b4d9b9e5623884f2732104ff8db56af26df992a48a2953f88a80b589ea0dfeaa98bd40d45e0edd9b78373a9ec5c058e82ec4fc91929a316523817ccb5a2e8ee986732de6b9ca93a737a7b3eb8b26b83cccec7c7852cffcb1ef5d45957410d50e08fc516f1490cd27a4bd4c721efcf888843215a6c1c8d6a0e307f3faded3c7b05a924364abdd68a01137c52e98673db5ca095c850b0e06a68b9f1608a5574bb8dae99747969b80de33c6110da4522199404815e03b8995a5504467fd184c5800495f2ce04b256024387d38156d4cbe60da206ff837ef0797d809c23ed55a48315c9d47ee2ddc6ba5970cc8f6bc16074ce69a0569842742b2316a56e6c835281326f80a540e0cfa90654117b3c4758f96111535ddae04ea202b2b5e1a71a96bcfa744946d9d6e80b3baacf5df0ef3e9b6cdf83db7fb6fa7eeb98ae66cc11c9d5c9061e05094d7c854081dbf250d250cbb41a4fe79b2bb5001410b44359ac4c1df87fcd007c5d8b26112402c2f33044eae29bc56699368d68654b695236e6643721a253abeb23c35ea413f877e9ce19b29d2d3c767cd74bd32982508ec2b0b52cdd693d6cf9095a6c4acfea9bc4f936e584f0fe42832cc669c512148490abe754c3c92fa48e853ad5752a2dad964a00da8d651a2943625d057d12ced28e086fb2f4acc8802acf7e6d1d959ba215f5ebd764d22640b3b80eed0c734c51046b87a6b93b922db7ccd99e6250e3bfc2b616d6f46fc58a2a27031c53fc4e27e99c7089d6419f2c128440edaa46364c0eb970675ae5f17c2649829a7fe7985ee2805eeb83bcfaba1ecf128e6263fb54d2d40c27d5bb7ba93a977f2366b271ff4fb0a87279c77d45e264fc0e311ed3ebc79439b403c3bde55d3c89c35bd441259d55a012541ed899f1d55a056aa245dace139a227811ccbcf3ee07a814197dd65b551bd79dcf3a9032ad5e59dcfef7f042c7c34ffd086542f73f74b67b8372329baad25756fe494adc90bc259f9438b2d436a38513a9d53a178cbc3b36ab91ef5a8935745eb024eb11747c24c89140e1e1863f84f03bf164375e708c144a8c9f0aa973fab587c404b4beaab9b223453018277562079fe4362b3e476278f6a102328a814e8e98967571076e61e4ceeb7cfcef153fd8cdf87fa4879c2417fb308e20a98d4d88d29d79d74e99eaee41ce8bfcf3b095b4039402ceee37e8a51a0f1de65a359120a88058ee14e3f172c3239e1a22f614274f1a75708340bdf2a9ba21b9e200fdad10261f10ef564395bf9b272ea4a8f37497845017081b1371c871cbdc8573c7e40e9a42edf54ff6b62c83e3040671e977a8267aa779ed6057beb63776dc8cbb02b629fb2b03921a8cc22ba5d68e401530437640726621e51bb2186359cfb99807ab92105e18b74f2bcb9d60571ad4b5bc80d1dde98bb6462995f446d0b82cc4b4d255cd00deaebb81c218d33411777589f0b5c92a3e227c763892504c593998002097cf657195e90ff7d20293767b06ef32df8c8744b77c921980ae6a8b652da3195cd7235a500bfec2e13f34ccdaf3392901d563e8fb3d85ad9f22a87843b949caa18d8ac29d7c4565996454a47098dc3e7f915e04dce41d4381135e1dedca151b931eb0476e00573e54b55581af6d3ec2cebaff23115737a51ece5cb78030df22bfed6854090e423ce317ef0dbd90c433747475d38d66a700e49655b174bff01791e9aaa4b1035280e8c65a648a8e693b880c146dd661de68284591b49795a36bee6c8de1d1005e3885ad98d2ceed05df80fb948dc7e018e60af43d8e2bb83a212848f8e09699bc5ea90c2a06d002b0e076d6df045d0e42de631247b785a4453d6ec84af6c69c301e69eec05378904ec05d6592380224e73d9e285632928a0204dd281426a0f9205c6c45951e0b55db80bbb86e65f40c3009486239b617f81f615310695bb0067df41524da4f98f251c7be5435ea6a2b6d842f0deb0d800fba3c996377202efd90fba73097186300d6dff130e35eb8b640c79cd09781abba623ba9568032c874822ddba2ca2146e8c76721cbea3f98d320058c679fffb9017fa96bf21c95402f05b312d55d6d1e781f1fcbf240a46708c5959a4873de63ef98759909a27a79c45ceee2a921d82dc23efadc21ea5db44b45fbdd83e8daf826e863a8734891b13d877c676d0d24b6fb7b7b8351e6c2cebbe08769934d9d14453fd66c3e9ac52b6f1da55bb4de6c143863320cbc0dc5b69ad80bc43ff69bbc109b30e2f19f968deab37be1b22cd21afe3ad126ac1b581a81ecbe2284ebfabfd05fa0941f33c9c264cbd5a912fed3da95bd43edb4109155cf14a2847224cefc5e34e7ebcf0aa3cf3aa29755d2c3ffbea5bcd16010de81c4716aedac5982bd0cd67a8dc3d94555c12b097f7bf03a1732c11016ce81b047e83abec5cfb0d6f4f42c4d389f0fea9379cbb1a47a7df4c93cb6d56ef858704335e3248bf05b48ef671223a5b71bbe7e9f3fc267e4c81849c393b8cee0d51df10ff91a58abe296dce3d137097fe8c9815313150ec8147e40bcf3cf9fceace6e72141b7d34f8bacd17a6979655eba627fcb85fc28f3bb970ebd816de50ade84d38dc865d340d6ea2b4a6e329077df8eea81b2470cc1ae0dbdaf55e45fce19981e86ac4c069f0ca6d597a78c02511acb3adc2c23e5e56191127afd0c44e4d64d88b3790b3e8b82add4d3626c8b09cc9583d18c73123b49b4aa61e7aa4b49bb67f280f27e6c138ba4fd8e9bc8dcd553ac44d1c0582eee2473036be15a58740f1ead2d0197f8b1c1e7701cd20ddb12f3c4a5a5f007ecdbc0d4acf71a5330096732b5699a65dae495586ce30b272b98abec57c5ed1e3f3a57704f9c8c95ac7823c110726aa0d1b5963ac74a1868fb8d27d72738abe175cf9defabde8c44441faa075d260f3522467c0ff10340e25a84a8f88477c2306c56093f3658286d5fa407a625211eb62070254742e82780efecd1c8c43afadf6a64f0240966b06616f81581f5e354e7001b0d136450fc44a3527ec51dbb5e1d6fec1552acb702548f8d3a08b318b24b2528507e9bce87431ae889374fbf8c88ca7ef2f3da4b855ab16748b92709352235cc769966ae2099980fd7679602dbae6049548b25fce2019fe8a87d1bf1a26e478dbf8d1f5aa76df3f3dfbcd74e46b22631685b2c0fc8f048877fe949f8978b7e08becdeff5fa4d049b909b1954584d6459d2e2971fa2d69a5064e973fa74dc3d3e27a44eab167623c13e606a833905774b785333d49f077889fec6fbf469630edba6ab5f59e00b5afb7dd744175db01855da2f8507d3c1f8a0da6dead1e6332d2f943848fac7c5eff4e07061d4dd094006439ef997be07bab949bfb9b6cf18f9fb8886ff5041b1600c020b800dadb01c3f32ba422c48dbb28a464e12e00f50fa24778a6451c1a8a6ae4d0b5e62c7fdfd7a2c4afe27e3ae572da35328b6789d05802fb117cc285edc30a9e21eee4bcebda8ff6a0c7814ce2cb78bd33a6f30c8f147ea7d67d0ce9fdb0e88ab399f02adb48111f38c6277755f1ebbf59a3b5b2ddaf6d391dd75809b6bb34ea35189fc5e777106e71cfe77086f575b7f67cd0afd43788b58fbf26dd03313df992b6c5b8b6442814bdd1be663d0fe3e03fdb46e088fd23881f042a1a874da82f1ee64f241e86fd8e28f4aa6bba06a6aa43e1cb52b71b53d8b94289b1257ea23f4626713fa041975de92985d6e85fd26c20ac3be8f611bef4d345fbe2a08317a9c5e348388541925c23664f32dadf50c185cef52cf439834536cd235d1585d723f07c2198aadbf2617a5c87a2fe5e1a128e83b0724fda666dffd9183112ff0e9092741350abf48bfcbe81732439c4b5fdea5694334290db3c696f43afcbff9a5114faec9b81977dfd2acf6b1ac94bfda8a4a3f9c54a1fc3ccfd866934d00c280260bd4512a3ea8db33e39868ccf2e3e6ec3e13c911d3cc97f7f5123c22d025c1ce76877b5607e189f861f3905607790f091aa2e4972f1fbfef0845ec7cb209ae990e2b726198ff0fcfc19fd909feb79e72c4f38bb0e3b1129cff875c77a1f777d4b3878ef03287a90892789cacf55cacccc3d1aecf1be6283db382b8507a83ed3cc0ed2af6ce630a21ebc277a85dc970a59de71343a0761c0ac7fc6acaa756fa5b461e35da5254fb90d2930fd3ff27f43b50938e3f7d3b2a2c0d99f1003af3084170c8afea780ee9a6e3a1f62cb275ad502a981ca122fdf8eb2018456833950e964192c5efb09228deb35fd79b8cd1b83abe3aec90b0b03d21d715c12cf2c075e496ef0adf6b331f438eeed872b6f6aa8809bea4c4239d03e257aade53d203119f29b051fec83a394293c7e792aa87cd3ece960733c765d4a9a301fcccd49c5aea86fa23f04d8d40d50e3ca81b4deb0b37dd8740e9b816afaf5c3705933f38fa97b6c8eaa5f3a8b7d323543ac279c378bc4550b05f74e3495385278c8abdbb9a96938103dab5ab51c6d81f7ac005b0c695af259a9f0fe618c416e2f9668aa6ad6913bdbf77e417390c601b52f31f5f553c848382dfe880c6068b473b4bc1d5fb6f0d920a63cf19cd345c5611a33bc1e1371962c1824776307b62378d265a22a324265e5aef1db9c63cc53592b6e425923062703bcd01f240dc3d97666e52fadbb8f482d1af2c1c4a1e56a5cf5e89b3982f1a45f7128a0867d0008bae24468c8f7f64d5f0bd07af6f48620eb2d919d1c8b26752fb6ff7af8ef1112ea138bb7ff306d3be21e0e679f071e75d41c8916c06151917baeda3049f1bb575dcdf9a1f3205e12a11f2bc65e96aa05b32c30a8d281e5ffde4aafb3c3adc9c2e1c9450cdd58df20577e2f58d299cdc1babe8bbad3e6b3f46db2f2943a71745f273b38da9f5f578f90c2b3567e44a7cdd421650db48727c914b11ac0856964c20e9ed2412e19b7ea1eed309f64ceed0a00a256dc2838141e92495f6056e918954f6651baf3fd9a22a3a52a99a178d4e6da2223a9446161857167a577cb9eee5fb9fed6dfbd94d66bc9e04c1b58216ed3faca88ca081dc2340113bd9c9b73df21d5618c620f7352b86be0d26ad8f5aca91f5eedf84c9be54fd5d18ed0ca591be2472fb7b02ee22f8ff7e26db575f9d5232f0e61de6547004d46c3fd1e4c5dff8885d0a55fc19146276ce4b147abb17fbb459d4315cba627dd40fe4b6040bd27a379fe1ff611d24081633a7f8ca7a10f8ac77d1d325d904a21cb87f1668e3a976c649274be0db31e8db15ec0b6ff82d2820892c0f6ffb5f441fc32326d88e73a657b8281ead0c537e8940a77d8f82809f1077d4f0b10d884c75813481ff27a6d63f04dedfe6a737aa2dc35d85466b5935abc34e71d7757a718f1abb9dbb1b3a6f2a902115ce0479fdbf77ceb05a280c645775bbf714af9917576ad945b3aca36d390549a99d4da6594afc8835deb30c58f351d372647cd17d84715dfbcad72af10175d55971de95a672d52e728c07dfbe17ff509d3c7a85c2cc4cdd7f8915f4d0f7a9ff07dbecbfbb76344e2910001277f15d101c1c8a2cf6347fcd83f31ae23420f4f5811b99d2d643c6426c882ee1d6fc9c491d5682260a5fc4daa581ed64fd9771ee9f1f0d3ed16b00df34f96def315bfa589a07f60e71c15b0bd49d8e64ad3aecc36912ec734e2252c3097c12b5950a7fbf989b642f207112071a97990adcf207bf75a7e4690a3f9814e244634219a3ab3556daf8f17373e067ec4b746f00df7b4ecc0d85962dfc348f06b94d5690029295f5cb386ee1c2a779215ab9e126857b7c3e2c85447f9c17249a751bd17ffe46468743d825845bbef121230a9786b58772c4d0710e4515f7bae6ae646e1373e135d4ad4b951181753731b0ff46bd21c958d7b1bdd638a3401fe795b08de583978da40f6f22f3ecae425185d295025a22b7f9ba6ba539888f82ea65bd2a07dbf8bfaa3e94f943831764a5a5ead102c2899ddfb6710e6cdc8860b0c481ad92d3582e276467eebe620352610ab157aec33d0b0b8d36ca3ec0451cdf5b44dca51d38c93e92dbf11899ef0d3def428b5a7ad827eeb316fb04f527b7f59cfacfcfcc896ae38c63bb67058de60659406b5d6973b585c47a7c0e578b2a1298f0abd3f696ac7025a605c5840b34849560f267fd16fc153048a8a2878dec5e51ba152eb1907b9d8afb2ddfdfabbfd818b69441a852cd757d91fcb0eaf1f2ea7d1cb1f63c137c04e98ee0e314d980dfb25985290d4fa968344c13e13f22cfa2dead3ce493472f728958428568b4fd4a5f769d84fac076c1b0de29269eb49b588dc03c8a6518eec7df8994e51da8a1c955d709c1e618aae7277712072dc744828bc56d2e9e3215bad0e38a5b9f9ea1b45199cba5990e978c5d708cdf84c33a0d68defa6c1937be970fc0988474fdd8f1c76a7a1df8d6b516db8bd276a28443cea85c1296e1da63c4d69d9525aa5cc009d7ea5b65a28ee8db31a9aa4fc2659e5ca289445b5fb94ddf555688ae7bd8e9c4309548610024dbe9ceea627efaeec97feb4645505c6f2cb79d144c6f81a1343aeaf512a50784a37539186ffecda58bd6dded3f651fbd21a265882415197a2aed8f5642aed8c739d94374fb5cb8b44aa0a12e04157e5addb2a9032c2bf1be0011654afbdbfaa703f1133bc21f1f3bb53bcf7901aa9b03a7e591060c3bd054a0c18aeb1a72900a5858d2355a41fbb4db536693f1feda00b7f4a3ae6912d72a8f1d7fca237ca1c4ccbbe7046a588bbf2e11193edda2e01b639728c09ffeca6cac642447c504d40ee4dfdcc95db6f888a7ad99c9bacb2108d993457078a22a5acb97c89c38859c2ee5fb8b28f3d3fe728cec7ff04883e72d9b637716d94d2dce2c873fcfe48c83fd41f162032b52dab9f3d055b68e374666ae72426897a4cd9b7b7854351473a85e2cb42875d6edacd575bdca94774a85353382749014132482521ebed13b4681fb29ba47542ed0dda0165a0fd315f233750905840d1fbae7d6ab3d98ae41aac867404286887fadd7abd8ffa318acefe2532877811618e4d07d2815085401f272bc4bebfd7de2ea66c8b3e8ec184550fa8027d507ce9bb728629a105bf39bab2e0f6a14dddfd7f569114e2b402c28868c2bf0894027578daf6a0f5ad46a628d4e7adbaaad547f40522a73fa205c66ec338632c5827219867adc89703dfdc1439ce026c8b2460a15a91dd3488842bb8967a5503c893823f835138726d44ab5b5c8d57aa609a3efd0c8b3940c5c2351a1070cbde4cd6e6c3637bd90633430ed33a87f56051c9781ecaa1240b289a1e6e8727c4ed77b6e84d2ee4686a27804d4ffdb7570859b19d63cdaf520d9aa4f01a9efe931f86cb002b0bafbcb9dae261c0b3bfd0d7246079706f0ff77bec58207eb31c5c8761ee5592fdce8b9d3d731a89da2fb18cbe36bc4828b88146408417758391f521b1f90b1ce9a49429fce7c473fbbbe8137c24543ac623d1afd495751589bc08cba41fc70cd72b2b1ec05abc758a05e902b0d68df68f691267ed2070ffdfcad2b499c33bf5ad15437e7085e7b5f947cf77f9802edb7d17fc7735a801eb0600e78eee64c8ba90451622b64887220b1cee0f8c681bb5917e500a4a38c8be69d7d7565dd72b1582328a8b432004c41f0ed439bcf06c5b0053d1c6c39cb68ca42f979c8c0b14550769483e92804209100bfba3f761a94e34494711ced486002a3b008d6b14cbb3dba900fd9f52eedcbd2144096a147793161500a7efd6cd86f808b191402a1134330d1225e7718aa40ee2820ff43911ccc4ae1778d6de016c537717ebd7b2a9ed3256d6f0dd00c52082d312626a144b30c56fa93af9a2b486402ace5c75b1c3773333200f06588868a2046c674b10b016b9616469d6561f5945b5c720c3fc65639775a93d8c4cda58bc37935515e04a9290be83b5480c4e6b0f68ecc892ba670079069640506cc7765de7684757d031d86fa8863c969655cd602f0be285a278cd443ccdf361884125ed46b6042aadfa65a19acd12154ad5427c03d2b2918e8b58fa9c2b3c8bd95c3e10acd5f20c963329b7f0b33fbd83c5b194d51592929a7e4104e95931c4841e14207eecbecb2664c40d3d483dbd9d8ddc6f368fe344ac4624476f5c2ef7d08cf69d809669380c356b88725bf2634fcdcadf6feb8c740c6cbb93e370c46c80493fe60d5ce79c61145861521f2863e05120260cb530a89f21017d49d8b6bd0332a333f65d9014f2132c5079242f93efa522b558610492fe044ec49acee78a89d618788b90524d1fdddfe75643e5b27a78ef4ab5cd752d4d44edcd3291222e0cffcc068c64c8b2e4a0320f4b04c1ad90c2885ee0ce64db050bbb3058d89c90bf23e734451c42b85ce659e8dab45f3681b97ebccad58d069a787f5d53cea1c1643e4160cd85479aefcdb411839400b521fa46b7b68e5abf2d312f0593424bb680e35f3b2c6632f93cc0d29988a2211ae909d5c8af995061c7c52fe1de004928897b1dd56fc26f07ef7810c278c97f9c7f21788b125a8e208e5c5fa953534b132bf1a87d43e0c62b7b623e8c28473dde5c22f47177045c6d5c411772f6d32ed9773b459df26a3cd583c956d39e11c6690ebed48b6efb34cdcbf2464ca924bdf29e60853ae085f63165f08c7cf27413df52a2f492c245219b99d011ded2ddd071e334120414e068f1d63d81683444a9c557bd2eea6ae36122db08d19c10cffd80a12fb614204c905ebb1a65d544a481c3026a3c54af2c62d2b55953042fbcc825ac82ce578d42d2f909231353eaaf1bda2075e06fde5d83caf32904c412f83aad11ca9237bb8b8df042e23cce2da7b1074c94c0d7864bfa2f43693474ee5344c0257af79b55c1da14c3815a9fbaf9bc800b91a75eff09f7bbb4936e831ae96c6904c42292bf2ad86ee78c8afd0ed43f6f5e93bd352cbca435220af73f67945fe3110ff6506deb7055b75a13ed1a2a96f6e95072956fd8df9bb8a6d3d997b250b0807124f25aca95c08f150792354fcd2435c1e45b6d50c8246440ef24c3488fdd2ec2e8eef5539310e3d4a27c9c5eed0b1bb6792aa3b22e0abf300fc810e9933be1008ee5e72750c00397ac48962f351664b926f8133993ef95496d6d6167ee38bcab96ab86227ef137b8cdb5dfecfd7193d3b035335aeb97750425cf5dba1c79c905c969d4ea610aa38f6849bcf10f47b4a6dc948f4450dfadb56cc3b1b2bb873964a87b7d71d034367b227cfc1d206a3e281817b5229e55037559b3fff3a24cb7dfc5d992470b4605d897f6c9ff8933f56ecbe5d6423f51948731c775966a1121c7833fa4758d074bc46e3230e33929384d42d2e75f06b6c6f27b1ade8ad85f8862827d7c1f495348db989d15fd7ae71fa6a0330f803ff33adecebac4a529ea3c13c89f9257fccbd532c379958a28aa5a1f9828ba0ca06e041ea5dee089a793b37cfbf997b20916b2c95c41d6c1ed078a0de18c1b9a8759e49dfc4bd0f18860b6827950e37ba0dc0ee1b8548f3a26b9fffe96d0e09eccb849bc156c0f92545e01c51a20442f81d0fd81cf7487ac9b68d4cf92d18e801b546c36db0c6c1c29ffc71b35c11a7c6a1f2c9bb0f87b3c53bb018547ba33b51d4dbfcc46909483027f2e1c1890e25b8275619d1b5a536bb20be71a5522a7d68235840eeaefb965e7acfd62233cac12293508e1ef0b90ccc788ad87f9ef8ed67da219c315a7a57003535c4427bc78b37e0d9b92a32a63339d00822d0013e5dab3ee8fc7e0f085627379b66f3cac3de8ea25381337140d70c65014b6f3cb463ab166aee8bba514d3dce0ed7d66f9729917183dd165c0fc7d9a8a2e7c31f8c94ce275dac8855ae82b506549e6c4fd5f6dcc16d86c7af23c1830eedcd4328a601a46a5ec8f4fe0ca50a7239e5fc65e44d559e6f0d70338cc42d999f50adb4517e867d6147f384892d84571bc8e9bcc28542a4a93988506fc4798869c4f21fcf8e73e751c37b04b4ab5f447007384b9190f373b5a46fbf165136691e1906a4a015e25a6cbad55056fbdfe996ffdd598d5e1f0170faab070670f039e2dbd09ae001e9153116efac1281552a377f2569be5bad1912dc4170d7334eb59509bc5e217c4697c7c6c1b897a60486b7f93c43f76224fb41dbc909e2d40daf0d7d029172d2b20cfe8a6ff8b9d62221ef8ff285ced6d7090b725fe55c1d8a693d31707087a7c84a0ba5d89423249abea1bf4f30665e6d5955f38afe08e4a094adb5e3ad5ef9876366566212f6373d400e6492390cfea2357954cc4668f3278c233bcb39e991b261f9e1c024d2c23aa233c9147abb4b670aed9a500c163fa946c07cf36542dee880aa6fdaaad688afbf65a1423531232cc2b42f3f251b090e491924d2bbfee352cd1c670e93f7b8f113ac9a9eea3562ec9183e2469ccfaa389fca9257f60047c5149450f31fa83e2d6e46c3d44675cc47fde97ecb25920917583ee0a219d4de9ed65d27980340026b2744e8a6f4232ec71c03bd143b68775aac9e0aa8441e5ecd4993bb964a6f5555a35883b80323e5695dbce9ed8b67770a2e3b574956e6c7a2677a812144f82c152ec4ea0fb4004b4a64cf0114ad961857b6c4061dcaa1fbe85db70d4d5a8d77d30031e0491ead52fde0bfb1c22714fe9eb1216ac6ca11c0d61f32039be35085ea67c99e290895d8dbcd201246164bbbd78522ea98e5b1db749678dfcfc9a474f751b168cb32b75bbef0d69110742c5f5b0cbabdf9b0b7765b11180e655d17b8f31e9479f1490940dfcd88edba8677d2ea74ce2be44ebfa9804e161c5506f43b50a8bb42dab8c4a80c3c8656c5426791de6b7eaa0a073d10e0c159f8018cd0cabb628c555912fd42fc8ee394943845e7281bafb98c18079e23a831141eae5149989fea0b4721e10dd354f6fbb5960dcd4a381eb722a0a12fd45617bf42515f76b84d6471c9ec82df3a88b59b3ab4db62b38718d35767163bc411577b3814d994e37c02a4128d6c329cde4d4628934be95be949187625e89bdb3592264ffcaf07131a78d2de42593e6c3b414cd707fdaa84c7b5d9b90d0b404e742ad2ca60430222fc31177b99ca7c44d551e484baf4446b9493c6b1e5c9ea63f4727b2cc1b7857c8496b62d499064e91197dd02aadc553f9ec880c55a78f0331bf05316e27e4de8bc07ee66b7e2a079372a5c1e78c6e07f136c57cfc046ac435891201e96076c00cb5be9e8659e7acd541f2211bda2223eaf4f47cbc0786c20e7bc9c8fe70ac10167e07fa454494feecf768382cda57eabdf9c1ef663f5c64182c92bd81a7f2f7c6aaadbe3eaba84d26cd3de7df70645549347ca5bc8be7cb3efea1e7ff5d33a4b15e50e870f228a8b8bf1d637153fe606cd6c7fabb881ad30daa1d968464566976d4754eb3ffd150f9ef83fd1856fe6eb1db95263bcefd2bbfa9b2b025fe156c5c483c94bf9d3bf99e9060a58a405f0c3aed6e8a0eafb1b5768eb61be79f3bea0bdc7afc6225ae0ae232912e5ada6bf9dd6107c39512848d4c6ce6bbf9f3fb18986371b8a6890f4a0ef051b91931efd06335f0d5a5c0961093164dd8e6aafd83fbcdad5cc031696dd4cc9f3c5fe5353a5a879b5b0c7b43abca742131bdc2ed948883f89a3e63a06cf52e392e9045f5ff257e56f3162b3155819d547ada36fe3fe8fa361f6c7c2f57991d3ca317a8dfecf99f6da9d904d892d896b507422bd9b3f2ee5e6411d39089b388bb13d89fa7e781b184f8c858d99b73b424a8edd176bc4e40a0c61e17843b42a656ac569ea45100c510eb2a6d9b4244a930f8cbc6e58e4dd51a66ecaa81ee73199c7c358a38af81b6accd26a8ce9e4f96ca186661caffb907686b3354a6429bbb9cd325965a746dbffb3e196c3350ce288b04040f7409409d31e8422e2573a62274594fdb0e1c29798610438cd373c9728b11978e4a61321927d0f11a2227d9e03df1968a089280028d83e27d81ba2ed935230f136d4a5277c6b52df85237aa177c6043242fe6c3ebbe2a76eb466c1e5ff81ead421b959c5c14425ba5f51252b8d1e615e9c001f5abd60a06dae4d120984de1d78cdcfebf6ef8edd021b541bf1419877c68f60601fc710a78be7a638cea8d7323ad2d4e79b74aba8f18c9736748b9290bc1ba0948c094516afa7cb6fc5d46aab34f134dc626500cb2290e65314da550faefec99aee8dd713f2e29317b69a990e5b54f9cfa138860270be9c2ef051e7ee94b8a1f1e6fea65f839a9a6aea101f06293171ebd7ec8233950dcaea776deea356856be8ddcadf1666064a831423bdbaf6c1034e36b02b5e8f74e16564b1ab8f886d3f03dee306b0a1602167e2d55c66e8b20293f8a36cb2e8b3c30f81543d7170007b55f81ce300faa0f907561fa8d905bbe647d818dadceb210fa89135ebb26b2340d0c1d506cc18b3eec8999f47e8b3fc630012f5c6b93a7c17731803200dfadbdb0bfe22753750dcd48277e642c91e807234320a24950f6d02caccc7889c6b3a9b06def49a6d47f4873061cc576c4788b2cfff3da43aa87a10fc6bef8a36c17691f5e342dc18914f69f726a3e46b78e248bc24427aee9546d9665bab81de114aa01d213ba40e429d00d96ddb898eff181b2b31e40bce6a78411a0515fe6b5941ece646b9d3b8c58ceadfee90664f6865312f3e148282fb4b3cc67fd8994013c470a87d81f2433fe79748b5b220a9079274a1ec4214e02d3442b362f0a4da4fda09bac7e196008457a7b484a865eeda795d143c292e085c4ec3eeae725d6c0eb579453198da762de6365cfe83005d5ae7ad67f64a18d77cb481ea8c664bf5a247f2b2f7b71c01bd08e620c5d09ba875769bc940729257d899fe0b2469f0707c353116ddcca8740a018d609dcb6c686f56f214ef8755f5eac83264a2d16bb02b275ca91c389d0350294d6286c617c6c5a2826eb9a5c619f0fc8800901734dcc65789e7f3ece7568438eb052b28e19f625a8d0c10578f00bf357000288f55028a23e0f537f8b71b632ec56af0aed417b2658cc4c7ecc5222c29e9b6f4f1e457a44705eaded9e8adc5146a0941e46071bdc00b7d402ee828c68bad09a298f20324ed2f2c1c7f2fee5572b116a61ccad4a0c51c9cd63b56507497f6222cce93239298dda861f9f9d49bf3f09cd1efcece1c0a022de12b43b8b1b151444714c0e90098a6b5b5b241a9a166b9f72d87c55504b80fab5077274423bdb292bdeb4f4c54468436f1ce06da7528cf00d31a797e10e77b85635288b6ed27cab24db43b72230c4966abf717ce588cbaae1a278e98dea3db5d742a78a448f617e535e7fadca020bb8285a2ae33c4f8fb669afa1fe743633acb3e04048c49d19d5cc5c0877f7e91da5a009f816520c3b8c79937e08e28ab0902b4d50808c1377f886643d2065b6ae5efd977f86dabeaaf0ee680a877528d7325e84e4c4477fb681f738c958b7dd8b4eec7740340587cbb297dc3b000b07d243506a30f5d932d66f388677be8397ab2f9d2cf9f53b093252273aa26e8ca951f77aa7df40fd45f16651112ae7d1f5b45d6219806e341ecbac57e4382d602569339f838d1be1a1ea4b9e1038fe10be0cedcacc2ffe58401a442a7e6545e301a413d41be162552e6e81fecf5de9cfb806fd179fb158f4a8614d6d843185f6df1a125a31da98b36381f7c9c2226a70dfafb28999d599243342215febdf82eab21684c4bb86c43014751ea2bd9079611ef361657db0997333c0d5544f9098dbe8e0139d83aa348685ef174f9a4e1a0c8c61f1045dc44c16ef0d914daba1e599b85ccd9a952f0ce0b7d78dff70c5e0d34102cf1c7299736747a5f4699cd7841f650f45de5e4f6668869fb5203d55f45de354cb84402f6d9994fc089d52d338c4c07739341eef4da75b3c42e930c7395e1b8095ae8e876d47e8231d92548a0efed6ef9028848cc20a3428363417eb157aadccc999b1185465b6ef2b948d00c1695a579dbb0a5eb1fa6ae71b1b775ecc069c8e40f8656239a31abd514d5a5706169e68eafa8289024f3420c5724ad114bb2609aa4e45514120fe0f6a0f33b81f2e012a31975d02dd4c7a70b528c4fa480bc5f34552bb621c8ac7eacdab6cf669c08c4536c471b87f28f90652c0f2716c6d1da0f80b7d5fb821afd38ac7b5d7e6f2ed9859f2b059c76d0690746966e4df14c3219eba849a083f7341a2033e2d7ce33e1db6b2fe3a284692f886ab1f0c453f036731098f2f91a6c9b73e9ec1c9f0d8ac585051f39d3026d78847cf50f2a50088df3f03f2e361dad91fbbd00591a5736d2e800af45ce38913e317a689ee6a71b51030b6135c71b5e33b88ef2e281cd9b6c0443b24392fab5af512c2536664485c617c4666ef3ce7b86c4a18fe8519a5571c2335eb06e4080e6234be5ffc5f3ecba50d4b014fd11536b27b0f0ef2ea993964818b31b539699cc9406ef82d19f2d738668749a2e0225afd613db6d4dd2b21a01789f6ac020c3c61b9cbb8cafa141d9b3050b026743f638110fd43037d0d033c41a5741ad2d5acee82b1011994d94b8650566965f76e34d0abe40b4cdafb7b8bd1c391e31de936419cb1051fdd6216abb952e630890ba2b5b03163e1874ddb66af620f5d517debfa6e94e17d2202d4d555a025eac15fb9ee68125cf7ce65969342c079ea3653e1d8c9d7bf224f886d0f4a82526a85674d56f9f07f956fa3704b62b68bf1ac678afde476f9e02987ff1270f314ba6f0f4f694317e44c8f3a9ed9f5fca002cdf163cb8003853eb094dc48532a7ca583ca509ccec554d6b588e77bdd7eb832f93ff1e243b1a1f51c277cb69de2ffb94d73c92d88047da5523c002cbf2ffb915dedbb9d5a1f5499f8b0e58b9119927dff62f8171a4d81c90e8b617c43f41d6bb52192854b34be656878610c947c267cf41b77cbcd34f0a0ea3983ca9ed7dbfcf32d0291f2d550d69fd2dd175f14e4d148ea4696694ad32b1ea668a284180e47d118da924954891f9537aef6cbb373576a97edf967b926ffcdfd2703744856f1bc56503300773ea3244bddb0dbcaa22ee5dd6dcffde557bd1a394f518d4812305642a447c039c3cd3892b30644682f5b54dac4f4e0ba6c9ec233d46a2a902435448fa87099a4abc0d7e95f032f180a88f365e46ff15445adf15c521754da978a0f4277214c06d5c910ed6cfebc3cbb23cfe6feb4878b6cb76fba5a3ffcc39b7d5c7820364eb87b88688e2d8f2caf5c64465b9c088521b3efd967411050a0aec271bcffdaf6e8e02d8f9863f366b240a9f0107678075ff5e62bdd36429fca4fcb993b64bda5b846fd1c5214a19cbaa4c51b797ce791d8ad34792b9a3887e1dc148a019023449eb202f65b44c5e0f093c5923b301e4adb9cb99bc81b6419ecb4e0052e68ea34e4a345c64dc65f30c65ead13459cabe983bfcf2372e2788a2a0786a36d5ca77f1d26e0d903b5b8ff03c8439c22902b417824ef50eebe2b38151d65017ccda7feaef549c6327ca8766ef20647a44a71f20144e3165dcde0df0573906c361db42292f2a96d539fdb1855086c32885e44d1d5cd5eeb3aedbb74b8f83037596a4606849085ddc452d0a6335b73e8a91bce94689560b33a709c583610d798776aaf08d8613e44824b51f666d860560c75f74b2b7193b9f80e194cebfc4e5fd112eda1d430599fd1b3627c3b70cab6cbc96e1985b0b52b05fe5842e54fe842764e6a993cb13b3525cc36bddef20e84186e9654b66d900f495b51d962315382cc5adeae639741c344109b0194cfbd7bbb4d9a72a265116738d1f6409ab7fc697424bda49fb6af267185cd6200bc9d14455f7d254d32942812b98db4ec3f95cfb10cb85338c2c5359a549c0ef154b2778e5c97226eebeaefe04abb133648a3f5682c45bb2cdbce0b7f583c617b273c501eeb656ec54fad75f00a72574eb9ef1ff93fa1d0a583b24f4c6d3fe9e3fddf372c547a981c6167c5b8bee3571f4566a2174914058cc00a261d317dacde5b61d804856577cce0bfba1c1d4276c9bf7102004400dc187f14d22348ea28208c64d89fe4fa464699ec8e054df4063a0202a10e61fa280319efdcadf26c6c620ad3f41b656220c7de874591b81cce552b2b731ed219ea82c692b9af20f5080271f353cb302012da75c95468e3bb60c3fa5fa603faeefcf859dd1c59a6004ea03d234831ca5f1434f6c1115f0e51f168c7c2d5f02d92ec3cb51b1c4f0ea35c7058477fe46bd76b218b30810d82b2293a741a1d2952913658d152e607d37953b0e741b9c8f178700e3b15c960bed197904e0908d491142418e85a0d2fce7c012a82452bdca93df2d150b1d07f02b9be4cc0c11440c00c724babdb081531f66fe763985e49433c278833567978d12b45d68d47d80a8a7e80121790ae07c4af40b64307e30ed79b077f2d0c9d73356ebc4416f8ec0c73574351188f4ae29451de0fa6f25941bca1d5c8f230b5137a8eab8058c82d936ebe97b956921d092053c27a353d95ab917549c05afca2effd7a9acb7bdb680c63aa24a8fe6491c3b61f9f59b7044d01541f101702c8756dd5796dccdb37a04749bfa621fd992b62940b29fd00add2d9cc4385219d88565e5e0f9a392ad82c65e3f13d74d57a6f75acc6ab19eaa68d25b6a489837130eca2a75b56e173cab1d5f3c3d785384402c7c8fcdaca9bfb05152428b908e28e9a9ccbf3ff30f72487a61912291a2460b6fc811bcfc25f0ac6dc740af5ec8fe6e2c9b1cd072f34ad587da4f28a7caf6dbe1636ed845f38fa1125525d579f5f097d0557d93611b05b51ce2663887cc0c3db1682699d2578a5a5fafe98fc7b6ddfadbb5db14c97b04088a037d09174a049f88c8987f4aa363556419445b1c806bf67cca1f3a604694ecbc063f7a4caf29da4da216cc68ce750ca8b62b13f0a6f8e540f1cb1b9ddab9d59e221fe6a1d61d115668bc3a26062ea38e9865ad2d71f5cc6ca9433f4bc7fc745d7bf3c872d0bc8b535c0222cb6f1c23622033f1c2c71287c37a398575266ec080d310d7186e431ee62815cee82ef40f6e867acbb2f5e15b5d660eaeda58749610f5b7828feda693b8e1c8af461f812a57690656e85cb1bfc2e532f70dc1c8df2648120cd8604ff1a761d8bdd733a56e965eea3dd97b78aa400632cc2669bc3e388c1a026d6d14d687af0eb6de748300f74603ad474e46e3a32019aca7259c9c80439f1975c65a9af9e393b8d4f476396ffc2c57756a4006dedb7ef06a3d3821cd53533437fae0415684332413ae240e9b83e7f9a0def53b4a5937208f4e3170ebfbdf630bda27f3798e9b37a513981b1e2a52243b2baff677730d0cf93c6367b0c46452a703c37d48b3347a4dc56028902a771d65907d62d3234a3b116993357a2ea94c58c1b7d0b509cc737db0de148fae8494acfcc0ba663a1ff9d99df17804dd45c33221917df19b907e4da26d33f8d05d5a85f4ac798cb6b82e09698c0043fdbff7b3c7d3a0f2af42731fc66f01a9f1607dd5d49acbc526712e1d4f25dbbc49911fd52af7efda08866acee2a5495d6c31fb6df019f40d83dedaf6838d1aa36f5eaa0131ea57ee1bfbefb78e5a7dfb0d326ff26d26dd83bda79ca48ba6fe973ba55a00ce29b6dd69882c14bbbee0114093fecc07bcc078a2e835eb0096b4fc484c7308735656ea5b91ed4a58b7ff45a9d50cd5fb29fb6244a76670d23ef4085ff2f53a1e5c4501e9b3960a6ec2609bde8a2139e725e835e62fe1c4aab025b732b1d4094924be1e80cb40bc7a94d64352a3f4198bf08c6ffef67e5a42e856bce99014eef5c070f2618ba76e11d4d641c27de0bd87c1e80d2233f24ae5541818621bb16577d8630a46e1102a480bc6b18c5d2013c2103ea7ff8b32eb5feaff2a0f50694f90f540b1aedc8bebfb040d8480c3f454bb98c30860a3045cce59aa1ec60a69c0977f20e983d1455dd045a5e19834922a3fe552b8e2ba4af6b921a08207ad5455ad05c5617ea2741a95bf167bb630d98cf6121f0872c8bc649fa1c4bc2363a6dc51290ddf3c8705e3b7d1788cc4d79877ab4b352894c0ce8ba4a99a364579d99ad854a18c7cbad9d84315f07bcd4e4d2a1d302d000dab30b08def962403955daf6844d03b6fa596a2ae86d35f14f737e51609eeea0d60d0481f270c134ea85a48d5ea041d9ff7a7bd1758089ceb8c390179d151e180a39e616786a1585d94197f16cb426c9a7bf8d37f57255783fa5f365b47c8286c462f7ce52d476c89c8c504ce3668c5c51bd1fa579bbe06a10ee11ea923999d979d88205107e8827e6a2e6730804306285ee6afa783bc31cbe91b7d7c72fc2c41b06f650827e9814f8d1ed4685e82cceb31e60bd85c16585f2b8642b65ee7875d2f710e7654fd1a208e5999d7be0151c8bd10a59c36c2e8c4e17d75c2bbf660c154910bc2abb82fa5d4cb897c68107acf285ffdfab54e365860fceeeb500d2cf58318fb2184e17c5cae9b3016b1adbf96daaa15fd911b14b1cc5746d22428555e5e7029b3d41fcb8b4419758fbec20897a8613e14de7fdfaa25cfbc00d734966e992295a77e2861a0c95c8fd842145eedccadd1de4ebf8bf0438265f876580f4d859836fe80c9e1baa4a502263f32a04ad1c9c4ed972e8a99c8076087056e43ce924c656b6eace1c2a5670bf6551d4b8d48f1fceef7d604bd254434d0a902f121d797c6f1ec97d54a5e6b7d27f3a73c3f91f7f56122d4702f0a8364c7c63c2f862060307e5e888f35093072709c47003bbe991095f3136d52de58763c059b4f66e41a7e00b29e5a83e29e7c25825fe2a5fb6962cabc1b05cc2507f578894d2bd3a21cbca376ec64973ad00463d2854c4d93dd67d5fce5aea5db4886e9332f9573fd317bb2ade6bba5e4a878bed53238149040d34befd883d5f48252c013f97d0b392f9353f0d0fd99bdfb1f64489adf4243e861d0798972550addea7fa45a86fd306bb799f9223c638886ccf31d60e8bcdeea1508e7876703ce3cde41884137a396a3a52395cae3e7076cc8a4d0f9bb4039808b915d777b48872e743130547c7149d150b76c9b8245ecda309ccec2357fdfaf41d2c4cdfef172a0a9646fdfd6b5d3ab6770e7b94db2ad68acabd09bfd850d0fa075bd4152fc9d74da4a441186fb8a91284061cc97815b09bbee8edd63f09c53140d88367742df999d3e20ae6eea40e4d490edfc6bfc5eb7137f6e1693ea561c14758573032ec3af997e413085ae8e0897141b934d01a4f0c73d43f76390e32891915000efe8b73f8eb8fa70d7b959c0f5ddfbff074d8ff555c6c8ebe312ba1ad00eae1f7781591b5532120838901f1a30562de81c7ccf418566ea9603844999c415e6e65077c9331e91c303edad6f2ec3d01d14316e5f737d5e37d2f54f745930432a3def081f554c256a65cc7953cbd2f3cc6428a6dc710a5df9756a78668052c53336b841d4c695d24916e2c27c93f092d24f5c6bf89d74c4fb4b9af929cf0c813d7f9acddf39879ee74d1ba1f0e8ed57a232743d3bd92a181af5dd8c20612184907c8e4ecbf83125055ba864e9d7968eb81bc98a21a2ea1daed6614db7235244c4a7b6e4239f665ee5987c393ef1369731fcc051f3effa267c154b7b9652f0786764bd50c1c6a765fe54380e25206ff2d54fc919350784e9722a496d3e347892ac5eab072a528dd55b9f8850aa255c1239ae3ba441d0ea152be7ae04b962de2de1654432958254e9c1084de9f1183c5f96c124dc1ecf6a35b280273c24684eec4b3567a1c1b8b27c6a24b273cb1482f36e5d774070d09567ea18fa1567e7c8e4ad8fb896c1a1134c033ea0f4fc6eb2c4dc8ce21a3a8e1ba24faefbe438ccce7f7b062f79dbf09e60952bab8eb098918cececfeef17669f2b7caa56ee2e8e4fdd1874d8d5d3665375e944c378b76a566d5805e858a2da6a9c731fb1f3fc0eb41de7b3ca03ca3620c3cb22ff2a3f6e472c78e7dcadc17a2d28a75ca87d44610acfe6ad3d4627985858a0a041227b668c5056f6e2b0fdd636819fd155d33130c2f7259091faed1be21c5053750f46a7064bb003416bfce004e26c383d9be6e52f9c4da0ef9c6cbf112a235eda6b7574dfcdc92dd5baf404b93dea40efab44a0efd3fdca882dcd0d3ad6088a9df098d1e9c8223ab32d3c3065e42202bd82bc5beaef4afd5ad9bb683db11c3d6580962c5c46b147d25bcfb33389d55f7f77334582211798bd1110ea5b349ef050052f6fb3e976a32ebe6cd2305f6dca950ff973aab5dfcb96185bb9dcdf25750ce128cce315d84424e44b842a7aaa5d0e28c32b6070baefaaa347a74c0a3cde0c8e3f8a02d22d0dacabe4d9f05585c80eec3547a428517aa5527526c3f61d52630200a70146b1d58c9cd94aa56b7382a5279a382d3ddbdc4353fb7982bea712c446909bdf9bf44fb180fc95f6d276fe70ab37ff788ce1282573b1a665658855557a8ab637f9ac19bdfd6aaac71a6cdd878b55a485ef9861aeca258b1f81cb0779b5d22994cc8e695886d3a2a7f7ab3913ce04d8d00c0079a2aea8ecd7d28839135e7106e47751553a04c79d0e3a871ef637743a89a12cfa06e01783be97154d80598efd8ffc492a8df7c6b55eac112917119ec7eee1278c5aca885f242bc5be8b0e79e5dceaa741a4da7825aa25acf53bf92277caac1f5fb555d706f9218cd91c6f003bc08fa74b163c5f050243406673815525d93115361b84f37ce9a3b0ed3d21b62abb8f7c400ba35cddc653314714e8236afc8e356785b59ecf8d17795221eb5dcd3bd96e4788005a62947f66f225a41a88c6a1c76fa05b508ef743fda8fe47d30473c7b487768dd3d7dfe630964232d761a7698cfeaae6d8b6f84fde201e6f6c05ac41dd46399bba0c3d1b7d0b1032ebd8f2a884cd74f9d70de75214b642dbeda5741a9e02771ff6fa9f67eab02147203f2d86bd7531bda5c327c87170ecb3adaeb5a8c481f150bbaab9431dca460bb8859c21fadbdf8487a4b8ea12e6e1d6016ded07e80e22555d5f7600facf156576dd019dad70104e1933db20abfcc108b3edf74376d11418d84e7f41fe7915170b664b8ba5c65179c6235529a051cd0a216472803a14d1f4eb98a657dcd3de8a633f3f611685967f9982265f89b117b5777ba288d3d49c343bc94105d3ef18efecb701cef76d5f1fc0a4fff663ebee1e0df23ef22153dfc984afbd4a290f34d55fa736c11c80229f67ca278a119d3265819dfca32f1b7961dbfb916f40f4d6d5144bf7e8234ff637cff763249b04b5b1a3753eccbaeeac0e5bf0536ea061a8a61b98b248d41baad1c7c7c6e1125f8ef70c9f7ce67ec58a4dfe5708cfdafa2a8b0accfda17dafb4c7c10c5437c82cbcda67f585f5972ee6a71f62b235b3133de98e456c6b5dd23cde104bb880ea3ba1337c0fb362a4be1bd029af0d8181a67ae89805ab028edf3df59b8767fb9ac38ec9ef4873095a204b9a1058eb035d5ff703ff5e4af55140dd7d4fcd92109d071fcd7dbf6a26049cc3d79584bdc26ef36a58ed053dcd994caf79a90bbbe0cc062320ffb7756b2f3e8d90c4bfe4eb04ce07dc547dd18d42c9b27bff1e5e2cce33ef45297eda5f68906e4994724c28e7b150ddfeedcd5e858462a431e3cf6e8e59482b9fa4acc79862f6b2b750b3e930d666a35910630870a65df2db5e4d9b49b98afcc6f4780b3a90e020ef1371b03e3faa0dd508e41d99eb476cf748138f62f52443e591ac9b9af8e3432b085e08be5759521b445acafe46342843d1ab262c74994ae679137e4692f3677bf84efd832c6b1fce6ece3897d0e458bcb0b9a6393377b7479c0cfb6955c3bc6b3bfbb5fbabf28f8e272541a367898dd82a2b2fa89cd9c16248f3905d0a0737cef1d89963583e7f40a6c6022b48a4ec26e5d89380d3fcf64f0798b6bbe72d913411d019880e7a40ffc6a912573964e4f6a66ad54e260de2429a44336aa5c4f12baa45644309c1dec6f733ca1bd8c0730fd5ffffe8884c2f3ae32a9e96b0955053506b228310dba252d09d94a08644082428e72b62039f2ac55e761ac7cf95c5e7c3efd75c252192bc547db71874d59731dee99c19ff857c6eba8748e7ac1da5700c5cb3ffb6696b88b059398e91fb5cc3c7538bf78c5419d9ada95a24b87a1081b6acecdde5d9a246eddfe10838dbbfec9f12ac368d3206ab3753e2ca04150968978b9c9c4beb6cce8880004bd61eac1080fbdba8fe9f739c434aebf3874510bd86e23e38ef291b3bc9d0fa05db29e4ef8b9bf35dfb015407861a84d8aa6fcba7d9a798d234fd10e88c2befc06cb260c55e0e9877ecca3020863c532cdeefcacf13207fbaddf430565bc9bc844e736d001dda730931380ba5637833b3f3c223f46097e0930326ce6b5b0ce6af554c6cb5d22429703b687195d8f423716d0e92771c49c21aa0dc628f52d43850533d890239be3de029c3db8af8d7ab178489e403d7240368880335f9e0ca45aadc5a63a6d5338ca763dc88c5e286c01bd036753ac328679070d39f7c484a6fc8460477bb813a38c8ced13206496df3925f9344187efa73f246e07265755b5e4ca771269bfad0a03b9b8c185249064fbfa4a59b81938d7a0fb0dda298c2b7f67bb15f98f7f0df60cb7d459cf6bd801a36f6aa3a48a90741b9ecf5b3da806b536ac7135b8d3d635608643add2a1b04a3cfd2686f97896f9793a5e24f3d7dd10a9044146266113db675ec1b9749d1e283db8cf84e00a4a63ec822dd1db1342d7dff8c380a36e9b597ee064eabf6caab17e8242099bb69c98f6ee0ff167cefb72fa9517b12a566a6d64b1060ce7c53bfe802ced84a2d75ae0112b39badaa901abc51633f83d149f01f786ef5e4155d3c5b0cbfb7797f43ba85706ee9b56a93964b5c47f0f38423123aa3b53f47531cb49fa530faf168841d2a29f8dce7e936ee05a6c8d7096089ba39969ad9b84f213e579aed62c3ce212ec2b4ee4201e800e467e9c9224e312ca9d17139eb9667def119d307a6e406ecc589f6192e7af912094cdaf0e63f660acd444e391877523c41d844f69687d2f8cbdcbd88d667690baae361feac5b8313a670919deb9399b7e472ecb21a42dc29ca40277d3b144369d8262aa5a7d80b0b722589fd5cc8a3a2cc2fa2a42c349e9408a505623f938aaac9874c8c3fd95195b8c533a9f7441fdf6d25e2ae1279cd3e39c156507bfd9ac1a80715451a7cb8b9c897dacb2d388c1d2b4889f6d32aef2b9c2aa6eb9080adb8f6be28b26cf54cf29b6c5b0847981044a31c138436c2b59070586587c4b49c7a5079823124828ba1ffbf11759e8abdcd4a6401439de52a512d14337433eb6f3e2e919907b5df7215276f0867fada1864f109825d895aea051b1a79cf4321440a4c2b7397222b933548c19bbeaa48831d0c8ca9e802bd9023a027fa2836b562f354892b434d4e80b9997841e5dd19e4dbb48a9d2971f903f945d0da306e68667b5fe4fcb5077bd485d05098a287cbda8e8142f3f982de7a5b3004944ce6ea0d9aebbc5fd278e8853a166c66e376dd7c7386dc6a11e9e551e7cffd59edc157f6bc8146b77b53fb03e1e830b701eb0b143d26e1a40b02d5606061b8527c3c6ff44eb3ae99cae474d4052a3dcd8208fec2488a8514f84119137ea521a9741b275af41710d784747192438ee612dc0a51ba23ad2306aa6ed794ae6bb0b518ffa038df308a0ee32daf70b48c2bef95861464dd2164a789a5880b00e3e4cf5f3bc303298f6b54dd04e26849bbc56c64ea0bf35b1d5f5e29c96807be082c8c053dd6989370be103e374e930a60e9db9d926e411b5b15c1c19b044ae544666507cbd837e6b731146589bb2f0ad13bb05f33025d728b4e8f3c332348bfb2d4727af594cb4b3994ee19b9583163d4b4ed9ab9bef13e0923f3f0dd2bf6a14efb7cd167d1e0dc5c359965b0cfb2eeb236327354e9ddf8f16af02c5de5f27d1c216356f544cf1cf606683cdbd441c6f21bc04011d29b5d495abdd6c5af860cb3b5ff3f09f030fb96ea71bd29c0f74c54a2aebf994925e455ec25bf9996a9a472e5d773f800f1d48938481b3fb6beb442aa43f058f0537eba452bd703dd8edac40737bccc3edc13fd48d5c52b1cb6bc62c649c3790dd7cc6e2d8701bc6b3f84ce00f41352bfdf7d6de34b9f7902e3b1699395ffe1d73feb214815e16a54933d05a0de7edeb4c71ec705e8e720996dec0557ae9c39cdc89994561722cdd5d4725634ce2eeb8fb47666c0c8293bc00783ed9356c08b1212efa9ca773125c7322c1427df84e87f86f02e8d3aa2be6acc084a5e1bf8d9561b239e4fb0c81a76c11175b60c753037613f0117895095b3b35ed283bd8a04d2ed35bb9968823cd7638f3acc0ce9bda7e66a1c46b90139dfbe67c225025918f17f3d65dae89f610044b47ec5afc498dae590fb930f208f4ce868baa924031616b3a7e9d74eef4fa6251ebb09f4335898e513477b7df356ef65a8306aac491185fdd7e4c3bf2b6bc64b5783b58c44b5213e32525d9f47f32d7454466aafe44cdcd82a60f737814f39f6b0236a90f99604d34a404073983c7bd2190dfc02a454133446fdc40729d24bbd948fd575c6585c56f612ff90ea84c0f18017fd359f0d4f2950174140d1f15c6121571dae484924928c74950d8bdc35fc4f640ea9c3698698cedb68c275c4988dccaf418bca8a4b811f47d77b05140929672fc4c7adec05aeb63ee636deaba810daf376d4a04a78ce65db2dbad02a613c2bdaa06f65682ed563dd80ae48893ef08883f17decd74a32c55932e4da518ba50025d82219f695af657d323107f7f99a7f45090b0feba39660187c843ccbfa01c960bf05a3106377b4a181489f2010849a17c8447e0fdb306ddf6bc066873e173ee2ce0e9bbfe0a969cdbb2f808d0343375ed30d6c29841467d1334e7d2e8b837a947956dcb3e982334fe9e36c370afd196fdfcc558aa84c94acab8439260e0ff2cd0f9775a6e6345cc4752a3836ab6252f4be0764e689a22bdb095e323b603a79236ab85df134cc7062a444caf146f88aea683861a0203a7f99d99f381ba00c27f17d7e49b9e51dd71d5358aea54c09ee0aefd6517b30a457cf466ff8ca790316e16282bacbb8abc53538fca9eb377c9e60b02501eac807ebd2a23f784402673780ea9220f40bed2d85c66915a249c0fe6ce852c4f33231ad9e0506fb10995c2eca121f1469ce6a7bf12f2fb441dd650e816aa32e8999195485b5805adb2b724ea13560745eb3c3edda9b0c564ea8148f1d38a99fb5ca61d5d36646bcf224a62ea42f936cb1c0b0aa9ae1af27575a88e3c2871ae2f0016117edb6918b4f0917a21dfca921a573b11dec6aaa7273fb3778ecd78d58ae83966ea3d16b5650460f03e692a2e0e3931558517de5116105057ad11e46fa03493c61412fc2162b20cc9f83546fc21d5c6fb3d9319e6a5fd36bddf2b8afd1cb75f4322f916cb57097828cc7e3d14d8debd08ee7c97dc411874d93eda7cc6cb217c1e09456957a989274ded8cf6d0de2b690915ccd944cbcd0403d51649813d8c9d2ec5e3e94c0345488014ae6782f1205689f5066ff3b74bb323dece3ba1ac1cb844f60e0ebe697d8b1fd4a878d91547b37c79a80889a771bff74e83b565c3d50bfd9537b8557d88b629e5ab8e815984c01efda41fcce279048d5d1b56fd6be527d3f88f09b3e9bb600e8669eed60b0ade2feef8aa031dfba840b3f43956f326085611532a1e6cec4b797e346ac176437e19ba5b6b3a01839c900323487e9186b28f8e8c85d60fe8b9981c83d80859575cf767ae594e82d6e3b2c55fbe29c8bb040a5ca41d5a57d15ad875f826f163b9a7af5b4e606cb3dabd415b6650cd100306fa9406cdd47475e3998cdb17ad9e8b3a4de396663aaad8c0c737053a47858a737ab963b2121875f5d576c47068771e8073bb612a9990fb2c0f15c8a11a80f772612073cdb56a86da4330218aa4083abbcf005ecfa4ccfb73fd461e057489b997be98f0cff6d4ba5471d2e72836c6c3992d5e98ae5c3802eecc1813377f0cd1ecde8ebfb2da3321bb95d7e252d19364e8c67bac59e82e43052eb609fd707c4ab668bd5577a404785fe8494d66c85f9b409d24eb5f47539114a3256363b6350ffa968d130fc388427652bb47ea44808245072f1e6c669b0acf96262c78a839ba2afd848bc0276c06a94bd4a5dd93bcb1add22f12e4b83e3c8ee3b63176f950edceefd2a0c2588d3705656fb43eec7c06e211c220c3bb161b6a2062c0fb523005032aa68a900ec89c3759d8a32ad8f26d2ac96b384aba7a10f172c9fdae1a0f77570c51135770e3ecd75617e8472ec4c175aa24157c09831723c137689965cb6965562c9d0cf87a1452bb56ab660341fb1a885320d0ee3b14539b3b263418e6661b966edfb96ef6e00c15b45e61cb1ce49e97d61e0c609ecede4f5023ea07a0f7552591b0c1d0f4d3da3cde19bfdca319f098ef742bf9126251c5bc90789b27ab870fa6cc43a86d59e3e27ea51870664a6bc9d9ca1f2c21240387321b0be06ba43e1df6f8d166ad28e5f266dfbb1fd7375bb87175493d233d08a77d022e392f15e4465805e8437c401db5f0d6ee0c15a2b2b8f54a98957978cb6e9aea6d8de6a1440530e727083fe3da58c5c05adcdfdf1530c759c56bd907839fdf20f3571541a1a7ee0b3afedc18b11de4ded5da0a4489b42d1493dc0c0df6e990562a81d309c46822cceff02cd3c4c5b6911439fb939197b3c673e61cbb93bde267a90afb975bb204e6c625306a59dbce42f84cd81d542b67be316f8509b097c0139fc6faf2d97037967187aeede90eff8f93f1e595b4617961d552b029b5aa51c4e6193e826b6cc3ae77edafabdf9d8d80651e573bec698ebbf92a5dd2ed42052869271086a597e15c10e0668cd7c7c11345d5eb15a7a6fe20f42927b44bc5a8fd23ac11bf921f58b05fe9e859aa3223f964340351d3647923737784b77d8d7dceb0ba0826b2973cd5aecdde1f38c63152ba622e273331f5321af77d8abc417a91f7bdb1d9320b486f2a741ffae1d9a73390550055309cb9c229cab60d46b6f548b03ce064d4f61c46a939b5dc6691351da8e4dfa5f31bb60493c4f5d8e5cf5da8a25e53719f887cb5d808dcfe2834a4a8ffa4f2232ff46038ba4df04d8832656053810b2ab69a0bf4bc74d4dfda5e0d349a51fa26f18363aa9b8da8a2e2ec643b3e5e78519e3d0a3834d9da15c9628cae6d642c556542d00cd97edef60c9d8a34428c9d4e907852bc8ef6d3649ad73c66878c97eb0f0f4f3c2ed50dfc07c9c10822c0e7139a21298d178155e9dde7c76a71050c8343055ea43881259e441e53ffda450d10897c834a040959e08d93acf992a158c618e285ac9ed83c25a58e089b61f2fcce1fef95fa6d0a1c871a47affc7f41f5f41d70be25c8b867676f347c5dd274b9ef191bedabe156b8e1d1b09773175125e48cd664bfa7a0a42778e7172f2c8669b7326ed3a23f5ab671db50c50f9bfba21a76475f742cfa6fe72b7f8b67e7114512f77c3b56ecfd8deb201f3b6d82e7bc780688541e7b1465804607c3d3d02b80e0ab7ac160eaad7795aae7ccc56ef6df64140146a6703b467b9fe61ddd0e06f004e45d6d5aeccc149991128d54f02e7034fce24ec0260859c343c5e8c6893a9a557436550700ac6491ee727bf31162b5dbae3da1e4730f94cf2d9bc8d1a0474f13ff885b02f9a9f6d6a3ea176e21d4d3e2bb7d6fcb9e8d74a6cfab1226cf425a98511667e11f3c28b14b330cef49df1a9b6bff5541c5a8a006f630d43346a96f1f0d321f3adc36b8c25f61f8b84aa32247e25786c8d39c007184f70bb75d5ec2f4a3f84018be82a3ead636fc6004fcf0e5d86dd5dc91cbe0cf75cb6ae308504f5e7bbeb0bdf218e78333c226b786a6e643cc58ef3d6b957a3a0a2b1b3b9ccc07cef260140f580c46e985feeea01115355aefe0253a957af2c460e951986cd8b9502b27af171727b9d27f1cb7b283e86042d5fccd686284a6181d551aa9fadeea4b61b24b30419c9f065e2ecd08895b96ede9eb66ed3f1e6b7719109ebacd55f66d869efb87e312f3ebac75ee9a3b765b0766734a09f04a5ae79aa37620120e45f51b8287d6d5d8e8c7d9dbb7c2c10f6e63eea3f46c0db65acca73413216b1141aae0334fe6b053190be54273419517d5a3a297aab52cf008070761bcde58fa272362b228a507696272b15a1b61fe517f72f2c37bda15b52acc9b98c1518bdd23b7ff65658d3b2cfcb368d9df48f8248e919e8c96045d7c80cade29c9d731263872dc91390b409eaee2b314c7ad978d002c6102a28a37a94b31d14b7e1692e0ae225a9233c1818abe4794ca7c468f63629832457f54547e1f717ee490035b6cb2f551d0a4fcb7cf36cb0aad7d8ff689b5b5d724532a477b84d33183263a0ad3ee5538620b6b8fd7082fd4401938a9a92526102df8ceb0eb437e6815d4e1c64fd4e84b28f8b80735d17f2cf51ae5fb54b24f6fbdda2719fb16b16ea7c9098d441c035c7b9104a46164824dcf6cabd852f04316c506abe55a2e48cfb51286680ab2911e8ee0db7f01f2e7949bf151d28d0d2bb868eb9cb6d1f6a0207cbaeef0ab13d09b31cd883dff792d0f3deb0f363cc789436e8ba095c5b6906f9c5736ab5e26fa07c02d0b13bad4b9d19477e54d12005ff55a4811a5dec18b4966d7b37b81260dcc0533dabb373a453969293450216851315f15fce5a8bdb194702bb9e501ef9c5e4ed09400d6e9f867841572a8a33c910c0b229226a5cadc7f60f088dda387e2434f8af1cef4e4e57dff4fc0b64fbd22e19ac3680ab97b95f8995d08300001c5b76b1f903923369a2072b5456287c7ea366466ea121e83abbcd58417ff1045000b8f4df149bf76e2213ba885ec2a394c92f368bd1aa6b7d5ffb518679dcb26888cb1dd246b0e5c17cc5c271733eab4516002a1dd12603b7e8a0df44c68340f03db1429ce801cd93094417b2cb4d707f6acf872e2556bc46c69b2215cb93a1f21c3de30abfe6d828cb44cc74e794dfe046c87a45252cdf4e2ec71fff0481b969a50fe9acf199d8e259e6d4b1fc913af5aa8eb00a192483e294b55538e6a022d127fd61a14a6ac08b5d3e22d833d55c5de961381810a273c98c53646a602f8445db5f04a482046e2091e5f786c8e41b47abe6d9147c407e09c775e9fab745cd0c990e0594839535c237fe8683192530da5d19ed967c95c87ba99e38684aad695a1cff179d46c4cb0989298610bd7e5b5bb302cb27e52211de9156d9135634ff54600149810ac92c8fc2de4355290ffd65910cfbc837046d4e02dd7fc9fa2162bb87aa06273c03b6a265698389e14c34f60eef192214be70b0b66e7ecd2aa50716deefada7b845ad99049f05f110bb8491a1585f06b84d763d7ad6ac03dad3bb277700fa48f2b8a2bd96b9de5f1395fd6b2d91a4a656214d21f8f9e63143bc775ba86e749ba461276303f42657f94b284c520a1ebbaa233acb0795c6dc77d97e1c6742cb80053d82990e26faae22a130df988195e621bff600287a50fc1e638d90f62746dd7bb361b1cd35fe45aaa86f7ec822fb918993f5a8ca2d76a0ccb97e7a897248c338ed3f36c9e651e094f9cff3d0a39e33909f32eed668729057f4d582337cbb1af0da0eeb04ca3c8d3c3d2fa4c797afd156632a620d9d4c09c4cbc4777cf1135b2917caa23191e0a8ee6bfaf4194ae74c348bdd6b8f7a5fe54608bfcfcbf5336afc85e5d38d7c958054db8df6702beb270d9b17f088c144928db3f23c429207e3dac0ca1878c3925675920de770c0cef2cc1953917c7c88edd6ee5bdbc19565181361387e4d854d82901626fd28df40c0613e9b3ce93f3dd8a523c81dac06a22796beedef57f7052f9813cc08ccae009e7a9a546d84e89bd76e202dea6059b51d54951f07fb504383cda20f42471b1a11d9a659e38dea58621ed5ebe692a26a215653d6416049ae005c55c3f9cfe5186f5387f8e3346014b46cb736b9213848b58aba236380635ffd2497f3f0a1335dbafe998dcc9428088959eaba7225078b5f67660d221dec6e3868ef75e195abe0968ec0b57dc2de6667041825126b68aa06618656b805cc0147e857c899dabcfc297d2ddd04e5babc97e0f6330ea79651717dbba57fadaf4a191be3ea67b399734e416de7bb5151c59593cc9fdf27210fab8116acc1ead6c5cff31de79df9494c072b44b85bd0ea60cdd7be15be337735d421608be74dc9408ae33c3ee88cbeea8aa57927c68a7db9c32da719829ff1e17a7f3a018c36672d393637c904862dca7d530f85b0b5215f26bc34f57a1ccdfe01e3d8146a18887487379cafa84b4c0c4821d5e1820beb8a84df8ebdae09e32d34e08bcdc0f3c6616ec50d4098adecdf2a0a3c145f77d1074f9c50759ad634158a3f89215121429bbf7f3f7652d7a47bfea9b950e28c79f508fe3836b742cdc2cccc942406e25abe37cefea4ec5d4c2a34b41b58f4a69562bb08f0141e6d9bf15d638a37782056ed11c84eb5d741d9ae89c2bf91798e32b1916482f60c0d4d6dbacc1652325af3aae9bb92883f2a628026ac5bfab8d1e2e03e38b636080de1fbfc13cb3e0617df53e5c8e6cec0d222e256601a5f2faee7c401e4cfdb73dcc59e7d92d80661ac8625af276a8e70e095b5814b315008907e950b77fd8486d7d1e43bd35fb9ed06fda3b67a842eb333ef3c9335e3ccd8e0a7292a2aa9fd5d923c919f34c64846aa3b826d0e9c1285863cff0801ccc5d6226b922f3766566e78d1fe31aa58c37a090213c2bae6f0453886effaa9346fc783b3ae75669ad2def0f7930fbc21058ff3459912cbf51724290975b45f1c73d0abe226a40d2344b866c23437b8bd9831d4644cdd912754143cd19f7bebd26d5dc49ccba1481596d83661e27756f4312cfe6fe4a1125eb6bdd0c1c360bc578e5a4be0db903653063e161562b5508e7150521960b120c471be5f2bdf127ad3d169109ffd714eaeb38ca2ed9ad8fca3391153ec09a38de398161e5087ea62c71d9e2fc1c525769e2a8e6773d9b763e212a2ea50a8258e85ec6d91b0e1f138d0312b22c946486b17fa8a1eee7d114c7a1a55a0be193f452b7ebfde4374a52afe2b0375aa883a150b7eb4cccd57741aec4b3bc0f15f9120023febc6c52fcd54c4b298133c83f4089ba6526980961fe38c4ef12b44fe6aff12b8044896e8b69c37ec94cb774ca35acd29c40764cb55998d2671ca1e517212a89c98cb1a01ffa2c4b1b341a1196db25d59228ccad5f8ff3a24a027f1314d2cfc2a949817c040986339340024ab0de065ade23ad51fbbec5fee62632343a466e0ceeebe3deb6a3ce5c537ce6758d0f4791fd5441f6dc86a64d37a15470dd28cfffc58b2c97459fd973fa6047c56578fd9c2e7709b2eabfa5319887b21f80882646b733ace5c531edfa41a01f27df9261ec86fd6100ae720dc3d5176093d8e9f091e3696054c884770d9dbab7b5d0f680f9253e2de63e360697bef2ee3d20110b50775754a8817473bdf52952e680f6a61625953ea43e43e956a532d759ee2b729d10dbab6236d947a56ddd0d7e49eb992d7a032f7d1b743f624993162107aad1e9154bd46ee8c8689ec70b3c1eb9d32e8a0174e2cb21fded9f3f63c72c14eef5b76e5622421caccedbd533fc7c71655dffe2c9f6b4683badc47c6e01ab40b0a405862f6e7771f044f5eaa74d7eefa0957d007dcffb514d5d12d1df0baf29fdf9bc0b7e7cec204115fcd2f747647f00084e26ac5ab61f1e85f17d2dfbfe6f5fa496c0ea785b619fc415d24a5a6991811899988a3d6e9cd67fab3f96cea5ed6720450f6f2253fc87a023a1b31a42aced2e6ee8944006b8391be0c0a3667a5b6f3a2ad6a5fac37a65e9e72384c3d749496380c9bfd7612f2f629ae1d64f3b020afbaa3ddf313ae2964cfc9b1373ae9f933050b74ff2e811e3121f234e04e8aa1ebd2a2096ae536c4caa4f2f57ce1f3da784ebe8b75ae7cd074c3f7001f6ceb9c8cbaedbb62afebbc176d069419fef6178a07676c09d90087c36ab72bd55271074913807f97c9c4d67a7b30c6684a672ecc32a7d89779b181508556aaf77ee4e2ea2cd84cfc16d2143ca881a73cc539170b40c6725051d2bb8b2ac21f6f340955ef2723ae7b3ea2ba84615784544bdd17af3b8bc0edb3e52a0bbe4d04d2ef8736b39772e3f13f0aa120cebebfa6c955320f93655e56c1c31fd322259fd303721fe58dffb30814c12612704107e990af57d6c3b891f37364f86b17be0d615c9e9e9926d5ebc26328a7080642de1cd56aa00cee37879e4630fab1673b5ac0848e86dc464af5450da97886394ce76a6fcd6f7a804a437dd1c87a0bf420751078bc7be10a6abdbe988616212c1fd9444f0fb1159e17723cd4519cabbe35f463b7b707595cbff888037b589499a2fe581413a8743e827efdac073566283688a20b9706c168db6a25f97d1193c81eafec278abecf341b17a372e06ac334a120cce76819be5638df1859a8e626d64140cc8935424ec0765593f4b95ef9cd891982d3d2718f388443c61ad11fdf6306a145600e2451fbe9e4c8974cbe3357b0451cd810d67531d7043a0941dfddd244d76ec6c361b807bed59e0515e0d56741a50619dd0dc4c30167961d106fc8a24fedd9edaa35985f2f464d84d910fef1cbfe1bfd5ba1fc1fdb32184aa14d00f3357a0aa7313d62add371a87cbbdda19c65c4eb332332fbee0207455a032f3bf361a0580e499c9d3c6bd3a136351951d3b761272d2f4cb78ef1dac5b569f1fde7816e257584d1fc1b220c3c0fe5f8f4e52f97080d1be9267d04714935cd8f4b246d45dfe346ac3c62325b667c7efbdc3606cde1080a8fa333878c9a6046d1ffa674e851c4d568550d746c8b8c4f29732f9cde54e17a5068780dce1c755b844ee120113004931c23f099cfd81fcf2e790cb9d23965fc4d2bb9cb9db17a7b97817308430363512333034d5916ffb7e9520d47cba5152e84f2db374ed702abdc877131b5b0dc9c39aeaabb37063b7069590312d0600847a74466733f9715cb9e1a23d0687a5813c82a932bc3493b3de8832411e9f1c98b34ee27c41cff472c44e79523bcc35ef38785ba3e798f02fb57777fd4cec45b4a9ce0c5e59327a5e0c8a88b128d3e17fb856c6112a2fa552d10925b6359e111da6cd6aecbd224565d3a4dc4a130f9da1e2d88edc793aa968dc242b4193bd95d7ae276e3b1625814dd9158ce8bcd2954a4536311dd716ddf44589a9adfd125624f6e01121fc699a3b103f9bd8c59b40dac2b5ff06339c442e1c64aaa49fe2b078a94d74d6cae4cca5b082ec7c4e0c7a565c7f29a017821cb2acd5798a3a7d210d2bfc7ee1f2b6b470b20a1daca33e490fb2c33baecd4103d5e1eb938e3fd242080db95dc03ffe4209785d6e676b5ab5a4df202723be86d2bbb3b66183ead6f55a372865336bcb113814674273755d55a18de5e2a10260dc38670c89c8b3e006d389aa473acaee65dd80df0ec4fb24eeeb2287349c826fdea9fb8728bb56d2e1206dd89e92537ebf9c722216d1c3371a5bf6c2544554dc0e0f742968987f16d6a72cd2f5244936436ec30ff273f724cc71383a9694c224d184a15ea541450bc0f7db2b64f866636394ccc183e65d24f69d813e35ebd2b7bed84c2d40fdcd227f3a3849753df0088bdd29bac037cd9a9a799494559722bf20f39dddef389f0636cf2004a653b05b711ca8c5513042e05d106923336ee88e8e558a3d84d093cc787dd00c90191082771873c2c1715799a8b59da65b7c30d3f4768d03307f8d88553cb4db7b712d20c68778ee67cc1263457425063358da829f465fcdba512d37078c5577e65ffefb0b1832ba45e6c0ca18cf92480ef63025f5e082c3715d0400863d198cf73c8aacef4e8f330bf692f3f852fa1bcf1acdd2bc690d3a3d52178a89a4ca9c339ee4552b444b3c2805d29d035034ec8328dd6d6fa2930bedfd1badb474b53fb7c04ca7ca477c436875254642fc0322ac6d78239228d760687a26499b03720794c076fb2590e561316ced9c793de079bd59a5840ce8742772bc5d974563b9ef156ace67346712391f9e3ee4a417daf2be35e6380c1e4c94b7ad668a7e1dac880bc5e989ad7a947fe81e8bbf172608472630a26bda1c6fc999c80e0a6d300b8018e7eab7a8bf5f187566547d18efbde9c67c895fff4821dba0ccfeb4c6c47a4f621fc58ed77bcff3f28f1564df1c81e9c77ba7e54c07319db66072b5a986dfab2956f5c7e3445e79fdaf81af2c9d7db102c2024fb4c54024780cdd9d1b0d8bbd9818e1c4675f47b38327dcbea0aa0b0ed4f76957dd996c3b98e4b465b9d2001bec85db03c40d8f82b00066a42e6013093a62d958713029330bf7ab0060457788db11e6dad5a833e144a97c890e8eb615e2458eafdc04539c3fe06bf85fd51e49149a145c3b31a0483c47505e03cfa2562077ba07e4b877f4be431f39398db4e7f266aec862e8d814a9ec3b2fc151c25d0967e95d34103a9a96153c746ccdfbb93265d59b6fb26991b933313e744ef3f12fd86bbe8e5ddd2ac3c87dfe13f20d6ad36cdb9388fab4849a70eadec8655b907ac671eb517d3b8a31d62fb5ff2188f9455fcf2108e8f7e1124d24a293aca8bfef000e628640454de9bb93b35acf79fff94595d95506f69f425122bb292e07181aed2a6c4b9381a97f1f7428c07642951bfba656eb614668b0f09a6c8a34913c9e8f5e0442c56d64dd1d43bd171403c43b663b29f9967f5ea38619e6c41fba5cf9c86e908c930a40e3ee8f3580982d2a108856a253849f715bf27680090860eb3949630fe45ed7e7d1a04221faa14d53eac38a46fa9fd92b58a99b7212fbbc70cbb3b4d1e72fceb19decde3382bb24f4fb3c89a3845386ea1ad3029fbac204b5aa90d5cbe04953838140781dbf5556f903cb7089cc8061155af570bf46c44be682973a69797eb0e234738482c43606ecbc680720f48984b85cc8a8b0911e701565ddad92b4519045f1db47cea7afde166b30cc1aec762b8342820ad445c6781fd87b56d879d056baa24e53732cce7e15c607a331db81652942338aaec58234e0fcd0a7bd88f7e994cdc0b1b2c67b43e4a761894f4687799a901a498958cd6bea618163d3f8180108d806910e0977415b3036dabb67aa0c1b72f8fe70b4d393bed0379d2aebcce3989be6262b4436d0f985b7be069494e56ba3df31d6bd135a2c67077282311b70b0c80c8f4202406196a413bcc3a5b22eec51700ad29e47f389b0528417419b974296843210c42f1b7706a430b916907e2ee300f6455ea348c5a7184ac99f6a6e5967379588c2146d82fcd525fe5623b99f5e853f2abfc1963bad2f6f6db9b15641aa334af8f4080f60d06f43decce249e75c91d8d6d61485417e9eae393ff682820a156fad5414867677b2d2bf87fe8b717f219043ea4350f708151c58d433a0abf030adada14bbfaa56bb130f18d00464af5297f195590d6655a3507b45a84a697bc0ed2f56c58f91256a619c3654a4d00b0c0108e28805ff9bf51b250c0f96ed8e4fc831367c70ab7766b1a251532e4c4552996e0f3c91fdc9ea7ab7c5f6172032f3dbd1d1394f11573bfbefbb591c50908fb1609b038b24bc672f757fbc78b09ff3734754acc6707089dd7f4a2862183cf3b45af1f9a5b147d44cfa1705c2ec6e8b6d20736bf34bfb3a226d617fb6e2f7827e34eb59c2e33b80e88be5f2976221d19d808377b67499e8fccecc41b4eb2eddaf33109359aaa9809fab330e342548abcd3663bc131e174e39a86e1fa59b42a8407ea1a417c64a6df077948fc0ea6720e68a96b1e60e0683e8ecb29a97244bd69d23af44d962f1ce83161c8a284ed7c17d22561299c96c97d6c5b461080cdc91ef99daba5654dc778f363a1f378f4e9b841d656d79b7a8e21728155376e2ce995ec39ad3c5657767bec5ebbdffb4d1219fe57b98b7143c22d734ee5c63ba7af21219963c7fe2b9aeac39b38424d6755fdbd2d893715123e0fb98c09d16409ab58475d6bb0d98315ca9cfd2feb147d9994e57f6381beb8d976cb6baec110f5144c7c26bab602549d96e29b2659452c8e06fde4b86c7df0838ac474801f2c33058473e3cb178f57ce3437f9301c8f2b7e50fe06179d7657e5c0a0f4468c84cc0a5e6e689cd7e680c0566305ce4e4307cd0d6ddc34bac0ef5bac1b29eb10fc098b726c5e15d2818f9c1445cff87b2903799fc882051e9b8be8982e912be16515bc1129f5e03930aa227506726e450de3c86dc132dba7536ec6ebd7a602ed31df6b442cbb9531250da7d5e6fb41087541fadcb05279d9238fec15730b1ca2f74c187c7fc2277a491718f4aad9116489d93f5a919f9d5db7f1e167cc7c0ee9425a42db2f43f829bb61d786ea0a17bc5426cf834fac3415450dc2c9938cf5f80a9ea399b7a14045bd148751ce3c034d591f12d968672b2b3c969772656b188b79027f1c463b451f475809e0c9ceec98245d3854c011655f78152e7e407222e6d76742f16a059b20b3a3de5e27a49016f72017f2375e61dcb9d6c5aae5e2bc622aa9c26af96827090cf0cf6090cb962b78db1f2c25dbcaa4a1a3264a68a81ede545eae51a20cdea63a172db58303abfa61802046b1bfbc935309bad3cc820438434651a3a0c4ccc79c38e47bb748b8ec805e68bd69431bfc5645c81dbc5651bd1c8552c6a429ab48882e020420a6c25503f8057d751a2c4464573878e3126ead84d92e4e75072fd1e2fe4d868f9b60efdf3a772220773c0e16c03493892d70c419865d076b7ef4e9dca7c8d11d541b635bebcaf4442d7fe0a1c4fe2372d223f9eb4ca47bcb8b78011a48617ae83e34ec93fc8a6cfe4c11361550e27ed634cf3b1b803b058d7cfa10a1d04c6da4c5fb579013e3cee6a115ca3f0f4ab421383136c604cc7b26999547f17273a8e04f98b807ee4c62872c33d432430a2ab6908fd9900f39f25b74c1a4420d2e3bcb880a874fb2562e7fb3d57529e3885416276ae5b4f6e9f029b255e62c8f3428fa63b2418cdf4e6ab151c5252a862c7b23bdd70d504cdc4af040db5e289e70418499d8148a143e184fcd947bdaae52276ca1d29e1c15bcf9c04be1168e51aaee111ed204c445517905a1dc1f8c08e2284789b01759bc24f19a6d176ee71b68ddc5c4773611d0f9d129731e34fcb57fd7e83421eddd71a81eb74906e4d8017e2042534ebee9923ce2743a2a6431fb5aa5f97469b44a0a5db2b8f4f6e8fd77c71a06b7486505881104b9d37df62cbbb151da90198ce68bd4ecfaa510d99c5131e7abfbfc3af7d930130627b6851cee553a63b7a4ae60c568a3c63b23ea9d8c04fcb9e7cd4b982cd6fffbce53b04e6a12df82cd6c81b3e36b05e6fedc4d8e1c6d536d2cf4b4376d5a9431b44968b59f5cdbd97400a417bad72522b3b7065d06bf6ea20fad4a1960fff44289693dcd7660fa80455cbe1a012fb9bacd089310cb8e10a3f9c27eb432891f3019caa08f9a178c46d041f76fc18701d8d02bed3a4320eb707154692d956ac75ad41453a52506b8f14ae93b60653ce34cd4c3bc615ed24c18a5b2e5a5cc2068f505f590732594005d239aac97811528769a59e28798cc0153e61c20ccd3b0341d05324ef036283d93e87cb04315214b2df3d92b4ffcfe0147d9c07486520c400ba5661d4e98993ed61988982bb76208e98fd0e29681f3123731491ffba9338fc74ed145fa6019e954355d9d581c403ddd976e999e927f7fa01f88e804a102b9556ce17f53cf8d38aa5ba2eed488469597553607f27700a7368b11ce59c202d18f9e8e079f27030c053a22786350530e37a58ed60eedbbfb833a1009acff847f2dc2dcaf30f91d8513ff3ac6e1b6a712c2838653516f1ee9bad624956a3e0492cac9d5fc1c8d42f076727934052c77f6c05220fb413949001a037cfa5c6813cb15375791fdde6884569d1d6f335f20d59308deac6bc1a10dba8c17e59269c43a8e34bb3d2f711ffd1db7d011a67260717aeebf3900ac2981164e7c4e188b6fc518d1b82dd0867c5b3a0993f3517e4595466d6b82061281455120a48fbc5e2e2d54c2fd87d09e915e6d45f62a77fe7678a9785642106bf4e37b77db0a4a7cbff422cf61606d077f3047ac356bd864e9c970fc9a1214225690392cabc6fda7f2f49457f2d56024ff200106d5a514586457ef35ec2b6e4c034f72c135234afe6cd492bd4d0ad2af5da22c319de034c661201a9ea251c0d7bc0db700133ec2f70048a4e8b27cd4901525559db497fec690fa75d95207b7df40b8b6e47de28b027d25f29e37bd184e13492862e9db834839351999f253eed623b088b26f977a074bdf3b438794202186f34fd15fc5401836a1310ba549669180b96f5f1440f28928c483a07a12b1a99f49345bb6905bf9eb08632d710418a8d266b28802884687a416b9d2bee048e35a15123be858b07f928b65ecfb1196506372ab8f6b86053d86ea3de37508fdcaab74b386a3819a523b02ee21f47aef21cd10d87b77540c9db376ad6217ee7afda9b335871ec933e463558d91668be7cd87fbc72b3640aea9288e464b082a339b4c70234b9eadebbe1bd45dc52a21beebcdaf2875cd8f2ba1678cb1bc435911a1fa8155489563c6030ce78a7fba52cd49d6f9075cc79695c250e9b1fd450a7ddec72710b5934235952f5be70740802691839eec5cdad0a8cacc7021d7d11d62e42259bb04d32fb6870f3d34431b8d239cd4e569b0f5d34dd0261294d999eedc5269d71c4937876ceb6ee48b5a6706a6f981d69dc6e245d0f1d8d5ea01c84898bc0f67188cdc3ff4b400b0de1d852a5578c87c8c030e077697c12093306932ea03b07e893608f9a5930c32739c0c186215ca2ded9240c579d2bdc3c6f2d0dbdcd19abcffcc4b055664a02909134393e1a8163cdbc359c1560c8874aa02a7394eb7769b235a1b239775402da3170e9a62797a9d5aec669cc4e3cfa01f480b5f431026680c20d3c97664e0f501d465226a01513710efa5537929ad3b3b526ce65a3ca630299e317ad2f43d6857a79afeaa9d9aea7580af994fd382b52cd6e9030be59e5896630b3cda4b4faa6b5d5d8757f0bc567cbf740934c2d96059986f2e2bc92349558781b9cea2caa782633918df8ad546a622da81ad903f642551d0c0214f5c662094fc1068bc6cee93461b4f0e7a75deb52cd28710c7e3481dbbd8d38d0e11118216711c2b4879fe74995fccefe28e24483e400fef3dc3a953fafe86bc9646a01954441fec0ab47b7c63bee836b75a321ab6b8477f16f732678fe20b0fb10e938c8a27f69aa8dd3a7f625bac7627d4755333692bb0920c52a23a52f27b898d45d746226af4a79ae533d4d423684f5842dbe428499b1b1f442b7a3ddfa338e360e77ddc9b3c7463078c06169f8adfeaaab733a5c3bf0c520ac85b106d1f7bac85759e35dea766cb7797a17a0ddba7151fcb18a50cde776010a6aa711a4a60f3eec5caef07e7b3552d026367b619dad34587d94e881eef33023024fe93bec7a0c9bc8919dd4c43c9f4d307d5ab13275e0f147e2ca969de0af700558210cc3f7e88bbd27d9c738566c6c0a0c6980537882774ecbcaed2492f7baf0609229b230301e5f8df3d4da280aeeb56ea190d59aa54d63acadfa409afa244a7e8a99fa59b6cc85cc202ec36da76b4cf7648f7c55ab3823be590266a2389dca1e9cba49a9b03c4ec5b4c012a4baa4bee74002a0bcaa8c171e612d7071dfbb2994b4552ee6f2aeafd95ffbd612d6f2bda4923018bde1a8edffdcb0e85ad288b2a8a307f220c3dcee5cb3096b14551d6bbec5a2f41316821dea7a65e7b2134ccee56fb55a787d52bf25f7e2d90381471c5333ae78439da3835798adbd0fcbd849d1ac045d390367ebc6851e02c80c0c239853d4fc43e77e084d35ab862a3a724e27ce60d39c9777bfea1d97d24edbfb7e090cf3261272782074ffe49964d6e6689d17195865c9dcf96a541a1a6a7dd803177396af25493eef7d3589083f50edd652b40b8138ab4bdbdb1b2241c00ee1e7e62ca1ae3c8058eef2aefcaf25fab0e1a5762512ea8aec196c4bd8c864927aa4dceb79298814a79a1207c4cc7f3aeb1fc2011adefaecf7d46fd11853bf61a59f34c21b7925fc1794483bb93da8483814c588b003e0bb20b99319dd29e5850ccadb004d965c60ca84cac243be526023663b1f50f24ee4afa947009b7456748553505759d118846b9523b28ea19b244b7f8662cb2f3475bc8e9eb05af0f637008d21e0e47706d6093dc6a6630e80f5c09ec23007db960138ca13a11a6e318023c586c142f9741141cb2313473de0e974fee6e23c9560f0d9660cded6fe3a68ceadd1a42582960117f828e3c5b1559f0511c9325808af5abb71abb3682ac961daf6c63260ca17141e58fc2afc603336bc107684a54fb350806c9067c140450b509037ef9605e32db59f406b2ec3d54c487d4d05151a7adb55b815fcde75d1a1a9d5614b545c52707e4a7b8af98ce053017a1de980f86d4e540c77f29386269f8eca370915be8da474da17021f2ccef0bae907505dfb8d5bc7617d6f845b93824e8fd4ae7a182c0c44c33e3e54c5a893d53f5540e3786ecf77335b2b5a2b8014dae1ed6fa21cf6b88b9b8a243ab728c84c90c7fac1136913f857da45862da2a7e585291db3cce4c8fe518fe4be062d3e7e44f3ef3be14575e6883a935877678e1eb8fc9070763a9b4e9b42edd288ee60413cd481541d97dd2d362f9cd9e057c2f585531cdd850ad001071f33ba57d6f2bcd09602fd2d4a4d5d045d694ca6d11bd678886abf034c6271881f408acde0846191d25d40219640795d3b0b6d5a3f491da62cd2d35c87b57aa806601fc94df171ebd416a9efdf414088cdd8f1201a2d49cb2d6ab3ea20a967ffd2fb209e4ac307bc3ef516babcd439fddda24d472221e46a60af96f368d4a24f9cbf851e8d805a1c4fda3c1259bbd79927d43eabc03fb4466a681f7101b4f9a635f5cb9d3706e1d5b848eea2defb4354e0646839ad58877605f18d3654da748241461203266684ab4caf00a8db2db1c1e896821d4f82245a0dac71eb79300815e0091a9c6485f0c1ac2ae4b55d9cdb5f3a1453a67d37a1edf80c6af0d7a8e62db365c191183ebd706295a1970356f0d91e6a1bbe36acc8108456c78ad02b52ea6d63aba53b3c76e84083c2c1ade07fbfac32090f4e4ff216864d46fc232e5f5f5fbd19dedc69e538e6d41f43fcde6bfa3de7f2365c7be1596438f2b9a1e20a36acde432fa210c216dd94234fefd57a96d6dd42439b7eb42a2a3ac817278781073c7fe1228ad56bc9318c3b5ac2eaad25b678e609713075cc5be451ba156c211260a16bf4ee84c4e24070ba5208b87c0105b9ea9ca1126e9c4269510b5981c07520f8eaa1be7fc4f2a09376d34cd97374bbcd92bf71f91b9e6fbaf617c5e4930c3e2bbdd17d21ab60a3142f6ea64ed677d7d01ad91992e7e462082e8c2978dfa197f3fdd9a034ec7f2fc422527cfb53bc2544b0b5cc209364c88fd5ebbc0e92bb0d6cf16e0f8c555191cf7fd463d11496645df89aa84da1905164c2fcc3586c14501cdc47f7b51154ae7c3e43042fb2bf014028666d155f7f9d2c4a0ba3fe6113001989301432f6a3cd162e847e25c9566d742bafadbaac97a7bfc8f9a08080825ab9aadc90ff2ac86ade4a191b15e06c06f5426cfe29048b99a151a1e6cb4987ea6b1cadc8d347a8ef4f04c3907960de502a464b40c383505c806ee84e8dbdb9d65c2bf458ff59a0ac717b17debc968a636a514388489c202965361bbcf0b4c77a9796eb280ddb934285f40d2830f10eb32a7c70606e0f220b5dd5764e9991d3d0cd5a580dd03119ac9b92b227062df5f92ae527d49eb34f7ea5dab0430e2bbea817be5608fd5baa91c949bcd9f1ce70698503ed1275483866a617c7e96fcb502b1275f5810d44518750ef7ab7b42d6b1487947b3ccfc1b02b1ff54fa9a795371f7ae70ee85d9e027f5002bf0688e513a2024f389e26c353eb9ebf4e55d38a1e1d1accf322df2f191affd288fcc5080e4b61442cd7dfe6efcee8921b34d98c814e2b09f91b22b089e9c1fe5596cc16d697a18f9d6f75ad5780c3801598f0ba395e7cec7b211bdf32627b753a24acb67c42309ddd15564d9f32160423ee960c07fcd8c64b51dae0cfe997b48efd8b9b41db31700b582f50235b63887faae2e891783079f65e13e17f15ecc8af3e4605ac4d56e1314cb3425562a35edc620460346c839842635e1e7834e08251fee0031142ae64a4f24d3b91a07e53e54b9a5768d99cb6b71b2d2c4ddb3687d2bc7c1693d7d0002ef4ac4d6848eb7c7912fc4fac60c0b5c9002ff10b6e8012f4d2a1e120b6e685e356a19a1d8b112b8ff0b4adcf114473ec67484a985d28637f2b3ee2fc7bd65553389512920019dbe6fc9f2659feb91bad8cd68abed53bd46528608892b8d08c5607b95c4d066a4d051b460eea52be8dce4a9fd6c38625a9b0eab582a80ded48314efa402cfa802568676830ec2996ae20aaeffefdc32982670106e45efac620e94efebe08a8b28c7cdef90d04af267c6717cb4403a4c5e961e62c70af4bc705d8db327d9ff5cd6ef105e2234e9187623807e96c997f1d25fbac11d6be2ff2cf3cc31050a290452540a94b4d752925ec0d989253b9c1fee969822070c684e18ee41337503a59120c2fb8ca41f0a868563d65b89dcea4eb4e176cdd0ddb8749f58267ec25065fb1f789867ae4c342c06aad5bee88173fa4b6066b10bd7be9f507b1885f8d6500eb94687796e682dd4e58aa1073a2ed85d2d59fb34b5c00ffc6c5ceee340fe7207004d4aaad4d1671338738d26cba41082971f549d549faf6988a292094b069785e203a0054cb8075814d0e0a2017d7e0a8921e8daddd140dd74847d3409de22e7d0cff1a374e13ddf6301b31ca14c4afc4cea7a9ba0ba1232a43a02d63c12da61405f766439e6edca0fefacfb2ce9ec0959afd3d4444e01f44712341bc184fb8320496a0398b7a1ea5bde96e585ad101271c62cda6fe7886453f4f1d6ac976ccd5958d228c7eeffe64af895e2c8a7afab878e602b10a61fff954666fce7c9a7d64c7fc0adc4d5b6063eeca328a559d353e875aaf1db72324799821a66c61bf7c3649cff75881a05715ed210d231d32b2030a0411c0321a9dea00d1510cfdc411ffe2ecb6bd59317c669dbff6dd82be601c0b0e1c8726fbd6805106014bcfea521a51236cd5697cb25fc1912ccfe12fecabb441dbf22c60cb91c39b6fc409165642a74cc41116e4735f4548110d708f0e861ff87d4779c002e239969f1fe0e4f903ed0a3f9bf1199f834f854e1c770141837756f33bbbf8a53f877748a1cf7e71fb343cc45be13fc6be49c7ce62c8439195cfc65d7c059f1f1dc887d90c17ff086a20ed6317ad93b3388325c3e0b41e7e1a59bc62d4c872fe443a63bba45e4094b9260347735f21f37833d29e8482af00e3e0b507a4faec8dba4559301a9734c0b41857dd93ec3e08549aeaba87cac805eb608a64fe5d9d0a59cabc62dd277cc36d0fa1c8804cdeb0ef4f71279ad5ef441b6bf55515a5e6c6511f433d00b25202d15fc58d26a88c5ddc4412c2c73edf7539f0247371de7849ac0a9caf3686f671357c8f94e2e82924b85cb39a2005ac7a1d7755cd0cb912865164b2e7bfff6866b30871b08a8482851a9ce97d00e43c3f2bef96eb265fc7ee7817262f6b67655e85c466fef22d2c22ad95615c70aa80bd6ce688f4fa4885e262dbfb6b8f38de9e21511c8f6de3b03b07275503fb38eb5c265fba284cd84ba1941b984379569e0ee60dd960bc56e14ead503ef94b83e4ee1eb50a1da35ee2ed8792009ef6caccfa3a9ecc5443f6d447a6b7ac213f9a187148d8fae9213e3086b8aa8ec44e988c8540cb08ac5e17035b50b3de67147f14812fbbcb4455c7f5ba41ccc680530798909ea6d2dda6c4a7d0da69e9fda5e6dda8538713f16ae4983e816d9e63686a90267ce5f641b34f1356b269bcb840b9a124c80bee813cddcb8fd80a0ac0e58ff8a89942c2948034e41fde5797087651c6462479d0f79e7b572a5545ef773080459d7dfb3a55c2012161a7e88c0bdb0215b0e645358886639c07b57fc85f9c2ac4499260239b5696e2cb8c93e668eae511b896bd410668d9aeefaca09a5d31c1a652d60bcce5d38983af7cf7b984c7dbf0e1b97d2ae9fc10aaf84cafc7683c337bbea449189f052e129ac00556655e92803c92db1cc378e3d78b0701d08de4acc764bd8799b554fa5d8be66498bb9d0967e255952018b7b605eaeef8183f8947d197fc09ba48e650993ae9089bc447fd5ac248b32c432dfe9c54f128dd875993d60959ab1183ac1825a02e2f87255328105806756ffd0812303c9ddd0c1c77c635b51501292c308521718a8ef2012a67e37e95a31945450287e91076a3423d64fca7805166ced1f93d0df758da6443e63e0c758f1a8b622c85e8d448a6ce9929bb6e03c2c5c8440923018c684354d1c0cda3f124a756359095e99474850b313db582c101f9ee789b508081b213e36f3390ec4734d8b6eed44378bb60bd520cd6417d7f8b19954631fddabd4ed9df139bd97d78281b0dbcb1721427e00548b1feee4622d274b81f018a2726d619f694c845d2d3355c7209234fe5f6e3d8daa8a7f1061f273dacd1734416b2071091d67c36451f04893d32c17235ae2bd90fac4b246b1a0e2e65e53face1b0aa4533aa507cb13bba6b1998d4767f56553a255994d8ca2263f86f720de534104de0d247cef2e98622854ee9f7b082b4642704085fdba1914866d5bd3e443b21e5252aaca73544df7d48d9147c26d458bc87356f2f3c656c1e487368d67f7b79b3647720fc2d4d988f86088124b6a06eeddf5da90156229c9b38887d93eac7ddb8ac8ab0801246995845ba266fda00ea28152ae00c19dc7c50792b356581fe3255e47215a9c6116026f480b45dedc11b6ed8105953226d6ae50c5ad7085bcf02668260901757c4fd016ef7d1e9cf225f93dad80c0f36d6ed6b9f5aa2add50f07f0c28b5cf1931f9653025b4c83d59981320fb6f0e31445bde67f4c532ea86bf6dfb6494c0661e51d30ab26f493cb10323a126c93cc1cd00b2805cbb43b5501987f8b7a80b372f542a13cebb83631558ec350625a62bb939a7800ef8f2295921ff48f4e24f62a8bdfb0f39145a6ef66ea762a78c2a49aacb0c1cc3eb0905e129ca03b231ffe5f5f1d1ff4ace9fa4f109cfe204a3121f646cb90814249d4ec7a03d1f19bf91655cc59aaa1a68a4463d29b4fb1ee6cf096df31369dcb81b87aaf3a50e52bd4bde2bc787c4056f2810b480acb7ded49c395159974e0fe08f5372f6b82ba23bc42fbad2180951558d896829f34e4aef0cdcffc45ebde687dc670b4f1cde5aa84327e185b6b0431bc48625b0e37277e8c4e8c43460aa99bba765db8f329c791befcd1d776e43683adc6faac8a87dad6b8a8ccd304296de9d718a172cc70dc4a2e503301c2229de726ccae5e26d1c3ab69328d7674cd06ceb33350afffd2be6d3ff139f4a88a517129140fab85553df828af3921b903c38d0f9e633df665c32aa875b676041c52ca4b35bea68bc41883b50d18c48fca7a9f393979dea30869986914e8075aa24a00bec5edc74425dc95fc20c3b21ace80e7166051844ca45ab02768b5c440e224a273d77d67caaf22eb7485fe00a53a7794fa74329b0fb2fd0c3278f3c1feaec03ce33795dd9bca1b7c4683042464167c3fd9f9b52307f95a379430dca641925d077c7af727d7e180039ee4bb451b887002eb310e119e8b110bc5f16c2200ee844ab80b53aef26a4c2a9eb313767dceac18fc00c5caa07b31e8098768e306de478b0e8a75ca7b458b0c54d139ae24a63d8fb73fe47f7d5dd2028b8b61e247a8c04d4fb9a73a2c46631403d33041c6f18f30fe2c053dc380ea405c967d3f14b92b943f63bec03fd53f52d6844eac513f9a4177b326e7eb5d48515d7d5ac2c86093f26ce26998bbe765d897372c092093d6e69fbad62baeaa8784898865f72987b8dedb8a206d7ca2f41e31dfd7481280a19d6344de1527d382139840ba35b0820ab40f32c9d6271123c604d6aa2b325ef50fb4dc0544f831a8b0760d50b0b60997dc02bff47f28a907d7363eb774f81b10b2a5bbbf30baad34c7d8d07c0ce3c703e1ae9afb1218cde232297d421488480ced6619ce60d3d57890278d6f50f5f6520d902e255199909fd2f16dad9c40a12e028fda42d3e78c96c40b87ad128e4c7103eaf64f9a5d2227485ff4ca98619c215143926440a1af209b1b3abb6d5fa6cb5e32e6cec83614286ee6ef67dd3d8b11e281d343ec58ebdfdbc85ff89f473c6464d5e8c0dc0c5a5189f4e8345d32ca8af3121308d0d2c7293ea5ebc08a38848b26c3706dcf2b71bec75ba510a33602f4a83e0f7b9b7fff6e792c8706f368029475824d0106ebc88c6cb14556b63a9ced13542ab6854c240740cde31f1dbb27cecf372d35b97b528887f68b39b69aacc72c2c7bc1844b349581deac0aca62011daead792544aa2ec75c02b2b8c1acf807dca758fd161578142ea822ce0e7b16a945ed2f180fe7e18eeb528bed5e89825c30e866fde51ff0e4be001fc4ee460b6fad891e57b477b44ec6b60fa2718898a0fb915150367a1ee4697a2d13594f9140e0d1f85f027a2a67034b7cc2085c99d0f7affbae96bf72869bbee019c0cffd9b79d8268d77ef41f6cfe813b0032d7187ea14f34501b32d978664d8b38355a13e8fc5ff52231d04a74fa2bc4894eaf367c252b6e95d019125960f3432a25fe5c427eda08f264101576c9edab40ea0b91fcff0f474b0a9d765862603fe9ac4443cb98d5e6d115a8d94fcc70a2a6e66a0973018ad8c75eb7109c7b153ee9b3099ad78c85205a8c1078086053c5b29a2b11f2d7228f969e7c918abe14ca3a64cf3914929505dd65d23b2875657ce4344e7b799db00cf913f0c0ce0b924a2872c88a459879d7f80eaea0b97e6fbf06864254fb1d2750e220a2abdc0d56b3751c1a725309c843c8608bf6c88b269aed9b31d8c16c263d491d6770e2f5c48d5b12caee599ed31c9430eb0eb28af94ad025f093c222b61c69096aa062afda972354a138374da2fc3968a7c80137c56a4827dc9f900065711f0afc9f770e44693d10d161b8df5e4f86148a6ede0b6256e1ebdaf993a3e9c0af088915ff2c38e222aa4ee7cae866c5a3c90ceedea5fe87c5a4c97d7cdd89bca1ab08abdc18006e3c22acb104ebb516a9b434932fdb620bb4130d16f81c850036a0e2ca397ff44dc20f66e437194348b17bbcf3dd80b51b500b4d8d89b71ce9482e74cbb5fbf6c20e98e52a9583245c8e50f056943719efbcd449e33e3521a211f98aa1c6a8a26c98ad180e104d92120110d5c3f1087e777090ff07b39e2581cd36ae83aaf76a521d8688da65843c5b76cba5283449504e653d383e968af837ff84343759cde8fb2ace0cab0f0d2bc4cf85d229652b5b593eaed5de208cd72f4369d1f1a669ca5d8c0375d544c801d7718c760aa112bf380b49d1e7f0eb51f9787ad57191cfc1074ebcb862d1de17eba1fd87682d96acd48624775dded04e2cff04fd12ac0333c7af8b929e64a9f5395097597c58524e212bb54971c6525d4ba5e7735a3d4b9d3ad071ebf0b64688548b26439618ee86d2098d44798a11687be51f732d08b53641f59ad808dd157b49c0f2dc44386ab598b61b69d87a5d3afc3e653fdd261fe7fdedaa6ea3b52afcbfe27a4abb96fdcc551804a6bf2a066d7520b6840569116f0cb62ced4542f6cfd95624303bc9f2bec1cbc5720e150889738766106a81ec62904bb2264d037202144c5677ff69580484f4b35225cec35a3976094837188c9971e1b57b2fb4be30bd972e238ee1f06cf32a2721d82914251e9d6bc336ededd0c4d8acb6f8680417a55cf34e4876db957a4d1f372fefe0e913bf6195626978d323e820220c0a09482454ccfa22b8a160e1462d7b991510fede49797716b780584d6d7b07d1f21605d5715e9298b97797c7fe793ec2e3a1f5490900a735ec6533e808077f2c516fae88ecf088bfe8770e5384c095bf914db359c29fe13b0c5394bb923fd0c1d59c97f11faeece2c29b058ef48da974dfcd0470ea09f36521def098734d75aed8b946ab14d1ebd12c4bc6268cd4aa0117dce1c449712e23ebf288728f6ae21bd710d3e162d38ce68b22216afa188c914407bb29b6ce49a78fe1bc2942dfd7fa31a88b8aee4eb35ef0d2fb7a6fd6c204e16992345ac2da0babbdc078ac25dc0ad23b29aa3a42b5f8dcf3d839070731cef4526be8dddc9e6f152c3f28a8143d2f383b87d97b06efda6a31bec1c15c47099601e0806b98858ed5a47f444402a74bec586a8a452f4077ea948222ee2483a411006977737a70be0bfc93c46b37aec1a7b3f9e4bf4c4f38276da87c6b26c0c5d8b5ba8420d71e6598c42c53c33005047903a7d93d33405babc75d54760651e57b8eebd1b8ef4804bdac7defa1d6b897bd2a8175c0bc9c1eca027525157e136c7c2e17366c897a0ca1cf0ed7efd26bdf62d0c5ee76264430c7b5b6543c1517d6c216fa5e71b566f0d82018451076ee7fa6bd329fecbed8a2ec503d6e20a43c9b33f512b46789026376db55217f6cc95eb50ba82eafe9c319d1d06187b975397d81c100098735005a2407671cfa630b7b1a3e5c2687b82ebb2516e723e99984d8351ebabdb1991fad2eb0fdc37a1f305ecd6858de0044a43fedf6868e3e74cdffaa4be6e15ef0d8398641f0880190f607b58a3063e302b5d5c8e33817c0276175adb88634b06f6b8b51d731d14104937e13cfe37a4f7438a4ccbf6142b8350d96e66d8e16c852acc155a8ffca354dbd133b3d5cb265945f3acfaf5dcadc2425c74201b5369c382a935090f578cc03761eee0c21383cf8686173db4ddc672e00429eb5f1b6c1a0276d032e78945428b958ace8db1b11cd3817a8f9922a83169a47e7eea022ce343b2d25135f349fda885675d9a702b9a5c9f5c6c08e82ebeda18181e01139d50f757586717bd3f9e3a0401b76b25d5fa028c68657486b85b56bfd6837279f1d51c4e2e25c74015698b09d3c2942ca7d2573355b40286108c9490622b0e285c98ce1194871804e34b205d2cdb7be1dfecf9d5d5a8a4d32c8b2f671fdd95ba84224ab9529a8cbbaffeba452d68bf3719b57b5073eaefa37988dd5fd983425711dc585db4a42f59eea2f11ae70515053359fdcec369f1ddc7fc7a9d309fc99759c0f47299e3905eaca4bc29f9b12169d8ac72d6c495b12dcc68d05a5dca30b34d6bec3af02bd223ec5c141e8189f1b29613a2cf4163c51eeb6149f7cf7ed714bec36ea7af990ffc0929c7b6b0b4a45a2f82b8f67a967b68fbdcc4c1ee63e10018affaa877db3a177a2e2c7966cbe03b43d72399c2fe9714b2713dc6aa41f838ae3096b310cccb35a1bb8cddba0d3d911b18e8ea70a6737f787bc7d4ae7af0213f45d5198bb6268e8c3893d07ef15fc7af2bcee6636417f2370530b58614cb3deb19b6201f89c717d6a5f8315bb4d8ca16d7aa5124f6af0e81ab0eb6629694c103e5c8d583923b10094764baf8cb9f893ec998a7f098a8af98831b3d7054ed195ae02fe76b6a9c3f4a4b530547d4dcbbbb6180089ae2bc071a9314f646e21224bf807f93686dda5186887e1da8259650121f1921cdc202dfe89f7169de173850f6856b0093a4c92354aed9b9f7143ba771f1200c17c6488be856e47a5b5546fc5013d881c0ceb8181d9f1acfbdd4990a9f1e2135145a1b4de02aa195c7543e4746e9796b98f0508614bd6ee9296590f79a481dcde3b7ef938b9cbdb2990859c0f1da0ac59c28d0aace9ada5d32ff4caad1fe6347f08940d28af93e686eab089f07be9c4ae2ce35767aad48bc6ceeee497a1306df6557c9ff28b60e701de328c6009afbda09771c8b786b0dde91fdf3a174e95c2ba916373ea142150360e7547007bfbd56e2cc01a24ce950cf2e4e5ee757fc2a3d7c4cbda18587f4e294785fdf5b80527b36f81e5d4fec87f5aa7d3cf6bfe2eca32a15354fb9a79fb52b51e227835e74e1ab62a91a3605cc0a81ef2688b2735ee75735c506c8cafbd22705cc3e20339590d5f8120b75715f8ac918b5583bb11b8d8029a8a061857a90625af43522ba2890c2d9ca29a351660f520bb63f7fee66ae44f9e86e9ec01a6f72be175a3e29b3f49e50b8f55048d0f478dbb6152ba491d02e8f85aea59ad253567b184d6d8aeb8e9fe113a0c093888133e12d42fa2547fc936e927ea0bdebe51d49c8ad21b426209f350eb6f660db289e5a17b817a6009723c7eff53b3dd60ea64b6cf9dfc9524cc7d79cb41856f160299539f0d32a68fa96fc70ded71c4b8ec1505baf4b51e62b4fa8b13cb9a30f4f855c4c9395711ce5534e22ef7e00fba36f7225a8b9e533890820d813497725e31bcd0aeca07ced204cb8a49c5691046169bd7772940021c2caa2cbabad0721123c28932e2ddd7d083155badc577100a23e2b212078841d903dc737b26dd5adcefbff6f38a04a5359d3fef4d1f17b6c85240398f608b5f7c6018fbd5553ac40c53a86ce1961a27749f54fc7b2c8ed41277403f9c637581ef142b6da0940693a3d4bb0806097bee383969e601ec16bddf94bff780ac2ec8cc7ef8b636a5e9efab3f354b0fdab7effe5f611502f4d5da8fb39e4b353a23196de431a5c877d397ed23c085f813e3f6374e034fdffe3d6b20c3216b8cb3e0d7894e16d0e16ba995028f5050d3d7b4187e532f298e62f585f53e034bc89b448316dccea58764fe78d4681d485314291f244cff2cebf3f56bfb0a58113f5ad86eae9e7b36d71f697bc54f171e1bc626d1bffa2e502579fbf92184f5ee69a26c3dd86a720a4579d2fb7c2421b5b52a8bfba2e0f90df3075bfda15ff7daaefec6415570353db9c46ba8f5aca48479d388d3db10ec495e574d4e3a3a02c1bfb6d9bf9592c0f18b0ba72ca0df07d62427ca0e44db3cd120a894fd1cf295a3472b499a266c01d75a618010980c2d44dedea15523fe77fec877c911a4d37504f3a4637eebaf8a0dbbc0b0ffed93df08e8d409ff8dde50a11a7b7cb1373dc990922ae2108bef9c52cc5e67c0e6dd853040f26fc74e51043546d68e5be04ac649a6c733351fcf015fb5544c0f46935d03c773e8e9cb20b6b84a02d45118bac3dbe0a17f077f0b04c5494d10bf8b4530ff933cd5415c98b7663e6b3f57067832a2b93e71e577b4eb86db60bfef6c96aac9cc8d1d7f104b8adceb68d08db96609a84e4a37062bba16a450414d7cafb720827d9040058463e613a5674d8592c21d5b6d4527c881fba97618daa5c0a9681922a29cfc49248a4ce70aeeefabbb3d63aeaa34f54f243c9f9ff742abba7ff8690fe67a315fa7b572373b2d5209b2f11232ad9bbd840a240be376666f21ebe1b7d6772d1809c378797156b5835029b0c366c0f9ec439731a2371c12a6f00ff05cf907adfc849ac804253a046de085c5a578a2103ef0940d3e95ea25425b6fc1773adf09507c653c6399663985d9846739e41edc1c8053d2c12a326c6dbb7839ef975d29f380183b5fcebd800126ad93461facc9c14baff358a945113d03f0bb9765ebb006b93a9a61521521360cc5b00bf6004e3198930a3921d5fc896930e296a420c496c856c5f825b00ad5a61b8f83514da3f73c5a9927e6a2fcd9106829eb46999f6896b256d483e41f9bfd5156e0b817ceec5164962b3111df4941dffa9d09fd326a5b4cd67b387373203e95d99215bf3c374ec0aaaa3e4a3a0061f5b8894cf34bd6080eae13443037e584a239b5cb3298caf02b4183c7c019b99a1eb30be828ae72345b945c0bd140e8acc00cc9085c9d2d56065b77be085b67fee7d25d280cdc7d077061b7de4ff4dbef26344565f5979d7300908981029c1eacd4e75fc88c2b8a0d082378c6ad484a01e94b7e00c723bab71e4f8559b23c79181101f19833e3c80fc56fcf8c161128075fbc0f6935451d3c9086c5865510c7099a5adf0958622885bcf67470965b483e4ae8410f780e4b25aaaf8b81fd671ed508979fccec9f2e894bc5c80ac30ce2ac494975dc9da30e4128d69ad8338a9690bc83c17c9c052ae6d3d3828c9f035d3aa174ea503702082e0ef7dd5de300bd360ac52e1849f8f9636f4f3c93876f3c0f748cda26592ac27d6defb452bb8f0900b7d992f9287b1b8ec0e6d63f8becb7e9d24babbae07330f64f7b81e4a7560fd6a467a271713d8e9b3e191b8aaf848b2929cc5f7f30df700d6d25f186a5c61357f2726b88d30d9ddab49a507c2fa04b54d73f9711f1d1f8accc7d5ff4e8f6eefcade8341fde417e2697663585cdd0a4437b219332dae57e44f640239683abf6c935f234c4cc3b8d7126aeadf86d4f38a00b36009b14cc334fb7bcefaf1fc5ef3e3b8b9966e63a8b2c73aaaddd1e2463f8f8f6ca8bfe6d78ae872ea4408edbd88d9d3651dd0910d0c8e1f3c0fcc3bfbc03da45adf443d5816c9b9b8b2d7afc5016189f7493224b3df36470440900650c5368104cc5868fb9a1be897ccc116969a5471bbf46bd36ccf79a5cda79574b26b5faa7c7a83162577c8664bcdcf3a620cff6c405a5a19ed818270101084d3e545d9d76c3bed776a30ea21d23dcdcd2e8c48e775f62ed4bafb209ba2673299b5449f708cd1c06e32c7a3a6190c9752088326b7d17604a09802cb116e1de3df838c5d49a4c3f6b6d12d3996b430c17dec5c9231b62fd670feb40df4f22cc43458b4ee759e65f321c39814ba5b393e9422d606be27768d495be4ed3751dd7a5f557535b36391294cea996b10b6432543d626d9d9ee756deee527f6186b58b8ddf8fad150f08f500d4f35361ddacaec24ab2174ca79c82b7d2884b9f77d0cb20abfaecab9e73c2143c1d4134237168d87f9bfd993fb9e8745cbcac9efcbd9402dc9dce606ca2e56c0054ae4ce803b661ede936447a023213f8d617606fb035ec05ed204f47cf71d152a99e006c368653c5852a1e03967e8f2fa657b56af603b4730a33b9348daf1d8ac8741fb9ae4bed218384bbe265804bdd498583f679e61e5b92f42159ea432b9d5616c15d53deea39d262313e9598d392d4ff502469713e3aab4a1149a5b60b35ca7994d35c74ec30d0ee81adf2ea77f42e54231c5e6f82765bf66b2d61905e31cd8535f103750bb5a4fccab7a170751a2100dc075c395aff3cf73046f6342c089ba384b6a9f18c87d1c0c5dd8a6f6cc51d421aca363850c430e053ffedfac233b90958f487e7ee844a7bc008c415b2984faaf23fdf09ccac4372008ccdaaa1d32390e29434d48b554238fef993c66fc9e028d12151cd17c2154016e53590b77b9a3a99e8667e4ea400ea4267b00751ed8ac9b3a94c64ce24517f5b71f4202c8fda98ae9d084ad3388d598e87efb4725081c96254a320563570be92caf71161869d7c31bb737441b50e36d00017746f4fcf2eb8d77c40fdb3020986bc4825e54914e0fe9f6ba5d2f9e5b3bc8c9be67eb224e414916cfd17890628aa33ae88a7a777bb47314758f5c24513ffc4cc57c3136883e333c7170ff2547bb93c0866ab09e60856461223ddc7ad5e0aea7d6bd8eeac9dd6e572008389396384aa77a79947f167fa174ff9de87a8fc2e21b1211c2ee0e1f0d91844cfa01ba2944f326966dcd508e23a125b3fbab75c87402f3f868d87044ab1592bf62c99a63a9a9edaae5f3e1b626f323cd6e5342636bc06a9d3be445962491e78609367501b64e9120840a361d135b02afaf473e270cb19bbf72f32467d053d290ffcb168d78ea7568bab1cf9a7acedf96a41479ea5891a121466ea336e0552ae4a360e45d23175a4562db5b7f61d84531ea6fab0188873f89ce840763415248131f08f4cc170164232de82d1931dad6260118b4dc2862d9033c46e4aa840e0ff0af5b35785a3b10e780162163baaaaa8c33b0033db6d7deafc7103010b558ec41609e484d70edebd7ed41689a3b191fa23aee4cd0baee65ec85fb8f23f7ce141267a971bd8ab619c4a3de2004669bce9ec0d7c5b6170e6a1ec687bcae5286c681db5b4a69b4a76844549937a0d9a87879ec56d58cde57dc419285cb9cee764640aa5414ea28ac6b7330bddd33e3db6fcab901cf94b6965e2c9e2696e71f7dcd8bae0854efb474c525ab76372efcba1a4ee823a11c0b53ae0abd27462de04e998a8f005cfc3520e93c857e6f6d4e79d337539f024a1d95372515f3da87f998f07c4ee8c4a52bef27edfad709cfe2f953c4804b38f1cabd165b86a8a4818ddec7b3fc6c1a134fbec4805b1319c2a4cc530c0c7e490c67b67fa4933065b7c4af1e0ff2f99bde3b95522a1e59cb8568c5b156cd1d6b11a46aa6b5b8e50f315a298ae9fb4ee210661e5a0083147e9999916e585c4537501dd2c51c1dc3add48ba7f36f2dfadcadca4526e309e6b5405426f86b3b8b2f7c4782ee6df9d7ba9304a954b3b4d638c272dca61d9e8f3276a81cb11cb949da074faea50c9d75d8533c5b275cba74c4829da82a62a527da1bf01764099e75e3a0fc4893bcef264bfc3ac741a7c31f0ead35fff641e8fcd6be82f0a2c942029e67f2016e48cd6bed7de17df004fcd7124940db484a2d0a97424df052bfd16724c67bc234526907660db4ad0db9717dcefbd2ec8aadb6976081e8de2148534e3e05386b0ab79c98293aad52de4f461ce94b3e125cec4146fc29195676209eb3ae482106bdf9c0ff0b0ca439c998c708b9c9e6b8456c4b4d7834c84cf539044a47373b7878255972bf5aa08e78fe4a404f9539f9b2cf5c1a2bf357a4b1d814a8c19282ae3883997ba87e22293133f1c97fbfb1f91033e5ff9916232ede9e99ff7e9271b1e0659cae694fb72892153c39b59a0559c3fbe2629d7a62eb59688d8de33d170794affa4cb6f07d00033cdc991a6e540be662ac0184af76d465b178109e5363307f67d1866d4b65724bd6b8134d227129bbc80cf1b3e8fffdb69dd5072ebe09d61d8ca934293de4f99e6261598879475e78ae8c5e55d3d21ca14faa9aa19cb7dbb3ad2c17529e3d4984c008a1dff98e8cf30de65223e868216025419a227706e546e93fd9149a19e890fd5a69f904e45262a9625e60c34c8ec44497b26802c2f778f796e6ec5a50ce47514386288be0ba2751874d45724d4c7d8f1fd21b6aa081e43e3e834fd7de05bd76c7cb869720b6cfc2102120460ac11ec400d35c589475be665324ae84c9f6735b5e1afbdae1af35d5c1b42b48e6fbc7309cc3f3075669a0c1f1b1f1e11dcc6577b50234f51a238d6e7868361634b6b41158b70422cef234d603aa7974eee594b7eca285759a2641882f62bc241a7a7f12aa2b38e6ca75555a50378a7fe332771067ced613c9d4d1973e6c7e951380188b995f88053878862a2d04912d448a8356788bdd2e40d7c5dab6f2980b3dd1080c340e2cb6911b22d9009b967d8f454bb8f663530b61cc399e31c99ccd40892e18f4fa3b44b22c96b59a6055b0ce0e42ae27c8e3903772266213eaa245c6154a8d730b9a84e91967d813a0db71fac7f1ca4dc218ca5acfa2e13de89b5eeb2f18b6ed548c050192bc18d6b36aaeccdc2e1fc322375123a51528aa0033f2273bf49c58cb8575383dee31aa1188465000eeb3159e73ab6d4fe51a22bb84c8a0f185a6135ae0d9e59b281fe33e8b47da79492b74b066b94c4a817e61366b97bf3f1e43123c5689d1c590cd93d4f192ccdad4fda29c42a880e40d7b78e3d086cc86bc9d5d31e92616e72bd1e331fee6b1f94b468c3b50f4ebbe1cc136195fbaf1b774d25ee1415619e623b619dac5c20c9b16a2accf5ce7aed3eed118052071ce1b35c04dc6fd727476fe925c1b88b77b6464dd86a2d40f1799930f3c7f6010eaf83457f5847fa3640cc4968b0cf75c9803303cc82012be622ae13022fb860f261dec087a96233a45c4a7a92c8988252d344b3c51cb61c9b6704cf5c4ab7b5e93d6b6889a5a4a624f1634cd62fc77d93950aa366e871a29ef34f3d8d3b8dc6a10cbac41b9adb0d2d796ad05bc0a9b33e246f9e35f2218f545e3a1833d6867b0a246c5bb129a6abbf9ab6859dd128a3677a4ff7bcc5bcf51a0730489288faf317c79eabe4135fe96a8dc65e33efd558f490c5f3cc9ac7f07e3fcf9ff9710cfacac963a13d058c01897bb6162e5bfbc9a848c8b2cf5193c2d0545a27fe3ab746ddcc7ff7694d859a72e8488a740629351a542807fc7ae946476eb46c9a2c5238014fcda2f3d8c9bcd501d94927da3aaf84365cbcc9fbe347cce4944f854d1bd3d2fd1f22fb7e616fedb79b9e32f6993fe01597c1f1c5687d98f6be0a8cdef63b292d70e0f3a30a1ff0296741cadbc214919a2f3ec13849ca4edb1b2e119f674acf12b251a9ecee79c44ae445f45737efd5c9c428d726a49e290a43c6ff0e632a3b83fc877567af44b3b09bd6cc86ed705e7bf6c67e4d8bee52675362ff984e6a91baf78c0b58b9ac9cbff7dce754a192ada221eae7b55bd2da1d3113b8f701b4180e015a9dde02e4caf840e698851e63c43d40fe26ee18257f9ab0dcce74bdd1d1061ad22981d6e4217b5f13bd93f637464864d29620f1dcfa98ecb380c47acd55997c793c0bc6a49b01d3cd10d2c9af1fa7516a5edcb8b15e59e9c1dc29c9f95cd3af014fde4945c61265ad2e1f2b8819134468fd477b8c36fdef7552b6151d0c9cb21903a78e267f31941435bbf5bd62b0246fc8135582b4bffa4f1edb0a9aad8863b5fc4fd00f7dee42437207d02d1a0fe113389396d1a106d59ede69eb0831d469f61725a26502ede3ca82df136217b9ae9b41d9a70d711c1a57a81a338425fb14793a7f27de214779c936018ec784ce819ddfc838084ced3b8ee6d5bfe4a099adecc79ffce28c6b860f9336440f87b240f005dee29e0b856b9480fc7c876e73e530f3c6492916eea74ef57336b111737b3550493583e9bc613fe10423cdc7052450b9a8435beb7ba6587fe15519bf5f7b6ec89a24c5838d7a36817f35de555f3c68b637f0affca476294c698965e60655ccd79641bf8a2efddad88bf6bd2ca96259f7ce5f238fe249814b968927a212e64ee78787a5ff737d0e22cae3c69c804460bb78ca8c62d9d4cb23e9bd8c91090def676f58778b2178250b66f08b3074750b9fe95e5efb4f3f6d8cf14931176153b4e0135f672654476627ed37d8246cd1b63ebc4a7fec1b3bbc38881c3ea24513f82a2655a35ba4f50db08c700124973e3ab314108d8a085f4b1b76abccbe6436b9f384d5fb764aa016aa8657a6bc3eda07d4c7ee2c2d1d9049589b5b7aa726cfa219b208ce69455f907118fe1ba09c7d64e72218ce9516fe3499d7ec792879712d8a267fe8c477439e1d680dbee7fd2b26c2756159729523209f8013c95c689dcc2d98ad7603a7428ad8838706bbfdce755743b60c3d603ae2813c490332ca45f9dfe6e0bfb4a07c436d2536873eca1b5a7b1bd9c889df8897ce09f05d2cfabccaa37076ac42ad97edfa490f3c2e4f1bef7844054dd000ce019a33fe5470f9a70085d6b1bbf409fa6133c3df0f0a7cd6ba188e04faa2699cbb46a1de2c8f56b9c0c20163b544015880c0fd55fa503c8fe6e7ebe1cb5fd7a74e52f4979026e38841556c156b4860161302d3c7e4714747533c13b04da3a815be84f834c6b9b506a54e3aaee636d85175b7bfa542ed55aea1ea0f5186fc8337434bd679ea7606c7bede74e3ad30e881646cd4da2e79d4632bf3ed8d67248322de6aa0e86aff2ec9cc46bd65c8ddc382c2c1e419ce5517b3bd69ab3ef450b859777835ed7b7e0669d5b91b75fd1cce9257d6d2feb05f8f30076f28e520bd61da526ef6068c4e61b93acf79e67f3267b33334e9ad1437245542298865ca56cdaeb45afec1b5929557b9e6bf1b22dad514878ed2fea8abbc097dba639d1b98ba9fc753832924d61453444226b6f95a0fb178cbcf407f6216dc5d58da457506a31c576c01f6f03d93dad3851af98235f6629eeb8d8136e651e8a78cbaf5a0f7743d1e1caff67622a268fa8300ef46fc1814ac00fa81fd59ce5d033b66e5e7f824d1d96e5e7db60416f5aff1e5f545a7f44843e531c78141081c415e6b7b341484dce16b6386f2b735010c3b55a9cab2063ab2bd01ae60f1248cca29ccc11fcfc4c312f856892a27112a1a0eda92759e2051bc4608a252800f3fd72fd149381dabe10cc0f87b8096fdeaf9200ba127c75bad7285d62c785e90524394c6c240f52299324c1967a73bc217a08858731f4fae5de9cac26d83cd4a935baa2a921495145c5027b464327a23898a3d7ea51c2264295fad723d25d03ee3e3745349a847ffde56145ed19ba71ac452a7b5195d4683a7ccf8b00953ceae275fe7ec8ad8c6d121880ca9e8f8570c8065da7cfcef813f3376449af13ccee738c6ee4e35b16a48577636ae70fa049ef075ec8bd12f5d4ce4604edb86b3a7abae94a977fb63640568746e09c77f97d2726acee606150599b0b288e2ff7e213286f100086f1e259850b8695eb9f6639df757fe7776a6f336bdc30b2699d95e10bb20144214cbdb83681b13e073ab7d10cde244cb8dc2b8febb9488efafbb1a5f4fb01d99cf5be7d1f4d85548ca30e52f9f12c9a8e331bb5d830e879bff9228968a1a7d0c860c26151e3c1b29ba51204f5c50cfd1bac614af6b1c41de4b2652089b1b12d135010876003b98fbb2e74c087ec293037292827f457bbec83728b5ef08cd62264fc79d322c9a225f4405ca3e51ab3e5e30169b92370308b83b1d3091fac1d4b45b109c7b2942da3d329f63f4aeaeb1368d3355c72f5ef6beec2d4f5e1f9ff3b7f90f2fb0fb5af677f8aa7768e7410bf13090e0c32d60bed43dedc6faaf6aad4e92f39ebe277df59a64a7341cd09b1e82c1e1d09e1c9e6612a1a1f3a9b3ca17fa56ee0bb1be932ad48628062a847cf65bb93e687ba05bfa2ad03e5c0d92c91f4afcbe2ce7f53c2f8e9180805ddd1d32379326a6a0a08bffae00d0f8ef3b8e9882d3542f3261b60050c6e269648c32e1e126209e261f1508d685b742a94b019acc51bcd1d2d14886e210049527be07f662712273af0221f7c43323a49c12eef46da8628b1ebfba1dcf372b13cb50122c5aed30ea5557e05c6ba75fa8e07c2516e2183a070855af393a81b75bd95cf33e70f9ddf6251d7a67e2f03c3f84a5301d5679aa7c7662d32d29db41b4b8675f621c51b7f9d0bce8bc27ec74ef9f708252d09420d5ad793a7c280dc75553e4726e7bee4d6b5d40b3861bc9519d87ef6e146188f1eca51b652fb9512df40fbdc809206ee6d333135dfa9807b1d75611481a4ba0cda28d06b3f12c83444f8948ae0ac61c4baa9f51c79ca1652d39f587e274937d40152b452ab2e1b2a9eece3a0b4a0f9b446dcbc27af812269110e2c16f465abac0d19242b80a7d3b6b2b959eb5043107374f124a6bada7e725df15428b94d63d588366d040a1277851766954f2e25e639271a0d332cde872d2ccc0ebdd0b23f8e3a045ee41cff51ce9e25187750b3ecb62dc574c0c18ee5d65adea90b17cfeafd61ec0c75d67439303f7d81d53d5f554390505232ba1ddab4d5f8e813adb998ebe3d5255ff003067287e276d4fc251d0754ef84bb475980929fbc830820213205b3bd28a4598ce4d27d71437e39e16b333b56862c46f4c0ce13912b441e0d833aed1548498ea1860d5bf49c6733862e3ad390b8c82c73438a4ef26c9a41b59e0f3c8b968aa7a96f75de531b8630d929569e8ca98ff85f99b294e214033038d21eb05c5345102d2cafab46fbf9d4d0381f4a490305dbdff70000a3f7e898a3d3ef1c095ce61c1f2027da74b811fd3a9ca939f9afe659a9f7b6e10ec9eb902c7b971448b5d6fe1af932f48028ec08dd6e1d48d4ca26a27520f1c9265ad5517579b15dbe669fbf488e9b4b9be4141de8a3d9a959e979094a41fec1fdf9bddc914bd7afb3a6fc6cbefaa951e54b13e9a11681a11840d277d88753296fbd51cbfae647ea78c635f830dda359830a28f7da22b273a146f930aa106ad9ec682a9e64d18e2bed2b1c01ed081159f5166c00d60da193f659a14bf3f0d2eea889163f8626c5c27017d52c6c799deed788526b2aa1ff5a8b3dea6198663bced83449dadf3204de02582141ace440eed277458b3fe5f77e62219597801891e50d5d2733bb290a10264332a489c8db7304e647285613c42f606f3a24ea7355ffc3da24fb334afe1104b5d455330bbd7195c41d033a989a72377a07e52236cec3955b66349e5af15c2224f43826de41fca23c24d104ab0906d8026fff211450c23543ea1532b17b39db03da2cdbbccc5d78816c499f39e56ca6a183b7c944a67862e94ef3ad05cfc783c59894167640a08e653a70806bd64d5cda0d40b883575667245622f0fa7c214d4522c1a4f59af87e2d3bc75f73212b1cfc39fd22d89a691617546bfb4be26472c36bfac86086353a4ae9c1cff466f36f6426979c12a091ee5fee53028f43d1d37b71559c97cecfeac9153f118204516493ecd6e866b139909c91f4e6c8035a6b5e198ddaf223d821ad55b5714037e988ffa734201c52814c248e45f9e186f331ada618905b8c38266d1d9d2a4b5bb4644dce106d4c72ce8747ecec812e8086d25293d88a60bdf565ff505c4c698c2e5d4318fa28d1bf6ab081c73613347c220bf2bec8ec6f37e337db49573a120dfac8682ad1bea97de2fc7ff42371170d495a6328ac16312533d81f33a2f8493992777d90a28fbc427a195501eb0be4e5523bb7dbc0cf329a220f9536d2dc51d761e9b643dc2677769b3fc2cd5ed8ec61651c44e4125468ed02e570944a63554d6dba0b2a99cd1973e49456ef165af3e10d70f233a048528d38ea642772d582290d9a1ed8b4a09e6fbe2bd6b8fcdeb2e8972414558488dcc8d0bc3b14be6e1677112a380f885ca52dd873fab4a04ddc353e37cf384a09e7df7fd4296f077f27bec529e2aeda6825f096e92e67b78ef9e2100fd18b18fe2ee0bafec4412ca734db0fbd73a641264317dc374cc1eb98e8f1a57425b449144d2ddfa30da709fc49950e9b53c0793a6456c12d62fbec36f54f3a5799fc47a07af4ffb31dba1aebeb7e3212015f63087560e494530a86ed3e52f49315682a1109d80aea059310083d4ec3b81aa7879110a9b133c025cbc250be6d7055cb6101834965321eb09f26c2635537034b08b6fd8d158e11262caadf855257c9a972907b61d2573f63902b88475f2a5830a833e0b61b9e7e496efbb12a96ec75fde84843cc8406541b6e0da21c32508d79dbc75074c5440603095e08ef7475e44f9c75cace93b7ee726cefaef24e65bfa39e9bf94afee9a5a543e99a0c75ce5d1db5365f83304305a82b257a3c9f1fb6d25bbb863db9ca3673a17fcb165edf146877fdcc4fb87031c06f142c5cbeb24f0e05145a19869dd4e9a10909fc5f6d4896bf9141c2ed4734fd36a22f7a94c30dacbadfaafb8614effccf3303cab989a9d39ffdcd7a94fc08a8457e27c3500941550d457760b82bb5d3cc87428d1ddf27ce0b97e2296dc06ed4ed788e8bdfc50853a62314b00d0cef920b7bf7723f9a1e477bbd3172708f45382fdeeac50eb28fd5232bdff56b682ae60b91ee63ff87266347e51525970bfb00398061741606425f36b0bf5122d21149cd3735d8009c3ab79b35f1dd8464ca74d7865891405b6526bed019a813d3afae23517e92025f1dd2514b201db99ea68b714dbe614ea8cd7c44bbf2ddbf63c1d3083ab503624077f69e6bc917ebb426b4e21e373b1ebbc49c2c7186c0ae148a029010827bf4023200e7c3ad4e57d16ce9455560040893ea26c00bbc3899d74cb576867a2bb106f0d27a3145d286c6274726d819c9ae7e19df26c03cab4f1eb7c9d4ce29dd125b70f9225c334ad5596610c862661dff848613b26be7ca7c78be583cd6771339742ec4ecf80cf8f242b953b24255f86711d068a76c996a17f2ccdeea94c11ab17f343a063cc738929dbd97f94fa2057c8fe068d16a4aa43c4b5cdca720c1ceb7dc4231b2e06f6f9b7af58cabbd42f856d98cdee778a00559913632b473dd52e4e07278c740daff25d3c990a566aeedb89b28d0d2f2c07c673d199bd1b574a146a16587e9bdb12bc9fe080c1144b4a29afa861967022524c5e216bdd8cf4e3fffec5666e9d477455cabcc706cdfb979710c84c4930dec6c6ae78fc91cc1ec217a6f1b6cc2aaee56e65d3d4083f73fbf9bb24b74a454e22e1097b15981a3fd49771666bcd06764a95116c3e6339ffa2093b16d18043c1c70f0daffba7d19e60100cca863241fff87dcda1bb1bff7d903f2844e05c70a5e5b7cd1e028f9051bfcca066c704c311073e9623bc77e096b8f085447a9b3bf58f788cfe7e6a41338996a846b606a56663eb29da402d4f94c45ff50313472813f535fe961979c543233cd8c924afc82725d1901367e00c19489c16ca8426967b797fc13de6d0d1bd2cd3f458b5d16dadf19201f6abea6759a673c419834e11484ce16cfc62408586f193539a3e360eca0db37dc696f49277f8c81a97e61a94e7d8dda17b7b35be06a9b524ecaf3c8d59f80a80bc15ffed3363065f0d814944dc77350d6f44bc95ffe6588de70e1298ced71816fecfc1cf284e1c9f943b8fe3d66221576d90907999a246e0619a781201f6bab9fd442654b5bc1be570c909e0f9a80f8773853850ff4ddd2a76fcf17f33d2ae0088c133870eaa52f0a6aaf4acc3436a6f5b1ae4b4af2daa9054b33b7bc9ce78af950611f2f73eb8be00b628bced1d6e7be3962c1bbed4bb5594d7c1a832211a2a8a0c5040a79c6ad28b6494c8e9f3bc9d11b3b839288edb3ccfe14f777599c701d5482c618cd55c7ace4ebdc261931e1bcdff8f4a752a0c98e266610b2c4fc4c99221d9adbd63ec328535aabf5ffd5e47cfe732775927dd659fc93584756653c584fdb3f0f20fca184fe464455eb4975d2653f750fde0658b10d692dd1541387450d84a34c5eea07f0a824711efe4409c697043d136dd961053913ba089205c6d75dbe65a9d0eff396e998d457d0bbca6259e2fe6930df233127653bb3c1a2eb017537765e33b21df211fcd1aa80eda6442bdb880c109504647551dd6e7f3c3259d0bd9148e0c8b247223b243b568fafe262a4bb1aa259c3bf5eb36a816ea72dc9e9b551ad6b558b36ab98bcbf6a31586252725097ff938d7fe9f07b82f8617a42c6bb1f87d432d63763f4b6151caaa545ab2f359c494f5387c84fed94129cee90eeeeaaf9588da5efcba9c46e86d8d117dc20d182cffc933122f89e2bf66858e4722fe641fae651461950a0720b4de73e5be81f13bb440991cb30ac27ee1a72a489af464f00775984d76cd8526213314ad15e0bd3d2946a1af79a133f64c32e03df764e25111c3d933bf22ffcc33fbaad3f96eb8e73d471f05ab13cae9575e6280407c6ba56856e9cc33d3fdbf43579169c6dcafaece8709717ffdbd5f244810a68b7cf273cdd4e98ef16a2df2ed5608ef5894b4083d3e0de9fe29da005a591eb981b861fd354d863740013337e6a25f0c53b1713e1622c095edffe42337e128fc46491848524ff10bb70cff9295474ab46df08a1f1bdd07d70b59847f9690108da621b6716bda9f37182704efc3178121f46cd953aca4218688182c4e3a6ffb64321f082c5d7fd64d7982729b928fa24e9df52f47d737b499e56c2a193332773431a1e1ff2dcb72a39e4dea81a2b4a9e75262195ff00d02fdf59d0cdbeab9f08dfe399d0f323470e01068de8b71b6dbf5819e67050294ed55f6b6fde412846166bae0840502cf883df04f26c2d1a7ba5cd950a34d67148129660ca5b0e513956090ad154ce21e2ae1328e947f5505590ae4a3c9001b314470c4bb2a85c85d71232fb9157816ea1c2cbfa5a40b9d64146512505112ee96e4057b4451219982b50a7e26fe7edf59aeefa42325d6128b71cfb3cd29686fe5ef319a80d4b2e15d16a9fe33b093ff99a9eae5c44f0b080ca05aad216879e834aa3c2280558c9f41fbc3b53d4f8a867c0f155c6432c567514fef7e2d4f932ce4cef0bd2b1ca32cb01fbb4ef41f52edc0207731e2a1026f7648173ea1e73b87237dd95f2b820a4efeec31f0c2559447da8c93d4ac4ba2cbf5f7b0ba7018e1fec3ebf9044cf1ab000447dcfd0f9e498a5df330a8b7efd997bff6ef26b16abef3776a0f58067f7a70411e675496207fdca889b5b6a6f5715a77da386e0ab58d526b7db5e6fb98ed65ce91355de79a07a777d0ddc2daed81db2144de2f2d0f43304be96d6193190dd07e262df4337e268c4430fa76969a0379d0fb78d80acf1b161ce7524fee522fbbefcebd166ae05a4e1194b7129cc03f50538b88dc47c820f32581581ccefa1cc3a223dcb44f3b7d03895342539110c70f65d45106c675b1661d2c4d736bef57d71fae95ddd61c29dcbbaa4a2cefeb2c97fda68880174359afede45b49499370ff5119143508006b1e093c14fcb4b41ecb98d74fc7a5fc6343fab7071ac51d304729ff62d07847c48af2f61d32939cdb5aa1b81aa1f1553e35702d072eed1f21d90e715c2018e4d24d86f2d71eb672fe013d56f42993579152fcada91e3ffd3ef938a5b13682d715a1bec566ba7e20a8358e89d97a5cf6d7ff89d3fa368e98956045ac1263a3b1eac7c69e5540e2443ef57d4d14919eed19e802da6a8e64e0fc9883d022619b15a814099b9f82f2f8c8949dfb5e0a5ea432741480e3fe4ad7480223bb796ac353fa1236a5ddfddba5dc0525ac4528b9243e2b2c5c9eb92797ffdea52498570b5494bf34bb3779cfbe122a678fc79a8241a189a77ce8aa34c7d8fd2b8991732cac76fe9bf6b1faf8fc2820b5e59a505acd32e68ef2f2dc184ce1671e04a8a71a08a79079ade3ff590bbfc773b8d4b3a499c3c65b0aa9af5966f91316b53c44147b9f3be9edd3d7fdad82913b574cd149018635f70a4e7f5dd7f4b7bc02505c7aba45f4bd015c77b6379cb5724fe635b8f6bfb146e016e56025ce37fddab82e517bff161b776316ff0f831333e117ee8c57eb935a97bea867f29e23c758a4abf6606f015ffa101cbb78eee312eb5bddf0c00739b84fc552ad6deb006b599fb3e8ffb45ae593d9741d31fbec67b174a7ccc3664269b39aca3c78f55759b2eb66e404167d9aed12e7260da5a5da39b77d1b939d624c55861818c1a326425a9ec8c74ede27905c1a2f43cacb25e6bb83cf9b0414ee7f2a487711fe1be7333d821ad129a6962704b58e30c344d1bed572161771d8cb2f56ecb69fc83a245d5418f17d3af96818fd4bc4735f0120a586339341174b298852b28f8eea51b5399987f8cf8cdb225adeb8f3680ee30b1a24f5497f8e9911857621f82ecdee0de452b05b52acfe14ffc1940ba11baa20a3c510b8555119736df58c7906cb5e10fe71c08c2d675ef7b2ca4c75776b85bfef7c04350311dfffaf06ac11f89b0d3ceab3156dbdd5664616641996d5537914eeac9a277564d3778864e249c73a1482bc4b9a1dbc921cf197237f3c97d6c5899c60feed9faad210a4e82768e83b7b60bf3a944d7ec601980c26b0171d21890197048135f6f47fff9e0f0dac6905da7a60045ac5035459bd4dc69c90dd09108580f1e0ec52437cbaa694b4b4de96e5c67bbf3dfe3d91167e0159cbf9614f6281032420d76489b3a1587df1e3a1ecfa8de4c48dd1371140fed4a0799ad5b44d6b7e8fab9251415433a9b3abb62738636d5060a92f16245f8d4e4f39160f2a6c565407338b27a1a58288dd49598dcdd5bf94bbe6ff8c94a7f4ec4770e3cca0d5b103c3d33f8a10a2924b3f98c42cdf60fd7fa7a7fb9eb2afba933e67008823ba996208fae0f8f5f14866704861da2148f06102a82ba1375659676cc7501fae960b75c6bda6f723bac78fc5e4c49414ed5cb651fd2c62b1ea27f784a812aad4a6a90bada218665bce17519b63635294bbeb5c8d695b5bb80857aa46b3a7187d0ea713183ef6bf1f3805ea9c29df48de83ecc3aae46258e932eb8bdbf4161637ef247860d4c31664cfd544486cc1a14cb2ab0b4b09622f6d2c4d9a991cb79313c187974c585c9bbf6debf74da3d5b8408d8de8d30fb3d98be2264f1c3efc10aeab8ae2ab8e1bdad586461b039ed351ef053df75a45aa4ca42ee99dd55e46d61595873c45e14fa7edfcf522514e8f6d634bf388884eebe33cb5c3b7954efcff957b7f8a4aa4ce0e3ab52f6b0af7b68a6a33155e61b41f7a8152e4773d1e838fcceb00ac961629f2c4214a68d3ec75df6537afaf0360547cfd7040bedf830046784e9a3ddb00b0b7f2cca53a91f94031bd59a3d635ae74c26c9c51c0180a431137256980ea6a631a2862e2083ab56f9ba065293a8f0fe896d208d3a09eeccf0ec7531daac4429293d0ef95a9f1fb811111fa1a32e589fef9cf9bf292c4754512fa711b4e6b89bd14ca71b3433ffdac53979e5aed2dc752a3a5bcc902d09021368b6b59b20197bb14afd8186f0644479985a64708b892a0bc435e6f99087ff31f0e1a2dd5af100fd9e7f67ab65daa186e2a7ce3fe4028e7beef990e4dd19f477a021425601e8dc456253d159f57a14d6175d0054f0f467a039888e86109f98bb92b4cef6a2c849a0c40c82b1ef14660494750e1f94f5a1cb3acdbf606cd779d91109a57fbf0d6076ce3eb93c496002f846b523893537f4c711f4e63eb10431002b04041699076ccecc14e5746a6fd7680f07b74b6e6a41fd2787996245e020a7d46201e6153dfb6e1071ecebb59168c8263129433cc4a2df330803a975fbced23cd5d94ed3a4c5a126eaa34f3230bcb5a3da713838caa0964d4222059c4c5fc45c7f43439f14f6f3e27560ef0dda88d5d5db15835b3d91e5b73c0d4594a5467f90f87553366e3bb2cfbce010837129e3941a56bc3c244bc117b25bd99105f0dcf294e6978003e60d766544dfb481d0349610a4fa5e488039fd837fb73a6f70b627b9c6be4925d65e590f1762c58fcf4e5dbed17ddb6cf8b895cae405a1c57161e38eb6aa37cfbee7ad0a90b69205bbb7ef05c1b19bf7a604a62a6c6e79395ee7f03baf5f396dfacb96942ebf399ddeb0622746ebd3b73c7d635b494530de581008509faf5a232233527229b0583be29baca12d87e6d65c44b828d640f2e1e3647b369c5ebc0fbb423495a3b3836adefcf94eaaf4998b4f1f34fd45488ef0fd81f3ed55b0dad3e78be7d622e37c5c4ad2e4b13df1a14550b9ae4b757f0434de48cef808865c1ae921e775ffb36d51f73c0027581b4e494c2c5fea621ba64633eae42537ab4d162fddb1c562d5bd2ec186a046daae46260cb4ce5ab1bd0006a35435e30808828f9e359297897203795be69a83c1eeb6615c1ae4ee35c56bb5abdcbc8bd89c80cf65a65bde76be4aaa0c04b41f8f11804468caaa237fe7af79f86d5d9bf6b948679b1f8e7fea900a67fa82cb68fa13a1a0770c40470d1c0962d460b2ccc8e34e2ac8226c914ef058a4969d84a5c9513d6d6875425e2a0e28c89dff8ea088c232438c59e82a0f98d675ff379e259cfac58a76152c1514b4305b35e9b7e5901b93badf7060b91fa3c88764a6cc2160e3f9361bc0f310ce086999dc463c1bd0a516f1042d854286e5fda1d03d1bb7b804f5f8d4aba0ffae02eda735307bfa3407190d6cb6b82b49f406ed0549ee1930050ee0f82152612521b32959de22611ad26dbff408b625928e8c4e4a86b91064aab4f3ccdea8cb6aa5c3f8974d2bba2b31763ccdd54eb02815354e1aca3e4ce895b0a28c48928f4696249a8d0e21a7c6d6fc51b3399ee2f0d22ebc75f6ba7ad8a202b92fb9236e6b652165cfefc75cfb411522a8c9b4a0f9d097516287fe94417973f60c768dd15d3a85584838a39e03ab4140e58fe66767535fb6397cd448a432065cf275ba81a37b716018766caca56d695ec046e9321628fe7f96bbe084292991dca5220d2c05f4f1ae6d3cfc63cb3aa97ff91454f79a467f1266a4f96c2eef6fac8eed4a40c907f6da6b46c42b4316114bbafab5d9f62fc5c7cd69a4f98bccf9edc57e908c759e5863cb33fb0441381337e9aac9af8362ad601ef06f6dd36d9ed323304b6c0aea7d1432c163a90c08ea4298c44b9501875479f958f4e3262d7dc46eddd0d4e75d2c2772e5b0fc5419903f978c8a1bfc14b2cbae85790dc4f731a304177108b051dd57eb08782e4fd97daca9cf771beaf999b838ccba6de4ea64bbfa3f16172f4fab9fbab3cfa1199b48045ddb59cbd7eb106a1de4943076dcc3ad18644f4d2264edb092dc0de5c747578deb48a83e6546cd499f99c72807cb2d36d11ad00604b554bcd6fa72ffd5662af675581619af1a7ed6a7de8f9355c3efbef9ac3ff999471b65fc35eb8106678434f24afab989373c2130d0112fc9dc69d04d0b4bda6966fc601d0f3eb7fabc94dd09d4d8581b674bb0035607e9b6a88494ddebdfd0e895e48c65751e2738b0deb9913ac257096bdbd621bf6e3c077284964c650b284b960ff940c34eb8f240b4c81e41acd36d04f6733ebac53ad9587d205beed4a2239851c574e0480bd9f270414f7d0ddbb9910d6688a37088f8e5d80b96683038e261e5390af2c651b12090ce51cbedb6cc90917372f85f282390fc730bf566a1433d65ec036e3e3429312031d8a160a1a785c7abd091f076deee9f205c1f6bd3550d22d9e02705657a115ef403bd63e20aca1714ed2f75e6bd15db0c23f9f7afcaf1886727638d0145da634ec2e4d403a6624e7b1906f35d7084718ee919c509028c2b3fc006e4d0e5aa7d55fe399bb4f18da2f1344624c5680336bb8aeedd9d48b71c7eca9b13ce7576f599923b5795d70687c92a3bd9b4478748b4f6451e0d15c25e62b6f71451d9867ea8ed52599f2538d74bb8ee9068fadbe8c24d7714dbd9f11a75034c4e72f7a149da63128189b374f29a7afc5c5ea85e9540d515a071cbddf878e7549f2b49a9492d67673b84fd4ab9e83bca3a16be89d6782f1543c855f05a88066847a1b4cbc27d532e220c12141a9c9742ebeb82c8881935815b07cc798524c854c8290a646189cb1e5b0153d57e276908ebd9ddd20d89d0ea72f3373cc70e6dc011279fd5107e43de2a20eda2cfa1c21361a8a9110592d0b28e362817019f6db6aec44c322a2685662d46f6d1d8c24f5cc6b73f7f87dd6ba3ddfa96ae8dfa0c52543d6ac6de95a59dc2a86f73d2027a198378c259de30b4e14e979ad53704319b6d335ba4eda162eccf17163c94772934f6ca9db6ff38f5b9b05c5e01ed75d1c7c76f0912af0110818270b41aa01baea588dc07f2ce49d0d3cbee0b4ca1807d1e81555ee757c61c3fa22b2510079d1b90006091ebf837ea6e8177f2f314cae66cb4eea78bcede9bc49ea631a5e39e0abe8b2778788b04d5fa441ce10e8ac7f97f8fd9847e15d1685c62afd0323c82bcce1f2c2bbaedd4aad8d24cc43a9aa26b6103cff0a0aba7c7ecef9382cbaf54620998ac924020c09e72d939dc3b2b182f83811b36d98a7c1bdb01c42d29d40f111e3be48d7a2eef899659698c8ff0a693b6df3f4e2f3f82a58380be969fb05f585c190c91851da382e88423585c06b9020b43ac23293fff1b3a24ab4d7d5575400658d489ec5bd8ed9bd862b70daaa1493bf3800b2ad3410eccd470cd09eff57b88794c26c6e5d13b287fc88b7705be3ef7e63f3f8a008fa980a3b18f7ec0f2fa5467f8f7084eeb3cfbf0195aacfa53f86a71bcff3d32fcea904378384902330aa48be4e37d1759588fa6bd3b1c6b13ffac7921f8a15a4ffb42eea4fe4ddfaf0bfe282780b7fea2d6bc50f72f845fb5a9ff269f52ce04eba50ca0029910cde7713c71b7776925a45dddd2e586634bc27620dbb5cb69409d7624d4461ec8f63a00832f6f8b78a815313eed601754db14528a1f399ed433540fe5d65f88bcd62d31697c8275ca419b6e971bf399d8a566ec03e9714192df454db22d8c17642bc4d08e83ef7511abe66b37092251a5c0b16b85bf9b13e943f4f60b592f81ef1423c2ab988966b77a46fc40c2173b4559b107b7bdf29daad0768a73bcbe7f758f2c4efd7e5c7cd47f826380afed90625cee7b8f59ff60612069f704d270b4b930798a66a981954983e432388b15a69d2f21cf14f6fb0cfbded1b32d57a2fa2f9b10d7af1de9d49d294caf14195bfc4ff9dbd50cf3e01103a8c452a5f9e42a8c8a51c58797333a9a1a4732bec0ab08cf40ff4211da9804795cc6f135b0c9beba9bef2640f591a5b7800ed944f26b508785a1e32a45053516ab2844251e3b0391dcecf9c8c3aab731da56710d9ff3a6adb4d401048e9c466dff8857c937595d388155d7936a0c2f2712cab7b8957990f263c3df9a2934289c2ecc4b2ea4c1e39e7e052727080a6dfe78678830318781b6e658077a5efcc97f3fd7d6416e37d073701535fce02ee5bf4aebc00f58b9fa0a111c3ef41e4c0f1bf6f294a207bb86bf7b01969a8cfad567ad4b15649f8de2ead58b37db913e0c44d398e465347b1962abe3ae30399036f0b3ab7e88a7bbb990ebb8d801b51d831285ef2697c0ffea875e5c35623646ccea3ed10c277bc9c6432b2103d9ede897d9b3d72d0321bdf5756cd7ab9c4d84c7447a06ae0ce1b2c334dc66343477f28920235b0335a7dab43bdfcc7338e62f1b98ba83d1f2a8247258971b6f02e475417c3213c3695a0444288831a3e36c1b14fe306929f4096439dce35ca05ef6b99ec020fd2d73648ccec95e0caeeb7f902a8a16c5220f0b6f32b3d7f3d4de9f57d2d471204a038d2bf14b81363b8ce515da81713f09d80a006eab983ecde94f1ac38df3267d8a4d61e420a01d64513f727060ce85fb8b6a7b5f43825f69c9518ea9ff7f29e590b10fcc6bd0c938b4570d0827dba40d280248051b82651d9c9606753a1a30d252e8eac4823503b6a65634626ab723d2e1bf433275a0ac033b987f6a4fe57da4fac255d447f7bde758414154dfd8f9f17dcd994d05e2e04ebe90010809d5f8c6c2fdbe6dcdde0593e23f9223cf54f4d89547a41223ae8ecbb275c0ad4e2b429a24236e19df73acdfe1c62d2684b299da44947b6ffbfd3d38f9646be50a7a24db5c12e1ed44d5472f93f5f1991caa7dac923266957cc68c9f810005ae58b2f4c5d25146295ffcc5d68a2560f36443a10b63db83165d25312d2eb37de27eeeaa500793f93ab6c91aed66d151ce6d09ebcddc14e344f75d541ffe4db9ce226b2cce5b9c04eab7bf829dc0c1c763e8508e1ea0130499a74cb42b0f2638421cb0b3ba0c1ba1b3c79ee090fc5dc57f40441d78143897013c3048c7ac9d4be1ef805c01b0c6d724c68d8e7e6b73c02f10ce18597b0c7d1d6ce75469f589a9cbd55e35f487f0baa7ae3ccc7e175f861a1930e960be170e05c8092e0a0762fd9f6e4661a28f0b214c3b8fbc30081db619e1331730aa2f40e0f0adb0f2f2018a980a69e5c6595a08d5cc2b6f2dd267cde23478d0fe850c14de477c1a2542404d09e098ae983c1882e2850c2a76b82c9f005ef81021f88a5036ab54e017a3e9e862dd7b4b62bc050590782241595d746bb68918c9693c3e48267376ad70968b4b3d8a3bb27d411b91721f10f0b1a31f33117fa2953f9cb487dd496f10bb92ae51fc68fb15bbb9d70f52e0d979172226a7888dc63e5f02662c9b56fe13cfd71fa4e55547affe7bebe9d0e3a765b1db2cf609ab29910f0abf7a03ac1477a5e3703b6f4e335a9e20ee2dd64f5008996d84d93b38009728e87edbf773e70a6b34f17ab665f9639b49201325cca3ab9d0e3436e643f26c25bded245716c17a4c05d819217f8b0357d68565856369db9f61b8736c17c452bbf7842e3816c5d0605d4544b6743f89317cd685e9559d149df9937316e1ee7a8983dbf0d6cf3a9bcfd16d89aa9d340f2f37d891e18592e31a2ad19f71e8f1999f622709a458cd4d373628c8b650c77532a87ca01ffd045b197dbd6f4628c61e113d4556c81692c0c762dec14d802988db8f3b1d1a2d8df81e445ec48e9cb6b62904874b3698998ce7828fd67b015a543e0b1518cc73b9ab139a96ae05594808db40c3143edfa6cd4543e0a5f119f3aef594bdda9e6c6ea93f3b21e7b045d5632103f413ce51517c353798aaaf92985ab8d0360e05ce26fa4ff010f5591b95432895e33c208493e9ce58ef8c94aaa7d58120abae9aa051b25f0a9daf60732b52a02edcfc8ad8dfe8a15823ccc4602b529b94df85fbfe57e6fd560759fe1415c1ca60fdfd29db2abcbbe4fefe39baf7de3daa2704c9db1b86d13d755a29d5b9adc45175c79c95cc8888dfbc5d8841a2938ccccd8d4bd944b2ab7853c62588d09fbdab1d144e2f0ab0e7cd0d036ed54acf378781c1acb9e4b5d42d698b627d311a261e5e120547b5baa5aa2d8abcb3c37a70061c276470f7f58aa625f007b4bcf96e7390a9d95cd8804d981b7a4fb4599d6922c77311e4168cde787569d216d6170c3148072602e6103a5b0b56b1b8c07f06a4b6124042fa3cec6c9bfd7359ea4ad1fb6847b109f01ad1f1d1592cd136e7c03f5cd9ec4d5e7593d51c7ce1b82d52a949c814a7aed7d1af9dc0cc82453c554bd369d17ffbdda77aaf3758893bdf3816356d4e0d629420a8fc8a98a31fa344c0a1ffe75315d6358c4cd29a4b0dbf57c3b061c2f1e8788563c6944a87b130bb408359a95c24b695e628b127d143d59cb60ca5024d7b28130bd9ac6a5306fb7d42dfbf3e53f66a26c5df05015fbbbd2250e672ad766e92663d6e16c1ea768acbdf372ab4384223c58ae327e90a2fc8075b4c8231737e8d52900ae9dd9fa90d073d0ec3656abfc0fc501f496ff36f9d1652401bf380a1819e913da26c57ae4185f20c2637e53ee500167c380c30fe160b6c3dc7a9e0026b86869e3c91a29bdabe8cb5682dc95924144438689f7a4499287386a62a5a6f2c8362a4b4bc12c0cc7b6c0b6b0e83cfa03e3635310bac42b205d66116e02427867486506ea7356066d7eaf614119c3a0b002f4e1b6e318f14d055ebe0694254b7cc6ac5c561fdbd804c7b8325c5269bfba08c57695d4f4093e818bd7ec2a65080c999fc061150a7baa569198b99195f8d9e818aa742abfe5066fbdf92045de516ced7d0fc5a2846b0c52c3e01e71b9707d02db33b415ca018bbc5afc049d662270a38fdc0d3a10a9528af973084774b4fb60af2dcc87fdf80b2525457a2b56daa80ac7763d7d9f9f115519a8cc3291399a18a89a886dc8553de185de119772931c44f5a36e501ceedc4d559c5047421d001fbec63a56c7bf2fdb0c467dccc09934cfd3fd8c1ec2bb7747426e5f12cbeb030b6a23cd3f16f822f84bf0b08960aa4a8f7c334ec3c3633b7441313b54920794d26fd917babd497e3fd9c7d5d9f9bc92bf1cd5e741c07f367478da0a01e9ee4e29bdbc41356ddd0128c95755b52e26877d6e499419117fa6bd23f621086247a979ffa01af9623f0b8462abff3f1746b587a304a9217c7c0c954e00740a1d34632dabc5ce60dca87092a89a01ed85b21d4e3b0bd43a93e5d3e53773ce4ebaa193a1881c212de9168a0f57e3ba82033ba17ab167cf8706144c0a56d06419a1805aa1c3127fa17ba46b0320da117f0791f2af8d63e88eb202f28c47d29b0ff0f3d3ec8b40daecdba778130d2812e6a30bc8503bf7f97f74562f3d3df9a27c75c43d5f95ae2131d572efbebf1d3204a61eaa6da41cf442b5e46baccc0f4f555735ac867fa43738e915c7fe14a1e941687c3dae03b1c21643f8a780b0876e13bc2005b32bb233cbb01bbfec12d3120eb2970102af378c859e5bde617e8c316b07ab5e19884e5fd6bd2863e648ec5f2fedd1d524eefaa092a517fbc36b414122670df55d705dfc5c3c9b7ff50861613b9f032451d4e2fd84666b63c01a2fa9cbc8e8a0722cd8dca3c05372b0eafd8792ad16e7588b9007ec80cd861dac9107c7223b3c97ede111f95e260ee01c6ec0e284d1db40b874f6fceaa09b1d05f416622c6c958202a3e6d5c9d8b0d2cf07f593c1e868d7f9d833c168822160d4541b6cbf4c72780a42b2ae6ee3aa0c5370a54bfb4fb036b0a9f78668d7313862ec6291f1517e081ce131e022709b6688335fe9964ffab68259b60aa65f9372e9f38ccb198ce178078699501a6f4ae98218d2acb88501cbfb341825a1d11d6cf292d2181385d51fd58227e1fc85f2da4f6540efd8386606ac5cd3364c097188d08afabdcba3b58718cc2efb12120d60c4cc9fd5a79852a32e2fb96b17c46e324d20bcb177ce6270bf5ab2d2bed1b34526cf84c84c2024c4a4dd15ed644c0a1388a8ca0e5aef7e2be53c28fb555348ff16757c713c8d877f255e57c446990794eb55044fd6e86824220ddd21262e4bf3ef1608ce39eedbc36169720792b1d754e2d5a04ac1f6a22367f213427bf6f2b2a8e17b1a402410ae62b27ab20b97d74a2f53cc7b4836bf16c2278b6d83867b7497441644133016eba2269e215b92dcdc942477fa709da83e61acf56ae64372e8dc3a2282d6e1e65aa946dc663af9e3d8247b4eb9d9b74d991a0f82de652dd62a19550b7dbc25c3eaccc897e122f32e8681cb07f3c8dd05cbfa42780ee29fa8cce7ad3ee9c1f587404fc029f2df04c9195d403cb9e72648ff49a9925136a65f261c67773d5c4925edeb52ec36e73c63aa030e21d163d16deca4c328d66f07f9adf802896e047c53b39324f6e2887971ab574032b59f4793f3a2c47c00d94d1d4f3bb40509fab516fe75db78103bf07efac5f768561a78bdd108fc22f5e18b0ffb292691bef7351a1e323ba500617a7ad72cae0480bce19bb9b0b7325f19abca3f9ccb8de7a1428d2f2bc7ff027846017e3feb50518fd9caf4e2217cd76b2d82b6a910501d6e5af8171af5a6b1ad2af5d1c7d91e648c038d6bfd8191e44ac9b44d52fb91c7efdcd4ed20b85cb217caf9b30735dc4dcaa47752fcc6d4077cc24721fba3be4f0bcf97f467d45e5e9ba5cfabe0779f9eee2de38de1cdf9a88ed322f98327480ccb2e51541ee20fa2544b104a94aff7645045f65c8a4804fe5f9dbe381111bd252dd37c74bd52de23fda2177016675ae4638580d13ca251e58d2a3de94c0e2a4d586e9faee969d22531ae08f036f9da35ef4c596eaa479ed846464f10396c44d35c48a9bef35ab51b985d580172cd8d4ba1758c9e7b5e8c50dc0343495d7e88ff346ce3fc0b24aa157175c13af4d126862f7629349703ff3a72bc6abdc08ec8b639acc9cfa6f7d7524ea78cf3348cc6d9619dfe6a84bdc48565a9bd80351342c64b5a9778c0efca28de67536db8647eb88508260098a272672df43429be66e316288a124c0b9f0d3480cde5810fae504b5122ebf620ed38b3a481b762d2f8e4c0b164ea3a3180c497f99cdd59613954978343ca738d1147616e36e9356ca783f56601d3f148befb6de9edd40aff975d8f12420e4b06fbbccfad405450eff27473f26cee02b0c636790e01128de697aaccab1462d3939fcc0384ca7fdb21f038367df250649143b7a6d5bb93e6f551b08699794197609705d4f5f16afeb78ba9ddb1ef8b0ae9514c0ac85d23669231a65da0e26f425a1886c9b81a02b04a12d5deae777ce38afdd5b4bb664f26a19eda271386f58ffbf5f1c5bbcaecdf2c046465e6dbf5301ad5e5cd9ac8909b35aa0888bf7b3332d038327c18be1b949c70f10c0b22d8a5258a12b3664279047f8ec6aa591a488e2c3aeebab6562c95c7777322b25725a1a42b680d47db90ff8a3cc6becae7c6061638e2df1fb77879087614f15a6072e3d92233f8542fcb2ce6d73d5a2ff6d76edbf71c8e41717dc77ed330d8d9c9fdae56a71a820b277f98c143e3ddc7cba3a744f4523a7192f2b63a7c71c43aea5a79865177722f5fe7472e7f54dca695732e0529e16dbc28b38fb274a8b0f060341e5912e7c6f8834b778632de6ab44812c44c1bcf18d7b3829adaed281c1a8a6c6b9d8b7ba40e259abbed1cc7cbe4b636fd9b4abddd8db81beff3e1b604f1c4c97ec1fb69dfcf0985abb5a14b4cdd91a3bb79696fd52f6b06290ec134879056804a821ab948f48030bdf2eeeb79d040398396ecd8aca356df0a65feb2c906c9c95b1114058630d5013e6bbc64716b2cd92565a4cc7873252161320aae5bde686b29a2d19785ad776b328a8e7106327128017f9d327e7b645d5541f0596c80628c24a6247139b906765eb5c3a2962acbf64818c7d1e975bd795065ff01e57a958ffa19e2ea77c29c8b6a0bdd4fff11816351ae1e9c3d50df0a477ca918dd3effd794b15519c69e8e6b3ddf5830b22b68aa547875dc26053012dd90fe529fed6e4b5a7ba98e76bef610a643cccf5c3b5c04975ab9180ea55027c4a0aef91c62a6c8f6743bf2bc648616bbdf8aa95c542f7f4ff880ada63d4ccde5591f749c8a6b8de3d8d9438b21f7a89ee0cb2cf4383c0f4b840b5493618a25063c60230e33c28b6afd1c05e80cf32af60100d4cfadf40934154abd694beaec13cff4297f18803c824bc39f2ee73fe11342122d3d649c5e57d8c1ceeeb2b333051e458a4b86837d06d6862a1892303fcdd32ccb6c60ecc1edbe6795df84a0feeb4d1370c7ba509585ad9d05e3b354815924e988dbe8d364655b5da07ddbbe2def507bc938049e57eb8b902503eeffedc9a383886ff12af5c60a22e04aec65cbb3879687b72a2661b32205e86ad91d66e5de54572e0099e5497bc5516ed8c604b4c5a4ce6519c157586c5a2428b2a3edfca0e0deb7595b9d04789f75d57be55fbda6a6488d981660873455bed28b6a86b902b5e0f063934431e801338745265488407729a76ab129d6b470dd2c680b1a0c205fa28fd2b2744d1c2352e304662eed4e47508f7c1d552c85804b8922fb72f01bbaa5f5f56228d6f5e2f525365cbd4e76a33cf9aafa11e9925d90bcc5537ae5adad528629fadae094727b93ed6c63420d148be1bb2fa826f0ea019f50c2d17a9ee45858cb538ce9e6d0720a02812b1486d5fd52ba37f9a42f106be2ca08b78b9b60199beae3fc6dace3d976c62efca4e5bbd8b9b715e50964380c0ef1bb4b91892d5f4e50d517780e5f03486b1edf16fd3ebb1771d6745bf5ea5154d5ddb26a4f648fa83c7b990383b1e231a433c382e284bc0f1dd1fc159e3855b79c166003fa94a9935aa3b3ea282a0ce5fd083c75f2ee4e735d3c927a7a0194591c1b4ab6c278d219e5b7494c9685e46307ec8cd0539d2aef5ebb638acbbc49f7af586520c5155b51a5c89090cd5cfd235627d35b2256c08e737bdb12927b77a8beb9aa10d6d19a93c55a8864af169ee5965091320278f1546f46603f58be54c7cb61ff6b6caeab9ce1b0f5e526c212aeb5cc2e9cf3ec0f95f7678ebae8409aa781ff7ba896705f8ad5ad418c192b05faa393d14111830b7d73d2ed54fe52efdf434211896a2f4414b796f16ef65c484d1d65ea6df08eaad65b38192789de681e804bf0e4e90cd2983f4c729907e9f4e4a3514479d47f6099bb4e71422362a5f47de12ae15e0778d8be4e9f48a77f9c2c8c029ad3ee3bab6ee3a516c8a87cce2ac27a15c63d3d2fcd3c2b25f726be7628388e5a06d21fd5b7a179ff540d696178bd7541c2a79185bf343c808119770fea7742602a81512b79fd88f65b7e53abdb19e937f82b4d158163b0bc88513bda1b5206d80323d4c97b68898a1ddfeb3de323c4f414220ebc84d9bea6f123d4a8d1a8686661b06985ec4a8cd730458ee67794bcd1e330371579606f84d74a5286aad47c6541e93d80f1fd1135463f63cc44541866118bfd0aaae2d5b0af24e906bebd06944fda5f827f775b0bd224a281c7a6b17835d5d66abb3d8c5a19567af16cc1f79e5898c0748c634eb4c2b5f0fabbb7922c52ccb77a6d39bbad7ee19f4a7637208c889e453b8536cf354906181032d11e5f92cd7f282b4eb7af198ef54ca7e488d61351ded3a9cebe4eb72faa67a46a1298f6fcd191d23ef089af157d5d2e486ceac686cb41a31742a733035e4fbe51bde574c01e7be838cdf313a01e04940867aa137fbfd1d922ee464312e89a48c88945b25602ce6ad97d2cf5eb2f5c84adda855d7766bb279b8b139d928812c76eb670cbf1d827e1d78083e1b6bc681a58bc9ddbde93f0e91d491b0c8dee1e9915599e558edaba46ce8a77520766c883b491f963f7ddc9031b984cf2c4689bf03ad2098c6c871c02b6cdd4919c1d8b7d6f31d9c3df4835143becb3cd0b98abebe7fca94e8299f4ac5db8f6393bc2b6f5117e9eb7b89a950acc0f944dc913f33cca0d81e982c507f98afcd1402902c717c67c81ebc74dea299a6a67069174846a06aa8187d279b6ee5fe829030237af1512b308fd76273bf24fb78c5e7060a8eac741594e8958546c510cfb737cafc27d620725a79234884ff6234ca148203bc738a83a5380159167b106e588445a7040c5a055c6f438197ff7a9400ca65f68e731120ff350241ce60aeeb27c7695c6421376466c5e824d15f39dfe191e5853a65851e89e6c0cbb826614fd091100d12ec322aea6d35bf4b0b0e1d79c663bc53f9558d45df10f347c72d0f112098cde9c71de4ebdf88528c5b69749b60d6bf726edc626b4910650ab6034dd63737843f2b247aea671919a3cd0e087d539268cf522e09a6b23cc64ad91406a4e052c50c8a43080d501c092fae2397f4d69cae41ee354101a33bdb0a32ffbf7012c6088659b653c03d337fa91dcc33681c72aa8d321471f757c52929bd47f7d3692f8552fc2d6143679b35f29e4e4310b6dfe385116b1df60748e8ad762702794787e5aa7828930249e20444d82a1da286b231675c338c2449f5ccbf149845eeeb967330007d5eae7a17f8951623741d33d9c946425c33545971e8752c8170bef43c26c348580feaf72d7541b3b6ee62b6b0a7699bef81f6ba1b033bb32aceb171143dc2d89396d5f33e51b5b516f31f0034b4a16515b9e67c2d62697ec06e814ca5829bf09ec70c53bc3cf59aeffa60cc5989c28e4cb92da28791e3170952efe723388ef9684203fa8a47c2a0f5c7ab8e925ff877a54aec341719a00f9bd4f425d54eedc66fe76fd367596dbb62cb3266e3cd7374be6fee80b58182b8bc0e4719d1dcb905e1aec6478165def27eb52b89ab77163b0317c923f5a552c3a7cdd25859b8d5309b392402e6c295989b2d0fe77a4c5965557cfcb765a8a1e2825cb3e83b22619994570d5e33d6db0eea530e11f1e5d14cda9a86631047000d423ff04ea0b1cf2edd95ae86bf12f56b154db0d98480d610a3e6a7a80e493a2749a8027b974b0fba7d712f55dd6eb657da976d2ca4706cd4298ed2090d3e71cd02220215b40f9a23daedf7e7f2f84b1301c59bcaac4499172da9b62a19899cba94f54f12397f625ea5a42ab8e107950c0170117ac3fd223a316c55b084de95b47d8e8c6c9f572fa117d7901ff21f1f37869c7e42683c77cb1aa9655be7cc01402f864b77e44f0fc409614b3bc55f17a7c3a092dcab15b16bfb571c9f4021aab5f55f1e1cf6bec28d093b2e67fac680e8395a7c3f6ee9e34b783a6eac6080507fe046661dc00f996653d42a260b22c7228c8fee458eff02bee08ee14dd8a9882942655e4a66c56fb349a9f6e34e1af3662d80a2a027aac003837584ebd240298d701e12955ea4b0b8be5ef35a329ec5c908b0fedf67e8a6b5d13b7a0f82923feb848ac96adcbece6154a5647b3d47dabc80c105bd94362cb7074f8149e7ce6b018908a650abab0910116521f4c399db92519d6cae28f95c90a54e5090d377aba75cf46f9b3f4288910f4a1a9cb0e7c970cd66e30dd171439e87598164fa1efc0482b346a586c4added3dd522380fc51b20d2e9bf830ecce5ab6cab9bff8c303f5513c7f7e6c87fb9b44d9eee0fed4d62b1138437dafeda390b7a5ca55c58a23626d6cae5df4377cd36de12852f7a315954860dc557a50ed4170a63b75a1959dbb73c488a1b6cb92e98061c2b05ad4fdef11b0d5a724ffa0923b880a6f21eec52e376fb52310a0483c321ebce0fb0f978014cde0ff38d7c92453a914141289ea2badb0049d9eafe1be13dce4a3a7f5c9a5cfc91368bef0f879ae5e4eba804fa293415c12e5027a92f964666e7ad71f3692fb9fb8b5322585ca90b5f820f5431b1633f96b85066f5fda3950941ecfe5ab096ecc3b1d28f35cb31111e2a5413cd91cac9239d2e972a53ab4b97ceec72b44ede3757668043dc57f628d7b5f1833f5434e2391a6dd9f084f8ae42d94cb1edde97406e649c9fae488e256f8236ff889fcac133bc5859ba495753930f6310d21249f7cba90e869e3aeed93e159b0410849eb9f7861c12e26fb69a112d955647de4c0cfc79bf4221de3871e09cabb8f8a8a2bd361b241ada8994aa9c8c991ee9bdcb30f5dd53cff2b2b50ee5997e66441a3a2c500874d6e11507908cb282798b581b53d961e2323098d6a6a440fc68eb1b67a2a2270b486e20604d3d30d04e45d460e9d3fcba9023897b09ecfdbfac697cbfbc2b67c17bba1518a7ecb38c78cc9f88c855cb3b733f0ffaa96be4176a7e0f95a517a3ad1fbc6a9e7aa26c5c7296814fda9a85079f3e443f6ebd0e9e26ce079be450d63c7c9e68aa172f088fa93a9520197a61a307e8dd8aba76a7444599d01682a40b8d86a0e8a464e004ceca42c513c78ace460e821db3cd15a77c41a878a3faa1c28ae7e7f10d7dce40bb524922dfe98b2af011c5ac3034daaada53ae87183c5c27306aee572841f4fb6f3033733475df6f84f8acea2d308299203b719f91d39d3afeb1c54f1695376c7121fd00126645c49a316248229f4e7d506da0404193a85710fc7e9a862b36a33f07ca496af8a827f092b4fefdeeae5219d7516e29e10afc5c77f5e54dced181a49bec759ad43803bacc01bce312e0a8664e95143f875bad1b61fe6acfac02edc2f9d2e59cfe895382d48a8f39c026dd87882fa218352a98c457e080e2b3ce7295c5f7f935f3d28e73f7f03739fef21a13f063171158b6e6090b65ffc626e71a8772ead61bdaf67788a8661e006376746b3cdc596565e4a71ea9c5af8f06e6bccf1dd6e91129e128c0f4959c668d3ffb981fa4d90415446561b476cdd4ecd6df43d930ad6434e8f04ce21b6e7597ac05cca3c960671a105ae679ddb998d871b9c3f9db609952a0738bce127aa0ec1eafa16fe9ffd4e34183aba5fa95a4ddb2d13dc97b4299eaee0ffd90d181373d7b2f4b124fca0ca47dcf393db84a647516ec40a4c579480bed642d72a79fd4333e06e4beb7b80243ad5f591fc5542a9df133681c1ec3e196f16c973a0d28b14ade9e7c3fb95c50b6c6944cd24a40e9b91f54a208870613ae809b2692bafcdc0d5cf9235487760d6b6cce363651e1ad59c053257dd1e9771dc76ef989b580116f486e299092ee6916ae2d48eda99a390f2377a9a913247e33dd2bff2093a11e2eae24a6e0c2267688de9e41fea549d0fa720a2e6660d15177c211968a79c72baa931db2852d006b0203d1b94418ffb5db4936ad25f9c9d82705d0f6970ed79696fe8f95dd9db0bd6f5b9b0d8064fa3354c7f5eab086d85385b964e9aad6bc8dfeb38a768c9ebea8e904e3732a8d9f17270f211cdcc5ac6069c0f935582b232fb99f8770556dec05d4d88f5c4dc2c2e80808bb510eae8e9b353ee0a6683966eefac9836708c1914944d32a637e04389a0ff8b18eb2607b6de2796ed52012a6b7ee237c7b83f7fe9945ae9a6e2e86c4694ef360c0d25917328d17ef70339251f7def9a360a10431e2c73b58876e531319bccbf302b64faf7db06d591005a38255483c19f90766007a5b0b811b575485cf0848f5002c3b457e14023b4d2f469a4be7aba2397e18bbc182df3fcd57f08d555d7a863a40bb5864f4d40a4e4b9882bd80f858146990157dcc903301cd6af6ba8c8a406625cf674329648e1483e97e3fb4afc32eb4aea980ea43ad17b1dc3b0a1e8a76469c77f049167404234bb9adf00c56e2e2301ffe79709e781fd88b21e40992959a3bbea51f54f25e7e9b0265eee543139daf2aec98124058f8d6a1bf01883acd3647eda9b308ab41d2bd474609c67eb6b28d18248d362160a7a3c76bc042953a623951e0226ca3a6a9d51396aef23ac456bb173686609eafbbafc497d6f0889588ecda86b75933a197af9a44daaf192f2f0178392d095ff461aa02066cde0bee5d8d94c2801986c966df04bbdf712fb563968208886eab8c0ade7c61f291872b5582832b92bccfb4b0495f99ac0db5eddde6dcfe8f207a59d59e82c3b993038727be912d1d9e0fa7b89c3287121703170a6cf2f2fba0eea6e3c1ff399d9284f7fbcc9452ea0dc7e9a6e7c41e70e663a943e635b56ccf50baee1827e0ac3e247f4f2c948c5f4accdf3262f68e4520150884c91320bf9bd47178620945a2231b49ee8f3b94c213418e3ffab706158fd67c23873284b76cc854b84803ae4a7ebcfc1529dda59655f82a7b1a57657e533f4c7f87351290219520a0f548ecab9fddbfef9c7d393ead578066e489b72d44e9b22b8f5b2c24d9851801872404a1129167538254ea08d562538cd2258308cc531c083b88683378f955768c79230e6584e3302a5ff1e25fd0f9a99e68c6022589aa63a99b64d53d53b977da26c866af2c17a6d2f7dbab5d9597a16a06ea3aa96342b2ab25f75de9596283df26fbf5013455bd1d723b3f3f3b0b3c146fb2148e3b5d08a81ea0681b1c36694320a394b4615c164fd0a8e44652e706c6c17d3706cceae0c1777e2cd3d07f502d66fe8b95401bd999b12edbcb6c232cfc0f0c0bdbf7cbab3827ea1f353dcc8b9be98939bedca3203d2d4619cd403c9b5b0a9cefa2d72fad708bfca5b3250deadae704d5e5034dd5aaa612c20ec960755893683bc31566a42e79c1f65d93baf6074af7eae337de965f3441ddf356ef1f6f6979327709dba828e4f7772388613b7f7aa6e7eac87dd222fe17cb6a0b25cb847d5edb0e410aee00950e3cc037e2a5f4ffdf5a8bf94770aef39ee0ea4bc2b6680145adcd30614739bff66ee581aee396ca7de31b91e5360371e2ac93e684e33283514afa902a1b1374f5366901b8421a7b5a6025e04dfb4fff2975c8fa0fee1ec0c1343ffd05fca1616166a028ac9aca665951096e2ad05a78aee9b7b6737de18a89a7e99818e39c695b4f3069dcf33a20b1bbcd4c10cad9b40e8eefa6170f7910d54eddcf6c36a78ff56561d67b4204386a63dd0d9099623f32471d70fefb7aca5fe7a3a2d78d237dabde7151610637619c525e0700082a2210bff70abfea9fa8b2ab8c3ca1dc0ddc211ded0ff9c0e6c3adb5b456d2c02c768ec3e49db71760f7ac541d77eab6055a5f905c0352c82fdd51d6be10bba57bbbf9047e2bb288c2200629dc459d3de902562cd6f47f77f958800930e0f7ace00ba9a41d435b56f454f0064ad6a40ea542cb31a2fb44a57f6daa908a441292e85676a2f40b612543ba6c25ac6c5c6a2f74daf0c10fa3173e9763513282bda7f359380f8249f84485f3b83a3c9ac450b7d6f5dd0fcc8402842db59b475970da85ac5c1bb388218320a31544c9778f6a22bc301ff2048c95ccf01b325514b8ffa04ea4bcfdacbee3cd5b6073c05419417228c1fc62eb681bbf05a84feae3d2a1a2ff4e4f6a326e4108e24fdacd001dbdfd88ae5879a646240a95cc955f05670865860b16cbc503db5ec0f4050db049a58b15d8027fa865f86b605b50c06fd4481d7a6365eb69bd426bebf0a6bff578c075e3d96599d4c8cb470ac7ed5f5e7ce675f52635252aff5d6438a89725f5f34aaa4a44f0bf4c598ff859fa92f6a3c8a37edc7d3c08a597193636cefebe4d6119352f5541f870d513558eb3d7012de98c97e06dd3fb3424e2924638dfe79051e556d84aed1efaa63101bd7f3d05e3c89b4c71a9880f10d347aaaea51e1540959014ff44a8dd746451f353a079e637c9a9090be6199b4d564ca8371fe2c67cc1a67e63634de71304307148d386a752b5462be8509f5ceb965184ef3b77f242f41338542e643528c6f99c9c2eadc0f9e2280ad02b8268c3ade51b2ac7e53215895d405e5ffdd67b4524e39285906685b95601509da5259ecc560dc5ddeb2400f399ac8999131717170ac2881a36f4016624bd9ee67634f469802469724e9c37b96f886cd8e3b42fc70bc5c4e2ee37d963c40ad333e214c1137bf2d702804851ac567e0d5988113d043272bd96d7b406013492e5630a2f9fae172aa6966a5d4348edb94e94a736b8591729be21ab2a45006392a17f0dcad60ae4201c297eb507bbcf78e44db4a91708d0426f6873671c3b4ca52f5e4d584c48fae1b93653ce0731ae4240831f3ff284f504dde1819176bda8389693e24e75a1a35715da17ac304e41de52b2c9839463954c0fca9278d0fdf0405468fb0ff405276cb668c5caad9cab959c420fd5845007520520c3ac84553a04651b9bec6476a5624c7cc32b0d34d9bceb5750527b48433de54b5558a01b826690063b4ae00130430fdaf7898814213d11209818bc5cbdb37c6747befaed0b57f2d5444e38c996917bae54c41362644fe2b7c39381610808aecf327e7fa3c3e38a9c39cbdcde43a139764672f8a628e3947b4e2dc039c53426a3e429f377a79559caf2603ce9ddfc07d4802337e93392754c98888e574af315bd28babaf9e92385a4d3a5ac9e9e16f795d18c278503920175e303c46b89e6f3233905c82c8061baa5af159abf160de247ebd5995238d171928640b1f628325e0a443479dd4a0e66595417b139f1bb27d5e10db21215f36f2e8a8c8e91704b05cc18faaa68ee56f4c3226aa7f6d688bad0339bd299272aa2b6ae04a8124c96cc8fd0d5a2d7fb90bf5925c5d74ff552a19f50b317accae7a0434d6b1d9444fa22b16a3d248ec5505a26ac153825f2b739af0ff99e9ba89dfccb8d249cc9a1e5f366db353cc66eca28fc910caaabc4a17a7c2ba6bedfaef1383263e6cbd127ef9224379ee1a2a4741273b23d3ddfd2692fc7227362f4cc78642a34225982488e0793ec91d9a0277df527db669da08fe3a8a1acf1b7e25ef201a97c48b581dd05eb9a848ee53ddcb47f6221a898bef718ef1cb29dca33ff12e3129adcb56bfff9b56d2cd863dde9b3d407d740fe17b6f7c4124dcf045b7cc35ab5b3e3bcd4591a24de43f27a42054180c3e2dccc3c15cd6f72f57de10fac47e1db0934c3360df60342c253d54114d45718c99e0fcebc5f40cc41cf4ca0ac5fab6dc79caa3938f0fb903479c8db20b622f4c653a706b5eab518ca20fa2a8634257e9495c243250f7f5813bcf3c5c8cf7baa36fadfcb457747a69e6c8c3562cd793e89e6e1732a18e6871deb03a8385dbbf992d9c27997ddef5b0a2f9dc6c956f3497cc00c51e050959e3b45cdc96f4920f17b0e6274e0a1060dda15eb2aa6951fb7f035a2afde04fe85c17aa4df188d5ec837977317d403669a793d0a6ecc13ae33c8bfc0d81a5e30749e81bfff491cbf771829899af1929452ba068ced8ddcac8d18ff0777a69d61d1bb664d96017dbedffd46d654691403352aa822fa187b00a47fa3bc461d3ff030a86d782272b852acecb2b6506c8a94e40c6ad5e0bf1cb5e518a19e81a59fd01a47d0ad0652b53a912dbb5e4afded7ab110bb7d71adcc6f145d3b9014ff0568d0f719de9c755de8e3b5a72e111b2cd6f679705d96af94364c561591b5ad901b10092f532b87369a907fef979c9b07f3811007531b2fab9f8e688b1438a099370a4cb9d0d956f2532bde4ec13101e359c458b6c4b167a73ba30b5bc984a531b853daf78ddee9c8552f0f002c6ebc65bcd1a106adeac895a095d93383a19936f4050124a0cdebb0d835160d1072124e0a0d8566f0882351ce8ab3e74118bd8f2eed4ed31be6cd6387b7506571432e16b48228b24362c154d3c6b0fac237bf2257235c0f356743d4bd096cc1ab97fc3075059d4e655eca1fb8d3529203c47d3296b3797862272185ea2c318a8d4bd8a7c48bbee7d24a48186b3dc57a44da06549f23901b83a0c9ef79107c49ee60ca40eef74fb797531376c7d249e883e6fd8140eb59621b7af5a157ae5fb8367d2f397b1e737b7d9f3b0d4b344f1b46463fd0fe0a3375da83572b4023a1482d1208d5e2340452b32f05413e48ca4006601a9de117686997865f93324b32ac7f965e0e29159322f3dead74f64524b34d5f06940dcb3cc8874a2a8bb35897d527519ea4afce6f1b152891f140eb3a5da55b889a87c01158ac9287b6f4e0bab894ba5f2903344933d85ac712de31b254866a3f227e7d35d779752a8a772dd490db4aeb6c482fb0d3e9e0a5c3538bfe5af2097b383c47624c957985809a5ccf34d8f86cb70d2021683a2392fe5b9569b783b1ea7d858efa9e97cd28f99e48f34f8a739f4ac2e3ed099024561d4e529e32f1956c746c5ff790e638e48d5404260824c9031e041d01141238b980cf67370715e78bff8068e405599e58ae22479e96dbe463121b5218be186bf4af74509b466ab822b23bfaf634174f1bb59f9aeb2b1b95f040cb831dbeef89ec680ba8f2ed55564b8f7090917dca99375f65e0fd729c9db7be249711bdf1bfe3a7312b9dc4b60345746d2ad513ef9e8085996d813c4c3510c88c03869d51387816b74d21d01de9185e4e611d9669f6afa73c7564472f30ddd9f0738918d61e1c72fa0766d7c3cc850f1e31f499c4c98569ada66715b17678af05e4cbe56bd968b4450e4ec66150ce47020021cc7111df57012455f37055d43370b807592638214b5c4aa745bbbf1ee973119ba24ea1c0e29489f1a9a071598f2147109ce9a2bc7f5f76891f7034130f4f5eab2f030ed480e9a7ecd0255843c8c5a161592baf63c54d266bf65afcb4711443b5fae55682ee8af1e50718c2a0970c084df45d0dd6c62ae2a526c8a69e60406690abac47d4228cf220048896e64b36cd023b6e78bf247b6167744cf272ea6774ef47d9e7346646090783d4e4a73210672e3443e89ad6be90f2a0ff06617ac5ebf9d5fbfd625667b85937307c7a5328d0395179b2783a2cf17b185a99b48b5aa776be953c82b0c55336ff29102b8167c139b25748d0ba616136df3d9c7ef9c2f08056bfddda21c5a3c888edc53431e32aaff8ebbc13ee026f8b36d4f794790ea4e72cf7dae17f11c345441beb6c89d90d17a575dc5e1fe1448d933a7b6bdb7f13205e5faefebad949111b8c7c11bb36f93cb769fed694258f096036f9ee02ef7347c45e7a95ac65f782f119efd42eb683c535da15d8ca21d1c5bbe56f00af2ff8b8ebdcd1513f6e7f5e1ef1d4bc92eab42e2db18ef45ab3dd194b18eb0caa2ff9991159bbdd97b64f1a7c4d39a7365d0a441366b27b819805c3413032223c6c0b4ff2dee09d6efa10424e22a412cc67da7d7e36ac76ec02d4bd3224489c92198263a726c834ec197d2444b05621360cc41fb3bfb8269168f50a2cd2254dfeb83490d54ee1044c8caab1eb3397fd13e38929119e3224f766693212c2128402b096f7ac0c959e0097a517491f67fcbfa8cf81b5d0cc989b7146ae9e68b973db42946dc7c566e1a638f8682c384428c8c2eda1f636ee0312cf6796e7c864178f3f110ff05ae216218c1cd4175b09d86ed44f32ed5e0cb08e7bb45adb7c927a8a851da4ae86e2ccffccb6402fae645604c4180e57f40bc299d37bd65860cecc8db1356eb8590c0efcb0cd48fe42b2d8f21b14f102b6c518749e306b11ee5992b3c008a32d09545b5a57f61cea6d9facf9fe69c6a8c31130b5ab14d42797322f7acd625f3a8b720fb07fd534e7fa65a46e0f8e6162d51b0e8dfd9ef7d92bdd5e62deb1ffb63c80f9fa6da77c640dad7a95b9bab59f68101063ed8d736aa4d8de0efa5f647d2fc59aa10f20615a8241fb9f801c54f0bba292bb84c490585e32dc507c143177aa2964733cb499b77227fc8709cdd40a1ca92f45c5c61d7cb60580f8cd44b14126f018291b234ff2026b61a753347e6672168750f96e06f9e7e078c105d91f21dd25058151c6a20a9b37d0c166e454cc34a3c023a68aa36e7e4288e0cda272695d6a6f4b76efd6fd54549718f1d6d39bd1ba4c7301a79da0166d5122aa65cf888b4cddf8a6614c4e1b82451dd3dd8de2677960fa4b3f92cfe334a806b60a196bc932d465a01fda1daf4deed24c752761d46b91014a58da9bc104a245ddc61a3741e0b494c43afb385ca669596e54ad32b402e5c852fe3fbfb7d276371d2cf6571dac7145613e911dc391a05fff01f456182663823d1c184b603fcd65f8349e563202d5ea422a6a7c5b518d114c567a36cc118d71734b19d51f860b5cd495f4630c525aa21e53b5c1ed3ea73cc2a10522d942bb97bb3190f1439b274b04e43f4208559639050416abce834b75150241ceb6ca1694b89f510f60fcf1e0eab5b879fe5003fbc2485f30368b352ce473628250bf9bb166c1e276c1504b4eb77dd45baca433a5fe84f72b5c841c47e59737ded95eed21f51049e7d854a00250b676bd181b0d5274b6b498181759b1ea7b181a71a262eace42b185479b0e7461cf226b474384b9c19404eb283c69492f60927581ae3ba1b66a20a1bc082bebd3de62593ec5d9ab08d1d8f5c8f8a9b0261d56df8b348de89ef5427bcc64d6ab6780acb33b31b6cb516d22cf7fb0c3a4e8029b35221c2269cc5bae6ec53dcea008e669c1be748afe5b8a958297430fd247c9f74b562df71bb0b76a122fefc188a0f19fbba56e6960407991d35a800c78e638c8aadb35ea5039001823857cc6c2d007569dbebc2017a0a92a22157ec463a347626478759cc712bb82c55d386ca0232852c09cb00aaaf93e8aa98c33d89b0de07fd3df670e76fcaed835eb6c1d2e3444db870f2a9e9db49be9a21e40b47140bdc9901e1bc3580485b86ac8ca3f35ac63c3ed450b28e976ec36378fcb666bd9102fd7bc4c141b986b9fd8a8e4d622dd6f6acb9d5b7f8ba02117846ac41b81f10693f47aead9e4371b210af3738957ff0f296f98a2ec286419dfd7ee2f22a370201c9c8d8e374af5ca27e07dee3593b76ac4313ee3aea87d842e05ba70791d66453c6fd68a0ed0736a4e36c2944313c8f7839da8151697052020df4fb41ab745373febbb89adae34d9efa5b3e8f65b75761ad782a92fab5b8c19386ac026eb5b0c8ec759027cf14a9d892ff348de47ae87f1818804aa8b352af713dc02fc952f7deb43dae0b2338ccfe62fdb8d4fabbe866fae18adde6338df56853b58d6b56b1215e037497c08277559e3df4fd75c96d67bcd2e09efcc1ebe5156cc00804ad69364a34033fc697710f079b4cd8d35d57999970fcd0ce974d8f7f7e25c12f270b983826a3c3f5e32d97691a3589e2d2db75ccbae5c9b4fc6653c6faeac38499b98fce4088e2520512209bb7eb5528a97c9df300b81ac14d8cb4176b55e9f3ba7ab09fe347781dba6a924acd2c1039b3bb4ea0ce69ddd15675d40eb8af416ef6f1b12ba6f9218648ba1ec0166743dba6db2fc37475adc8726924c7ee65c5a68325adc864322fc86644f4e1fa60dad02fb8906a19cc0330a966a363b586befcb2deae63eeeb2dff16fdafdbebdd1c31dde341c42dfc4c82fc99f1a9d3e319a8abb29e0612121e26a34c356585a055d673a9907f2fa8ef0c5a1ac12e45b6f5843d8baa7f6c2c4e66aba89765c83d68c4dcaf5c074b5ccc823b02fe8bbbc5e16da8495249e42e7faeee85b021ec6d20fe395def0d827cbad44518c528f8183484ba8ece7c15480c95755f8e4bbd2de3188079833974f8d1034d981b7eeb6f720dc6dd53aa92ffe83a9b87f3bb796adcabba129871c3e1fea084cdf40c243a91b5f774992fe76d1982365a267fa3d598dba9632ecf54f0547a744f1f8f4b66694cd1549a9dc558820dc691dceecd3757b9a9a1046011e473bb16f759de4e84dc08961dc8b9422cb271da2b9cbf79ca1dbae294b907363986b50a117768018262505c964aa2031f2d93392a09f95d4175fe8b45d0a5f5e763faad881f8657cee7ec9f4d24be2ce300e8ca828ec2a93608858bef6267802a68333ce220c0b04e884e92ce0f136dcc023ac6596f4a0c75284df85538c2421b7a65574d7b00a5b6439301a521bde7e06166d1317549489debaf8618be75ea7844b1e932c6a080d4008f86eb7af6a560bb50f13c2f2570e4ea70031f33fc7d5a343b004d48395027130bddc7943a3056439a2934157fa57162a9e292bc26b3242dbf3c93208</script>
</div>
<script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
      <categories>
        <category>云原生</category>
      </categories>
      <tags>
        <tag>Kubernetes</tag>
        <tag>Docker</tag>
        <tag>Helm</tag>
        <tag>Apache Druid</tag>
        <tag>OpenTSDB</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux 实战技巧</title>
    <url>/posts/15691/</url>
    <content><![CDATA[<h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><h3 id="adduser"><a href="#adduser" class="headerlink" title="adduser"></a>adduser</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 以创建 Apache Eagle 用户为例</span></span><br><span class="line">$ adduser eagle</span><br><span class="line">$ passwd eagle            <span class="comment"># ur password for eagle user</span></span><br><span class="line"><span class="comment"># 赋予用户可以 sudo 的权限</span></span><br><span class="line">$ chmod u+w /etc/sudoers</span><br><span class="line">$ vim /etc/sudoers</span><br><span class="line">  <span class="comment"># 找到 `root ALL=(ALL) ALL` 这行，并在下面添加 eagle 用户</span></span><br><span class="line">  eagle    ALL=(ALL)    ALL</span><br><span class="line">$ chmod u-w /etc/sudoers</span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换到 eagle 用户</span></span><br><span class="line">$ su - eagle</span><br></pre></td></tr></tbody></table></figure>
<h3 id="awk"><a href="#awk" class="headerlink" title="awk"></a>awk</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">'1'</span> &gt;&gt; sum</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">'2'</span> &gt;&gt; sum</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">'3'</span> &gt;&gt; sum</span><br><span class="line">$ cat sum</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight txt"><table><tbody><tr><td class="code"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ cat sum | awk <span class="string">'{s+=$1} END {print s}'</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">6</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ awk <span class="string">'{s+=$1} END {print s}'</span> sum</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">6</span><br></pre></td></tr></tbody></table></figure>
<h3 id="bash"><a href="#bash" class="headerlink" title="bash"></a>bash</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 下载并一键执行 Shell 脚本，更多相关内容：https://yuzhouwan.com/posts/666/</span></span><br><span class="line">$ bash -c <span class="string">"<span class="subst">$(curl -L https://raw.githubusercontent.com/asdf2014/algorithm/master/first_commit.sh)</span>"</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="cat"><a href="#cat" class="headerlink" title="cat"></a>cat</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 查看系统版本</span></span><br><span class="line">$ cat /etc/issue</span><br><span class="line">  Yuzhouwan Group Enterprise Linux Server release 7.2</span><br></pre></td></tr></tbody></table></figure>
<h3 id="chown"><a href="#chown" class="headerlink" title="chown"></a>chown</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 软链接</span></span><br><span class="line">$ chown -h superset:superset superset</span><br><span class="line"><span class="comment"># 所有子目录及文件</span></span><br><span class="line">$ chown -R superset:superset superset-0.15.4</span><br></pre></td></tr></tbody></table></figure>
<h3 id="cp"><a href="#cp" class="headerlink" title="cp"></a>cp</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># -r 拷贝目录</span></span><br><span class="line"><span class="comment"># -p 保留源文件或目录的属性，包括所有者、所属组、权限与时间</span></span><br><span class="line"><span class="comment"># -u 只会在源文件的修改时间，相比目的文件的修改时间更新时，或是对应的目的文件不存在，才执行复制</span></span><br><span class="line"><span class="comment"># -v 打印拷贝了哪些文件</span></span><br><span class="line">$ cp -r -p -u -v ../* /</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过如下方式，可以避免源文件不存在而导致的报错</span></span><br><span class="line">$ cp ~/does_not_exist ~/somewhere 2&gt;/dev/null | <span class="literal">true</span> &amp;&amp; <span class="built_in">echo</span> <span class="string">"always get here"</span></span><br></pre></td></tr></tbody></table></figure>
<div class="note info">为了避免别名的影响，可以使用 /bin/cp 原生的命令，或者 unalias cp 消除别名</div>

<h3 id="crontab"><a href="#crontab" class="headerlink" title="crontab"></a>crontab</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 查看脚本是否执行</span></span><br><span class="line">$ tail -f /var/<span class="built_in">log</span>/cron</span><br><span class="line"></span><br><span class="line"><span class="comment"># 防止 nohup 的定时任务发邮件给 root，导致 var 目录堆积（/var/spool/cron）</span></span><br><span class="line">$ crontab -e</span><br><span class="line">  <span class="comment"># 加在文件开头</span></span><br><span class="line">  MAILTO=<span class="string">""</span></span><br></pre></td></tr></tbody></table></figure>
<a id="more"></a>
<h3 id="curl"><a href="#curl" class="headerlink" title="curl"></a>curl</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 发送 Post 请求</span></span><br><span class="line">$ curl -H <span class="string">"Content-Type:application/json"</span> -X POST --data <span class="string">'{"blog":"yuzhouwan"}'</span> localhost:8080/api/query</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送的 Put 请求中带时间戳</span></span><br><span class="line"><span class="keyword">for</span> (( i=1; i&lt;=100; i++ )); <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">'[{"ts": "yuzhouwan_'</span>`date <span class="string">"+%s"</span>`<span class="string">'"}]'</span> &gt; id.data;  curl -s -X POST -H <span class="string">"Content-Type: application/json"</span> http://yuzhouwan:8081/api/put -d <span class="string">"@id.data"</span> ; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送 gzip 压缩的请求</span></span><br><span class="line">$ gzip raw</span><br><span class="line">$ curl -X POST --data-binary <span class="string">"@raw.gz"</span> --header <span class="string">"Content-Type: application/json"</span> --header <span class="string">"Content-Encoding: gzip"</span> http://yuzhouwan:8888/gzip_api</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看公网 IP</span></span><br><span class="line">$ curl cip.cc</span><br></pre></td></tr></tbody></table></figure>
<h3 id="date"><a href="#date" class="headerlink" title="date"></a>date</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 该时间戳格式为 13 位毫秒级别</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">"`date -d '2017-04-21 10:00:00' +%s`000"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印时间戳</span></span><br><span class="line">$ date +%s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 格式化时间戳</span></span><br><span class="line">$ date <span class="string">'+%Y-%m-%d %H:%M:%S'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印纳秒</span></span><br><span class="line">$ date <span class="string">"+%s%N"</span></span><br><span class="line">  1539065478653578171</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解析时间戳</span></span><br><span class="line">$ date -d@1545149326</span><br><span class="line">  Wed Dec 19 00:08:46 CST 2018</span><br><span class="line">$ date -d@1543210000 <span class="string">"+%Y-%m-%d %H:%M:%S"</span></span><br><span class="line">  2018-11-26 13:26:40</span><br><span class="line"></span><br><span class="line"><span class="comment"># For MacOS</span></span><br><span class="line">$ date -r 1577808000</span><br><span class="line">  2020年 1月 1日 星期三 00时00分00秒 CST</span><br><span class="line">$ date -r 1577808000 <span class="string">"+%Y-%m-%d %H:%M:%S"</span></span><br><span class="line">  2020-01-01 00:00:00</span><br></pre></td></tr></tbody></table></figure>
<h3 id="df"><a href="#df" class="headerlink" title="df"></a>df</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 磁盘信息</span></span><br><span class="line">$ df -h</span><br><span class="line">  Filesystem                   Size  Used Avail Use% Mounted on</span><br><span class="line">  /dev/mapper/systemvg-rootlv  7.9G  388M  7.1G   6% /</span><br><span class="line">  tmpfs                        3.9G   12K  3.9G   1% /dev/shm</span><br><span class="line">  /dev/vda1                    485M   39M  421M   9% /boot</span><br><span class="line">  /dev/mapper/systemvg-homelv   30G   11G   18G  38% /home</span><br><span class="line">  /dev/mapper/systemvg-optlv    30G  187M   28G   1% /opt</span><br><span class="line">  /dev/mapper/systemvg-tmplv   2.0G   68M  1.9G   4% /tmp</span><br><span class="line">  /dev/mapper/systemvg-usrlv   9.9G  2.7G  6.7G  29% /usr</span><br><span class="line">  /dev/mapper/systemvg-varlv   6.0G  352M  5.3G   7% /var</span><br><span class="line">  /dev/mapper/datavg-datalv     98G  4.1G   89G   5% /data</span><br><span class="line"></span><br><span class="line"><span class="comment"># 找到 device 对应的 disk</span></span><br><span class="line">$ ls -trl /dev/mapper/</span><br><span class="line">  crw-rw---- 1 root root 10, 58 May 27  2017 control</span><br><span class="line">  lrwxrwxrwx 1 root root      7 May 27  2017 systemvg-lv_swap -&gt; ../dm-0</span><br><span class="line">  lrwxrwxrwx 1 root root      7 May 27  2017 systemvg-optlv -&gt; ../dm-4</span><br><span class="line">  lrwxrwxrwx 1 root root      7 May 27  2017 systemvg-tmplv -&gt; ../dm-5</span><br><span class="line">  lrwxrwxrwx 1 root root      7 May 27  2017 systemvg-usrlv -&gt; ../dm-6</span><br><span class="line">  lrwxrwxrwx 1 root root      7 May 27  2017 systemvg-varlv -&gt; ../dm-3</span><br><span class="line">  lrwxrwxrwx 1 root root      7 May 27  2017 systemvg-rootlv -&gt; ../dm-1</span><br><span class="line">  lrwxrwxrwx 1 root root      7 Jun  1  2017 datavg-datalv -&gt; ../dm-7</span><br><span class="line">  lrwxrwxrwx 1 root root      7 Jun  1  2017 systemvg-homelv -&gt; ../dm-2</span><br></pre></td></tr></tbody></table></figure>
<h3 id="diff"><a href="#diff" class="headerlink" title="diff"></a>diff</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">"a"</span> &gt; a</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">"b"</span> &gt; b</span><br><span class="line">$ diff a b</span><br><span class="line">  1c1</span><br><span class="line">  &lt; a</span><br><span class="line">  ---</span><br><span class="line">  &gt; b</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1c1：表示 a 文件的第 1 行 和 b 文件的第 1 行不一致</span></span><br><span class="line"><span class="comment"># &lt; a：展示的是 a 文件中不一致的那一行的内容</span></span><br><span class="line"><span class="comment"># &gt; b：展示的是 b 文件中不一致的那一行的内容</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="du"><a href="#du" class="headerlink" title="du"></a>du</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 文件大小</span></span><br><span class="line">$ du -h /home/ --max-depth=1</span><br><span class="line">  3.1G	/home/eagle</span><br><span class="line">  40.8G	/home/</span><br><span class="line"></span><br><span class="line">$ du -sh *</span><br><span class="line">  64K	logs</span><br><span class="line">  276M	software</span><br><span class="line">  28K	zkdata</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定以 MB 为单位展示大小，并排序</span></span><br><span class="line">$ du -sm * | sort -nr</span><br><span class="line"></span><br><span class="line"><span class="comment"># 另外，使用 `ll -h` 也可以得到文件的大小</span></span><br><span class="line">$ ll -h</span><br><span class="line">  总用量 546M</span><br><span class="line">  -rw-rw-r-- 1 zookeeper zookeeper  41M 8月  31 10:08 zookeeper.log</span><br><span class="line">  -rw-rw-r-- 1 zookeeper zookeeper 101M 8月  31 00:06 zookeeper.log.1</span><br><span class="line">  -rw-rw-r-- 1 zookeeper zookeeper 101M 8月  29 11:39 zookeeper.log.2</span><br><span class="line">  -rw-rw-r-- 1 zookeeper zookeeper 101M 8月  27 16:01 zookeeper.log.3</span><br><span class="line">  -rw-rw-r-- 1 zookeeper zookeeper 101M 8月  25 20:38 zookeeper.log.4</span><br><span class="line">  -rw-rw-r-- 1 zookeeper zookeeper 101M 8月  24 00:34 zookeeper.log.5</span><br><span class="line">  -rw-rw-r-- 1 zookeeper zookeeper 4.2M 8月  31 09:35 zookeeper.out</span><br></pre></td></tr></tbody></table></figure>
<h3 id="echo"><a href="#echo" class="headerlink" title="echo"></a>echo</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 不换行</span></span><br><span class="line">$ <span class="built_in">echo</span> -e <span class="string">"yuzhouwan.com\c"</span> &gt;&gt; blogs.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 除法结果保留小数位</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">"scale=2;1234/1000"</span> | bc</span><br><span class="line">  1.23</span><br><span class="line">$ res=$(<span class="built_in">echo</span> <span class="string">"scale=2;1234/1000"</span> | bc)</span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$res</span></span><br><span class="line">  1.23</span><br></pre></td></tr></tbody></table></figure>
<h3 id="find"><a href="#find" class="headerlink" title="find"></a>find</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 找到最占用磁盘空间的十个文件</span></span><br><span class="line">$ find / -<span class="built_in">type</span> f -print0 | xargs -0 du -h | sort -rh | head -n 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># 当需要删除的文件列表过长时，rm 会报错 Argument list too long，此时则可以使用 find 命令进行查找删除</span></span><br><span class="line">$ find . -name <span class="string">"*.log"</span> -delete</span><br></pre></td></tr></tbody></table></figure>
<h3 id="firefox"><a href="#firefox" class="headerlink" title="firefox"></a>firefox</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ yum install firefox</span><br><span class="line">$ firefox yuzhouwan.html</span><br></pre></td></tr></tbody></table></figure>
<h3 id="grep"><a href="#grep" class="headerlink" title="grep"></a>grep</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 或操作</span></span><br><span class="line">$ grep -E <span class="string">'bin|etc'</span></span><br><span class="line">$ egrep <span class="string">'bin|etc'</span></span><br><span class="line">$ awk <span class="string">'/bin|etc/'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 与操作</span></span><br><span class="line">$ grep bin | grep etc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 不区分大小写</span></span><br><span class="line">$ grep -i BIN		<span class="comment"># (bin/sbin)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 全词匹配</span></span><br><span class="line">$ grep -w bin		<span class="comment"># (bin)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 匹配，并指定显示多少行上下文</span></span><br><span class="line">$ grep -C 1 bin		<span class="comment"># (bin/boot root/sbin/script)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 过滤脚本输出（|&amp; 相当于 stdout + stderr）</span></span><br><span class="line">$ zkServer.sh status |&amp; grep Mode</span><br><span class="line">  Mode: follower</span><br><span class="line"></span><br><span class="line"><span class="comment"># 特殊字符，需要增加反斜杠（\），进行转义</span></span><br><span class="line">$ grep \$</span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据字段 str 匹配到某一行，并获取这一行随后的 n 行（grep -A &lt;n&gt; &lt;str&gt;）</span></span><br><span class="line">$ vim yuzhouwan.txt</span><br><span class="line">  1</span><br><span class="line">  2</span><br><span class="line">  3</span><br><span class="line">  4</span><br><span class="line">  5</span><br><span class="line">  6</span><br><span class="line">$ cat yuzhouwan.txt | grep -A 2 3</span><br><span class="line">  3</span><br><span class="line">  4</span><br><span class="line">  5</span><br></pre></td></tr></tbody></table></figure>
<h3 id="hostname"><a href="#hostname" class="headerlink" title="hostname"></a>hostname</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 查看机器的 IP 地址</span></span><br><span class="line">$ hostname -i</span><br><span class="line">  10.10.10.1</span><br></pre></td></tr></tbody></table></figure>
<h3 id="iostat"><a href="#iostat" class="headerlink" title="iostat"></a>iostat</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 查看磁盘 I/O</span></span><br><span class="line">$ iostat -x 1 10</span><br><span class="line">  Linux 2.6.32-504.3.3.el6.centos.plus.x86_64 (yuzhouwan01.com) 	01/19/2018 	_x86_64_	(24 CPU)</span><br><span class="line"></span><br><span class="line">  avg-cpu:  %user   %nice %system %iowait  %steal   %idle</span><br><span class="line">            17.28    0.00    2.02    0.08    0.00   80.62</span><br><span class="line"></span><br><span class="line">  Device:         rrqm/s   wrqm/s     r/s     w/s   rsec/s   wsec/s avgrq-sz avgqu-sz   await  svctm  %util</span><br><span class="line">  sdb               0.01   159.15    2.51    9.62   493.46  1350.14   151.96     0.02    1.77   0.28   0.34</span><br><span class="line">  sdd               0.01   162.24    2.49    9.69   493.13  1375.44   153.42     0.02    1.85   0.28   0.34</span><br><span class="line">  sdc               0.01   162.57    2.49    9.83   487.72  1379.15   151.58     0.02    2.02   0.27   0.34</span><br><span class="line">  sde               0.01   161.54    2.54    9.80   500.08  1370.68   151.61     0.02    1.87   0.28   0.34</span><br><span class="line">  sdg               0.01   162.06    2.53    9.83   498.98  1375.10   151.64     0.02    1.93   0.28   0.34</span><br><span class="line">  sdf               0.01   163.34    2.53    9.74   496.43  1384.64   153.22     0.02    1.92   0.28   0.35</span><br><span class="line">  sdh               0.01   161.44    2.56    9.74   502.61  1369.43   152.20     0.02    1.90   0.28   0.34</span><br><span class="line">  sdi               0.01   162.58    2.54    9.78   498.87  1378.82   152.48     0.02    1.99   0.28   0.35</span><br><span class="line">  sda               0.29    83.48    0.29  146.49    14.22  1146.37     7.91     0.04    0.28   0.05   0.69</span><br><span class="line">  sdj               0.01   164.20    2.60    9.77   512.11  1391.74   153.90     0.02    1.97   0.28   0.35</span><br><span class="line">  sdk               0.01   161.76    2.60    9.70   505.17  1371.69   152.56     0.03    2.04   0.28   0.35</span><br><span class="line">  sdl               0.01   168.31    2.50    9.84   490.59  1425.20   155.30     0.03    2.57   0.28   0.35</span><br><span class="line">  sdm               0.01   162.34    2.52    9.69   486.76  1376.20   152.68     0.02    1.97   0.28   0.34</span><br><span class="line">  dm-0              0.00     0.00    0.02    0.31     0.70     2.45     9.64     0.00    6.04   0.43   0.01</span><br><span class="line">  dm-1              0.00     0.00    0.39    0.42     3.10     3.32     8.00     0.00    3.42   0.27   0.02</span><br><span class="line">  dm-2              0.00     0.00    0.10  173.34     7.42  1035.66     6.01     0.02    0.04   0.03   0.55</span><br><span class="line">  dm-3              0.00     0.00    0.01    7.47     0.22    59.05     7.93     0.00    0.56   0.07   0.05</span><br><span class="line">  dm-4              0.00     0.00    0.00    4.10     0.00    32.78     8.00     0.00    0.56   0.04   0.02</span><br><span class="line">  dm-5              0.00     0.00    0.04    0.81     1.26     6.51     9.07     0.00    0.59   0.17   0.01</span><br><span class="line">  dm-6              0.00     0.00    0.01    0.82     1.51     6.59     9.68     0.00    2.02   0.16   0.01</span><br></pre></td></tr></tbody></table></figure>
<h3 id="jq"><a href="#jq" class="headerlink" title="jq"></a><a href="https://stedolan.github.io/jq/">jq</a></h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># https://stedolan.github.io/jq/download/ 下载 jq-linux64</span></span><br><span class="line">$ mv jq-linux64 ~/software/</span><br><span class="line">$ <span class="built_in">cd</span> ~/software/</span><br><span class="line">$ chmod +x jq-linux64</span><br><span class="line">$ ln -s jq-linux64 jq</span><br><span class="line">$ vim ~/.bashrc</span><br><span class="line">  <span class="built_in">alias</span> jq=<span class="string">'/home/connect/software/jq'</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">source</span> ~/.bashrc</span><br><span class="line">$ curl localhost:8083/ | jq</span><br><span class="line">  {</span><br><span class="line">    <span class="string">"version"</span>: <span class="string">"0.11.0.0-cp1"</span>,</span><br><span class="line">    <span class="string">"commit"</span>: <span class="string">"5cadaa94d0a69e0d"</span></span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取某一个元素</span></span><br><span class="line">$ jq <span class="string">".element"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取数组中的某一个</span></span><br><span class="line">$ jq <span class="string">".element[0]"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新把 JSON 压缩成一行</span></span><br><span class="line">$ jq -c</span><br></pre></td></tr></tbody></table></figure>
<h3 id="jstack"><a href="#jstack" class="headerlink" title="jstack"></a>jstack</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 线程 dump，可以判断进程是否是假死状态</span></span><br><span class="line">$ jstack -m &lt;pid&gt;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="jstat"><a href="#jstat" class="headerlink" title="jstat"></a>jstat</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 查看 Java 进程的 GC 情况</span></span><br><span class="line"><span class="comment"># Usage: jstat -gcutil &lt;pid&gt; &lt;interval_ms&gt;</span></span><br><span class="line">$ jstat -gcutil 24909 1000</span><br><span class="line">    S0     S1     E      O      P       YGC   YGCT     FGC   FGCT     GCT</span><br><span class="line">  40.77   0.00  98.56   6.38  46.86      2    0.147     0    0.000    0.147</span><br><span class="line">  40.77   0.00  98.56   6.38  46.86      2    0.147     0    0.000    0.147</span><br><span class="line">  40.77   0.00  98.56   6.38  46.86      2    0.147     0    0.000    0.147</span><br><span class="line">  40.77   0.00  98.56   6.38  46.86      2    0.147     0    0.000    0.147</span><br><span class="line">  40.77   0.00  98.56   6.38  46.86      2    0.147     0    0.000    0.147</span><br><span class="line">  40.77   0.00  98.56   6.38  46.86      2    0.147     0    0.000    0.147</span><br><span class="line">  40.77   0.00  98.56   6.38  46.86      2    0.147     0    0.000    0.147</span><br><span class="line">  40.77   0.00  98.56   6.38  46.86      2    0.147     0    0.000    0.147</span><br><span class="line">  40.77   0.00  99.16   6.38  46.87      2    0.147     0    0.000    0.147</span><br></pre></td></tr></tbody></table></figure>
<h3 id="lsblk"><a href="#lsblk" class="headerlink" title="lsblk"></a>lsblk</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ lsblk -d -o name,rota</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># rota，全称 rotational，表示磁盘是否可以旋转</span></span><br><span class="line"><span class="comment"># 其中，0 表示不可以旋转，而 1 表示可以旋转</span></span><br><span class="line"><span class="comment"># 前者不可以旋转的说明是 SSD 盘，反之，后者可以旋转则不是 SSD 盘，有可能是 SDA 盘等</span></span><br><span class="line">NAME  ROTA</span><br><span class="line">vda      1</span><br><span class="line">vdb      1</span><br></pre></td></tr></tbody></table></figure>
<h3 id="lsof"><a href="#lsof" class="headerlink" title="lsof"></a>lsof</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 系统级 监控 &amp; 诊断工具</span></span><br><span class="line"><span class="comment"># 指定进程号，可以查看该进程打开的文件</span></span><br><span class="line">$ lsof -p &lt;pid&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 针对打开的文件数，对进程进行排序</span></span><br><span class="line">$ lsof -n | awk <span class="string">'{print $2}'</span> | sort | uniq -c | sort -nr</span><br></pre></td></tr></tbody></table></figure>
<h3 id="nc"><a href="#nc" class="headerlink" title="nc"></a>nc</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 模拟暴露 8080 端口的服务器</span></span><br><span class="line">$ nc -l 8080</span><br><span class="line"></span><br><span class="line"><span class="comment"># 最简聊天室</span></span><br><span class="line"><span class="comment"># Windows1</span></span><br><span class="line">$ nc -l 8080</span><br><span class="line"><span class="comment"># Windows2</span></span><br><span class="line">$ nc localhost 8080</span><br><span class="line"><span class="comment"># 然后，可以在各自的窗口输入信息，另一个窗口就可以接收到</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="nmon"><a href="#nmon" class="headerlink" title="nmon"></a>nmon</h3><h4 id="生成-nmon-文件"><a href="#生成-nmon-文件" class="headerlink" title="生成 nmon 文件"></a>生成 nmon 文件</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 获得帮助文档</span></span><br><span class="line">$ nmon_x86_64_centos6 -h</span><br><span class="line"></span><br><span class="line"><span class="comment"># 不同的操作系统，可能 nmon 命令不一样</span></span><br><span class="line"><span class="comment"># -f 使得 xxx.nmon 文件名包含文件创建的时间</span></span><br><span class="line"><span class="comment"># -N 指定需要对 NFS 活动情况进行监控</span></span><br><span class="line"><span class="comment"># -m 指定生成的 xxx.nmon 存放的目录</span></span><br><span class="line"><span class="comment"># -s 指定相隔多少秒，做一次监控</span></span><br><span class="line"><span class="comment"># -c 指定采集多少次监控数据，生成一个 xxx.nmon 文件</span></span><br><span class="line">$ /nmon/nmon_x86_64_rhel6 -f -N -m /nmon -s 60 -c 1440</span><br><span class="line">$ /nmon/nmon_x86_64_centos6 -f -N -m /nmon -s 60 -c 1440</span><br><span class="line"></span><br><span class="line"><span class="comment"># 转换 .nmon 文件为 .csv 文件</span></span><br><span class="line">$ sort yuzhouwan-prd3_170831_0001.nmon &gt; yuzhouwan-prd3_170831_0001.csv</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看监控数据</span></span><br><span class="line"><span class="comment"># 在 https://www.ibm.com/developerworks/community/wikis/home?lang=en#!/wiki/Power%20Systems/page/nmon_analyser 页面，下载 nmon analyser v52_1.xlsm 文件</span></span><br><span class="line"><span class="comment"># 打开后，会提示“启用宏定义”，点击确定</span></span><br><span class="line"><span class="comment"># 一共会有 Analyser / Settings / Release Notes 三个 sheet，跳转到第一个 Analyser 里</span></span><br><span class="line"><span class="comment"># 点击 “Analyze nmon data” 按钮，选择 yuzhouwan-prd3_170831_0001.csv 文件</span></span><br><span class="line"><span class="comment"># 会生成一个 yuzhouwan-prd3_170831_0001.nmon.xlsx，并直接打开</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="系统资源实时监控"><a href="#系统资源实时监控" class="headerlink" title="系统资源实时监控"></a>系统资源实时监控</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ /nmon/nmon_x86_64_centos6</span><br><span class="line">  <span class="comment"># 常用组合：nml</span></span><br><span class="line">  lnmonq14g-------------------Hostname=yuzhouwan-prd3-Refresh= 2secs ---11:04.35-----------|</span><br><span class="line">  | CPU +-------------------------------------------------------------------------+        |</span><br><span class="line">  |100%-|                                           |                                      |</span><br><span class="line">  | 95%-|                                           |                                      | <span class="comment"># 为方便展示，此处省去 25% ~ 90%</span></span><br><span class="line">  | 20%-|                                           |                                      |</span><br><span class="line">  | 15%-|                                           |                                      |</span><br><span class="line">  | 10%-|              ss                           |                                      |</span><br><span class="line">  |  5%-|UUUUsUUUUsUUsUUUUwUUssUssUUssUUUsUUsUUUUUsU|                                      |</span><br><span class="line">  |     +--------------------User---------System----+----Wait---------------------+        |</span><br><span class="line">  | Memory Stats --------------------------------------------------------------------------|</span><br><span class="line">  |                RAM     High       Low     Swap    Page Size=4 KB                       |</span><br><span class="line">  | Total MB    129013.3     -0.0     -0.0  10240.0                                        |</span><br><span class="line">  | Free  MB     584.1     -0.0     -0.0  10240.0                                          |</span><br><span class="line">  | Free Percent     0.5%   100.0%   100.0%   100.0%                                       |</span><br><span class="line">  |             MB                  MB                  MB                                 |</span><br><span class="line">  |                      Cached= 76656.7     Active= 54649.3                               |</span><br><span class="line">  | Buffers=  4908.1 Swapcached=     0.0  Inactive = 68809.5                               |</span><br><span class="line">  | Dirty  =   131.6 Writeback =     0.0  Mapped   =    75.1                               |</span><br><span class="line">  | Slab   =  4059.3 Commit_AS = 47663.8 PageTables=    96.6                               |</span><br><span class="line">  | Network I/O ---------------------------------------------------------------------------|</span><br><span class="line">  |I/F Name Recv=KB/s Trans=KB/s packin packout insize outsize Peak-&gt;Recv Trans            |</span><br><span class="line">  |      lo  1044.0  1044.0     335.5    335.5  3186.8 3186.8     8639.4  8639.4           |</span><br><span class="line">  |    eth0  5262.7  1168.7    5999.0   2762.1   898.3  433.3    10531.6 43312.1           |</span><br><span class="line">  |    eth1     0.0     0.0    0.0     0.0     0.0    0.0        0.0     0.0               |</span><br><span class="line">  |---------Warning: Some Statistics may not shown-----------------------------------------|</span><br></pre></td></tr></tbody></table></figure>
<h3 id="nohup"><a href="#nohup" class="headerlink" title="nohup"></a>nohup</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 启动一个后台进程</span></span><br><span class="line">$ nohup sleep 1000 &amp;</span><br><span class="line">  [1] 30408</span><br><span class="line"><span class="comment"># 列出所有的后台进程</span></span><br><span class="line">$ <span class="built_in">jobs</span></span><br><span class="line">  [1]+  Running                 nohup sleep 1000 &amp;</span><br><span class="line"><span class="comment"># 将后台进程 [1] 提到前台，并 Ctrl+C 停止进程</span></span><br><span class="line">$ <span class="built_in">fg</span> %1</span><br><span class="line">  nohup sleep 1000</span><br><span class="line"><span class="comment"># 检查后台进程已经被停止</span></span><br><span class="line">$ <span class="built_in">jobs</span></span><br><span class="line"><span class="comment"># 不输出任何内容</span></span><br><span class="line">$ nohup bash yuzhouwan.sh &gt;/dev/null 2&gt;&amp;1 &amp;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="make"><a href="#make" class="headerlink" title="make"></a>make</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ make -j&lt;thread_num&gt;</span><br><span class="line"><span class="comment"># 查看 CPU 核数</span></span><br><span class="line">$ cat /proc/cpuinfo | grep processor | wc -l</span><br><span class="line"><span class="comment"># 如果是两个处理器的话，一般 `-j2` 可以达到最高效率（某些进程主要耗时是在 I/O 上，并不能充分利用单个 cpu 的时间，则可以考虑 -j4）</span></span><br><span class="line"><span class="comment"># 一般的，使用 `thread_num = number_of_cores + 1` 公式来计算即可</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="locale"><a href="#locale" class="headerlink" title="locale"></a>locale</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ locale </span><br><span class="line">  LANG=en_US.UTF-8                    <span class="comment"># 未设置任何 LC_xxx 变量时所使用的默认值</span></span><br><span class="line">  LC_CTYPE=zh_CN.UTF-8                <span class="comment"># 指定使用某区域的字符分类及处理方式</span></span><br><span class="line">  LC_NUMERIC=<span class="string">"en_US.UTF-8"</span>            <span class="comment"># 指定使用某区域的非货币的数字格式</span></span><br><span class="line">  LC_TIME=<span class="string">"en_US.UTF-8"</span>               <span class="comment"># 指定使用某区域的日期和时间格式</span></span><br><span class="line">  LC_COLLATE=<span class="string">"en_US.UTF-8"</span>            <span class="comment"># 指定使用某区域的排序规则</span></span><br><span class="line">  LC_MONETARY=<span class="string">"en_US.UTF-8"</span>           <span class="comment"># 指定使用某区域的货币格式</span></span><br><span class="line">  LC_MESSAGES=<span class="string">"en_US.UTF-8"</span>           <span class="comment"># 指定使用某区域的响应与信息的格式</span></span><br><span class="line">  LC_PAPER=<span class="string">"en_US.UTF-8"</span>              <span class="comment"># 指定使用某区域的纸张大小</span></span><br><span class="line">  LC_NAME=<span class="string">"en_US.UTF-8"</span>               <span class="comment"># 指定使用某区域的姓名书写方式</span></span><br><span class="line">  LC_ADDRESS=<span class="string">"en_US.UTF-8"</span>            <span class="comment"># 指定使用某区域的地址格式和位置信息</span></span><br><span class="line">  LC_TELEPHONE=<span class="string">"en_US.UTF-8"</span>          <span class="comment"># 指定使用某区域的电话号码格式</span></span><br><span class="line">  LC_MEASUREMENT=<span class="string">"en_US.UTF-8"</span>        <span class="comment"># 指定使用某区域的度量衡规则</span></span><br><span class="line">  LC_IDENTIFICATION=<span class="string">"en_US.UTF-8"</span>     <span class="comment"># 对 locale 自身信息的概述</span></span><br><span class="line">  LC_ALL=                             <span class="comment"># 用来覆盖掉所有其他 LC_xxx 变量的值</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="tar"><a href="#tar" class="headerlink" title="tar"></a>tar</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 压缩</span></span><br><span class="line">$ tar zcvf gc.tar.gz gc</span><br><span class="line"><span class="comment"># 解压</span></span><br><span class="line">$ tar zxvf gc.tar.gz</span><br></pre></td></tr></tbody></table></figure>
<h3 id="top"><a href="#top" class="headerlink" title="top"></a>top</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 在 top 展示页面中</span></span><br><span class="line"><span class="comment"># 按 CPU 排序：Shift + P</span></span><br><span class="line"><span class="comment"># 按内存排序：Shift + M</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看进程内，各线程的资源消耗</span></span><br><span class="line">$ top -Hp &lt;pid&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进一步，可以根据线程 pid 在 jstack 中定位出对应的线程栈</span></span><br><span class="line"><span class="comment"># 拿到 thread_pid 对应的 16 进制数</span></span><br><span class="line">$ <span class="built_in">printf</span> <span class="string">'%x\n'</span> &lt;thread_pid&gt;</span><br><span class="line">$ jstack &lt;pid&gt; | less</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 batch 模式（-b），并控制命令执行迭代次数为 1 次（-n），达到生成一次 CPU 使用情况的快照</span></span><br><span class="line">$ top -b -n 1</span><br></pre></td></tr></tbody></table></figure>
<h3 id="tree"><a href="#tree" class="headerlink" title="tree"></a>tree</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ yum install tree -y</span><br><span class="line">$ tree -L 1 /</span><br><span class="line">  /</span><br><span class="line">  ├── bin</span><br><span class="line">  ├── usr</span><br><span class="line">  └── var</span><br></pre></td></tr></tbody></table></figure>
<h3 id="rpm"><a href="#rpm" class="headerlink" title="rpm"></a>rpm</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ rpm -i --badreloc --relocate /usr/java=/home/eagle/software/java jdk-7u80-linux-x64.rpm</span><br></pre></td></tr></tbody></table></figure>
<h3 id="rsync"><a href="#rsync" class="headerlink" title="rsync"></a><a href="https://en.wikipedia.org/wiki/Rolling_hash">rsync</a></h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 软链接、隐藏文件等特殊文件的复制，需要用 `rsync` 命令而不能用 `scp`</span></span><br><span class="line">$ rsync -avuz -e ssh eagle/ root@eagle:/home/eagle</span><br></pre></td></tr></tbody></table></figure>
<h3 id="sed"><a href="#sed" class="headerlink" title="sed"></a>sed</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 直接修改文件</span></span><br><span class="line">$ sed -<span class="keyword">in</span>-place -e <span class="string">'s/blog/yuzhouwan.com/g'</span> yuzhouwan.json</span><br></pre></td></tr></tbody></table></figure>
<h3 id="scp"><a href="#scp" class="headerlink" title="scp"></a>scp</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 后台运行 scp 传输任务</span></span><br><span class="line">$ scp yuzhouwan root@192.168.1.1:/</span><br><span class="line">  root@192.168.1.1<span class="string">'s password: </span></span><br><span class="line"><span class="string">  yuzhouwan  0%   11MB   1.3MB/s 5:24:10 ETA^Z</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Ctrl+Z 暂停 scp 任务</span></span><br><span class="line"><span class="string">  [1]+  Stopped    scp yuzhouwan root@192.168.1.1:/</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 查看任务已经被暂停</span></span><br><span class="line"><span class="string">$ jobs</span></span><br><span class="line"><span class="string">  [1]+  Stopped    scp yuzhouwan root@192.168.1.1:/</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 使得其在后台恢复运行</span></span><br><span class="line"><span class="string">$ bg %1</span></span><br><span class="line"><span class="string">  [1]+ scp yuzhouwan root@192.168.1.1:/ &amp;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 已恢复运行</span></span><br><span class="line"><span class="string">$ jobs</span></span><br><span class="line"><span class="string">  [1]+  Running    scp yuzhouwan root@192.168.1.1:/ &amp;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 忽略 HUP 信号（终端断线的中断信号）</span></span><br><span class="line"><span class="string">$ disown -h %1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 退出</span></span><br><span class="line"><span class="string">$ exit</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 重新登录后，查看 scp 后台任务是否正常运行</span></span><br><span class="line"><span class="string">$ ps -ef | grep scp</span></span><br><span class="line"><span class="string">  root  6189     1  0 18:04 ?        00:00:00 scp yuzhouwan root@192.168.1.1:/</span></span><br><span class="line"><span class="string">  root  6190  6189  0 18:04 ?        00:00:00 /usr/bin/ssh -x -oForwardAgent=no -oPermitLocalCommand=no -oClearAllForwardings=yes -l root -- 192.168.1.1 scp -t /</span></span><br><span class="line"><span class="string">  root  7723  7643  0 18:05 pts/3    00:00:00 grep --color=auto scp</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="split"><a href="#split" class="headerlink" title="split"></a>split</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 写入三行数据</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">"1"</span> &gt;&gt; yuzhouwan</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">"2"</span> &gt;&gt; yuzhouwan</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">"3"</span> &gt;&gt; yuzhouwan</span><br><span class="line">$ cat yuzhouwan</span><br><span class="line">  1</span><br><span class="line">  2</span><br><span class="line">  3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按照数据行数切分</span></span><br><span class="line">$ split -l 1 yuzhouwan tmp_</span><br><span class="line"><span class="comment"># 按照数据大小切分</span></span><br><span class="line"><span class="comment"># 默认不指定单位是 B，支持 K, M, G, T, P, E, Z, Y</span></span><br><span class="line">$ split -b 2 yuzhouwan tmp_</span><br><span class="line"></span><br><span class="line"><span class="comment"># 成功切分</span></span><br><span class="line">$ ll tmp_*</span><br><span class="line">-rw-r--r-- 1 root root 2 Aug  2 19:35 tmp_aa</span><br><span class="line">-rw-r--r-- 1 root root 2 Aug  2 19:35 tmp_ab</span><br><span class="line">-rw-r--r-- 1 root root 2 Aug  2 19:35 tmp_ac</span><br><span class="line"></span><br><span class="line"><span class="comment"># 两种切分方式，得到的结果应该是一样的</span></span><br><span class="line">$ cat tmp_aa</span><br><span class="line">  1</span><br><span class="line">$ cat tmp_ab</span><br><span class="line">  2</span><br><span class="line">$ cat tmp_ac</span><br><span class="line">  3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 合并为新文件</span></span><br><span class="line">$ cat tmp_* &gt; yuzhouwan_new</span><br><span class="line">$ cat yuzhouwan_new</span><br><span class="line">  1</span><br><span class="line">  2</span><br><span class="line">  3</span><br></pre></td></tr></tbody></table></figure>
<h3 id="ssh"><a href="#ssh" class="headerlink" title="ssh"></a>ssh</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 登录远程机器，执行命令</span></span><br><span class="line">$ ssh bj@192.168.1.101 <span class="string">"df -h"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用逗号分隔多个执行命令</span></span><br><span class="line">$ ssh bj@192.168.1.101 <span class="string">"pwd; ls"</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="sz"><a href="#sz" class="headerlink" title="sz"></a>sz</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line">$ yum install lrzsz -y</span><br><span class="line"><span class="comment"># 将服务器上文件，拉取到本机</span></span><br><span class="line">$ sz &lt;file name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果下载出现乱码，可以增加 `-e` 参数，同理 `rz` 也可以通过这个参数来解决乱码问题</span></span><br><span class="line">-e, --escape</span><br><span class="line">  Force sender to escape all control characters; normally XON, XOFF, DLE, CR-@-CR, and Ctrl-X are escaped.</span><br></pre></td></tr></tbody></table></figure>
<h3 id="ping"><a href="#ping" class="headerlink" title="ping"></a>ping</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 如果遇到 ZooKeeper 报警网络延迟，不能只看延迟，还需要关注丢包率（packet loss）</span></span><br><span class="line"><span class="comment"># 如果出现网络丢包率过高，可能是交换机的负载过大，接口松动，或者是网线质量问题</span></span><br><span class="line">$ ping yuzhouwan01</span><br><span class="line">  PING yuzhouwan01.com (192.168.1.101) 56(84) bytes of data.</span><br><span class="line">  64 bytes from yuzhouwan01.com (192.168.1.101): icmp_seq=1 ttl=64 time=0.055 ms</span><br><span class="line">  64 bytes from yuzhouwan01.com (192.168.1.101): icmp_seq=2 ttl=64 time=0.066 ms</span><br><span class="line">  64 bytes from yuzhouwan01.com (192.168.1.101): icmp_seq=3 ttl=64 time=0.064 ms</span><br><span class="line">  64 bytes from yuzhouwan01.com (192.168.1.101): icmp_seq=4 ttl=64 time=0.083 ms</span><br><span class="line">  ^C</span><br><span class="line">  --- yuzhouwan01.com ping statistics ---</span><br><span class="line">  4 packets transmitted, 4 received, 0% packet loss, time 3443ms</span><br><span class="line">  rtt min/avg/max/mdev = 0.055/0.067/0.083/0.010 ms</span><br><span class="line"></span><br><span class="line"><span class="comment"># 控制 ping 的次数 和 timeout 时间（单位：秒）</span></span><br><span class="line">$ ping -c 4 yuzhouwan01 -W 5</span><br></pre></td></tr></tbody></table></figure>
<h3 id="ps"><a href="#ps" class="headerlink" title="ps"></a>ps</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 查看进程的 “启动时间” 和 “已运行时长”</span></span><br><span class="line">$ ps -eo pid,lstart,etime | grep &lt;pid&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看进程分配内存大小</span></span><br><span class="line"><span class="comment"># RSS（Resident Set Size）常驻内存集，表示该进程分配的内存大小</span></span><br><span class="line">$ ps -e -o pid,rss</span><br></pre></td></tr></tbody></table></figure>
<h3 id="ulimit"><a href="#ulimit" class="headerlink" title="ulimit"></a>ulimit</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 当进程报错 `java.io.IOException: Too many open files` 时，可以检查是不是没有修改默认的打开文件数（1024）</span></span><br><span class="line">$ <span class="built_in">ulimit</span> -n</span><br><span class="line">  1024</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以通过下面这行命令进行修改</span></span><br><span class="line">$ <span class="built_in">ulimit</span> -HSn 4096</span><br><span class="line"></span><br><span class="line"><span class="comment"># 想要重启系统后，保证修改仍然生效，则可以把上面的命令，添加到 ~/.bash_profile 或者 /etc/profile</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="uname"><a href="#uname" class="headerlink" title="uname"></a>uname</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ uname -a</span><br><span class="line">  Linux yuzhouwan 2.6.32-504.3.3.el6.centos.plus.x86_64 <span class="comment">#1 SMP Wed Dec 17 01:21:03 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># kernel version</span></span><br><span class="line">$ uname -r</span><br><span class="line">  2.6.32-504.3.3.el6.centos.plus.x86_64</span><br><span class="line"></span><br><span class="line"><span class="comment"># 具体含义：&lt;内核主版本&gt;.&lt;偶数:稳定版本/奇数:开发中版本&gt;.&lt;错误修补的次数&gt;-&lt;?&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="umask"><a href="#umask" class="headerlink" title="umask"></a>umask</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># umask 全称 user file-creatiopn mode mask，用来控制用户权限的</span></span><br><span class="line"><span class="comment"># 查看 umask</span></span><br><span class="line">$ <span class="built_in">umask</span></span><br><span class="line">  0022</span><br><span class="line">$ <span class="built_in">umask</span> -S</span><br><span class="line">  u=rwx,g=rx,o=rx</span><br><span class="line"><span class="comment"># 修改 umask</span></span><br><span class="line">$ <span class="built_in">umask</span> 0022</span><br><span class="line"><span class="comment"># 存在 umask 之后，会减少用户的 umask 权限（例如，0777 - 0022 = 0755）</span></span><br><span class="line"><span class="comment"># 所以，部署安装包的时候，如果 *.sh / *.py 脚本的执行权限分配不足的话，同时 umask 设置较大时，解压安装包后，会出现文件执行权限不足的情况</span></span><br><span class="line"><span class="comment"># 这时候，需要考虑分配适当的文件和文件夹权限</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="vim"><a href="#vim" class="headerlink" title="vim"></a>vim</h3><h4 id="按照单词跳转"><a href="#按照单词跳转" class="headerlink" title="按照单词跳转"></a>按照单词跳转</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># w       跳到下一个单词的开头</span></span><br><span class="line"><span class="comment"># get     跳到上一个单词的开头</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="撤销"><a href="#撤销" class="headerlink" title="撤销"></a>撤销</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># u       撤销上一步的操作</span></span><br><span class="line"><span class="comment"># U       恢复当前行（即一次撤销对当前行的全部操作）</span></span><br><span class="line"><span class="comment"># Ctrl+r  恢复上一步被撤销的操作</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="翻页"><a href="#翻页" class="headerlink" title="翻页"></a>翻页</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Ctrl+U   向上翻半页</span></span><br><span class="line"><span class="comment"># Ctrl+D   向下翻半页</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="退出并保存"><a href="#退出并保存" class="headerlink" title="退出并保存"></a>退出并保存</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># esc + ZZ   （esc 是确保 vim 已经退出了编辑模式）</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="wget"><a href="#wget" class="headerlink" title="wget"></a>wget</h3><h4 id="从-ftp-服务器下载文件"><a href="#从-ftp-服务器下载文件" class="headerlink" title="从 ftp 服务器下载文件"></a>从 ftp 服务器下载文件</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ wget -nd -m --ftp-user=&lt;user&gt; --ftp-password=&lt;password&gt; ftp://&lt;ftp_server&gt;/zookeeper/zookeeper-3.4.6.4.tar.gz</span><br></pre></td></tr></tbody></table></figure>
<h4 id="输出到控制台"><a href="#输出到控制台" class="headerlink" title="输出到控制台"></a>输出到控制台</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># -q：quiet 模式，屏蔽 request header 信息的回显</span></span><br><span class="line"><span class="comment"># -O：指定输出文件，后面加 - 横杠，就定向为 console</span></span><br><span class="line">$ wget -q -O- &lt;url&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 简写</span></span><br><span class="line">$ wget -qO- &lt;url&gt;</span><br></pre></td></tr></tbody></table></figure>
<p>Tips: 另外还有一个好处，wget 可以实现跳转。以 <a href="https://yuzhouwan.com/posts/5845/">Apache Druid</a> 为例，用 <code>curl 命令去访问 http://standby-overlord:8090/druid/indexer/v1/runningTasks</code> 会因为 overlord 是 standby 结点，导致调用接口失败。而如果用 wget 命令则可以自动跳转到 active 结点，同时再配合使用 <code>-qO-</code> 命令，就能达到和 <code>curl</code> 命令一样，将接口调用结果直接输出到控制台的效果（当然 <code>curl -L</code> 也可以实现）</p>
<h3 id="xargs"><a href="#xargs" class="headerlink" title="xargs"></a>xargs</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 获取 Java 进程的 PID，并使用 jstat 命令观察 GC 情况</span></span><br><span class="line">$ jps -ml | grep yuzhouwan | awk <span class="string">'{print $1}'</span> | xargs -i jstat -gcutil {} 1000</span><br></pre></td></tr></tbody></table></figure>
<h3 id="标准-I-O"><a href="#标准-I-O" class="headerlink" title="标准 I/O"></a>标准 I/O</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 只输出 “脚本执行异常信息”</span></span><br><span class="line">$ ./commands.sh 1&gt;/dev/null 2&gt;./error.log</span><br><span class="line"><span class="comment"># 完全不作输出</span></span><br><span class="line">$ ./commands.sh 1&gt;/dev/null 2&gt;&amp;1</span><br></pre></td></tr></tbody></table></figure>
<h2 id="Shell-编程"><a href="#Shell-编程" class="headerlink" title="Shell 编程"></a>Shell 编程</h2><h3 id="bashrc"><a href="#bashrc" class="headerlink" title=".bashrc"></a>.bashrc</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 在执行脚本开始的时候，载入环境变量</span></span><br><span class="line"><span class="built_in">source</span> ~/.bash_profile</span><br></pre></td></tr></tbody></table></figure>
<h3 id="dirname"><a href="#dirname" class="headerlink" title="dirname"></a>dirname</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 跳转到，当前脚本的文件目录</span></span><br><span class="line"><span class="built_in">cd</span> `dirname <span class="variable">$0</span>`</span><br></pre></td></tr></tbody></table></figure>
<h3 id="cut-string"><a href="#cut-string" class="headerlink" title="cut string"></a>cut string</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 将 string 的前后各删除一个字符</span></span><br><span class="line">arr=<span class="string">"[leader, election, zookeeper]"</span></span><br><span class="line">arr=`<span class="built_in">echo</span> <span class="variable">${arr:1:${#arr}</span>-2}`    <span class="comment"># leader, election, zookeeper</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="command"><a href="#command" class="headerlink" title="command"></a>command</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 通过 `command` 命令，可以在脚本开始执行前，对需要的命令进行 check</span></span><br><span class="line"><span class="built_in">command</span> -v nc &gt;/dev/null 2&gt;&amp;1 || {</span><br><span class="line">    <span class="built_in">echo</span> &gt;&amp;2 <span class="string">"I require nc but it's not installed!"</span>; <span class="built_in">exit</span> 1;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="for-loop"><a href="#for-loop" class="headerlink" title="for loop"></a>for loop</h3><h4 id="遍历文件"><a href="#遍历文件" class="headerlink" title="遍历文件"></a>遍历文件</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> `cat yuzhouwan.txt`; <span class="keyword">do</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="variable">$line</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="进阶用法"><a href="#进阶用法" class="headerlink" title="进阶用法"></a>进阶用法</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">arr=<span class="string">"leader, election, zookeeper"</span></span><br><span class="line">OLD_IFS=<span class="string">"<span class="variable">$IFS</span>"</span></span><br><span class="line">IFS=$<span class="string">", "</span></span><br><span class="line">arr=(<span class="variable">${arr}</span>)</span><br><span class="line"><span class="keyword">for</span> a <span class="keyword">in</span> <span class="variable">${arr[@]}</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">${a}</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">IFS=<span class="string">"<span class="variable">$OLD_IFS</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置 IFS，前文 "实战技巧 - IFS 设置" 部分已经提到了</span></span><br><span class="line"><span class="comment"># 下面介绍一种 `fori` 的遍历方式</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 0	/election</span></span><br><span class="line"><span class="comment"># 0	/leader</span></span><br><span class="line"><span class="comment"># 2	/zookeeper</span></span><br><span class="line">sorted_num=`<span class="built_in">echo</span> <span class="variable">${sorted}</span> | wc -l`</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">${sorted_num}</span> -gt <span class="variable">${top_n}</span> ]; <span class="keyword">then</span></span><br><span class="line">    sorted_num=<span class="variable">${top_n}</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">json=<span class="string">"{"</span></span><br><span class="line"><span class="keyword">for</span> (( i=1; i&lt;=<span class="variable">${sorted_num}</span>; i++ )); <span class="keyword">do</span></span><br><span class="line">    line=`<span class="built_in">echo</span> <span class="string">"<span class="variable">${sorted}</span>"</span> | sed -n <span class="string">"<span class="variable">${i}</span> p"</span>`</span><br><span class="line">    json=<span class="string">"<span class="variable">${json}</span>`echo <span class="variable">${line}</span> | awk '{print <span class="variable">$1</span>}'`: `echo <span class="variable">${line}</span> | awk '{print <span class="variable">$2</span>}'`"</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">${i}</span> -lt <span class="variable">${sorted_num}</span> ]; <span class="keyword">then</span></span><br><span class="line">        json=<span class="string">"<span class="variable">${json}</span>, "</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">json=<span class="string">"<span class="variable">${json}</span>}"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 当然，也有其他的实现方法，比如下面 `seq` 这种</span></span><br><span class="line"><span class="comment"># 但是，`seq` 这种方式需要注意两点</span></span><br><span class="line"><span class="comment"># 第一点，$(seq 1 1 10) 里面的 初始值、步长、最大值 都必须要是 Integer 类型的，如果是通过 shell 外部传参进来的，需要做类型转换</span></span><br><span class="line"><span class="comment"># 第二点，`seq` 方式在 console 里面执行没问题，但是，写在 shell 脚本里面，可能会失效（原因尚不明确）</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq 1 2 10); <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">"skip by 2 step, value is <span class="variable">$i</span>"</span>; <span class="keyword">done</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="function"><a href="#function" class="headerlink" title="function"></a>function</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 定义函数的时候，不需要表示入参，直接用 $1 / $2 获取入参的值</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">f</span></span>() {</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$1</span>.<span class="variable">$2</span>"</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment"># 函数定义需要在调用逻辑之前</span></span><br><span class="line"><span class="comment"># 多个入参，依次空格隔开传入，即可</span></span><br><span class="line">f <span class="string">"yuzhouwan"</span> <span class="string">"com"</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="if"><a href="#if" class="headerlink" title="if"></a>if</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 判断字符串是否一致</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">${context}</span>_x == <span class="string">"_x"</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"OK"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 数值比较大小(这种写法还支持浮点数，而 `lt` / `gt` 的写法则不行)</span></span><br><span class="line"><span class="keyword">if</span> [[ $(<span class="built_in">echo</span> <span class="string">"<span class="variable">${origin_cost_time}</span> &gt;= <span class="variable">${compact_cost_time}</span>"</span>|bc) -eq 1 ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"True"</span> &gt;&gt; time.txt</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"False"</span> &gt;&gt; time.txt</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="paste"><a href="#paste" class="headerlink" title="paste"></a>paste</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 针对某一列进行 sum 求和</span></span><br><span class="line">$ cat c | awk <span class="string">'{print $1}'</span>  | paste -sd+ - | bc</span><br><span class="line">  160</span><br></pre></td></tr></tbody></table></figure>
<h3 id="readlink"><a href="#readlink" class="headerlink" title="readlink"></a>readlink</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 获取到文件</span></span><br><span class="line">$ readlink -f logs/zookeeper.log</span><br><span class="line">  /home/zookeeper/logs/zookeeper.log</span><br></pre></td></tr></tbody></table></figure>
<h3 id="sed-1"><a href="#sed-1" class="headerlink" title="sed"></a>sed</h3><h4 id="替换"><a href="#替换" class="headerlink" title="替换"></a>替换</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 先后从 zk_con 里面，将 ":" 冒号后面 和 "/" 斜线之前的都删掉</span></span><br><span class="line">zk_con=<span class="string">" /192.168.1.1:35632[1](queued=0,recved=146,sent=146,sid=0x25dd0c02a0a02a7,lop=PING,est=1503994626336,to=40000,lcxid=0x0,lzxid=0xffffffffffffffff,lresp=1503996561355,llat=0,minlat=0,avglat=0,maxlat=3)"</span></span><br><span class="line">zk_con=`<span class="built_in">echo</span> <span class="variable">$zk_con</span> | sed <span class="string">'s/:.*//g'</span> | sed <span class="string">'s/.*\///g'</span>`    <span class="comment"># 192.168.1.1</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="删除匹配行"><a href="#删除匹配行" class="headerlink" title="删除匹配行"></a>删除匹配行</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 从 txt 文件中，删除包含 yuzhouwan 字符串的行</span></span><br><span class="line">$ sed -e <span class="string">'/yuzhouwan/d'</span> txt</span><br></pre></td></tr></tbody></table></figure>
<h4 id="删除空白行"><a href="#删除空白行" class="headerlink" title="删除空白行"></a>删除空白行</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 删除没有任何字符的行</span></span><br><span class="line">$ sed -i <span class="string">'s/^$//g'</span> <span class="built_in">log</span></span><br><span class="line"><span class="comment"># 删除只有空格的行</span></span><br><span class="line">$ sed -i <span class="string">'/^\s*$/d'</span> <span class="built_in">log</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="sort"><a href="#sort" class="headerlink" title="sort"></a>sort</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 通过 `-k1` 指定 针对第一列进行排序</span></span><br><span class="line"><span class="comment"># 通过 `-n` 指定 针对数字进行排序，避免 9 排在了 10 前面</span></span><br><span class="line"><span class="comment"># 当然也可以通过增加 `-r`，使得排序变成降序</span></span><br><span class="line"><span class="comment"># 如果，列与列之间的分隔符不是默认的 \t，则需要通过 `-t` 参数进行指定</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 0	/election</span></span><br><span class="line"><span class="comment"># 0	/leader</span></span><br><span class="line"><span class="comment"># 2	/zookeeper</span></span><br><span class="line">sorted=`<span class="built_in">echo</span> <span class="variable">${result}</span> | sort -k1 -n`</span><br></pre></td></tr></tbody></table></figure>
<h3 id="uniq"><a href="#uniq" class="headerlink" title="uniq"></a>uniq</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 计数</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"1\n1\n0"</span> | uniq -c</span><br><span class="line"><span class="comment"># 2 1</span></span><br><span class="line"><span class="comment"># 1 0</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="exit-0"><a href="#exit-0" class="headerlink" title="exit 0"></a>exit 0</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 养成一个，脚本结尾，添加 `exit 0` 的好习惯</span></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></tbody></table></figure>
<h2 id="实用技巧"><a href="#实用技巧" class="headerlink" title="实用技巧"></a>实用技巧</h2><h3 id="IFS-设置"><a href="#IFS-设置" class="headerlink" title="IFS 设置"></a>IFS 设置</h3><p>　Shell 脚本中 IFS 变量全称 <strong>I</strong>nternal <strong>F</strong>ield <strong>S</strong>eprator，内部域分隔符</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="variable">$IFS</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">"<span class="variable">$IFS</span>"</span> | od -b</span><br><span class="line">  0000000 040 011 012 012</span><br><span class="line">  0000004</span><br><span class="line"></span><br><span class="line"><span class="comment"># 遍历多行文本之前，设置 IFS 为 \n</span></span><br><span class="line">pids=`ps -ef | grep <span class="string">"<span class="variable">${PROCESS_NAME}</span>"</span> | grep -v grep | grep -v <span class="string">"<span class="variable">${SELF_NAME}</span>"</span> | awk <span class="string">'{print $2}'</span>`</span><br><span class="line">IFS=$<span class="string">'\n'</span> <span class="built_in">read</span> -rd <span class="string">''</span> -a pids &lt;&lt;&lt;<span class="string">"<span class="variable">$pids</span>"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"pids: <span class="variable">${pids}</span>"</span></span><br><span class="line"><span class="keyword">for</span> pid <span class="keyword">in</span> <span class="string">"<span class="variable">${pids}</span>"</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"kill -9 <span class="variable">${pid}</span>"</span></span><br><span class="line">    <span class="built_in">kill</span> -9 <span class="string">"<span class="variable">${pid}</span>"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="每秒执行一次"><a href="#每秒执行一次" class="headerlink" title="每秒执行一次"></a>每秒执行一次</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span> sleep 1; &lt;<span class="built_in">command</span>&gt;; <span class="keyword">done</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="自启动"><a href="#自启动" class="headerlink" title="自启动"></a>自启动</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 以 OpenTSDB 为例</span></span><br><span class="line">$ vim keep_alive.sh</span><br><span class="line">  <span class="comment">#!/usr/bin/env bash</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span></span><br><span class="line">      process_num=`ps -ef | grep -v grep | grep opentsdb | wc -l`</span><br><span class="line">      <span class="built_in">echo</span> <span class="variable">${process_num}</span></span><br><span class="line">      <span class="keyword">if</span> [[ <span class="variable">${process_num}</span> -gt 0 ]]; <span class="keyword">then</span></span><br><span class="line">          <span class="built_in">echo</span> <span class="string">"health"</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">          <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/opentsdb</span><br><span class="line">          nohup ./build/tsdb tsd &gt;/dev/null 2&gt;&amp;1 &amp;</span><br><span class="line">      <span class="keyword">fi</span></span><br><span class="line">      sleep 10;</span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">$ nohup sh keep_alive.sh &gt;/dev/null 2&gt;&amp;1 &amp;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="获得当前机器的资源使用情况"><a href="#获得当前机器的资源使用情况" class="headerlink" title="获得当前机器的资源使用情况"></a>获得当前机器的资源使用情况</h3><h4 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">idle_cpu_percent=`top -b -n 1 | grep Cpu | awk <span class="string">'{print $5}'</span> | cut -f 1 -d <span class="string">"."</span>`</span><br><span class="line">used_cpu_percent=$(<span class="built_in">echo</span> <span class="string">"100-<span class="variable">${idle_cpu_percent}</span>"</span> | bc)</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Memory"><a href="#Memory" class="headerlink" title="Memory"></a>Memory</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">free_m=`free -m`</span><br><span class="line">free_m_detail=`<span class="built_in">echo</span> <span class="variable">${free_m}</span> | sed <span class="string">'s/.*Mem://g'</span> | sed <span class="string">'s/-\/+.*//g'</span>`</span><br><span class="line">total_mem=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">${free_m_detail}</span>"</span> | awk <span class="string">'{print $1}'</span>)</span><br><span class="line">used_mem=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">${free_m_detail}</span>"</span> | awk <span class="string">'{print $2}'</span>)</span><br><span class="line">used_mem_percent=$[<span class="variable">${used_mem}</span> * 100 / <span class="variable">${total_mem}</span>]</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Disk"><a href="#Disk" class="headerlink" title="Disk"></a>Disk</h4><h5 id="空间使用率"><a href="#空间使用率" class="headerlink" title="空间使用率"></a>空间使用率</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">used_disk_percent=`df -P | grep <span class="string">"home"</span> | awk <span class="string">'{print $5}'</span>`</span><br></pre></td></tr></tbody></table></figure>
<h5 id="I-O-使用率"><a href="#I-O-使用率" class="headerlink" title="I/O 使用率"></a>I/O 使用率</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">virtual_device=`df -h | grep <span class="string">"home"</span> | awk <span class="string">'{print $1}'</span> | cut -f 4 -d <span class="string">'/'</span>`</span><br><span class="line">device=`ls -trl /dev/mapper/ | grep <span class="variable">${virtual_device}</span> | sed <span class="string">'s/.*\///g'</span>`</span><br><span class="line">device_io=`iostat -x 1 1 | grep <span class="variable">${device}</span> | awk <span class="string">'{print $12}'</span>`</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Network"><a href="#Network" class="headerlink" title="Network"></a>Network</h4><h5 id="获得当前机器的-IP"><a href="#获得当前机器的-IP" class="headerlink" title="获得当前机器的 IP"></a>获得当前机器的 IP</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">now_ip=`ifconfig | grep <span class="string">"inet addr"</span> | grep -v <span class="string">"127.0.0.1"</span> | awk <span class="string">'{print $2}'</span> | sed <span class="string">'s/.*://g'</span>`</span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">${now_ip}</span>"</span> == <span class="string">""</span> ]; <span class="keyword">then</span></span><br><span class="line">    now_ip=`hostname -i | awk <span class="string">'{print $1}'</span>`</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="从机器列表中获取目标-IP"><a href="#从机器列表中获取目标-IP" class="headerlink" title="从机器列表中获取目标 IP"></a>从机器列表中获取目标 IP</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 这里以 ZooKeeper 为例</span></span><br><span class="line">aim_ip=`cat <span class="variable">${zk_home}</span>/conf/zoo.cfg | grep server | sed <span class="string">'s/.*=//g'</span> | cut -d <span class="string">':'</span> -f 1 | grep -v <span class="variable">${now_ip}</span> | tail -1`</span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">${aim_ip}</span>"</span> == <span class="string">""</span> ]; <span class="keyword">then</span></span><br><span class="line">    aim_ip=<span class="string">"127.0.0.1"</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="网络延迟和丢包率"><a href="#网络延迟和丢包率" class="headerlink" title="网络延迟和丢包率"></a>网络延迟和丢包率</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">ping_result=`ping -c 4 <span class="variable">${aim_ip}</span> -W 5`</span><br><span class="line">ping_packet_loss=`<span class="built_in">echo</span> <span class="variable">${ping_result}</span> | sed <span class="string">'s/.*received, //g'</span> | sed <span class="string">'s/ packet loss.*//g'</span>`</span><br><span class="line">ping_avg_ms=`<span class="built_in">echo</span> <span class="variable">${ping_result}</span> | sed <span class="string">'s/.*rtt //g'</span> | awk <span class="string">'{print $3}'</span> | cut -d <span class="string">'/'</span> -f 2`</span><br></pre></td></tr></tbody></table></figure>
<h4 id="通用工具"><a href="#通用工具" class="headerlink" title="通用工具"></a>通用工具</h4><h5 id="tsar"><a href="#tsar" class="headerlink" title="tsar"></a><a href="https://github.com/alibaba/tsar">tsar</a></h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line">$ wget -O tsar.zip https://github.com/alibaba/tsar/archive/master.zip --no-check-certificate</span><br><span class="line">$ unzip tsar.zip</span><br><span class="line">$ <span class="built_in">cd</span> tsar-master/</span><br><span class="line">$ make</span><br><span class="line">$ make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用</span></span><br><span class="line"><span class="comment"># 指标含义</span></span><br><span class="line"><span class="comment"># cpu - util:        CPU 总使用的时间百分比</span></span><br><span class="line"><span class="comment"># mem - util:        内存使用率</span></span><br><span class="line"><span class="comment"># tcp - retran:      系统的重传率</span></span><br><span class="line"><span class="comment"># traffic - bytin:   入口流量 Byte/s</span></span><br><span class="line"><span class="comment"># traffic - bytout:  出口流量 Byte/s</span></span><br><span class="line"><span class="comment"># vda - util:        虚拟磁盘 vda 的 I/O</span></span><br><span class="line"><span class="comment"># vda1 - util:       虚拟磁盘 vda1 的 I/O</span></span><br><span class="line"><span class="comment"># load - load1:      一分钟的系统平均负载</span></span><br><span class="line">$ tsar -l -i 1</span><br><span class="line">  Time              ---cpu-- ---mem-- ---tcp-- -----traffic---- --vda--- --vda1--  ---load-</span><br><span class="line">  Time                util     util   retran    bytin  bytout     util     util     load1</span><br><span class="line">  09/04/19-19:59:44   0.00     0.71     0.00   126.00  222.00     0.00     0.00      0.16</span><br><span class="line">  09/04/19-19:59:45   0.02     0.71     0.00    66.00  338.00     0.00     0.00      0.16</span><br><span class="line">  09/04/19-19:59:46   0.00     0.71     0.00    66.00  242.00     0.00     0.00      0.16</span><br></pre></td></tr></tbody></table></figure>
<h3 id="从-JVM-进程中，找到占用-CPU-最高的-Java-线程"><a href="#从-JVM-进程中，找到占用-CPU-最高的-Java-线程" class="headerlink" title="从 JVM 进程中，找到占用 CPU 最高的 Java 线程"></a>从 JVM 进程中，找到占用 CPU 最高的 Java 线程</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 使用命令 top -p &lt;pid&gt;，显示 Java 进程的内存情况</span></span><br><span class="line">$ top -p 15108</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按大写的 H，获取每个线程的内存情况</span></span><br><span class="line"><span class="comment"># 找到内存和 CPU 占用最高的线程 pid</span></span><br><span class="line">PID   USER      PR  NI  VIRT   RES   SHR   S  %CPU   %MEM  TIME+    COMMAND</span><br><span class="line">15133 druid     20   0  24.9g  1.1g  7776  S  244.9  0.9   0:07.36  java</span><br><span class="line">15108 druid     20   0  24.9g  1.1g  7776  S  0.0    0.9   0:00.57  java</span><br><span class="line">15114 druid     20   0  24.9g  1.1g  7776  S  0.0    0.9   0:08.96  java</span><br><span class="line">15115 druid     20   0  24.9g  1.1g  7776  S  0.0    0.9   0:07.26  java</span><br><span class="line">15116 druid     20   0  24.9g  1.1g  7776  S  0.0    0.9   0:07.25  java</span><br><span class="line">15117 druid     20   0  24.9g  1.1g  7776  S  0.0    0.9   0:07.19  java</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获得线程 pid 的十六进制</span></span><br><span class="line">$ <span class="built_in">printf</span> 0x%x 15133</span><br><span class="line">  0x3b1d</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从线程堆栈信息中找到 3b1d 这个线程，并展示所在行的后面 10 行</span></span><br><span class="line">$ jstack 15108 | grep -A 10 3b1d</span><br><span class="line">  <span class="string">"qtp2028042905-211-acceptor-3@41374390-ServerConnector@2faa55bb{HTTP/1.1}{0.0.0.0:8090}"</span> <span class="comment">#211 daemon prio=4 os_prio=0 tid=0x00007f789bc47800 nid=0x3b1d runnable [0x00007f74e29ec000]</span></span><br><span class="line">     java.lang.Thread.State: RUNNABLE</span><br><span class="line">          at sun.nio.ch.ServerSocketChannelImpl.accept0(Native Method)</span><br><span class="line">          at sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:422)</span><br><span class="line">          at sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:250)</span><br><span class="line">          - locked &lt;0x00000007122b1fa0&gt; (a java.lang.Object)</span><br><span class="line">          at org.eclipse.jetty.server.ServerConnector.accept(ServerConnector.java:377)</span><br><span class="line">          at org.eclipse.jetty.server.AbstractConnector<span class="variable">$Acceptor</span>.run(AbstractConnector.java:500)</span><br><span class="line">          at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:620)</span><br><span class="line">          at org.eclipse.jetty.util.thread.QueuedThreadPool<span class="variable">$3</span>.run(QueuedThreadPool.java:540)</span><br><span class="line">          at java.lang.Thread.run(Thread.java:745)</span><br><span class="line"><span class="comment"># 查看对应的堆栈信息，找出可能存在问题的代码</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="Windows-相关"><a href="#Windows-相关" class="headerlink" title="Windows 相关"></a>Windows 相关</h3><h4 id="Windows-下执行-shell-脚本"><a href="#Windows-下执行-shell-脚本" class="headerlink" title="Windows 下执行 shell 脚本"></a>Windows 下执行 shell 脚本</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 安装 git</span></span><br><span class="line">$ doskey bash=<span class="string">"%GIT_HOME%\bin\bash.exe"</span> $*</span><br><span class="line">$ doskey sh=<span class="string">"%GIT_HOME%\bin\sh.exe"</span> $*</span><br><span class="line">$ bash shell.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 类似的可以设置 `np` 为 `notepad++` 的快捷启动命令</span></span><br><span class="line">$ doskey np=D:\apps\Notepad++\notepad++.exe $*</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Cmd-设置-Proxy"><a href="#Cmd-设置-Proxy" class="headerlink" title="Cmd 设置 Proxy"></a>Cmd 设置 Proxy</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">set</span> http_proxy=http://your_proxy:your_port</span><br><span class="line">$ <span class="built_in">set</span> http_proxy=http://username:password@your_proxy:your_port</span><br><span class="line">$ <span class="built_in">set</span> https_proxy=https://your_proxy:your_port</span><br><span class="line">$ <span class="built_in">set</span> https_proxy=https://username:password@your_proxy:your_port</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Cygwin"><a href="#Cygwin" class="headerlink" title="Cygwin"></a>Cygwin</h4><h5 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h5><p>　在<a href="https://cygwin.com/">官网</a>找到 <a href="https://cygwin.com/setup-x86_64.exe">setup-x86_64.exe</a> 安装包，下载并执行（安装的过程中，如果提示有冲突，选择 <code>contiune</code> 而不能是 <code>retry</code>，否则，将会全部重新开始）</p>
<h5 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 切换到想要的盘符下</span></span><br><span class="line">$ <span class="built_in">cd</span> /cygdrive/e</span><br><span class="line">$ <span class="built_in">cd</span> e:/</span><br></pre></td></tr></tbody></table></figure>
<h3 id="防火墙"><a href="#防火墙" class="headerlink" title="防火墙"></a>防火墙</h3><h4 id="CentOS"><a href="#CentOS" class="headerlink" title="CentOS"></a>CentOS</h4><h5 id="CentOS-6"><a href="#CentOS-6" class="headerlink" title="CentOS 6"></a>CentOS 6</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 查看状态</span></span><br><span class="line">$ service iptable status</span><br><span class="line"></span><br><span class="line"><span class="comment"># 临时关闭</span></span><br><span class="line">$ servcie iptables stop</span><br><span class="line"><span class="comment"># 永久关闭</span></span><br><span class="line">$ chkconfig iptables off</span><br></pre></td></tr></tbody></table></figure>
<h5 id="CentOS-7"><a href="#CentOS-7" class="headerlink" title="CentOS 7"></a>CentOS 7</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 查看默认防火墙状态（CentOS 7.0）</span></span><br><span class="line">$ firewall-cmd --state</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看默认防火墙状态（CentOS 7.x）</span></span><br><span class="line">$ systemctl list-unit-files | grep firewalld.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 firewall</span></span><br><span class="line">$ systemctl start firewalld.service</span><br><span class="line"><span class="comment"># 重启 firewall</span></span><br><span class="line">$ systemctl restart firewalld.service</span><br><span class="line"><span class="comment"># 停止 firewall</span></span><br><span class="line">$ systemctl stop firewalld.service</span><br><span class="line"><span class="comment"># 查看 firewall 状态</span></span><br><span class="line">$ systemctl status firewalld.service</span><br><span class="line"><span class="comment"># 是否 / 开启 / 禁止 firewall 的开机自启</span></span><br><span class="line">$ systemctl is-enabled/<span class="built_in">enable</span>/<span class="built_in">disable</span> firewalld.service</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Ubuntu"><a href="#Ubuntu" class="headerlink" title="Ubuntu"></a>Ubuntu</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 开启防火墙</span></span><br><span class="line">$ ufw <span class="built_in">enable</span></span><br><span class="line"><span class="comment"># 关闭防火墙</span></span><br><span class="line">$ ufw <span class="built_in">disable</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 卸载 iptables 服务</span></span><br><span class="line">$ apt-get remove iptables</span><br></pre></td></tr></tbody></table></figure>
<h2 id="优化实战"><a href="#优化实战" class="headerlink" title="优化实战"></a>优化实战</h2><h3 id="关闭-Swappiness"><a href="#关闭-Swappiness" class="headerlink" title="关闭 Swappiness"></a>关闭 Swappiness</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ cat /proc/sys/vm/swappiness</span><br><span class="line">  <span class="comment"># default: 60</span></span><br><span class="line">  <span class="comment"># memory first: 0</span></span><br><span class="line">  <span class="comment"># swap first: 100</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使得 swappiness 设置永久生效</span></span><br><span class="line">$ vim /etc/sysctl.conf</span><br><span class="line">  vm.swappiness=10</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以配合 JVM 中的 `-XX:+AlwaysPreTouch` 参数，在进程启动的时候，让 jvm 通过 demand-zeroed 方式将内存一次分配到位，提高 daemon 常驻进程性能</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="控制-Overcommit"><a href="#控制-Overcommit" class="headerlink" title="控制 Overcommit"></a>控制 Overcommit</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ cat /proc/sys/vm/overcommit_memory</span><br><span class="line">  <span class="comment"># 0: 表示内核将检查是否有足够的可用内存供应用进程使用</span></span><br><span class="line">  <span class="comment">#    如果有足够的可用内存，内存申请允许；否则，内存申请失败，并把错误返回给应用进程</span></span><br><span class="line">  <span class="comment"># 1: 表示内核允许分配所有的物理内存，而不管当前的内存状态如何</span></span><br><span class="line">  <span class="comment"># 2: 表示内核允许分配超过所有物理内存和交换空间总和的内存</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="禁用透明巨页"><a href="#禁用透明巨页" class="headerlink" title="禁用透明巨页"></a>禁用透明巨页</h3><h4 id="Page-Size"><a href="#Page-Size" class="headerlink" title="Page Size"></a>Page Size</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ getconf PAGE_SIZE</span><br><span class="line">  4096</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Huge-Page-Size"><a href="#Huge-Page-Size" class="headerlink" title="Huge Page Size"></a>Huge Page Size</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ cat /proc/meminfo | grep Hugepagesize</span><br><span class="line">  Hugepagesize:       2048 kB</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Transparent-Huge-Pages"><a href="#Transparent-Huge-Pages" class="headerlink" title="Transparent Huge Pages"></a>Transparent Huge Pages</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ cat /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line">  [always] madvise never</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line">$ <span class="built_in">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/defrag</span><br><span class="line"></span><br><span class="line"><span class="comment"># Redhat 的相关目录: /sys/kernel/mm/redhat_transparent_hugepage/</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="清理-Cache"><a href="#清理-Cache" class="headerlink" title="清理 Cache"></a>清理 Cache</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ free -g &amp;&amp; sync &amp;&amp; <span class="built_in">echo</span> 3 &gt; /proc/sys/vm/drop_caches &amp;&amp; free -g</span><br><span class="line">  <span class="comment"># before</span></span><br><span class="line">                 total       used       free     shared    buffers     cached</span><br><span class="line">    Mem:          3833       3726        106          0        107        272</span><br><span class="line">    -/+ buffers/cache:       3346        486</span><br><span class="line">    Swap:        10239          0      10239</span><br><span class="line">  <span class="comment"># after</span></span><br><span class="line">                 total       used       free     shared    buffers     cached</span><br><span class="line">    Mem:          3833       3345        487          0          1         31</span><br><span class="line">    -/+ buffers/cache:       3312        520</span><br><span class="line">    Swap:        10239          0      10239</span><br><span class="line"></span><br><span class="line"><span class="comment"># To free pagecache:</span></span><br><span class="line">$ <span class="built_in">echo</span> 1 &gt; /proc/sys/vm/drop_caches</span><br><span class="line"><span class="comment"># To free dentries and inodes:</span></span><br><span class="line">$ <span class="built_in">echo</span> 2 &gt; /proc/sys/vm/drop_caches</span><br><span class="line"><span class="comment"># To free pagecache, dentries and inodes:</span></span><br><span class="line">$ <span class="built_in">echo</span> 3 &gt; /proc/sys/vm/drop_caches</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行完清空 Cache 的命令之后，需要重新设置为 0，否则 Cache 机制就相当于被 disable 了</span></span><br><span class="line">$ <span class="built_in">echo</span> 0 &gt; /proc/sys/vm/drop_caches</span><br></pre></td></tr></tbody></table></figure>
<h3 id="增大预留空闲内存"><a href="#增大预留空闲内存" class="headerlink" title="增大预留空闲内存"></a>增大预留空闲内存</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 系统默认预留内存空间，只有 88 MB</span></span><br><span class="line">$ cat /proc/sys/vm/min_free_kbytes</span><br><span class="line">  90112</span><br><span class="line"></span><br><span class="line"><span class="comment"># 为了系统稳定性，可以增加到 1 GB</span></span><br><span class="line">$ vim /proc/sys/vm/min_free_kbytes</span><br><span class="line">  1048576</span><br></pre></td></tr></tbody></table></figure>
<h2 id="系统架构"><a href="#系统架构" class="headerlink" title="系统架构"></a>系统架构</h2><h3 id="Cache-amp-Buffer"><a href="#Cache-amp-Buffer" class="headerlink" title="Cache &amp; Buffer"></a>Cache &amp; Buffer</h3><h4 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h4><p>　在 Linux 的内存管理中，<strong>Cache</strong>（Page Cache）属于 页面缓存，<strong>Buffer</strong>（Buffer Cache）则属于 缓冲区缓存。前者，针对 页（Page）内存进行管理，后者，则针对 块（Block）内存进行管理</p>
<h4 id="分析-Cache"><a href="#分析-Cache" class="headerlink" title="分析 Cache"></a>分析 Cache</h4><h5 id="fincore"><a href="#fincore" class="headerlink" title="fincore"></a><a href="https://github.com/david415/linux-ftools">fincore</a></h5><h6 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 安装两个 perl 依赖包（大小仅 336 KB）</span></span><br><span class="line">$ yum install perl-Inline perl-Parse-RecDescent -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载编译 fincore</span></span><br><span class="line">$ wget https://github.com/david415/linux-ftools/archive/master.zip</span><br><span class="line">$ unzip linux-ftools-master.zip</span><br><span class="line">$ <span class="built_in">cd</span> linux-ftools-master</span><br><span class="line">$ chmod 777 configure</span><br><span class="line">$ ./configure --prefix=/usr/<span class="built_in">local</span>/ &amp;&amp; make -j2 &amp;&amp; make -j2 install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果报错 WARNING: `automake-1.10` is missing on your system.</span></span><br><span class="line">$ ln -sf /usr/bin/aclocal /usr/bin/aclocal-1.10</span><br><span class="line">$ ln -sf /usr/bin/automake /usr/bin/automake-1.10</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果需要在线上环境，进行离线安装</span></span><br><span class="line">$ mkdir -p /tmp/fincore</span><br><span class="line">$ yum reinstall --downloadonly --downloaddir=/tmp/fincore perl-Inline perl-Parse-RecDescent -y</span><br><span class="line">$ ll /tmp/fincore</span><br><span class="line">  -rw-r--r-- 1 root root 151484 Jul 22  2010 perl-Inline-0.46-1.el6.noarch.rpm</span><br><span class="line">  -rw-r--r-- 1 root root 193348 Sep 25  2011 perl-Parse-RecDescent-1.965-1.el6.noarch.rpm</span><br></pre></td></tr></tbody></table></figure>
<h6 id="编码"><a href="#编码" class="headerlink" title="编码"></a>编码</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">command</span> -v fincore &gt;/dev/null 2&gt;&amp;1 || {</span><br><span class="line">    <span class="built_in">echo</span> &gt;&amp;2 <span class="string">"I require fincore but it's not installed. Try install..."</span> ; <span class="built_in">exit</span> 1;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">pids_tmp=/tmp/cache.pids</span><br><span class="line">cache_tmp=/tmp/cache.files</span><br><span class="line">fincore_tmp=/tmp/cache.fincore</span><br><span class="line">result_tmp=/tmp/result.fincore</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"The top 3 cache pid:"</span></span><br><span class="line">ps -e -o pid,rss | sort -nk2 -r | grep -vw 1 | head -3 | awk <span class="string">'{print $1}'</span> &gt; <span class="variable">${pids_tmp}</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"`cat <span class="variable">${pids_tmp}</span>`\n"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> pid <span class="keyword">in</span> `cat <span class="variable">${pids_tmp}</span>`; <span class="keyword">do</span></span><br><span class="line">    ps -ef | grep <span class="variable">${pid}</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\n"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -f <span class="variable">${cache_tmp}</span> ]; <span class="keyword">then</span></span><br><span class="line">    rm -f <span class="variable">${cache_tmp}</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> line; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"Pid: <span class="variable">${line}</span>, Files:"</span></span><br><span class="line">    file=`lsof -p <span class="variable">${line}</span> 2&gt;/dev/null | awk <span class="string">'{print $9}'</span>`</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">${file}</span>"</span> &gt;&gt; <span class="variable">${cache_tmp}</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"<span class="variable">${file}</span>\n"</span> | grep -vw <span class="string">"NAME"</span></span><br><span class="line"><span class="keyword">done</span>&lt;<span class="variable">${pids_tmp}</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -f <span class="variable">${fincore_tmp}</span> ]; <span class="keyword">then</span></span><br><span class="line">    rm -f <span class="variable">${fincore_tmp}</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `cat <span class="variable">${cache_tmp}</span>`; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> [ -f <span class="variable">${i}</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">${i}</span> &gt;&gt; <span class="variable">${fincore_tmp}</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">fincore --pages=<span class="literal">false</span> `cat <span class="variable">${fincore_tmp}</span> | grep -v /usr/sbin/sshd | grep -v /lib64/ld-2.12.so | grep -v /bin/bash | grep -v /bin/login` &gt; <span class="variable">${result_tmp}</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"filename size	total pages	cached pages    cached size	cached percentage"</span></span><br><span class="line"></span><br><span class="line">len=`cat <span class="variable">${result_tmp}</span> | wc -l`</span><br><span class="line">cat <span class="variable">${result_tmp}</span> | tail -$(<span class="built_in">echo</span> <span class="string">"<span class="variable">${len}</span>-1"</span> | bc) | sort -nk4 -r</span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></tbody></table></figure>
<p>Tips: Full code is <a href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-common/src/main/resources/shell/max_cache.sh">here</a>.</p>
<h5 id="System-Tap"><a href="#System-Tap" class="headerlink" title="System Tap"></a>System Tap</h5><p>　依赖包太多，线上环境不适合</p>
<h5 id="pcstat"><a href="#pcstat" class="headerlink" title="pcstat"></a><a href="https://github.com/tobert/pcstat">pcstat</a></h5><p>　卡在了安装的第一步 <code>go get golang.org/x/sys/unix</code> …</p>
<h4 id="回收-Cache"><a href="#回收-Cache" class="headerlink" title="回收 Cache"></a>回收 Cache</h4><h5 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h5><p>　具体操作，请看上文 “优化实战 - <a href="https://yuzhouwan.com/posts/15691/#清理-Cache">清理 Cache</a>” 部分</p>
<h5 id="成本"><a href="#成本" class="headerlink" title="成本"></a>成本</h5><p>　清理 Cache 之前，需要保证 Cache 中的数据，和对应文件中的数据一致，才能对 Cache 进行释放。因此，清除 Cache 之前，内核会检查 Cache 数据与对应磁盘文件数据一致性，并将不一致的 Cache 写回磁盘。这一过程，将消耗大量的磁盘 I/O 资源</p>
<h5 id="无法被回收的情况"><a href="#无法被回收的情况" class="headerlink" title="无法被回收的情况"></a>无法被回收的情况</h5><h6 id="tmpfs"><a href="#tmpfs" class="headerlink" title="tmpfs"></a><a href="http://www.tmtpost.com/43815.html">tmpfs</a></h6><p>　Linux 提供一种 “临时”文件系统（重启之后数据不会被保存），拿出一部分的内存空间当做文件系统使用，可以动态调整文件系统的大小，并且相比磁盘文件系统的读写速度，会快上很多倍。在 <strong>tmpfs</strong> 系统里面的内存，是不会被回收的，除非 tmpfs 里面的文件被删除</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 操作系统默认就创建了一个 `/dev/shm` 的 tmpfs 目录，可以用来做缓存，进行提速（Automatic Memory Management、Web 缓存等）</span></span><br><span class="line">$ ll -h /dev/shm</span><br><span class="line">  total 76K</span><br><span class="line">  -rw-r--r-- 1 root root  46 Aug 13 11:05 10694</span><br><span class="line">  -r-------- 1 root root 65M May 25 14:43 pulse-shm-17791060</span><br><span class="line">  -r-------- 1 root root 65M May 25 14:43 pulse-shm-31652098</span><br><span class="line"></span><br><span class="line"><span class="comment"># 当然，也可以创建自己的 tmpfs</span></span><br><span class="line">$ mkdir /tmp/tmpfs</span><br><span class="line">$ mount -t tmpfs -o size=3G none /tmp/tmpfs/</span><br><span class="line">$ df -h</span><br><span class="line">  Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">  tmpfs            63G     0   63G   0% /dev/shm</span><br><span class="line">  none            3.0G     0  3.0G   0% /tmp/tmpfs</span><br><span class="line"></span><br><span class="line">$ free -g</span><br><span class="line">               total       used       free     shared    buffers     cached</span><br><span class="line">  Mem:           125         79         46          0          0          0</span><br><span class="line">  -/+ buffers/cache:         79         46</span><br><span class="line">  Swap:            0          0          0</span><br><span class="line"></span><br><span class="line">$ dd <span class="keyword">if</span>=/dev/zero of=/tmp/tmpfs/yuzhouwan bs=1G</span><br><span class="line">  dd: writing <span class="string">'/tmp/tmpfs/yuzhouwan'</span>: No space left on device</span><br><span class="line">  4+0 records <span class="keyword">in</span></span><br><span class="line">  3+0 records out</span><br><span class="line">  3221225472 bytes (3.2 GB) copied, 2.57476 s, 1.3 GB/s</span><br><span class="line"></span><br><span class="line">$ free -g</span><br><span class="line">               total       used       free     shared    buffers     cached</span><br><span class="line">  Mem:           125         83         42          0          0          3</span><br><span class="line">  -/+ buffers/cache:         80         45</span><br><span class="line">  Swap:            0          0          0</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> 3 &gt; /proc/sys/vm/drop_caches</span><br><span class="line">$ free -g</span><br><span class="line">               total       used       free     shared    buffers     cached</span><br><span class="line">  Mem:           125         84         41          0          0          3</span><br><span class="line">  -/+ buffers/cache:         80         44</span><br><span class="line">  Swap:            0          0          0</span><br><span class="line"></span><br><span class="line">$ rm /tmp/tmpfs/yuzhouwan</span><br><span class="line">$ free -g</span><br><span class="line">               total       used       free     shared    buffers     cached</span><br><span class="line">  Mem:           125         86         39          0          0          0</span><br><span class="line">  -/+ buffers/cache:         85         40</span><br><span class="line">  Swap:            0          0          0</span><br></pre></td></tr></tbody></table></figure>
<h6 id="ipcs"><a href="#ipcs" class="headerlink" title="ipcs"></a>ipcs</h6><p>　进程间通信（IPC）方式，只需要在 “输入文件” 到 “共享内存区” 之间进行两次数据的拷贝。但是，如果通过 <code>shmget</code> 创建完共享内存之后，没有在结束的时候，使用 <code>shmctl</code> 删除共享内存，那么，这块内存将一直无法被清理出去</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 可以通过以下两个命令，查看共享内存空间，并删除</span></span><br><span class="line">$ ipcs -m</span><br><span class="line">$ ipcrm -m &lt;shmid&gt;</span><br></pre></td></tr></tbody></table></figure>
<h6 id="mmap"><a href="#mmap" class="headerlink" title="mmap"></a>mmap</h6><p>　进程之间还可以通过 <code>mmap</code> 方法，映射同一个普通文件，来实现共享内存。普通文件被映射到进程地址空间后，进程可以像访问普通内存一样对文件进行访问，不必再调用 <code>read</code> / <code>write</code> 方法。同样地，如果没有在进程退出时，使用 <code>munmap</code> 方法解除映射关系，也会存在共享内存无法被清除的情况</p>
<h2 id="资源"><a href="#资源" class="headerlink" title="资源"></a>资源</h2><h3 id="Book"><a href="#Book" class="headerlink" title="Book"></a>Book</h3><ul>
<li><a href="http://fifilyu.github.io/halcpgb/">高可用负载均衡集群实践</a></li>
</ul>
<h3 id="Tool"><a href="#Tool" class="headerlink" title="Tool"></a>Tool</h3><ul>
<li><a href="https://www.memtest86.com/">MemTest86</a></li>
<li><a href="http://pyropus.ca/software/memtester/">MemTester 4</a></li>
</ul>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt=""></a></td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>语言</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Shell</tag>
      </tags>
  </entry>
  <entry>
    <title>Maven 高级玩法</title>
    <url>/posts/2254/</url>
    <content><![CDATA[<h2 id="实用技巧"><a href="#实用技巧" class="headerlink" title="实用技巧"></a>实用技巧</h2><h3 id="Maven-提速"><a href="#Maven-提速" class="headerlink" title="Maven 提速"></a>Maven 提速</h3><h4 id="多线程"><a href="#多线程" class="headerlink" title="多线程"></a>多线程</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 用 4 个线程构建，以及根据 CPU 核数每个核分配 1 个线程进行构建</span></span><br><span class="line">$ mvn -T 4 clean install</span><br><span class="line">$ mvn -T 1C clean install</span><br></pre></td></tr></tbody></table></figure>
<h4 id="跳过测试"><a href="#跳过测试" class="headerlink" title="跳过测试"></a>跳过测试</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">-DskipTests               <span class="comment"># 不执行测试用例，但编译测试用例类生成相应的 class 文件至 target/test-classes 下</span></span><br><span class="line">-Dmaven.test.skip=<span class="literal">true</span>    <span class="comment"># 不执行测试用例，也不编译测试用例类</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 结合上文的`并行执行`</span></span><br><span class="line">$ mvn -T 1C clean install -Dmaven.test.skip=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果还是阻塞: 资源管理器 - shutdown all java app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果 jar 包过大，可以下载按照路径放在 repository 中，之后可能还需要 mvn clean 来下载 groovy-all-2.3.11.pom 文件 (mvnrepository.com)</span></span><br><span class="line">D:\apps\maven\repository\org\codehaus\groovy\groovy-all\2.3.11\groovy-all-2.3.11.jar</span><br></pre></td></tr></tbody></table></figure>
<h4 id="编译失败后，接着编译"><a href="#编译失败后，接着编译" class="headerlink" title="编译失败后，接着编译"></a>编译失败后，接着编译</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 如果是 Apache Eagle 之类带有几十个子项目的工程，如果从头编译所有的模块，会很耗功夫</span></span><br><span class="line"><span class="comment"># 通过指定之前失败的模块名，可以继续之前的编译</span></span><br><span class="line">$ mvn -rf :moduleName clean install</span><br></pre></td></tr></tbody></table></figure>
<h4 id="跳过失败的模块，编译到最后再报错"><a href="#跳过失败的模块，编译到最后再报错" class="headerlink" title="跳过失败的模块，编译到最后再报错"></a>跳过失败的模块，编译到最后再报错</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ mvn clean install --fail-at-end</span><br></pre></td></tr></tbody></table></figure>
<h4 id="使用-Aliyun-国内镜像"><a href="#使用-Aliyun-国内镜像" class="headerlink" title="使用 Aliyun 国内镜像"></a>使用 Aliyun 国内镜像</h4><figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<a id="more"></a>
<h3 id="指定-Repository-目录"><a href="#指定-Repository-目录" class="headerlink" title="指定 Repository 目录"></a>指定 Repository 目录</h3><figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Default: ~/.m2/repository  --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">localRepository</span>&gt;</span>D:\apps\maven\repository<span class="tag">&lt;/<span class="name">localRepository</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="如何使用-Maven-编译指定-module"><a href="#如何使用-Maven-编译指定-module" class="headerlink" title="如何使用 Maven 编译指定 module"></a>如何使用 Maven 编译指定 module</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ mvn install -pl &lt;module_name&gt; -am</span><br><span class="line"></span><br><span class="line">  -pl, --projects      (Build specified reactor projects instead of all project)</span><br><span class="line">  -am, --also-make     (If project list is specified, also build projects required by the list)</span><br><span class="line">  -amd, --also-make-dependents    (If project list is specified, also build projects that depend on)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="如何使用-Maven-编译跳过-module"><a href="#如何使用-Maven-编译跳过-module" class="headerlink" title="如何使用 Maven 编译跳过 module"></a><a href="https://yuzhouwan.com/posts/200906/#%E7%BC%96%E8%AF%91">如何使用 Maven 编译跳过 module</a></h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ mvn install -pl &lt;!module_name&gt;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Maven-标准目录结构"><a href="#Maven-标准目录结构" class="headerlink" title="Maven 标准目录结构"></a>Maven 标准目录结构</h3><figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line">src/main/java             Application/Library sources</span><br><span class="line">src/main/resources        Application/Library resources</span><br><span class="line">src/main/filters          Resource filter files</span><br><span class="line">src/main/webapp           Web application sources</span><br><span class="line">src/test/java             Test sources</span><br><span class="line">src/test/resources        Test resources</span><br><span class="line">src/test/filters          Test resource filter files</span><br><span class="line">src/it                    Integration Tests (primarily <span class="keyword">for</span> plugins)</span><br><span class="line">src/assembly              Assembly descriptors</span><br><span class="line">src/site                  Site</span><br><span class="line">LICENSE.txt               Project<span class="string">'s license</span></span><br><span class="line"><span class="string">NOTICE.txt                Notices and attributions required by libraries that the project depends on</span></span><br><span class="line"><span class="string">README.txt                Project'</span>s readme</span><br></pre></td></tr></tbody></table></figure>
<h3 id="如何在-Maven-中使用多个-source"><a href="#如何在-Maven-中使用多个-source" class="headerlink" title="如何在 Maven 中使用多个 source"></a>如何在 Maven 中使用多个 source</h3><figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.codehaus.mojo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>build-helper-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">phase</span>&gt;</span>generate-sources<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>add-source<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sources</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">source</span>&gt;</span>src/main/scala<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">sources</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="Using-Scala-UnitTest-by-Maven"><a href="#Using-Scala-UnitTest-by-Maven" class="headerlink" title="Using Scala UnitTest by Maven"></a>Using Scala UnitTest by Maven</h3><h4 id="安装-Scala"><a href="#安装-Scala" class="headerlink" title="安装 Scala"></a>安装 <a href="https://yuzhouwan.com/posts/18651/">Scala</a></h4><h4 id="Maven-依赖"><a href="#Maven-依赖" class="headerlink" title="Maven 依赖"></a>Maven 依赖</h4><figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.scalatest<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>scalatest_2.10<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="创建-unittest-需要的-trait"><a href="#创建-unittest-需要的-trait" class="headerlink" title="创建 unittest 需要的 trait"></a>创建 unittest 需要的 trait</h4><figure class="highlight scala"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.scalatest._</span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">UnitTestStyle</span> <span class="keyword">extends</span> <span class="title">FlatSpec</span></span></span><br><span class="line"><span class="class"><span class="keyword">with</span> <span class="title">Matchers</span> <span class="keyword">with</span> <span class="title">OptionValues</span> <span class="keyword">with</span> <span class="title">Inside</span> <span class="keyword">with</span> <span class="title">Inspectors</span></span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="编写测试"><a href="#编写测试" class="headerlink" title="编写测试"></a>编写测试</h4><figure class="highlight scala"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> spark.streaming.detect.<span class="type">SendNetflow</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SendNetflowTest</span> <span class="keyword">extends</span> <span class="title">UnitTestStyle</span> </span>{</span><br><span class="line"></span><br><span class="line">  <span class="string">"Clean method"</span> should <span class="string">"output a string"</span> in {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> s = <span class="string">"0,tcp,http,SF,229,9385,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,9,9,0.00,0.00,0.00,0.00,1.00,0.00,0.00,9,90,1.00,0.00,0.11,0.04,0.00,0.00,0.00,0.00,normal."</span></span><br><span class="line">    <span class="type">SendNetflow</span>.clean(s) should be(<span class="string">"0,229,9385,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,9,9,0.00,0.00,0.00,0.00,1.00,0.00,0.00,9,90,1.00,0.00,0.11,0.04,0.00,0.00,0.00,0.00\tnormal."</span>)</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  it should <span class="string">"throw Exception if an empty string is inputted"</span> in {</span><br><span class="line">    <span class="keyword">val</span> emptyS = <span class="string">""</span></span><br><span class="line">    a[<span class="type">RuntimeException</span>] should be thrownBy {</span><br><span class="line">    <span class="type">SendNetflow</span>.clean(emptyS)</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>Tips: Full code is <a href="https://github.com/asdf2014/yuzhouwan/tree/master/yuzhouwan-bigdata/yuzhouwan-bigdata-spark/src/test/scala/com/yuzhouwan/bigdata/spark/style">here</a>.</p>
<h3 id="Using-slf4j-by-Maven"><a href="#Using-slf4j-by-Maven" class="headerlink" title="Using slf4j by Maven"></a>Using slf4j by Maven</h3><h4 id="Maven-配置"><a href="#Maven-配置" class="headerlink" title="Maven 配置"></a>Maven 配置</h4><figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">slf4j.version</span>&gt;</span>1.7.12<span class="tag">&lt;/<span class="name">slf4j.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">logback.version</span>&gt;</span>1.1.3<span class="tag">&lt;/<span class="name">logback.version</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>${logback.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-classic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>${logback.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>${slf4j.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jcl-over-slf4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>${slf4j.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-over-slf4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>${slf4j.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jul-to-slf4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>${slf4j.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="logback-xml-in-resources-directory"><a href="#logback-xml-in-resources-directory" class="headerlink" title="logback.xml in resources directory"></a>logback.xml in resources directory</h4><figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- %p:Level %m:Message %c.%M:Package+Method %F:%L:File+Line --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"pattern"</span> <span class="attr">value</span>=<span class="string">"%d{yyyy-MM-dd HH:mm:ss.SSS} | %p | %m | %c.%M | %F:%L %n"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- Print in Console --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"STDOUT"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.ConsoleAppender"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">encoder</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>${pattern}<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">"ALL"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"STDOUT"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="编码"><a href="#编码" class="headerlink" title="编码"></a>编码</h4><h5 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h5><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger _log = LoggerFactory.getLogger(ZKEventWatch.class);</span><br><span class="line">_log.info(state);</span><br></pre></td></tr></tbody></table></figure>
<h5 id="遇到的坑"><a href="#遇到的坑" class="headerlink" title="遇到的坑"></a>遇到的坑</h5><h6 id="SLF4J-multi-bindings"><a href="#SLF4J-multi-bindings" class="headerlink" title="SLF4J multi bindings"></a>SLF4J multi bindings</h6><ul>
<li>描述</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">SLF4J: Class path contains multiple SLF4J bindings.</span><br><span class="line">SLF4J: Found binding <span class="keyword">in</span> [jar:file:/D:/apps/maven/repository/ch/qos/logback/logback-classic/1.1.3/logback-classic-1.1.3.jar!/org/slf4j/impl/StaticLoggerBinder.class]</span><br><span class="line">SLF4J: Found binding <span class="keyword">in</span> [jar:file:/D:/apps/maven/repository/org/slf4j/slf4j-log4j12/1.6.1/slf4j-log4j12-1.6.1.jar!/org/slf4j/impl/StaticLoggerBinder.class]</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>解决</li>
</ul>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 使用 Apache Curator 需要 exclusion slf4j-log4j12，否则会出现问题 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-recipes<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>${apache.curator.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-log4j12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<p>Tips: Full code is <a href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-common/pom.xml">here</a>.</p>
<h3 id="导出依赖-Jar"><a href="#导出依赖-Jar" class="headerlink" title="导出依赖 Jar"></a>导出依赖 Jar</h3><p>　如何利用 Maven 将依赖的 jar 都导入到一个文件夹下<br></p><figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-dependency-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span>${project.build.directory}/lib<span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">excludeTransitive</span>&gt;</span>false<span class="tag">&lt;/<span class="name">excludeTransitive</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">stripVersion</span>&gt;</span>false<span class="tag">&lt;/<span class="name">stripVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><br><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ mvn clean dependency:copy-dependencies</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 yuzhouwan-flume 依赖的 jars 都 导出到一个文件夹</span></span><br><span class="line"><span class="comment"># 用相对路径，不能是 绝对路径，否则 maven 会报错：Unknown lifecycle phase "Java"</span></span><br><span class="line">$ mvn dependency:copy-dependencies -f yuzhouwan-flume/pom.xml -DoutputDirectory=yuzhouwan-flume/target/lib</span><br><span class="line">$ mvn dependency:copy-dependencies -f yuzhouwan-api/yuzhouwan-admin-api/pom.xml -DoutputDirectory=target/lib</span><br></pre></td></tr></tbody></table></figure><p></p>
<h3 id="Profiles"><a href="#Profiles" class="headerlink" title="Profiles"></a>Profiles</h3><h4 id="根据操作系统自动选择-Profile"><a href="#根据操作系统自动选择-Profile" class="headerlink" title="根据操作系统自动选择 Profile"></a><a href="https://maven.apache.org/enforcer/enforcer-rules/requireOS.html">根据操作系统自动选择 Profile</a></h4><figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">profiles</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>linux<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activation</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">activeByDefault</span>&gt;</span>true<span class="tag">&lt;/<span class="name">activeByDefault</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">os</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">family</span>&gt;</span>unix<span class="tag">&lt;/<span class="name">family</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">name</span>&gt;</span>Linux<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">os</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activation</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">blog</span>&gt;</span>https://yuzhouwan.com/posts/15691/<span class="tag">&lt;/<span class="name">blog</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>mac<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activation</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">os</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">family</span>&gt;</span>mac<span class="tag">&lt;/<span class="name">family</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">os</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activation</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">blog</span>&gt;</span>https://yuzhouwan.com/posts/190101/<span class="tag">&lt;/<span class="name">blog</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">profiles</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="指定-Profile"><a href="#指定-Profile" class="headerlink" title="指定 Profile"></a>指定 Profile</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 激活指定的 profile</span></span><br><span class="line">$ mvn clean install -P &lt;profile_A&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 不激活指定的 profile</span></span><br><span class="line">$ mvn clean install -P <span class="string">'!&lt;profile_B&gt;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以结合使用</span></span><br><span class="line">$ mvn clean install -P &lt;profile_A&gt; -P <span class="string">'!&lt;profile_B&gt;'</span></span><br></pre></td></tr></tbody></table></figure>
<p>Tips: Full code is <a href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-common/pom.xml">here</a>.</p>
<h3 id="日志级别"><a href="#日志级别" class="headerlink" title="日志级别"></a>日志级别</h3><p>　-Dorg.slf4j.simpleLogger.defaultLogLevel=<a href="https://maven.apache.org/maven-logging.html">error</a></p>
<h3 id="Generate-Code-for-Antlr"><a href="#Generate-Code-for-Antlr" class="headerlink" title="Generate Code for Antlr"></a>Generate Code for Antlr</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ mvn clean install -T 1C -DskipTests=<span class="literal">true</span> -Dorg.slf4j.simpleLogger.defaultLogLevel=error -B</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Maven-Properties"><a href="#Maven-Properties" class="headerlink" title="Maven Properties"></a>Maven Properties</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ mvn clean install -Dmy.property=propertyValue</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Maven-Check-Style"><a href="#Maven-Check-Style" class="headerlink" title="Maven Check Style"></a>Maven Check Style</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ mvn clean install -Dcheckstyle.skip</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Maven-Update"><a href="#Maven-Update" class="headerlink" title="Maven Update"></a>Maven Update</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ mvn clean install -U</span><br><span class="line"><span class="comment"># -U means force update of dependencies.</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="Maven-Dependency"><a href="#Maven-Dependency" class="headerlink" title="Maven Dependency"></a>Maven Dependency</h3><h4 id="Pre-download"><a href="#Pre-download" class="headerlink" title="Pre-download"></a>Pre-download</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ mvn dependency:go-offline</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Version-compare"><a href="#Version-compare" class="headerlink" title="Version-compare"></a>Version-compare</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 在开发一些 Coprocessor 的时候，需要保证和 HBase 集群的依赖 jar 版本一致，可以使用该方法</span></span><br><span class="line">$ mvn versions:compare-dependencies -DremotePom=org.apache.hbase:hbase:0.98.8-hadoop2 -DreportOutputFile=depDiffs.txt</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Maven-Proxy"><a href="#Maven-Proxy" class="headerlink" title="Maven Proxy"></a>Maven Proxy</h3><h4 id="命令行设置"><a href="#命令行设置" class="headerlink" title="命令行设置"></a>命令行设置</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Linux (bash)</span></span><br><span class="line">$ <span class="built_in">export</span> MAVEN_OPTS=<span class="string">"-DsocksProxyHost=10.10.10.10 -DsocksProxyPort=8080"</span></span><br><span class="line"><span class="comment"># Windows</span></span><br><span class="line">$ <span class="built_in">set</span> MAVEN_OPTS=<span class="string">"-DsocksProxyHost=10.10.10.10 -DsocksProxyPort=8080"</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line">$ vim $MAVEN_HOME/conf/settings.xml</span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">proxies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;proxy&gt;</span></span><br><span class="line"><span class="comment">      &lt;id&gt;http-proxy&lt;/id&gt;</span></span><br><span class="line"><span class="comment">      &lt;active&gt;true&lt;/active&gt;</span></span><br><span class="line"><span class="comment">      &lt;protocol&gt;http&lt;/protocol&gt;</span></span><br><span class="line"><span class="comment">      &lt;host&gt;10.10.10.10&lt;/host&gt;</span></span><br><span class="line"><span class="comment">      &lt;port&gt;8888&lt;/port&gt;</span></span><br><span class="line"><span class="comment">      &lt;nonProxyHosts&gt;*.yuzhouwan.com&lt;/nonProxyHosts&gt;</span></span><br><span class="line"><span class="comment">    &lt;/proxy&gt;--&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">proxy</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>socks-proxy<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">active</span>&gt;</span>true<span class="tag">&lt;/<span class="name">active</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">protocol</span>&gt;</span>socks5<span class="tag">&lt;/<span class="name">protocol</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">host</span>&gt;</span>127.0.0.1<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">port</span>&gt;</span>1080<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">nonProxyHosts</span>&gt;</span>*.yuzhouwan.com<span class="tag">&lt;/<span class="name">nonProxyHosts</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">proxy</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">proxies</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="Avro-插件"><a href="#Avro-插件" class="headerlink" title="Avro 插件"></a>Avro 插件</h3><h4 id="创建-avsc-文件"><a href="#创建-avsc-文件" class="headerlink" title="创建 avsc 文件"></a>创建 avsc 文件</h4><figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"namespace"</span>: <span class="string">"com.yuzhouwan.hacker.avro"</span>,</span><br><span class="line">  <span class="attr">"type"</span>: <span class="string">"record"</span>,</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"User"</span>,</span><br><span class="line">  <span class="attr">"fields"</span>: [</span><br><span class="line">    {</span><br><span class="line">      <span class="attr">"name"</span>: <span class="string">"name"</span>,</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"string"</span></span><br><span class="line">    },</span><br><span class="line">    {</span><br><span class="line">      <span class="attr">"name"</span>: <span class="string">"favorite_number"</span>,</span><br><span class="line">      <span class="attr">"type"</span>: [</span><br><span class="line">        <span class="string">"int"</span>,</span><br><span class="line">        <span class="string">"null"</span></span><br><span class="line">      ]</span><br><span class="line">    },</span><br><span class="line">    {</span><br><span class="line">      <span class="attr">"name"</span>: <span class="string">"favorite_color"</span>,</span><br><span class="line">      <span class="attr">"type"</span>: [</span><br><span class="line">        <span class="string">"string"</span>,</span><br><span class="line">        <span class="string">"null"</span></span><br><span class="line">      ]</span><br><span class="line">    }</span><br><span class="line">  ]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="使用-avro-tools-工具生成-Avro-类"><a href="#使用-avro-tools-工具生成-Avro-类" class="headerlink" title="使用 avro-tools 工具生成 Avro 类"></a>使用 avro-tools 工具生成 Avro 类</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 下载 avro-tools</span></span><br><span class="line"><span class="comment"># https://mvnrepository.com/artifact/org.apache.avro/avro-tools/1.8.1</span></span><br><span class="line"><span class="comment"># http://archive.apache.org/dist/avro/avro-1.8.1/java/                    (better)</span></span><br><span class="line">$ wget http://archive.apache.org/dist/avro/avro-1.8.1/java/avro-tools-1.8.1.jar -c avro-tools-1.8.1.jar</span><br><span class="line"></span><br><span class="line"><span class="comment"># 利用 avsc 文件中的 Schema 生成 Avro 类</span></span><br><span class="line">$ java -jar avro-tools-1.8.1.jar compile schema user.avsc .</span><br></pre></td></tr></tbody></table></figure>
<h4 id="使用-avro-plugin-插件生成-Avro-类"><a href="#使用-avro-plugin-插件生成-Avro-类" class="headerlink" title="使用 avro-plugin 插件生成 Avro 类"></a>使用 avro-plugin 插件生成 Avro 类</h4><figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">apache.avro.version</span>&gt;</span>1.7.7<span class="tag">&lt;/<span class="name">apache.avro.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- apache avro --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.avro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>avro<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>${apache.avro.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.avro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>avro-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>${apache.avro.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">phase</span>&gt;</span>generate-sources<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>schema<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">sourceDirectory</span>&gt;</span>${project.basedir}/src/main/resources/avsc/<span class="tag">&lt;/<span class="name">sourceDirectory</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span>${project.basedir}/src/main/java/<span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<p>Tips: Full code is <a href="https://github.com/asdf2014/yuzhouwan/tree/master/yuzhouwan-hacker/src/main/java/com/yuzhouwan/hacker/avro">here</a>.</p>
<h3 id="Shade-插件解决-Jar-多版本共存"><a href="#Shade-插件解决-Jar-多版本共存" class="headerlink" title="Shade 插件解决 Jar 多版本共存"></a><a href="http://maven.apache.org/plugins/maven-shade-plugin/">Shade</a> 插件解决 Jar 多版本共存</h3><h4 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h4><p>　在整合大型项目时，可能都依赖 commons-collections 此类的工具包，但是也可能 commons-collections 的版本却因为不一致，导致冲突。可以通过 Shade 插件的 <code>relocation</code> 方法进行重定向，此时冲突的依赖 package 名，会被重命名，并且依赖该 jar 的程序，都会被自动替换为新的 package 名</p>
<h4 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h4><h5 id="指定-Shade-插件的版本"><a href="#指定-Shade-插件的版本" class="headerlink" title="指定 Shade 插件的版本"></a>指定 Shade 插件的版本</h5><figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.shade.plugin.version</span>&gt;</span>3.2.4<span class="tag">&lt;/<span class="name">maven.shade.plugin.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="实例一"><a href="#实例一" class="headerlink" title="实例一"></a>实例一</h5><p>　除了 org.mapdb.* 路径之外的 <code>org.apache.commons.collections</code> 包路径，将被重命名为 <code>com.yuzhouwan.org.apache.commons.collections</code></p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-shade-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>${maven.shade.plugin.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>shade<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">shadedArtifactAttached</span>&gt;</span>false<span class="tag">&lt;/<span class="name">shadedArtifactAttached</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">createSourcesJar</span>&gt;</span>true<span class="tag">&lt;/<span class="name">createSourcesJar</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactSet</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>org.mapdb.*<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">artifactSet</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">relocations</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">relocation</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>org.apache.commons.collections<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">shadedPattern</span>&gt;</span>com.yuzhouwan.org.apache.commons.collections<span class="tag">&lt;/<span class="name">shadedPattern</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">relocation</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">relocations</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="实例二"><a href="#实例二" class="headerlink" title="实例二"></a>实例二</h5><p>　除了 org.glassfish.* 路径之外的 <code>javax.ws</code> 包路径，将被重命名为 <code>shade.javax.ws</code>。同时，<code>org.apache.curator</code> 包路径，将被重命名为 <code>shade.org.apache.curator</code>。另外，将 <code>shadedArtifactAttached</code> 参数指定为 true 之后，可以避免子模块中出现找不到 shade 后的新包路径的问题</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-shade-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>${maven.shade.plugin.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>shade<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">shadedArtifactAttached</span>&gt;</span>true<span class="tag">&lt;/<span class="name">shadedArtifactAttached</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">shadedClassifierName</span>&gt;</span>all<span class="tag">&lt;/<span class="name">shadedClassifierName</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">createSourcesJar</span>&gt;</span>true<span class="tag">&lt;/<span class="name">createSourcesJar</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactSet</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!-- 因为 org.glassfish 里面存在类似 public static class Builder implements javax.ws.rs.client.Invocation.Builder 全限定名的写法 --&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!-- 所以只能用 shade 去隐藏 com.sun.jersey --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>org.glassfish.*<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">artifactSet</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">relocations</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">relocation</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>javax.ws<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">shadedPattern</span>&gt;</span>shade.javax.ws<span class="tag">&lt;/<span class="name">shadedPattern</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">relocation</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">relocation</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">shadedPattern</span>&gt;</span>shade.org.apache.curator<span class="tag">&lt;/<span class="name">shadedPattern</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">relocation</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!--&lt;relocation&gt;</span></span><br><span class="line"><span class="comment">                        &lt;pattern&gt;org.glassfish&lt;/pattern&gt;</span></span><br><span class="line"><span class="comment">                        &lt;shadedPattern&gt;shade.org.glassfish&lt;/shadedPattern&gt;</span></span><br><span class="line"><span class="comment">                    &lt;/relocation&gt;</span></span><br><span class="line"><span class="comment">                    &lt;relocation&gt;</span></span><br><span class="line"><span class="comment">                        &lt;pattern&gt;com.sun.jersey&lt;/pattern&gt;</span></span><br><span class="line"><span class="comment">                        &lt;shadedPattern&gt;shade.com.sun.jersey&lt;/shadedPattern&gt;</span></span><br><span class="line"><span class="comment">                    &lt;/relocation&gt;--&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">relocations</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="踩过的坑"><a href="#踩过的坑" class="headerlink" title="踩过的坑"></a>踩过的坑</h4><h5 id="Error-creating-shaded-jar-Error-in-ASM-processing-class"><a href="#Error-creating-shaded-jar-Error-in-ASM-processing-class" class="headerlink" title="Error creating shaded jar: Error in ASM processing class"></a>Error creating shaded jar: Error in ASM processing class</h5><h6 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h6><figure class="highlight"><table><tbody><tr><td class="code"><pre><span class="line">Failed to execute goal org.apache.maven.plugins:maven-shade-plugin:2.1:shade (default) on project base-k2d-flow: Error creating shaded jar: Error in ASM processing class com/yuzhouwan/bigdata/k2d/K2DPartitioner.class: 52264 -&gt; [Help 1]</span><br></pre></td></tr></tbody></table></figure>
<h6 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h6><p>　升级 <code>maven-shade-plugin</code> 版本到 <code>2.4.x</code></p>
<h5 id="通过-Shade-将问题解决后，部署上线后，依赖冲突复现"><a href="#通过-Shade-将问题解决后，部署上线后，依赖冲突复现" class="headerlink" title="通过 Shade 将问题解决后，部署上线后，依赖冲突复现"></a>通过 Shade 将问题解决后，部署上线后，依赖冲突复现</h5><h6 id="解决-1"><a href="#解决-1" class="headerlink" title="解决"></a>解决</h6><p>　因为官方明确指出 <code>java.io.File.listFiles()</code> 方法返回的文件序列顺序，是不做保证的。所以，上线后运行环境发生变化，加载 <code>lib</code> 目录下的 <code>jar 包</code>顺序，可能会发生变化。这时候，就需要利用不同 <code>lib</code> 目录，并修改 classpath 的方式，将 <code>jar 包</code>加载顺序确定下来</p>
<p>　例如，在整合 <a href="https://yuzhouwan.com/posts/5845/">Druid</a> 这类依赖树比较庞大的工程，就遇到了这么一种情况。Druid 中 com.sun.jersey (1.19) 和 Dataflow 中 org.glassfish.jersey (2.25.1) 发生冲突。增加了上述实例二中的 Shade 操作仍然会在线上环境，复现依赖冲突。这时，我们可以通过增加一个 <code>lib_jersey</code> 目录，存放 <code>javax.ws.rs-api-2.1.jar</code>，并修改 classpath 为 <code>lib_jersey/*:lib/*</code>。以此，保证了 <code>lib_jersey</code> 中的依赖得以优先加载，从而解决冲突</p>
<h5 id="报错-Invalid-signature-file-digest-for-Manifest-main-attributes"><a href="#报错-Invalid-signature-file-digest-for-Manifest-main-attributes" class="headerlink" title="报错 Invalid signature file digest for Manifest main attributes"></a>报错 Invalid signature file digest for Manifest main attributes</h5><h6 id="描述-1"><a href="#描述-1" class="headerlink" title="描述"></a>描述</h6><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">java.lang.SecurityException: Invalid signature file digest <span class="keyword">for</span> Manifest main attributes</span><br></pre></td></tr></tbody></table></figure>
<h6 id="解决-2"><a href="#解决-2" class="headerlink" title="解决"></a>解决</h6><figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-shade-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>${maven.shade.plugin.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>shade<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">shadedArtifactAttached</span>&gt;</span>true<span class="tag">&lt;/<span class="name">shadedArtifactAttached</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">createSourcesJar</span>&gt;</span>true<span class="tag">&lt;/<span class="name">createSourcesJar</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">relocations</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">relocation</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>com.google.common<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">shadedPattern</span>&gt;</span>com.yuzhouwan.google.common<span class="tag">&lt;/<span class="name">shadedPattern</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">relocation</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">relocations</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">artifactSet</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">include</span>&gt;</span>org.apache.hadoop:hadoop-common<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">artifactSet</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">filters</span>&gt;</span></span><br><span class="line">                            <span class="comment">&lt;!-- 加上如下的 filter 过滤，可以忽略有问题的 META-INF 目录 --&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">artifact</span>&gt;</span>*:*<span class="tag">&lt;/<span class="name">artifact</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>META-INF/*.SF<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>META-INF/*.DSA<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>META-INF/*.RSA<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">filters</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 之后，也可以通过 zip 命令，将 META-INF 目录下的相关文件，从 jar 包中删除</span></span><br><span class="line">$ zip -d yuzhouwan.jar <span class="string">'META-INF/*.SF'</span> <span class="string">'META-INF/*.DSA'</span> <span class="string">'META-INF/*.RSA'</span></span><br></pre></td></tr></tbody></table></figure>
<div class="note success">如果是某一个第三方依赖导致的版本冲突，则只需要针对这个第三方依赖进行 shade 操作即可。因此，这里的 artifactSet 使用了 includes，而不是 excludes</div>






<h3 id="Assembly-插件"><a href="#Assembly-插件" class="headerlink" title="Assembly 插件"></a>Assembly 插件</h3><h4 id="重命名-jar-包"><a href="#重命名-jar-包" class="headerlink" title="重命名 jar 包"></a>重命名 jar 包</h4><figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">files</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">file</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">source</span>&gt;</span>${project.basedir}/../yuzhouwan-common/target/yuzhouwan-common-${project.version}.jar<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span>lib<span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">destName</span>&gt;</span>ayuzhouwan-common-${project.version}.jar<span class="tag">&lt;/<span class="name">destName</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">file</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">files</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<div class="note success">更名为 a 开头的 jar 包之后，可以确保在 classpath 中能被优先加载起来。如此，项目中对依赖里面类的修改，才会生效</div>



<h4 id="不同模块的依赖，打包到不同的目录下"><a href="#不同模块的依赖，打包到不同的目录下" class="headerlink" title="不同模块的依赖，打包到不同的目录下"></a>不同模块的依赖，打包到不同的目录下</h4><h5 id="具体步骤"><a href="#具体步骤" class="headerlink" title="具体步骤"></a>具体步骤</h5><p>　第一步，先在负责打包分发的 distribution 模块中，设置 pom.xml 文件</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.assembly.plugin.version</span>&gt;</span>2.3<span class="tag">&lt;/<span class="name">maven.assembly.plugin.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.yuzhouwan<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.yuzhouwan<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ai<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.yuzhouwan<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>bigdata<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>${maven.assembly.plugin.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">id</span>&gt;</span>assemble<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>single<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">descriptors</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">descriptor</span>&gt;</span>src/assembly/bin.xml<span class="tag">&lt;/<span class="name">descriptor</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">descriptor</span>&gt;</span>src/assembly/src.xml<span class="tag">&lt;/<span class="name">descriptor</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">descriptors</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">tarLongFileMode</span>&gt;</span>gnu<span class="tag">&lt;/<span class="name">tarLongFileMode</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<p>　第二步，创建好对应的 bin.xml 和 src.xml</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">assembly</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/plugins/maven-assembly-plugin/assembly/1.1.2"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/plugins/maven-assembly-plugin/assembly/1.1.2 http://maven.apache.org/xsd/assembly-1.1.2.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>bin<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">formats</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">format</span>&gt;</span>dir<span class="tag">&lt;/<span class="name">format</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">format</span>&gt;</span>tar.gz<span class="tag">&lt;/<span class="name">format</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">formats</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">baseDirectory</span>&gt;</span>yuzhouwan-${project.version}-bin<span class="tag">&lt;/<span class="name">baseDirectory</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">fileSets</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">fileSet</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">directory</span>&gt;</span>../<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>**/target/**<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>**/.classpath<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>**/.project<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>**/.settings/**<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>lib/**<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>conf/**<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">include</span>&gt;</span>README<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">include</span>&gt;</span>LICENSE<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">include</span>&gt;</span>NOTICE<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">include</span>&gt;</span>CHANGELOG<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">include</span>&gt;</span>RELEASE-NOTES<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">include</span>&gt;</span>conf/<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">fileSet</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">fileSet</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">directory</span>&gt;</span>../<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">include</span>&gt;</span>bin/yuzhouwan-cli.sh<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fileMode</span>&gt;</span>0777<span class="tag">&lt;/<span class="name">fileMode</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">directoryMode</span>&gt;</span>0755<span class="tag">&lt;/<span class="name">directoryMode</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">fileSet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">fileSets</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">moduleSets</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">moduleSet</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">includeSubModules</span>&gt;</span>false<span class="tag">&lt;/<span class="name">includeSubModules</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">useAllReactorProjects</span>&gt;</span>true<span class="tag">&lt;/<span class="name">useAllReactorProjects</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">include</span>&gt;</span>com.yuzhouwan:yuzhouwan-core<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>com.yuzhouwan:ai<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>com.yuzhouwan:bigdata<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">binaries</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span>lib/core<span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">unpack</span>&gt;</span>false<span class="tag">&lt;/<span class="name">unpack</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">dependencySets</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">dependencySet</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">useProjectArtifact</span>&gt;</span>false<span class="tag">&lt;/<span class="name">useProjectArtifact</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">useTransitiveDependencies</span>&gt;</span>true<span class="tag">&lt;/<span class="name">useTransitiveDependencies</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">unpack</span>&gt;</span>false<span class="tag">&lt;/<span class="name">unpack</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>com.yuzhouwan:ai<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>com.yuzhouwan:bigdata<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">dependencySet</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">dependencySets</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">binaries</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">moduleSet</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">moduleSet</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">includeSubModules</span>&gt;</span>false<span class="tag">&lt;/<span class="name">includeSubModules</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">useAllReactorProjects</span>&gt;</span>true<span class="tag">&lt;/<span class="name">useAllReactorProjects</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">include</span>&gt;</span>com.yuzhouwan:ai<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>com.yuzhouwan:bigdata<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">binaries</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span>lib/plugins/ai<span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">unpack</span>&gt;</span>false<span class="tag">&lt;/<span class="name">unpack</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">dependencySets</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">dependencySet</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">useProjectArtifact</span>&gt;</span>false<span class="tag">&lt;/<span class="name">useProjectArtifact</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">useTransitiveDependencies</span>&gt;</span>true<span class="tag">&lt;/<span class="name">useTransitiveDependencies</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">unpack</span>&gt;</span>false<span class="tag">&lt;/<span class="name">unpack</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>com.yuzhouwan:bigdata<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">dependencySet</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">dependencySets</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">binaries</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">moduleSet</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">moduleSet</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">includeSubModules</span>&gt;</span>false<span class="tag">&lt;/<span class="name">includeSubModules</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">useAllReactorProjects</span>&gt;</span>true<span class="tag">&lt;/<span class="name">useAllReactorProjects</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">include</span>&gt;</span>com.yuzhouwan:bigdata<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>com.yuzhouwan:ai<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">binaries</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span>lib/plugins/bigdata<span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">unpack</span>&gt;</span>false<span class="tag">&lt;/<span class="name">unpack</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">dependencySets</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">dependencySet</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">useProjectArtifact</span>&gt;</span>false<span class="tag">&lt;/<span class="name">useProjectArtifact</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">useTransitiveDependencies</span>&gt;</span>true<span class="tag">&lt;/<span class="name">useTransitiveDependencies</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">unpack</span>&gt;</span>false<span class="tag">&lt;/<span class="name">unpack</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>com.yuzhouwan:ai<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">dependencySet</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">dependencySets</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">binaries</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">moduleSet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">moduleSets</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">assembly</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">assembly</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/plugins/maven-assembly-plugin/assembly/1.1.2"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/plugins/maven-assembly-plugin/assembly/1.1.2 http://maven.apache.org/xsd/assembly-1.1.2.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>src<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">formats</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">format</span>&gt;</span>dir<span class="tag">&lt;/<span class="name">format</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">format</span>&gt;</span>tar.gz<span class="tag">&lt;/<span class="name">format</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">formats</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">baseDirectory</span>&gt;</span>yuzhouwan-${project.version}-src<span class="tag">&lt;/<span class="name">baseDirectory</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">fileSets</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">fileSet</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">directory</span>&gt;</span>../<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>**/target/**<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>**/.classpath<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>**/.project<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>**/*.iml<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>**/.settings/**<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>lib/**<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">include</span>&gt;</span>.ci<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">include</span>&gt;</span>.gitignore<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">include</span>&gt;</span>DEVNOTES<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">include</span>&gt;</span>README<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">include</span>&gt;</span>LICENSE<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">include</span>&gt;</span>NOTICE<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">include</span>&gt;</span>CHANGELOG<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">include</span>&gt;</span>RELEASE-NOTES<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">include</span>&gt;</span>bin/**<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">include</span>&gt;</span>conf/**<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">include</span>&gt;</span>native/**<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">include</span>&gt;</span>pom.xml<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">include</span>&gt;</span>dev-conf/**<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">include</span>&gt;</span>yuzhouwan-core/**<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">include</span>&gt;</span>yuzhouwan-ai/**<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">include</span>&gt;</span>yuzhouwan-bigdata/**<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">fileSet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">fileSets</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">assembly</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<p>　构建完成之后，即可看到 <code>yuzhouwan-ai</code> 和 <code>yuzhouwan-bigdata</code> 模块的依赖，分别被打包到了 <code>plugins/ai</code> 和 <code>plugins/bigdata</code> 目录下</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 需要预先安装 tree 命令（yum install tree -y）</span></span><br><span class="line">$ tree</span><br><span class="line">  .</span><br><span class="line">  ├── bin</span><br><span class="line">  │&nbsp;&nbsp; └── yuzhouwan-cli.sh</span><br><span class="line">  └── lib</span><br><span class="line">      ├── core</span><br><span class="line">      └── plugins</span><br><span class="line">          ├── ai</span><br><span class="line">          └── bigdata</span><br></pre></td></tr></tbody></table></figure>
<h5 id="踩过的坑-1"><a href="#踩过的坑-1" class="headerlink" title="踩过的坑"></a>踩过的坑</h5><h6 id="模块间存在版本冲突的-jar-包"><a href="#模块间存在版本冲突的-jar-包" class="headerlink" title="模块间存在版本冲突的 jar 包"></a>模块间存在版本冲突的 jar 包</h6><ul>
<li><p>问题描述</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">Currently, inclusion of module dependencies may produce unpredictable results <span class="keyword">if</span> a version conflict occurs</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>解决</p>
<p>如果上述 <code>yuzhouwan-ai</code> 和 <code>yuzhouwan-bigdata</code> 模块，与 <code>yuzhouwan-common</code> 模块存在版本冲突的 jar 包，则需要将 <code>bin.xml</code> 拆解成 <code>bin-common.xml</code>、<code>bin-ai.xml</code> 和 <code>bin-bigdata.xml</code> 三个 assembly 配置文件，依次进行构建（此时需要将 id 设置成一样的，不然会被构建到不同的目录下）。否则，版本冲突的 jar 包，将只能保留其中一个版本，且具体保留哪个版本是不确定的</p>
</li>
</ul>
<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h3 id="如何使用其他语言编译出来的-Jar"><a href="#如何使用其他语言编译出来的-Jar" class="headerlink" title="如何使用其他语言编译出来的 Jar"></a>如何使用其他语言编译出来的 Jar</h3><h4 id="Clojar"><a href="#Clojar" class="headerlink" title="Clojar"></a>Clojar</h4><p>　如果需要在 Maven 中，添加新的 Repository，这里以 Clojar 为例，配置如下：<br></p><figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>clojars.org<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://clojars.org/repo<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<h3 id="本地缓存"><a href="#本地缓存" class="headerlink" title="本地缓存"></a>本地缓存</h3><p>　Maven 中出现 Repository 被缓存在本地，则可以进一步添加下面属性，以配置更新策略：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">id</span>&gt;</span>clojars.org<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://clojars.org/repo<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">releases</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">updatePolicy</span>&gt;</span>always<span class="tag">&lt;/<span class="name">updatePolicy</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">releases</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">updatePolicy</span>&gt;</span>always<span class="tag">&lt;/<span class="name">updatePolicy</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="下载问题"><a href="#下载问题" class="headerlink" title="下载问题"></a>下载问题</h3><h4 id="已-download，未-import"><a href="#已-download，未-import" class="headerlink" title="已 download，未 import"></a>已 download，未 import</h4><p>　如果发现 <code>pom.xml</code> 中的 依赖虽然在 <code>.m2</code> 中被下载了，但是没有被 <code>import</code> 到项目中<br>　尝试在 Intellij Idea 的 setting 中 找到 <code>Maven -&gt; Ignored Files</code>，看看对应的 <code>pom.xml</code> 有没有被勾选</p>
<div class="note info">如果仍然无法解决，也有可能是 Intellij Idea 自身的问题，可尝试通过 Just Restart 来解决</div>



<h3 id="编译问题"><a href="#编译问题" class="headerlink" title="编译问题"></a>编译问题</h3><h4 id="JDK-版本不一致"><a href="#JDK-版本不一致" class="headerlink" title="JDK 版本不一致"></a>JDK 版本不一致</h4><h5 id="描述-2"><a href="#描述-2" class="headerlink" title="描述"></a>描述</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">Error:java: Compilation failed: internal java compiler error</span><br></pre></td></tr></tbody></table></figure>
<h5 id="解决-3"><a href="#解决-3" class="headerlink" title="解决"></a>解决</h5><p>　调整 compiler 的级别，并在 <code>pom.xml</code> 中添加 build 标签，规定 compiler 的级别</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>elastic-netflow-v5<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.7<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.7<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-release-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="Scala-版本不一致"><a href="#Scala-版本不一致" class="headerlink" title="Scala 版本不一致"></a>Scala 版本不一致</h4><h5 id="描述-3"><a href="#描述-3" class="headerlink" title="描述"></a>描述</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[ERROR] error: error <span class="keyword">while</span> loading &lt;root&gt;, Error accessing D:\.m2\repository\org\apache\curator\curator-client\2.4.0\curator-client-2.4.0.jar</span><br><span class="line">[ERROR] error: scala.reflect.internal.MissingRequirementError: object java.lang.Object <span class="keyword">in</span> compiler mirror not found.</span><br></pre></td></tr></tbody></table></figure>
<h5 id="解决-4"><a href="#解决-4" class="headerlink" title="解决"></a>解决</h5><p>　查看 pom 文件中指定的 Scala 版本，切换到对应的版本，进行编译即可</p>
<h4 id="存在没有下载好的依赖"><a href="#存在没有下载好的依赖" class="headerlink" title="存在没有下载好的依赖"></a>存在没有下载好的依赖</h4><h5 id="描述-4"><a href="#描述-4" class="headerlink" title="描述"></a>描述</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">Error creating properties files <span class="keyword">for</span> forking; nested exception is java.io.IOException: No such file or directory</span><br></pre></td></tr></tbody></table></figure>
<h5 id="解决-5"><a href="#解决-5" class="headerlink" title="解决"></a>解决</h5><p>　安装依赖</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ mvn dependency::tree</span><br></pre></td></tr></tbody></table></figure>
<p>　离线 build (offline)<br></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ mvn install -o</span><br></pre></td></tr></tbody></table></figure><p></p>
<h4 id="本地-mvn-clean-install-到-m2-repository-中的-jar-和-仓库中的不一致时"><a href="#本地-mvn-clean-install-到-m2-repository-中的-jar-和-仓库中的不一致时" class="headerlink" title="本地 mvn clean install 到 .m2/repository 中的 jar 和 仓库中的不一致时"></a>本地 mvn clean install 到 .m2/repository 中的 jar 和 仓库中的不一致时</h4><h5 id="描述-5"><a href="#描述-5" class="headerlink" title="描述"></a>描述</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="string">"Class not found 'xxxx' Empty test suite"</span> <span class="keyword">in</span> java unittest, after change the modules<span class="string">' names</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="解决-6"><a href="#解决-6" class="headerlink" title="解决"></a>解决</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">Maven           -&gt;        Reimport            -&gt;        Generte Source and Update Folder</span><br><span class="line">Ctrl + F9       -&gt;        Make Project</span><br></pre></td></tr></tbody></table></figure>
<h4 id="打包存在脏程序"><a href="#打包存在脏程序" class="headerlink" title="打包存在脏程序"></a>打包存在脏程序</h4><p>　<code>war:war</code> 之前需要先执行 <code>mvn clean install</code>。否则，会因为 <code>profiles</code> 的缘故，导致 <code>war</code> 包中 缺少文件</p>
<h3 id="语法问题"><a href="#语法问题" class="headerlink" title="语法问题"></a>语法问题</h3><h4 id="Maven-中无法识别-project-version"><a href="#Maven-中无法识别-project-version" class="headerlink" title="Maven 中无法识别 ${project.version}"></a>Maven 中无法识别 ${project.version}</h4><p>　需要将所有（除了 root / parent 模块）的 <code>&lt;version&gt;1.0&lt;/version&gt;</code> 中的具体版本号（如 <code>1.0.0</code>）全部替换成 <code>"${project.version}"</code></p>
<h3 id="插件问题"><a href="#插件问题" class="headerlink" title="插件问题"></a>插件问题</h3><h4 id="xxx-module-must-not-contain-source-root-the-root-already-belongs-to-module-xxx"><a href="#xxx-module-must-not-contain-source-root-the-root-already-belongs-to-module-xxx" class="headerlink" title="xxx module must not contain source root. the root already belongs to module xxx"></a>xxx module must not contain source root. the root already belongs to module xxx</h4><h5 id="解决-7"><a href="#解决-7" class="headerlink" title="解决"></a>解决</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">Artifacts Setting  -&gt;  Modules -&gt; Sourc tab</span><br><span class="line">delete the fold by clicking on the X icon to the right of it</span><br></pre></td></tr></tbody></table></figure>
<h4 id="ExecutionException-The-forked-VM-terminated-without-properly-saying-goodbye"><a href="#ExecutionException-The-forked-VM-terminated-without-properly-saying-goodbye" class="headerlink" title="ExecutionException The forked VM terminated without properly saying goodbye"></a>ExecutionException The forked VM terminated without properly saying goodbye</h4><h5 id="描述-6"><a href="#描述-6" class="headerlink" title="描述"></a>描述</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[ERROR] Failed to execute goal org.apache.maven.plugins:maven-surefire-plugin:2.19.1:<span class="built_in">test</span> (default-test) on project eagle-app-streamproxy: ExecutionException The forked VM terminated without properly saying goodbye. VM crash or System.exit called?</span><br></pre></td></tr></tbody></table></figure>
<h5 id="解决-8"><a href="#解决-8" class="headerlink" title="解决"></a>解决</h5><figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-surefire-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>${maven-surefire.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 增加 argLine 参数以调整 JVM --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">argLine</span>&gt;</span>-Xmx2048m -Xms1024m -XX:MaxPermSize=512m -XX:-UseGCOverheadLimit<span class="tag">&lt;/<span class="name">argLine</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">forkMode</span>&gt;</span>always<span class="tag">&lt;/<span class="name">forkMode</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<p>详见：<a href="https://github.com/apache/eagle/pull/897">Eagle-RP-897</a></p>
<h4 id="Fatal-error-compiling-无效的目标发行版-1-8"><a href="#Fatal-error-compiling-无效的目标发行版-1-8" class="headerlink" title="Fatal error compiling: 无效的目标发行版: 1.8"></a>Fatal error compiling: 无效的目标发行版: 1.8</h4><p>　需要在 IDE 的 <code>Project Structure(Ctrl+Alt+Shift+S)</code> 里设置 <code>Project JDK</code> 为 <code>jdk1.8</code>，并在 <code>Settings(Ctrl+Alt+S)</code> 里设置 <code>Java Compiler</code> 的 <code>bytecode version</code> 为 <code>1.8</code></p>
<h4 id="Assembly-插件报错-java-lang-StackOverflowError"><a href="#Assembly-插件报错-java-lang-StackOverflowError" class="headerlink" title="Assembly 插件报错 java.lang.StackOverflowError"></a>Assembly 插件报错 java.lang.StackOverflowError</h4><h5 id="解决-9"><a href="#解决-9" class="headerlink" title="解决"></a>解决</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 调大默认的堆栈大小</span></span><br><span class="line"><span class="built_in">export</span> MAVEN_OPTS=-Xss2m</span><br></pre></td></tr></tbody></table></figure>
<h5 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">-Xms：jvm 进程启动时分配的内存</span><br><span class="line">-Xmx：jvm 进程运行过程中最大能分配到的内存</span><br><span class="line">-Xss：jvm 进程中启动线程，为每个线程分配的内存大小</span><br></pre></td></tr></tbody></table></figure>
<h4 id="protobuf-maven-plugin-找不到-protoc-运行程序"><a href="#protobuf-maven-plugin-找不到-protoc-运行程序" class="headerlink" title="protobuf-maven-plugin 找不到 protoc 运行程序"></a>protobuf-maven-plugin 找不到 protoc 运行程序</h4><h5 id="解决-10"><a href="#解决-10" class="headerlink" title="解决"></a>解决</h5><p>　本地安装 Protobuf 即可</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gcc --version</span><br><span class="line">  Configured with: --prefix=/Library/Developer/CommandLineTools/usr --with-gxx-include-dir=/Library/Developer/CommandLineTools/SDKs/MacOSX10.14.sdk/usr/include/c++/4.2.1</span><br><span class="line">  Apple LLVM version 10.0.1 (clang-1001.0.46.4)</span><br><span class="line">  Target: x86_64-apple-darwin18.7.0</span><br><span class="line">  Thread model: posix</span><br><span class="line">  InstalledDir: /Library/Developer/CommandLineTools/usr/bin</span><br><span class="line"></span><br><span class="line">$ brew install autoconf automake libtool curl</span><br><span class="line">$ wget https://github.com/google/protobuf/releases/download/v2.5.0/protobuf-2.5.0.tar.gz</span><br><span class="line">$ tar zxvf protobuf-2.5.0.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> protobuf-2.5.0</span><br><span class="line">$ ./autogen.sh</span><br><span class="line">$ ./configure</span><br><span class="line">$ make</span><br><span class="line">$ make check</span><br><span class="line">$ make install</span><br><span class="line">$ protoc --version</span><br><span class="line">  libprotoc 2.5.0</span><br></pre></td></tr></tbody></table></figure>
<h4 id="如何跳过-gpg-插件"><a href="#如何跳过-gpg-插件" class="headerlink" title="如何跳过 gpg 插件"></a>如何跳过 gpg 插件</h4><p>　增加 <code>&lt;skip&gt;true&lt;/skip&gt;</code> 配置即可</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-gpg-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>sign-artifacts<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>verify<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>sign<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">skip</span>&gt;</span>true<span class="tag">&lt;/<span class="name">skip</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="Permission-denied-of-shell-script"><a href="#Permission-denied-of-shell-script" class="headerlink" title="Permission denied of shell script"></a>Permission denied of shell script</h4><h5 id="解决-11"><a href="#解决-11" class="headerlink" title="解决"></a>解决</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 修改 exec-maven-plugin 中需要用到脚本即可</span></span><br><span class="line">$ chmod +x yuzhouwan.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 还可以通过以下命令，修改已经上传的文件权限</span></span><br><span class="line">$ git update-index --chmod=+x yuzhouwan.sh</span><br></pre></td></tr></tbody></table></figure>
<h3 id="依赖问题"><a href="#依赖问题" class="headerlink" title="依赖问题"></a>依赖问题</h3><h4 id="Maven-中央仓库找不到对应版本的依赖"><a href="#Maven-中央仓库找不到对应版本的依赖" class="headerlink" title="Maven 中央仓库找不到对应版本的依赖"></a>Maven 中央仓库找不到对应版本的依赖</h4><h5 id="如何将其他项目的-jar-安装到-maven-仓库中"><a href="#如何将其他项目的-jar-安装到-maven-仓库中" class="headerlink" title="如何将其他项目的 jar 安装到 maven 仓库中"></a>如何将其他项目的 jar 安装到 maven 仓库中</h5><h6 id="利用命令安装"><a href="#利用命令安装" class="headerlink" title="利用命令安装"></a>利用命令安装</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ mvn install:install-file -Dfile=&lt;jar 包的位置&gt; -DgroupId=&lt;上面的 groupId&gt; -DartifactId=&lt;上面的 artifactId&gt; -Dversion=&lt;上面的 version&gt; -Dpackaging=jar -DgeneratePom=<span class="literal">true</span> -DpomFile=&lt;指定一个 pom.xml 添加进去&gt;</span><br><span class="line"></span><br><span class="line">$ mvn install:install-file -Dfile=G:\ES\yuzhouwan_netflow-rest\lib\ite-esmanage-0.7.2-SNAPSHOT.jar -DgroupId=ite -DartifactId=esmanage -Dversion=0.7.2-SNAPSHOT -Dpackaging=jar -DgeneratePom=<span class="literal">true</span> -DpomFile=C:\yuzhouwan\Maven\pom.xml</span><br><span class="line"></span><br><span class="line"><span class="comment"># -DgeneratePom 没有成功</span></span><br><span class="line"><span class="comment"># 原因是 这个第三方的 jar 中，pom.xml 路径不对，必须手动 copy 出来，并用 -DpomFile 的方式导入</span></span><br></pre></td></tr></tbody></table></figure>
<h6 id="利用插件安装"><a href="#利用插件安装" class="headerlink" title="利用插件安装"></a>利用插件安装</h6><figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 注意：${project.basedir} 是当前模块的根目录，需要把依赖包，放对位置 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">pluginManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-install-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>install-external<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>clean<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">file</span>&gt;</span>${project.basedir}/lib/flume-hdfs-sink-${flume.version}.jar<span class="tag">&lt;/<span class="name">file</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">repositoryLayout</span>&gt;</span>default<span class="tag">&lt;/<span class="name">repositoryLayout</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flume.flume-ng-sinks<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flume-hdfs-sink<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">version</span>&gt;</span>${flume.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">generatePom</span>&gt;</span>true<span class="tag">&lt;/<span class="name">generatePom</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">goal</span>&gt;</span>install-file<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">pluginManagement</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="控制-Scope-范围"><a href="#控制-Scope-范围" class="headerlink" title="控制 Scope 范围"></a>控制 Scope 范围</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># compile（编译范围）</span></span><br><span class="line">　compile 范围是默认的。编译范围依赖在所有的 classpath 中可用，同时它们也会被打包</span><br><span class="line"></span><br><span class="line"><span class="comment"># provided（已提供范围）</span></span><br><span class="line">　provided 范围只有在当 JDK 或者一个容器已提供该依赖之后才使用。它们不是传递性的，也不会被打包。适用于在实现了公共 common 模块，其中有很多依赖，但是只有在其他依赖了 common 模块的子模块中，重新声明依赖，才会真正被打包到子模块中。这样，既可以保证 common 模块的正常编译，又可以减少子模块中的依赖包大小</span><br><span class="line"></span><br><span class="line"><span class="comment"># runtime（运行时范围）</span></span><br><span class="line">　runtime 范围在运行和测试系统的时候需要，但在编译的时候不需要。例如，在编译的时候，如果只需要 JDBC API Jar，但只有在运行的时候才需要 JDBC 驱动的具体实现</span><br><span class="line"></span><br><span class="line"><span class="comment"># test（测试范围）</span></span><br><span class="line">　<span class="built_in">test</span> 范围在一般的编译和运行时都不需要，它们只有在测试编译和测试运行阶段可用。常用于 JUnit 的依赖</span><br><span class="line"></span><br><span class="line"><span class="comment"># system（系统范围）</span></span><br><span class="line">　system 范围与 provided 类似，但是必须显式的提供一个对于本地系统中 Jar 文件的路径。这么做是为了允许基于本地对象编译（systemPath），而这些对象是系统类库的一部分。这样的构件应该是一直可用的，Maven 也不会在仓库中去寻找它（不推荐使用）</span><br></pre></td></tr></tbody></table></figure>
<h4 id="引入某一个本身依赖树很庞大的-Dependency"><a href="#引入某一个本身依赖树很庞大的-Dependency" class="headerlink" title="引入某一个本身依赖树很庞大的 Dependency"></a>引入某一个本身依赖树很庞大的 Dependency</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 依赖列表</span></span><br><span class="line">$ mvn dependency:list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 依赖树（这里推荐直接用 Intellij Idea 中自带的 "Show Dependencies" 功能，可视化地展示依赖树 和 对应依赖冲突，并能够直接对 依赖树进行修剪）</span></span><br><span class="line">$ mvn dependency:tree</span><br><span class="line"></span><br><span class="line"><span class="comment"># 依赖分析</span></span><br><span class="line">$ mvn dependency:analyze</span><br><span class="line">  Unused declared dependencies  表示项目中未使用的，但显示声明的依赖</span><br><span class="line">  Used undeclared dependencies  表示项目中使用到的，但是没有显示声明的依赖</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Detected-both-log4j-over-slf4j-jar-AND-slf4j-log4j12-jar-on-the-class-path-preempting-StackOverflowError"><a href="#Detected-both-log4j-over-slf4j-jar-AND-slf4j-log4j12-jar-on-the-class-path-preempting-StackOverflowError" class="headerlink" title="Detected both log4j-over-slf4j.jar AND slf4j-log4j12.jar on the class path, preempting StackOverflowError."></a>Detected both log4j-over-slf4j.jar AND slf4j-log4j12.jar on the class path, preempting StackOverflowError.</h4><h5 id="解决-12"><a href="#解决-12" class="headerlink" title="解决"></a>解决</h5><figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">spark.scala.version</span>&gt;</span>2.11<span class="tag">&lt;/<span class="name">spark.scala.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">apache.kafka.version</span>&gt;</span>0.9.0.1<span class="tag">&lt;/<span class="name">apache.kafka.version</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.kafka<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kafka_${spark.scala.version}<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>${apache.kafka.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-log4j12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="Could-not-find-artifact-jdk-tools-jdk-tools-jar-1-7-at-specified-path-Library-Java-JavaVirtualMachines-jdk-12-0-2-jdk-Contents-Home-lib-tools-jar"><a href="#Could-not-find-artifact-jdk-tools-jdk-tools-jar-1-7-at-specified-path-Library-Java-JavaVirtualMachines-jdk-12-0-2-jdk-Contents-Home-lib-tools-jar" class="headerlink" title="Could not find artifact jdk.tools:jdk.tools:jar:1.7 at specified path /Library/Java/JavaVirtualMachines/jdk-12.0.2.jdk/Contents/Home/../lib/tools.jar"></a>Could not find artifact jdk.tools:jdk.tools:jar:1.7 at specified path /Library/Java/JavaVirtualMachines/jdk-12.0.2.jdk/Contents/Home/../lib/tools.jar</h4><h5 id="描述-7"><a href="#描述-7" class="headerlink" title="描述"></a>描述</h5><p>　Hive 中存在 jdk.tools 依赖，需要特定的 JDK 版本</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hive<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hive-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="解决-13"><a href="#解决-13" class="headerlink" title="解决"></a>解决</h5><p>　通过 exclusion 标签将 jdk.tools 去除掉即可。如果仍然需要 jdk.tools 依赖，则可以另外单独增加 jdk.tools 的 dependency，并指定好正确的 JDK 版本</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hive<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hive-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jdk.tools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>jdk.tools<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>jdk.tools<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jdk.tools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt=""></a></td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>Maven</tag>
        <tag>Java</tag>
        <tag>Scala</tag>
        <tag>Clojure</tag>
        <tag>Apache Avro</tag>
      </tags>
  </entry>
  <entry>
    <title>Python：从入门到实践</title>
    <url>/posts/43687/</url>
    <content><![CDATA[<h2 id="什么是-Python"><a href="#什么是-Python" class="headerlink" title="什么是 Python?"></a>什么是 Python?</h2><p>　<strong>Python</strong> is a programming language that lets you work <strong>quickly</strong> and integrate systems more <strong>effectively</strong>.</p>
<p><img data-src="/picture/python/python_and_mouse.jpg" alt="Python and Mouse"></p>
<center>（图片来源：<a href="http://www.mac-smith.com/" target="_blank">Mac Smith</a> 的个人作品，已获得授权）</center>



<h2 id="为什么要有-Python"><a href="#为什么要有-Python" class="headerlink" title="为什么要有 Python?"></a>为什么要有 Python?</h2><h3 id="胶水语言"><a href="#胶水语言" class="headerlink" title="胶水语言"></a>胶水语言</h3><p>　胶水语言，能够把用其他语言制作的各种模块（尤其是 <code>C</code>/<code>C++</code>）很轻松地联结在一起</p>
<h3 id="脚本语言"><a href="#脚本语言" class="headerlink" title="脚本语言"></a>脚本语言</h3><p>　ABC 语言的一种继承</p>
<p>　缩短传统的 <code>编写</code> - <code>编译</code> - <code>链接</code> - <code>运行</code>（<code>edit</code>-<code>compile</code>-<code>link</code>-<code>run</code>）过程</p>
<a id="more"></a>
<h2 id="环境部署"><a href="#环境部署" class="headerlink" title="环境部署"></a>环境部署</h2><h3 id="Python-安装"><a href="#Python-安装" class="headerlink" title="Python 安装"></a>Python 安装</h3><h4 id="Linux-基础环境"><a href="#Linux-基础环境" class="headerlink" title="Linux 基础环境"></a>Linux 基础环境</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ sudo yum install gcc libffi-devel python-devel python-pip python-wheel openssl-devel libsasl2-devel openldap-devel -y</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Python-编译安装"><a href="#Python-编译安装" class="headerlink" title="Python 编译安装"></a>Python 编译安装</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 在 python ftp 服务器中下载到 对应版本的 python</span></span><br><span class="line">$ wget https://www.python.org/ftp/python/3.6.8/Python-3.6.8.tgz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译</span></span><br><span class="line">$ tar -zxvf Python-3.6.8.tgz</span><br><span class="line">$ <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/Python-3.6.8</span><br><span class="line">$ ./configure --prefix=/usr/<span class="built_in">local</span>/python36</span><br><span class="line">$ make</span><br><span class="line">$ make install</span><br><span class="line"></span><br><span class="line">$ ls /usr/<span class="built_in">local</span>/python36/ -al</span><br><span class="line">  total 24</span><br><span class="line">  drwxr-xr-x 6 root root 4096 Jan 30 11:10 .</span><br><span class="line">  drwxr-xr-x 1 root root 4096 Jan 30 11:09 ..</span><br><span class="line">  drwxr-xr-x 2 root root 4096 Jan 30 11:10 bin</span><br><span class="line">  drwxr-xr-x 3 root root 4096 Jan 30 11:10 include</span><br><span class="line">  drwxr-xr-x 4 root root 4096 Jan 30 11:10 lib</span><br><span class="line">  drwxr-xr-x 3 root root 4096 Jan 30 11:10 share</span><br></pre></td></tr></tbody></table></figure>
<h4 id="覆盖旧版-Python"><a href="#覆盖旧版-Python" class="headerlink" title="覆盖旧版 Python"></a>覆盖旧版 Python</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 覆盖原来的 python6</span></span><br><span class="line">$ <span class="built_in">which</span> python</span><br><span class="line">  /usr/bin/python</span><br><span class="line">$ /usr/<span class="built_in">local</span>/python36/bin/python3.6 -V</span><br><span class="line">  Python 3.6.8</span><br><span class="line">$ mv /usr/bin/python /usr/bin/python_old</span><br><span class="line">$ ln -s /usr/<span class="built_in">local</span>/python36/bin/python3.6 /usr/bin/python</span><br><span class="line">$ python -V</span><br><span class="line">  Python 3.6.8</span><br></pre></td></tr></tbody></table></figure>
<h4 id="恢复-yum-中旧版-Python-的引用"><a href="#恢复-yum-中旧版-Python-的引用" class="headerlink" title="恢复 yum 中旧版 Python 的引用"></a>恢复 yum 中旧版 Python 的引用</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 修改 yum 引用的 python 版本为旧版 2.6 的 python</span></span><br><span class="line">$ vim /usr/bin/yum</span><br><span class="line">  <span class="comment"># 第一行修改为 python2.6</span></span><br><span class="line">  <span class="comment">#!/usr/bin/python2.6</span></span><br><span class="line"></span><br><span class="line">$ yum --version | sed <span class="string">'2,$d'</span></span><br><span class="line">  3.2.29</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Pip"><a href="#Pip" class="headerlink" title="Pip"></a>Pip</h3><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><h5 id="在线"><a href="#在线" class="headerlink" title="在线"></a>在线</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ pip --version</span><br><span class="line">  pip 9.0.1 from /usr/<span class="built_in">local</span>/lib/python2.7/site-packages (python 2.7)</span><br><span class="line"></span><br><span class="line"><span class="comment"># upgrade setup tools and pip</span></span><br><span class="line">$ pip install --upgrade setuptools pip</span><br></pre></td></tr></tbody></table></figure>
<h5 id="离线"><a href="#离线" class="headerlink" title="离线"></a>离线</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># https://pypi.org/project/setuptools/#files 下载 setuptools-40.7.1.zip</span></span><br><span class="line">$ unzip setuptools-40.7.1.zip</span><br><span class="line">$ <span class="built_in">cd</span> setuptools-40.7.1</span><br><span class="line">$ python setup.py install</span><br><span class="line"></span><br><span class="line"><span class="comment"># https://pypi.org/project/pip/#files 下载 pip-19.0.1.tar.gz</span></span><br><span class="line">$ tar zxvf pip-19.0.1.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> pip-19.0.1</span><br><span class="line">$ python setup.py install</span><br><span class="line"></span><br><span class="line">$ python -m pip -V</span><br><span class="line">  pip 18.1 from /usr/<span class="built_in">local</span>/python36/lib/python3.6/site-packages/pip (python 3.6)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 环境变量</span></span><br><span class="line">$ vim ~/.bashrc</span><br><span class="line">  <span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/usr/<span class="built_in">local</span>/python36/bin</span><br><span class="line">$ <span class="built_in">source</span> ~/.bashrc</span><br><span class="line">$ pip -V</span><br><span class="line">  pip 19.0.1 from /usr/<span class="built_in">local</span>/python36/lib/python3.6/site-packages/pip-19.0.1-py3.6.egg/pip (python 3.6)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="VirtualEnv"><a href="#VirtualEnv" class="headerlink" title="VirtualEnv"></a>VirtualEnv</h3><p>　这里我们以 Apache Superset 为例，更多相关内容，详见我的另一篇博客《<a href="https://yuzhouwan.com/posts/743/">Apache Superset 二次开发</a>》</p>
<h4 id="解压安装"><a href="#解压安装" class="headerlink" title="解压安装"></a>解压安装</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ pip install virtualenv</span><br><span class="line"></span><br><span class="line"><span class="comment"># virtualenv is shipped in Python 3 as pyvenv</span></span><br><span class="line">$ virtualenv venv</span><br><span class="line">$ <span class="built_in">source</span> venv/bin/activate</span><br><span class="line"><span class="comment"># 如果希望 virtualEnv 的隔离环境，能够访问系统全局的 site-packages 目录，可以增加 `--system-site-packages` 参数</span></span><br><span class="line"><span class="comment"># virtualenv -p /usr/local/bin/python --system-site-packages venv</span></span><br><span class="line"><span class="comment"># 另外，如果考虑到便于拷贝，使得 virtualEnv 中依赖的文件，都是复制进来的，而非软链接，则增加 `--always-copy` 参数</span></span><br><span class="line"><span class="comment"># virtualenv -p /usr/local/bin/python --always-copy venv</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 【Offline环境】安装 virtualenv</span></span><br><span class="line"><span class="comment"># 在 https://pypi.python.org/pypi/virtualenv#downloads 页面，下载 virtualenv-15.1.0.tar.gz</span></span><br><span class="line">$ tar zxvf virtualenv-15.1.0.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> virtualenv-15.1.0</span><br><span class="line">$ python setup.py install</span><br><span class="line"></span><br><span class="line">$ virtualenv --version</span><br><span class="line">  15.1.0</span><br></pre></td></tr></tbody></table></figure>
<h4 id="部署上线"><a href="#部署上线" class="headerlink" title="部署上线"></a>部署上线</h4><h5 id="拷贝"><a href="#拷贝" class="headerlink" title="拷贝"></a>拷贝</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># rsync 替换 scp 可以确保软链接 也能被 cp</span></span><br><span class="line">$ rsync -avuz -e ssh /home/superset/superset-0.15.4/ yuzhouwan@middle:/home/yuzhouwan/superset-0.15.4</span><br><span class="line"></span><br><span class="line">  //...</span><br><span class="line">  sent 142935894 bytes  received 180102 bytes  3920986.19 bytes/sec</span><br><span class="line">  total size is 359739823  speedup is 2.51</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 本机 和 目标机器 的 Superset 目录下，校验文件数量</span></span><br><span class="line">$ find | wc -l</span><br><span class="line">  10113</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重复以上步骤，从跳板机 rsync 到线上机器</span></span><br><span class="line">$ rsync -avuz -e ssh /home/yuzhouwan/superset-0.15.4/ root@192.168.2.10:/home/superset/superset-0.15.4</span><br><span class="line"></span><br><span class="line"><span class="comment"># virtualenv 创建依赖的 python</span></span><br><span class="line">$ rsync -avuz -e ssh /root/software yuzhouwan@middle:/home/yuzhouwan</span><br><span class="line">$ rsync -avuz -e ssh /home/yuzhouwan/software root@druid-prd01:/root</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> /root/software</span><br><span class="line">$ tar zxvf Python-2.7.12.tgz</span><br><span class="line">$ <span class="built_in">cd</span> Python-2.7.12</span><br><span class="line"></span><br><span class="line">$ ./configure --prefix=/usr --<span class="built_in">enable</span>-shared CFLAGS=-fPIC</span><br><span class="line">$ make &amp;&amp; make install</span><br><span class="line">$ /sbin/ldconfig -v | grep /      <span class="comment"># nessnary!!</span></span><br><span class="line">$ python -V</span><br><span class="line">  Python 2.7.12</span><br></pre></td></tr></tbody></table></figure>
<h5 id="动态链接库"><a href="#动态链接库" class="headerlink" title="动态链接库"></a>动态链接库</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 虽然软链接已经 rsync 过来了，但是 目标机器相关目录下，没有对应的 python 的动态链接库</span></span><br><span class="line">$ file /root/superset/lib/python2.7/lib-dynload</span><br><span class="line"></span><br><span class="line">  /root/superset/lib/python2.7/lib-dynload: broken symbolic link to `/usr/<span class="built_in">local</span>/python27/lib/python2.7/lib-dynload`</span><br><span class="line"></span><br><span class="line"><span class="comment"># 需要和联网环境中，创建 virtualenv 时的 python 全局环境一致</span></span><br><span class="line">$ ./configure --prefix=/usr/<span class="built_in">local</span>/python27 --<span class="built_in">enable</span>-shared CFLAGS=-fPIC</span><br><span class="line">$ make &amp;&amp; make install</span><br><span class="line">$ /sbin/ldconfig -v | grep /</span><br><span class="line"></span><br><span class="line">$ ls /usr/<span class="built_in">local</span>/python27/lib/python2.7/lib-dynload -sail</span><br></pre></td></tr></tbody></table></figure>
<h4 id="VirtualEnvWrapper"><a href="#VirtualEnvWrapper" class="headerlink" title="VirtualEnvWrapper"></a>VirtualEnvWrapper</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># VirtualEnv Wrapper 是 virtualenv 的扩展工具，可以方便的创建、删除、复制、切换不同的虚拟环境</span></span><br><span class="line">$ pip install virtualenvwrapper</span><br><span class="line">$ mkdir ~/workspaces</span><br><span class="line">$ vim ~/.bashrc</span><br><span class="line">  <span class="comment"># 增加</span></span><br><span class="line">  <span class="built_in">export</span> WORKON_HOME=~/virtualenv</span><br><span class="line">  <span class="built_in">source</span> /usr/<span class="built_in">local</span>/bin/virtualenvwrapper.sh</span><br><span class="line"></span><br><span class="line">$ mkvirtualenv --python=/usr/bin/python superset</span><br><span class="line">  Running virtualenv with interpreter /usr/bin/python</span><br><span class="line">  New python executable <span class="keyword">in</span> /root/virtualenv/superset/bin/python</span><br><span class="line">  Installing setuptools, pip, wheel...done.</span><br><span class="line">  virtualenvwrapper.user_scripts creating /root/virtualenv/superset/bin/predeactivate</span><br><span class="line">  virtualenvwrapper.user_scripts creating /root/virtualenv/superset/bin/postdeactivate</span><br><span class="line">  virtualenvwrapper.user_scripts creating /root/virtualenv/superset/bin/preactivate</span><br><span class="line">  virtualenvwrapper.user_scripts creating /root/virtualenv/superset/bin/postactivate</span><br><span class="line">  virtualenvwrapper.user_scripts creating /root/virtualenv/superset/bin/get_env_details</span><br><span class="line">(superset) [root@superset01 virtualenv]<span class="comment"># deactivate</span></span><br><span class="line"></span><br><span class="line">$ workon superset</span><br><span class="line">(superset) [root@superset01 virtualenv]<span class="comment"># lsvirtualenv -b</span></span><br><span class="line">  superset</span><br></pre></td></tr></tbody></table></figure>
<h2 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h2><h3 id="基本数据类型"><a href="#基本数据类型" class="headerlink" title="基本数据类型"></a>基本数据类型</h3><h4 id="int"><a href="#int" class="headerlink" title="int"></a>int</h4><h5 id="int-类型的最大值"><a href="#int-类型的最大值" class="headerlink" title="int 类型的最大值"></a>int 类型的最大值</h5><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> sys</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sys.maxsize</span><br><span class="line">  <span class="number">9223372036854775807</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 该值取决于你的操作系统位数</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>pow(<span class="number">2</span>, <span class="number">63</span>) - <span class="number">1</span></span><br><span class="line">  <span class="number">9223372036854775807</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">1</span> &lt;&lt; <span class="number">64</span> - <span class="number">1</span></span><br><span class="line">  <span class="number">9223372036854775808</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="float"><a href="#float" class="headerlink" title="float"></a>float</h4><h5 id="inf-无穷大"><a href="#inf-无穷大" class="headerlink" title="inf 无穷大"></a><a href="http://python3-cookbook.readthedocs.io/zh_CN/latest/c03/p07_infinity_and_nan.html">inf</a> 无穷大</h5><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>float(<span class="string">'inf'</span>)</span><br><span class="line">  inf</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>float(<span class="string">'Inf'</span>)</span><br><span class="line">  inf</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>float(<span class="string">'inf'</span>) &gt; <span class="number">0</span></span><br><span class="line">  <span class="literal">True</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>float(<span class="string">'inf'</span>) &lt; <span class="number">0</span></span><br><span class="line">  <span class="literal">False</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>float(<span class="string">'inf'</span>) &gt; <span class="number">9999999999</span></span><br><span class="line">  <span class="literal">True</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>float(<span class="string">'inf'</span>) &gt; <span class="number">9999999999999999999999</span></span><br><span class="line">  <span class="literal">True</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>float(<span class="string">'-inf'</span>) &lt; <span class="number">-9999999999999999999999</span></span><br><span class="line">  <span class="literal">True</span></span><br><span class="line"><span class="comment"># inf、Inf、INF 都是可以表示无穷大的（infinity），这里没有大小写的规定</span></span><br><span class="line"><span class="comment"># inf 表示正无穷，而 -inf 表示为负无穷</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>float(<span class="string">'Inf'</span>) == float(<span class="string">'inf'</span>) == -float(<span class="string">'-inf'</span>) == -float(<span class="string">'-Inf'</span>)</span><br><span class="line">  <span class="literal">True</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="string"><a href="#string" class="headerlink" title="string"></a><a href="https://docs.python.org/3/library/string.html">string</a></h4><h5 id="split"><a href="#split" class="headerlink" title="split"></a>split</h5><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">'a b c'</span>.split(<span class="string">' '</span>)</span><br><span class="line">  [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">'a b c'</span>.split(<span class="string">' '</span>, <span class="number">1</span>)</span><br><span class="line">  [<span class="string">'a'</span>, <span class="string">'b c'</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">'a b c'</span>.split(<span class="string">' '</span>, <span class="number">2</span>)</span><br><span class="line">  [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>]</span><br></pre></td></tr></tbody></table></figure>
<h5 id="类型转换"><a href="#类型转换" class="headerlink" title="类型转换"></a>类型转换</h5><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>int(<span class="number">1</span>)</span><br><span class="line">  <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>float(<span class="number">1.0</span>)</span><br><span class="line">  <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">b"yuzhouwan.com"</span>.decode(<span class="string">"utf-8"</span>)</span><br><span class="line">  <span class="string">u'yuzhouwan.com'</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="占位符"><a href="#占位符" class="headerlink" title="占位符"></a>占位符</h5><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">"speed: %skm/h"</span> % <span class="number">16.8</span></span><br><span class="line">  <span class="string">'speed: 16.8km/h'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">"(%s, %s)"</span> % (<span class="string">"percent"</span>, <span class="number">99.97</span>)</span><br><span class="line">  <span class="string">'(percent, 99.97)'</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="遍历字符"><a href="#遍历字符" class="headerlink" title="遍历字符"></a>遍历字符</h5><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> i, c <span class="keyword">in</span> enumerate(<span class="string">'yuzhouwan.com'</span>):</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">print</span> i, c</span><br><span class="line">...</span><br><span class="line">  <span class="number">0</span> y</span><br><span class="line">  <span class="number">1</span> u</span><br><span class="line">  <span class="number">2</span> z</span><br><span class="line">  <span class="number">3</span> h</span><br><span class="line">  <span class="number">4</span> o</span><br><span class="line">  <span class="number">5</span> u</span><br><span class="line">  <span class="number">6</span> w</span><br><span class="line">  <span class="number">7</span> a</span><br><span class="line">  <span class="number">8</span> n</span><br><span class="line">  <span class="number">9</span> .</span><br><span class="line">  <span class="number">10</span> c</span><br><span class="line">  <span class="number">11</span> o</span><br><span class="line">  <span class="number">12</span> m</span><br></pre></td></tr></tbody></table></figure>
<h3 id="打印"><a href="#打印" class="headerlink" title="打印"></a>打印</h3><h4 id="不换行"><a href="#不换行" class="headerlink" title="不换行"></a>不换行</h4><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(<span class="string">"[]"</span>, end=<span class="string">""</span>)</span><br><span class="line">[]&gt;&gt;&gt;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="OS"><a href="#OS" class="headerlink" title="OS"></a><a href="https://docs.python.org/3/library/os.html">OS</a></h3><h4 id="操作系统相关"><a href="#操作系统相关" class="headerlink" title="操作系统相关"></a>操作系统相关</h4><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 获取操作系统特定的路径分割符（Windows: '\\'；Linux/Unix: '/'）</span></span><br><span class="line">os.sep</span><br><span class="line"><span class="comment"># 字符串表示正在使用的平台（Windows: 'nt'；Linux/Unix: 'posix'）</span></span><br><span class="line">os.name</span><br><span class="line"><span class="comment"># 字符串给出当前平台使用的行终止符（Windows: '\r\n'；Linux: '\n'；Mac: '\r'）</span></span><br><span class="line">os.linesep</span><br><span class="line"><span class="comment"># 函数用来运行 shell 命令</span></span><br><span class="line">os.system(shell)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获得当前工作目录</span></span><br><span class="line">os.getcwd()</span><br><span class="line"><span class="comment"># 获取 / 设置 环境变量</span></span><br><span class="line">os.getenv(key) / os.putenv(key, value)</span><br><span class="line"><span class="comment"># 获得当前进程的 PID</span></span><br><span class="line">os.getpid()</span><br></pre></td></tr></tbody></table></figure>
<h4 id="获取文件-路径信息"><a href="#获取文件-路径信息" class="headerlink" title="获取文件/路径信息"></a>获取文件/路径信息</h4><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 返回指定目录下的所有文件和目录名，v3.5 之后被替换为 scandir</span></span><br><span class="line">os.listdir(path)</span><br><span class="line"><span class="comment"># 函数返回路径 path 的目录名和文件名</span></span><br><span class="line">os.path.split(path)</span><br><span class="line"><span class="comment"># 判断路径是一个文件还是目录</span></span><br><span class="line">os.path.isfile(path) / os.path.isdir(path)</span><br><span class="line"><span class="comment"># 判断路径是否是软链接</span></span><br><span class="line">os.path.islink(path)</span><br><span class="line"><span class="comment"># 判断是否存在文件或目录</span></span><br><span class="line">os.path.exists(path)</span><br><span class="line"><span class="comment"># 获得文件大小，如果 path 是目录返回 0L</span></span><br><span class="line">os.path.getsize(path)</span><br><span class="line"><span class="comment"># 获得绝对路径</span></span><br><span class="line">os.path.abspath(path)</span><br><span class="line"><span class="comment"># 规范 path 字符串形式</span></span><br><span class="line">os.path.normpath(path)</span><br><span class="line"><span class="comment"># 分割文件名与目录</span></span><br><span class="line">os.path.split(path)</span><br><span class="line"><span class="comment"># 分离文件名与扩展名</span></span><br><span class="line">os.path.splitext(path)</span><br><span class="line"><span class="comment"># 连接目录与文件名或目录</span></span><br><span class="line">os.path.join(path, file)</span><br><span class="line"><span class="comment"># 返回文件名</span></span><br><span class="line">os.path.basename(path)</span><br><span class="line"><span class="comment"># 返回文件路径</span></span><br><span class="line">os.path.dirname(path)</span><br></pre></td></tr></tbody></table></figure>
<h4 id="实际操作文件-路径"><a href="#实际操作文件-路径" class="headerlink" title="实际操作文件 / 路径"></a>实际操作文件 / 路径</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 返回但前目录</span></span><br><span class="line">os.curdir</span><br><span class="line"><span class="comment"># 改变工作目录到 path</span></span><br><span class="line">os.chdir(path)</span><br><span class="line"><span class="comment"># 删除文件</span></span><br><span class="line">os.remove(path)</span><br><span class="line"><span class="comment"># 删除目录</span></span><br><span class="line">os.rmdir(path)</span><br><span class="line"><span class="comment"># 递归删除目录，删除 'foo/bar/baz'，意味着依次删除 'foo/bar/baz' - 'foo/bar' - 'foo'</span></span><br><span class="line">os.removedirs(path)</span><br></pre></td></tr></tbody></table></figure>
<h4 id="读取文件"><a href="#读取文件" class="headerlink" title="读取文件"></a>读取文件</h4><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">open_file</span>(<span class="params">f = <span class="string">""</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(f):</span><br><span class="line">        print(<span class="string">"File not exists, path is %s!"</span> % f)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">with</span> open(f, <span class="string">"r+"</span>, encoding = <span class="string">"utf8"</span>) <span class="keyword">as</span> of:</span><br><span class="line">        <span class="keyword">return</span> of.readlines()</span><br></pre></td></tr></tbody></table></figure>
<h4 id="执行-shell-命令"><a href="#执行-shell-命令" class="headerlink" title="执行 shell 命令"></a>执行 shell 命令</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; import os</span><br><span class="line">&gt;&gt;&gt; exit_code = os.system(<span class="string">"source ~/.bashrc"</span>)</span><br><span class="line">&gt;&gt;&gt; exit_code</span><br><span class="line">  0</span><br></pre></td></tr></tbody></table></figure>
<h3 id="JSON"><a href="#JSON" class="headerlink" title="JSON"></a><a href="https://docs.python.org/3/library/json.html">JSON</a></h3><h4 id="加载与提取"><a href="#加载与提取" class="headerlink" title="加载与提取"></a>加载与提取</h4><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>user = json.loads(<span class="string">'{"name":"benedict","infos":{"age":0,"blog":"yuzhouwan.com"}}'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>user[<span class="string">'name'</span>]</span><br><span class="line">  <span class="string">'benedict'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>user[<span class="string">'infos'</span>][<span class="string">'blog'</span>]</span><br><span class="line">  <span class="string">'yuzhouwan.com'</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="与-YAML-格式互换"><a href="#与-YAML-格式互换" class="headerlink" title="与 YAML 格式互换"></a>与 YAML 格式互换</h4><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># json2yaml</span></span><br><span class="line">sys.stdout.write(yaml.dump(json.load(sys.stdin)))</span><br><span class="line"><span class="comment"># yaml2json</span></span><br><span class="line">sys.stdout.write(json.dumps(yaml.load(sys.stdin)))</span><br></pre></td></tr></tbody></table></figure>
<h3 id="集合"><a href="#集合" class="headerlink" title="集合"></a>集合</h3><h4 id="map"><a href="#map" class="headerlink" title="map"></a>map</h4><h5 id="赋值-取值"><a href="#赋值-取值" class="headerlink" title="赋值 / 取值"></a>赋值 / 取值</h5><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>kv_map = {}</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>kv_map[<span class="string">"k"</span>] = <span class="string">"v"</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>kv_map</span><br><span class="line">  {<span class="string">'k'</span>: <span class="string">'v'</span>}</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>kv_map[<span class="string">"k"</span>]</span><br><span class="line">  <span class="string">'v'</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h5><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>costs = {<span class="string">"b"</span>: <span class="number">2</span>, <span class="string">"a"</span>: <span class="number">1</span>, <span class="string">"c"</span>: <span class="number">3</span>}</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>costs</span><br><span class="line">  {<span class="string">'b'</span>: <span class="number">2</span>, <span class="string">'c'</span>: <span class="number">3</span>, <span class="string">'a'</span>: <span class="number">1</span>}</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按照 Key 排序</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sorted(costs)</span><br><span class="line">  [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sorted(costs.keys())</span><br><span class="line">  [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按照 Value 排序</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sorted(costs.values())</span><br><span class="line">  [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>[ (k, costs[k]) <span class="keyword">for</span> k <span class="keyword">in</span> sorted(costs, key=costs.get, reverse=<span class="literal">False</span>) ]</span><br><span class="line">  [(<span class="string">'a'</span>, <span class="number">1</span>), (<span class="string">'b'</span>, <span class="number">2</span>), (<span class="string">'c'</span>, <span class="number">3</span>)]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sorted(costs.items(), key=<span class="keyword">lambda</span> item: item[<span class="number">1</span>], reverse=<span class="literal">True</span>)</span><br><span class="line">  [(<span class="string">'c'</span>, <span class="number">3</span>), (<span class="string">'b'</span>, <span class="number">2</span>), (<span class="string">'a'</span>, <span class="number">1</span>)]</span><br></pre></td></tr></tbody></table></figure>
<h5 id="遍历"><a href="#遍历" class="headerlink" title="遍历"></a>遍历</h5><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> k, v <span class="keyword">in</span> costs_sorted:</span><br><span class="line"><span class="meta">... </span>    print(k, v)</span><br><span class="line">...</span><br><span class="line">  a <span class="number">1</span></span><br><span class="line">  b <span class="number">2</span></span><br><span class="line">  c <span class="number">3</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="求和"><a href="#求和" class="headerlink" title="求和"></a>求和</h5><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>sum({<span class="string">"b"</span>: <span class="number">2</span>, <span class="string">"a"</span>: <span class="number">1</span>, <span class="string">"c"</span>: <span class="number">3</span>}.values())</span><br><span class="line">  <span class="number">6</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="list"><a href="#list" class="headerlink" title="list"></a>list</h4><h5 id="单层-list"><a href="#单层-list" class="headerlink" title="单层 list"></a>单层 list</h5><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># range(start, stop, step)</span></span><br><span class="line"><span class="comment"># 参数三 如果是负数，则是倒序遍历</span></span><br><span class="line"><span class="comment"># 注意 [start, stop) 是前闭后开的</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>[ _ <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">3</span>, <span class="number">0</span>, <span class="number">-1</span>)]</span><br><span class="line">  [<span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>]</span><br></pre></td></tr></tbody></table></figure>
<h5 id="双层-list"><a href="#双层-list" class="headerlink" title="双层 list"></a>双层 list</h5><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>[[<span class="string">''</span> <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">2</span>)] <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">2</span>)]</span><br><span class="line">  [[<span class="string">''</span>, <span class="string">''</span>], [<span class="string">''</span>, <span class="string">''</span>]]</span><br></pre></td></tr></tbody></table></figure>
<h5 id="Join-双层-list"><a href="#Join-双层-list" class="headerlink" title="Join 双层 list"></a>Join 双层 list</h5><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">'.'</span>.join(str(x) <span class="keyword">for</span> inner_arr <span class="keyword">in</span> [<span class="string">'yuzhouwan'</span>, <span class="string">'com'</span>] <span class="keyword">for</span> x <span class="keyword">in</span> inner_arr)</span><br><span class="line">  <span class="string">'y.u.z.h.o.u.w.a.n.c.o.m'</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="set"><a href="#set" class="headerlink" title="set"></a>set</h4><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>s = set()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s.add(<span class="number">1</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s.add(<span class="number">2</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s.add(<span class="number">2</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s.add(<span class="number">3</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(s)</span><br><span class="line">  set([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></tbody></table></figure>
<h4 id="iter"><a href="#iter" class="headerlink" title="iter"></a>iter</h4><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>blog = <span class="string">"yuzhouwan"</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>iter_blog = iter(blog)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(next(iter_blog))</span><br><span class="line">  y</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(next(iter_blog))</span><br><span class="line">  u</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(next(iter_blog))</span><br><span class="line">  z</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(next(iter_blog))</span><br><span class="line">  h</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(next(iter_blog))</span><br><span class="line">  o</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(next(iter_blog))</span><br><span class="line">  u</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(next(iter_blog))</span><br><span class="line">  w</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(next(iter_blog))</span><br><span class="line">  a</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(next(iter_blog))</span><br><span class="line">  n</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(next(iter_blog))</span><br><span class="line">  Traceback (most recent call last):</span><br><span class="line">    File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  StopIteration</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(next(iter_blog, <span class="literal">None</span>))</span><br><span class="line">  <span class="literal">None</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="流程控制"><a href="#流程控制" class="headerlink" title="流程控制"></a>流程控制</h3><h4 id="if-else"><a href="#if-else" class="headerlink" title="if-else"></a>if-else</h4><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">-1</span> <span class="keyword">if</span> <span class="literal">True</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">  <span class="number">-1</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">-1</span> <span class="keyword">if</span> <span class="literal">False</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">  <span class="number">0</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="try-except"><a href="#try-except" class="headerlink" title="try-except"></a>try-except</h4><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    resp = urllib2.urlopen(<span class="string">"https://yuzhouwan.com/"</span>)</span><br><span class="line">    <span class="keyword">print</span> resp.read()</span><br><span class="line"><span class="keyword">except</span> urllib2.HTTPError, error:</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"Cannot visit this url!"</span>, error</span><br><span class="line">    sys.exit(<span class="number">1</span>)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="算术运算"><a href="#算术运算" class="headerlink" title="算术运算"></a>算术运算</h3><h4 id="除以并返回商的整数值"><a href="#除以并返回商的整数值" class="headerlink" title="除以并返回商的整数值"></a>除以并返回商的整数值</h4><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">1</span> // <span class="number">1</span></span><br><span class="line">  <span class="number">1</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">2</span> // <span class="number">1</span></span><br><span class="line">  <span class="number">2</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">3</span> // <span class="number">1</span></span><br><span class="line">  <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">1</span> // <span class="number">2</span></span><br><span class="line">  <span class="number">0</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">2</span> // <span class="number">2</span></span><br><span class="line">  <span class="number">1</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">3</span> // <span class="number">2</span></span><br><span class="line">  <span class="number">1</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">4</span> // <span class="number">2</span></span><br><span class="line">  <span class="number">2</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">5</span> // <span class="number">2</span></span><br><span class="line">  <span class="number">2</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">6</span> // <span class="number">2</span></span><br><span class="line">  <span class="number">3</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="逻辑运算"><a href="#逻辑运算" class="headerlink" title="逻辑运算"></a>逻辑运算</h3><h4 id="amp-vs-and"><a href="#amp-vs-and" class="headerlink" title="&amp; vs and"></a>&amp; vs and</h4><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="literal">True</span> &amp; <span class="literal">False</span></span><br><span class="line">  <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="literal">True</span> <span class="keyword">and</span> <span class="literal">False</span></span><br><span class="line">  <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">10</span> &gt; <span class="number">1</span> &amp; <span class="number">10</span> &lt; <span class="number">1</span></span><br><span class="line">  <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">10</span> &gt; <span class="number">1</span> <span class="keyword">and</span> <span class="number">10</span> &lt; <span class="number">1</span></span><br><span class="line">  <span class="literal">False</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="位运算"><a href="#位运算" class="headerlink" title="位运算"></a>位运算</h3><div class="table-container">
<table>
<thead>
<tr>
<th>位运算</th>
<th>运算符</th>
<th>运算规则</th>
</tr>
</thead>
<tbody>
<tr>
<td>与运算</td>
<td><code>&amp;</code></td>
<td>A 与 B 值均为 1 时，结果才为 1，否则为 0</td>
</tr>
<tr>
<td>或运算</td>
<td><code>|</code></td>
<td>A 或 B 值为 1 时，结果才为 1，否则为 0</td>
</tr>
<tr>
<td>异或运算</td>
<td><code>^</code></td>
<td>A 与 B 不同为 0 或 1 时，结果才为 1，否则为 0</td>
</tr>
<tr>
<td>按位取反</td>
<td><code>~</code></td>
<td>取反二进制数，0 取 1，1 取 0</td>
</tr>
</tbody>
</table>
</div>
<h3 id="切片"><a href="#切片" class="headerlink" title="切片"></a>切片</h3><h4 id="获取列表的一部分"><a href="#获取列表的一部分" class="headerlink" title="获取列表的一部分"></a>获取列表的一部分</h4><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>][:<span class="number">1</span>]</span><br><span class="line">  [<span class="number">1</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>][:<span class="number">2</span>]</span><br><span class="line">  [<span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>][:<span class="number">3</span>]</span><br><span class="line">  [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>][<span class="number">1</span>::]</span><br><span class="line">  [<span class="number">2</span>, <span class="number">3</span>]</span><br></pre></td></tr></tbody></table></figure>
<h4 id="获取整个列表"><a href="#获取整个列表" class="headerlink" title="获取整个列表"></a>获取整个列表</h4><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>][:]</span><br><span class="line">  [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br></pre></td></tr></tbody></table></figure>
<h4 id="反转"><a href="#反转" class="headerlink" title="反转"></a>反转</h4><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 反转列表</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>][::<span class="number">-1</span>]</span><br><span class="line">  [<span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>]</span><br><span class="line"><span class="comment"># 反转字符串</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">'nawuohzuy'</span>[::<span class="number">-1</span>]</span><br><span class="line">  <span class="string">'yuzhouwan'</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="对列表的切片赋值"><a href="#对列表的切片赋值" class="headerlink" title="对列表的切片赋值"></a>对列表的切片赋值</h4><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>l = list(range(<span class="number">10</span>))</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>l</span><br><span class="line">  [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>l[<span class="number">0</span>:<span class="number">3</span>] = [<span class="number">0</span>, <span class="number">-1</span>, <span class="number">-2</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>l</span><br><span class="line">  [<span class="number">0</span>, <span class="number">-1</span>, <span class="number">-2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>l[<span class="number">2</span>::<span class="number">3</span>] = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>l</span><br><span class="line">  [<span class="number">0</span>, <span class="number">-1</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">9</span>]</span><br></pre></td></tr></tbody></table></figure>
<h2 id="Python-标准库"><a href="#Python-标准库" class="headerlink" title="Python 标准库"></a>Python 标准库</h2><h3 id="binascii"><a href="#binascii" class="headerlink" title="binascii"></a><a href="https://docs.python.org/3/library/binascii.html">binascii</a></h3><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"><span class="comment"># 字符串转 16 进制</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>binascii.b2a_hex(<span class="string">u"宇宙湾"</span>.encode(<span class="string">"utf8"</span>))</span><br><span class="line">  <span class="string">'e5ae87e5ae99e6b9be'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 16 进制转字符串</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">'e5ae87e5ae99e6b9be'</span>.decode(<span class="string">'hex'</span>)</span><br><span class="line">  <span class="string">'\xe5\xae\x87\xe5\xae\x99\xe6\xb9\xbe'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(<span class="string">'e5ae87e5ae99e6b9be'</span>.decode(<span class="string">'hex'</span>))</span><br><span class="line">  宇宙湾</span><br></pre></td></tr></tbody></table></figure>
<h3 id="datetime"><a href="#datetime" class="headerlink" title="datetime"></a><a href="https://docs.python.org/3/library/datetime.html">datetime</a></h3><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">start = datetime.datetime.now()</span><br><span class="line">end = datetime.datetime.now()</span><br><span class="line">print((end - start).microseconds)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="gettext"><a href="#gettext" class="headerlink" title="gettext"></a><a href="https://docs.python.org/3/library/gettext.html">gettext</a></h3><h4 id="制作-PO-文件"><a href="#制作-PO-文件" class="headerlink" title="制作 PO 文件"></a>制作 PO 文件</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 生成模板</span></span><br><span class="line">$ python D:\apps\Python\Python35\Tools\i18n\pygettext.py</span><br><span class="line">$ cat messages.pot</span><br><span class="line">  <span class="comment"># SOME DESCRIPTIVE TITLE.</span></span><br><span class="line">  <span class="comment"># Copyright (C) YEAR ORGANIZATION</span></span><br><span class="line">  <span class="comment"># FIRST AUTHOR &lt;EMAIL@ADDRESS&gt;, YEAR.</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  msgid <span class="string">""</span></span><br><span class="line">  msgstr <span class="string">""</span></span><br><span class="line">  <span class="string">"Project-Id-Version: PACKAGE VERSION\n"</span></span><br><span class="line">  <span class="string">"POT-Creation-Date: 2017-12-28 11:24+0800\n"</span></span><br><span class="line">  <span class="string">"PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"</span></span><br><span class="line">  <span class="string">"Last-Translator: FULL NAME &lt;EMAIL@ADDRESS&gt;\n"</span></span><br><span class="line">  <span class="string">"Language-Team: LANGUAGE &lt;LL@li.org&gt;\n"</span></span><br><span class="line">  <span class="string">"MIME-Version: 1.0\n"</span></span><br><span class="line">  <span class="string">"Content-Type: text/plain; charset=cp936\n"</span></span><br><span class="line">  <span class="string">"Content-Transfer-Encoding: 8bit\n"</span></span><br><span class="line">  <span class="string">"Generated-By: pygettext.py 1.5\n"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 charset 为 UTF-8，以及其他基本信息</span></span><br><span class="line">$ vim messages.pot</span><br><span class="line">  <span class="comment"># SOME DESCRIPTIVE TITLE.</span></span><br><span class="line">  <span class="comment"># Copyright (C) 2017 yuzhouwan.com</span></span><br><span class="line">  <span class="comment"># Benedict Jin &lt;benedictjin2016@gmail.com&gt;, 2017.</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  msgid <span class="string">""</span></span><br><span class="line">  msgstr <span class="string">""</span></span><br><span class="line">  <span class="string">"Project-Id-Version: Yuzhouwan v1.0.2\n"</span></span><br><span class="line">  <span class="string">"POT-Creation-Date: 2017-12-28 11:24+0800\n"</span></span><br><span class="line">  <span class="string">"PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"</span></span><br><span class="line">  <span class="string">"Last-Translator: Benedict Jin &lt;benedictjin2016@gmail.com&gt;\n"</span></span><br><span class="line">  <span class="string">"Language-Team: LANGUAGE &lt;LL@li.org&gt;\n"</span></span><br><span class="line">  <span class="string">"MIME-Version: 1.0\n"</span></span><br><span class="line">  <span class="string">"Content-Type: text/plain; charset=UTF-8\n"</span></span><br><span class="line">  <span class="string">"Content-Transfer-Encoding: 8bit\n"</span></span><br><span class="line">  <span class="string">"Generated-By: pygettext.py 1.5\n"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 PoEdit 打开，并且保存为 po 文件（messages.pot - messages.po）</span></span><br><span class="line"><span class="comment"># 移动到 locale 目录下</span></span><br><span class="line">$ mv messages.po locale/cn/LC_MESSAGES</span><br><span class="line"></span><br><span class="line"><span class="comment"># 增加两段翻译</span></span><br><span class="line">$ vim messages.po</span><br><span class="line">  <span class="comment"># SOME DESCRIPTIVE TITLE.</span></span><br><span class="line">  <span class="comment"># Copyright (C) 2017 yuzhouwan.com</span></span><br><span class="line">  <span class="comment"># Benedict Jin &lt;benedictjin2016@gmail.com&gt;, 2017.</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  msgid <span class="string">""</span></span><br><span class="line">  msgstr <span class="string">""</span></span><br><span class="line">  <span class="string">"Project-Id-Version: Yuzhouwan v1.0.2\n"</span></span><br><span class="line">  <span class="string">"POT-Creation-Date: 2017-12-28 11:39+0800\n"</span></span><br><span class="line">  <span class="string">"PO-Revision-Date: 2017-12-28 11:43+0800\n"</span></span><br><span class="line">  <span class="string">"Language-Team: \n"</span></span><br><span class="line">  <span class="string">"MIME-Version: 1.0\n"</span></span><br><span class="line">  <span class="string">"Content-Type: text/plain; charset=UTF-8\n"</span></span><br><span class="line">  <span class="string">"Content-Transfer-Encoding: 8bit\n"</span></span><br><span class="line">  <span class="string">"Generated-By: pygettext.py 1.5\n"</span></span><br><span class="line">  <span class="string">"X-Generator: Poedit 2.0.1\n"</span></span><br><span class="line">  <span class="string">"Last-Translator: \n"</span></span><br><span class="line">  <span class="string">"Plural-Forms: nplurals=2; plural=(n != 1);\n"</span></span><br><span class="line">  <span class="string">"Language: zh\n"</span></span><br><span class="line"></span><br><span class="line">  msgid <span class="string">"Hello, world!"</span></span><br><span class="line">  msgstr <span class="string">"世界，你好!"</span></span><br><span class="line"></span><br><span class="line">  msgid <span class="string">"yuzhouwan.com"</span></span><br><span class="line">  msgstr <span class="string">"宇宙湾"</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="编写-PO-程序"><a href="#编写-PO-程序" class="headerlink" title="编写 PO 程序"></a>编写 PO 程序</h4><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> gettext</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getLocStrings</span>():</span></span><br><span class="line">    current_dir = os.path.dirname(os.path.realpath(__file__))</span><br><span class="line">    locale_dir = os.path.join(current_dir, <span class="string">"locale"</span>)</span><br><span class="line">    print(<span class="string">"Locale directory:"</span>, locale_dir)</span><br><span class="line">    <span class="keyword">return</span> gettext.translation(<span class="string">'messages'</span>, locale_dir, [<span class="string">"zh_CN"</span>, <span class="string">"en-US"</span>]).gettext</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">_ = getLocStrings()</span><br><span class="line"></span><br><span class="line">print(_(<span class="string">"Hello, world!"</span>))</span><br><span class="line">print(_(<span class="string">"yuzhouwan.com"</span>))</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">Locale directory: E:\Core Code\leetcode\i18n\locale</span><br><span class="line">世界，你好!</span><br><span class="line">宇宙湾</span><br></pre></td></tr></tbody></table></figure>
<h3 id="time"><a href="#time" class="headerlink" title="time"></a><a href="https://docs.python.org/3/library/time.html">time</a></h3><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拿到当前时间的字符串</span></span><br><span class="line">time.strftime(<span class="string">'%Y-%m-%d %H:%M:%S'</span>, time.localtime())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拿到秒级的时间戳</span></span><br><span class="line">int(time.mktime(time.strptime(<span class="string">"2016-3-1 0:0:0"</span>, <span class="string">"%Y-%m-%d %H:%M:%S"</span>)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取当前时间戳</span></span><br><span class="line">datetime.datetime.now().time()</span><br></pre></td></tr></tbody></table></figure>
<h2 id="Python-第三方库"><a href="#Python-第三方库" class="headerlink" title="Python 第三方库"></a>Python 第三方库</h2><h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h3><h4 id="Flask"><a href="#Flask" class="headerlink" title="Flask"></a>Flask</h4><p>　完整的 Flask 服务端示例：</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/', methods=['GET', 'POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">welcome</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Welcome!"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/blog', methods=['GET', 'POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">blog</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"&lt;a href='https://yuzhouwan.com/'&gt;https://yuzhouwan.com/&lt;a&gt;"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run(host=<span class="string">"127.0.0.1"</span>, port=<span class="number">65533</span>, debug=<span class="literal">True</span>)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="数据分析核心库"><a href="#数据分析核心库" class="headerlink" title="数据分析核心库"></a>数据分析核心库</h3><h4 id="Pandas"><a href="#Pandas" class="headerlink" title="Pandas"></a><a href="http://pandas.pydata.org/">Pandas</a></h4><h4 id="SciPy"><a href="#SciPy" class="headerlink" title="SciPy"></a><a href="http://www.scipy.org/">SciPy</a></h4><h4 id="NumPy"><a href="#NumPy" class="headerlink" title="NumPy"></a><a href="http://www.numpy.org/">NumPy</a></h4><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line">arr = [<span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">10</span>]</span><br><span class="line"><span class="keyword">print</span> np.mean(arr)     <span class="comment"># 平均值</span></span><br><span class="line"><span class="keyword">print</span> np.median(arr)   <span class="comment"># 中位数</span></span><br><span class="line"><span class="keyword">print</span> np.std(arr)      <span class="comment"># 标准差</span></span><br><span class="line"></span><br><span class="line">  <span class="number">6.0</span></span><br><span class="line">  <span class="number">6.0</span></span><br><span class="line">  <span class="number">2.82842712475</span></span><br></pre></td></tr></tbody></table></figure>
<p>Tips: Full code is <a href="http://nbviewer.jupyter.org/github/asdf2014/yuzhouwan/blob/master/yuzhouwan-hacker/yuzhouwan-hacker-python/src/main/resources/numpy/NumpyExamples.ipynb">here</a>.</p>
<h3 id="统计学"><a href="#统计学" class="headerlink" title="统计学"></a><a href="https://yuzhouwan.com/posts/42737/#统计学">统计学</a></h3><h4 id="Scrapy"><a href="#Scrapy" class="headerlink" title="Scrapy"></a><a href="https://scrapy.org/">Scrapy</a></h4><h4 id="StatsModels"><a href="#StatsModels" class="headerlink" title="StatsModels"></a><a href="http://statsmodels.sourceforge.net/">StatsModels</a></h4><h3 id="NLP"><a href="#NLP" class="headerlink" title="NLP"></a>NLP</h3><h4 id="NLTK"><a href="#NLTK" class="headerlink" title="NLTK"></a><a href="http://www.nltk.org/">NLTK</a></h4><h4 id="Gensim"><a href="#Gensim" class="headerlink" title="Gensim"></a><a href="https://radimrehurek.com/gensim/">Gensim</a></h4><h3 id="机器学习"><a href="#机器学习" class="headerlink" title="机器学习"></a>机器学习</h3><h4 id="Scikit-learn"><a href="#Scikit-learn" class="headerlink" title="Scikit-learn"></a><a href="http://scikit-learn.org/">Scikit-learn</a></h4><h3 id="人工智能"><a href="#人工智能" class="headerlink" title="人工智能"></a><a href="https://yuzhouwan.com/posts/42737/">人工智能</a></h3><h4 id="TensorFlow"><a href="#TensorFlow" class="headerlink" title="TensorFlow"></a><a href="https://yuzhouwan.com/posts/42737/#开源项目">TensorFlow</a></h4><h4 id="Theano"><a href="#Theano" class="headerlink" title="Theano"></a><a href="http://deeplearning.net/software/theano/">Theano</a></h4><h4 id="Keras"><a href="#Keras" class="headerlink" title="Keras"></a><a href="https://keras.io/">Keras</a></h4><h3 id="可视化"><a href="#可视化" class="headerlink" title="可视化"></a>可视化</h3><h4 id="Matplotlib"><a href="#Matplotlib" class="headerlink" title="Matplotlib"></a><a href="https://matplotlib.org/">Matplotlib</a></h4><h5 id="基本绘图"><a href="#基本绘图" class="headerlink" title="基本绘图"></a>基本绘图</h5><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line">byte_arr_for_point = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]</span><br><span class="line">byte_arr_for_multi_point = [<span class="number">1.1</span>, <span class="number">1.2</span>, <span class="number">1.3</span>, <span class="number">1.4</span>, <span class="number">1.5</span>]</span><br><span class="line">plt.plot([i <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">5</span>)], byte_arr_for_point, ls=<span class="string">'-'</span>, label=<span class="string">'line1'</span>)</span><br><span class="line">plt.plot([i <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">5</span>)], byte_arr_for_multi_point, ls=<span class="string">'--'</span>, label=<span class="string">'line2'</span>)</span><br><span class="line">plt.xlabel(<span class="string">'x'</span>)</span><br><span class="line">plt.ylabel(<span class="string">'y'</span>)</span><br><span class="line">plt.legend()</span><br><span class="line">plt.show()</span><br></pre></td></tr></tbody></table></figure>
<p><img data-src="/picture/python/python_matplotlib_example.png" alt="Python Matplotlib Example"></p>
<center>（对 <a href="https://matplotlib.org/" target="_blank">Matplotlib</a>™ 输出界面的截图）</center>

<h5 id="三角函数"><a href="#三角函数" class="headerlink" title="三角函数"></a>三角函数</h5><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line">plt.figure(<span class="number">1</span>)</span><br><span class="line">plt.figure(<span class="number">2</span>)</span><br><span class="line">plt.figure(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">x = np.linspace(<span class="number">0</span>, <span class="number">6</span>, <span class="number">100</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">  plt.figure(<span class="number">1</span>)</span><br><span class="line">  plt.plot(x, np.sin(i * x))</span><br><span class="line">  plt.figure(<span class="number">2</span>)</span><br><span class="line">  plt.plot(x, np.cos(i * x))</span><br><span class="line">  plt.figure(<span class="number">3</span>)</span><br><span class="line">  plt.plot(x, np.tan(i * x))</span><br><span class="line"></span><br><span class="line">plt.show()</span><br><span class="line">plt.close()</span><br></pre></td></tr></tbody></table></figure>
<p><img data-src="/picture/python/python_matplotlib_sin.png" alt="Python Matplotlib Sin"><br><img data-src="/picture/python/python_matplotlib_cos.png" alt="Python Matplotlib Cos"><br><img data-src="/picture/python/python_matplotlib_tan.png" alt="Python Matplotlib Tan"></p>
<center>（对 <a href="https://matplotlib.org/" target="_blank">Matplotlib</a>™ 输出界面的截图）</center>

<h5 id="积分"><a href="#积分" class="headerlink" title="积分"></a>积分</h5><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> matplotlib.pyplot <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span>(<span class="params">_</span>):</span></span><br><span class="line">    <span class="keyword">return</span> pow(np.e, (<span class="number">-1</span> * _))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">a = <span class="number">0</span></span><br><span class="line">b = <span class="number">1</span></span><br><span class="line">x = np.linspace(<span class="number">0</span>, <span class="number">2</span>)</span><br><span class="line">y = f(x)</span><br><span class="line"></span><br><span class="line">fig_size = <span class="number">6</span></span><br><span class="line">fig, ax = subplots(figsize=(fig_size, fig_size * <span class="number">0.618</span>))</span><br><span class="line">plot(x, y, <span class="string">'b'</span>, linewidth=<span class="number">1</span>)</span><br><span class="line">ylim()</span><br><span class="line"></span><br><span class="line">x_ = np.linspace(a, b)</span><br><span class="line">y_ = f(x_)</span><br><span class="line">shadow = [(a, <span class="number">0</span>)] + list(zip(x_, y_)) + [(b, <span class="number">0</span>)]</span><br><span class="line">poly = Polygon(shadow, facecolor=<span class="string">'0.8'</span>, edgecolor=<span class="string">'0.4'</span>)</span><br><span class="line">ax.add_patch(poly)</span><br><span class="line"></span><br><span class="line">text(<span class="number">1.4</span> * (a + b), <span class="number">1.2</span>,</span><br><span class="line">     <span class="string">r"$Cost(X, Y) = \int_{x_0}^{x_1} \int_{y_0}^{y_1} e^{-\lambda|x-y|}{\rm d}x{\rm d}y$"</span>,</span><br><span class="line">     horizontalalignment=<span class="string">'center'</span>, fontsize=<span class="number">16</span>)</span><br><span class="line">figtext(<span class="number">0.95</span>, <span class="number">0.03</span>, <span class="string">'$x$'</span>)</span><br><span class="line">figtext(<span class="number">0.075</span>, <span class="number">0.82</span>, <span class="string">'$f(x)$'</span>)</span><br><span class="line"></span><br><span class="line">ax.set_xticks((a, b))</span><br><span class="line">ax.set_xticklabels([<span class="string">'$x=%d$'</span> % a, <span class="string">'$y=%d$'</span> % b])</span><br><span class="line">ax.set_yticks([f(a), f(b)])</span><br><span class="line">title(<span class="string">''</span>)</span><br><span class="line">show()</span><br></pre></td></tr></tbody></table></figure>
<p><img data-src="/picture/python/python_matplotlib_cost.png" alt="Python Matplotlib Cost"></p>
<center>（对 <a href="https://matplotlib.org/" target="_blank">Matplotlib</a>™ 输出界面的截图）</center>

<h4 id="Seaborn"><a href="#Seaborn" class="headerlink" title="Seaborn"></a><a href="https://seaborn.pydata.org/">Seaborn</a></h4><h4 id="Bokeh"><a href="#Bokeh" class="headerlink" title="Bokeh"></a><a href="http://bokeh.pydata.org/en/latest/">Bokeh</a></h4><h4 id="Plotly"><a href="#Plotly" class="headerlink" title="Plotly"></a><a href="https://plot.ly/python/">Plotly</a></h4><h3 id="地图"><a href="#地图" class="headerlink" title="地图"></a>地图</h3><h4 id="GeoplotLib"><a href="#GeoplotLib" class="headerlink" title="GeoplotLib"></a><a href="https://github.com/andrea-cuttone/geoplotlib">GeoplotLib</a></h4><h4 id="MapBox"><a href="#MapBox" class="headerlink" title="MapBox"></a><a href="https://www.mapbox.com/">MapBox</a></h4><h3 id="图像处理"><a href="#图像处理" class="headerlink" title="图像处理"></a>图像处理</h3><h4 id="PIL"><a href="#PIL" class="headerlink" title="PIL"></a><a href="https://pillow.readthedocs.io/">PIL</a></h4><h3 id="爬虫"><a href="#爬虫" class="headerlink" title="爬虫"></a>爬虫</h3><h4 id="lxml"><a href="#lxml" class="headerlink" title="lxml"></a><a href="http://lxml.de/tutorial.html">lxml</a></h4><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_ide_id</span>(<span class="params">job_id, tag_name</span>):</span></span><br><span class="line">    <span class="comment"># view-source:http://historyserver-yuzhouwan:19888/jobhistory/conf/job_1010101010101_0101010</span></span><br><span class="line">    url = <span class="string">"http://historyserver-yuzhouwan:19888/jobhistory/conf/"</span> + job_id</span><br><span class="line">    page = requests.get(url)</span><br><span class="line">    html = page.text</span><br><span class="line">    selector = etree.HTML(html)</span><br><span class="line">    tds = selector.xpath(<span class="string">"//*[@id='conf']//tbody//tr//td//text()"</span>)</span><br><span class="line">    exist = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">for</span> td <span class="keyword">in</span> tds:</span><br><span class="line">        <span class="keyword">if</span> tag_name <span class="keyword">in</span> td:</span><br><span class="line">            exist = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> exist:</span><br><span class="line">            <span class="keyword">return</span> td.strip()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">print(get_ide_id(<span class="string">"job_1010101010101_0101010"</span>, <span class="string">"hive.ide.job.id"</span>))</span><br></pre></td></tr></tbody></table></figure>
<h2 id="科学分析工具"><a href="#科学分析工具" class="headerlink" title="科学分析工具"></a>科学分析工具</h2><h3 id="IPython-Notebook"><a href="#IPython-Notebook" class="headerlink" title="IPython Notebook"></a><a href="https://ipython.org/notebook.html">IPython Notebook</a></h3><h4 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 安装之前需要确定 pip 版本足够高，以及环境变量中加入了 %PYTHON_HOME%/Script</span></span><br><span class="line">$ python -m pip install --upgrade pip</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载 Enthought Canopy 套件 (https://www.enthought.com/canopy-subscriptions/)</span></span><br><span class="line"><span class="comment"># 安装后，配置环境变量</span></span><br><span class="line">$ PATH=D:\apps\Enthought\Canopy\App;%PATH%</span><br><span class="line"><span class="comment"># 安装</span></span><br><span class="line">$ pip install <span class="string">"ipython[all]"</span></span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">$ mkdir ipython</span><br><span class="line">$ <span class="built_in">cd</span> ipython</span><br><span class="line">$ ipython notebook</span><br><span class="line">$ ipython notebook --pylab             <span class="comment"># pylab 模式</span></span><br><span class="line">$ ipython notebook --pylab inline      <span class="comment"># Matplotlib 生成的图片嵌入网页内显示</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 创建默认配置文件</span></span><br><span class="line">$ jupyter notebook --generate-config</span><br><span class="line">  Writing default config to: C:\Users\BenedictJin\.jupyter\jupyter_notebook_config.py</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改默认工作区</span></span><br><span class="line">$ vim ~/.jupyter/jupyter_notebook_config.py</span><br><span class="line">  c.NotebookApp.notebook_dir = <span class="string">'F:\Github\_draft\ipython'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启，验证</span></span><br><span class="line">$ ipython notebook</span><br></pre></td></tr></tbody></table></figure>
<h4 id="格式转换"><a href="#格式转换" class="headerlink" title="格式转换"></a>格式转换</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ ipython c --to markdown --execute Basic.ipynb</span><br><span class="line"><span class="comment"># 或者使用 notedown 进行转换 (https://github.com/aaren/notedown)</span></span><br><span class="line">$ pip install notedown</span><br></pre></td></tr></tbody></table></figure>
<h4 id="实用技巧"><a href="#实用技巧" class="headerlink" title="实用技巧"></a>实用技巧</h4><h5 id="嵌入-Markdown"><a href="#嵌入-Markdown" class="headerlink" title="嵌入 Markdown"></a>嵌入 Markdown</h5><p>　iPython 创建好 <code>.ipynb</code>文件后，在 markdown 使用 <code>&lt;iframe&gt;</code>标签，就可以将完成嵌入<br></p><figure class="highlight html"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">"https://nbviewer.jupyter.org/github/asdf2014/yuzhouwan/blob/master/yuzhouwan-hacker/yuzhouwan-hacker-python/src/main/resources/ipython/Basic.ipynb"</span> <span class="attr">width</span>=<span class="string">"640"</span> <span class="attr">height</span>=<span class="string">"700"</span> <span class="attr">frameborder</span>=<span class="string">"0"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><br>　如此一来，可以将 matplotlib 画出的可视化图形，展示出来，而非仅仅一段 python 脚本，实际效果如下：<p></p>
<center><iframe src="https://nbviewer.jupyter.org/github/asdf2014/yuzhouwan/blob/master/yuzhouwan-hacker/yuzhouwan-hacker-python/src/main/resources/ipython/Basic.ipynb" width="640" height="700" frameborder="0"></iframe></center>

<p>Tips: 如果你的博客也是全站 <strong>HTTPS</strong> 的话，则需要保证 <code>iframe</code> 里面加载的资源也是 <code>https</code> 的，否则 Chrome 会<a href="https://developers.google.com/web/fundamentals/security/prevent-mixed-content/fixing-mixed-content?hl=zh-cn">阻止混合内容</a>的展示</p>
<h5 id="帮助文档"><a href="#帮助文档" class="headerlink" title="帮助文档"></a>帮助文档</h5><p>　<code>?</code> 单问号，可以展示出 对应函数、类、变量的文档，而使用 <code>??</code> 双问号，则可以将对应的源码展示出来</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ a = 1</span><br><span class="line">$ a?</span><br><span class="line">  Type:        int</span><br><span class="line">  String form: 1</span><br><span class="line">  Docstring:  </span><br><span class="line">  int(x=0) -&gt; int or long</span><br><span class="line">  int(x, base=10) -&gt; int or long</span><br><span class="line"></span><br><span class="line">  Convert a number or string to an <span class="built_in">integer</span>, or <span class="built_in">return</span> 0 <span class="keyword">if</span> no arguments</span><br><span class="line">  are given.  If x is floating point, the conversion truncates towards zero.</span><br><span class="line">  If x is outside the <span class="built_in">integer</span> range, the <span class="keyword">function</span> returns a long instead.</span><br><span class="line"></span><br><span class="line">  If x is not a number or <span class="keyword">if</span> base is given, <span class="keyword">then</span> x must be a string or</span><br><span class="line">  Unicode object representing an <span class="built_in">integer</span> literal <span class="keyword">in</span> the given base.  The</span><br><span class="line">  literal can be preceded by <span class="string">'+'</span> or <span class="string">'-'</span> and be surrounded by whitespace.</span><br><span class="line">  The base defaults to 10.  Valid bases are 0 and 2-36.  Base 0 means to</span><br><span class="line">  interpret the base from the string as an <span class="built_in">integer</span> literal.</span><br><span class="line">  &gt;&gt;&gt; int(<span class="string">'0b100'</span>, base=0)</span><br><span class="line">  4</span><br><span class="line"></span><br><span class="line">$ a??</span><br><span class="line">  Type:        int</span><br><span class="line">  String form: 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 另外，推荐使用 "shift + tab" 快捷键，可以更便捷地展示方法的详细描述</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="配置-iPython-Notebook-支持Python-3"><a href="#配置-iPython-Notebook-支持Python-3" class="headerlink" title="配置 iPython Notebook 支持Python 3"></a>配置 iPython Notebook <a href="http://ipython.readthedocs.io/en/stable/install/kernel_install.html">支持Python 3</a></h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 安装 python3</span></span><br><span class="line">$ <span class="built_in">which</span> python</span><br><span class="line">  /d/apps/Python/Python35/python</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 iPython kernel</span></span><br><span class="line">$ python -m pip install ipykernel</span><br><span class="line">$ python -m ipykernel install --user</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 notebook</span></span><br><span class="line">$ <span class="built_in">which</span> pip</span><br><span class="line">  /d/apps/Python/Python35/Scripts/pip</span><br><span class="line">$ pip install notebook</span><br></pre></td></tr></tbody></table></figure>
<h2 id="Python-工程工具"><a href="#Python-工程工具" class="headerlink" title="Python 工程工具"></a>Python 工程工具</h2><h3 id="Tox"><a href="#Tox" class="headerlink" title="Tox"></a><a href="https://testrun.org/tox">Tox</a></h3><h3 id="VirtualEnv-1"><a href="#VirtualEnv-1" class="headerlink" title="VirtualEnv"></a><a href="https://github.com/pypa/virtualenv">VirtualEnv</a></h3><h2 id="实战技巧"><a href="#实战技巧" class="headerlink" title="实战技巧"></a>实战技巧</h2><h3 id="设置-Proxy"><a href="#设置-Proxy" class="headerlink" title="设置 Proxy"></a>设置 Proxy</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">export</span> http_proxy=<span class="string">"http://127.0.0.1:1080"</span></span><br><span class="line">$ <span class="built_in">export</span> https_proxy=<span class="string">"https://127.0.0.1:1080"</span></span><br><span class="line">$ <span class="built_in">export</span> socks5_proxy=<span class="string">"socks5://127.0.0.1:1080"</span></span><br><span class="line"><span class="comment"># pip install --upgrade pip</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="Remote-Debug"><a href="#Remote-Debug" class="headerlink" title="Remote Debug"></a>Remote Debug</h3><p>　我们需要达到的效果是，<strong>本地</strong>通过 断点直接对 Python 代码进行 <strong>Debug</strong> 并<strong>修改</strong>，并在 <strong>Ctrl+S</strong> 之后会通过 <strong>SFTP</strong> 直接<strong>上传</strong>至<strong>远程服务器</strong>，待全部修改部署完成，自动通过 <strong>Flask</strong> 自动 <strong>reload 最新</strong>的<strong>代码</strong>，并<strong>自动重启</strong>远程 Python <strong>进程</strong>，在本地直接看到修改之后的线上效果。(这里我们以 Airbnb的 <a href="https://yuzhouwan.com/posts/743/">Superset</a> 项目为基础来介绍)</p>
<h4 id="PyCharm"><a href="#PyCharm" class="headerlink" title="PyCharm"></a>PyCharm</h4><h5 id="Windows-开发机"><a href="#Windows-开发机" class="headerlink" title="Windows 开发机"></a>Windows 开发机</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">## local</span></span><br><span class="line"><span class="comment"># should shutdown local firewall firstly</span></span><br><span class="line">$ <span class="built_in">cd</span> .\JetBrains\PyCharm 2016.2.3\debug-eggs\pycharm-debug.egg</span><br><span class="line">$ easy_install pycharm-debug.egg</span><br><span class="line"><span class="comment"># 若运行使用的是 Python3，则需要 pycharm-debug-py3k.egg</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Run/Debug Configuration - SuperSet Remote Debug - 192.168.3.10(local ip) - 12345(port &gt; 10000), will generate..</span></span><br><span class="line">import pydevd</span><br><span class="line">pydevd.settrace(<span class="string">'192.168.3.10'</span>, port=12345, stdoutToServer=True, stderrToServer=True)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Path mappings</span></span><br><span class="line">E:/Core Code/superset=/root/superset</span><br><span class="line"></span><br><span class="line"><span class="comment"># SFTP</span></span><br><span class="line"><span class="comment"># copy a project to a local directory.</span></span><br><span class="line"><span class="comment"># configure: tools - deployment, to upload this local copy to remote server</span></span><br><span class="line"><span class="comment"># config remote host</span></span><br><span class="line"></span><br><span class="line">192.168.1.10 SFTP 192.168.1.10 22 /root/superset-0.15.4 root/****** UTF-8		<span class="comment"># 脱敏</span></span><br><span class="line"><span class="comment"># Tools - Deployment - Options - Upload changed files automatically to the default server (On explicit save action (Ctrl+S))</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># make deployment automatic: tools - deployment - "automatic upload"</span></span><br><span class="line"><span class="comment"># add remote interpreter: file - settings - python interpreters - "+" - "Remote.."</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Start Debug</span></span><br><span class="line">Starting debug server at port 12345</span><br><span class="line">Use the following code to connect to the debugger:</span><br><span class="line">import pydevd</span><br><span class="line">pydevd.settrace(<span class="string">'192.168.3.10'</span>, port=12345, stdoutToServer=True, stderrToServer=True)</span><br><span class="line">Waiting <span class="keyword">for</span> process connection...</span><br><span class="line">Connected to pydev debugger (build 162.1967.10)</span><br><span class="line">Starting server with <span class="built_in">command</span>: gunicorn -w 2 --timeout 60 -b 0.0.0.0:9097 --<span class="built_in">limit</span>-request-line 0 --<span class="built_in">limit</span>-request-field_size 0 superset:app</span><br></pre></td></tr></tbody></table></figure>
<h5 id="远程-Linux-运行环境"><a href="#远程-Linux-运行环境" class="headerlink" title="远程 Linux 运行环境"></a>远程 Linux 运行环境</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">## remote</span></span><br><span class="line">$ <span class="built_in">cd</span> /root/superset</span><br><span class="line">$ <span class="built_in">source</span> bin/activate</span><br><span class="line">$ <span class="built_in">cd</span> /root/superset/lib</span><br><span class="line"><span class="comment"># cp \JetBrains\PyCharm 2016.2.3\debug-eggs\pycharm-debug.egg 到 lib 目录中</span></span><br><span class="line">$ easy_install pycharm-debug.egg</span><br><span class="line"></span><br><span class="line"><span class="comment"># trouble shooting</span></span><br><span class="line">&gt;&gt;&gt; import pydevd</span><br><span class="line"></span><br><span class="line"><span class="comment"># restart</span></span><br><span class="line">$ vim /root/superset/bin/superset</span><br><span class="line"></span><br><span class="line">  import pydevd</span><br><span class="line">  pydevd.settrace(<span class="string">'192.168.3.10'</span>, port=12345, stdoutToServer=True, stderrToServer=True)</span><br><span class="line"></span><br><span class="line"><span class="comment"># After local debug, then start superset</span></span><br><span class="line">$ mkdir logs</span><br><span class="line">$ nohup superset runserver -a 0.0.0.0 -p 9097 2&gt;&amp;1 &gt; logs/superset.log &amp;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Flask - Werkzeug debugger</span></span><br><span class="line">2017-02-07 15:47:03,905:WARNING:werkzeug: * Debugger is active!</span><br><span class="line">2017-02-07 15:47:03,905:INFO:werkzeug: * Debugger pin code: 330-765-812</span><br><span class="line"></span><br><span class="line">$ pip install django-debug-toolbar</span><br><span class="line"></span><br><span class="line">$ vim lib/python2.7/site-packages/pycharm-debug.egg/tests_pydevd_python/my_django_proj_17/my_django_proj_17/settings.py</span><br><span class="line"></span><br><span class="line">  INSTALLED_APPS = (</span><br><span class="line">    <span class="string">'django.contrib.admin'</span>,</span><br><span class="line">    <span class="string">'django.contrib.auth'</span>,</span><br><span class="line">    <span class="string">'django.contrib.contenttypes'</span>,</span><br><span class="line">    <span class="string">'django.contrib.sessions'</span>,</span><br><span class="line">    <span class="string">'django.contrib.messages'</span>,</span><br><span class="line">    <span class="string">'django.contrib.staticfiles'</span>,</span><br><span class="line">    <span class="string">'debug_toolbar'</span>,                       <span class="comment"># add</span></span><br><span class="line">    <span class="string">'my_app'</span>,</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line"><span class="comment"># enable django</span></span><br><span class="line">Setting - Language &amp; Frameworks - Django - <span class="string">"Enable Django Support"</span></span><br><span class="line"></span><br><span class="line">E:\Core Code\superset-0.15.4\bin\superset runserver -a <span class="string">'0.0.0.0'</span> -p 9097</span><br><span class="line"></span><br><span class="line"><span class="comment">############################# PyDevd is so stiff! Let's Try Remote Python. #############################</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 SFTP (同上)</span></span><br><span class="line"><span class="comment"># 配置 Remote Python</span></span><br><span class="line"></span><br><span class="line">  File - Settings - Project: superset-0.15.4 - Project Interpreter - show all(+) - </span><br><span class="line"></span><br><span class="line">    name:                        Remote Python 2.7.12 (ssh://root@192.168.1.10:22/root/superset-0.15.4/bin/python)</span><br><span class="line">    SSH Credentials</span><br><span class="line">    Host:                        192.168.1.10 Port: 22</span><br><span class="line">    User name:                   root</span><br><span class="line">    Auth <span class="built_in">type</span>:                   Password      <span class="comment"># 脱敏</span></span><br><span class="line">    Python interpreter path:     /root/superset-0.15.4/bin/python</span><br><span class="line">    PyCharm helpers path:        /root/superset-0.15.4/.pycharm_helpers</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果发现无法识别，可能是 python 缺少运行权限</span></span><br><span class="line">$ <span class="built_in">cd</span> /root/superset-0.15.4/bin &amp;&amp; chmod 777 *</span><br></pre></td></tr></tbody></table></figure>
<h5 id="PyCharm-相关配置"><a href="#PyCharm-相关配置" class="headerlink" title="PyCharm 相关配置"></a>PyCharm 相关配置</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 配置 Python 运行项目</span></span><br><span class="line"></span><br><span class="line">  Run - Run/Debug Configurations(+) - Python - </span><br><span class="line"></span><br><span class="line">    Name:                     superset</span><br><span class="line">    Script:                   E:\Core Code\superset-0.15.4\bin\superset</span><br><span class="line">    Script parameters:        runserver -d -p 9097</span><br><span class="line">    Environment Variables:    VIRTUALENVWRAPPER_PYTHON=E:\Core Code\superset-0.15.4\bin\python;PYTHONUNBUFFERED=1</span><br><span class="line">    Python interpreter:       Remote Python 2.7.12 (ssh://root@192.168.1.10:22/root/superset-0.15.4/bin/python)		<span class="comment"># 上面配置的 remote python</span></span><br><span class="line">    Working directory:        E:\Core Code\superset-0.15.4\bin</span><br><span class="line">    Path mapping:             E:/Core Code/superset-0.15.4=/root/superset-0.15.4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在用远程 python 进行 remote debug 之前，进入到 virtualenv 中</span></span><br><span class="line"><span class="comment"># 这里有可能找不到 activate 文件，可直接添加</span></span><br><span class="line"></span><br><span class="line">  File - Settings - Tools - Terminal - Shell path</span><br><span class="line"></span><br><span class="line">    /bin/bash --rcfile ~/.pycharmrc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ vim <span class="string">'/e/Core Code/superset-0.15.4/.pycharmrc'</span>     <span class="comment"># 本地工程增加 .pycharmrc</span></span><br><span class="line"></span><br><span class="line">  VIRTUAL_ENV=<span class="string">"/root/superset-0.15.4"</span>               <span class="comment"># 远程服务器中的 virtualenv 目录 (可以直接将 bin/activate 文件内容复制过来)</span></span><br><span class="line">  <span class="built_in">export</span> VIRTUAL_ENV</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 远程服务器上多了两个进程</span></span><br><span class="line">$ ps -ef | grep superset | grep -v grep</span><br><span class="line"></span><br><span class="line">  root      8638 10912  0 15:24 pts/1    00:00:00 bash -c <span class="built_in">cd</span> /root/superset-0.15.4/bin; env <span class="string">"IDE_PROJECT_ROOTS"</span>=<span class="string">"/root/superset-0.15.4"</span> <span class="string">"IPYTHONENABLE"</span>=<span class="string">"True"</span> <span class="string">"PYTHONPATH"</span>=<span class="string">"/root/superset-0.15.4:/root/superset-0.15.4/.pycharm_helpers/pydev"</span> <span class="string">"PYTHONUNBUFFERED"</span>=<span class="string">"1"</span> <span class="string">"PYCHARM_HOSTED"</span>=<span class="string">"1"</span> <span class="string">"VIRTUALENVWRAPPER_PYTHON"</span>=<span class="string">"E:\Core Code\superset-0.15.4\bin\python"</span> <span class="string">"LIBRARY_ROOTS"</span>=<span class="string">"C:/Users/yuzhouwan/.PyCharm2016.2/system/remote_sources/368920028/544046706;C:/Users/yuzhouwan/.PyCharm2016.2/system/remote_sources/368920028/550610069;C:/Users/yuzhouwan/.PyCharm2016.2/system/remote_sources/368920028/421221282;C:/Users/yuzhouwan/.PyCharm2016.2/system/remote_sources/368920028/-1386076807;C:/Users/yuzhouwan/.PyCharm2016.2/system/remote_sources/368920028/964856790;C:/Users/yuzhouwan/.PyCharm2016.2/system/remote_sources/368920028/-1532312494;C:/Users/yuzhouwan/.PyCharm2016.2/system/remote_sources/368920028/-1783908167;C:/Users/yuzhouwan/.PyCharm2016.2/system/remote_sources/250609560/2125044534;C:/Users/yuzhouwan/.PyCharm2016.2/system/remote_sources/250609560/550610069;C:/Users/yuzhouwan/.PyCharm2016.2/system/remote_sources/250609560/421221282;C:/Users/yuzhouwan/.PyCharm2016.2/system/remote_sources/250609560/-1386076807;C:/Users/yuzhouwan/.PyCharm2016.2/system/remote_sources/250609560/-900005478;C:/Users/yuzhouwan/.PyCharm2016.2/system/remote_sources/250609560/77779222;C:/Users/yuzhouwan/.PyCharm2016.2/system/remote_sources/250609560/-1783908167;C:/Users/yuzhouwan/.PyCharm2016.3/system/remote_sources/250609560/2125044534;C:/Users/yuzhouwan/.PyCharm2016.3/system/remote_sources/250609560/550610069;C:/Users/yuzhouwan/.PyCharm2016.3/system/remote_sources/250609560/421221282;C:/Users/yuzhouwan/.PyCharm2016.3/system/remote_sources/250609560/-1386076807;C:/Users/yuzhouwan/.PyCharm2016.3/system/remote_sources/250609560/-900005478;C:/Users/yuzhouwan/.PyCharm2016.3/system/remote_sources/250609560/77779222;C:/Users/yuzhouwan/.PyCharm2016.3/system/remote_sources/250609560/-1783908167;C:/Users/yuzhouwan/.PyCharm2016.3/system/python_stubs/250609560;D:/apps/JetBrains/PyCharm 2016.3.2/helpers/python-skeletons"</span> <span class="string">"PYTHONDONTWRITEBYTECODE"</span>=<span class="string">"1"</span> <span class="string">"JETBRAINS_REMOTE_RUN"</span>=<span class="string">"1"</span> <span class="string">"PYTHONIOENCODING"</span>=<span class="string">"UTF-8"</span> /root/superset-0.15.4/bin/python -u /root/superset-0.15.4/.pycharm_helpers/pydev/pydevd.py --multiproc --qt-support --client <span class="string">'0.0.0.0'</span> --port 39925 --file /root/superset-0.15.4/bin/superset runserver -d -p 9097</span><br><span class="line">  root      8660  8638 11 15:24 pts/1    00:00:17 /root/superset-0.15.4/bin/python -u /root/superset-0.15.4/.pycharm_helpers/pydev/pydevd.py --multiproc --qt-support --client 0.0.0.0 --port 39925 --file /root/superset-0.15.4/bin/superset runserver -d -p 9097</span><br><span class="line">  root      8715  8660 28 15:24 pts/1    00:00:38 /root/superset-0.15.4/bin/python /root/superset-0.15.4/.pycharm_helpers/pydev/pydevd.py --multiproc --qt-support --client 0.0.0.0 --port 39925 --file /root/superset-0.15.4/bin/superset runserver -d -p 9097</span><br></pre></td></tr></tbody></table></figure>
<h5 id="完成"><a href="#完成" class="headerlink" title="完成"></a>完成</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 本地 windows 上访问</span></span><br><span class="line">http://192.168.1.10:9097/login/</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Visual-Studio-Code"><a href="#Visual-Studio-Code" class="headerlink" title="Visual Studio Code"></a>Visual Studio Code</h4><p>　Not good for me! You can still try it if you are interested.</p>
<h4 id="踩过的坑"><a href="#踩过的坑" class="headerlink" title="踩过的坑"></a>踩过的坑</h4><h5 id="Gunicorn-预开启了多个-Work-子进程，无法-Remote-Debug"><a href="#Gunicorn-预开启了多个-Work-子进程，无法-Remote-Debug" class="headerlink" title="Gunicorn 预开启了多个 Work 子进程，无法 Remote Debug"></a>Gunicorn 预开启了多个 Work 子进程，无法 Remote Debug</h5><h6 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h6><p>　在本地 windows 开发机上，远程连接 linux 上运行在 virtualenv 里的 superset，发现可以 debug，但是 superset 里的 gunicorn 用的是 prefork 模型，开启了好多个 work 子进程</p>
<h6 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h6><p>a) 正常的 remote debug 来处理                    —not ok</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">Connected to pydev debugger (build 162.1967.10)</span><br><span class="line">[2017-02-06 18:13:22 +0000] [13609] [INFO] Starting gunicorn 19.6.0</span><br><span class="line">[2017-02-06 18:13:22 +0000] [13609] [INFO] Listening at: http://0.0.0.0:9097 (13609)</span><br><span class="line">[2017-02-06 18:13:22 +0000] [13609] [INFO] Using worker: sync</span><br><span class="line">[2017-02-06 18:14:23 +0000] [13609] [CRITICAL] WORKER TIMEOUT (pid:13624)</span><br><span class="line">[2017-02-06 18:14:23 +0000] [13609] [CRITICAL] WORKER TIMEOUT (pid:13623)</span><br></pre></td></tr></tbody></table></figure>
<p>b) 所以用 “Django server” 替换 “Python Remote Debug” 来进行调试                    —not ok</p>
<p>　配置的 Remote Python 明明是 <code>/root/superset/bin/python</code>，但是看到 报错信息里面，用的却是 <code>/usr/local/bin/python</code></p>
<p>c) ipdb                    —not good</p>
<p>　将 gunicorn 进程切换到前台，在 命令行用 ipdb 进行 debug</p>
<p>d) 增加 <code>-w</code> 参数，控制 work 数量                    —not ok</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">@manager.option(</span><br><span class="line"><span class="string">'-w'</span>, <span class="string">'--workers'</span>, default=config.get(<span class="string">"SUPERSET_WORKERS"</span>, 2),    <span class="comment"># default: 2</span></span><br><span class="line"><span class="built_in">help</span>=<span class="string">"Number of gunicorn web server workers to fire up"</span>)</span><br><span class="line"></span><br><span class="line">$ superset runserver -a 0.0.0.0 -p 9097 -w 0</span><br></pre></td></tr></tbody></table></figure>
<p>e) 关闭 gunicorn                    —ok</p>
<p>　只有在压测时候，才需要开启 gunicorn<br>　<code>superset runserver -d -p 9097</code></p>
<h5 id="Trying-to-add-breakpoint-to-file-that-does-not-exist"><a href="#Trying-to-add-breakpoint-to-file-that-does-not-exist" class="headerlink" title="Trying to add breakpoint to file that does not exist"></a>Trying to add breakpoint to file that does not exist</h5><h6 id="描述-1"><a href="#描述-1" class="headerlink" title="描述"></a>描述</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">pydev debugger: warning: trying to add breakpoint to file that does not exist: /root/superset/d:/apps/python27/lib/site-packages/gunicorn/arbiter.py</span><br></pre></td></tr></tbody></table></figure>
<h6 id="解决-1"><a href="#解决-1" class="headerlink" title="解决"></a>解决</h6><p>a) 增加 python 中 site-packages 的 mapping 映射                    —not good</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">E:/Core Code/superset=/root/superset;D:/apps/Python27=/root/superset/lib/python2.7</span><br></pre></td></tr></tbody></table></figure>
<p>b) 修改 python 为 superset 项目中的 python，而不是本机的 python                    —ok</p>
<p>　同步到本机的 python 不是 python.exe                    —no<br>　使用 remote python                                                 —ok</p>
<h5 id="Couldn’t-obtain-remote-socket"><a href="#Couldn’t-obtain-remote-socket" class="headerlink" title="Couldn’t obtain remote socket"></a>Couldn’t obtain remote socket</h5><h6 id="描述-2"><a href="#描述-2" class="headerlink" title="描述"></a>描述</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">Error running superset</span><br><span class="line">Can<span class="string">'t run remote python interpreter: Couldn'</span>t obtain remote socket from output (<span class="string">'0.0.0.0'</span>, 52703), stderr /usr/<span class="built_in">local</span>/bin/python: No module named virtualenvwrapper virtualenvwrapper.sh: There was a problem running the initialization hooks. </span><br><span class="line">If Python could not import the module virtualenvwrapper.hook_loader, check that virtualenvwrapper has been installed <span class="keyword">for</span> VIRTUALENVWRAPPER_PYTHON=/usr/<span class="built_in">local</span>/bin/python and that PATH is <span class="built_in">set</span> properly.</span><br></pre></td></tr></tbody></table></figure>
<h6 id="解决-2"><a href="#解决-2" class="headerlink" title="解决"></a>解决</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 查看 PATH 是否包含 venvWapper 的环境变量</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$PATH</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 没有，则检查 ~/.bashrc，将其注释</span></span><br><span class="line"><span class="comment"># Source global definitions</span></span><br><span class="line"><span class="comment"># export WORKON_HOME=~/virtualenv</span></span><br><span class="line"><span class="comment"># source /usr/local/bin/virtualenvwrapper.sh</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="Vagrant"><a href="#Vagrant" class="headerlink" title="Vagrant"></a>Vagrant</h3><p>　<strong>Vagrant</strong> 是一款可以<code>自动化</code>虚拟机的 <code>安装和配置流程</code>的软件</p>
<h4 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Vagrant</span></span><br><span class="line">  https://www.vagrantup.com/downloads.html</span><br><span class="line"></span><br><span class="line"><span class="comment"># VirtualBox</span></span><br><span class="line">  https://www.virtualbox.org/wiki/Downloads</span><br><span class="line">  http://download.virtualbox.org/virtualbox/5.1.12/      <span class="comment"># better</span></span><br><span class="line">  https://hashicorp-files.hashicorp.com/lucid32.box      <span class="comment"># not good</span></span><br><span class="line">  https://cloud-images.ubuntu.com/vagrant/trusty/current/trusty-server-cloudimg-amd64-vagrant-disk1.box      <span class="comment"># best</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 相关镜像</span></span><br><span class="line">  https://atlas.hashicorp.com/boxes/search</span><br><span class="line">  http://chef.github.io/bento/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装完成之后，需要 cmd/pycharm/git dash 等等，最好重启电脑</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vagrant box add superset /f/软件库/python/trusty-server-cloudimg-amd64-juju-vagrant-disk1.box</span><br><span class="line"></span><br><span class="line">  ==&gt; box: Box file was not detected as metadata. Adding it directly...</span><br><span class="line">  ==&gt; box: Adding box <span class="string">'superset'</span> (v0) <span class="keyword">for</span> provider:</span><br><span class="line">      box: Unpacking necessary files from: file:///F:/%C8%ED%BC%FE%BF%E2/python/trusty-server-cloudimg-amd64-juju-vagrant-disk1.box</span><br><span class="line">      box:</span><br><span class="line">  ==&gt; box: Successfully added box <span class="string">'superset'</span> (v0) <span class="keyword">for</span> <span class="string">'virtualbox'</span>!</span><br><span class="line"></span><br><span class="line">$ vagrant box list</span><br><span class="line">  superset (virtualbox, 0)</span><br><span class="line"></span><br><span class="line">$ vagrant init</span><br><span class="line"></span><br><span class="line">  A `Vagrantfile` has been placed <span class="keyword">in</span> this directory. You are now ready to `vagrant up` your first virtual environment! Please <span class="built_in">read</span> the comments <span class="keyword">in</span> the Vagrantfile as well as documentation on `vagrantup.com` <span class="keyword">for</span> more information on using Vagrant.</span><br><span class="line"></span><br><span class="line">$ vim /e/vagrant/superset-0.15.4/Vagrantfile</span><br><span class="line"></span><br><span class="line">  <span class="comment"># -*- mode: ruby -*-</span></span><br><span class="line">  <span class="comment"># vi: set ft=ruby :</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Vagrant.configure("2") do |config|</span></span><br><span class="line">  <span class="comment">#   config.vm.box = "superset"</span></span><br><span class="line">  <span class="comment">#   config.vm.box_check_update = false</span></span><br><span class="line">  <span class="comment">#   config.ssh.shell = "bash -c 'BASH_ENV=/etc/profile exec bash'"</span></span><br><span class="line">  <span class="comment">#   config.vm.synced_folder "./", "/root/superset-0.15.4"</span></span><br><span class="line">  <span class="comment"># </span></span><br><span class="line">  <span class="comment">#   config.vm.network "public_network"</span></span><br><span class="line">  <span class="comment">#   config.vm.provider "virtualbox" do |vb|</span></span><br><span class="line">  <span class="comment">#     vb.gui = true</span></span><br><span class="line">  <span class="comment">#     vb.memory = "1024"</span></span><br><span class="line">  <span class="comment">#   end</span></span><br><span class="line">  <span class="comment">#   config.vm.provision "shell", inline: &lt;&lt;-SHELL</span></span><br><span class="line">  <span class="comment">#     apt-get update</span></span><br><span class="line">  <span class="comment">#   SHELL</span></span><br><span class="line">  <span class="comment"># end</span></span><br><span class="line"></span><br><span class="line">$ vagrant up --provide virtualbox</span><br><span class="line"></span><br><span class="line">  Bringing machine <span class="string">'default'</span> up with <span class="string">'virtualbox'</span> provider...</span><br><span class="line">  ==&gt; default: Importing base box <span class="string">'superset'</span>...</span><br><span class="line">  ==&gt; default: Matching MAC address <span class="keyword">for</span> NAT networking...</span><br><span class="line">  ==&gt; default: Setting the name of the VM: superset-0154_default_1486969836220_44233</span><br><span class="line">  ==&gt; default: Clearing any previously <span class="built_in">set</span> forwarded ports...</span><br><span class="line">  ==&gt; default: Clearing any previously <span class="built_in">set</span> network interfaces...</span><br><span class="line">  ==&gt; default: Preparing network interfaces based on configuration...</span><br><span class="line">      default: Adapter 1: nat</span><br><span class="line">      default: Adapter 2: hostonly</span><br><span class="line">  ==&gt; default: Forwarding ports...</span><br><span class="line">      default: 22 (guest) =&gt; 2122 (host) (adapter 1)</span><br><span class="line">      default: 80 (guest) =&gt; 6080 (host) (adapter 1)</span><br><span class="line">      default: 6079 (guest) =&gt; 6079 (host) (adapter 1)</span><br><span class="line">      default: 22 (guest) =&gt; 2222 (host) (adapter 1)</span><br><span class="line">  ==&gt; default: Running <span class="string">'pre-boot'</span> VM customizations...</span><br><span class="line">  ==&gt; default: Booting VM...</span><br><span class="line">  ==&gt; default: Waiting <span class="keyword">for</span> machine to boot. This may take a few minutes...</span><br><span class="line">      default: SSH address: 127.0.0.1:2222</span><br><span class="line">      default: SSH username: vagrant</span><br><span class="line">      default: SSH auth method: private key</span><br></pre></td></tr></tbody></table></figure>
<h4 id="踩过的坑-1"><a href="#踩过的坑-1" class="headerlink" title="踩过的坑"></a>踩过的坑</h4><h5 id="Provider-‘virtualbox’-not-found"><a href="#Provider-‘virtualbox’-not-found" class="headerlink" title="Provider ‘virtualbox’ not found"></a>Provider ‘virtualbox’ not found</h5><h6 id="描述-3"><a href="#描述-3" class="headerlink" title="描述"></a>描述</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vagrant up</span><br><span class="line">  ==&gt;  Provider <span class="string">'virtualbox'</span> not found. We<span class="string">'ll automatically install it now...</span></span><br><span class="line"><span class="string">  The installation process will start below. Human interaction may be required at some points. If you'</span>re uncomfortable with automatically installing this provider, you can safely Ctrl-C this process and install it manually.</span><br><span class="line">  ==&gt;  Downloading VirtualBox 5.0.10...</span><br><span class="line">  This may not be the latest version of VirtualBox, but it is a version that is known to work well. Over time, we<span class="string">'ll update the version that is installed.</span></span><br></pre></td></tr></tbody></table></figure>
<h6 id="解决-3"><a href="#解决-3" class="headerlink" title="解决"></a>解决</h6><p>　<code>vagrant up --provider=virtualbox</code></p>
<h5 id="Timed-out-while-waiting-for-the-machine-to-boot"><a href="#Timed-out-while-waiting-for-the-machine-to-boot" class="headerlink" title="Timed out while waiting for the machine to boot"></a>Timed out while waiting for the machine to boot</h5><h6 id="描述-4"><a href="#描述-4" class="headerlink" title="描述"></a>描述</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">子目录或文件 -p 已经存在。</span><br><span class="line">处理: -p 时出错。</span><br><span class="line">子目录或文件 charms 已经存在。</span><br><span class="line">处理: charms 时出错。</span><br><span class="line">Timed out <span class="keyword">while</span> waiting <span class="keyword">for</span> the machine to boot. This means that Vagrant was unable to communicate with the guest machine within the configured (<span class="string">"config.vm.boot_timeout"</span> value) time period.</span><br><span class="line"></span><br><span class="line">If you look above, you should be able to see the error(s) that Vagrant had when attempting to connect to the machine. These errors are usually good hints as to what may be wrong.</span><br><span class="line"></span><br><span class="line">If you<span class="string">'re using a custom box, make sure that networking is properly working and you'</span>re able to connect to the machine. It is a common problem that networking isn<span class="string">'t setup properly in these boxes. Verify that authentication configurations are also setup properly, as well.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">If the box appears to be booting properly, you may want to increase the timeout ("config.vm.boot_timeout") value.'</span></span><br></pre></td></tr></tbody></table></figure>
<h6 id="解决-4"><a href="#解决-4" class="headerlink" title="解决"></a>解决</h6><p>　升级 VirtualBox 到 5.1.12</p>
<h5 id="default-stdin-is-not-a-tty"><a href="#default-stdin-is-not-a-tty" class="headerlink" title="default: stdin: is not a tty"></a>default: stdin: is not a tty</h5><h6 id="描述-5"><a href="#描述-5" class="headerlink" title="描述"></a>描述</h6><p>　default: stdin: is not a tty</p>
<h6 id="解决-5"><a href="#解决-5" class="headerlink" title="解决"></a>解决</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">config.ssh.shell = <span class="string">"bash -c 'BASH_ENV=/etc/profile exec bash'"</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="Unittest"><a href="#Unittest" class="headerlink" title="Unittest"></a><a href="https://docs.python.org/3/library/unittest.html#test-discovery">Unittest</a></h3><h4 id="t-改变-顶级-package-路径"><a href="#t-改变-顶级-package-路径" class="headerlink" title="-t 改变 顶级 package 路径"></a>-t 改变 顶级 package 路径</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">The discover sub-command has the following options:</span><br><span class="line"></span><br><span class="line">  -v, --verbose                         Verbose output</span><br><span class="line">  -s, --start-directory directory       Directory to start discovery (. default)</span><br><span class="line">  -p, --pattern pattern                 Pattern to match <span class="built_in">test</span> files (<span class="built_in">test</span>*.py default)</span><br><span class="line">  -t, --top-level-directory directory   Top level directory of project (defaults to start directory)</span><br><span class="line"></span><br><span class="line">Name                          druid_tests</span><br><span class="line">Script                        E:\Core Code\superset-0.15.4\code\tests\druid_tests.py</span><br><span class="line">Environment variables         VIRTUALENVWRAPPER_PYTHON=E:\Core Code\superset-0.15.4\bin\python;PYTHONUNBUFFERED=1</span><br><span class="line">Python interpreter            Remote Python 2.7.12 (ssh://root@192.168.1.10:22/root/superset-0.15.4/bin/python)</span><br><span class="line">Interpreter options           -m tests.druid_tests</span><br><span class="line">Working directory             E:\Core Code\superset-0.15.4\code\</span><br><span class="line">Path mappings                 E:/Core Code/superset-0.15.4=/root/superset-0.15.4</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">export</span> SUPERSET_CONFIG=tests.superset_test_config</span><br><span class="line">$ python -m tests.druid_tests discover . <span class="string">"druid_tests.py"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试完成之后，需要 unset掉 SUPERSET_CONFIG</span></span><br><span class="line">$ <span class="built_in">unset</span> SUPERSET_CONFIG</span><br></pre></td></tr></tbody></table></figure>
<h3 id="参数解析"><a href="#参数解析" class="headerlink" title="参数解析"></a>参数解析</h3><ul>
<li>编写示例</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim blog.py</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">parser = argparse.ArgumentParser()</span><br><span class="line">parser.add_argument(<span class="string">'--ip'</span>, <span class="string">'-i'</span>, type=str, help=<span class="string">'ip'</span>, default=<span class="string">"localhost"</span>, required=<span class="literal">False</span>)</span><br><span class="line">parser.add_argument(<span class="string">'--port'</span>, <span class="string">'-p'</span>, type=int, help=<span class="string">'port'</span>, default=<span class="number">80</span>, required=<span class="literal">False</span>)</span><br><span class="line">parser.add_argument(<span class="string">'--debug'</span>, <span class="string">'-d'</span>, action=<span class="string">'store_true'</span>, help=<span class="string">'enable debug mode'</span>, default=<span class="literal">False</span>, required=<span class="literal">False</span>)</span><br><span class="line">args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">ip = str(args.ip)</span><br><span class="line">port = int(args.port)</span><br><span class="line">debug = args.debug</span><br><span class="line"><span class="keyword">if</span> port == <span class="number">80</span>:</span><br><span class="line">    blog = <span class="string">"https://%s"</span> % ip</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    blog = <span class="string">"https://%s:%s"</span> % (ip, port)</span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    print(blog)</span><br><span class="line">os.system(<span class="string">"open '%s'"</span> % blog)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>查看帮助文档</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ python3 blog.py -h</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">usage: blog.py [-h] [--ip IP] [--port PORT] [--debug]</span><br><span class="line"></span><br><span class="line">optional arguments:</span><br><span class="line">  -h, --<span class="built_in">help</span>            show this <span class="built_in">help</span> message and <span class="built_in">exit</span></span><br><span class="line">  --ip IP, -i IP        ip</span><br><span class="line">  --port PORT, -p PORT  port</span><br><span class="line">  --debug, -d           <span class="built_in">enable</span> debug mode</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>执行脚本</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ python3 blog.py -i yuzhouwan.com -d</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight html"><table><tbody><tr><td class="code"><pre><span class="line">https://yuzhouwan.com</span><br></pre></td></tr></tbody></table></figure>
<h2 id="踩过的坑-2"><a href="#踩过的坑-2" class="headerlink" title="踩过的坑"></a>踩过的坑</h2><h3 id="UnicodeDecodeError-‘gbk’-codec-can’t-decode-byte-0x87-in-position-illegal-multibyte-sequence"><a href="#UnicodeDecodeError-‘gbk’-codec-can’t-decode-byte-0x87-in-position-illegal-multibyte-sequence" class="headerlink" title="UnicodeDecodeError: ‘gbk’ codec can’t decode byte 0x87 in position illegal multibyte sequence"></a>UnicodeDecodeError: ‘gbk’ codec can’t decode byte 0x87 in position illegal multibyte sequence</h3><h4 id="解决-6"><a href="#解决-6" class="headerlink" title="解决"></a>解决</h4><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 在程序开头，指定编码，并在 open 文件的时候，指定 encoding 属性</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -*- coding:utf8 -*-</span></span><br><span class="line">open(fname, <span class="string">"r"</span>, encoding=<span class="string">"utf8"</span>)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="connection-broken-by-SSLError"><a href="#connection-broken-by-SSLError" class="headerlink" title="connection broken by SSLError"></a>connection broken by SSLError</h3><h4 id="解决-7"><a href="#解决-7" class="headerlink" title="解决"></a>解决</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ python -m pip install --trusted-host pypi.python.org --trusted-host files.pythonhosted.org --trusted-host pypi.org --upgrade pip</span><br></pre></td></tr></tbody></table></figure>
<h3 id="ModuleNotFoundError-No-module-named-‘yaml’"><a href="#ModuleNotFoundError-No-module-named-‘yaml’" class="headerlink" title="ModuleNotFoundError: No module named ‘yaml’"></a>ModuleNotFoundError: No module named ‘yaml’</h3><h4 id="解决-8"><a href="#解决-8" class="headerlink" title="解决"></a>解决</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ pip install pyyaml</span><br></pre></td></tr></tbody></table></figure>
<h3 id="ERROR-Gateway-Timeout"><a href="#ERROR-Gateway-Timeout" class="headerlink" title="ERROR: Gateway Timeout"></a>ERROR: Gateway Timeout</h3><h4 id="解决-9"><a href="#解决-9" class="headerlink" title="解决"></a>解决</h4><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭代理</span></span><br><span class="line">os.environ[<span class="string">'NO_PROXY'</span>] = <span class="string">'127.0.0.1'</span></span><br><span class="line">r = requests.get(<span class="string">'http://127.0.0.1:8080'</span>)</span><br></pre></td></tr></tbody></table></figure>
<h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><h3 id="Book"><a href="#Book" class="headerlink" title="Book"></a>Book</h3><ul>
<li><a href="https://www.amazon.com/Python-Data-Science-Handbook-Essential/dp/1491912057">Python Data Science Handbook: Essential Tools for Working with Data</a></li>
</ul>
<h3 id="Resource"><a href="#Resource" class="headerlink" title="Resource"></a>Resource</h3><ul>
<li><p><a href="https://github.com/vinta/awesome-python#awesome-python-">A curated list of awesome Python frameworks, libraries, software and resources</a></p>
</li>
<li><p><a href="http://pypl.github.io/PYPL.html">PYPL PopularitY of Programming Language</a></p>
<p><img data-src="/picture/language/pypl_popularity_of_programming_language.png" alt="PYPL PopularitY of Programming Language"></p>
<center>（图片来源：<a href="http://pypl.github.io/PYPL.html" target="_blank">pypl.github.io</a>™）</center>






</li>
</ul>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt=""></a></td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>语言</category>
      </categories>
      <tags>
        <tag>Apache Superset</tag>
        <tag>TensorFlow</tag>
        <tag>Python</tag>
        <tag>iPython</tag>
        <tag>人工智能</tag>
      </tags>
  </entry>
  <entry>
    <title>程序员的 Mac 高效手册</title>
    <url>/posts/190101/</url>
    <content><![CDATA[<h2 id="环境相关"><a href="#环境相关" class="headerlink" title="环境相关"></a>环境相关</h2><h3 id="右键开启-Terminal"><a href="#右键开启-Terminal" class="headerlink" title="右键开启 Terminal"></a>右键开启 Terminal</h3><p>　系统偏好设置 &gt; 键盘 &gt; 快捷键 &gt; 服务，勾选 “新建位于文件夹位置的终端窗口”</p>
<h3 id="右键创建新文件"><a href="#右键创建新文件" class="headerlink" title="右键创建新文件"></a>右键创建新文件</h3><p>　安装 “<a href="https://itunes.apple.com/cn/app/new-file-menu-free/id1066302071">New File Menu</a>“</p>
<h3 id="管理员权限打开-APP"><a href="#管理员权限打开-APP" class="headerlink" title="管理员权限打开 APP"></a>管理员权限打开 APP</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 以 Intellij IDEA 为例</span></span><br><span class="line">$ <span class="built_in">cd</span> /Applications</span><br><span class="line">$ sudo open -a <span class="string">'IntelliJ IDEA.app'</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="在命令行中用-Finder-打开当前目录"><a href="#在命令行中用-Finder-打开当前目录" class="headerlink" title="在命令行中用 Finder 打开当前目录"></a>在命令行中用 Finder 打开当前目录</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ open .</span><br></pre></td></tr></tbody></table></figure>
<h3 id="配置-PATH-环境变量"><a href="#配置-PATH-环境变量" class="headerlink" title="配置 PATH 环境变量"></a>配置 PATH 环境变量</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 环境变量的加载顺序是 /etc/profile /etc/paths ~/.bash_profile ~/.bash_login ~/.profile ~/.bashrc</span></span><br><span class="line"></span><br><span class="line">$ vim /etc/profile</span><br><span class="line">  <span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:&lt;PATH&gt;</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></tbody></table></figure>
<h3 id="查看本机信息"><a href="#查看本机信息" class="headerlink" title="查看本机信息"></a>查看本机信息</h3><h4 id="IP"><a href="#IP" class="headerlink" title="IP"></a>IP</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ ifconfig | grep <span class="string">"inet "</span> | grep -v 127.0.0.1</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">inet 8.8.8.8 netmask 0xfffff800 broadcast 8.8.8.8</span><br></pre></td></tr></tbody></table></figure>
<h4 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ nslookup store.chanjet.com</span><br><span class="line">$ cat /etc/resolv.conf</span><br></pre></td></tr></tbody></table></figure>
<h3 id="轻点触摸板"><a href="#轻点触摸板" class="headerlink" title="轻点触摸板"></a>轻点触摸板</h3><p><img data-src="/picture/mac/mac_soft_click_on_touch_board.png" alt="Soft click on mac touch board"></p>
<center>（对 <a href="https://www.apple.com/mac/" target="_blank">Mac</a>™ 的截图）</center>




<h2 id="Java-相关"><a href="#Java-相关" class="headerlink" title="Java 相关"></a>Java 相关</h2><h3 id="查看-JDK-安装目录"><a href="#查看-JDK-安装目录" class="headerlink" title="查看 JDK 安装目录"></a>查看 JDK 安装目录</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ /usr/libexec/java_home -V</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">Matching Java Virtual Machines (1):</span><br><span class="line">  1.8.0_231, x86_64:  <span class="string">"Java SE 8"</span></span><br><span class="line">  /Library/Java/JavaVirtualMachines/jdk1.8.0_231.jdk/Contents/Home</span><br></pre></td></tr></tbody></table></figure>
<h3 id="多-JDK-版本"><a href="#多-JDK-版本" class="headerlink" title="多 JDK 版本"></a>多 JDK 版本</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim ~/.bashrc</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">alias</span> /usr/libexec/java_home=<span class="string">'echo $JAVA_HOME'</span></span><br><span class="line"><span class="built_in">unalias</span> /usr/libexec/java_home</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> JAVA_8_HOME=$(/usr/libexec/java_home -v1.8)</span><br><span class="line"><span class="built_in">export</span> JAVA_12_HOME=$(/usr/libexec/java_home -v12)</span><br><span class="line"></span><br><span class="line"><span class="built_in">alias</span> java8=<span class="string">'export JAVA_HOME=$JAVA_8_HOME'</span></span><br><span class="line"><span class="built_in">alias</span> java12=<span class="string">'export JAVA_HOME=$JAVA_12_HOME'</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">alias</span> /usr/libexec/java_home=<span class="string">'echo $JAVA_HOME'</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=<span class="variable">$JAVA_8_HOME</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$JAVA_HOME</span>/bin</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">source</span> ~/.bashrc</span><br><span class="line"><span class="comment"># 默认 JDK8</span></span><br><span class="line">$ java -version</span><br><span class="line">  java version <span class="string">"1.8.0_231"</span></span><br><span class="line">  Java(TM) SE Runtime Environment (build 1.8.0_231-b11)</span><br><span class="line">  Java HotSpot(TM) 64-Bit Server VM (build 25.231-b11, mixed mode)</span><br><span class="line">$ /usr/libexec/java_home</span><br><span class="line">  /Library/Java/JavaVirtualMachines/jdk1.8.0_231.jdk/Contents/Home</span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换到 JDK12</span></span><br><span class="line">$ java12</span><br><span class="line">$ java -version</span><br><span class="line">  java version <span class="string">"12.0.2"</span> 2019-07-16</span><br><span class="line">  Java(TM) SE Runtime Environment (build 12.0.2+10)</span><br><span class="line">  Java HotSpot(TM) 64-Bit Server VM (build 12.0.2+10, mixed mode, sharing)</span><br><span class="line">$ /usr/libexec/java_home</span><br><span class="line">  /Library/Java/JavaVirtualMachines/jdk-12.0.2.jdk/Contents/Home</span><br></pre></td></tr></tbody></table></figure>
<p>Tips: 更多 Java 实用技巧，详见《<a href="https://yuzhouwan.com/posts/190413/">那些绕不过去的 Java 知识点</a>》</p>
<h2 id="Maven-相关"><a href="#Maven-相关" class="headerlink" title="Maven 相关"></a>Maven 相关</h2><h3 id="权限不足导致下载失败"><a href="#权限不足导致下载失败" class="headerlink" title="权限不足导致下载失败"></a>权限不足导致下载失败</h3><h4 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h4><p>　报错无法解析依赖，找不到 <code>xxx.lock</code> 文件</p>
<h4 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h4><p>　对 Maven 的依赖文件存放目录赋权即可</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ sudo chown -R benedictjin:wheel /data/maven/repo</span><br></pre></td></tr></tbody></table></figure>
<h4 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h4><p>　另外，还可以通过以下一系列命令，统一对目录下的所有文件和文件夹进行权限修改</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ sudo chown -R benedictjin:wheel *</span><br><span class="line">$ sudo chmod -R g+rwX .</span><br><span class="line">$ sudo find . -<span class="built_in">type</span> d -<span class="built_in">exec</span> chmod 755 {} \;</span><br><span class="line">$ sudo find . -<span class="built_in">type</span> f -<span class="built_in">exec</span> chmod 644 {} \;</span><br></pre></td></tr></tbody></table></figure>
<p>　同理，还可以利用这个方法，删除 <code>.DS_Store</code> 文件</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 查看过滤出来的文件</span></span><br><span class="line">$ find . -name <span class="string">'.DS_Store'</span></span><br><span class="line"><span class="comment"># 删除</span></span><br><span class="line">$ find . -name <span class="string">'.DS_Store'</span> -<span class="built_in">type</span> f -<span class="built_in">exec</span> rm -f {} \;</span><br><span class="line"><span class="comment"># 再次检查</span></span><br><span class="line">$ find . -name <span class="string">'.DS_Store'</span></span><br></pre></td></tr></tbody></table></figure>
<p>　而如果需要执行多个命令的话，可以指定多个 <code>-exec</code> 参数</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 找到后缀为 .md 的文件，执行 grep 命令，如果命中规则，则执行后续的 echo 命令</span></span><br><span class="line">$ find . -name <span class="string">'*.md'</span> -<span class="built_in">type</span> f -<span class="built_in">exec</span> grep <span class="string">'##'</span> {} \; -<span class="built_in">exec</span> <span class="built_in">echo</span> {} \;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以不用关心第一个命令是否执行成功，具体写法如下：</span></span><br><span class="line">$ find . -name <span class="string">'*.md'</span> -<span class="built_in">type</span> f \( -<span class="built_in">exec</span> grep <span class="string">'##'</span> {} \; -o -<span class="built_in">exec</span> <span class="literal">true</span> \; \) -<span class="built_in">exec</span> <span class="built_in">echo</span> {} \;</span><br></pre></td></tr></tbody></table></figure>
<p>Tips: 更多 Maven 实用技巧，详见《<a href="https://yuzhouwan.com/posts/2254/">Maven 高级玩法</a>》</p>
<h2 id="命令相关"><a href="#命令相关" class="headerlink" title="命令相关"></a>命令相关</h2><h3 id="brew"><a href="#brew" class="headerlink" title="brew"></a><a href="https://brew.sh/">brew</a></h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 使用国内的镜像</span></span><br><span class="line">$ <span class="built_in">cd</span> <span class="string">"<span class="subst">$(brew --repo)</span>"</span></span><br><span class="line">$ git remote <span class="built_in">set</span>-url origin git://mirrors.ustc.edu.cn/brew.git</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> <span class="string">"<span class="subst">$(brew --repo)</span>/Library/Taps/homebrew/homebrew-core"</span></span><br><span class="line">$ git remote <span class="built_in">set</span>-url origin git://mirrors.ustc.edu.cn/homebrew-core.git</span><br><span class="line"></span><br><span class="line">$ brew update</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">'export HOMEBREW_BOTTLE_DOMAIN=https://mirrors.ustc.edu.cn/homebrew-bottles'</span> &gt;&gt; ~/.bash_profile</span><br><span class="line">$ <span class="built_in">source</span> ~/.bash_profile</span><br></pre></td></tr></tbody></table></figure>
<h3 id="ccat"><a href="#ccat" class="headerlink" title="ccat"></a><a href="https://github.com/jingweno/ccat">ccat</a></h3><p>　操作类似 cat 命令，但是高亮了输出</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 使用 brew 安装</span></span><br><span class="line">$ brew install ccat</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看最后一次的代码修改</span></span><br><span class="line">$ git diff HEAD^ | ccat</span><br></pre></td></tr></tbody></table></figure>
<h3 id="diskutil"><a href="#diskutil" class="headerlink" title="diskutil"></a><a href="https://support.apple.com/zh-cn/HT208496">diskutil</a></h3><p>　通过命令行格式化 U 盘</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 查看磁盘列表</span></span><br><span class="line">$ diskutil list</span><br><span class="line"><span class="comment"># 分区 /dev/disk2 为 U 盘，将其卸载</span></span><br><span class="line">$ diskutil unmountDisk /dev/disk2</span><br><span class="line"><span class="comment"># 执行格式化命令</span></span><br><span class="line">$ diskutil eraseDisk JHFS+ raspberry disk2</span><br></pre></td></tr></tbody></table></figure>
<h3 id="fd"><a href="#fd" class="headerlink" title="fd"></a><a href="https://github.com/sharkdp/fd">fd</a></h3><p>　简化了 find 命令，使用起来更加简单高效，还会自动忽略隐藏目录（如 <code>.git/</code>、<code>.deploy_git/</code> 等）</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ brew install fd</span><br><span class="line">$ fd xml</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">pom.xml</span><br><span class="line">processing/pom.xml</span><br><span class="line">server/pom.xml</span><br><span class="line">services/pom.xml</span><br><span class="line">sql/pom.xml</span><br></pre></td></tr></tbody></table></figure>
<h3 id="ggrep"><a href="#ggrep" class="headerlink" title="ggrep"></a><a href="https://github.com/sharkdp/fd">ggrep</a></h3><p>　自带的 grep 命令不支持前缀匹配等操作，而 ggrep 命令可以有效地支持高阶正则表达式</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ brew install grep</span><br><span class="line"></span><br><span class="line"><span class="comment"># 匹配 + 加号左右两边没有空格的情况</span></span><br><span class="line">$ find . -name <span class="string">'*.md'</span> -<span class="built_in">type</span> f -<span class="built_in">exec</span> ggrep -Pio <span class="string">'(?! )\+(?! )| \+(?! )|(?&lt;! )\+ '</span> {} \; -<span class="built_in">exec</span> <span class="built_in">echo</span> {} \;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="htop"><a href="#htop" class="headerlink" title="htop"></a><a href="https://hisham.hm/htop/">htop</a></h3><p>　增强了 top 命令，展示页面更加丰富</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ brew install htop</span><br><span class="line">$ htop</span><br></pre></td></tr></tbody></table></figure>
<h3 id="tldr"><a href="#tldr" class="headerlink" title="tldr"></a><a href="https://github.com/tldr-pages/tldr">tldr</a></h3><p>　强化 man 命令，对展示的文档进行了简化，并展示了对应的例子</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 使用 npm 安装</span></span><br><span class="line">$ npm install -g tldr</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 cd 命令的使用文档</span></span><br><span class="line">$ tldr <span class="built_in">cd</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">✔ Page not found. Updating cache...</span><br><span class="line">✔ Creating index...</span><br><span class="line"></span><br><span class="line">  <span class="built_in">cd</span></span><br><span class="line"></span><br><span class="line">  Change the current working directory.</span><br><span class="line"></span><br><span class="line">  - Go to the given directory:</span><br><span class="line">    <span class="built_in">cd</span> path/to/directory</span><br><span class="line"></span><br><span class="line">  - Go to home directory of current user:</span><br><span class="line">    <span class="built_in">cd</span></span><br><span class="line"></span><br><span class="line">  - Go up to the parent of the current directory:</span><br><span class="line">    <span class="built_in">cd</span> ..</span><br><span class="line"></span><br><span class="line">  - Go to the previously chosen directory:</span><br><span class="line">    <span class="built_in">cd</span> -</span><br></pre></td></tr></tbody></table></figure>
<h3 id="tree"><a href="#tree" class="headerlink" title="tree"></a>tree</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 使用 brew 安装</span></span><br><span class="line">$ brew install tree</span><br><span class="line"></span><br><span class="line"><span class="comment"># 展示目录结构，这里我们以 ElasticSearch 的数据目录为例</span></span><br><span class="line">$ <span class="built_in">cd</span> <span class="variable">$ES_HOME</span>/data</span><br><span class="line">$ tree -L 5</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">.</span><br><span class="line">└── nodes</span><br><span class="line">    └── 0</span><br><span class="line">        ├── _state</span><br><span class="line">        │&nbsp;&nbsp; ├── global-20.st</span><br><span class="line">        │&nbsp;&nbsp; ├── manifest-35.st</span><br><span class="line">        │&nbsp;&nbsp; └── node-3.st</span><br><span class="line">        └── node.lock</span><br><span class="line"></span><br><span class="line">3 directories, 4 files</span><br></pre></td></tr></tbody></table></figure>
<h2 id="工具相关"><a href="#工具相关" class="headerlink" title="工具相关"></a>工具相关</h2><h3 id="Sublime"><a href="#Sublime" class="headerlink" title="Sublime"></a><a href="https://www.sublimetext.com/">Sublime</a></h3><h4 id="展示空格和制表符"><a href="#展示空格和制表符" class="headerlink" title="展示空格和制表符"></a>展示空格和制表符</h4><p>　使用 ⌘, 组合快捷键后，增加 <code>"draw_white_space": "all"</code> 配置项</p>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"color_scheme"</span>: <span class="string">"Packages/Color Scheme - Default/Mariana.sublime-color-scheme"</span>,</span><br><span class="line">  <span class="attr">"font_size"</span>: <span class="number">14</span>,</span><br><span class="line">  <span class="attr">"ignored_packages"</span>: [</span><br><span class="line">    <span class="string">"Vintage"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"word_wrap"</span>: <span class="string">"true"</span>,</span><br><span class="line">  <span class="attr">"draw_white_space"</span>: <span class="string">"all"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="删除重复行"><a href="#删除重复行" class="headerlink" title="删除重复行"></a>删除重复行</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># ⌥+⌘+F 打开替换模式，并打开正则表达式的开关</span></span><br><span class="line">^(.+)$[\r\n](^\1$[\r\n]{0, 1})+</span><br></pre></td></tr></tbody></table></figure>
<h4 id="常用插件"><a href="#常用插件" class="headerlink" title="常用插件"></a>常用插件</h4><h5 id="JSON-格式化"><a href="#JSON-格式化" class="headerlink" title="JSON 格式化"></a>JSON 格式化</h5><p>　使用 ⌘⇧P 组合快捷键后，输入 <code>Pretty JSON: Validate</code> 再回车，对文件中的 JSON 进行校验；输入 <code>Pretty JSON: Format and Sort JSON</code> 再回车，对文件中的 JSON 进行格式化；输入 <code>Pretty JSON: Minify (compress) JSON</code> 再回车，将文件中的 JSON 压缩成一行</p>
<h5 id="二进制文件可视化"><a href="#二进制文件可视化" class="headerlink" title="二进制文件可视化"></a>二进制文件可视化</h5><p>　使用 ⌘⇧P 组合快捷键后，输入 <code>HexViewer: Toggle Hex View</code> 再回车，开启二进制可视化功能</p>
<h3 id="iTerm2"><a href="#iTerm2" class="headerlink" title="iTerm2"></a><a href="https://iterm2.com/">iTerm2</a></h3><h4 id="安装-amp-卸载-zsh"><a href="#安装-amp-卸载-zsh" class="headerlink" title="安装 &amp; 卸载 zsh"></a>安装 &amp; 卸载 zsh</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ sh -c <span class="string">"<span class="subst">$(curl -fsSL https://raw.github.com/robbyrussell/oh-my-zsh/master/tools/install.sh)</span>"</span></span><br><span class="line">$ uninstall_oh_my_zsh</span><br></pre></td></tr></tbody></table></figure>
<h4 id="配置主题"><a href="#配置主题" class="headerlink" title="配置主题"></a>配置主题</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim ~/.zshrc</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">ZSH_THEME=<span class="string">"agnoster"</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="高亮"><a href="#高亮" class="headerlink" title="高亮"></a>高亮</h4><h5 id="语法高亮"><a href="#语法高亮" class="headerlink" title="语法高亮"></a>语法高亮</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ brew install zsh-syntax-highlighting</span><br><span class="line">$ vim ~/.zshrc</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">source</span> /usr/<span class="built_in">local</span>/Cellar/zsh-syntax-highlighting/0.6.0/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh</span><br></pre></td></tr></tbody></table></figure>
<h5 id="vim-高亮"><a href="#vim-高亮" class="headerlink" title="vim 高亮"></a><a href="https://ethanschoonover.com/solarized/">vim 高亮</a></h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ wget http://ethanschoonover.com/solarized/files/solarized.zip</span><br><span class="line">$ unzip solarized.zip</span><br><span class="line">$ <span class="built_in">cd</span> solarized/vim-colors-solarized/colors</span><br><span class="line">$ mkdir -p ~/.vim/colors</span><br><span class="line">$ cp solarized.vim ~/.vim/colors/</span><br><span class="line">$ vi ~/.vimrc</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">syntax <span class="built_in">enable</span></span><br><span class="line"><span class="built_in">set</span> background=dark</span><br><span class="line">colorscheme solarized</span><br></pre></td></tr></tbody></table></figure>
<h5 id="ls-高亮"><a href="#ls-高亮" class="headerlink" title="ls 高亮"></a>ls 高亮</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ brew install coreutils</span><br><span class="line">$ gdircolors --<span class="built_in">print</span>-database &gt; ~/.dir_colors</span><br><span class="line">$ vim ~/.zshrc</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> brew list | grep coreutils &gt; /dev/null ; <span class="keyword">then</span> PATH=<span class="string">"<span class="subst">$(brew --prefix coreutils)</span>/libexec/gnubin:<span class="variable">$PATH</span>"</span> <span class="built_in">alias</span> ls=<span class="string">'ls -F --show-control-chars --color=auto'</span> <span class="built_in">eval</span> `gdircolors -b <span class="variable">$HOME</span>/.dir_colors` <span class="keyword">fi</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="加载环境变量"><a href="#加载环境变量" class="headerlink" title="加载环境变量"></a>加载环境变量</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim ~/.zshrc</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># .zshrc 的最后一行加入</span></span><br><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br></pre></td></tr></tbody></table></figure>
<h4 id="自动补齐"><a href="#自动补齐" class="headerlink" title="自动补齐"></a>自动补齐</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/.oh-my-zsh/custom/plugins</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/zsh-users/zsh-autosuggestions.git <span class="variable">$ZSH_CUSTOM</span>/plugins/zsh-autosuggestions</span><br><span class="line">$ vim ~/.zshrc</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># plugins=(git)</span></span><br><span class="line"><span class="comment"># 修改为：</span></span><br><span class="line">plugins=(zsh-autosuggestions git)</span><br></pre></td></tr></tbody></table></figure>
<h4 id="自动补全只能看到一个字符"><a href="#自动补全只能看到一个字符" class="headerlink" title="自动补全只能看到一个字符"></a>自动补全只能看到一个字符</h4><p>　如果发现自动提示的命令只能展示出一个字符，则说明 ANSI Colors 里面第一行的 Normal 和 Bright 颜色过于相近</p>
<h4 id="scp-报错-cannot-change-locale-UTF-8"><a href="#scp-报错-cannot-change-locale-UTF-8" class="headerlink" title="scp 报错 cannot change locale (UTF-8)"></a>scp 报错 cannot change locale (UTF-8)</h4><p>　使用 zsh 替代了 Mac 上原生的 bash 之后，本地化的设置默认是没有配置的，可以通过 <a href="https://yuzhouwan.com/posts/15691/#locale">locale</a> 命令来检查。解决方法也很简单，具体操作如下：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim ~/.zshrc</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> LC_ALL=en_US.UTF-8</span><br><span class="line"><span class="built_in">export</span> LANG=en_US.UTF-8</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">source</span> ~/.zshrc</span><br><span class="line">$ locale</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">LANG=<span class="string">"en_US.UTF-8"</span></span><br><span class="line">LC_COLLATE=<span class="string">"en_US.UTF-8"</span></span><br><span class="line">LC_CTYPE=<span class="string">"en_US.UTF-8"</span></span><br><span class="line">LC_MESSAGES=<span class="string">"en_US.UTF-8"</span></span><br><span class="line">LC_MONETARY=<span class="string">"en_US.UTF-8"</span></span><br><span class="line">LC_NUMERIC=<span class="string">"en_US.UTF-8"</span></span><br><span class="line">LC_TIME=<span class="string">"en_US.UTF-8"</span></span><br><span class="line">LC_ALL=<span class="string">"en_US.UTF-8"</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="删除-zsh-历史记录"><a href="#删除-zsh-历史记录" class="headerlink" title="删除 zsh 历史记录"></a>删除 zsh 历史记录</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">""</span> &gt; ~/.zsh_history &amp; <span class="built_in">exec</span> <span class="variable">$SHELL</span> -l</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Intellij-IDEA"><a href="#Intellij-IDEA" class="headerlink" title="Intellij IDEA"></a>Intellij IDEA</h3><h4 id="不停顿地-Debug"><a href="#不停顿地-Debug" class="headerlink" title="不停顿地 Debug"></a>不停顿地 Debug</h4><p><img data-src="/picture/idea/idea_debug_without_pause.png" alt="Debug without pause in Intellij IDEA"></p>
<center>（对 <a href="https://www.jetbrains.com/idea/" target="_blank">IntelliJ IDEA</a>™ 的截图）</center>

<h4 id="Debug-启动的时候，卡在了-Finished-saving-caches"><a href="#Debug-启动的时候，卡在了-Finished-saving-caches" class="headerlink" title="Debug 启动的时候，卡在了 Finished, saving caches"></a>Debug 启动的时候，卡在了 Finished, saving caches</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 获取 Mac 的 hostname</span></span><br><span class="line">$ hostname</span><br><span class="line">  BenedictJin.local</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加到 hosts 文件，即可解决</span></span><br><span class="line">$ sudo vim /etc/hosts</span><br><span class="line">  127.0.0.1       localhost        BenedictJin.local</span><br></pre></td></tr></tbody></table></figure>
<h4 id="只格式化自己修改的代码"><a href="#只格式化自己修改的代码" class="headerlink" title="只格式化自己修改的代码"></a>只格式化自己修改的代码</h4><p>　通过 <code>⌘⌥⇧L</code> 组合快捷键打开配置面板，选择 <code>Only VCS changed text</code> 后，再次使用 <code>⌘⌥L</code> 组合快捷键格式化代码，便只会影响本次修改的、尚未 commit 的代码了</p>
<p><img data-src="/picture/idea/idea_only_vcs_changed_text.png" alt="Only VCS changed text in Intellij IDEA"></p>
<center>（对 <a href="https://www.jetbrains.com/idea/" target="_blank">IntelliJ IDEA</a>™ 的截图）</center>

<h4 id="生成-SerialVersionUID"><a href="#生成-SerialVersionUID" class="headerlink" title="生成 SerialVersionUID"></a>生成 SerialVersionUID</h4><p>　安装 GenerateSerialVersionUID 插件后，在类文件中，使用 <code>⌘N</code> 组合快捷键，并选择 SerialVersionUID 菜单，即可生成类似如下的一行代码：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">90000066L</span>;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Typroa"><a href="#Typroa" class="headerlink" title="Typroa"></a>Typroa</h3><h4 id="支持-callout"><a href="#支持-callout" class="headerlink" title="支持 callout"></a>支持 callout</h4><p>　首先通过 <code>⌘,</code> 快速打开 Typroa 的控制面板，依次点击 <code>General</code> - <code>Open Theme Folder</code> 按钮，打开 <code>theme</code> 目录，并在该目录下新建 <code>base.user.css</code> 文件，填写如下内容：</p>
<figure class="highlight css"><table><tbody><tr><td class="code"><pre><span class="line"><span class="selector-tag">div</span><span class="selector-attr">[style^=<span class="string">'callout:'</span>]</span> {</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">20px</span> <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#eee</span>;</span><br><span class="line">    <span class="attribute">border-left-width</span>: <span class="number">6px</span> <span class="meta">!important</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">3px</span>;</span><br><span class="line">}</span><br><span class="line"><span class="selector-tag">div</span><span class="selector-attr">[style^=<span class="string">'callout:'</span>]</span> <span class="selector-tag">h4</span> {</span><br><span class="line">    <span class="attribute">margin-top</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">1em</span>;</span><br><span class="line">}</span><br><span class="line"><span class="selector-tag">div</span><span class="selector-attr">[style^=<span class="string">'callout:'</span>]</span> <span class="selector-tag">p</span><span class="selector-pseudo">:last-child</span> {</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"><span class="selector-tag">div</span><span class="selector-attr">[style^=<span class="string">'callout:'</span>]</span> <span class="selector-tag">code</span> {</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">3px</span>;</span><br><span class="line">}</span><br><span class="line"><span class="selector-tag">div</span><span class="selector-attr">[style^=<span class="string">'callout:'</span>]</span>+<span class="selector-tag">div</span><span class="selector-attr">[style^=<span class="string">'callout:'</span>]</span> {</span><br><span class="line">    <span class="attribute">margin-top</span>: -<span class="number">5px</span>;</span><br><span class="line">}</span><br><span class="line"><span class="selector-tag">div</span><span class="selector-attr">[style=<span class="string">'callout:default'</span>]</span> {</span><br><span class="line">    <span class="attribute">border-left-color</span>: <span class="number">#777</span> <span class="meta">!important</span>;</span><br><span class="line">}</span><br><span class="line"><span class="selector-tag">div</span><span class="selector-attr">[style=<span class="string">'callout:default'</span>]</span> <span class="selector-tag">h4</span> {</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#777</span> <span class="meta">!important</span>;</span><br><span class="line">}</span><br><span class="line"><span class="selector-tag">div</span><span class="selector-attr">[style=<span class="string">'callout:primary'</span>]</span> {</span><br><span class="line">    <span class="attribute">border-left-color</span>: <span class="number">#428bca</span> <span class="meta">!important</span>;</span><br><span class="line">}</span><br><span class="line"><span class="selector-tag">div</span><span class="selector-attr">[style=<span class="string">'callout:primary'</span>]</span> <span class="selector-tag">h4</span> {</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#428bca</span> <span class="meta">!important</span>;</span><br><span class="line">}</span><br><span class="line"><span class="selector-tag">div</span><span class="selector-attr">[style=<span class="string">'callout:success'</span>]</span> {</span><br><span class="line">    <span class="attribute">border-left-color</span>: <span class="number">#5cb85c</span> <span class="meta">!important</span>;</span><br><span class="line">}</span><br><span class="line"><span class="selector-tag">div</span><span class="selector-attr">[style=<span class="string">'callout:success'</span>]</span> <span class="selector-tag">h4</span> {</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#5cb85c</span> <span class="meta">!important</span>;</span><br><span class="line">}</span><br><span class="line"><span class="selector-tag">div</span><span class="selector-attr">[style=<span class="string">'callout:danger'</span>]</span> {</span><br><span class="line">    <span class="attribute">border-left-color</span>: <span class="number">#d9534f</span> <span class="meta">!important</span>;</span><br><span class="line">}</span><br><span class="line"><span class="selector-tag">div</span><span class="selector-attr">[style=<span class="string">'callout:danger'</span>]</span> <span class="selector-tag">h4</span> {</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#d9534f</span> <span class="meta">!important</span>;</span><br><span class="line">}</span><br><span class="line"><span class="selector-tag">div</span><span class="selector-attr">[style=<span class="string">'callout:warning'</span>]</span> {</span><br><span class="line">    <span class="attribute">border-left-color</span>: <span class="number">#f0ad4e</span> <span class="meta">!important</span>;</span><br><span class="line">}</span><br><span class="line"><span class="selector-tag">div</span><span class="selector-attr">[style^=<span class="string">'callout:warning'</span>]</span> <span class="selector-tag">h4</span> {</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#f0ad4e</span> <span class="meta">!important</span>;</span><br><span class="line">}</span><br><span class="line"><span class="selector-tag">div</span><span class="selector-attr">[style^=<span class="string">'callout:info'</span>]</span> {</span><br><span class="line">    <span class="attribute">border-left-color</span>: <span class="number">#5bc0de</span> <span class="meta">!important</span>;</span><br><span class="line">}</span><br><span class="line"><span class="selector-tag">div</span><span class="selector-attr">[style^=<span class="string">'callout:info'</span>]</span> <span class="selector-tag">h4</span> {</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#5bc0de</span> <span class="meta">!important</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>　重启 Typroa 之后，即可使用 callout 功能：</p>
<figure class="highlight html"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"callout:default"</span>&gt;</span>default<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"callout:primary"</span>&gt;</span>primary<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"callout:success"</span>&gt;</span>success<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"callout:warning"</span>&gt;</span>warning<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"callout:info"</span>&gt;</span>info<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<p>　效果如下：</p>
<p><img data-src="/picture/mac/mac_typroa_callout.png" alt="Markdown Callout in Typroa"></p>
<center>（对 <a href="https://typora.io/" target="_blank">Typroa</a>™ 的截图）</center>


<h3 id="Chrome"><a href="#Chrome" class="headerlink" title="Chrome"></a>Chrome</h3><h4 id="Octotree-代码大纲"><a href="#Octotree-代码大纲" class="headerlink" title="Octotree 代码大纲"></a>Octotree 代码大纲</h4><p><img data-src="/picture/mac/mac_octotree.png" alt="Octotree"></p>
<center>（对 <a href="https://github.com/asdf2014" target="_blank">Github</a>™ 的截图）</center>

<h4 id="Isometric-Contributions-可视化"><a href="#Isometric-Contributions-可视化" class="headerlink" title="Isometric Contributions 可视化"></a>Isometric Contributions 可视化</h4><p><img data-src="/picture/mac/mac_asdf2014_on_isometric_contributions.png" alt="asdf2014 on Isometric Contributions"></p>
<center>（对 <a href="https://github.com/asdf2014" target="_blank">Github</a>™ 的截图）</center>



<h3 id="asciinema"><a href="#asciinema" class="headerlink" title="asciinema"></a><a href="https://github.com/asciinema/asciinema">asciinema</a></h3><h4 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ brew install asciinema</span><br><span class="line">$ asciinema rec</span><br><span class="line"><span class="comment"># 录制成功后，exit 退出即可</span></span><br><span class="line"><span class="comment"># 支持保存在本地，或发布在 asciinema.org 网站上</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="鉴权"><a href="#鉴权" class="headerlink" title="鉴权"></a>鉴权</h4><p>　如果你担心发布在网上，存在隐私问题。你可以注册 ascinema 的账号，并设置录制内容是否公开（默认为 private）</p>
<h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ asciinema rec</span><br><span class="line">$ <span class="built_in">cd</span> /tmp</span><br><span class="line">$ vim open.sh</span><br><span class="line">  open <span class="string">'https://yuzhouwan.com/'</span></span><br><span class="line">$ sh open.sh</span><br><span class="line">$ <span class="built_in">exit</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="转-gif"><a href="#转-gif" class="headerlink" title="转 gif"></a><a href="https://github.com/asciinema/asciicast2gif">转 gif</a></h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ brew install imagemagick</span><br><span class="line">$ brew install gifsicle</span><br><span class="line">$ npm install --global asciicast2gif</span><br><span class="line">$ asciicast2gif https://asciinema.org/a/246879.json 246879.gif</span><br></pre></td></tr></tbody></table></figure>
<h4 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h4><p><a href="https://asciinema.org/a/246879"><img data-src="https://asciinema.org/a/246879.svg" alt="Asciinema Example"></a></p>
<center>（利用 <a href="https://asciinema.org/a/246879" target="_blank">Asciinema</a>™ 录制而成）</center>


<h3 id="Alfred"><a href="#Alfred" class="headerlink" title="Alfred"></a>Alfred</h3><h4 id="使用-iTerm2-作为-Alfred-的默认命令行"><a href="#使用-iTerm2-作为-Alfred-的默认命令行" class="headerlink" title="使用 iTerm2 作为 Alfred 的默认命令行"></a><a href="https://github.com/vitorgalvao/custom-alfred-iterm-scripts">使用 iTerm2 作为 Alfred 的默认命令行</a></h4><p>　使用 ⌘, 组合快捷键后，进入 <code>Features</code> - <code>Terminal</code> - <code>Application</code>，选择 <code>Custom</code> 后，填入以下脚本即可：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">-- Set this property to <span class="literal">true</span> to always open <span class="keyword">in</span> a new window</span><br><span class="line">property open_in_new_window : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">-- Handlers</span><br><span class="line">on new_window()</span><br><span class="line">  tell application <span class="string">"iTerm"</span> to create window with default profile</span><br><span class="line">end new_window</span><br><span class="line"></span><br><span class="line">on new_tab()</span><br><span class="line">  tell application <span class="string">"iTerm"</span> to tell the first window to create tab with default profile</span><br><span class="line">end new_tab</span><br><span class="line"></span><br><span class="line">on call_forward()</span><br><span class="line">  tell application <span class="string">"iTerm"</span> to activate</span><br><span class="line">end call_forward</span><br><span class="line"></span><br><span class="line">on is_running()</span><br><span class="line">  application <span class="string">"iTerm"</span> is running</span><br><span class="line">end is_running</span><br><span class="line"></span><br><span class="line">on has_windows()</span><br><span class="line">  <span class="keyword">if</span> not is_running() <span class="keyword">then</span> <span class="built_in">return</span> <span class="literal">false</span></span><br><span class="line">  <span class="keyword">if</span> windows of application <span class="string">"iTerm"</span> is {} <span class="keyword">then</span> <span class="built_in">return</span> <span class="literal">false</span></span><br><span class="line">  <span class="literal">true</span></span><br><span class="line">end has_windows</span><br><span class="line"></span><br><span class="line">on send_text(custom_text)</span><br><span class="line">  tell application <span class="string">"iTerm"</span> to tell the first window to tell current session to write text custom_text</span><br><span class="line">end send_text</span><br><span class="line"></span><br><span class="line">-- Main</span><br><span class="line">on alfred_script(query)</span><br><span class="line">  <span class="keyword">if</span> has_windows() <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> open_in_new_window <span class="keyword">then</span></span><br><span class="line">      new_window()</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      new_tab()</span><br><span class="line">    end <span class="keyword">if</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    -- If iTerm is not running and we tell it to create a new window, we get two</span><br><span class="line">    -- One from opening the application, and the other from the <span class="built_in">command</span></span><br><span class="line">    <span class="keyword">if</span> is_running() <span class="keyword">then</span></span><br><span class="line">      new_window()</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      call_forward()</span><br><span class="line">    end <span class="keyword">if</span></span><br><span class="line">  end <span class="keyword">if</span></span><br><span class="line"></span><br><span class="line">  -- Make sure a window exists before we <span class="built_in">continue</span>, or the write may fail</span><br><span class="line">  repeat until has_windows()</span><br><span class="line">    delay 0.01</span><br><span class="line">  end repeat</span><br><span class="line"></span><br><span class="line">  send_text(query)</span><br><span class="line">  call_forward()</span><br><span class="line">end alfred_script</span><br></pre></td></tr></tbody></table></figure>
<h2 id="快捷键"><a href="#快捷键" class="headerlink" title="快捷键"></a>快捷键</h2><h3 id="Mac-键盘符号"><a href="#Mac-键盘符号" class="headerlink" title="Mac 键盘符号"></a>Mac 键盘符号</h3><div class="table-container">
<table>
<thead>
<tr>
<th>键盘符号</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>⌘</td>
<td>Command</td>
</tr>
<tr>
<td>⇧</td>
<td>Shift</td>
</tr>
<tr>
<td>⌥</td>
<td>Option</td>
</tr>
<tr>
<td>⌃</td>
<td>Control</td>
</tr>
<tr>
<td>↩︎</td>
<td>Return / Enter</td>
</tr>
<tr>
<td>⌫</td>
<td>Delete</td>
</tr>
<tr>
<td>⌦</td>
<td>向前删除键（Fn + Delete）</td>
</tr>
<tr>
<td>↑</td>
<td>上箭头</td>
</tr>
<tr>
<td>↓</td>
<td>下箭头</td>
</tr>
<tr>
<td>←</td>
<td>左箭头</td>
</tr>
<tr>
<td>→</td>
<td>右箭头</td>
</tr>
<tr>
<td>⇞</td>
<td>Page Up（Fn + ↑）</td>
</tr>
<tr>
<td>⇟</td>
<td>Page Down（Fn + ↓）</td>
</tr>
<tr>
<td>Fn + ←</td>
<td>Home</td>
</tr>
<tr>
<td>Fn + →</td>
<td>End</td>
</tr>
<tr>
<td>⇥</td>
<td>右制表符（Tab 键）</td>
</tr>
<tr>
<td>⇤</td>
<td>左制表符（Shift + Tab）</td>
</tr>
<tr>
<td>⎋</td>
<td>Escape（Esc）</td>
</tr>
</tbody>
</table>
</div>
<h3 id="Mac-本身相关"><a href="#Mac-本身相关" class="headerlink" title="Mac 本身相关"></a>Mac 本身相关</h3><h4 id="访问隐藏目录"><a href="#访问隐藏目录" class="headerlink" title="访问隐藏目录"></a>访问隐藏目录</h4><p>　在 Finder 里面同时按 <code>Command + Shift + G</code> 即可输入隐藏目录，如 <code>/usr/bin/java</code></p>
<h3 id="Vim-相关"><a href="#Vim-相关" class="headerlink" title="Vim 相关"></a>Vim 相关</h3><div class="table-container">
<table>
<thead>
<tr>
<th>快捷键</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>⌃F</td>
<td>下翻页</td>
</tr>
<tr>
<td>⌃B</td>
<td>上翻页</td>
</tr>
<tr>
<td>⌃F</td>
<td>下翻页</td>
</tr>
<tr>
<td>⌃B</td>
<td>上翻页</td>
</tr>
<tr>
<td>⇧M</td>
<td>将光标移动的该页中部</td>
</tr>
<tr>
<td>GG</td>
<td>回到文件顶部</td>
</tr>
<tr>
<td>⇧G</td>
<td>回到文件底部</td>
</tr>
<tr>
<td>HJKL</td>
<td>移动光标（HL: 左右；JK: 上下）</td>
</tr>
</tbody>
</table>
</div>
<p>Tips: 更多 Vim 实用技巧 和 完整快捷键 详见《<a href="https://yuzhouwan.com/posts/15691">Linux 实战技巧</a>》的 <a href="https://yuzhouwan.com/posts/15691/#vim">vim</a> 和 <a href="https://yuzhouwan.com/posts/15691/#Blog">cheat sheet</a> 部分</p>
<h3 id="Alfred-相关"><a href="#Alfred-相关" class="headerlink" title="Alfred 相关"></a><a href="https://www.alfredapp.com/">Alfred</a> 相关</h3><div class="table-container">
<table>
<thead>
<tr>
<th>快捷键</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>⌥⌘C</td>
<td>展示粘贴板上历史命令、图片和文件列表</td>
</tr>
</tbody>
</table>
</div>
<h3 id="iTerm2-相关"><a href="#iTerm2-相关" class="headerlink" title="iTerm2 相关"></a>iTerm2 相关</h3><div class="table-container">
<table>
<thead>
<tr>
<th>快捷键</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>⌘⇧I</td>
<td>开启同时向多窗口输入命令的功能</td>
</tr>
</tbody>
</table>
</div>
<h3 id="Intellij-Idea-相关"><a href="#Intellij-Idea-相关" class="headerlink" title="Intellij Idea 相关"></a>Intellij Idea 相关</h3><h4 id="Editing（编辑）"><a href="#Editing（编辑）" class="headerlink" title="Editing（编辑）"></a>Editing（编辑）</h4><div class="table-container">
<table>
<thead>
<tr>
<th>快捷键</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>⌃Space</td>
<td>基本的代码补全（补全任何类、方法、变量）</td>
</tr>
<tr>
<td>⌃⇧Space</td>
<td>智能代码补全（过滤器方法列表和变量的预期类型）</td>
</tr>
<tr>
<td>⌘⇧↩</td>
<td>自动结束代码，行末自动添加分号</td>
</tr>
<tr>
<td>⌘P</td>
<td>显示方法的参数信息</td>
</tr>
<tr>
<td>⌃J</td>
<td>快速查看文档</td>
</tr>
<tr>
<td>⇧F1</td>
<td>查看外部文档（在某些代码上会触发打开浏览器显示相关文档）</td>
</tr>
<tr>
<td>⌘+鼠标</td>
<td>显示简要信息</td>
</tr>
<tr>
<td>⌘F1</td>
<td>在错误或警告处显示具体描述信息</td>
</tr>
<tr>
<td>⌘N, ⌃↩</td>
<td><strong>生成代码</strong>（<code>getter</code>、<code>setter</code>、构造函数、<code>hashCode</code> / <code>equals</code> / <code>toString</code>）</td>
</tr>
<tr>
<td>⌃O</td>
<td>覆盖方法（重写父类方法）</td>
</tr>
<tr>
<td>⌃I</td>
<td>实现方法（实现接口中的方法）</td>
</tr>
<tr>
<td>⌘⌥T</td>
<td>包围代码（使用 <code>if..else</code>, <code>try..catch</code>, <code>for</code>, <code>synchronized</code> 等包围选中的代码）</td>
</tr>
<tr>
<td>⌘/</td>
<td>注释 / 取消注释与行注释</td>
</tr>
<tr>
<td>⌘⌥/</td>
<td>注释 / 取消注释与块注释</td>
</tr>
<tr>
<td>⌥↑</td>
<td>连续选中代码块</td>
</tr>
<tr>
<td>⌥↓</td>
<td>减少当前选中的代码块</td>
</tr>
<tr>
<td>⌃⇧Q</td>
<td>显示上下文信息</td>
</tr>
<tr>
<td>⌥↩</td>
<td>显示意向动作和快速修复代码</td>
</tr>
<tr>
<td>⌘⌥L</td>
<td>格式化代码</td>
</tr>
<tr>
<td>⌃⌥O</td>
<td>优化 <code>import</code></td>
</tr>
<tr>
<td>⌃⌥I</td>
<td>自动缩进线</td>
</tr>
<tr>
<td>⇥ / ⇧⇥</td>
<td>缩进代码 / 反缩进代码</td>
</tr>
<tr>
<td>⌘X</td>
<td>剪切当前行或选定的块到剪贴板</td>
</tr>
<tr>
<td>⌘C</td>
<td>复制当前行或选定的块到剪贴板</td>
</tr>
<tr>
<td>⌘V</td>
<td>从剪贴板粘贴</td>
</tr>
<tr>
<td>⌘⇧V</td>
<td><strong>从最近的缓冲区粘贴</strong></td>
</tr>
<tr>
<td>⌘D</td>
<td>复制当前行或选定的块</td>
</tr>
<tr>
<td>⌘⌫</td>
<td>删除当前行或选定的块的行</td>
</tr>
<tr>
<td>⌃⇧J</td>
<td>智能的将代码拼接成一行</td>
</tr>
<tr>
<td>⌘↩</td>
<td>智能的拆分拼接的行</td>
</tr>
<tr>
<td>⇧↩</td>
<td>开始新的一行</td>
</tr>
<tr>
<td>⌘⇧U</td>
<td>大小写切换</td>
</tr>
<tr>
<td>⌘⇧] / ⌘⇧[</td>
<td>选择直到代码块结束 / 开始</td>
</tr>
<tr>
<td>⌥⌦</td>
<td>删除到单词的末尾</td>
</tr>
<tr>
<td>⌥⌫</td>
<td>删除到单词的开头</td>
</tr>
<tr>
<td>⌘+ / ⌘-</td>
<td>展开 / 折叠代码块</td>
</tr>
<tr>
<td>⌘⇧+</td>
<td>展开所以代码块</td>
</tr>
<tr>
<td>⌘⇧-</td>
<td>折叠所有代码块</td>
</tr>
<tr>
<td>⌘W</td>
<td>关闭活动的编辑器选项卡</td>
</tr>
</tbody>
</table>
</div>
<h4 id="Search-Replace（查询-替换）"><a href="#Search-Replace（查询-替换）" class="headerlink" title="Search / Replace（查询 / 替换）"></a>Search / Replace（查询 / 替换）</h4><div class="table-container">
<table>
<thead>
<tr>
<th>快捷键</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>Double ⇧</td>
<td>查询任何东西</td>
</tr>
<tr>
<td>⌘F</td>
<td>文件内查找</td>
</tr>
<tr>
<td>⌘G</td>
<td>查找模式下，向下查找</td>
</tr>
<tr>
<td>⌘⇧G</td>
<td>查找模式下，向上查找</td>
</tr>
<tr>
<td>⌘R</td>
<td>文件内替换</td>
</tr>
<tr>
<td>⌘⇧F</td>
<td>全局查找（根据路径）</td>
</tr>
<tr>
<td>⌘⇧R</td>
<td>全局替换（根据路径）</td>
</tr>
<tr>
<td>⌘⇧S</td>
<td>查询结构（Ultimate Edition 版专用，需要在 Keymap 中设置）</td>
</tr>
<tr>
<td>⌘⇧M</td>
<td>替换结构（Ultimate Edition 版专用，需要在 Keymap 中设置）</td>
</tr>
</tbody>
</table>
</div>
<h4 id="Usage-Search（使用查询）"><a href="#Usage-Search（使用查询）" class="headerlink" title="Usage Search（使用查询）"></a>Usage Search（使用查询）</h4><div class="table-container">
<table>
<thead>
<tr>
<th>快捷键</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>⌥F7 / ⌘F7</td>
<td>在文件中查找用法 / 在类中查找用法</td>
</tr>
<tr>
<td>⌘⇧F7</td>
<td>在文件中突出显示的用法</td>
</tr>
<tr>
<td>⌘⌥F7</td>
<td>显示用法</td>
</tr>
</tbody>
</table>
</div>
<h4 id="Compile-and-Run（编译和运行）"><a href="#Compile-and-Run（编译和运行）" class="headerlink" title="Compile and Run（编译和运行）"></a>Compile and Run（编译和运行）</h4><div class="table-container">
<table>
<thead>
<tr>
<th>快捷键</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>⌘F9</td>
<td>编译 Project</td>
</tr>
<tr>
<td>⌘⇧F9</td>
<td>编译选择的文件、包或模块</td>
</tr>
<tr>
<td>⌃⌥R</td>
<td>弹出 Run 的可选择菜单</td>
</tr>
<tr>
<td>⌃⌥D</td>
<td>弹出 Debug 的可选择菜单</td>
</tr>
<tr>
<td>⌃R</td>
<td>运行</td>
</tr>
<tr>
<td>⌃D</td>
<td>调试</td>
</tr>
<tr>
<td>⌃⇧R, ⌃⇧D</td>
<td>从编辑器运行上下文环境配置</td>
</tr>
</tbody>
</table>
</div>
<h4 id="Debugging（调试）"><a href="#Debugging（调试）" class="headerlink" title="Debugging（调试）"></a>Debugging（调试）</h4><div class="table-container">
<table>
<thead>
<tr>
<th>快捷键</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>F8</td>
<td>进入下一步，如果当前行断点是一个方法，则不进入当前方法体内</td>
</tr>
<tr>
<td>F7</td>
<td>进入下一步，如果当前行断点是一个方法，则进入当前方法体内，如果该方法体还有方法，则不会进入该内嵌的方法中</td>
</tr>
<tr>
<td>⇧F7</td>
<td>智能步入，断点所在行上有多个方法调用，会弹出进入哪个方法</td>
</tr>
<tr>
<td>⇧F8</td>
<td>跳出</td>
</tr>
<tr>
<td>⌥F9</td>
<td>运行到光标处，如果光标前有其他断点会进入到该断点</td>
</tr>
<tr>
<td>⌥F8</td>
<td>计算表达式（可以更改变量值使其生效）</td>
</tr>
<tr>
<td>⌘⌥R</td>
<td>恢复程序运行，如果该断点下面代码还有断点则停在下一个断点上</td>
</tr>
<tr>
<td>⌘F8</td>
<td>切换断点（若光标当前行有断点则取消断点，没有则加上断点）</td>
</tr>
<tr>
<td>⌘⇧F8</td>
<td>查看断点信息</td>
</tr>
</tbody>
</table>
</div>
<h4 id="Navigation（导航）"><a href="#Navigation（导航）" class="headerlink" title="Navigation（导航）"></a>Navigation（导航）</h4><div class="table-container">
<table>
<thead>
<tr>
<th>快捷键</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>⌘O</td>
<td>查找类文件</td>
</tr>
<tr>
<td>⌘F12</td>
<td>弹出当前文件结构层，可以在弹出的层上直接输入进行筛选（可用于搜索类中的方法）</td>
</tr>
<tr>
<td>⌘⇧O</td>
<td>查找所有类型文件、打开文件、打开目录，打开目录需要在输入的内容前面或后面加一个反斜杠 /</td>
</tr>
<tr>
<td>⌘⌥O</td>
<td>前往指定的变量 / 方法</td>
</tr>
<tr>
<td>⌃← / ⌃→</td>
<td>左右切换打开的编辑 tab 页</td>
</tr>
<tr>
<td>F12</td>
<td>返回到前一个工具窗口</td>
</tr>
<tr>
<td>⎋</td>
<td>从工具窗口进入代码文件窗口</td>
</tr>
<tr>
<td>⇧⎋</td>
<td>隐藏当前或最后一个活动的窗口，且光标进入代码文件窗口</td>
</tr>
<tr>
<td>⌘⇧F4</td>
<td>关闭活动 run / messages / find / … 的 tab 页</td>
</tr>
<tr>
<td>⌘L</td>
<td>在当前文件跳转到某一行的指定处</td>
</tr>
<tr>
<td>⌘E</td>
<td>显示最近打开的文件记录列表</td>
</tr>
<tr>
<td>⌘⌥← / ⌘⌥→</td>
<td>退回 / 前进到上一个操作的地方</td>
</tr>
<tr>
<td>⌘⇧⌫</td>
<td>跳转到最后一个编辑的地方</td>
</tr>
<tr>
<td>⌥F1</td>
<td>显示当前文件选择目标弹出层，弹出层中有很多目标可以进行选择（如在代码编辑窗口可以选择显示该文件的 Finder）</td>
</tr>
<tr>
<td>⌘B / ⌘</td>
<td>鼠标点击 进入光标所在的方法 / 变量的接口或是定义处</td>
</tr>
<tr>
<td>⌘⌥B</td>
<td>跳转到实现处，在某个调用的方法名上使用会跳到具体的实现处，可以跳过接口</td>
</tr>
<tr>
<td>⌥ Space, ⌘Y</td>
<td>快速打开光标所在方法、类的定义</td>
</tr>
<tr>
<td>⌃⇧B</td>
<td>跳转到类型声明处</td>
</tr>
<tr>
<td>⌘U</td>
<td>前往当前光标所在方法的父类的方法 / 接口定义</td>
</tr>
<tr>
<td>⌃↓ / ⌃↑</td>
<td>当前光标跳转到当前文件的前一个 / 后一个方法名位置</td>
</tr>
<tr>
<td>⌘] / ⌘[</td>
<td>移动光标到当前所在代码的花括号开始/结束位置</td>
</tr>
<tr>
<td>⌃H</td>
<td>显示当前类的层次结构</td>
</tr>
<tr>
<td>⌘⇧H</td>
<td>显示方法层次结构</td>
</tr>
<tr>
<td>⌃⌥H</td>
<td>显示调用层次结构</td>
</tr>
<tr>
<td>F2 / ⇧F2</td>
<td>跳转到下一个 / 上一个突出错误或警告的位置</td>
</tr>
<tr>
<td>F4 / ⌘↓</td>
<td>编辑 / 查看代码源</td>
</tr>
<tr>
<td>⌥ Home</td>
<td>显示到当前文件的导航条</td>
</tr>
<tr>
<td>F3</td>
<td>选中文件 / 文件夹 / 代码行，添加 / 取消书签</td>
</tr>
<tr>
<td>⌥F3</td>
<td>选中文件 / 文件夹 / 代码行，使用助记符添加 / 取消书签</td>
</tr>
<tr>
<td>⌃0…⌃9</td>
<td>定位到对应数值的书签位置</td>
</tr>
<tr>
<td>⌘F3</td>
<td>显示所有书签</td>
</tr>
</tbody>
</table>
</div>
<h4 id="Refactoring（重构）"><a href="#Refactoring（重构）" class="headerlink" title="Refactoring（重构）"></a>Refactoring（重构）</h4><div class="table-container">
<table>
<thead>
<tr>
<th>快捷键</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>F5</td>
<td>复制文件到指定目录</td>
</tr>
<tr>
<td>F6</td>
<td>移动文件到指定目录</td>
</tr>
<tr>
<td>⌘⌫</td>
<td>在文件上为安全删除文件，弹出确认框</td>
</tr>
<tr>
<td>⇧F6</td>
<td>重命名文件</td>
</tr>
<tr>
<td>⌘F6</td>
<td><strong>更改签名</strong></td>
</tr>
<tr>
<td>⌘⌥N</td>
<td>一致性</td>
</tr>
<tr>
<td>⌘⌥M</td>
<td>将选中的代码提取为方法</td>
</tr>
<tr>
<td>⌘⌥V</td>
<td>提取变量</td>
</tr>
<tr>
<td>⌘⌥F</td>
<td>提取字段</td>
</tr>
<tr>
<td>⌘⌥C</td>
<td>提取常量</td>
</tr>
<tr>
<td>⌘⌥P</td>
<td>提取参数</td>
</tr>
</tbody>
</table>
</div>
<h4 id="VCS（版本控制）"><a href="#VCS（版本控制）" class="headerlink" title="VCS（版本控制）"></a>VCS（版本控制）</h4><div class="table-container">
<table>
<thead>
<tr>
<th>快捷键</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>⌘K</td>
<td>提交代码到版本控制器</td>
</tr>
<tr>
<td>⌘T</td>
<td>从版本控制器更新代码</td>
</tr>
<tr>
<td>⌥⇧C</td>
<td>查看最近的变更记录</td>
</tr>
<tr>
<td>⌃C</td>
<td>快速弹出版本控制器操作面板</td>
</tr>
</tbody>
</table>
</div>
<h4 id="Live-Templates（动态代码模板）"><a href="#Live-Templates（动态代码模板）" class="headerlink" title="Live Templates（动态代码模板）"></a>Live Templates（动态代码模板）</h4><div class="table-container">
<table>
<thead>
<tr>
<th>快捷键</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>⌘⌥J</td>
<td>弹出模板选择窗口，将选定的代码使用动态模板包住</td>
</tr>
<tr>
<td>⌘J</td>
<td>插入自定义动态代码模板</td>
</tr>
</tbody>
</table>
</div>
<h4 id="General（通用）"><a href="#General（通用）" class="headerlink" title="General（通用）"></a>General（通用）</h4><div class="table-container">
<table>
<thead>
<tr>
<th>快捷键</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>⌘1…⌘9</td>
<td>打开相应编号的工具窗口</td>
</tr>
<tr>
<td>⌘S</td>
<td>保存所有</td>
</tr>
<tr>
<td>⌘⌥Y</td>
<td>同步、刷新</td>
</tr>
<tr>
<td>⌃⌘F</td>
<td>切换全屏模式</td>
</tr>
<tr>
<td>⌘⇧F12</td>
<td>切换最大化编辑器</td>
</tr>
<tr>
<td>⌥⇧F</td>
<td>添加到收藏夹</td>
</tr>
<tr>
<td>⌥⇧I</td>
<td>检查当前文件与当前的配置文件</td>
</tr>
<tr>
<td>§⌃, ⌃`</td>
<td>快速切换当前的 scheme（切换主题、代码样式等）</td>
</tr>
<tr>
<td>⌘,</td>
<td>打开 IDEA 系统设置</td>
</tr>
<tr>
<td>⌘;</td>
<td>打开项目结构对话框</td>
</tr>
<tr>
<td>⇧⌘A</td>
<td>查找动作（可设置相关选项）</td>
</tr>
<tr>
<td>⌃⇥</td>
<td>编辑窗口标签和工具窗口之间切换（如果在切换的过程加按上 delete，则是关闭对应选中的窗口）</td>
</tr>
</tbody>
</table>
</div>
<h4 id="Other"><a href="#Other" class="headerlink" title="Other"></a>Other</h4><div class="table-container">
<table>
<thead>
<tr>
<th>快捷键</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>⌘⇧8</td>
<td>竖编辑模式</td>
</tr>
<tr>
<td>⌘`</td>
<td>项目之间的切换</td>
</tr>
<tr>
<td>⌥⇧U</td>
<td>装上 CamelCase 插件之后，切换变量的驼峰法命名</td>
</tr>
<tr>
<td>⌃⌘U</td>
<td>装上 Translation 插件之后，可以快速翻译</td>
</tr>
<tr>
<td>⌃⌘O</td>
<td>装上 Translation 插件之后，可以翻译并替换</td>
</tr>
<tr>
<td>⌥S</td>
<td>装上 OnlineSearch 插件之后，可以配置为该快捷键</td>
</tr>
<tr>
<td>⌘⌥⇧/</td>
<td>使用 2018.3 EAP   版本时候，开启 JVM Profile 功能</td>
</tr>
</tbody>
</table>
</div>
<h2 id="踩过的坑"><a href="#踩过的坑" class="headerlink" title="踩过的坑"></a>踩过的坑</h2><h3 id="Error-Unknown-command-services"><a href="#Error-Unknown-command-services" class="headerlink" title="Error: Unknown command: services"></a>Error: Unknown command: services</h3><h4 id="描述-1"><a href="#描述-1" class="headerlink" title="描述"></a>描述</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ brew services start grafana</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">Error: Unknown <span class="built_in">command</span>: services</span><br></pre></td></tr></tbody></table></figure>
<h4 id="解决-1"><a href="#解决-1" class="headerlink" title="解决"></a><a href="https://apple.stackexchange.com/questions/150300/need-help-using-homebrew-services-command">解决</a></h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ brew tap homebrew/services</span><br></pre></td></tr></tbody></table></figure>
<h3 id="升级-Catalina-系统后根目录下文件消失"><a href="#升级-Catalina-系统后根目录下文件消失" class="headerlink" title="升级 Catalina 系统后根目录下文件消失"></a>升级 Catalina 系统后根目录下文件消失</h3><h4 id="解决-2"><a href="#解决-2" class="headerlink" title="解决"></a>解决</h4><p>　已经被移动到 <code>/Users/Shared/Relocated Items/Security</code> 目录下了</p>
<h3 id="升级-Catalina-系统后根目录无法创建文件夹"><a href="#升级-Catalina-系统后根目录无法创建文件夹" class="headerlink" title="升级 Catalina 系统后根目录无法创建文件夹"></a>升级 Catalina 系统后根目录无法创建文件夹</h3><h4 id="描述-2"><a href="#描述-2" class="headerlink" title="描述"></a>描述</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /</span><br><span class="line">$ sudo mkdir yuzhouwan</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">mkdir: yuzhouwan: Read-only file system</span><br></pre></td></tr></tbody></table></figure>
<h4 id="解决-3"><a href="#解决-3" class="headerlink" title="解决"></a>解决</h4><p>　确保 <a href="https://support.apple.com/en-us/HT204899">SIP</a>（<strong>S</strong>ystem <strong>I</strong>ntegrity <strong>P</strong>rotection）关闭的情况下，给更目录赋予写入的权限即可</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ csrutil status</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">System Integrity Protection status: disabled.</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ sudo mount -uw /</span><br><span class="line">$ sudo mkdir /yuzhouwan</span><br></pre></td></tr></tbody></table></figure>
<h3 id="删除雷蛇应用后，仍然显示雷蛇图标"><a href="#删除雷蛇应用后，仍然显示雷蛇图标" class="headerlink" title="删除雷蛇应用后，仍然显示雷蛇图标"></a>删除雷蛇应用后，仍然显示雷蛇图标</h3><h4 id="解决-4"><a href="#解决-4" class="headerlink" title="解决"></a>解决</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ launchctl remove com.razer.rzupdater</span><br><span class="line">$ launchctl remove com.razerzone.rzdeviceengine</span><br><span class="line">$ sudo rm /Library/LaunchAgents/com.razer.rzupdater.plist</span><br><span class="line">$ sudo rm -rf /Library/Application\ Support/Razer</span><br></pre></td></tr></tbody></table></figure>
<h3 id="自带的-grep-不支持-P-参数"><a href="#自带的-grep-不支持-P-参数" class="headerlink" title="自带的 grep 不支持 -P 参数"></a>自带的 grep 不支持 -P 参数</h3><h4 id="解决-5"><a href="#解决-5" class="headerlink" title="解决"></a>解决</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ brew install grep</span><br><span class="line">$ vim tmp</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">宇宙湾</span><br><span class="line">yuzhouwan.com</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ /usr/<span class="built_in">local</span>/opt/grep/libexec/gnubin/grep -P <span class="string">'[\p{Han}]'</span> tmp</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">宇宙湾</span><br></pre></td></tr></tbody></table></figure>
<h2 id="资源"><a href="#资源" class="headerlink" title="资源"></a>资源</h2><h3 id="理论"><a href="#理论" class="headerlink" title="理论"></a>理论</h3><ul>
<li><a href="https://meta.stackexchange.com/questions/66377/what-is-the-xy-problem">What is the XY problem?</a></li>
<li><a href="https://mp.weixin.qq.com/s/fhqg1ntQoPYxC-5KDQk3jQ">为了效率，扎克伯格的 26 张 PPT</a></li>
<li><a href="https://xiaozhuanlan.com/Effective-Mac">Mac 高效开发指南</a></li>
<li><a href="https://ihtcboy.com/2018/07/15/2018-07-15_%E7%A8%8B%E5%BA%8F%E5%91%98%E7%9A%84macOS%E7%B3%BB%E5%88%97%EF%BC%9A%E7%B2%BE%E9%80%89MacApp/">程序员的 macOS 系列：精选 Mac App</a></li>
<li><a href="https://leohxj.gitbooks.io/a-programmer-prepares/content/software/mac/index.html">程序员的自我修养 - Mac 篇</a></li>
</ul>
<h3 id="软件"><a href="#软件" class="headerlink" title="软件"></a>软件</h3><h4 id="通用"><a href="#通用" class="headerlink" title="通用"></a>通用</h4><ul>
<li><a href="https://www.zhihu.com/topic/19591970/hot">Mac OS X 使用技巧</a></li>
<li><a href="https://macpaw.com/">CleanMyMac X</a></li>
<li><a href="https://wangchujiang.com/awesome-mac/">Awesome Mac</a></li>
</ul>
<h4 id="钉钉"><a href="#钉钉" class="headerlink" title="钉钉"></a>钉钉</h4><ul>
<li>DingTalk RC: <a href="https://download.alicdn.com/dingtalk-desktop/win_installer/RC/DingTalk_v3.3.4-RC.1.exe">win</a> &amp; <a href="https://download.alicdn.com/dingtalk-desktop/mac_dmg/RC/DingTalk_v3.3.4-RC.1.dmg">mac</a></li>
</ul>
<h4 id="iTerm2-1"><a href="#iTerm2-1" class="headerlink" title="iTerm2"></a>iTerm2</h4><ul>
<li><p><a href="https://www.jianshu.com/p/405956cdaca6">ITerm2 配置 - 让你的 mac 命令行更加丰富高效</a><br><img data-src="/picture/mac/mac_iterm2.png" alt="iTerm2"></p>
<center>（对 <a href="https://iterm2.com/" target="_blank">ITerm2</a>™ 的截图）</center></li>
<li><a href="http://bluebiu.com/blog/iterm2-ssh-session-idle.html">iTerm2 中 ssh 保持连接不断开</a></li>
</ul>
<h4 id="Jump-Desktop"><a href="#Jump-Desktop" class="headerlink" title="Jump Desktop"></a>Jump Desktop</h4><ul>
<li><a href="https://jumpdesktop.com/">Jump Desktop：连接远程桌面</a></li>
</ul>
<h4 id="Sublime-1"><a href="#Sublime-1" class="headerlink" title="Sublime"></a>Sublime</h4><ul>
<li><a href="https://github.com/sb2nov/mac-setup">Installing Development environment on macOS</a></li>
<li><a href="https://github.com/dzhibas/SublimePrettyJson">Prettify / Minify / Query / Goto / Validate / Lint JSON plugin for Sublime Text 2 &amp; 3</a></li>
<li><a href="https://www.jianshu.com/p/a50db1f77eb9">Sublime Text：Pretty Json 插件使用技巧</a></li>
</ul>
<h4 id="Chrome-1"><a href="#Chrome-1" class="headerlink" title="Chrome"></a>Chrome</h4><ul>
<li><a href="https://github.com/Mottie/GitHub-userscripts">Userscripts to add functionality to GitHub</a></li>
</ul>
<h3 id="硬件"><a href="#硬件" class="headerlink" title="硬件"></a>硬件</h3><ul>
<li><a href="https://support.apple.com/zh-cn/HT204063">重置 Mac 上的 NVRAM 或 PRAM</a></li>
<li><a href="https://support.apple.com/zh-cn/HT207513">如何在 Mac 上使用夜览</a></li>
</ul>
<h3 id="工具网站"><a href="#工具网站" class="headerlink" title="工具网站"></a>工具网站</h3><ul>
<li><a href="http://www.bejson.com/">JSON 格式化</a></li>
<li><a href="http://tool.chinaz.com/Tools/unixtime.aspx">时间戳转换</a></li>
<li><a href="https://www.debuggex.com/">正则表达式校验</a></li>
<li><a href="https://vega.github.io/vega/examples/word-cloud/">词云生成</a></li>
<li><a href="https://www.w3schools.com/colors/colors_shades.asp">HTML Color Shades</a></li>
<li><a href="https://mermaid-js.github.io/mermaid-live-editor">Mermaid Live Editor</a></li>
</ul>
<h3 id="图像"><a href="#图像" class="headerlink" title="图像"></a>图像</h3><h4 id="素材"><a href="#素材" class="headerlink" title="素材"></a>素材</h4><ul>
<li><a href="https://pixabay.com/">Pixabay</a>：免费高质量的图片素材网站</li>
<li><a href="https://www.pexels.com/">Pexels</a>：每周定量更新，所有的图片都会显示详细的信息</li>
<li><a href="https://www.splitshire.com/">Splitshire</a>：免费高清摄影图片下载</li>
<li><a href="http://pngimg.com/">Pngimg</a>：PNG 格式的透明素材图</li>
<li><a href="https://www.zhihu.com/question/23169054">有哪些好的 PPT 素材网站，推荐下?</a></li>
</ul>
<h4 id="图标"><a href="#图标" class="headerlink" title="图标"></a>图标</h4><ul>
<li><a href="https://fontawesome.com/">Font Awesome gives you scalable vector icons that can instantly be customized</a></li>
<li><a href="https://www.iconfont.cn/">Iconfont</a>：阿里巴巴矢量图库</li>
<li><a href="https://www.easyicon.net/">Easyicon</a></li>
<li><a href="http://www.iconninja.com/">Iconninja</a></li>
<li><a href="https://simpleicons.org/">Free SVG icons for popular brands</a></li>
</ul>
<h4 id="纹理背景"><a href="#纹理背景" class="headerlink" title="纹理背景"></a>纹理背景</h4><ul>
<li><a href="https://www.toptal.com/designers/subtlepatterns/">Subtle patterns</a></li>
</ul>
<h4 id="地图图表"><a href="#地图图表" class="headerlink" title="地图图表"></a>地图图表</h4><ul>
<li><a href="https://pixelmap.amcharts.com/">Pixel Map Generator</a></li>
</ul>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt=""></a></td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>Maven</tag>
        <tag>Java</tag>
        <tag>Mac</tag>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Algorithm</title>
    <url>/posts/666/</url>
    <content><![CDATA[<h2 id="LeetCode-组队刷题活动"><a href="#LeetCode-组队刷题活动" class="headerlink" title="LeetCode 组队刷题活动"></a>LeetCode 组队刷题活动</h2><div class="note primary">组队刷 LeetCode</div>

<h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><h4 id="代码仓库"><a href="#代码仓库" class="headerlink" title="代码仓库"></a>代码仓库</h4><p>　代码仓库的坐标：<strong><a href="https://github.com/asdf2014/algorithm">asdf2014 / algorithm</a></strong></p>
<h4 id="报名途径"><a href="#报名途径" class="headerlink" title="报名途径"></a>报名途径</h4><p>　只需要在《<a href="https://yuzhouwan.com/posts/666/">Algorithm</a>》文末留言，即可随时参与</p>
<div class="note success">留言内容的话，至少要留一下自己的 Github 名称，方便我们这边统计汇总。另外，也可以说明下自己能接受的刷题频率、希望的选题策略，亦或者，对算法知识沉淀的模式有好的建议，都可以提出</div>

<h4 id="参与方式"><a href="#参与方式" class="headerlink" title="参与方式"></a>参与方式</h4><p>　每位参与的小伙伴，都会获得代码仓库的 Collaborator 权限，可以自由地提交代码（不限制语种）。在 <code>/Codes/${User}</code> 目录下，每人都将拥有一个自己的代码库。留下 Github 名称后，将很快会收到邀请函，大家可以在 <a href="https://github.com/asdf2014/algorithm/invitations">asdf2014 - algorithm - invitations</a> 链接中认领。随后，可以在任意目录下（不需要是空目录），使用如下命令，一键完成您的第一次代码提交：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">bash -c <span class="string">"<span class="subst">$(curl -L https://raw.githubusercontent.com/asdf2014/algorithm/master/first_commit.sh)</span>"</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="刷题频率"><a href="#刷题频率" class="headerlink" title="刷题频率"></a>刷题频率</h4><p>　考虑到可能大家的闲暇时间并不多，我们暂定刷题频率为“一周一题”</p>
<h4 id="选题策略"><a href="#选题策略" class="headerlink" title="选题策略"></a>选题策略</h4><p>　分为两个阶段：</p>
<ul>
<li>前 100 题都是经典中的经典，所以我们第一阶段先将这些题目吃透</li>
<li>第二阶段，通过程序进行<a href="https://nbviewer.jupyter.org/github/asdf2014/algorithm/blob/master/Picker/leetcode_picker.ipynb"><strong>随机选定</strong></a>，历史题库可以点击<a href="https://yuzhouwan.com/posts/666/#Index">链接</a>看到</li>
</ul>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>　操作 Git 时遇到问题的话，可以参考我的一篇博客《<a href="https://yuzhouwan.com/posts/30041/">Git 高级玩法</a>》</p>
<div class="note success">也可以直接在文章最后留言。目前，支持 Gitalk + Disqus 两种留言系统，以便更好地服务于国内和海外的小伙伴</div>

<p>　同时，为了大家更加方便地交流，也欢迎加入算法 QQ 群 <a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="/picture/algorithm/algorithm_qq_group_5366753.svg" alt=""></a> 或者 Gitter 聊天室 <a href="https://gitter.im/yuzhouwan/community?utm_source=badge&amp;utm_medium=badge&amp;utm_campaign=pr-badge"><img data-src="/picture/algorithm/algorithm_gitter_community.svg" alt=""></a></p>
<div class="note danger">但是，请不要在评论区讨论入群问题的答案，避免打广告的进入</div>

<p>　另外，因为大部分算法都会有很多实现思路，我们会尽可能地展现所有可能的解题方法。但为了文章的排版更加地紧凑，我们会将同一算法的不同实现，通过选项卡的形式展现。且默认展示的选项卡将会是最优解。这样的话，如果您想要快速阅读本文，则可以不用翻看其他的选项卡。实际效果如下：</p>
<div class="tabs" id="code"><ul class="nav-tabs"><li class="tab"><a href="#code-1">CODE 1</a></li><li class="tab"><a href="#code-2">CODE 2</a></li><li class="tab active"><a href="#code-3">CODE 3</a></li></ul><div class="tab-content"><div class="tab-pane" id="code-1"><p><strong>迭代解</strong></p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">solution</span>(<span class="params">n</span>):</span></span><br><span class="line">    <span class="keyword">if</span> n &lt;= <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> n</span><br><span class="line">    a = <span class="number">0</span></span><br><span class="line">    b = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> n &gt; <span class="number">1</span>:</span><br><span class="line">        n = n - <span class="number">1</span></span><br><span class="line">        sum_ = a + b</span><br><span class="line">        a = b</span><br><span class="line">        b = sum_</span><br><span class="line">    <span class="keyword">return</span> b</span><br></pre></td></tr></tbody></table></figure></div><div class="tab-pane" id="code-2"><p><strong>递归解</strong></p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">solution</span>(<span class="params">n</span>):</span></span><br><span class="line">    <span class="keyword">if</span> n &lt;= <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> n</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> solution(n - <span class="number">1</span>) + solution(n - <span class="number">2</span>)</span><br></pre></td></tr></tbody></table></figure></div><div class="tab-pane active" id="code-3"><p><strong>动态规划解</strong></p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">solution</span>(<span class="params">n</span>):</span></span><br><span class="line">    <span class="keyword">if</span> n &lt;= <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> n</span><br><span class="line">    cache = [x <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">0</span>, n + <span class="number">1</span>)]</span><br><span class="line">    cache[<span class="number">1</span>] = <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>, n + <span class="number">1</span>):</span><br><span class="line">        cache[i] = cache[i - <span class="number">1</span>] + cache[i - <span class="number">2</span>]</span><br><span class="line">    <span class="keyword">return</span> cache[n]</span><br></pre></td></tr></tbody></table></figure></div></div></div>
<a id="more"></a>
<h3 id="进度"><a href="#进度" class="headerlink" title="进度"></a>进度</h3><p>　截止目前为止，活跃的小伙伴数量：<a href="https://yuzhouwan.com/posts/666/"><img data-src="https://img.shields.io/github/contributors/asdf2014/algorithm" alt=""></a>，使用到的语言种类：<a href="https://yuzhouwan.com/posts/666/"><img data-src="https://img.shields.io/github/languages/count/asdf2014/algorithm" alt=""></a>，代码提交频率：<a href="https://yuzhouwan.com/posts/666/"><img data-src="https://img.shields.io/github/commit-activity/m/asdf2014/algorithm?cacheSeconds=3600" alt=""></a>，开源许可证：<a href="https://yuzhouwan.com/posts/666/"><img data-src="https://img.shields.io/github/license/asdf2014/algorithm" alt=""></a></p>
<h3 id="排行榜"><a href="#排行榜" class="headerlink" title="排行榜"></a>排行榜</h3><h4 id="完成题目最多的小伙伴"><a href="#完成题目最多的小伙伴" class="headerlink" title="完成题目最多的小伙伴"></a>完成题目最多的小伙伴</h4><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">User</th>
<th style="text-align:center">Completed</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><strong><a href="https://github.com/asdf2014/algorithm/tree/master/Codes/gracekoo">gracekoo</a></strong></td>
<td style="text-align:center">160</td>
</tr>
<tr>
<td style="text-align:center"><strong><a href="https://github.com/asdf2014/algorithm/tree/master/Codes/zsdostar">zsdostar</a></strong></td>
<td style="text-align:center">54</td>
</tr>
<tr>
<td style="text-align:center"><strong><a href="https://github.com/asdf2014/algorithm/tree/master/Codes/gmywq392">gmywq392</a></strong></td>
<td style="text-align:center">50</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/asdf2014/algorithm/tree/master/Codes/Liam">Liam</a></td>
<td style="text-align:center">47</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/asdf2014/algorithm/tree/master/Codes/jxdeng3264">jxdeng3264</a></td>
<td style="text-align:center">46</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/asdf2014/algorithm/tree/master/Codes/ZZhang">ZZhang</a></td>
<td style="text-align:center">34</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/asdf2014/algorithm/tree/master/Codes/Buddy119">Buddy119</a></td>
<td style="text-align:center">32</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/asdf2014/algorithm/tree/master/Codes/lxycg">lxycg</a></td>
<td style="text-align:center">29</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/asdf2014/algorithm/tree/master/Codes/asdf2014">asdf2014</a></td>
<td style="text-align:center">29</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/asdf2014/algorithm/tree/master/Codes/mggger">mggger</a></td>
<td style="text-align:center">14</td>
</tr>
</tbody>
</table>
</div>
<h4 id="最活跃的小伙伴"><a href="#最活跃的小伙伴" class="headerlink" title="最活跃的小伙伴"></a>最活跃的小伙伴</h4><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">User</th>
<th style="text-align:center">Latest Active Date</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><strong><a href="https://github.com/asdf2014/algorithm/tree/master/Codes/asdf2014">asdf2014</a></strong></td>
<td style="text-align:center">2020-07-27 20:54:46</td>
</tr>
<tr>
<td style="text-align:center"><strong><a href="https://github.com/asdf2014/algorithm/tree/master/Codes/ZZhang">ZZhang</a></strong></td>
<td style="text-align:center">2020-07-26 22:56:26</td>
</tr>
<tr>
<td style="text-align:center"><strong><a href="https://github.com/asdf2014/algorithm/tree/master/Codes/gracekoo">gracekoo</a></strong></td>
<td style="text-align:center">2020-07-16 17:42:18</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/asdf2014/algorithm/tree/master/Codes/Buddy119">Buddy119</a></td>
<td style="text-align:center">2020-06-07 23:26:47</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/asdf2014/algorithm/tree/master/Codes/gmywq392">gmywq392</a></td>
<td style="text-align:center">2020-04-02 10:40:19</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/asdf2014/algorithm/tree/master/Codes/Liam">Liam</a></td>
<td style="text-align:center">2020-03-13 13:31:26</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/asdf2014/algorithm/tree/master/Codes/lxycg">lxycg</a></td>
<td style="text-align:center">2020-03-02 11:39:32</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/asdf2014/algorithm/tree/master/Codes/BoCai">BoCai</a></td>
<td style="text-align:center">2020-02-17 23:06:11</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/asdf2014/algorithm/tree/master/Codes/yore">yore</a></td>
<td style="text-align:center">2020-02-15 12:25:07</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/asdf2014/algorithm/tree/master/Codes/zsdostar">zsdostar</a></td>
<td style="text-align:center">2020-01-22 18:37:49</td>
</tr>
</tbody>
</table>
</div>
<div class="note info">下文将总结归纳大家讨论交流的内容，不断地沉淀解题过程中思考的点滴</div>



<h2 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h2><h3 id="复杂度"><a href="#复杂度" class="headerlink" title="复杂度"></a>复杂度</h3><p><img data-src="/picture/algorithm/algorithm_comparison_computational_complexity.svg" alt="Algorithm Complexity"></p>
<center>（图片来源：<a href="https://zh.wikipedia.org/wiki/%E6%97%B6%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6" target="_blank">wikipedia.org</a>，已确认版权为 CC BY-SA 4.0 协议）</center>



<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">名称</th>
<th style="text-align:center">运行时间</th>
<th style="text-align:center">运行时间举例</th>
<th style="text-align:center">算法举例</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">常数时间</td>
<td style="text-align:center">$O(1)$</td>
<td style="text-align:center">10</td>
<td style="text-align:center">判断一个二进制数的奇偶</td>
</tr>
<tr>
<td style="text-align:center">反阿克曼时间</td>
<td style="text-align:center">$O(\alpha (n))$</td>
<td style="text-align:center"></td>
<td style="text-align:center">并查集的单个操作的平摊时间</td>
</tr>
<tr>
<td style="text-align:center">迭代对数时间</td>
<td style="text-align:center">$O(\log ^{\ast}n)$</td>
<td style="text-align:center"></td>
<td style="text-align:center"><a href="https://zh.wikipedia.org/wiki/图着色问题">分布式圆环着色问题</a></td>
</tr>
<tr>
<td style="text-align:center">对数对数时间</td>
<td style="text-align:center">$O(\log \log n)$</td>
<td style="text-align:center"></td>
<td style="text-align:center">有界优先队列的单个操作</td>
</tr>
<tr>
<td style="text-align:center">对数时间</td>
<td style="text-align:center">$O(\log n)$</td>
<td style="text-align:center">$\log n$，$\log n^{2}$</td>
<td style="text-align:center">二分搜索</td>
</tr>
<tr>
<td style="text-align:center">幂对数时间</td>
<td style="text-align:center">$(\log n)^{O(1)}$</td>
<td style="text-align:center">$(\log n)^{2}$</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">幂时间（小于 1 次）</td>
<td style="text-align:center">$O(n^{c})$，$0&lt;c&lt;1$</td>
<td style="text-align:center">$n^{\frac {1}{2}}$，$n^{\frac {2}{3}}$</td>
<td style="text-align:center"><a href="https://zh.wikipedia.org/wiki/K-d树">K-d 树</a>的搜索操作</td>
</tr>
<tr>
<td style="text-align:center">线性时间</td>
<td style="text-align:center">$O(n)$</td>
<td style="text-align:center">$n$</td>
<td style="text-align:center">无序数组的搜索</td>
</tr>
<tr>
<td style="text-align:center">线性迭代对数时间</td>
<td style="text-align:center">$O(n\log ^ {\ast}n)$</td>
<td style="text-align:center"></td>
<td style="text-align:center">莱姆德·赛德尔的三角分割多边形算法</td>
</tr>
<tr>
<td style="text-align:center">线性对数时间</td>
<td style="text-align:center">$O(n\log n)$</td>
<td style="text-align:center">$n\log n$</td>
<td style="text-align:center">最快的比较排序</td>
</tr>
<tr>
<td style="text-align:center">二次时间</td>
<td style="text-align:center">$O(n^{2})$</td>
<td style="text-align:center">$n^{2}$</td>
<td style="text-align:center">冒泡排序、插入排序</td>
</tr>
<tr>
<td style="text-align:center">三次时间</td>
<td style="text-align:center">$O(n^{3})$</td>
<td style="text-align:center">$n^{3}$</td>
<td style="text-align:center">矩阵乘法的基本实现</td>
</tr>
<tr>
<td style="text-align:center">多项式时间</td>
<td style="text-align:center">$2^{O(\log n)}=n^{O(1)}$</td>
<td style="text-align:center">$n$，$n\log n$，$n^{10}$</td>
<td style="text-align:center">线性规划中的卡马卡算法，<a href="https://zh.wikipedia.org/wiki/AKS質數測試">AKS 质数测试</a></td>
</tr>
<tr>
<td style="text-align:center">准多项式时间</td>
<td style="text-align:center">$2^{(\log n)^{O(1)}}$</td>
<td style="text-align:center"></td>
<td style="text-align:center">关于有向斯坦纳树问题最著名的 $O(\log ^{2}n)$ 近似算法</td>
</tr>
<tr>
<td style="text-align:center">次指数时间（第一定义）</td>
<td style="text-align:center">$O(2^{n^{\epsilon }})$，ε &gt; 0</td>
<td style="text-align:center">$O(2^{(\log n)^{\log \log n}})$</td>
<td style="text-align:center">假设复杂性理论推测，BPP 包含在 SUBEXP 中</td>
</tr>
<tr>
<td style="text-align:center">次指数时间（第二定义）</td>
<td style="text-align:center">$2^{o(n)}$</td>
<td style="text-align:center">$2^{n^{\frac1{3}}}$</td>
<td style="text-align:center">用于<a href="https://zh.wikipedia.org/wiki/整数分解">整数分解</a>与图形同构问题的著名算法</td>
</tr>
<tr>
<td style="text-align:center">指数时间</td>
<td style="text-align:center">$2^{O(n)}$</td>
<td style="text-align:center">$1.1^n$，$10^n$</td>
<td style="text-align:center">使用动态规划解决<a href="https://zh.wikipedia.org/wiki/旅行推销员问题">旅行推销员问题</a></td>
</tr>
<tr>
<td style="text-align:center">阶乘时间</td>
<td style="text-align:center">$O(O!)$</td>
<td style="text-align:center">$n!$</td>
<td style="text-align:center">通过暴力搜索解决旅行推销员问题</td>
</tr>
<tr>
<td style="text-align:center">指数时间</td>
<td style="text-align:center">$2^{poly(n)}$</td>
<td style="text-align:center">$2^n, 2^{n^2}$</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">双重指数时间</td>
<td style="text-align:center">$2^{2^{poly(n)}}$</td>
<td style="text-align:center">$2^{2^n}$</td>
<td style="text-align:center">在预膨胀算术中决定一个给定描述的真实性</td>
</tr>
</tbody>
</table>
</div>
<center>（表格来源：<a href="https://zh.wikipedia.org/wiki/%E6%97%B6%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6" target="_blank">wikipedia.org</a>）</center>





<h2 id="经典算法"><a href="#经典算法" class="headerlink" title="经典算法"></a>经典算法</h2><h3 id="String-Matching"><a href="#String-Matching" class="headerlink" title="String Matching"></a>String Matching</h3><h4 id="种类"><a href="#种类" class="headerlink" title="种类"></a>种类</h4><h5 id="朴素算法（Naive-Algorithm）"><a href="#朴素算法（Naive-Algorithm）" class="headerlink" title="朴素算法（Naive Algorithm）"></a><a href="http://www.cnblogs.com/gaochundong/p/string_matching.html">朴素算法（Naive Algorithm）</a></h5><h5 id="Rabin-Karp-算法"><a href="#Rabin-Karp-算法" class="headerlink" title="Rabin-Karp 算法"></a>Rabin-Karp 算法</h5><h5 id="有限自动机算法（Finite-Automation）"><a href="#有限自动机算法（Finite-Automation）" class="headerlink" title="有限自动机算法（Finite Automation）"></a>有限自动机算法（Finite Automation）</h5><h5 id="KMP"><a href="#KMP" class="headerlink" title="KMP"></a>KMP</h5><p>　KMP，<a href="http://en.wikipedia.org/wiki/Knuth%E2%80%93Morris%E2%80%93Pratt_algorithm"><strong>K</strong>nuth-<strong>M</strong>orris-<strong>P</strong>ratt</a> 匹配<a href="http://www.ruanyifeng.com/blog/2013/05/Knuth%E2%80%93Morris%E2%80%93Pratt_algorithm.html">算法</a></p>
<h5 id="Boyer-Moore-算法"><a href="#Boyer-Moore-算法" class="headerlink" title="Boyer-Moore 算法"></a><a href="http://www.cnblogs.com/gaochundong/p/boyer_moore_string_matching_algorithm.html">Boyer-Moore 算法</a></h5><h5 id="Simon-算法"><a href="#Simon-算法" class="headerlink" title="Simon 算法"></a>Simon 算法</h5><h5 id="Colussi-算法"><a href="#Colussi-算法" class="headerlink" title="Colussi 算法"></a>Colussi 算法</h5><h5 id="Galil-Giancarlo-算法"><a href="#Galil-Giancarlo-算法" class="headerlink" title="Galil-Giancarlo 算法"></a>Galil-Giancarlo 算法</h5><h5 id="Apostolico-Crochemore-算法"><a href="#Apostolico-Crochemore-算法" class="headerlink" title="Apostolico-Crochemore 算法"></a>Apostolico-Crochemore 算法</h5><h5 id="Horspool-算法"><a href="#Horspool-算法" class="headerlink" title="Horspool 算法"></a>Horspool 算法</h5><h5 id="Sunday-算法"><a href="#Sunday-算法" class="headerlink" title="Sunday 算法"></a>Sunday 算法</h5><h4 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h4><h5 id="string-to-integer-atoi"><a href="#string-to-integer-atoi" class="headerlink" title="string-to-integer-atoi"></a><a href="https://leetcode.com/problems/string-to-integer-atoi/submissions/">string-to-integer-atoi</a></h5><div class="tabs" id="code8"><ul class="nav-tabs"><li class="tab active"><a href="#code8-1">CODE8 1</a></li></ul><div class="tab-content"><div class="tab-pane active" id="code8-1"><p><strong>正则匹配解</strong></p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line">patten = <span class="string">'^(([+|-]\\d+)|\\d+)'</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">string_to_integer_atoi</span>(<span class="params">s</span>):</span></span><br><span class="line">    match = re.search(patten, s.strip())</span><br><span class="line">    res = int(match.group()) <span class="keyword">if</span> match <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> max(min(res, <span class="number">2</span> ** <span class="number">31</span> - <span class="number">1</span>), <span class="number">-2</span> ** <span class="number">31</span>)</span><br></pre></td></tr></tbody></table></figure></div></div></div>
<h5 id="letter-combinations-of-a-phone-number"><a href="#letter-combinations-of-a-phone-number" class="headerlink" title="letter-combinations-of-a-phone-number"></a><a href="https://leetcode.com/problems/letter-combinations-of-a-phone-number/">letter-combinations-of-a-phone-number</a></h5><div class="tabs" id="code17"><ul class="nav-tabs"><li class="tab active"><a href="#code17-1">CODE17 1</a></li></ul><div class="tab-content"><div class="tab-pane active" id="code17-1"><p><strong>算术解</strong></p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line">chars = [<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>, <span class="string">"d"</span>, <span class="string">"e"</span>, <span class="string">"f"</span>, <span class="string">"g"</span>, <span class="string">"h"</span>, <span class="string">"i"</span>, <span class="string">"j"</span>, <span class="string">"k"</span>, <span class="string">"l"</span>, <span class="string">"m"</span>, <span class="string">"n"</span>, <span class="string">"o"</span>, <span class="string">"p"</span>, <span class="string">"q"</span>, <span class="string">"r"</span>, <span class="string">"s"</span>, <span class="string">"t"</span>, <span class="string">"u"</span>, <span class="string">"v"</span>, <span class="string">"w"</span>, <span class="string">"x"</span>, <span class="string">"y"</span>, <span class="string">"z"</span> ]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">letter_combinations_of_a_phone_number</span>(<span class="params">digits</span>):</span></span><br><span class="line">    <span class="keyword">if</span> len(digits) == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    <span class="keyword">if</span> len(digits) == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> [i <span class="keyword">for</span> i <span class="keyword">in</span> letters(digits[<span class="number">0</span>])]</span><br><span class="line">    previous = letter_combinations_of_a_phone_number(digits[:<span class="number">-1</span>])</span><br><span class="line">    <span class="keyword">return</span> [i + j <span class="keyword">for</span> i <span class="keyword">in</span> previous <span class="keyword">for</span> j <span class="keyword">in</span> letters(digits[<span class="number">-1</span>])]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">letters</span>(<span class="params">n</span>):</span></span><br><span class="line">    n = int(n)</span><br><span class="line">    <span class="keyword">if</span> n &lt; <span class="number">1</span> <span class="keyword">or</span> n &gt; <span class="number">9</span>:</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    <span class="keyword">elif</span> n == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    <span class="keyword">elif</span> n &lt;= <span class="number">6</span>:</span><br><span class="line">        <span class="keyword">return</span> chars[(n - <span class="number">2</span>) * <span class="number">3</span> : (n - <span class="number">1</span>) * <span class="number">3</span>]</span><br><span class="line">    <span class="keyword">elif</span> n == <span class="number">7</span>:</span><br><span class="line">        <span class="keyword">return</span> chars[<span class="number">15</span>:<span class="number">19</span>]</span><br><span class="line">    <span class="keyword">elif</span> n == <span class="number">8</span>:</span><br><span class="line">        <span class="keyword">return</span> chars[<span class="number">19</span>:<span class="number">22</span>]</span><br><span class="line">    <span class="keyword">elif</span> n == <span class="number">9</span>:</span><br><span class="line">        <span class="keyword">return</span> chars[<span class="number">22</span>:<span class="number">26</span>]</span><br></pre></td></tr></tbody></table></figure></div></div></div>
<h5 id="valid-parentheses"><a href="#valid-parentheses" class="headerlink" title="valid-parentheses"></a><a href="https://leetcode.com/problems/valid-parentheses/">valid-parentheses</a></h5><div class="tabs" id="code20"><ul class="nav-tabs"><li class="tab active"><a href="#code20-1">CODE20 1</a></li></ul><div class="tab-content"><div class="tab-pane active" id="code20-1"><p><strong>堆栈解</strong></p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">valid_parentheses</span>(<span class="params">s: str</span>) -&gt; bool:</span></span><br><span class="line">    <span class="keyword">if</span> len(s) == <span class="number">0</span> <span class="keyword">or</span> len(s) % <span class="number">2</span> == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    stack = []</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> s:</span><br><span class="line">        <span class="keyword">if</span> c <span class="keyword">in</span> revert_pairs.values():</span><br><span class="line">            stack.append(c)</span><br><span class="line">        <span class="keyword">elif</span> c <span class="keyword">in</span> revert_pairs:</span><br><span class="line">            <span class="keyword">if</span> len(stack) == <span class="number">0</span> <span class="keyword">or</span> stack.pop() <span class="keyword">is</span> <span class="keyword">not</span> revert_pairs[c]:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> len(stack) == <span class="number">0</span></span><br></pre></td></tr></tbody></table></figure></div></div></div>
<h5 id="zigzag-conversion"><a href="#zigzag-conversion" class="headerlink" title="zigzag-conversion"></a><a href="https://leetcode.com/problems/zigzag-conversion/">zigzag-conversion</a></h5><div class="tabs" id="code6"><ul class="nav-tabs"><li class="tab"><a href="#code6-1">CODE6 1</a></li><li class="tab active"><a href="#code6-2">CODE6 2</a></li></ul><div class="tab-content"><div class="tab-pane" id="code6-1"><p><strong>纯数学解</strong></p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">zigzag_conversion</span>(<span class="params">s, num_rows</span>):</span></span><br><span class="line">    s_len = len(s)</span><br><span class="line">    <span class="keyword">if</span> s_len == <span class="number">0</span> <span class="keyword">or</span> num_rows &lt;= <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span></span><br><span class="line">    <span class="keyword">if</span> s_len &lt; <span class="number">3</span> <span class="keyword">or</span> num_rows == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line">    middle_num = num_rows - <span class="number">2</span></span><br><span class="line">    cycle_num = num_rows + middle_num</span><br><span class="line">    remain = s_len % cycle_num</span><br><span class="line">    x_total = (s_len // cycle_num) * (middle_num + <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="number">0</span> &lt; remain &lt;= num_rows:</span><br><span class="line">        x_total += <span class="number">1</span></span><br><span class="line">    <span class="keyword">elif</span> remain &gt; num_rows:</span><br><span class="line">        x_total += remain - num_rows + <span class="number">1</span></span><br><span class="line">    arr = [[<span class="string">""</span> <span class="keyword">for</span> _ <span class="keyword">in</span> range(x_total)] <span class="keyword">for</span> _ <span class="keyword">in</span> range(num_rows)]</span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> s:</span><br><span class="line">        cycle_times = count // cycle_num</span><br><span class="line">        remain = count % cycle_num</span><br><span class="line">        <span class="keyword">if</span> remain &lt; num_rows:</span><br><span class="line">            arr[remain][cycle_times * (middle_num + <span class="number">1</span>)] = c</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            arr[num_rows - (remain - (num_rows - <span class="number">1</span>)) - <span class="number">1</span>][ cycle_times * (middle_num + <span class="number">1</span>) + remain - num_rows + <span class="number">1</span> ] = c</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">""</span>.join(str(x) <span class="keyword">for</span> inner_arr <span class="keyword">in</span> arr <span class="keyword">for</span> x <span class="keyword">in</span> inner_arr)</span><br></pre></td></tr></tbody></table></figure></div><div class="tab-pane active" id="code6-2"><p><strong>爬格子解</strong></p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">zigzag_conversion</span>(<span class="params">s, num_rows</span>):</span></span><br><span class="line">    <span class="keyword">if</span> num_rows == <span class="number">1</span> <span class="keyword">or</span> num_rows &gt;= len(s):</span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line">    res = [<span class="string">""</span>] * num_rows</span><br><span class="line">    index, step = <span class="number">0</span>, <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> s:</span><br><span class="line">        res[index] += c</span><br><span class="line">        <span class="keyword">if</span> index == <span class="number">0</span>:</span><br><span class="line">            step = <span class="number">1</span></span><br><span class="line">        <span class="keyword">elif</span> index == num_rows - <span class="number">1</span>:</span><br><span class="line">            step = <span class="number">-1</span></span><br><span class="line">        index += step</span><br><span class="line">    <span class="keyword">return</span> <span class="string">""</span>.join(res)</span><br></pre></td></tr></tbody></table></figure></div></div></div>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><h5 id="Book"><a href="#Book" class="headerlink" title="Book"></a>Book</h5><ul>
<li>《<a href="https://book.douban.com/subject/2038862/">柔性字符串匹配</a>》</li>
</ul>
<h3 id="Sorting-Algorithm"><a href="#Sorting-Algorithm" class="headerlink" title="Sorting Algorithm"></a>Sorting Algorithm</h3><h4 id="参考-1"><a href="#参考-1" class="headerlink" title="参考"></a>参考</h4><ul>
<li><a href="https://zh.wikipedia.org/wiki/%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95">wikipedia 排序算法</a></li>
<li><a href="https://leetcode.com/tag/sort/">Leetcode Sort</a></li>
</ul>
<h3 id="Dynamic-Programming"><a href="#Dynamic-Programming" class="headerlink" title="Dynamic Programming"></a>Dynamic Programming</h3><h4 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h4><p>　<strong>动态规划</strong>（<strong>DP</strong>，<strong>D</strong>ynamic <strong>P</strong>rogramming），是一种通过把原问题分解为相对简单的子问题，以求解复杂问题的方法</p>
<h4 id="关键概念"><a href="#关键概念" class="headerlink" title="关键概念"></a>关键概念</h4><h5 id="状态"><a href="#状态" class="headerlink" title="状态"></a>状态</h5><p>　用来描述该问题的子问题的解</p>
<h5 id="状态转移方程"><a href="#状态转移方程" class="headerlink" title="状态转移方程"></a>状态转移方程</h5><p>　状态和状态之间的关系式</p>
<p>　例如，可以将斐波那契数列表示为：</p>
<script type="math/tex; mode=display">
f(x) = 
\begin{cases}
0, x = 0 \\
1, x = 1 \\
f(x - 1) + f(x - 2), x \ge 2, x \in N
\end{cases}</script><h5 id="递推"><a href="#递推" class="headerlink" title="递推"></a>递推</h5><p>　每个阶段只有一个状态</p>
<h5 id="贪心"><a href="#贪心" class="headerlink" title="贪心"></a>贪心</h5><p>　每个阶段的最优状态，都是由上一个阶段的最优状态得到的</p>
<h5 id="搜索"><a href="#搜索" class="headerlink" title="搜索"></a>搜索</h5><p>　每个阶段的最优状态，是由之前所有阶段的状态的组合得到的</p>
<h5 id="动态规划"><a href="#动态规划" class="headerlink" title="动态规划"></a>动态规划</h5><p>　每个阶段的最优状态，可以从之前<strong>某个阶段</strong>的某个或某些状态<strong>直接得到</strong>，而<strong>不管</strong>之前这个状态是<strong>如何得到的</strong></p>
<h5 id="最优子结构"><a href="#最优子结构" class="headerlink" title="最优子结构"></a>最优子结构</h5><p>　每个阶段的最优状态，可以从之前某个阶段的某个或某些状态直接得到</p>
<h5 id="无后效性"><a href="#无后效性" class="headerlink" title="无后效性"></a>无后效性</h5><p>　不管之前这个状态是如何得到的</p>
<h4 id="实战-1"><a href="#实战-1" class="headerlink" title="实战"></a>实战</h4><h5 id="longest-palindromic-substring"><a href="#longest-palindromic-substring" class="headerlink" title="longest-palindromic-substring"></a><a href="https://leetcode.com/problems/longest-palindromic-substring/">longest-palindromic-substring</a></h5><div class="tabs" id="code5"><ul class="nav-tabs"><li class="tab active"><a href="#code5-1">CODE5 1</a></li></ul><div class="tab-content"><div class="tab-pane active" id="code5-1"><p><strong>S(n) = $O(1)$ 解</strong></p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">longest_palindromic_substring</span>(<span class="params">s</span>):</span></span><br><span class="line">    res = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(s)):</span><br><span class="line">        odd = find(s, i, i)</span><br><span class="line">        even = find(s, i, i + <span class="number">1</span>)</span><br><span class="line">        res = max(res, odd, even, key=len)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find</span>(<span class="params">s, left, right</span>):</span></span><br><span class="line">    <span class="keyword">while</span> left &gt;= <span class="number">0</span> <span class="keyword">and</span> right &lt; len(s) <span class="keyword">and</span> s[left] == s[right]:</span><br><span class="line">        left -= <span class="number">1</span></span><br><span class="line">        right += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> s[left + <span class="number">1</span>:right]</span><br></pre></td></tr></tbody></table></figure></div></div></div>
<h5 id="regular-expression-matching"><a href="#regular-expression-matching" class="headerlink" title="regular-expression-matching"></a><a href="https://leetcode.com/problems/regular-expression-matching/">regular-expression-matching</a></h5><div class="tabs" id="code10"><ul class="nav-tabs"><li class="tab active"><a href="#code10-1">CODE10 1</a></li></ul><div class="tab-content"><div class="tab-pane active" id="code10-1"><p><strong>动态规划解</strong></p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">regular_expression_matching</span>(<span class="params">s, p</span>):</span></span><br><span class="line">    dp = [[<span class="literal">False</span>] * (len(s) + <span class="number">1</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> range(len(p) + <span class="number">1</span>)]</span><br><span class="line">    dp[<span class="number">0</span>][<span class="number">0</span>] = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, len(p)):</span><br><span class="line">        dp[i + <span class="number">1</span>][<span class="number">0</span>] = dp[i - <span class="number">1</span>][<span class="number">0</span>] <span class="keyword">and</span> p[i] == <span class="string">"*"</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(p)):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(len(s)):</span><br><span class="line">            <span class="keyword">if</span> p[i] == <span class="string">"*"</span>:</span><br><span class="line">                dp[i + <span class="number">1</span>][j + <span class="number">1</span>] = dp[i - <span class="number">1</span>][j + <span class="number">1</span>] <span class="keyword">or</span> dp[i][j + <span class="number">1</span>]</span><br><span class="line">                <span class="keyword">if</span> p[i - <span class="number">1</span>] == s[j] <span class="keyword">or</span> p[i - <span class="number">1</span>] == <span class="string">"."</span>:</span><br><span class="line">                    dp[i + <span class="number">1</span>][j + <span class="number">1</span>] |= dp[i + <span class="number">1</span>][j]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dp[i + <span class="number">1</span>][j + <span class="number">1</span>] = dp[i][j] <span class="keyword">and</span> (p[i] == s[j] <span class="keyword">or</span> p[i] == <span class="string">"."</span>)</span><br><span class="line">    <span class="keyword">return</span> dp[<span class="number">-1</span>][<span class="number">-1</span>]</span><br></pre></td></tr></tbody></table></figure></div></div></div>
<h5 id="generate-parentheses"><a href="#generate-parentheses" class="headerlink" title="generate-parentheses"></a><a href="https://leetcode.com/problems/generate-parentheses/">generate-parentheses</a></h5><div class="tabs" id="code22"><ul class="nav-tabs"><li class="tab active"><a href="#code22-1">CODE22 1</a></li></ul><div class="tab-content"><div class="tab-pane active" id="code22-1"><p><strong>动态规划解</strong></p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_parentheses</span>(<span class="params">n: int</span>) -&gt; [str]:</span></span><br><span class="line">    <span class="keyword">if</span> n &lt;= <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    res = [[<span class="literal">None</span>], [<span class="string">"()"</span>]]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>, n + <span class="number">1</span>):</span><br><span class="line">        tmp = []</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(i):</span><br><span class="line">            tmp1 = res[j]</span><br><span class="line">            tmp2 = res[i - j - <span class="number">1</span>]</span><br><span class="line">            <span class="keyword">for</span> t1 <span class="keyword">in</span> tmp1:</span><br><span class="line">                <span class="keyword">for</span> t2 <span class="keyword">in</span> tmp2:</span><br><span class="line">                    <span class="keyword">if</span> t1 <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                        t1 = <span class="string">""</span></span><br><span class="line">                    <span class="keyword">if</span> t2 <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                        t2 = <span class="string">""</span></span><br><span class="line">                    tmp.append(<span class="string">"("</span> + t1 + <span class="string">")"</span> + t2)</span><br><span class="line">        res.append(tmp)</span><br><span class="line">    <span class="keyword">return</span> res[n]</span><br></pre></td></tr></tbody></table></figure></div></div></div>
<h4 id="参考-2"><a href="#参考-2" class="headerlink" title="参考"></a>参考</h4><ul>
<li><a href="https://zh.wikipedia.org/wiki/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92">wikipedia 动态规划</a></li>
<li><a href="https://www.zhihu.com/question/23995189">什么是动态规划？动态规划的意义是什么？</a></li>
<li><a href="https://leetcode.com/tag/dynamic-programming/">Leetcode Dynamic Programming</a></li>
</ul>
<h3 id="Hash"><a href="#Hash" class="headerlink" title="Hash"></a>Hash</h3><h4 id="哈希冲突"><a href="#哈希冲突" class="headerlink" title="哈希冲突"></a>哈希冲突</h4><h5 id="开放式寻址"><a href="#开放式寻址" class="headerlink" title="开放式寻址"></a><a href="https://en.wikipedia.org/wiki/Open_addressing">开放式寻址</a></h5><ul>
<li><p><a href="https://zh.wikipedia.org/wiki/%E7%BA%BF%E6%80%A7%E6%8E%A2%E6%B5%8B">线性探测</a>法</p>
<p>从发生冲突的地址起，依次判断下一个地址是否为空，直到碰到空闲的地址</p>
</li>
<li><p>直接定址法</p>
<p>取关键字 $k$ 或者 $k$ 的某个线性函数值（$a \cdot k + b$）作为哈希地址</p>
</li>
<li><p><a href="https://en.wikipedia.org/wiki/Quadratic_probing">二次探测</a>法</p>
<p>以关键字 $k$ 或者 $k$ 加上某个常数的平方（$k + 1^2$、$k + 2^2$、$k + 3^2$ $\dots$）作为哈希地址</p>
</li>
<li><p>伪随机数法</p>
<p>采用一个伪随机数当作哈希函数</p>
</li>
<li><p><a href="https://en.wikipedia.org/wiki/Double_hashing">双重哈希</a>法</p>
<p>双重哈希是用于开放寻址最好的方法之一，散列函数如下：</p>
<script type="math/tex; mode=display">h(i, k)=(h_1(k)+i \cdot h_2(k)) \mod \vert T \vert</script><p>为了能查找整个散列表，值 $h_2(k)$ 需要与表的大小 $T$ 互质。为确保这一条件成立，可采用以下两种方法</p>
<ul>
<li>取 $T$ 为 2 的幂，并设计一个总产生奇数的 $h_2$</li>
<li>取 $T$ 为质数，并设计一个总是产生较 $T$ 小的正整数的 $h_2$</li>
</ul>
</li>
</ul>
<h5 id="关键字分析"><a href="#关键字分析" class="headerlink" title="关键字分析"></a>关键字分析</h5><ul>
<li><p>数字分析法</p>
<p>提取关键字中，取值比较均匀的数字作为哈希地址</p>
</li>
<li><p>平方取中法</p>
<p>如果关键字各个部分的分布都不均匀的话，可以先求出它的平方值，然后按照需求取中间的几位作为哈希地址</p>
</li>
<li><p>分段叠加法</p>
<p>按照哈希表地址位数将关键字分成位数相等的几部分，其中最后一部分可以比较短。然后将这几部分相加，舍弃最高进位后的结果，即可作为该关键字的哈希地址</p>
</li>
</ul>
<h5 id="冲突转移"><a href="#冲突转移" class="headerlink" title="冲突转移"></a>冲突转移</h5><ul>
<li><p>拉链法</p>
<p>拉链法，又称链接地址法，是将哈希值相同的元素构成一个同义词的单链表</p>
</li>
<li><p>公共溢出区</p>
<p>将哈希表分为公共区和溢出区，当发生溢出时，将所有溢出数据统一写入到溢出区</p>
</li>
</ul>
<h4 id="实战-2"><a href="#实战-2" class="headerlink" title="实战"></a>实战</h4><h5 id="two-sum"><a href="#two-sum" class="headerlink" title="two-sum"></a><a href="https://leetcode.com/problems/two-sum/">two-sum</a></h5><div class="tabs" id="code1"><ul class="nav-tabs"><li class="tab active"><a href="#code1-1">CODE1 1</a></li></ul><div class="tab-content"><div class="tab-pane active" id="code1-1"><p><strong>T(n) = S(n) = $O(n)$ 解</strong></p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">two_sum</span>(<span class="params">nums, target</span>):</span></span><br><span class="line">    nums_len = len(nums)</span><br><span class="line">    <span class="keyword">if</span> nums_len &lt; <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    cache = {}</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(nums_len):</span><br><span class="line">        n = nums[i]</span><br><span class="line">        <span class="keyword">if</span> n <span class="keyword">in</span> cache:</span><br><span class="line">            <span class="keyword">return</span> [cache[n], i]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            cache[target - n] = i</span><br></pre></td></tr></tbody></table></figure></div></div></div>
<h4 id="参考-3"><a href="#参考-3" class="headerlink" title="参考"></a>参考</h4><ul>
<li><a href="http://cyan4973.github.io/xxHash/">xxHash: an extremely fast non-cryptographic hash algorithm, working at speeds close to RAM limits</a></li>
</ul>
<h3 id="Linked-List"><a href="#Linked-List" class="headerlink" title="Linked List"></a>Linked List</h3><h4 id="种类-1"><a href="#种类-1" class="headerlink" title="种类"></a>种类</h4><h5 id="单向链表"><a href="#单向链表" class="headerlink" title="单向链表"></a>单向链表</h5><p><img data-src="/picture/algorithm/algorithm_singly_linked_list.svg" alt="单向链表"></p>
<center>（图片来源：<a href="https://en.wikipedia.org/wiki/File:Singly-linked-list.svg" target="_blank">wikipedia.org</a>，已确认无版权）</center>

<h6 id="快慢指针法"><a href="#快慢指针法" class="headerlink" title="快慢指针法"></a>快慢指针法</h6><p>　该方法常用于解决查找单向链表的中点、判断链表是否存在环等问题。大体思路便是，设计一快一慢两个指针，记做 <code>fast</code> 和 <code>slow</code>。同时，控制 <code>fast</code> 的速度是 <code>slow</code> 的两倍（如，<code>fast = fast.next.next; slow = slow.next</code>）。这样，可以保证当 <code>fast</code> 到达链表尾部的时候，<code>slow</code> 刚好在链表中间</p>
<h5 id="双向链表"><a href="#双向链表" class="headerlink" title="双向链表"></a>双向链表</h5><p><img data-src="/picture/algorithm/algorithm_doubly_linked_list.svg" alt="双向链表"></p>
<center>（图片来源：<a href="https://en.wikipedia.org/wiki/File:Doubly-linked-list.svg" target="_blank">wikipedia.org</a>，已确认无版权）</center>

<h5 id="循环链表"><a href="#循环链表" class="headerlink" title="循环链表"></a>循环链表</h5><p><img data-src="/picture/algorithm/algorithm_circularly_linked_list.svg" alt="循环链表"></p>
<center>（图片来源：<a href="https://en.wikipedia.org/wiki/File:Circularly-linked-list.svg" target="_blank">wikipedia.org</a>，已确认无版权）</center>

<h4 id="性能对比"><a href="#性能对比" class="headerlink" title="性能对比"></a>性能对比</h4><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">Linked list</th>
<th style="text-align:center">Array</th>
<th style="text-align:center">Dynamic array</th>
<th style="text-align:center">Balanced tree</th>
<th style="text-align:center">Random access list</th>
<th>Hashed array tree</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Indexing</td>
<td style="text-align:center">$O(n)$</td>
<td style="text-align:center">$O(1)$</td>
<td style="text-align:center">$O(1)$</td>
<td style="text-align:center">$O(\log n)$</td>
<td style="text-align:center">$O(\log n)$</td>
<td>$O(1)$</td>
</tr>
<tr>
<td style="text-align:center">Insert/delete at beginning</td>
<td style="text-align:center">$O(1)$</td>
<td style="text-align:center"><code>N/A</code></td>
<td style="text-align:center">$O(n)$</td>
<td style="text-align:center">$O(\log n)$</td>
<td style="text-align:center">$O(1)$</td>
<td>$O(n)$</td>
</tr>
<tr>
<td style="text-align:center">Insert/delete at end</td>
<td style="text-align:center">$O(1)$ when last element is known;<br>$O(n)$ when last element is unknown</td>
<td style="text-align:center"><code>N/A</code></td>
<td style="text-align:center">$O(1)$ <a href="https://en.wikipedia.org/wiki/Amortized_analysis">amortized</a></td>
<td style="text-align:center">$O(\log n)$</td>
<td style="text-align:center">$O(\log n)$ updating</td>
<td>$O(1)$ <a href="https://en.wikipedia.org/wiki/Amortized_analysis">amortized</a></td>
</tr>
<tr>
<td style="text-align:center">Insert/delete in middle</td>
<td style="text-align:center">search time + $O(1)$</td>
<td style="text-align:center"><code>N/A</code></td>
<td style="text-align:center">$O(n)$</td>
<td style="text-align:center">$O(\log n)$</td>
<td style="text-align:center">$O(\log n)$ updating</td>
<td>$O(n)$</td>
</tr>
<tr>
<td style="text-align:center">Wasted space (average)</td>
<td style="text-align:center">$O(n)$</td>
<td style="text-align:center"><code>0</code></td>
<td style="text-align:center">$O(n)$</td>
<td style="text-align:center">$O(n)$</td>
<td style="text-align:center">$O(n)$</td>
<td>$O(\sqrt{n})$</td>
</tr>
</tbody>
</table>
</div>
<center>（表格来源：<a href="https://en.wikipedia.org/wiki/Linked_list" target="_blank">wikipedia.org</a>）</center>



<h4 id="实战-3"><a href="#实战-3" class="headerlink" title="实战"></a>实战</h4><h5 id="add-two-numbers"><a href="#add-two-numbers" class="headerlink" title="add-two-numbers"></a><a href="https://leetcode.com/problems/add-two-numbers/">add-two-numbers</a></h5><div class="tabs" id="code2"><ul class="nav-tabs"><li class="tab active"><a href="#code2-1">CODE2 1</a></li></ul><div class="tab-content"><div class="tab-pane active" id="code2-1"><p><strong>T(n) = $O(n)$ 解</strong></p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_two_numbers</span>(<span class="params">left, right</span>):</span></span><br><span class="line">    carry = <span class="number">0</span></span><br><span class="line">    tmp = ListNode(<span class="number">0</span>)</span><br><span class="line">    root = tmp</span><br><span class="line">    <span class="keyword">while</span> left <span class="keyword">or</span> right:</span><br><span class="line">        total = carry + left.val + right.val</span><br><span class="line">        left = left.next</span><br><span class="line">        right = right.next</span><br><span class="line">        carry = total // <span class="number">10</span></span><br><span class="line">        tmp.next = ListNode(total % <span class="number">10</span>)</span><br><span class="line">        tmp = tmp.next</span><br><span class="line">    <span class="keyword">return</span> root.next</span><br></pre></td></tr></tbody></table></figure></div></div></div>
<h5 id="remove-nth-node-from-end-of-list"><a href="#remove-nth-node-from-end-of-list" class="headerlink" title="remove-nth-node-from-end-of-list"></a><a href="https://leetcode.com/problems/remove-nth-node-from-end-of-list/">remove-nth-node-from-end-of-list</a></h5><div class="tabs" id="code19"><ul class="nav-tabs"><li class="tab active"><a href="#code19-1">CODE19 1</a></li></ul><div class="tab-content"><div class="tab-pane active" id="code19-1"><p><strong>遍历解</strong></p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">remove_nth_node_from_end_of_list</span>(<span class="params">head: ListNode, n: int</span>) -&gt; ListNode:</span></span><br><span class="line">    tmp = head</span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> tmp:</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        tmp = tmp.next</span><br><span class="line">    n = count + <span class="number">1</span> - n</span><br><span class="line">    <span class="keyword">if</span> n &lt;= <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> head</span><br><span class="line">    <span class="keyword">if</span> n <span class="keyword">is</span> <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> head.next</span><br><span class="line">    tmp = head</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(n - <span class="number">2</span>):</span><br><span class="line">        tmp = tmp.next</span><br><span class="line">    tmp.next = tmp.next.next</span><br><span class="line">    <span class="keyword">return</span> head</span><br></pre></td></tr></tbody></table></figure></div></div></div>
<h5 id="merge-two-sorted-lists"><a href="#merge-two-sorted-lists" class="headerlink" title="merge-two-sorted-lists"></a><a href="https://leetcode.com/problems/merge-two-sorted-lists/">merge-two-sorted-lists</a></h5><div class="tabs" id="code21"><ul class="nav-tabs"><li class="tab active"><a href="#code21-1">CODE21 1</a></li></ul><div class="tab-content"><div class="tab-pane active" id="code21-1"><p><strong>遍历解</strong></p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">merge_two_sorted_lists</span>(<span class="params">l1: ListNode, l2: ListNode</span>) -&gt; ListNode:</span></span><br><span class="line">    root = tmp = ListNode(<span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">while</span> l1 <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">or</span> l2 <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">if</span> l2 <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            tmp.next = l1</span><br><span class="line">            l1 = l1.next</span><br><span class="line">        <span class="keyword">elif</span> l1 <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            tmp.next = l2</span><br><span class="line">            l2 = l2.next</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> l1.val &lt; l2.val:</span><br><span class="line">                tmp.next = l1</span><br><span class="line">                l1 = l1.next</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                tmp.next = l2</span><br><span class="line">                l2 = l2.next</span><br><span class="line">        tmp = tmp.next</span><br><span class="line">    <span class="keyword">return</span> root.next</span><br></pre></td></tr></tbody></table></figure></div></div></div>
<h3 id="Sliding-Window"><a href="#Sliding-Window" class="headerlink" title="Sliding Window"></a>Sliding Window</h3><h4 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h4><p>　滑动窗口算法，主要用于解决数组或者字符串的子元素问题。它可以将嵌套的循环问题，转换为单循环问题，从而降低时间复杂度</p>
<h4 id="实战-4"><a href="#实战-4" class="headerlink" title="实战"></a>实战</h4><h5 id="longest-substring-without-repeating-characters"><a href="#longest-substring-without-repeating-characters" class="headerlink" title="longest-substring-without-repeating-characters"></a><a href="https://leetcode.com/problems/longest-substring-without-repeating-characters/">longest-substring-without-repeating-characters</a></h5><div class="tabs" id="code3"><ul class="nav-tabs"><li class="tab active"><a href="#code3-1">CODE3 1</a></li></ul><div class="tab-content"><div class="tab-pane active" id="code3-1"><p><strong>T(n) = S(n) = $O(n)$ 解</strong></p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">longest_substring_without_repeating_characters</span>(<span class="params">s</span>):</span></span><br><span class="line">    begin = <span class="number">0</span></span><br><span class="line">    res = <span class="number">0</span></span><br><span class="line">    cache = {}</span><br><span class="line">    <span class="keyword">for</span> i, c <span class="keyword">in</span> enumerate(s):</span><br><span class="line">        <span class="keyword">if</span> c <span class="keyword">in</span> cache <span class="keyword">and</span> begin &lt;= cache[c]:</span><br><span class="line">            begin = cache[c] + <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            res = max(res, i - begin + <span class="number">1</span>)</span><br><span class="line">        cache[c] = i</span><br><span class="line">    <span class="keyword">return</span> res</span><br></pre></td></tr></tbody></table></figure></div></div></div>
<h3 id="Math"><a href="#Math" class="headerlink" title="Math"></a>Math</h3><h4 id="实战-5"><a href="#实战-5" class="headerlink" title="实战"></a>实战</h4><h5 id="reverse-integer"><a href="#reverse-integer" class="headerlink" title="reverse-integer"></a><a href="https://leetcode.com/problems/reverse-integer/">reverse-integer</a></h5><div class="tabs" id="code7"><ul class="nav-tabs"><li class="tab active"><a href="#code7-1">CODE7 1</a></li><li class="tab"><a href="#code7-2">CODE7 2</a></li></ul><div class="tab-content"><div class="tab-pane active" id="code7-1"><p><strong>纯数学的方式</strong></p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reverse_integer</span>(<span class="params">x</span>):</span></span><br><span class="line">    sign = (x &gt; <span class="number">0</span>) - (x &lt; <span class="number">0</span>)</span><br><span class="line">    x *= sign</span><br><span class="line">    size = len(str(x))</span><br><span class="line">    res = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, size + <span class="number">1</span>):</span><br><span class="line">        remaining = x % <span class="number">10</span></span><br><span class="line">        refactor = <span class="number">10</span> ** (size - i)</span><br><span class="line">        res += remaining * refactor</span><br><span class="line">        x //= <span class="number">10</span></span><br><span class="line">    <span class="keyword">if</span> res &gt; <span class="number">2</span> ** <span class="number">31</span> - <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> sign * res</span><br></pre></td></tr></tbody></table></figure></div><div class="tab-pane" id="code7-2"><p><strong>字符串切片</strong></p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reverse_integer</span>(<span class="params">x</span>):</span></span><br><span class="line">    sign = (x &gt; <span class="number">0</span>) - (x &lt; <span class="number">0</span>)</span><br><span class="line">    res = int(str(x * sign)[::<span class="number">-1</span>])</span><br><span class="line">    <span class="keyword">return</span> sign * res * (res &lt; <span class="number">2</span> ** <span class="number">31</span>)</span><br></pre></td></tr></tbody></table></figure></div></div></div>
<h5 id="palindrome-number"><a href="#palindrome-number" class="headerlink" title="palindrome-number"></a><a href="https://leetcode.com/problems/palindrome-number/">palindrome-number</a></h5><div class="tabs" id="code9"><ul class="nav-tabs"><li class="tab"><a href="#code9-1">CODE9 1</a></li><li class="tab active"><a href="#code9-2">CODE9 2</a></li></ul><div class="tab-content"><div class="tab-pane" id="code9-1"><p><strong>纯数学的方式</strong></p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">palindrome_number</span>(<span class="params">x</span>):</span></span><br><span class="line">    <span class="keyword">if</span> x &lt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">elif</span> x == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    h, rev = x, <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> h:</span><br><span class="line">        rev = rev * <span class="number">10</span> + h % <span class="number">10</span></span><br><span class="line">        h //= <span class="number">10</span></span><br><span class="line">    <span class="keyword">return</span> rev == x</span><br></pre></td></tr></tbody></table></figure></div><div class="tab-pane active" id="code9-2"><p><strong>字符串反转</strong></p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">palindrome_number</span>(<span class="params">x</span>):</span></span><br><span class="line">    <span class="keyword">return</span> x == <span class="number">0</span> <span class="keyword">or</span> (x &gt; <span class="number">0</span>) <span class="keyword">and</span> int(str(x)[::<span class="number">-1</span>]) == x</span><br></pre></td></tr></tbody></table></figure></div></div></div>
<h5 id="roman-to-integer"><a href="#roman-to-integer" class="headerlink" title="roman-to-integer"></a><a href="https://leetcode.com/problems/roman-to-integer/">roman-to-integer</a></h5><div class="tabs" id="code13"><ul class="nav-tabs"><li class="tab active"><a href="#code13-1">CODE13 1</a></li><li class="tab"><a href="#code13-2">CODE13 2</a></li></ul><div class="tab-content"><div class="tab-pane active" id="code13-1"><p><strong>纯数学的方式</strong></p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line">d = {<span class="string">"I"</span>: <span class="number">1</span>, <span class="string">"V"</span>: <span class="number">5</span>, <span class="string">"X"</span>: <span class="number">10</span>, <span class="string">"L"</span>: <span class="number">50</span>, <span class="string">"C"</span>: <span class="number">100</span>, <span class="string">"D"</span>: <span class="number">500</span>, <span class="string">"M"</span>: <span class="number">1000</span>}</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">roman_to_integer</span>(<span class="params">s</span>):</span></span><br><span class="line">    res = <span class="number">0</span></span><br><span class="line">    high = <span class="number">-1</span></span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> reversed(s):</span><br><span class="line">        now = d[c]</span><br><span class="line">        <span class="keyword">if</span> now &lt; high:</span><br><span class="line">            res -= now</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            res += now</span><br><span class="line">        high = max(high, now)</span><br><span class="line">    <span class="keyword">return</span> res</span><br></pre></td></tr></tbody></table></figure></div><div class="tab-pane" id="code13-2"><p><strong>字符串替换</strong></p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line">d = {<span class="string">"I"</span>: <span class="number">1</span>, <span class="string">"V"</span>: <span class="number">5</span>, <span class="string">"X"</span>: <span class="number">10</span>, <span class="string">"L"</span>: <span class="number">50</span>, <span class="string">"C"</span>: <span class="number">100</span>, <span class="string">"D"</span>: <span class="number">500</span>, <span class="string">"M"</span>: <span class="number">1000</span>}</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">roman_to_integer</span>(<span class="params">s</span>):</span></span><br><span class="line">    res = <span class="number">0</span></span><br><span class="line">    s = s.replace(<span class="string">"IV"</span>, <span class="string">"IIII"</span>).replace(<span class="string">"IX"</span>, <span class="string">"VIIII"</span>)</span><br><span class="line">    s = s.replace(<span class="string">"XL"</span>, <span class="string">"XXXX"</span>).replace(<span class="string">"XC"</span>, <span class="string">"LXXXX"</span>)</span><br><span class="line">    s = s.replace(<span class="string">"CD"</span>, <span class="string">"CCCC"</span>).replace(<span class="string">"CM"</span>, <span class="string">"DCCCC"</span>)</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> s:</span><br><span class="line">        res += d[c]</span><br><span class="line">    <span class="keyword">return</span> res</span><br></pre></td></tr></tbody></table></figure></div></div></div>
<h5 id="3sum"><a href="#3sum" class="headerlink" title="3sum"></a><a href="https://leetcode.com/problems/3sum/">3sum</a></h5><div class="tabs" id="code15"><ul class="nav-tabs"><li class="tab active"><a href="#code15-1">CODE15 1</a></li></ul><div class="tab-content"><div class="tab-pane active" id="code15-1"><p><strong>基于 2sum 的思路</strong></p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sum3</span>(<span class="params">nums</span>):</span></span><br><span class="line">    <span class="keyword">if</span> len(nums) &lt; <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    nums.sort()</span><br><span class="line">    res = []</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> enumerate(nums[:<span class="number">-2</span>]):</span><br><span class="line">        <span class="keyword">if</span> k &gt;= <span class="number">1</span> <span class="keyword">and</span> v == nums[k - <span class="number">1</span>]:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        cache = {}</span><br><span class="line">        <span class="keyword">for</span> n <span class="keyword">in</span> nums[k + <span class="number">1</span>:]:</span><br><span class="line">            <span class="keyword">if</span> n <span class="keyword">not</span> <span class="keyword">in</span> cache:</span><br><span class="line">                cache[-v - n] = <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                tmp = [v, -v - n, n]</span><br><span class="line">                <span class="keyword">if</span> tmp <span class="keyword">not</span> <span class="keyword">in</span> res:</span><br><span class="line">                    res += [tmp]</span><br><span class="line">    <span class="keyword">return</span> res</span><br></pre></td></tr></tbody></table></figure></div></div></div>
<h2 id="预测算法"><a href="#预测算法" class="headerlink" title="预测算法"></a>预测算法</h2><h3 id="简易平均法"><a href="#简易平均法" class="headerlink" title="简易平均法"></a>简易平均法</h3><h4 id="算术平均值"><a href="#算术平均值" class="headerlink" title="算术平均值"></a>算术平均值</h4><h4 id="加权平均值"><a href="#加权平均值" class="headerlink" title="加权平均值"></a>加权平均值</h4><script type="math/tex; mode=display">\frac{\sum^{n}_{i = 1}w_ix_i}{\sum^{n}_{i = 1}w_i}</script><h3 id="移动平均法"><a href="#移动平均法" class="headerlink" title="移动平均法"></a>移动平均法</h3><h3 id="指数平滑法"><a href="#指数平滑法" class="headerlink" title="指数平滑法"></a>指数平滑法</h3><h4 id="参考-4"><a href="#参考-4" class="headerlink" title="参考"></a>参考</h4><ul>
<li><a href="http://westerly-lzh.github.io/cn/2014/05/Exponential-Smoothing/">指数平滑</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-pipeline-movavg-aggregation.html#%20_holt_winters">ElasticSearch Holt-Winters</a></li>
<li><a href="https://tech.meituan.com/order-holtwinter.html">外卖订单量预测异常报警模型实践</a></li>
<li><a href="https://blog.csdn.net/u010665216/article/details/78051192">Holt-Winters 模型原理分析及代码实现（python）</a></li>
<li><a href="http://www.cnblogs.com/kemaswill/archive/2013/04/01/2993583.html">时间序列挖掘 - 预测算法 - 三次指数平滑法（Holt-Winters）</a></li>
</ul>
<h3 id="线性回归法"><a href="#线性回归法" class="headerlink" title="线性回归法"></a>线性回归法</h3><h2 id="分类算法"><a href="#分类算法" class="headerlink" title="分类算法"></a>分类算法</h2><h3 id="贝叶斯（Bayes）"><a href="#贝叶斯（Bayes）" class="headerlink" title="贝叶斯（Bayes）"></a><a href="https://zh.wikipedia.org/wiki/%E8%B4%9D%E5%8F%B6%E6%96%AF%E5%AE%9A%E7%90%86">贝叶斯（Bayes）</a></h3><h4 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h4><script type="math/tex; mode=display">P(B \mid A) = \frac{P(B)\,P(A \mid B)}{P(A)}</script><p>　其中，$P(A \mid B)$ 是在 $B$ 发生的情况下 $A$ 发生的可能性，称为 $A$ 的<a href="https://zh.wikipedia.org/wiki/%E5%90%8E%E9%AA%8C%E6%A6%82%E7%8E%87">后验概率</a>。相应的，$P(B \mid A)$ 则称为 $B$ 后验概率；$P(A)$ 是不考虑任何 $B$ 方面的因素下 $A$ 发生的可能性，称为 $A$ 的<a href="https://zh.wikipedia.org/wiki/%E5%85%88%E9%AA%8C%E6%A6%82%E7%8E%87">先验概率</a>（或<a href="https://zh.wikipedia.org/wiki/%E8%BE%B9%E7%BC%98%E6%A6%82%E7%8E%87">边缘概率</a>）。相应的，$P(B)$ 则称为 $B$ 的先验概率</p>
<h4 id="种类-2"><a href="#种类-2" class="headerlink" title="种类"></a>种类</h4><h5 id="特征独立性"><a href="#特征独立性" class="headerlink" title="特征独立性"></a>特征独立性</h5><p>　按照特征之间<strong>独立性</strong>的强弱，可以分为 <a href="https://zhuanlan.zhihu.com/p/25097242">朴素贝叶斯</a>、半朴素贝叶斯、（一般的）贝叶斯 等</p>
<h5 id="分布情况"><a href="#分布情况" class="headerlink" title="分布情况"></a>分布情况</h5><p>　按照属性和特征的<strong>分布</strong>情况，又可以分为 高斯贝叶斯、多项式贝叶斯、伯努利贝叶斯 等</p>
<h5 id="离散程度"><a href="#离散程度" class="headerlink" title="离散程度"></a>离散程度</h5><p>　按照训练集的<strong>离散</strong>程度，还可以分为 离散型贝叶斯、连续型贝叶斯、混合型贝叶斯 等</p>
<h4 id="编码实战"><a href="#编码实战" class="headerlink" title="编码实战"></a>编码实战</h4><p>　The set <code>A</code> contains 30 <code>a</code> and 10 <code>b</code>, and the set <code>B</code> contains 20 <code>a</code> and 20 <code>b</code>, then what is the value of <code>P(A|a)</code>?</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line">situations = dict()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">priori_probability</span>(<span class="params">situation, probability</span>):</span></span><br><span class="line">    situations[situation] = probability  <span class="comment"># P(A), P(B)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">posterior_probability</span>(<span class="params">situation, probability</span>):</span></span><br><span class="line">    old_prob = situations[situation]</span><br><span class="line">    situations[situation] = old_prob * probability  <span class="comment"># P(A)P(a|A), P(B)P(a|B)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">normalize</span>():</span></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> situation <span class="keyword">in</span> situations.values():</span><br><span class="line">        count += situation  <span class="comment"># P(A)P(a|A) + P(B)P(a|B)</span></span><br><span class="line">    <span class="keyword">for</span> situation, probability <span class="keyword">in</span> situations.items():</span><br><span class="line">        <span class="comment"># P(A)P(a|A)/(P(A)P(a|A) + P(B)P(a|B)), P(B)P(a|B)/(P(A)P(a|A) + P(B)P(a|B))</span></span><br><span class="line">        situations[situation] = situations[situation] / count</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">prob</span>(<span class="params">hypothis</span>):</span></span><br><span class="line">    <span class="keyword">return</span> situations[hypothis]  <span class="comment"># P(A|a), P(B|a)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">priori_probability(<span class="string">'A'</span>, <span class="number">0.5</span>)  <span class="comment"># P(A)=1/2</span></span><br><span class="line">priori_probability(<span class="string">'B'</span>, <span class="number">0.5</span>)  <span class="comment"># P(B)=1/2</span></span><br><span class="line"></span><br><span class="line">posterior_probability(<span class="string">'A'</span>, <span class="number">0.75</span>)  <span class="comment"># P(a|A)=3/4</span></span><br><span class="line">posterior_probability(<span class="string">'B'</span>, <span class="number">0.5</span>)   <span class="comment"># P(a|B)=1/2</span></span><br><span class="line"></span><br><span class="line">normalize()</span><br><span class="line">prob = prob(<span class="string">'A'</span>)  <span class="comment"># P(A|a)</span></span><br><span class="line">print(<span class="string">'The probability of getting `a` that belongs to set `A`: %s'</span> % prob)</span><br><span class="line"><span class="comment"># P(a|A): 从 A 中获取 a</span></span><br><span class="line"><span class="comment"># P(A|a): 获取 a，并且 a 恰巧是属于 A 的</span></span><br><span class="line"><span class="comment"># 这两个描述的场景完全不同，对应的概率也因而不同</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h4><p>　当存在多个特征变量时，表达式可扩展为</p>
<script type="math/tex; mode=display">P(C \mid F_1,\dots,F_n) = \frac{P(C) \, P(F_1,\dots,F_n \mid C)}{P(F_1,\dots,F_n)} = \frac{1}{Z} P(C)\prod_{i=1}^n P(F_i \mid C)</script><p>　其中，$\frac{1}{Z}$ 是一个只与 $F_i$ 相关的缩放因子，且当特征变量的值固定时，$\frac{1}{Z}$ 为常量</p>
<h3 id="支持向量机（SVM）"><a href="#支持向量机（SVM）" class="headerlink" title="支持向量机（SVM）"></a>支持向量机（SVM）</h3><ul>
<li><a href="https://yuzhouwan.com/posts/42737/">感知机</a>追求最大程度正确划分，最小化错误，但相对容易造成过拟合</li>
<li>支持向量机追求在大致正确分类的同时，最大化 margin，一定程度上避免了过拟合。但是由于 SVM 是借助二次规划来求解支持向量，而求解二次规划将涉及 m 阶矩阵的计算（m 为样本的个数）。所以当 m 的数目很大时，该矩阵的存储将消耗大量的机器资源，且运算的时间成本也会很高</li>
</ul>
<h2 id="聚类算法"><a href="#聚类算法" class="headerlink" title="聚类算法"></a>聚类算法</h2><h3 id="K-means"><a href="#K-means" class="headerlink" title="K-means"></a>K-means</h3><h4 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h4><p>　输入聚类个数 k，以及包含 n 个数据对象的数据库，输出满足方差最小标准 k 个聚类的一种算法</p>
<h4 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h4><ul>
<li>从 n 个数据对象任意选择 k 个对象作为初始聚类中心</li>
<li>根据每个聚类对象的均值（中心对象），计算每个对象与这些中心对象的距离；并根据最小距离重新对相应对象进行划分</li>
<li>重新计算每个（有变化）聚类的均值（中心对象）</li>
<li>计算标准测度函数，当满足一定条件，如函数收敛时，则算法终止；如果条件不满足则回到第二步</li>
</ul>
<h2 id="基数估算"><a href="#基数估算" class="headerlink" title="基数估算"></a>基数估算</h2><h3 id="非概率算法"><a href="#非概率算法" class="headerlink" title="非概率算法"></a>非概率算法</h3><h4 id="BitMap"><a href="#BitMap" class="headerlink" title="BitMap"></a>BitMap</h4><h4 id="Roaring-Bitmap"><a href="#Roaring-Bitmap" class="headerlink" title="Roaring Bitmap"></a>Roaring Bitmap</h4><h4 id="Bloom-filter"><a href="#Bloom-filter" class="headerlink" title="Bloom filter"></a>Bloom filter</h4><h4 id="双层字典码"><a href="#双层字典码" class="headerlink" title="双层字典码"></a><a href="https://www.infoq.cn/article/2012%2F08%2Fpowerdrill-in-memory-column-stor">双层字典码</a></h4><h3 id="概率算法"><a href="#概率算法" class="headerlink" title="概率算法"></a>概率算法</h3><h4 id="Count-Mean-Min-Sketch"><a href="#Count-Mean-Min-Sketch" class="headerlink" title="Count-Mean-Min Sketch"></a><a href="https://www.cnblogs.com/fxjwind/p/3289221.html">Count-Mean-Min Sketch</a></h4><h4 id="LogLog-Counting"><a href="#LogLog-Counting" class="headerlink" title="LogLog Counting"></a>LogLog Counting</h4><h4 id="Linear-Counting"><a href="#Linear-Counting" class="headerlink" title="Linear Counting"></a>Linear Counting</h4><h4 id="LogLog-Counting-1"><a href="#LogLog-Counting-1" class="headerlink" title="LogLog Counting"></a>LogLog Counting</h4><h4 id="Adaptive-Counting"><a href="#Adaptive-Counting" class="headerlink" title="Adaptive Counting"></a>Adaptive Counting</h4><h4 id="HyperLogLog-Counting"><a href="#HyperLogLog-Counting" class="headerlink" title="HyperLogLog Counting"></a>HyperLogLog Counting</h4><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line">m = <span class="number">2</span> ^ b  <span class="comment"># with b in [4...16]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> m == <span class="number">16</span>:</span><br><span class="line">    alpha = <span class="number">0.673</span></span><br><span class="line"><span class="keyword">elif</span> m == <span class="number">32</span>:</span><br><span class="line">    alpha = <span class="number">0.697</span></span><br><span class="line"><span class="keyword">elif</span> m == <span class="number">64</span>:</span><br><span class="line">    alpha = <span class="number">0.709</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    alpha = <span class="number">0.7213</span> / (<span class="number">1</span> + <span class="number">1.079</span> / m)</span><br><span class="line"></span><br><span class="line">registers = [<span class="number">0</span>] * m  <span class="comment"># initialize m registers to 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Construct the HLL structure</span></span><br><span class="line"><span class="keyword">for</span> h <span class="keyword">in</span> hashed(data):</span><br><span class="line">    register_index = <span class="number">1</span> + get_register_index(h, b)  <span class="comment"># binary address of the rightmost b bits</span></span><br><span class="line">    run_length = run_of_zeros(h, b)  <span class="comment"># length of the run of zeroes starting at bit b+1</span></span><br><span class="line">    registers[register_index] = max(registers[register_index], run_length)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Determine the cardinality</span></span><br><span class="line">DV_est = alpha * m ^ <span class="number">2</span> * <span class="number">1</span> / sum(<span class="number">2</span> ^ -register)  <span class="comment"># the DV estimate</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> DV_est &lt; <span class="number">5</span> / <span class="number">2</span> * m:  <span class="comment"># small range correction</span></span><br><span class="line">    V = count_of_zero_registers(registers)  <span class="comment"># the number of registers equal to zero</span></span><br><span class="line">    <span class="keyword">if</span> V == <span class="number">0</span>:  <span class="comment"># if none of the registers are empty, use the HLL estimate</span></span><br><span class="line">        DV = DV_est</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        DV = m * log(m / V)  <span class="comment"># i.e. balls and bins correction</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> DV_est &lt;= (<span class="number">1</span> / <span class="number">30</span> * <span class="number">2</span> ^ <span class="number">32</span>):  <span class="comment"># intermediate range, no correction</span></span><br><span class="line">    DV = DV_est</span><br><span class="line"><span class="keyword">if</span> DV_est &gt; (<span class="number">1</span> / <span class="number">30</span> * <span class="number">2</span> ^ <span class="number">32</span>):  <span class="comment"># large range correction</span></span><br><span class="line">    DV = <span class="number">-2</span> ^ <span class="number">32</span> * log(<span class="number">1</span> - DV_est / <span class="number">2</span> ^ <span class="number">32</span>)</span><br></pre></td></tr></tbody></table></figure>
<h4 id="HyperLogLog"><a href="#HyperLogLog" class="headerlink" title="HyperLogLog++"></a>HyperLogLog++</h4><h4 id="MinHash"><a href="#MinHash" class="headerlink" title="MinHash"></a>MinHash</h4><h4 id="HyperLogLog-amp-Inclusion-exculsion-principle"><a href="#HyperLogLog-amp-Inclusion-exculsion-principle" class="headerlink" title="HyperLogLog++ &amp; Inclusion-exculsion principle"></a>HyperLogLog++ &amp; Inclusion-exculsion principle</h4><h4 id="HyperLogLog-amp-MinHash"><a href="#HyperLogLog-amp-MinHash" class="headerlink" title="HyperLogLog++ &amp; MinHash"></a>HyperLogLog++ &amp; MinHash</h4><h3 id="参考-5"><a href="#参考-5" class="headerlink" title="参考"></a>参考</h3><h4 id="Blog"><a href="#Blog" class="headerlink" title="Blog"></a>Blog</h4><ul>
<li><a href="https://juejin.im/entry/59d2e6b46fb9a00a4c27370d">Bitmap 的原理和实现</a></li>
<li><a href="https://blog.csdn.net/yizishou/article/details/78365791">EWAHCompressedBitmap 数据结构及原理</a></li>
<li><a href="https://blog.csdn.net/yizishou/article/details/78342499">Roaring Bitmap 数据结构及原理</a></li>
<li><a href="https://www.pilosa.com/blog/range-encoded-bitmaps/">Using Bitmaps to Perform Range Queries</a></li>
<li><a href="https://colobu.com/2016/07/02/bloom-filter-for-scala/">JVM 上最快的 Bloom filter 实现</a></li>
<li><a href="http://arganzheng.life/bloom-filter-for-distributed-system.html">Bloom filter 在分布式环境中的应用</a></li>
<li><a href="http://shzhangji.com/cnblogs/2017/08/27/an-introduction-to-stream-lib-the-stream-processing-utilities/">实时计算工具库 stream-lib 使用指南</a></li>
<li><a href="http://blog.codinglabs.org/tag.html#HyperLogLogCounting">解读 Cardinality Estimation 算法</a></li>
<li><a href="https://research.neustar.biz/2012/10/25/sketch-of-the-day-hyperloglog-cornerstone-of-a-big-data-infrastructure/">Sketch of the Day：HyperLogLog — Cornerstone of a Big Data Infrastructure</a></li>
<li><a href="http://content.research.neustar.biz/blog/runs.html">Sketch of the Day：Probabilistic Counting with Stochastic Averaging（PCSA）</a></li>
<li><a href="https://blog.csdn.net/u011489043/article/details/78727128">分布式缓存 Redis 之 HyperLogLog</a></li>
<li><a href="https://soulmachine.gitbooks.io/system-design/content/cn/bigdata/heavy-hitters.html">Top K 频繁项</a></li>
</ul>
<h4 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h4><ul>
<li><a href="https://github.com/lemire/javaewah">A compressed alternative to the Java BitSet class</a></li>
<li><a href="https://github.com/RoaringBitmap/RoaringBitmap">RoaringBitmap：A better compressed bitset in Java</a></li>
<li><a href="https://datasketches.github.io/">Sketches Library from YAHOO</a></li>
<li><a href="https://github.com/addthis/stream-lib">Stream summarizer and cardinality estimator</a></li>
<li><a href="https://github.com/chaoslawful/ccard-lib#experiment">The following estimating results is calculated using bitmap with length of 2^16 (64k) bytes</a></li>
</ul>
<h2 id="数据库相关"><a href="#数据库相关" class="headerlink" title="数据库相关"></a>数据库相关</h2><h3 id="Binary-Search"><a href="#Binary-Search" class="headerlink" title="Binary Search"></a>Binary Search</h3><p>　二分查找（<strong>B</strong>inary <strong>S</strong>earch，也称折半搜索、对数搜索），是一种在有序数组中查找某一特定元素的搜索算法</p>
<p><img data-src="/picture/algorithm/algorithm_binary_search.png" alt="Binary Search"></p>
<center>（图片来源：<a href="https://zh.wikipedia.org/wiki/%E4%BA%8C%E5%88%86%E6%90%9C%E7%B4%A2%E7%AE%97%E6%B3%95#/media/File:Binary_search_into_array.png" target="_blank">wikipedia.org</a>，已确认无版权）</center>

<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">时间复杂度</th>
<th style="text-align:center">T(n) / S(n)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">平均</td>
<td style="text-align:center">$O(\log n)$</td>
</tr>
<tr>
<td style="text-align:center">最优</td>
<td style="text-align:center">$O(1)$</td>
</tr>
<tr>
<td style="text-align:center">最坏</td>
<td style="text-align:center">$O(\log n)$</td>
</tr>
<tr>
<td style="text-align:center">最坏</td>
<td style="text-align:center">迭代：$O(1)$；递归：$O(\log n)$（无<a href="https://yuzhouwan.com/posts/27328/#尾递归">尾调用</a>消除）</td>
</tr>
</tbody>
</table>
</div>
<h4 id="实战-6"><a href="#实战-6" class="headerlink" title="实战"></a>实战</h4><h5 id="median-of-two-sorted-arrays"><a href="#median-of-two-sorted-arrays" class="headerlink" title="median-of-two-sorted-arrays"></a><a href="https://leetcode.com/problems/median-of-two-sorted-arrays/">median-of-two-sorted-arrays</a></h5><div class="tabs" id="code4"><ul class="nav-tabs"><li class="tab active"><a href="#code4-1">CODE4 1</a></li></ul><div class="tab-content"><div class="tab-pane active" id="code4-1"><p><strong>Merge Sort 解</strong></p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">median_of_two_sorted_arrays</span>(<span class="params">nums1, nums2</span>):</span></span><br><span class="line">    nums = []</span><br><span class="line">    count1 = <span class="number">0</span></span><br><span class="line">    count2 = <span class="number">0</span></span><br><span class="line">    len1 = len(nums1)</span><br><span class="line">    len2 = len(nums2)</span><br><span class="line">    total_len = len1 + len2</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(total_len):</span><br><span class="line">        <span class="keyword">if</span> count1 == len1:</span><br><span class="line">            nums.extend(nums2[count2::])</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> count2 == len2:</span><br><span class="line">            nums.extend(nums1[count1::])</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        n1 = nums1[count1]</span><br><span class="line">        n2 = nums2[count2]</span><br><span class="line">        <span class="keyword">if</span> n1 &gt; n2:</span><br><span class="line">            nums.append(n2)</span><br><span class="line">            count2 += <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            nums.append(n1)</span><br><span class="line">            count1 += <span class="number">1</span></span><br><span class="line">    middle = total_len // <span class="number">2</span></span><br><span class="line">    <span class="keyword">if</span> total_len % <span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> (nums[middle - <span class="number">1</span>] + nums[middle]) / <span class="number">2</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> nums[middle]</span><br></pre></td></tr></tbody></table></figure></div></div></div>
<h3 id="二叉查找树"><a href="#二叉查找树" class="headerlink" title="二叉查找树"></a>二叉查找树</h3><h3 id="平衡二叉树"><a href="#平衡二叉树" class="headerlink" title="平衡二叉树"></a>平衡二叉树</h3><h3 id="AVL-树"><a href="#AVL-树" class="headerlink" title="AVL 树"></a>AVL 树</h3><h3 id="红黑树"><a href="#红黑树" class="headerlink" title="红黑树"></a>红黑树</h3><h3 id="B-树"><a href="#B-树" class="headerlink" title="B 树"></a>B 树</h3><h3 id="B-树-1"><a href="#B-树-1" class="headerlink" title="B+ 树"></a>B+ 树</h3><h4 id="参考-6"><a href="#参考-6" class="headerlink" title="参考"></a>参考</h4><ul>
<li><a href="https://www.zhihu.com/question/30527705">AVL 树，红黑树，B 树，B+ 树，Trie 树都分别应用在哪些现实场景中？</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/27700617">平衡二叉树、B 树、B+ 树、<code>B*</code> 树，理解其中一种你就都明白了</a></li>
<li><a href="https://blog.csdn.net/z702143700/article/details/49079107">二叉查找树、平衡二叉树、红黑树、B- / B+ 树 性能对比</a></li>
</ul>
<h3 id="SnapTreeMap"><a href="#SnapTreeMap" class="headerlink" title="SnapTreeMap"></a>SnapTreeMap</h3><h4 id="参考-7"><a href="#参考-7" class="headerlink" title="参考"></a>参考</h4><ul>
<li><a href="https://github.com/nbronson">nbronson</a> / <strong>snaptree</strong></li>
<li><a href="https://github.com/apache/druid/pull/6719">use SnapTreeMap instead of ConcurrentSkipListMap #6719</a></li>
<li><a href="https://www.datastax.com/dev/blog/cassandra-2-1-now-over-50-faster">Cassandra 2.1: now over 50% faster</a></li>
</ul>
<h3 id="LSM-tree"><a href="#LSM-tree" class="headerlink" title="LSM tree"></a>LSM tree</h3><h4 id="参考-8"><a href="#参考-8" class="headerlink" title="参考"></a>参考</h4><ul>
<li><a href="https://blog.csdn.net/Yaokai_AssultMaster/article/details/72877127">深入理解 HBase 的系统架构</a></li>
<li><a href="http://www.infoq.com/cn/articles/hbase-casestudy-facebook-messages">HBase 优化案例分析：Facebook Messages 系统问题与解决方案</a></li>
<li><a href="https://www.kancloud.cn/taobaomysql/monthly/67115">TokuDB 数据结构 Fractal-Trees 与 LSM-Trees 对比</a></li>
<li><a href="https://www.usenix.org/system/files/conference/fast16/fast16-papers-lu.pdf">WiscKey: Separating Keys from Values in SSD-conscious Storage</a></li>
<li><a href="http://kernelmaker.github.io/Btree_LSM_FTI">B+ Tree、LSM、Fractal tree index 读写放大分析</a></li>
</ul>
<h3 id="前缀树"><a href="#前缀树" class="headerlink" title="前缀树"></a>前缀树</h3><h4 id="Tire-Tree-Double-Array-Aho-Corasick"><a href="#Tire-Tree-Double-Array-Aho-Corasick" class="headerlink" title="Tire Tree + Double Array + Aho-Corasick"></a>Tire Tree + Double Array + Aho-Corasick</h4><h5 id="参考-9"><a href="#参考-9" class="headerlink" title="参考"></a>参考</h5><ul>
<li><a href="http://www.hankcs.com/program/java/tire-tree-participle.html">Trie 树分词</a></li>
<li><a href="http://www.hankcs.com/program/java/%e5%8f%8c%e6%95%b0%e7%bb%84trie%e6%a0%91doublearraytriejava%e5%ae%9e%e7%8e%b0.html">双数组 Trie 树（DoubleArrayTrie）Java 实现</a></li>
<li><a href="http://www.hankcs.com/program/algorithm/implementation-and-analysis-of-aho-corasick-algorithm-in-java.html">Aho-Corasick 算法的 Java 实现与分析</a></li>
<li><a href="http://www.hankcs.com/program/algorithm/aho-corasick-double-array-trie.html">Aho-Corasick 自动机结合 DoubleArrayTrie 极速多模式匹配</a></li>
</ul>
<h4 id="Patricia-Tree"><a href="#Patricia-Tree" class="headerlink" title="Patricia Tree"></a>Patricia Tree</h4><h4 id="SlimTire"><a href="#SlimTire" class="headerlink" title="SlimTire"></a>SlimTire</h4><h5 id="参考-10"><a href="#参考-10" class="headerlink" title="参考"></a>参考</h5><ul>
<li><a href="https://openacid.github.io/">SlimTrie: 单机百亿文件的极致索引</a></li>
<li><a href="https://github.com/openacid">openacid</a> / <strong><a href="https://github.com/openacid/slim">slim</a></strong></li>
<li>wikipedia: <a href="https://zh.wikipedia.org/wiki/User:Drmingdrmer/%E6%B2%99%E7%9B%92">SlimTrie</a></li>
</ul>
<h2 id="图论"><a href="#图论" class="headerlink" title="图论"></a>图论</h2><h3 id="图计算"><a href="#图计算" class="headerlink" title="图计算"></a>图计算</h3><h4 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h4><p>　<strong>图计算</strong>是以<strong>图论</strong>为基础的对现实世界的一种<strong>图</strong>结构的抽象表达，以及在这种数据结构上的计算模式。通常，在图计算中，基本的数据结构表达就是：</p>
<p>　$G = (V, E, D)$，其中，V = vertex（顶点或者节点），E = edge（边），D = data（权重）</p>
<p>　比如说：对于一个消费者的原始购买行为，有两类节点：用户和产品，边就是购买行为，权重是边上的一个数据结构，可以是购买次数和最后购买时间。对于许多我们面临的物理世界的数据问题，都可以利用图结构的来抽象表达：比如社交网络，网页链接关系，用户传播网络，用户网络点击、浏览和购买行为，甚至消费者评论内容，内容分类标签，产品分类标签等等</p>
<h2 id="加密"><a href="#加密" class="headerlink" title="加密"></a>加密</h2><h3 id="GPG"><a href="#GPG" class="headerlink" title="GPG"></a>GPG</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line">$ brew install gpg</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成</span></span><br><span class="line">$ <span class="built_in">export</span> GPG_TTY=$(tty)</span><br><span class="line">$ gpg --gen-key</span><br><span class="line">$ gpg --list-keys</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置</span></span><br><span class="line">$ git config --global user.signingkey xxx</span><br></pre></td></tr></tbody></table></figure>
<h2 id="压缩算法"><a href="#压缩算法" class="headerlink" title="压缩算法"></a>压缩算法</h2><h3 id="ZSTD"><a href="#ZSTD" class="headerlink" title="ZSTD"></a>ZSTD</h3><h4 id="参考-11"><a href="#参考-11" class="headerlink" title="参考"></a>参考</h4><ul>
<li><a href="https://facebook.github.io/zstd/">Zstandard is a real-time compression algorithm, providing high compression ratios</a></li>
</ul>
<h2 id="遗传算法"><a href="#遗传算法" class="headerlink" title="遗传算法"></a>遗传算法</h2><h3 id="参考-12"><a href="#参考-12" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.65.7300&amp;rep=rep1&amp;type=pdf">A Genetic Selection Algorithm for OLAP Data Cubes</a></li>
<li><a href="https://arxiv.org/abs/1602.04613">Towards reducing the multidimensionality of OLAP cubes using the Evolutionary Algorithms and Factor Analysis Methods</a></li>
</ul>
<h2 id="人工智能"><a href="#人工智能" class="headerlink" title="人工智能"></a>人工智能</h2><p>　详见，我的另一篇博客《<a href="https://yuzhouwan.com/posts/42737/">人工智能</a>》</p>
<h2 id="Index"><a href="#Index" class="headerlink" title="Index"></a>Index</h2><div class="table-container">
<table>
<thead>
<tr>
<th>序号</th>
<th>标题</th>
<th>分类</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://leetcode.com/problems/two-sum/">1</a></td>
<td><a href="https://yuzhouwan.com/posts/666/#two-sum">Two Sum</a></td>
<td><a href="https://yuzhouwan.com/posts/666/#Hash">Hash</a></td>
</tr>
<tr>
<td><a href="https://leetcode.com/problems/add-two-numbers/">2</a></td>
<td><a href="https://yuzhouwan.com/posts/666/#add-two-numbers">Add Two Numbers</a></td>
<td><a href="https://yuzhouwan.com/posts/666/#Linked-List">Linked List</a></td>
</tr>
<tr>
<td><a href="https://leetcode.com/problems/longest-substring-without-repeating-characters/">3</a></td>
<td><a href="https://yuzhouwan.com/posts/666/#longest-substring-without-repeating-characters">Longest Substring Without Repeating Characters</a></td>
<td><a href="https://yuzhouwan.com/posts/666/#Sliding-Window">Sliding Window</a></td>
</tr>
<tr>
<td><a href="https://leetcode.com/problems/median-of-two-sorted-arrays/">4</a></td>
<td><a href="https://yuzhouwan.com/posts/666/#median-of-two-sorted-arrays">Median of Two Sorted Arrays</a></td>
<td><a href="https://yuzhouwan.com/posts/666/#Binary-Search">Binary Search</a></td>
</tr>
<tr>
<td><a href="https://leetcode.com/problems/longest-palindromic-substring/">5</a></td>
<td><a href="https://yuzhouwan.com/posts/666/#longest-palindromic-substring">Longest Palindromic Substring</a></td>
<td><a href="https://yuzhouwan.com/posts/666/#Dynamic-Programming">Dynamic Programming</a></td>
</tr>
<tr>
<td><a href="https://leetcode.com/problems/zigzag-conversion/">6</a></td>
<td><a href="https://yuzhouwan.com/posts/666/#zigzag-conversion">ZigZag Conversion</a></td>
<td><a href="https://yuzhouwan.com/posts/666/#String-Matching">String</a></td>
</tr>
<tr>
<td><a href="https://leetcode.com/problems/reverse-integer/">7</a></td>
<td><a href="https://yuzhouwan.com/posts/666/#reverse-integer">Reverse Integer</a></td>
<td><a href="https://yuzhouwan.com/posts/4534/">Math</a></td>
</tr>
<tr>
<td><a href="https://leetcode.com/problems/string-to-integer-atoi/">8</a></td>
<td><a href="https://yuzhouwan.com/posts/666/#string-to-integer-atoi">String to Integer (atoi)</a></td>
<td><a href="https://yuzhouwan.com/posts/4534/">Math</a> &amp; <a href="https://yuzhouwan.com/posts/666/#String-Matching">String</a></td>
</tr>
<tr>
<td><a href="https://leetcode.com/problems/palindrome-number/">9</a></td>
<td><a href="https://yuzhouwan.com/posts/666/#palindrome-number">Palindrome Number</a></td>
<td><a href="https://yuzhouwan.com/posts/4534/">Math</a></td>
</tr>
<tr>
<td><a href="https://leetcode.com/problems/regular-expression-matching/">10</a></td>
<td><a href="https://yuzhouwan.com/posts/666/#regular-expression-matching">Regular Expression Matching</a></td>
<td><a href="https://yuzhouwan.com/posts/666/#String-Matching">String</a> &amp; <a href="https://yuzhouwan.com/posts/666/#Dynamic-Programming">Dynamic Programming</a> &amp; Backtracking</td>
</tr>
<tr>
<td><a href="https://leetcode.com/problems/container-with-most-water/">11</a></td>
<td>Container With Most Water</td>
<td>Array &amp; Two Pointers</td>
</tr>
<tr>
<td><a href="https://leetcode.com/problems/integer-to-roman/">12</a></td>
<td>Integer to Roman</td>
<td><a href="https://yuzhouwan.com/posts/4534/">Math</a> &amp; <a href="https://yuzhouwan.com/posts/666/#String-Matching">String</a></td>
</tr>
<tr>
<td><a href="https://leetcode.com/problems/roman-to-integer/">13</a></td>
<td><a href="https://yuzhouwan.com/posts/666/#roman-to-integer">Roman to Integer</a></td>
<td><a href="https://yuzhouwan.com/posts/4534/">Math</a> &amp; <a href="https://yuzhouwan.com/posts/666/#String-Matching">String</a></td>
</tr>
<tr>
<td><a href="https://leetcode.com/problems/longest-common-prefix/">14</a></td>
<td>Longest Common Prefix</td>
<td><a href="https://yuzhouwan.com/posts/666/#String-Matching">String</a></td>
</tr>
<tr>
<td><a href="https://leetcode.com/problems/3sum/">15</a></td>
<td><a href="https://yuzhouwan.com/posts/666/#3sum">3Sum</a></td>
<td>Array &amp; Two Pointers</td>
</tr>
<tr>
<td><a href="https://leetcode.com/problems/3sum-closest/">16</a></td>
<td>3Sum Closest</td>
<td>Array &amp; Two Pointers</td>
</tr>
<tr>
<td><a href="https://leetcode.com/problems/letter-combinations-of-a-phone-number/">17</a></td>
<td><a href="https://yuzhouwan.com/posts/666/#letter-combinations-of-a-phone-number">Letter Combinations of a Phone Number</a></td>
<td><a href="https://yuzhouwan.com/posts/666/#String-Matching">String</a> &amp; Backtracking</td>
</tr>
<tr>
<td><a href="https://leetcode.com/problems/4sum">18</a></td>
<td>4Sum</td>
<td>Array &amp; <a href="https://yuzhouwan.com/posts/666/#Hash">Hash Table</a> &amp; Two Pointers</td>
</tr>
<tr>
<td><a href="https://leetcode.com/problems/remove-nth-node-from-end-of-list/">19</a></td>
<td><a href="https://yuzhouwan.com/posts/666/#remove-nth-node-from-end-of-list">Remove Nth Node From End of List</a></td>
<td><a href="https://yuzhouwan.com/posts/666/#Linked-List">Linked List</a> &amp; Two Pointers</td>
</tr>
<tr>
<td><a href="https://leetcode.com/problems/valid-parentheses/">20</a></td>
<td><a href="https://yuzhouwan.com/posts/666/#valid-parentheses">Valid Parentheses</a></td>
<td><a href="https://yuzhouwan.com/posts/666/#String-Matching">String</a> &amp; Stack</td>
</tr>
<tr>
<td><a href="https://leetcode.com/problems/merge-two-sorted-lists/">21</a></td>
<td><a href="https://yuzhouwan.com/posts/666/#merge-two-sorted-lists">Merge Two Sorted Lists</a></td>
<td><a href="https://yuzhouwan.com/posts/666/#Linked-List">Linked List</a></td>
</tr>
<tr>
<td><a href="https://leetcode.com/problems/generate-parentheses/">22</a></td>
<td><a href="https://yuzhouwan.com/posts/666/#generate-parentheses">Generate Parentheses</a></td>
<td><a href="https://yuzhouwan.com/posts/666/#String-Matching">String</a> &amp; <a href="https://yuzhouwan.com/posts/666/#Dynamic-Programming">Dynamic Programming</a> &amp; Backtracking</td>
</tr>
</tbody>
</table>
</div>
<h2 id="资源"><a href="#资源" class="headerlink" title="资源"></a>资源</h2><h3 id="Blog-1"><a href="#Blog-1" class="headerlink" title="Blog"></a>Blog</h3><ul>
<li><a href="http://codecapsule.com/2012/01/18/how-to-implement-a-paper/">How to implement an algorithm from a scientific paper</a></li>
</ul>
<h3 id="Book-1"><a href="#Book-1" class="headerlink" title="Book"></a>Book</h3><ul>
<li><a href="http://interactivepython.org/courselib/static/pythonds/index.html">Problem Solving with Algorithms and Data Structures using Python</a></li>
<li><a href="https://www.amazon.com/Structures-Algorithms-Undergraduate-Computer-Science/dp/3319130714">Data Structures and Algorithms with Python</a></li>
<li><a href="https://www.amazon.com/Structures-Algorithms-Python-Michael-Goodrich/dp/812656217X">Data Structures and Algorithms in Python</a></li>
<li><a href="https://github.com/tianyicui/pack">背包九讲</a></li>
</ul>
<h3 id="Paper"><a href="#Paper" class="headerlink" title="Paper"></a>Paper</h3><ul>
<li><a href="https://paperswithcode.com/sota">Paper with Code</a></li>
</ul>
<h3 id="Github-1"><a href="#Github-1" class="headerlink" title="Github"></a>Github</h3><ul>
<li><a href="https://github.com/MisterBooo/LeetCodeAnimation">用动画的形式呈现解 LeetCode 题目的思路</a></li>
</ul>
<h3 id="Tool"><a href="#Tool" class="headerlink" title="Tool"></a>Tool</h3><ul>
<li><a href="https://plugins.jetbrains.com/plugin/12132-leetcode-editor">在 IDEA 编辑器中安装 LeetCode 刷题插件</a></li>
</ul>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt=""></a></td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>算法</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Algorithm</tag>
        <tag>Git</tag>
        <tag>Python</tag>
        <tag>LeetCode</tag>
      </tags>
  </entry>
  <entry>
    <title>Apache Eagle 深度调研</title>
    <url>/posts/39683/</url>
    <content><![CDATA[<h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><p>　<a href="https://yuzhouwan.com/posts/39683/">Apache Eagle</a> 是一个<code>高度可扩展</code>的监控警报平台，采用了<code>设计灵活</code>的应用框架和<code>经过实践考验</code>的大数据技术，如 <a href="https://yuzhouwan.com/posts/26002/">Kafka</a>，<a href="https://yuzhouwan.com/posts/4735/">Spark</a> 和 <a href="https://yuzhouwan.com/posts/13977/">Storm</a>。它提供了丰富的大数据平台监控程序，例如 <a href="https://yuzhouwan.com/posts/60504/">HDFS</a> / <a href="https://yuzhouwan.com/posts/45888/">HBase</a> / YARN 服务<code>运行状况检查</code>，<code>JMX 指标</code>，<code>守护进程日志</code>，<code>审核日志</code> 和 <code>Yarn</code> 应用程序。外部 Eagle 开发人员可以<code>自定义应用</code>来监视其 NoSQL 数据库或 Web 服务器，可以自己决定是否共享到 <code>Eagle 应用程序存储库</code>。它还提供最先进的<code>警报引擎</code>来报告<code>安全漏洞</code>，<code>服务故障</code>和<code>应用程序异常</code>，由警报策略定义<code>高度可定制</code>。</p>
<h3 id="Site"><a href="#Site" class="headerlink" title="Site"></a>Site</h3><p>　管理一组<code>应用程序</code>实例，用来区别某些被多次安装的应用程序</p>
<h3 id="Application"><a href="#Application" class="headerlink" title="Application"></a>Application</h3><p>　应用程序（或监控应用程序）是 Apache Eagle 中的一级公民，它代表<code>端到端</code>的<code>监控</code> / <code>警报</code>解决方案，通常包含<code>监控源</code>入站，源的 <code>schema</code>规范，<code>警报策略</code>和 <code>仪表板定义</code></p>
<h3 id="Stream"><a href="#Stream" class="headerlink" title="Stream"></a>Stream</h3><p>　Stream 是 Alert Engine 的输入，每个<code>应用程序</code>应该有自己的由开发人员定义的流。通常，流定义里面包含了一个类似 <code>POJO</code> 的结构。一旦定义完成，<code>应用程序</code>就有了将数据写入<code>Kafka</code> 的逻辑</p>
<a id="more"></a>
<h3 id="Data-Activity-Monitoring"><a href="#Data-Activity-Monitoring" class="headerlink" title="Data Activity Monitoring"></a>Data Activity Monitoring</h3><p>　内置监控应用程序，用于监控 <code>HDFS</code> / <code>HBase</code> / <code>Hive</code> 操作，并允许用户定义某些策略来实时检测<code>敏感数据访问</code>和<code>恶意数据操作</code></p>
<h3 id="Alert-Engine"><a href="#Alert-Engine" class="headerlink" title="Alert Engine"></a>Alert Engine</h3><p>　被所有其他<code>监控应用程序</code>所共享的特定<code>内置</code>应用程序，它从 Kafka 读取数据，并通过<code>实时应用策略</code>来处理数据，并<code>生成报警通知</code></p>
<h3 id="Policy"><a href="#Policy" class="headerlink" title="Policy"></a>Policy</h3><p>　Alert Engine 使用<code>规则</code>来匹配 Kafka 的数据输入（策略以 <a href="https://github.com/wso2/siddhi">SiddhiQL</a> 格式定义）</p>
<h3 id="Alert"><a href="#Alert" class="headerlink" title="Alert"></a>Alert</h3><p>　如果输入到 <code>Alert Engine</code> 的任何数据符合该策略，则 Alert Engine 将生成一条消息并通过<code>警报发布者（Alert Publisher）</code>进行发布。这些消息我们称之为警报</p>
<h3 id="Alert-Publisher"><a href="#Alert-Publisher" class="headerlink" title="Alert Publisher"></a>Alert Publisher</h3><p>　它会将<code>警报</code>发布到可以是 <code>SMTP 通道</code>、<code>Kafka 通道</code>、<code>Slack 通道</code>或 其他<code>存储系统的外部通道</code></p>
<h2 id="核心架构"><a href="#核心架构" class="headerlink" title="核心架构"></a>核心架构</h2><h3 id="概况"><a href="#概况" class="headerlink" title="概况"></a>概况</h3><p><img data-src="/picture/eagle/apache_eagle_eagle_overview.png" alt=""></p>
<h3 id="架构"><a href="#架构" class="headerlink" title="架构"></a><a href="https://eagle.apache.org/docs/latest/underlying-design/">架构</a></h3><p><img data-src="/picture/eagle/apache_eagle_architecture.png" alt=""></p>
<h3 id="告警"><a href="#告警" class="headerlink" title="告警"></a>告警</h3><p><img data-src="/picture/eagle/apache_eagle_alert_engine.png" alt=""></p>
<h3 id="存储"><a href="#存储" class="headerlink" title="存储"></a>存储</h3><p><img data-src="/picture/eagle/apache_eagle_storage_engine.png" alt=""></p>
<h2 id="主要功能"><a href="#主要功能" class="headerlink" title="主要功能"></a>主要功能</h2><h3 id="数据流接入和存储"><a href="#数据流接入和存储" class="headerlink" title="数据流接入和存储"></a>数据流接入和存储</h3><h4 id="Metrics-存储"><a href="#Metrics-存储" class="headerlink" title="Metrics 存储"></a>Metrics 存储</h4><ul>
<li>Eagle 为 HBase / RDMBS 提供了轻量级的 <code>ORM 框架</code>，支持使用 Java 注释便于定义<code>持久化数据模型</code></li>
<li>Eagle 在 NoSQL Model 上提供类似 SQL 的 REST 查询语言（List / Aggregation / Bucket / Rowkey / Rowkey  Query、Pagination、Sorting、Union、Join）</li>
<li>针对<code>时间序列数据</code>优化的 <a href="https://eagle.apache.org/docs/latest/underlying-design/#hbase-rowkey-design">Rowkey 设计</a>，针对<code>度量</code>/<code>实体</code>/<code>日志</code>等进行了优化，不同的存储类型</li>
</ul>
<h3 id="数据实时处理"><a href="#数据实时处理" class="headerlink" title="数据实时处理"></a>数据实时处理</h3><h4 id="流处理-API"><a href="#流处理-API" class="headerlink" title="流处理 API"></a>流处理 API</h4><p>　Eagle Alert Engine 是基于开源实时流处理框架的，如 Apache Storm 作为默认执行引擎，Apache Kafka 作为默认的<code>消息总线（Messaging Bus）</code></p>
<h4 id="告警框架"><a href="#告警框架" class="headerlink" title="告警框架"></a>告警框架</h4><ul>
<li>可伸缩的 Eagle 策略执行框架</li>
</ul>
<p>　　机器学习模块</p>
<ul>
<li>用户 Profile 离线训练以及异常监测架构</li>
</ul>
<p>　　核密度估计算法（Kernel Density Estimation）</p>
<ul>
<li>单一维度上用户行为直方图</li>
</ul>
<p>　　特征值分解算法（Eigen-Value Decomposition）</p>
<ul>
<li>展示重要的用户行为模式成分</li>
</ul>
<h3 id="Eagle-服务"><a href="#Eagle-服务" class="headerlink" title="Eagle 服务"></a>Eagle 服务</h3><h4 id="策略管理器"><a href="#策略管理器" class="headerlink" title="策略管理器"></a>策略管理器</h4><p>　Eagle 策略管理器 提供<code>交互友好的用户界面</code>和 <a href="https://eagle.apache.org/docs/latest/reference/#rest-apis">REST API</a> 供用户轻松地定义和管理策略<br>　Eagle 的用户界面 使得<code>策略的管理</code>、<code>敏感元数据的标识和导入</code>、<code>HDFS 或 Hive 的资源浏览</code>以及<code>预警仪表</code>等功能<br>　Eagle 策略引擎 默认支持 <code>WSO2 的 Siddhi CEP 引擎</code>和 <code>机器学习引擎</code>，以下是几个基于 <code>Siddi CEP</code> 的策略示例</p>
<h4 id="查询服务"><a href="#查询服务" class="headerlink" title="查询服务"></a>查询服务</h4><h5 id="单一事件执行策略（用户访问-Hive-中的敏感数据列）"><a href="#单一事件执行策略（用户访问-Hive-中的敏感数据列）" class="headerlink" title="单一事件执行策略（用户访问 Hive 中的敏感数据列）"></a>单一事件执行策略（用户访问 Hive 中的敏感数据列）</h5><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">from hiveAccessLogStream[sensitivityType=='PHONE_NUMBER'] <span class="keyword">select</span> * <span class="keyword">insert</span> <span class="keyword">into</span> outputStream;</span><br></pre></td></tr></tbody></table></figure>
<h5 id="基于窗口的策略（用户在-10-分钟内访问目录-tmp-private-多于-inverted-5-次）"><a href="#基于窗口的策略（用户在-10-分钟内访问目录-tmp-private-多于-inverted-5-次）" class="headerlink" title="基于窗口的策略（用户在 10 分钟内访问目录 /tmp/private 多于 inverted 5 次）"></a>基于窗口的策略（用户在 10 分钟内访问目录 /tmp/private 多于 inverted 5 次）</h5><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">hdfsAuditLogEventStream[(src == '/tmp/private')]<span class="comment">#window.externalTime(timestamp,10 min) select user, count(timestamp) as aggValue group by user having aggValue &gt;= 5 insert into outputStream;</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h2><h3 id="数据活动监控"><a href="#数据活动监控" class="headerlink" title="数据活动监控"></a>数据活动监控</h3><p>　分析数据活动和提醒不安全访问是保护企业数据的基本要求。随着 Hadoop、Hive、Spark 技术的数据量<code>呈指数级增长</code>，了解<code>每个用户的数据活动</code>变得非常困难，更不用说每天在 <code>PB 级的数据流</code>中，<code>实时</code>地警告单个恶意事件<br>　保护企业数据从了解每个用户的数据活动开始。 Apache Eagle 已与许多流行的大数据平台集成，例如 Hadoop、Hive、Spark、Cassandra 等。Eagle 用户可以浏览<code>数据层次结构</code>，标记<code>敏感数据</code>，然后制定<code>全面的策略</code>，告警不安全的数据访问</p>
<h3 id="任务性能分析"><a href="#任务性能分析" class="headerlink" title="任务性能分析"></a>任务性能分析</h3><p>　运行 <code>MapReduce</code> 任务是人们用来分析 Hadoop 系统中数据的最流行的方式。分析<code>任务的性能</code>和<code>提供调优建议</code>对于 <code>Hadoop 系统稳定性</code>、<code>作业 SLA</code> 和 <code>资源使用情况</code>至关重要<br>　Eagle 通过两种方法来分析 <code>Job 的性能</code>。 首先，Eagle 定期用 <code>Yarn API</code> 为所有正在运行的作业<code>拍摄快照</code>；其次，Eagle 在作业完成后立即读取<code>作业生命周期事件</code>。通过这两种方法，Eagle 可以分析<code>单个 Job 的趋势</code>，<code>数据倾斜问题</code>，<code>失败原因</code>等。更进一步地，Eagle 可以通过考虑所有工作来分析整个 Hadoop 集群的性能</p>
<h3 id="集群性能分析"><a href="#集群性能分析" class="headerlink" title="集群性能分析"></a>集群性能分析</h3><p>　了解<code>为什么集群性能会下降</code>是至关重要的。那是因为最近一些<code>不正常的工作</code>被提交，还是存在大量的小文件，还是 <code>NameNode</code> 的性能降级了？<br>　Eagle 实时计算单个作业中每分钟的资源使用量，例如 CPU、内存、HDFS IO 字节、HDFS IO numOps 等，还可以收集 NameNode JMX 指标。将它们相关在一起，将有效地帮助系统管理员，找到集群缓慢的根本原因</p>
<h3 id="Ebay（2015）"><a href="#Ebay（2015）" class="headerlink" title="Ebay（2015）"></a>Ebay（2015）</h3><ul>
<li>Eagle 的数据行为监控系统已经部署到一个拥有 10000 多个节点的 Hadoop 集群之上，用以保护数百 PB 数据的安全</li>
<li>已针对 HDFS、Hive 等集群中的数据<code>内置了一些基础的安全策略</code>，并将不断引入更多的策略，以确保重要数据的绝对安全</li>
<li>Eagle 的策略涵盖多种模式，包括从访问模式、频繁访问数据集，预定义查询类型、Hive 表和列、HBase 表，以及基于机器学习模型生成的<code>用户 Profile</code> 相关的所有策略等</li>
<li>有广泛的策略来防止<code>数据的丢失</code>、数据被<code>拷贝到不安全地点</code>、<code>敏感数据被未授权区域访问</code>等</li>
<li>Eagle 策略定义上极大的<code>灵活性</code>和<code>扩展性</code>，使得未来可以轻易地继续扩展更多更复杂的策略，以支持更多<code>多元化</code>的用例场景</li>
</ul>
<h2 id="优缺点"><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h2><h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><h4 id="高拓展性"><a href="#高拓展性" class="headerlink" title="高拓展性"></a>高拓展性</h4><p>　Apache Eagle 围绕 <code>application</code> 概念构建了其核心框架，<code>application</code> 本身包括用于<code>监视源数据收集</code>，<code>预处理</code>和<code>归一化</code>的逻辑。开发人员可以使用 Eagle 的应用程序框架轻松开发自己的<code>开箱（out-of-box）</code>监控应用程序，并部署到 Eagle 中</p>
<h4 id="可伸缩"><a href="#可伸缩" class="headerlink" title="可伸缩"></a>可伸缩</h4><p>　Eagle 核心团队选择了<code>经过考验的大数据技术</code>来构建其基本运行时，并应用可扩展内核，根据<code>数据流的吞吐量</code>以及<code>受监控应用程序的数量</code>进行自适应</p>
<h4 id="实时性"><a href="#实时性" class="headerlink" title="实时性"></a>实时性</h4><p>　基于 <code>Storm</code> 或 <code>Spark Streaming</code> 的计算引擎使我们能够将<code>策略</code>应用于<code>数据流</code>，并实时生成警报。确保能在<code>亚秒级别</code>的时间内产生告警，一旦综合多种因素确定为危险操作，立即采取措施进行阻止</p>
<h4 id="动态配置"><a href="#动态配置" class="headerlink" title="动态配置"></a>动态配置</h4><p>　用户可以自由<code>启用</code>或<code>禁用</code>监控应用程序，而无需重新启动服务。还可以动态<code>添加</code>/<code>删除</code>/<code>更改</code>其警报策略，而不会对底层运行时造成任何影响</p>
<h4 id="简单易用"><a href="#简单易用" class="headerlink" title="简单易用"></a>简单易用</h4><p>　用户可以通过选择相应的<code>监控应用程序</code>并为服务配置<code>少量</code>参数，在几分钟内实现对服务的监控</p>
<h4 id="无侵入性"><a href="#无侵入性" class="headerlink" title="无侵入性"></a>无侵入性</h4><p>　Apache Eagle 使用<code>开箱即用（out-of-box）</code>的应用程序来监控服务，不需要对现有服务进行任何更改</p>
<h4 id="用户Profile"><a href="#用户Profile" class="headerlink" title="用户Profile"></a>用户Profile</h4><p>　Eagle 内置提供基于<code>机器学习算法</code>，对监控平台中的用户行为习惯建立<code>用户 Profile</code>，实现实时地用户行为告警</p>
<h4 id="开源"><a href="#开源" class="headerlink" title="开源"></a>开源</h4><p>　Apache Eagle 一直都是根据开源的标准来进行开发的</p>
<h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><h4 id="目前流行度较差"><a href="#目前流行度较差" class="headerlink" title="目前流行度较差"></a>目前流行度较差</h4><div class="table-container">
<table>
<thead>
<tr>
<th>Watch</th>
<th>Star</th>
<th>Fork</th>
<th>Commit</th>
<th>Contributors</th>
<th>Current Date</th>
</tr>
</thead>
<tbody>
<tr>
<td>53</td>
<td>291</td>
<td>158</td>
<td>1047</td>
<td>27</td>
<td>2018-6-1</td>
</tr>
</tbody>
</table>
</div>
<h4 id="稳定性略不足"><a href="#稳定性略不足" class="headerlink" title="稳定性略不足"></a>稳定性略不足</h4><p>　最新 release 版本为 <code>eagle-0.5.0</code>，刚从 <code>0.4.0-incubating</code> 版本中孵化出来</p>
<p>　单元测试覆盖率过低：<strong>39%</strong></p>
<p>　另外，CI 系统方面，目前只有 <code>Jenkins</code> 在用，而 <code>Travis</code> 并未真实在用，在 fork 的私有分支下开启后，发现每次 build 过程需要一小时之久</p>
<h4 id="代码质量相对较差"><a href="#代码质量相对较差" class="headerlink" title="代码质量相对较差"></a>代码质量相对较差</h4><p>　由于 <code>check-in</code> 系统的不完善，没有对 代码质量、代码风格、测试覆盖率 等方面进行考量（Apache Eagle 暂定在 <a href="https://cwiki.apache.org/confluence/display/EAG/Eagle+Version+0.5.0">v0.5.0</a> 之后进行完善）</p>
<h2 id="对-HBase-的支持度"><a href="#对-HBase-的支持度" class="headerlink" title="对 HBase 的支持度"></a>对 HBase 的支持度</h2><h3 id="比对表"><a href="#比对表" class="headerlink" title="比对表"></a>比对表</h3><div class="table-container">
<table>
<thead>
<tr>
<th>Version</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>v0.4.0</td>
<td>只支持 用户行为分析</td>
</tr>
<tr>
<td><a href="https://cwiki.apache.org/confluence/display/EAG/Eagle+Version+0.5.0">v0.5.0</a></td>
<td>开始支持 JMX（Metric 不支持）、Add HBase master metric dashboard、Add HBase RegionServer metric dashboard、Integrate hbase metric to basic panel 等功能</td>
</tr>
</tbody>
</table>
</div>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://issues.apache.org/jira/browse/EAGLE-866">Refactor HBase JMX Metric with appropriate navigation path</a></li>
<li><a href="https://issues.apache.org/jira/browse/EAGLE-845">HBase JMX Monitoring Dashboard</a></li>
<li><a href="https://issues.apache.org/jira/browse/EAGLE-651">HBase JMX Metric Monitoring Application</a></li>
</ul>
<h2 id="Eagle-环境搭建"><a href="#Eagle-环境搭建" class="headerlink" title="Eagle 环境搭建"></a>Eagle 环境搭建</h2><h3 id="组件"><a href="#组件" class="headerlink" title="组件"></a>组件</h3><h4 id="流式平台依赖"><a href="#流式平台依赖" class="headerlink" title="流式平台依赖"></a>流式平台依赖</h4><div class="table-container">
<table>
<thead>
<tr>
<th>Name</th>
<th>Version</th>
<th style="text-align:center">Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>Storm</td>
<td>0.9.3 or later</td>
<td style="text-align:center">0.9.7</td>
</tr>
<tr>
<td>Kafka</td>
<td>0.8.x or later</td>
<td style="text-align:center">kafka_2.11-0.10.1.1</td>
</tr>
<tr>
<td>Java</td>
<td>1.7.x</td>
<td style="text-align:center">jdk-1.7.0_80（v0.4 不支持 JDK1.8）</td>
</tr>
<tr>
<td>NPM</td>
<td>3.x</td>
<td style="text-align:center">3.10.10（On MAC OS try <code>brew install node</code>）</td>
</tr>
<tr>
<td>LogStash</td>
<td>2.3.4</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td>Maven</td>
<td>3.3.9</td>
</tr>
</tbody>
</table>
</div>
<h4 id="数据库依赖（Choose-one-of-them）"><a href="#数据库依赖（Choose-one-of-them）" class="headerlink" title="数据库依赖（Choose one of them）"></a>数据库依赖（Choose one of them）</h4><div class="table-container">
<table>
<thead>
<tr>
<th>Name</th>
<th>Version</th>
<th style="text-align:center">Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>HBase</td>
<td>0.98 or later</td>
<td style="text-align:center">2.7.3 （Hadoop 2.6.x is required）</td>
</tr>
<tr>
<td>MySQL</td>
<td></td>
<td style="text-align:center">5.5.18（Eagle v0.4 建议使用 MySQL）</td>
</tr>
<tr>
<td>Derby</td>
<td></td>
</tr>
</tbody>
</table>
</div>
<h4 id="沙箱"><a href="#沙箱" class="headerlink" title="沙箱"></a>沙箱</h4><div class="table-container">
<table>
<thead>
<tr>
<th>Name</th>
<th>Version</th>
<th style="text-align:center">Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>Hortonworks Sandbox</td>
<td>2.2.4</td>
</tr>
</tbody>
</table>
</div>
<h3 id="基础环境"><a href="#基础环境" class="headerlink" title="基础环境"></a>基础环境</h3><h4 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h4><h5 id="用户"><a href="#用户" class="headerlink" title="用户"></a>用户</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 增加用户，并赋予其密码</span></span><br><span class="line">$ adduser eagle</span><br><span class="line">$ passwd eagle            <span class="comment"># ur password for eagle user</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 赋予用户可以 sudo 的权限</span></span><br><span class="line">$ chmod u+w /etc/sudoers</span><br><span class="line">$ vim /etc/sudoers</span><br><span class="line">  <span class="comment"># 找到 `root ALL=(ALL) ALL` 这行，并在下面添加 eagle 用户</span></span><br><span class="line">  eagle    ALL=(ALL)    ALL</span><br><span class="line">$ chmod u-w /etc/sudoers</span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换到 eagle 用户</span></span><br><span class="line">$ su - eagle</span><br></pre></td></tr></tbody></table></figure>
<h5 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/eagle</span><br><span class="line"></span><br><span class="line"><span class="comment"># 存放软件目录 &amp; 安装目录 &amp; 日志目录</span></span><br><span class="line">$ mkdir install &amp;&amp; mkdir software &amp;&amp; mkdir logs</span><br></pre></td></tr></tbody></table></figure>
<h4 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h4><h5 id="JDK"><a href="#JDK" class="headerlink" title="JDK"></a>JDK</h5><p>Download from <a href="http://download.oracle.com/otn/java/jdk/7u80-b15/jdk-7u80-linux-x64.rpm">jdk-7u80-linux-x64.rpm</a><br>（现在需要注册登录 Oracle 账户才可下载）</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ chmod +x install/jdk-7u80-linux-x64.rpm</span><br><span class="line">$ sudo rpm -ivh install/jdk-7u80-linux-x64.rpm</span><br><span class="line">$ java -version</span><br><span class="line">  java version <span class="string">"1.7.0_80"</span></span><br><span class="line">  Java(TM) SE Runtime Environment (build 1.7.0_80-b15)</span><br><span class="line">  Java HotSpot(TM) 64-Bit Server VM (build 24.80-b11, mixed mode)</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">which</span> java</span><br><span class="line">  /usr/bin/java</span><br><span class="line"></span><br><span class="line">$ ln -s /usr/java/jdk1.7.0_80 software/jdk1.7.0_80</span><br><span class="line">$ ln -s /home/eagle/software/jdk1.7.0_80 software/java</span><br><span class="line">$ vim ~/.bash_profile</span><br><span class="line">  <span class="comment"># User specific environment and startup programs</span></span><br><span class="line">  JAVA_HOME=/home/eagle/software/java</span><br><span class="line">  CLASSPATH=.:<span class="variable">$JAVA_HOME</span>/lib/tools.jar</span><br><span class="line">  PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$PATH</span></span><br><span class="line">  <span class="built_in">export</span> JAVA_HOME CLASSPATH PATH</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">source</span> ~/.bash_profile</span><br></pre></td></tr></tbody></table></figure>
<p>　如果需要清除之前的低版本 JDK，或者重装，可以参照（没有这个需求，可跳过）<br></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ rpm -qa | grep -E <span class="string">'jdk|java'</span></span><br><span class="line">  jdk-1.7.0_80-fcs.x86_64</span><br><span class="line"></span><br><span class="line">$ sudo rpm -e --nodeps jdk-1.7.0_80-fcs.x86_64</span><br></pre></td></tr></tbody></table></figure><p></p>
<h5 id="Hadoop"><a href="#Hadoop" class="headerlink" title="Hadoop"></a>Hadoop</h5><h6 id="依赖-1"><a href="#依赖-1" class="headerlink" title="依赖"></a>依赖</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># ssh</span></span><br><span class="line">$ sudo yum install openssh-clients openssh-server -y</span><br><span class="line">$ ssh localhost</span><br><span class="line">$ <span class="built_in">exit</span></span><br><span class="line">$ <span class="built_in">cd</span> ~/.ssh/</span><br><span class="line">$ ssh-keygen -t rsa</span><br><span class="line">$ cat id_rsa.pub &gt;&gt; authorized_keys</span><br><span class="line">$ chmod 600 ./authorized_keys</span><br></pre></td></tr></tbody></table></figure>
<h6 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 下载安装包</span></span><br><span class="line">$ <span class="built_in">cd</span> /home/eagle/install/</span><br><span class="line">$ wget http://mirror.bit.edu.cn/apache/hadoop/common/hadoop-2.7.3/hadoop-2.7.3.tar.gz</span><br><span class="line">$ wget http://mirror.bit.edu.cn/apache/hadoop/common/hadoop-2.7.3/hadoop-2.7.3.tar.gz.mds</span><br><span class="line">$ head -n 6 hadoop-2.7.3.tar.gz.mds</span><br><span class="line">  hadoop-2.7.3.tar.gz:    MD5 = 34 55 BB 57 E4 B4 90 6B  BE A6 7B 58 CC A7 8F A8</span><br><span class="line">  hadoop-2.7.3.tar.gz:   SHA1 = B84B 8989 3426 9C68 753E  4E03 6D21 395E 5A4A B5B1</span><br><span class="line">  hadoop-2.7.3.tar.gz: RMD160 = 8FE4 A91E 8C67 2A33 C4E9  61FB 607A DBBD 1AE5 E03A</span><br><span class="line">  hadoop-2.7.3.tar.gz: SHA224 = 23AB1EAB B7648921 7101671C DCF9D774 7B84AD50</span><br><span class="line">                                6A74E300 AE6617FA</span><br><span class="line">  hadoop-2.7.3.tar.gz: SHA256 = D489DF38 08244B90 6EB38F4D 081BA49E 50C4603D</span><br><span class="line">$ md5sum hadoop-2.7.3.tar.gz | tr <span class="string">"a-z"</span> <span class="string">"A-Z"</span></span><br><span class="line">  3455BB57E4B4906BBEA67B58CCA78FA8  HADOOP-2.7.3.TAR.GZ</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对比 MD5 码一致后进行解压安装</span></span><br><span class="line">$ tar zxvf hadoop-2.7.3.tar.gz -C ~/software/</span><br><span class="line">$ <span class="built_in">cd</span> ~/software/</span><br><span class="line">$ ln -s hadoop-2.7.3/ hadoop</span><br><span class="line">$ <span class="built_in">cd</span> hadoop/</span><br><span class="line">$ bin/hadoop version</span><br><span class="line">  Hadoop 2.7.3</span><br><span class="line"><span class="comment"># Trouble Shooting</span></span><br><span class="line">$ mkdir -p ~/input</span><br><span class="line">$ rm -r ~/output</span><br><span class="line">$ cp etc/hadoop/*.xml ~/input</span><br><span class="line">$ bin/hadoop jar share/hadoop/mapreduce/hadoop-mapreduce-examples-2.7.3.jar grep ~/input ~/output <span class="string">'dfs[a-z.]+'</span></span><br><span class="line">$ cat  ~/output/*</span><br><span class="line">  1	dfsadmin</span><br></pre></td></tr></tbody></table></figure>
<h6 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim ~/.bashrc</span><br><span class="line">  <span class="comment"># .bashrc</span></span><br><span class="line">  <span class="comment"># Source global definitions</span></span><br><span class="line">  <span class="keyword">if</span> [ -f /etc/bashrc ]; <span class="keyword">then</span></span><br><span class="line">          . /etc/bashrc</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="comment"># User specific aliases and functions</span></span><br><span class="line">  <span class="comment"># Hadoop Environment Variables</span></span><br><span class="line">  <span class="built_in">export</span> HADOOP_HOME=~/software/hadoop</span><br><span class="line">  <span class="built_in">export</span> HADOOP_INSTALL=<span class="variable">$HADOOP_HOME</span></span><br><span class="line">  <span class="built_in">export</span> HADOOP_MAPRED_HOME=<span class="variable">$HADOOP_HOME</span></span><br><span class="line">  <span class="built_in">export</span> HADOOP_COMMON_HOME=<span class="variable">$HADOOP_HOME</span></span><br><span class="line">  <span class="built_in">export</span> HADOOP_HDFS_HOME=<span class="variable">$HADOOP_HOME</span></span><br><span class="line">  <span class="built_in">export</span> YARN_HOME=<span class="variable">$HADOOP_HOME</span></span><br><span class="line">  <span class="built_in">export</span> HADOOP_COMMON_LIB_NATIVE_DIR=<span class="variable">$HADOOP_HOME</span>/lib/native</span><br><span class="line">  <span class="built_in">export</span> JAVA_HOME=~/software/java</span><br><span class="line">  <span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$HADOOP_HOME</span>/sbin:<span class="variable">$HADOOP_HOME</span>/bin:<span class="variable">$JAVA_HOME</span>/bin</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">source</span> ~/.bashrc</span><br><span class="line"><span class="comment"># 也可以通过 vim ~/software/hadoop/etc/hadoop/hadoop-env.sh 进行配置</span></span><br><span class="line"></span><br><span class="line">$ mkdir -p ~/data/hadoop/tmp</span><br><span class="line">$ vim ~/software/hadoop/etc/hadoop/core-site.xml</span><br><span class="line">  &lt;configuration&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">      &lt;name&gt;hadoop.tmp.dir&lt;/name&gt;</span><br><span class="line">      &lt;value&gt;file:/home/eagle/data/hadoop/tmp&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">      &lt;name&gt;fs.defaultFS&lt;/name&gt;</span><br><span class="line">      &lt;value&gt;hdfs://localhost:9000&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">  &lt;/configuration&gt;</span><br><span class="line"></span><br><span class="line">$ vim ~/software/hadoop/etc/hadoop/hdfs-site.xml</span><br><span class="line">  &lt;configuration&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">      &lt;name&gt;dfs.replication&lt;/name&gt;</span><br><span class="line">      &lt;value&gt;1&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">      &lt;name&gt;dfs.namenode.name.dir&lt;/name&gt;</span><br><span class="line">      &lt;value&gt;file:/home/eagle/data/hadoop/tmp/dfs/name&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">      &lt;name&gt;dfs.datanode.data.dir&lt;/name&gt;</span><br><span class="line">      &lt;value&gt;file:/home/eagle/data/hadoop/tmp/dfs/data&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">  &lt;/configuration&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开启审计日志</span></span><br><span class="line">$ vim ~/software/hadoop/etc/hadoop/hadoop-env.sh</span><br><span class="line">  <span class="comment"># export HADOOP_NAMENODE_OPTS="-Dhadoop.security.logger=${HADOOP_SECURITY_LOGGER:-INFO,RFAS} -Dhdfs.audit.logger=${HDFS_AUDIT_LOGGER:-INFO,NullAppender} $HADOOP_NAMENODE_OPTS"</span></span><br><span class="line">  <span class="built_in">export</span> HADOOP_NAMENODE_OPTS=<span class="string">"-Dhadoop.security.logger=<span class="variable">${HADOOP_SECURITY_LOGGER:-INFO,RFAS}</span> -Dhdfs.audit.logger=<span class="variable">${HDFS_AUDIT_LOGGER:-INFO,RFAAUDIT}</span> <span class="variable">$HADOOP_NAMENODE_OPTS</span>"</span></span><br><span class="line"></span><br><span class="line">$ mkdir -p /home/eagle/logs/hadoop-hdfs/</span><br><span class="line">$ vim ~/software/hadoop/etc/hadoop/log4j.properties</span><br><span class="line">  <span class="comment"># log4j.appender.RFAAUDIT.File=${hadoop.log.dir}/hdfs-audit.log</span></span><br><span class="line">  log4j.appender.RFAAUDIT.File=/home/eagle/logs/hadoop-hdfs/hdfs-audit.log</span><br><span class="line">$ ps auxwww | grep NameNode | grep <span class="string">'hdfs.audit.logger'</span>  <span class="comment"># 检查是否生效</span></span><br><span class="line">$ tail -f ~/logs/hadoop-hdfs/hdfs-audit.log</span><br><span class="line"></span><br><span class="line">$ bin/hdfs namenode -format</span><br><span class="line">  17/04/07 16:27:17 INFO util.ExitUtil: Exiting with status 0</span><br></pre></td></tr></tbody></table></figure>
<h6 id="伪分布式"><a href="#伪分布式" class="headerlink" title="伪分布式"></a>伪分布式</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/software/hadoop/</span><br><span class="line">$ bin/hdfs dfs -mkdir -p /user/hadoop</span><br><span class="line"><span class="comment"># bin/hdfs dfs -rm -r /home    # 如果有脏数据，可以先清除</span></span><br><span class="line"><span class="comment"># bin/hdfs dfs -ls /user       # 执行 mkdir 命令后，检查是否成功</span></span><br><span class="line">$ bin/hdfs dfs -mkdir /user/hadoop/input</span><br><span class="line">$ bin/hdfs dfs -put etc/hadoop/*.xml /user/hadoop/input</span><br><span class="line">$ bin/hadoop jar share/hadoop/mapreduce/hadoop-mapreduce-examples-*.jar grep /user/hadoop/input /user/hadoop/output <span class="string">'dfs[a-z.]+'</span></span><br><span class="line"><span class="comment"># 查看输出目录</span></span><br><span class="line">$ bin/hdfs dfs -ls /user/hadoop/output/</span><br><span class="line">  -rw-r--r--   1 eagle supergroup          0 2017-04-10 10:26 /user/hadoop/output/_SUCCESS</span><br><span class="line">  -rw-r--r--   1 eagle supergroup         97 2017-04-10 10:26 /user/hadoop/output/part-r-00000</span><br><span class="line"><span class="comment"># 查看统计结果</span></span><br><span class="line">$ bin/hdfs dfs -cat /user/hadoop/output/part-r-00000</span><br><span class="line">  1    dfsadmin</span><br><span class="line">  1    dfs.replication</span><br><span class="line">  1    dfs.namenode.name.dir</span><br><span class="line">  1    dfs.namenode.http</span><br><span class="line">  1    dfs.datanode.data.dir</span><br><span class="line"><span class="comment"># 取回统计结果</span></span><br><span class="line">$ bin/hdfs dfs -get /user/hadoop/output ~/output</span><br><span class="line"><span class="comment"># cat ~/output/*                # 本地查看统计结果</span></span><br></pre></td></tr></tbody></table></figure>
<h6 id="Yarn"><a href="#Yarn" class="headerlink" title="Yarn"></a>Yarn</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/software/hadoop/</span><br><span class="line">$ mv etc/hadoop/mapred-site.xml.template etc/hadoop/mapred-site.xml</span><br><span class="line">$ vim etc/hadoop/mapred-site.xml</span><br><span class="line">  &lt;configuration&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">      &lt;name&gt;mapreduce.framework.name&lt;/name&gt;</span><br><span class="line">      &lt;value&gt;yarn&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">  &lt;/configuration&gt;</span><br><span class="line"></span><br><span class="line">$ vim etc/hadoop/yarn-site.xml</span><br><span class="line">  &lt;configuration&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">      &lt;name&gt;yarn.nodemanager.aux-services&lt;/name&gt;</span><br><span class="line">      &lt;value&gt;mapreduce_shuffle&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">  &lt;/configuration&gt;</span><br></pre></td></tr></tbody></table></figure>
<h6 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 启动 `NaneNode` 和 `DataNode` 守护进程</span></span><br><span class="line">$ sbin/start-dfs.sh</span><br><span class="line">$ jps -ml | grep -v jps</span><br><span class="line">  13196 org.apache.hadoop.hdfs.server.namenode.NameNode</span><br><span class="line">  13503 org.apache.hadoop.hdfs.server.namenode.SecondaryNameNode</span><br><span class="line">  13329 org.apache.hadoop.hdfs.server.datanode.DataNode</span><br><span class="line">  31639 org.apache.catalina.startup.Bootstrap start</span><br><span class="line">  13685 sun.tools.jps.Jps -ml</span><br><span class="line"><span class="comment"># 如果没有正常启动，可以在 `/home/eagle/software/hadoop-2.7.3/logs/hadoop-eagle-namenode-federation02.log` 中排查</span></span><br><span class="line"><span class="comment"># 正常启动后，可访问 http://eagle01:50071</span></span><br><span class="line"></span><br><span class="line">$ sbin/start-yarn.sh            <span class="comment"># 需要确保已经启动好 HDFS</span></span><br><span class="line"><span class="comment"># 开启历史服务器，可在 Web UI 中查看任务运行状况</span></span><br><span class="line">$ sbin/mr-jobhistory-daemon.sh start historyserver</span><br><span class="line">$ jps -ml | grep -v jps</span><br><span class="line">  3691 org.apache.hadoop.hdfs.server.namenode.NameNode</span><br><span class="line">  3995 org.apache.hadoop.hdfs.server.namenode.SecondaryNameNode</span><br><span class="line">  3821 org.apache.hadoop.hdfs.server.datanode.DataNode</span><br><span class="line">  4271 org.apache.hadoop.yarn.server.nodemanager.NodeManager</span><br><span class="line">  4175 org.apache.hadoop.yarn.server.resourcemanager.ResourceManager</span><br><span class="line">  4671 org.apache.hadoop.mapreduce.v2.hs.JobHistoryServer</span><br><span class="line">  31639 org.apache.catalina.startup.Bootstrap start</span><br><span class="line"><span class="comment"># 正常启动后，可访问 http://eagle01:8088</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="LogStash"><a href="#LogStash" class="headerlink" title="LogStash"></a>LogStash</h5><h6 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 下载地址 https://www.elastic.co/downloads/past-releases/logstash-2-3-4</span></span><br><span class="line">$ tar zxvf logstash-2.3.4.tar.gz -C ~/software/</span><br><span class="line">$ <span class="built_in">cd</span> ~/software</span><br><span class="line">$ ln -s logstash-2.3.4/ logstash</span><br><span class="line">$ <span class="built_in">cd</span> logstash</span><br><span class="line">$ bin/logstash-plugin list | grep output-kafka</span><br><span class="line">  logstash-output-kafka</span><br><span class="line"><span class="comment"># 如果没有默认安装，需要执行 `bin/logstash-plugin install logstash-output-kafka`</span></span><br><span class="line"><span class="comment"># 如需配置代理，则先执行 `export HTTP_PROXY=http://10.10.10.10:9999`</span></span><br></pre></td></tr></tbody></table></figure>
<h6 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ mkdir -p /home/eagle/logs/hadoop-hdfs</span><br><span class="line">$ mkdir -p /home/eagle/logs/logstash</span><br><span class="line">$ mkdir conf</span><br><span class="line">$ vim conf/hdfs-audit.conf</span><br><span class="line">  input {</span><br><span class="line">    file {</span><br><span class="line">      <span class="built_in">type</span> =&gt; <span class="string">"cdh-nn-audit"</span></span><br><span class="line">      <span class="comment"># 这里需要需要和 etc/hadoop/log4j.properties 中配置的 log4j.appender.RFAAUDIT.File 一致</span></span><br><span class="line">      path =&gt; <span class="string">"/home/eagle/logs/hadoop-hdfs/hdfs-audit.log"</span></span><br><span class="line">      start_position =&gt; end</span><br><span class="line">      sincedb_path =&gt; <span class="string">"/home/eagle/logs/logstash/logstash.log"</span></span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  filter{</span><br><span class="line">    <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">"cdh-nn-audit"</span> {</span><br><span class="line">      grok {</span><br><span class="line">        match =&gt; [<span class="string">"message"</span>, <span class="string">"ugi=(?&lt;user&gt;([\w\d\-]+))@|ugi=(?&lt;user&gt;([\w\d\-]+))/[\w\d\-.]+@|ugi=(?&lt;user&gt;([\w\d.\-_]+))[\s(]+"</span>]</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  output {</span><br><span class="line">    <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">"cdh-nn-audit"</span> {</span><br><span class="line">        kafka {</span><br><span class="line">        codec =&gt; plain {</span><br><span class="line">          format =&gt; <span class="string">"%{message}"</span></span><br><span class="line">        }</span><br><span class="line">        bootstrap_servers =&gt; <span class="string">"localhost:9092"</span></span><br><span class="line">        topic_id =&gt; <span class="string">"hdfs_audit_log"</span></span><br><span class="line">        timeout_ms =&gt; 10000</span><br><span class="line">        retries =&gt; 3</span><br><span class="line">        client_id =&gt; <span class="string">"cdh-nn-audit"</span></span><br><span class="line">      }</span><br><span class="line">      <span class="comment"># stdout { codec =&gt; rubydebug }</span></span><br><span class="line">    }</span><br><span class="line">  }</span><br></pre></td></tr></tbody></table></figure>
<h6 id="启动-1"><a href="#启动-1" class="headerlink" title="启动"></a>启动</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ nohup bin/logstash -f conf/hdfs-audit.conf &gt; ~/logs/logstash/hdfs-audit.log 2&gt;&amp;1 &amp;</span><br><span class="line">  Settings: Default pipeline workers: 2</span><br><span class="line">  Pipeline main started</span><br><span class="line">$ tail -f ~/logs/logstash/hdfs-audit.log</span><br></pre></td></tr></tbody></table></figure>
<h5 id="ZooKeeper"><a href="#ZooKeeper" class="headerlink" title="ZooKeeper"></a>ZooKeeper</h5><h6 id="安装-2"><a href="#安装-2" class="headerlink" title="安装"></a>安装</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/install/</span><br><span class="line">$ wget http://archive.apache.org/dist/zookeeper/zookeeper-3.4.10/zookeeper-3.4.10.tar.gz</span><br><span class="line"><span class="comment"># MD5 校验，参照上文 “Hadoop-安装” 部分</span></span><br><span class="line">$ tar zxvf zookeeper-3.4.10.tar.gz -C ~/software/</span><br><span class="line">$ <span class="built_in">cd</span> ~/software</span><br><span class="line">$ ln -s zookeeper-3.4.10 zookeeper</span><br></pre></td></tr></tbody></table></figure>
<h6 id="配置-2"><a href="#配置-2" class="headerlink" title="配置"></a>配置</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> zookeeper</span><br><span class="line">$ mkdir tmp</span><br><span class="line">$ cp conf/zoo_sample.cfg conf/zoo.cfg</span><br><span class="line">$ mkdir -p /home/eagle/data/zookeeper</span><br><span class="line">$ mkdir -p /home/eagle/logs/zookeeper</span><br><span class="line">$ vim conf/zoo.cfg</span><br><span class="line">  dataDir=/home/eagle/data/zookeeper</span><br><span class="line">  dataLogDir=/home/eagle/logs/zookeeper</span><br></pre></td></tr></tbody></table></figure>
<h6 id="启动-2"><a href="#启动-2" class="headerlink" title="启动"></a>启动</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ bin/zkServer.sh start</span><br><span class="line">$ bin/zkServer.sh status</span><br><span class="line">  ZooKeeper JMX enabled by default</span><br><span class="line">  Using config: /home/eagle/software/zookeeper/bin/../conf/zoo.cfg</span><br><span class="line">  Mode: standalone</span><br><span class="line">$ bin/zkCli.sh</span><br></pre></td></tr></tbody></table></figure>
<h5 id="Storm"><a href="#Storm" class="headerlink" title="Storm"></a>Storm</h5><h6 id="安装-3"><a href="#安装-3" class="headerlink" title="安装"></a>安装</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/install/</span><br><span class="line">$ wget http://archive.apache.org/dist/storm/apache-storm-0.9.7/apache-storm-0.9.7.tar.gz</span><br><span class="line"><span class="comment"># MD5 校验，参照上文 “Hadoop-安装” 部分</span></span><br><span class="line">$ tar zxvf apache-storm-0.9.7.tar.gz -C ~/software/</span><br><span class="line">$ <span class="built_in">cd</span> ~/software</span><br><span class="line">$ ln -s apache-storm-0.9.7 storm</span><br><span class="line">$ <span class="built_in">cd</span> storm</span><br><span class="line">$ vim ~/.bashrc</span><br><span class="line">  <span class="keyword">if</span> [ -f /etc/bashrc ]; <span class="keyword">then</span></span><br><span class="line">          . /etc/bashrc</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="built_in">export</span> HADOOP_HOME=~/software/hadoop</span><br><span class="line">  <span class="built_in">export</span> HADOOP_INSTALL=<span class="variable">$HADOOP_HOME</span></span><br><span class="line">  <span class="built_in">export</span> HADOOP_MAPRED_HOME=<span class="variable">$HADOOP_HOME</span></span><br><span class="line">  <span class="built_in">export</span> HADOOP_COMMON_HOME=<span class="variable">$HADOOP_HOME</span></span><br><span class="line">  <span class="built_in">export</span> HADOOP_HDFS_HOME=<span class="variable">$HADOOP_HOME</span></span><br><span class="line">  <span class="built_in">export</span> YARN_HOME=<span class="variable">$HADOOP_HOME</span></span><br><span class="line">  <span class="built_in">export</span> HADOOP_COMMON_LIB_NATIVE_DIR=<span class="variable">$HADOOP_HOME</span>/lib/native</span><br><span class="line">  <span class="built_in">export</span> JAVA_HOME=~/software/java</span><br><span class="line">  <span class="built_in">export</span> STORM_HOME=~/software/storm</span><br><span class="line">  <span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$HADOOP_HOME</span>/sbin:<span class="variable">$HADOOP_HOME</span>/bin:<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$STORM_HOME</span>/bin</span><br><span class="line">$ <span class="built_in">source</span> ~/.bashrc</span><br><span class="line">$ storm version</span><br><span class="line">  0.9.7</span><br></pre></td></tr></tbody></table></figure>
<h6 id="配置-3"><a href="#配置-3" class="headerlink" title="配置"></a>配置</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim conf/storm.yaml</span><br><span class="line">  storm.zookeeper.servers:</span><br><span class="line">    - <span class="string">"127.0.0.1"</span></span><br><span class="line">  storm.zookeeper.port: 2181</span><br><span class="line">  nimbus.host: <span class="string">"127.0.0.1"</span></span><br><span class="line">  ui.host: 0.0.0.0</span><br><span class="line">  ui.port: 8081              <span class="comment"># default: 8080</span></span><br></pre></td></tr></tbody></table></figure>
<h6 id="启动-3"><a href="#启动-3" class="headerlink" title="启动"></a>启动</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ mkdir -p ~/logs/storm</span><br><span class="line">$ nohup bin/storm nimbus &gt; ~/logs/storm/nimbus.log 2&gt;&amp;1 &amp;</span><br><span class="line">$ nohup bin/storm supervisor &gt; ~/logs/storm/supervisor.log 2&gt;&amp;1 &amp;</span><br><span class="line">$ nohup bin/storm ui &gt; ~/logs/storm/ui.log 2&gt;&amp;1 &amp;</span><br><span class="line"><span class="comment"># 查看 UI http://eagle01:8081/index.html</span></span><br><span class="line"></span><br><span class="line">$ jps -ml | grep -v jps</span><br><span class="line">  17557 backtype.storm.daemon.nimbus</span><br><span class="line">  17675 backtype.storm.daemon.supervisor</span><br><span class="line">  20403 backtype.storm.ui.core</span><br><span class="line">  17043 org.apache.zookeeper.server.quorum.QuorumPeerMain /home/eagle/software/zookeeper/bin/../conf/zoo.cfg</span><br><span class="line">  3691 org.apache.hadoop.hdfs.server.namenode.NameNode</span><br><span class="line">  3995 org.apache.hadoop.hdfs.server.namenode.SecondaryNameNode</span><br><span class="line">  3821 org.apache.hadoop.hdfs.server.datanode.DataNode</span><br><span class="line">  4271 org.apache.hadoop.yarn.server.nodemanager.NodeManager</span><br><span class="line">  4175 org.apache.hadoop.yarn.server.resourcemanager.ResourceManager</span><br><span class="line">  4671 org.apache.hadoop.mapreduce.v2.hs.JobHistoryServer</span><br><span class="line">  15515 org.jruby.Main --1.9 /home/eagle/software/logstash/lib/bootstrap/environment.rb logstash/runner.rb agent -f conf/hdfs-audit.conf</span><br><span class="line">  7212 org.apache.catalina.startup.Bootstrap start</span><br><span class="line"><span class="comment"># 运行</span></span><br><span class="line">$ bin/storm jar examples/storm-starter/storm-starter-topologies-0.9.7.jar storm.starter.WordCountTopology | grep <span class="string">'Thread-[0-9]*-count'</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="Kafka"><a href="#Kafka" class="headerlink" title="Kafka"></a>Kafka</h5><h6 id="Scala依赖"><a href="#Scala依赖" class="headerlink" title="Scala依赖"></a>Scala依赖</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/install/</span><br><span class="line">$ wget https://downloads.lightbend.com/scala/2.11.8/scala-2.11.8.tgz --no-check-certificate</span><br><span class="line">$ tar zxvf scala-2.11.8.tgz -C ~/software/</span><br><span class="line">$ <span class="built_in">cd</span> ~/software/</span><br><span class="line">$ ln -s scala-2.11.8/ scala</span><br><span class="line">$ vim ~/.bash_profile</span><br><span class="line">  JAVA_HOME=/home/eagle/software/java</span><br><span class="line">  SCALA_HOME=/home/eagle/software/scala</span><br><span class="line">  CLASSPATH=.:<span class="variable">$JAVA_HOME</span>/lib/tools.jar</span><br><span class="line">  PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$SCALA_HOME</span>/bin:<span class="variable">$PATH</span></span><br><span class="line">  <span class="built_in">export</span> JAVA_HOME CLASSPATH PATH</span><br><span class="line"></span><br><span class="line">$ bash ~/.bash_profile</span><br></pre></td></tr></tbody></table></figure>
<h6 id="安装-4"><a href="#安装-4" class="headerlink" title="安装"></a>安装</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/install/</span><br><span class="line">$ wget http://archive.apache.org/dist/kafka/0.10.1.1/kafka_2.11-0.10.1.1.tgz</span><br><span class="line"><span class="comment"># MD5 校验，参照上文 “Hadoop-安装” 部分</span></span><br><span class="line">$ tar zxvf kafka_2.11-0.10.1.1.tgz -C ~/software/</span><br><span class="line">$ <span class="built_in">cd</span> ~/software</span><br><span class="line">$ ln -s kafka_2.11-0.10.1.1 kafka</span><br></pre></td></tr></tbody></table></figure>
<h6 id="配置-4"><a href="#配置-4" class="headerlink" title="配置"></a>配置</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> kafka</span><br><span class="line">$ mkdir -p ~/logs/kafka</span><br><span class="line">$ vim config/zookeeper.properties</span><br><span class="line">  dataDir=/home/eagle/data/zookeeper</span><br><span class="line">  clientPort=2181</span><br><span class="line">  maxClientCnxns=0</span><br><span class="line"></span><br><span class="line">$ vim config/server.properties</span><br><span class="line">  log.dirs=/home/eagle/logs/kafka</span><br></pre></td></tr></tbody></table></figure>
<h6 id="启动-4"><a href="#启动-4" class="headerlink" title="启动"></a>启动</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ nohup bin/kafka-server-start.sh config/server.properties &gt; ~/logs/kafka/kafka.server.log 2&gt;&amp;1 &amp;</span><br><span class="line">$ tail -f /home/eagle/software/hbase/logs/hbase-eagle-master-federation01.out</span><br><span class="line">$ bin/kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic hdfs_audit_log</span><br><span class="line">  Created topic <span class="string">"hdfs_audit_log"</span>.</span><br><span class="line"></span><br><span class="line">$ bin/kafka-topics.sh --list --zookeeper localhost:2181</span><br><span class="line">  hdfs_audit_log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查是否能成功消费到 LogStash 发送的 audit 日志</span></span><br><span class="line">$ bin/kafka-console-consumer.sh --zookeeper localhost:2181 --topic hdfs_audit_log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 offset</span></span><br><span class="line">$ ~/software/zookeeper/bin/zkCli.sh</span><br><span class="line">  [zk: localhost:2181(CONNECTED) 19] get /consumers/console-consumer-51054/offsets/hdfs_audit_log/0 </span><br><span class="line">    0</span><br><span class="line">    cZxid = 0x396</span><br><span class="line">    ctime = Tue Apr 11 15:59:22 CST 2017</span><br><span class="line">    mZxid = 0x396</span><br><span class="line">    mtime = Tue Apr 11 15:59:22 CST 2017</span><br><span class="line">    pZxid = 0x396</span><br><span class="line">    cversion = 0</span><br><span class="line">    dataVersion = 0</span><br><span class="line">    aclVersion = 0</span><br><span class="line">    ephemeralOwner = 0x0</span><br><span class="line">    dataLength = 1</span><br><span class="line">    numChildren = 0</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Eagle"><a href="#Eagle" class="headerlink" title="Eagle"></a>Eagle</h4><h5 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> install</span><br><span class="line">$ wget http://archive.apache.org/dist/eagle/apache-eagle-0.4.0-incubating/apache-eagle-0.4.0-incubating-src.tar.gz</span><br><span class="line">$ tar zxvf apache-eagle-0.4.0-incubating-src.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> apache-eagle-0.4.0-incubating-src</span><br><span class="line">$ curl -O https://patch-diff.githubusercontent.com/raw/apache/eagle/pull/268.patch</span><br><span class="line">$ git apply 268.patch</span><br><span class="line">$ mvn clean package -T 1C -DskipTests</span><br><span class="line"><span class="comment"># build 成功之后，会得到一个 tar 包 eagle-assembly/target/apache-eagle-0.4.0-incubating-bin.tar.gz</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="安装-5"><a href="#安装-5" class="headerlink" title="安装"></a>安装</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/eagle/install/</span><br><span class="line">$ tar zxvf apache-eagle-0.4.0-incubating-bin.tar.gz -C /home/eagle/software/</span><br><span class="line">$ <span class="built_in">cd</span> /home/eagle/software/</span><br><span class="line">$ ln -s apache-eagle-0.4.0-incubating/ eagle</span><br><span class="line">$ <span class="built_in">cd</span> eagle</span><br><span class="line">$ bin/eagle-service.sh start</span><br><span class="line">  Starting eagle service ...</span><br><span class="line">  Existing PID file found during start.</span><br><span class="line">  Removing/clearing stale PID file.</span><br><span class="line">  Eagle service started.</span><br><span class="line"><span class="comment"># 访问 http://eagle01:9099/eagle-service # default: admin/secret</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="配置-Eagle"><a href="#配置-Eagle" class="headerlink" title="配置 Eagle"></a><a href="https://eagle.apache.org/docs/latest/reference/#configuration">配置 Eagle</a></h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/software/eagle</span><br><span class="line">$ vim bin/eagle-env.sh</span><br><span class="line">  <span class="comment"># set EAGLE_HOME</span></span><br><span class="line">  <span class="built_in">export</span> EAGLE_HOME=$(dirname <span class="variable">$0</span>)/..</span><br><span class="line"></span><br><span class="line">  <span class="comment"># The java implementation to use. please use jdk 1.7 or later</span></span><br><span class="line">  <span class="built_in">export</span> JAVA_HOME=<span class="variable">${JAVA_HOME}</span></span><br><span class="line">  <span class="comment"># export JAVA_HOME=/usr/java/jdk1.7.0_80/</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># nimbus.host, default is localhost</span></span><br><span class="line">  <span class="built_in">export</span> EAGLE_NIMBUS_HOST=localhost</span><br><span class="line"></span><br><span class="line">  <span class="comment"># EAGLE_SERVICE_HOST, default is `hostname -f`</span></span><br><span class="line">  <span class="built_in">export</span> EAGLE_SERVICE_HOST=localhost</span><br><span class="line"></span><br><span class="line">  <span class="comment"># EAGLE_SERVICE_PORT, default is 9099</span></span><br><span class="line">  <span class="built_in">export</span> EAGLE_SERVICE_PORT=9099</span><br><span class="line"></span><br><span class="line">  <span class="comment"># EAGLE_SERVICE_USER</span></span><br><span class="line">  <span class="built_in">export</span> EAGLE_SERVICE_USER=admin</span><br><span class="line"></span><br><span class="line">  <span class="comment"># EAGLE_SERVICE_PASSWORD</span></span><br><span class="line">  <span class="built_in">export</span> EAGLE_SERVICE_PASSWD=secret</span><br><span class="line"></span><br><span class="line">  <span class="built_in">export</span> EAGLE_CLASSPATH=<span class="variable">$EAGLE_HOME</span>/conf</span><br><span class="line">  <span class="comment"># Add eagle shared library jars</span></span><br><span class="line">  <span class="keyword">for</span> file <span class="keyword">in</span> <span class="variable">$EAGLE_HOME</span>/lib/share/*;<span class="keyword">do</span></span><br><span class="line">          EAGLE_CLASSPATH=<span class="variable">$EAGLE_CLASSPATH</span>:<span class="variable">$file</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Add eagle storm library jars</span></span><br><span class="line">  <span class="comment"># Separate out of share directory because of asm version conflict</span></span><br><span class="line">  <span class="built_in">export</span> EAGLE_STORM_CLASSPATH=<span class="variable">$EAGLE_CLASSPATH</span></span><br><span class="line">  <span class="keyword">for</span> file <span class="keyword">in</span> <span class="variable">$EAGLE_HOME</span>/lib/storm/*;<span class="keyword">do</span></span><br><span class="line">          EAGLE_STORM_CLASSPATH=<span class="variable">$EAGLE_STORM_CLASSPATH</span>:<span class="variable">$file</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">$ vim conf/eagle-scheduler.conf</span><br><span class="line">  <span class="comment">### scheduler propertise</span></span><br><span class="line">  appCommandLoaderEnabled = <span class="literal">false</span></span><br><span class="line">  appCommandLoaderIntervalSecs = 1</span><br><span class="line">  appHealthCheckIntervalSecs = 5</span><br><span class="line"></span><br><span class="line">  <span class="comment">### execution platform properties</span></span><br><span class="line">  envContextConfig.env = <span class="string">"storm"</span></span><br><span class="line">  envContextConfig.url = <span class="string">"http://localhost:8081"</span></span><br><span class="line">  envContextConfig.nimbusHost = <span class="string">"localhost"</span></span><br><span class="line">  envContextConfig.nimbusThriftPort = 6627</span><br><span class="line">  envContextConfig.jarFile = <span class="string">"/home/eagle/software/eagle/lib/topology/eagle-topology-0.4.0-incubating-assembly.jar"</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">### default topology properties</span></span><br><span class="line">  eagleProps.mailHost = <span class="string">"mailHost.com"</span></span><br><span class="line">  eagleProps.mailSmtpPort = <span class="string">"25"</span></span><br><span class="line">  eagleProps.mailDebug = <span class="string">"true"</span></span><br><span class="line">  eagleProps.eagleService.host = <span class="string">"localhost"</span></span><br><span class="line">  eagleProps.eagleService.port = 9099</span><br><span class="line">  eagleProps.eagleService.username = <span class="string">"admin"</span></span><br><span class="line">  eagleProps.eagleService.password = <span class="string">"secret"</span></span><br><span class="line">  eagleProps.dataJoinPollIntervalSec = 30</span><br><span class="line"></span><br><span class="line">  dynamicConfigSource.enabled = <span class="literal">true</span></span><br><span class="line">  dynamicConfigSource.initDelayMillis = 0</span><br><span class="line">  dynamicConfigSource.delayMillis = 30000</span><br><span class="line"></span><br><span class="line">$ vim conf/sandbox-hdfsAuditLog-application.conf</span><br><span class="line">{</span><br><span class="line">  <span class="string">"envContextConfig"</span> : {</span><br><span class="line">    <span class="string">"env"</span> : <span class="string">"storm"</span>,</span><br><span class="line">    <span class="string">"mode"</span> : <span class="string">"cluster"</span>,</span><br><span class="line">    <span class="string">"topologyName"</span> : <span class="string">"sandbox-hdfsAuditLog-topology"</span>,</span><br><span class="line">    <span class="string">"stormConfigFile"</span> : <span class="string">"security-auditlog-storm.yaml"</span>,</span><br><span class="line">    <span class="string">"parallelismConfig"</span> : {</span><br><span class="line">      <span class="string">"kafkaMsgConsumer"</span> : 1,</span><br><span class="line">      <span class="string">"hdfsAuditLogAlertExecutor*"</span> : 1</span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  <span class="string">"dataSourceConfig"</span>: {</span><br><span class="line">    <span class="string">"topic"</span> : <span class="string">"hdfs_audit_log"</span>,</span><br><span class="line">    <span class="string">"zkConnection"</span> : <span class="string">"127.0.0.1:2181"</span>,</span><br><span class="line">    <span class="string">"brokerZkPath"</span> : <span class="string">"/brokers"</span>,</span><br><span class="line">    <span class="string">"zkConnectionTimeoutMS"</span> : 15000,</span><br><span class="line">    <span class="string">"fetchSize"</span> : 1048586,</span><br><span class="line">    <span class="string">"deserializerClass"</span> : <span class="string">"org.apache.eagle.security.auditlog.HdfsAuditLogKafkaDeserializer"</span>,</span><br><span class="line">    <span class="string">"transactionZKServers"</span> : <span class="string">"127.0.0.1"</span>,</span><br><span class="line">    <span class="string">"transactionZKPort"</span> : 2181,</span><br><span class="line">    <span class="string">"transactionZKRoot"</span> : <span class="string">"/consumers"</span>,</span><br><span class="line">    <span class="string">"consumerGroupId"</span> : <span class="string">"eagle.hdfsaudit.consumer"</span>,</span><br><span class="line">    <span class="string">"transactionStateUpdateMS"</span> : 2000</span><br><span class="line">  },</span><br><span class="line">  <span class="string">"alertExecutorConfigs"</span> : {</span><br><span class="line">     <span class="string">"hdfsAuditLogAlertExecutor"</span> : {</span><br><span class="line">       <span class="string">"parallelism"</span> : 1,</span><br><span class="line">       <span class="string">"partitioner"</span> : <span class="string">"org.apache.eagle.policy.DefaultPolicyPartitioner"</span>,</span><br><span class="line">       <span class="string">"needValidation"</span> : <span class="string">"true"</span></span><br><span class="line">     }</span><br><span class="line">  },</span><br><span class="line">  <span class="string">"eagleProps"</span> : {</span><br><span class="line">    <span class="string">"site"</span> : <span class="string">"sandbox"</span>,</span><br><span class="line">    <span class="string">"application"</span>: <span class="string">"hdfsAuditLog"</span>,</span><br><span class="line">        <span class="string">"dataJoinPollIntervalSec"</span> : 30,</span><br><span class="line">    <span class="string">"mailHost"</span> : <span class="string">"mailHost.com"</span>,</span><br><span class="line">    <span class="string">"mailSmtpPort"</span>:<span class="string">"25"</span>,</span><br><span class="line">    <span class="string">"mailDebug"</span> : <span class="string">"true"</span>,</span><br><span class="line">    <span class="string">"eagleService"</span>: {</span><br><span class="line">      <span class="string">"host"</span>: <span class="string">"localhost"</span>,</span><br><span class="line">      <span class="string">"port"</span>: 9099</span><br><span class="line">      <span class="string">"username"</span>: <span class="string">"admin"</span>,</span><br><span class="line">      <span class="string">"password"</span>: <span class="string">"secret"</span></span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  <span class="string">"dynamicConfigSource"</span> : {</span><br><span class="line">        <span class="string">"enabled"</span> : <span class="literal">true</span>,</span><br><span class="line">        <span class="string">"initDelayMillis"</span> : 0,</span><br><span class="line">        <span class="string">"delayMillis"</span> : 30000</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h5 id="元数据存储"><a href="#元数据存储" class="headerlink" title="元数据存储"></a>元数据存储</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ su - mysql</span><br><span class="line">$ mysql -uroot -p -S /home/mysql/data/mysql.sock</span><br><span class="line">  create database eagle;</span><br><span class="line">  <span class="comment"># 用户创建 &amp; 赋权，详见下文 “踩过的坑 - MySQL” 部分</span></span><br><span class="line"></span><br><span class="line">$ su - eagle</span><br><span class="line">$ vim /home/eagle/software/eagle/conf/eagle-service.conf</span><br><span class="line">eagle {</span><br><span class="line">  service {</span><br><span class="line">    storage-type=<span class="string">"jdbc"</span></span><br><span class="line">    storage-adapter=<span class="string">"mysql"</span></span><br><span class="line">    storage-username=<span class="string">"eagle"</span></span><br><span class="line">    storage-password=eagle</span><br><span class="line">    storage-database=eagle</span><br><span class="line">    storage-connection-url=<span class="string">"jdbc:mysql://mysql01:3306/eagle"</span></span><br><span class="line">    storage-connection-props=<span class="string">"encoding=UTF-8"</span></span><br><span class="line">    storage-driver-class=<span class="string">"com.mysql.jdbc.Driver"</span></span><br><span class="line">    storage-connection-max=30</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"><span class="comment"># eagle {</span></span><br><span class="line"><span class="comment">#   service {</span></span><br><span class="line"><span class="comment">#     storage-type="jdbc"</span></span><br><span class="line"><span class="comment">#     storage-adapter="derby"</span></span><br><span class="line"><span class="comment">#     storage-username="eagle"</span></span><br><span class="line"><span class="comment">#     storage-password=eagle</span></span><br><span class="line"><span class="comment">#     storage-database=eagle</span></span><br><span class="line"><span class="comment">#     storage-connection-url="jdbc:derby:/tmp/eagle-db-dev;create=true"</span></span><br><span class="line"><span class="comment">#     storage-connection-props="encoding=UTF-8"</span></span><br><span class="line"><span class="comment">#     storage-driver-class="org.apache.derby.jdbc.EmbeddedDriver"</span></span><br><span class="line"><span class="comment">#     storage-connection-max=8</span></span><br><span class="line"><span class="comment">#   }</span></span><br><span class="line"><span class="comment"># }</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="启动-5"><a href="#启动-5" class="headerlink" title="启动"></a>启动</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ bin/eagle-service.sh start</span><br><span class="line">$ bin/eagle-service.sh status</span><br><span class="line">  Eagle service is running 17789</span><br><span class="line">$ bin/eagle-topology-init.sh</span><br><span class="line">$ bin/eagle-topology.sh start</span><br><span class="line">$ bin/eagle-topology.sh status</span><br><span class="line">  Checking topology sandbox-hdfsAuditLog-topology status ...</span><br><span class="line">  Topology is alive: sandbox-hdfsAuditLog-topology ACTIVE     7          1            18        </span><br><span class="line"><span class="comment"># 访问 http://eagle01:9099/eagle-service/ui/#/landing</span></span><br><span class="line"><span class="comment"># tail -f logs/eagle-service.out</span></span><br></pre></td></tr></tbody></table></figure>
<p>　至此大功告成~</p>
<p><img data-src="/picture/eagle/apache_eagle_sites_default.png" alt=""></p>
<h2 id="Eagle-高级玩法"><a href="#Eagle-高级玩法" class="headerlink" title="Eagle 高级玩法"></a>Eagle 高级玩法</h2><h3 id="HBase-Security-Log"><a href="#HBase-Security-Log" class="headerlink" title="HBase Security Log"></a>HBase Security Log</h3><h4 id="HBase-部署"><a href="#HBase-部署" class="headerlink" title="HBase 部署"></a>HBase 部署</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ wget http://archive.apache.org/dist/hbase/hbase-0.98.8/hbase-0.98.8-hadoop2-bin.tar.gz</span><br><span class="line">$ tar zxvf hbase-0.98.8-hadoop2-bin.tar.gz -C ~/software/</span><br><span class="line">$ <span class="built_in">cd</span> ~/software</span><br><span class="line">$ ln -s hbase-0.98.8-hadoop2 hbase</span><br><span class="line">$ vim ~/.bashrc</span><br><span class="line">  HBASE_HOME=~/software/hbase</span><br><span class="line">  PATH=<span class="variable">$HBASE_HOME</span>/bin:<span class="variable">$PATH</span></span><br><span class="line">$ <span class="built_in">source</span> ~/.bashrc</span><br><span class="line">$ hbase version</span><br><span class="line">  2017-04-14 16:19:24,992 INFO  [main] util.VersionInfo: HBase 0.98.8-hadoop2</span><br><span class="line"></span><br><span class="line"><span class="comment"># ssh 免密</span></span><br><span class="line">$ ssh-keygen -t dsa -P <span class="string">''</span> -f /home/eagle/.ssh/id_dsa</span><br><span class="line">$ <span class="built_in">cd</span> /home/eagle/.ssh</span><br><span class="line">$ cat id_rsa.pub &gt; authorized_keys</span><br><span class="line">$ scp /home/eagle/.ssh/authorized_keys eagle@eagle02:/home/eagle/.ssh/</span><br><span class="line">$ chmod 700 -R ~/.ssh</span><br><span class="line">$ chmod 600 ~/.ssh/authorized_keys</span><br><span class="line"><span class="comment"># 配置双向 ssh，则重复上述步骤</span></span><br><span class="line"></span><br><span class="line">$ vim conf/hbase-env.sh</span><br><span class="line">  <span class="built_in">export</span> JAVA_HOME=~/software/java</span><br><span class="line">  <span class="built_in">export</span> HBASE_MANAGES_ZK=<span class="literal">false</span></span><br><span class="line"></span><br><span class="line">$ mkdir -p /home/eagle/data/hbase/tmp</span><br><span class="line">$ vim conf/hbase-site.sh</span><br><span class="line">  &lt;configuration&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">      &lt;name&gt;hbase.rootdir&lt;/name&gt;</span><br><span class="line">      &lt;value&gt;hdfs://eagle01:9000/hbase&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">      &lt;name&gt;dfs.replication&lt;/name&gt;</span><br><span class="line">      &lt;value&gt;1&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">      &lt;name&gt;hbase.cluster.distributed&lt;/name&gt;</span><br><span class="line">      &lt;value&gt;<span class="literal">true</span>&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">      &lt;name&gt;hbase.zookeeper.property.clientPort&lt;/name&gt;</span><br><span class="line">      &lt;value&gt;2181&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">      &lt;name&gt;hbase.zookeeper.quorum&lt;/name&gt;</span><br><span class="line">      &lt;value&gt;eagle01&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">      <span class="comment"># 参考 `~/software/zookeeper/config/zookeeper.properties`</span></span><br><span class="line">      &lt;name&gt;hbase.zookeeper.property.dataDir&lt;/name&gt;</span><br><span class="line">      &lt;value&gt;/home/eagle/data/zookeeper&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">      &lt;name&gt;zookeeper.znode.parent&lt;/name&gt;</span><br><span class="line">      &lt;value&gt;/hbase&lt;/value&gt; </span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">      &lt;name&gt;hbase.tmp.dir&lt;/name&gt;</span><br><span class="line">      &lt;value&gt;/home/eagle/data/hbase/tmp&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">  &lt;/configuration&gt;</span><br></pre></td></tr></tbody></table></figure>
<h4 id="开启-Security-日志"><a href="#开启-Security-日志" class="headerlink" title="开启 Security 日志"></a>开启 Security 日志</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ su - hbase</span><br><span class="line">$ <span class="built_in">cd</span> ~/software/hbase/</span><br><span class="line">$ vim conf/hbase-site.xml</span><br><span class="line">  <span class="comment"># 增加如下配置</span></span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;hbase.security.authentication&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;simple&lt;/value&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;hbase.security.authorization&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;<span class="literal">true</span>&lt;/value&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;hbase.coprocessor.master.classes&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;org.apache.hadoop.hbase.security.access.AccessController&lt;/value&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;hbase.coprocessor.region.classes&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;org.apache.hadoop.hbase.security.access.AccessController&lt;/value&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;hbase.coprocessor.regionserver.classes&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;org.apache.hadoop.hbase.security.access.AccessController&lt;/value&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line"></span><br><span class="line">$ sudo mkdir -p /opt/hbase/logs/security/</span><br><span class="line">$ sudo chown -R eagle:eagle /opt/hbase/</span><br><span class="line">$ vim conf/log4j.properties</span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># Security audit appender</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  hbase.security.log.file=SecurityAuth.audit</span><br><span class="line">  hbase.security.log.maxfilesize=256MB</span><br><span class="line">  hbase.security.log.maxbackupindex=20</span><br><span class="line">  log4j.appender.RFAS=org.apache.log4j.RollingFileAppender</span><br><span class="line">  log4j.appender.RFAS.File=/opt/hbase/logs/security/security.log</span><br><span class="line">  log4j.appender.RFAS.MaxFileSize=<span class="variable">${hbase.security.log.maxfilesize}</span></span><br><span class="line">  log4j.appender.RFAS.MaxBackupIndex=<span class="variable">${hbase.security.log.maxbackupindex}</span></span><br><span class="line">  log4j.appender.RFAS.layout=org.apache.log4j.PatternLayout</span><br><span class="line">  log4j.appender.RFAS.layout.ConversionPattern=%d{ISO8601} %p %c: %m%n</span><br><span class="line">  log4j.category.SecurityLogger=<span class="variable">${hbase.security.logger}</span></span><br><span class="line">  log4j.additivity.SecurityLogger=<span class="literal">false</span></span><br><span class="line">  log4j.logger.SecurityLogger.org.apache.hadoop.hbase.security.access.AccessController=TRACE</span><br><span class="line"></span><br><span class="line">$ bin/start-hbase.sh</span><br><span class="line">$ tail -f /opt/hbase/logs/security/security.log</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Kafka-1"><a href="#Kafka-1" class="headerlink" title="Kafka"></a>Kafka</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 创建 `hbase_security_log` topic</span></span><br><span class="line"><span class="comment"># 如果之前存在可以删除，bin/kafka-topics.sh --zookeeper localhost:2181 --delete --topic hbase_security_log（需要先在 config/server.properties 中配置 delete.topic.enable=true）</span></span><br><span class="line">$ bin/kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic hbase_security_log</span><br><span class="line">  Created topic <span class="string">"hbase_security_log"</span>.</span><br><span class="line">$ bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic hbase_security_log</span><br></pre></td></tr></tbody></table></figure>
<h4 id="LogStash-1"><a href="#LogStash-1" class="headerlink" title="LogStash"></a>LogStash</h4><h5 id="安装-6"><a href="#安装-6" class="headerlink" title="安装"></a>安装</h5><p>　参照上文 <code>Eagle环境搭建</code> - <code>LogStash</code> 部分</p>
<h5 id="配置-5"><a href="#配置-5" class="headerlink" title="配置"></a>配置</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/software/logstash/</span><br><span class="line">$ mkdir -p /data03/hbase/logs/logstash</span><br><span class="line">$ vim conf/hbase-security.conf</span><br><span class="line">  input {</span><br><span class="line">    file {</span><br><span class="line">      <span class="built_in">type</span> =&gt; <span class="string">"hbase-security-log"</span></span><br><span class="line">      path =&gt; <span class="string">"/data03/hbase/logs/security/security.log"</span></span><br><span class="line">      start_position =&gt; end</span><br><span class="line">      sincedb_path =&gt; <span class="string">"/data03/hbase/logs/security/security_monitor.log"</span></span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  output {</span><br><span class="line">    <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">"hbase-security-log"</span> {</span><br><span class="line">      kafka {</span><br><span class="line">        codec =&gt; plain {</span><br><span class="line">          format =&gt; <span class="string">"%{message}"</span></span><br><span class="line">        }</span><br><span class="line">        bootstrap_servers =&gt; <span class="string">"eagle01:9092"</span></span><br><span class="line">        topic_id =&gt; <span class="string">"hbase_security_log"</span></span><br><span class="line">        timeout_ms =&gt; 10000</span><br><span class="line">        batch_size =&gt; 1000</span><br><span class="line">        retries =&gt; 3</span><br><span class="line">        client_id =&gt; <span class="string">"hbase-security-log"</span></span><br><span class="line">      }</span><br><span class="line">      <span class="comment"># stdout {codec =&gt; rubydebug}</span></span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">$ nohup bin/logstash -f conf/hbase-security.conf &gt; /home/eagle/logs/logstash/hbase_security.log 2&gt;&amp;1 &amp;</span><br><span class="line">$ tail -f /data03/hbase/logs/logstash/hbase_security.log</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Eagle-配置"><a href="#Eagle-配置" class="headerlink" title="Eagle 配置"></a>Eagle 配置</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim conf/sandbox-hbaseSecurityLog-application.conf</span><br><span class="line">  <span class="string">"dataSourceConfig"</span>: {</span><br><span class="line">    <span class="string">"topic"</span> : <span class="string">"hbase_security_log"</span>,    <span class="comment"># 修改 topic</span></span><br><span class="line">    // ...</span><br><span class="line">  },</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Eagle-提交-Topology"><a href="#Eagle-提交-Topology" class="headerlink" title="Eagle 提交 Topology"></a>Eagle 提交 Topology</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># bin/eagle-topology.sh --topology sandbox-hbaseSecurityLog-topology --config conf/sandbox--application.conf start</span></span><br><span class="line">$ bin/eagle-topology.sh --main org.apache.eagle.security.hbase.HbaseAuditLogProcessorMain --config conf/sandbox-hbaseSecurityLog-application.conf start</span><br><span class="line">$ bin/eagle-topology.sh --topology sandbox-hbaseSecurityLog-topology status</span><br><span class="line">  Checking topology sandbox-hbaseSecurityLog-topology status ...</span><br><span class="line">  Topology is alive: sandbox-hbaseSecurityLog-topology ACTIVE     7          1            131</span><br><span class="line"><span class="comment"># 关闭 topology</span></span><br><span class="line">$ bin/eagle-topology.sh --topology sandbox-hbaseSecurityLog-topology stop</span><br></pre></td></tr></tbody></table></figure>
<h4 id="配置告警"><a href="#配置告警" class="headerlink" title="配置告警"></a>配置告警</h4><p>　在 <code>Site</code> 中配置好 HBase 的 <code>hbaseSecurityLog</code> <code>application</code> 之后，可以在 <code>Data Classification</code> 中看到如下界面<br><img data-src="/picture/eagle/apache_eagle_hbase_data_classification.png" alt=""><br>　之后，新建 <code>Policy</code><br><img data-src="/picture/eagle/apache_eagle_hbase_policy_detail.png" alt=""></p>
<p>参考</p>
<ul>
<li><a href="http://hbase.apache.org/1.1/book.html#_server_side_configuration_for_simple_user_access_operation">Server-side Configuration for Simple User Access Operation</a></li>
<li><a href="https://hbase.apache.org/book.html#security.example.config">Security Configuration Example</a></li>
<li><a href="https://www.elastic.co/guide/en/logstash/2.3/plugins-inputs-file.html">Input plugins » file</a></li>
<li><a href="https://www.elastic.co/guide/en/logstash/2.3/plugins-outputs-kafka.html">Output plugins » kafka</a></li>
<li><a href="https://eagle.apache.org/docs/tutorial/topologymanagement.html">Apache Eagle Topology Management</a></li>
</ul>
<h2 id="踩过的坑"><a href="#踩过的坑" class="headerlink" title="踩过的坑"></a>踩过的坑</h2><h3 id="RPM"><a href="#RPM" class="headerlink" title="RPM"></a>RPM</h3><h4 id="error-can’t-create-transaction-lock-on-var-lib-rpm-rpm-lock-Permission-denied"><a href="#error-can’t-create-transaction-lock-on-var-lib-rpm-rpm-lock-Permission-denied" class="headerlink" title="error: can’t create transaction lock on /var/lib/rpm/.rpm.lock (Permission denied)"></a>error: can’t create transaction lock on /var/lib/rpm/.rpm.lock (Permission denied)</h4><h5 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h5><p>　增加 sudo<br>　同时，需要保证 user 是在 /etc/sudoers 中的</p>
<h5 id="参考-1"><a href="#参考-1" class="headerlink" title="参考"></a>参考</h5><ul>
<li><a href="http://unix.stackexchange.com/questions/125706/why-cant-i-install-packages-with-rpm-i-get-transaction-lock">why can not I install packages with rpm? I get “transaction lock”[closed]</a></li>
</ul>
<h3 id="Maven"><a href="#Maven" class="headerlink" title="Maven"></a>Maven</h3><h4 id="zookeeper-jar-3-4-6-2-2-0-0-2041-无法从-Maven-中央仓库下载到"><a href="#zookeeper-jar-3-4-6-2-2-0-0-2041-无法从-Maven-中央仓库下载到" class="headerlink" title="zookeeper:jar:3.4.6.2.2.0.0-2041 无法从 Maven 中央仓库下载到"></a><code>zookeeper:jar:3.4.6.2.2.0.0-2041</code> 无法从 Maven 中央仓库下载到</h4><h5 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h5><p>　后面小版本说明并不是官方提供的 release 版本，是由 hortonworks 之类的第三方平台提供</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ mvn clean package -T 1C -DskipTests</span><br><span class="line"></span><br><span class="line">　Failed to execute goal on project eagle-log4jkafka: Could not resolve dependencies <span class="keyword">for</span> project org.apache.eagle:eagle-log4jkafka:jar:0.4.0-incubating: The following artifacts could not be resolved: org.apache.kafka:kafka_2.10:jar:0.8.1.2.2.0.0-2041, org.apache.zookeeper:zookeeper:jar:3.4.6.2.2.0.0-2041: Could not transfer artifact org.apache.kafka:kafka_2.10:jar:0.8.1.2.2.0.0-2041 from/to HDP Release Repository (http://repo.hortonworks.com/content/repositories/releases/): GET request of: org/apache/kafka/kafka_2.10/0.8.1.2.2.0.0-2041/kafka_2.10-0.8.1.2.2.0.0-2041.jar from HDP Release Repository failed: Connection reset -&gt; [Help 1]</span><br></pre></td></tr></tbody></table></figure>
<h5 id="解决-1"><a href="#解决-1" class="headerlink" title="解决"></a>解决</h5><ul>
<li><p>检查是否是因为 Maven 没有配置代理</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Linux (bash)</span></span><br><span class="line">$ <span class="built_in">export</span> MAVEN_OPTS=<span class="string">"-DsocksProxyHost=&lt;proxy host&gt; -DsocksProxyPort=&lt;proxy port&gt;"</span></span><br><span class="line"><span class="comment"># Windows</span></span><br><span class="line">$ <span class="built_in">set</span> MAVEN_OPTS=<span class="string">"-DsocksProxyHost=&lt;proxy host&gt; -DsocksProxyPort=&lt;proxy port&gt;"</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>Maven 中央仓库是否没有提供对应可下载的 Jar</p>
</li>
</ul>
<p>　　通过 <a href="https://mvnrepository.com/">mvnrepository.com</a> 进行查找，<a href="https://mvnrepository.com/artifact/org.apache.kafka/kafka_2.10/0.8.1.2.2.0.0-2041">kafka_2.10-0.8.1.2.2.0.0-2041.jar</a> 的确是存在可以下载，但是 <a href="https://mvnrepository.com/artifact/org.apache.zookeeper/zookeeper/3.4.6.2.2.0.0-2041">zookeeper_3.4.6.2.2.0.0-2041.jar</a> 并没有提供出来<br>　　Apache 官方提供的 <a href="http://archive.apache.org">archive.apache.org</a> 中，也只有标准的 <a href="http://archive.apache.org/dist/zookeeper/">Stable Release</a></p>
<ul>
<li>自己编译 zookeeper_3.4.6.2.2.0.0-2041.jar</li>
</ul>
<p>　　在 Hortonworks 的 github 分支中并没有提供源码，并且在 <a href="https://github.com/hortonworks/zookeeper-release/releases">Release</a> 中也找不到对应的版本</p>
<ul>
<li>直接用已经编译好的 Eagle</li>
</ul>
<p>　　<a href="http://archive.apache.org/dist/eagle/apache-eagle-0.4.0-incubating/">Apache Archive</a> 中提供了 apache-eagle-0.4.0-incubating-src.tar.gz 源码</p>
<ul>
<li>修改 hadoop.version 使得其依赖的 zookeeper 版本也跟着改变</li>
</ul>
<p>　　<code>-Dhadoop.version=&lt;hadoop version&gt; -Dhbase.version=&lt;hbase version&gt;</code><br>　　例如：<code>mvn clean package -T 1C -DskipTests -Dhadoop.version=2.7.3</code></p>
<p>　已提交 <a href="https://issues.apache.org/jira/browse/EAGLE-990">EAGLE-990</a>，欢迎参与讨论</p>
<h5 id="参考-2"><a href="#参考-2" class="headerlink" title="参考"></a>参考</h5><ul>
<li><a href="http://stackoverflow.com/questions/1251192/how-do-i-use-maven-through-a-proxy">How do I use Maven through a proxy?</a></li>
<li><a href="http://stackoverflow.com/questions/33130388/replace-maven-properties-in-pom-xml-via-command-line">Replace Maven properties in pom.xml via command line</a></li>
</ul>
<h4 id="maven-scala-plugin-版本过低"><a href="#maven-scala-plugin-版本过低" class="headerlink" title="maven-scala-plugin 版本过低"></a>maven-scala-plugin 版本过低</h4><h5 id="描述-1"><a href="#描述-1" class="headerlink" title="描述"></a>描述</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[ERROR] Failed to execute goal org.scala-tools:maven-scala-plugin:2.15.0:compile</span><br><span class="line"> (default) on project eagle-log4jkafka: wrap: org.apache.commons.exec.ExecuteExc</span><br><span class="line">eption: Process exited with an error: 1(Exit value: 1) -&gt; [Help 1]</span><br></pre></td></tr></tbody></table></figure>
<h5 id="解决-2"><a href="#解决-2" class="headerlink" title="解决"></a>解决</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim apache-eagle-0.4.0-incubating-src/pom.xml</span><br><span class="line">　&lt;!--&lt;maven-scala.version&gt;2.15.0&lt;/maven-scala.version&gt;--&gt;</span><br><span class="line">　&lt;maven-scala.version&gt;2.15.2&lt;/maven-scala.version&gt;</span><br></pre></td></tr></tbody></table></figure>
<h4 id="rt-jar-is-broken"><a href="#rt-jar-is-broken" class="headerlink" title="rt.jar is broken"></a>rt.jar is broken</h4><h5 id="描述-2"><a href="#描述-2" class="headerlink" title="描述"></a>描述</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[ERROR] error: error <span class="keyword">while</span> loading AnnotatedElement, class file <span class="string">'D:\apps\Java\jd</span></span><br><span class="line"><span class="string">k1.8.0_111\jre\lib\rt.jar(java/lang/reflect/AnnotatedElement.class)'</span> is broken</span><br></pre></td></tr></tbody></table></figure>
<h5 id="解决-3"><a href="#解决-3" class="headerlink" title="解决"></a>解决</h5><p>　这个问题是因为 JDK 版本过高</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># windows</span></span><br><span class="line">$ <span class="built_in">set</span> JAVA_HOME=D:\apps\Java\jdk1.7.0_67</span><br><span class="line">$ <span class="built_in">set</span> MAVEN_HOME=D:\apps\maven\apache-maven-3.3.9</span><br><span class="line">$ <span class="built_in">set</span> PATH=%JAVA_HOME%\bin;%MAVEN_HOME%\bin;%PATH%</span><br><span class="line"><span class="comment"># set 命令只是临时改动，如需应用到系统变量，可以尝试 setx</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="参考-3"><a href="#参考-3" class="headerlink" title="参考"></a>参考</h5><ul>
<li><a href="http://stackoverflow.com/questions/26993101/switching-between-different-jdk-versions-in-windows">Switching between different JDK versions in Windows</a></li>
</ul>
<h4 id="eagle-webservice-编译失败"><a href="#eagle-webservice-编译失败" class="headerlink" title="eagle-webservice 编译失败"></a>eagle-webservice 编译失败</h4><h5 id="描述-3"><a href="#描述-3" class="headerlink" title="描述"></a>描述</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[ERROR] Failed to execute goal org.codehaus.mojo:<span class="built_in">exec</span>-maven-plugin:1.6.0:<span class="built_in">exec</span> (<span class="built_in">exec</span>-ui-install) on project eagle-webservice: Command execution failed. Cannot run program <span class="string">"bash"</span> (<span class="keyword">in</span> directory <span class="string">"F:\eagle\apache-eagle-0.4.0-incubating-src\eagle-webservice"</span>): CreateProcess error=2, ????????? -&gt; [Help 1]</span><br></pre></td></tr></tbody></table></figure>
<h5 id="解决-4"><a href="#解决-4" class="headerlink" title="解决"></a>解决</h5><p>　没有安装 NPM</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 安装完成后，设置环境变量</span></span><br><span class="line">$ <span class="built_in">set</span> NODE_HOME=D:\apps\nodejs\</span><br><span class="line">$ <span class="built_in">set</span> PATH=%NODE_HOME%;%PATH%</span><br></pre></td></tr></tbody></table></figure>
<h4 id="java-io-IOException-Cannot-run-program-“bash”"><a href="#java-io-IOException-Cannot-run-program-“bash”" class="headerlink" title="java.io.IOException: Cannot run program “bash”"></a>java.io.IOException: Cannot run program “bash”</h4><h5 id="解决-5"><a href="#解决-5" class="headerlink" title="解决"></a>解决</h5><p>　将 Git 的 bash.exe 目录配置到环境变量<br></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">set</span> PATH=D:\apps\Git\bin;%PATH%</span><br></pre></td></tr></tbody></table></figure><p></p>
<h5 id="参考-4"><a href="#参考-4" class="headerlink" title="参考"></a>参考</h5><ul>
<li><a href="http://stackoverflow.com/questions/15135771/hudson-on-windows-error-java-io-ioexception-cannot-run-program-sh">Hudson on Windows - Error: java.io.IOException: Cannot run program <code>sh</code></a></li>
</ul>
<h4 id="Npm-fetch-失败"><a href="#Npm-fetch-失败" class="headerlink" title="Npm fetch 失败"></a>Npm fetch 失败</h4><h5 id="解决-6"><a href="#解决-6" class="headerlink" title="解决"></a>解决</h5><p>　检查是否配置好代理<br></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ npm config <span class="built_in">set</span> proxy <span class="string">"http://10.19.110.55:8080/"</span></span><br><span class="line">$ npm config <span class="built_in">set</span> registry <span class="string">"https://registry.npm.taobao.org"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者修改配置</span></span><br><span class="line">$ vim C:\Users\BenedictJin\.npmrc</span><br><span class="line">  proxy=http://10.19.110.55:8080/</span><br><span class="line">  registry=https://registry.npm.taobao.org</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>　另外，如果 npm 调用了 bower 命令，仍然需要给 bower 进行代理设置<br></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ touch C:\Users\BenedictJin\.bowerrc</span><br><span class="line">$ vim C:\Users\BenedictJin\.bowerrc</span><br><span class="line">  {</span><br><span class="line">    <span class="string">"directory"</span>: <span class="string">"bower_components"</span>,</span><br><span class="line">    <span class="string">"proxy"</span>: <span class="string">"http://10.19.110.55:8080/"</span>,</span><br><span class="line">    <span class="string">"https-proxy"</span>:<span class="string">"http://10.19.110.55:8080/"</span>,</span><br><span class="line">    <span class="string">"no-proxy"</span>:<span class="string">"*.yuzhouwan.com"</span></span><br><span class="line">  }</span><br></pre></td></tr></tbody></table></figure><p></p>
<div class="note info">默认镜像地址：https://registry.npmjs.com/</div>


<h4 id="application-conf-No-such-file-or-directory"><a href="#application-conf-No-such-file-or-directory" class="headerlink" title="application.conf: No such file or directory"></a>application.conf: No such file or directory</h4><h5 id="描述-4"><a href="#描述-4" class="headerlink" title="描述"></a>描述</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ bin/eagle-service.sh start</span><br><span class="line">cp: cannot create regular file `bin/../lib/tomcat/webapps/eagle-service/WEB-INF/classes/application.conf<span class="string">': No such file or directory</span></span><br><span class="line"><span class="string">cp: cannot create regular file `bin/../lib/tomcat/webapps/eagle-service/WEB-INF/classes/'</span>: No such file or directory</span><br><span class="line">cp: cannot create regular file `bin/../lib/tomcat/webapps/eagle-service/WEB-INF/classes/<span class="string">': No such file or directory</span></span><br><span class="line"><span class="string">Starting eagle service ...</span></span><br><span class="line"><span class="string">Eagle service started.</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="解决-7"><a href="#解决-7" class="headerlink" title="解决"></a>解决</h5><p>　可能是没有将 <code>apache-eagle-0.4.0-incubating-src\eagle-webservice\target</code> 中的 <code>eagle-service.war</code> 正常解压<br>　考虑将 <code>eagle-service</code> 拷贝到 <code>/home/eagle/software/eagle/lib/tomcat/webapps/</code> 中</p>
<h3 id="BootStrap"><a href="#BootStrap" class="headerlink" title="BootStrap"></a>BootStrap</h3><h4 id="Invalid-message-received-with-signature-18245"><a href="#Invalid-message-received-with-signature-18245" class="headerlink" title="Invalid message received with signature 18245"></a>Invalid message received with signature 18245</h4><h5 id="描述-5"><a href="#描述-5" class="headerlink" title="描述"></a>描述</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 访问 http://eagle01:9099/eagle-service</span></span><br><span class="line">$ tail -f logs/eagle-service.2017-04-07.log</span><br><span class="line">  Apr 07, 2017 10:59:25 AM org.apache.coyote.ajp.AjpMessage processHeader</span><br><span class="line">SEVERE: Invalid message received with signature 18245</span><br></pre></td></tr></tbody></table></figure>
<h5 id="解决-8"><a href="#解决-8" class="headerlink" title="解决"></a>解决</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim /home/eagle/software/eagle/lib/tomcat/conf/server.xml</span><br><span class="line">  <span class="comment"># 如果这里没有指定 `AJP` 的 `address` 可访问地址，默认是所有机器都可访问，会报错安全问题，可以依据自己的需求配置好 `address` 来控制访问（这里因为是测试环境，直接绑定了 0.0.0.0 地址）</span></span><br><span class="line">  <span class="comment"># &lt;!-- Define an AJP 1.3 Connector on port 8009 --&gt;</span></span><br><span class="line">  <span class="comment"># &lt;Connector port="9009" protocol="AJP/1.3" redirectPort="9443" /&gt;</span></span><br><span class="line">  &lt;Connector port=<span class="string">"9009"</span> protocol=<span class="string">"AJP/1.3"</span> address=<span class="string">"0.0.0.0"</span> redirectPort=<span class="string">"9443"</span> /&gt;</span><br></pre></td></tr></tbody></table></figure>
<h5 id="参考-5"><a href="#参考-5" class="headerlink" title="参考"></a>参考</h5><ul>
<li><a href="https://www.mobibrw.com/2016/5480">Tomcat 7 使用 AJP 协议导致 AJP 端口被意外暴露给外网</a></li>
</ul>
<h3 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h3><h4 id="Host-eagle01-is-not-allowed-to-connect-to-this-MySQL-server"><a href="#Host-eagle01-is-not-allowed-to-connect-to-this-MySQL-server" class="headerlink" title="Host eagle01 is not allowed to connect to this MySQL server"></a>Host <code>eagle01</code> is not allowed to connect to this MySQL server</h4><h5 id="解决-9"><a href="#解决-9" class="headerlink" title="解决"></a>解决</h5><p>　远程连接 MySQL 服务实例的时候，如果当前主机没有响应权限，需要对其赋权</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ su - mysql</span><br><span class="line">$ mysql -uroot -p -S /home/mysql/data/mysql.sock</span><br><span class="line">  <span class="comment"># 允许用户 eagle 从 ip 为 192.168.1.30 的主机连接到 mysql 服务器的 eagle 数据库，并使用 eagle 作为密码</span></span><br><span class="line">  CREATE USER <span class="string">'eagle'</span>@<span class="string">'192.168.1.30'</span> IDENTIFIED BY <span class="string">'eagle'</span>;</span><br><span class="line">  GRANT ALL PRIVILEGES ON eagle.* TO <span class="string">'eagle'</span>@<span class="string">'192.168.1.30'</span> IDENTIFIED BY <span class="string">'eagle'</span> WITH GRANT OPTION;</span><br><span class="line">  FLUSH PRIVILEGES;</span><br></pre></td></tr></tbody></table></figure>
<h5 id="参考-6"><a href="#参考-6" class="headerlink" title="参考"></a>参考</h5><ul>
<li><a href="https://www.cnblogs.com/xyzdw/archive/2011/08/11/2135227.html">报错:1130-host … is not allowed to connect to this MySql server</a></li>
</ul>
<h4 id="Table-‘eagle-eagleapplicationdesc-eagleapplicationdesc’-doesn’t-exist"><a href="#Table-‘eagle-eagleapplicationdesc-eagleapplicationdesc’-doesn’t-exist" class="headerlink" title="Table ‘eagle.eagleapplicationdesc_eagleapplicationdesc’ doesn’t exist"></a>Table ‘eagle.eagleapplicationdesc_eagleapplicationdesc’ doesn’t exist</h4><h5 id="解决-10"><a href="#解决-10" class="headerlink" title="解决"></a>解决</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 现有的 19 张表</span></span><br><span class="line">$ show tables;</span><br><span class="line">+---------------------------------------------------+</span><br><span class="line">| Tables_in_eagle                                   |</span><br><span class="line">+---------------------------------------------------+</span><br><span class="line">| alertexecutor_alertexecutor                       |</span><br><span class="line">| alertstream_alertstream                           |</span><br><span class="line">| eagle_metadata_generic_resource                   |</span><br><span class="line">| eagle_metadata_topologyoperation                  |</span><br><span class="line">| eagle_metric                                      |</span><br><span class="line">| eaglefeaturedesc_eaglefeaturedesc                 |</span><br><span class="line">| eaglesiteapplication_eaglesiteapplication         |</span><br><span class="line">| eaglesitedesc_eaglesitedesc                       |</span><br><span class="line">| filesensitivity_filesensitivity                   |</span><br><span class="line">| hbaseresourcesensitivity_hbaseresourcesensitivity |</span><br><span class="line">| hdfsusercommandpattern_hdfsusercommandpattern     |</span><br><span class="line">| hiveresourcesensitivity_hiveresourcesensitivity   |</span><br><span class="line">| ipzone_ipzone                                     |</span><br><span class="line">| mlmodel_mlmodel                                   |</span><br><span class="line">| oozieresourcesensitivity_oozieresourcesensitivity |</span><br><span class="line">| serviceaudit_serviceaudit                         |</span><br><span class="line">| unittest_entityut                                 |</span><br><span class="line">| unittest_testtsentity                             |</span><br><span class="line">| userprofile_schedule_command                      |</span><br><span class="line">+---------------------------------------------------+</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发现 `eagle-examples/eagle-cassandra-example/bin/init.sh` 中存在该表</span></span><br><span class="line">$ cp eagle-examples/eagle-cassandra-example/bin/init.sh /home</span><br><span class="line"></span><br><span class="line">$ su - mysql</span><br><span class="line">$ mysql -uroot -p -S /home/mysql/data/mysql.sock</span><br><span class="line">  use eagle;</span><br><span class="line">  <span class="comment"># 创建 缺失的几张表</span></span><br><span class="line">  create table alertnotifications_alertnotifications(</span><br><span class="line">    `uuid` varchar(254) COLLATE utf8_bin NOT NULL,</span><br><span class="line">    `timestamp` bigint(20) DEFAULT NULL,</span><br><span class="line">    `notificationType` varchar(30000),</span><br><span class="line">    `enabled` tinyint(1) DEFAULT NULL,</span><br><span class="line">    `description` mediumtext,</span><br><span class="line">    `className` mediumtext,</span><br><span class="line">    `fields` mediumtext,</span><br><span class="line">    PRIMARY KEY (`uuid`),</span><br><span class="line">    UNIQUE KEY `uuid_UNIQUE` (`uuid`)</span><br><span class="line">  )ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin;</span><br><span class="line"></span><br><span class="line">  create table eagle_metadata_topologydescription(</span><br><span class="line">    `uuid` varchar(254) COLLATE utf8_bin NOT NULL,</span><br><span class="line">    `timestamp` bigint(20) DEFAULT NULL,</span><br><span class="line">    `topology` varchar(30000),</span><br><span class="line">    `description` mediumtext,</span><br><span class="line">    `exeClass` mediumtext,</span><br><span class="line">    `<span class="built_in">type</span>` mediumtext,</span><br><span class="line">    `version` mediumtext,</span><br><span class="line">    PRIMARY KEY (`uuid`),</span><br><span class="line">    UNIQUE KEY `uuid_UNIQUE` (`uuid`)</span><br><span class="line">  )ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin;</span><br><span class="line"></span><br><span class="line">  create table eagle_metadata_topologyexecution(</span><br><span class="line">    `uuid` varchar(254) COLLATE utf8_bin NOT NULL,</span><br><span class="line">    `timestamp` bigint(20) DEFAULT NULL,</span><br><span class="line">    site varchar(1024),</span><br><span class="line">    application varchar(1024),</span><br><span class="line">    topology varchar(1024),</span><br><span class="line">    environment varchar(1024),</span><br><span class="line">    status varchar(1024),</span><br><span class="line">    description varchar(1024),</span><br><span class="line">    lastmodifieddate bigint(20),</span><br><span class="line">    fullname varchar(1024),</span><br><span class="line">    url varchar(1024),</span><br><span class="line">    mode varchar(1024),</span><br><span class="line">    PRIMARY KEY (`uuid`),</span><br><span class="line">    UNIQUE KEY `uuid_UNIQUE` (`uuid`)</span><br><span class="line">  )ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin;</span><br><span class="line"></span><br><span class="line">  create table eagle_metric_dmeta(</span><br><span class="line">    `uuid` varchar(254) COLLATE utf8_bin NOT NULL,</span><br><span class="line">    `timestamp` bigint(20) DEFAULT NULL,</span><br><span class="line">    drillDownPaths mediumtext,</span><br><span class="line">    aggFunctions mediumtext,</span><br><span class="line">    defaultDownSamplingFunction mediumtext,</span><br><span class="line">    defaultAggregateFunction mediumtext,</span><br><span class="line">    resolutions mediumtext,</span><br><span class="line">    downSamplingFunctions mediumtext,</span><br><span class="line">    storeType mediumtext,</span><br><span class="line">    displayName mediumtext,</span><br><span class="line">    PRIMARY KEY (`uuid`),</span><br><span class="line">    UNIQUE KEY `uuid_UNIQUE` (`uuid`)</span><br><span class="line">  )ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="ZooKeeper-1"><a href="#ZooKeeper-1" class="headerlink" title="ZooKeeper"></a>ZooKeeper</h3><h4 id="Error-contacting-service-It-is-probably-not-running"><a href="#Error-contacting-service-It-is-probably-not-running" class="headerlink" title="Error contacting service. It is probably not running."></a>Error contacting service. It is probably not running.</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 可以通过增加 `start-foreground` 参数来排查失败原因</span></span><br><span class="line">$ bin/zkServer.sh start-foreground</span><br><span class="line">  ZooKeeper JMX enabled by default</span><br><span class="line">  Using config: /home/eagle/software/zookeeper/bin/../conf/zoo.cfg</span><br><span class="line">  Error: Could not find or load main class org.apache.zookeeper.server.quorum.QuorumPeerMain</span><br><span class="line"><span class="comment"># /home/eagle/software/zookeeper/zookeeper-3.4.10.jar 的问题，重新下载，校验 md5 正确后，再次安装即可</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="Hadoop-1"><a href="#Hadoop-1" class="headerlink" title="Hadoop"></a>Hadoop</h3><h4 id="端口冲突"><a href="#端口冲突" class="headerlink" title="端口冲突"></a>端口冲突</h4><h5 id="解决-11"><a href="#解决-11" class="headerlink" title="解决"></a>解决</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 修改默认端口（Hadoop 2.7.3）</span></span><br><span class="line">$ vim ~/software/hadoop/etc/hadoop/hdfs-site.xml</span><br><span class="line">&lt;configuration&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;dfs.namenode.http-address&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;0.0.0.0:50070&lt;/value&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></tbody></table></figure>
<h5 id="参考-7"><a href="#参考-7" class="headerlink" title="参考"></a>参考</h5><ul>
<li><a href="https://hadoop.apache.org/docs/r2.7.3/hadoop-project-dist/hadoop-hdfs/hdfs-default.xml">hadoop v2.7.3 hdfs-default.xml</a></li>
</ul>
<h3 id="HBase"><a href="#HBase" class="headerlink" title="HBase"></a>HBase</h3><h4 id="FAILED-LOOKUP-Can’t-get-master-address-from-ZooKeeper-znode-data-null"><a href="#FAILED-LOOKUP-Can’t-get-master-address-from-ZooKeeper-znode-data-null" class="headerlink" title="FAILED LOOKUP: Can’t get master address from ZooKeeper; znode data == null"></a>FAILED LOOKUP: Can’t get master address from ZooKeeper; znode data == null</h4><h5 id="描述-6"><a href="#描述-6" class="headerlink" title="描述"></a>描述</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">hbase(main):001:0&gt; zk_dump</span><br><span class="line">HBase is rooted at /hbase</span><br><span class="line">Active master address: &lt;&lt;FAILED LOOKUP: Can<span class="string">'t get master address from ZooKeeper; znode data == null&gt;&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="解决-12"><a href="#解决-12" class="headerlink" title="解决"></a>解决</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 检查 </span></span><br><span class="line">/home/eagle/software/hbase/bin/../logs/hbase-eagle-master-federation01.out</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查是否禁用了 HBase 自带的 ZooKeeper</span></span><br><span class="line">$ vim ~/software/hbase/conf/hbase-env.sh</span><br><span class="line">  <span class="comment"># Tell HBase whether it should manage it's own instance of ZooKeeper or not.</span></span><br><span class="line">  <span class="comment"># export HBASE_MANAGES_ZK=true</span></span><br><span class="line">  <span class="built_in">export</span> HBASE_MANAGES_ZK=<span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查是否正确在 `zookeeper.znode.parent` `/hbase` 目录下创建节点</span></span><br><span class="line">$ ~/software/zookeeper/bin/zkCli.sh -server eagle01:2181</span><br><span class="line">　[zk: localhost:2181(CONNECTED) 0] ls /hbase</span><br><span class="line">　[recovering-regions, splitWAL, rs, backup-masters, region-in-transition, draining, table, table-lock]</span><br></pre></td></tr></tbody></table></figure>
<h4 id="The-node-hbase-unsecure-is-not-in-ZooKeeper"><a href="#The-node-hbase-unsecure-is-not-in-ZooKeeper" class="headerlink" title="The node /hbase-unsecure is not in ZooKeeper"></a>The node /hbase-unsecure is not in ZooKeeper</h4><h5 id="解决-13"><a href="#解决-13" class="headerlink" title="解决"></a>解决</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim conf/hbase-site.xml</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;zookeeper.znode.parent&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;/hbase-unsecure&lt;/value&gt;</span><br><span class="line">  &lt;/property&gt;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Storm-1"><a href="#Storm-1" class="headerlink" title="Storm"></a>Storm</h3><h4 id="ResourceManager-unable-to-find-resource-‘templates-ALERT-DEFAULT-vm’-in-any-resource-loader"><a href="#ResourceManager-unable-to-find-resource-‘templates-ALERT-DEFAULT-vm’-in-any-resource-loader" class="headerlink" title="ResourceManager : unable to find resource ‘templates/ALERT_DEFAULT.vm’ in any resource loader"></a>ResourceManager : unable to find resource ‘templates/ALERT_DEFAULT.vm’ in any resource loader</h4><h5 id="描述-7"><a href="#描述-7" class="headerlink" title="描述"></a>描述</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim ~/software/storm/logs/worker-6703.log</span><br><span class="line">  2017-04-13T11:21:36.481+0800 o.a.velocity [ERROR] ResourceManager : unable to find resource <span class="string">'templates/ALERT_DEFAULT.vm'</span> <span class="keyword">in</span> any resource loader.</span><br><span class="line">  2017-04-13T11:21:36.487+0800 o.a.e.c.e.EagleMailClient [INFO] Send mail failed, got an AddressException: Illegal whitespace <span class="keyword">in</span> address</span><br><span class="line">  javax.mail.internet.AddressException: Illegal whitespace <span class="keyword">in</span> address</span><br><span class="line">          at javax.mail.internet.InternetAddress.checkAddress(InternetAddress.java:926) ~[stormjar.jar:na]</span><br><span class="line">          at javax.mail.internet.InternetAddress.parse(InternetAddress.java:819) ~[stormjar.jar:na]</span><br><span class="line">          at javax.mail.internet.InternetAddress.parse(InternetAddress.java:555) ~[stormjar.jar:na]</span><br><span class="line">          at javax.mail.internet.InternetAddress.&lt;init&gt;(InternetAddress.java:91) ~[stormjar.jar:na]</span><br><span class="line">          at org.apache.eagle.common.email.EagleMailClient._send(EagleMailClient.java:101) [stormjar.jar:na]</span><br><span class="line">          at org.apache.eagle.common.email.EagleMailClient.send(EagleMailClient.java:171) [stormjar.jar:na]</span><br><span class="line">          at org.apache.eagle.common.email.EagleMailClient.send(EagleMailClient.java:192) [stormjar.jar:na]</span><br><span class="line">          at org.apache.eagle.common.email.EagleMailClient.send(EagleMailClient.java:198) [stormjar.jar:na]</span><br><span class="line">          at org.apache.eagle.notification.email.AlertEmailSender.run(AlertEmailSender.java:162) [stormjar.jar:na]</span><br><span class="line">          at java.util.concurrent.Executors<span class="variable">$RunnableAdapter</span>.call(Executors.java:471) [na:1.7.0_80]</span><br><span class="line">          at java.util.concurrent.FutureTask.run(FutureTask.java:262) [na:1.7.0_80]</span><br><span class="line">          at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145) [na:1.7.0_80]</span><br><span class="line">          at java.util.concurrent.ThreadPoolExecutor<span class="variable">$Worker</span>.run(ThreadPoolExecutor.java:615) [na:1.7.0_80]</span><br><span class="line">          at java.lang.Thread.run(Thread.java:745) [na:1.7.0_80]</span><br></pre></td></tr></tbody></table></figure>
<h5 id="解决-14"><a href="#解决-14" class="headerlink" title="解决"></a>解决</h5><p>　从编译好的 <code>eagle-core</code> 组件中，找到 <code>eagle-alert/eagle-alert-notification-plugin/target/classes</code> 目录，将 <code>ALERT_DEFAULT.vm</code> 文件 copy 到 部署环境的 <code>/home/eagle/software/eagle/lib/tomcat/webapps/eagle-service/templates</code> 目录下</p>
<h5 id="参考-8"><a href="#参考-8" class="headerlink" title="参考"></a>参考</h5><ul>
<li><a href="http://stackoverflow.com/questions/36180753/getting-velocity-error-unable-to-find-resource-error-vm-in-any-resource-loade">Getting velocity error “unable to find resource ‘error.vm’ in any resource loader.””</a></li>
</ul>
<h3 id="LogStash-2"><a href="#LogStash-2" class="headerlink" title="LogStash"></a>LogStash</h3><h4 id="ArgumentError-The-“sincedb-path”-argument-must-point-to-a-file-received-a-directory"><a href="#ArgumentError-The-“sincedb-path”-argument-must-point-to-a-file-received-a-directory" class="headerlink" title="ArgumentError: The “sincedb_path” argument must point to a file, received a directory"></a>ArgumentError: The “sincedb_path” argument must point to a file, received a directory</h4><h5 id="解决-15"><a href="#解决-15" class="headerlink" title="解决"></a>解决</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">修改 `sincedb_path` 为一个文件</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Commit-cannot-be-completed-since-the-group-has-already-rebalanced-and-assigned-the-partitions-to-another-member"><a href="#Commit-cannot-be-completed-since-the-group-has-already-rebalanced-and-assigned-the-partitions-to-another-member" class="headerlink" title="Commit cannot be completed since the group has already rebalanced and assigned the partitions to another member"></a>Commit cannot be completed since the group has already rebalanced and assigned the partitions to another member</h4><h5 id="描述-8"><a href="#描述-8" class="headerlink" title="描述"></a>描述</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">WARN Auto offset commit failed <span class="keyword">for</span> group console-consumer-87542: Commit cannot be completed since the group has already rebalanced and assigned the partitions to another member. This means that the time between subsequent calls to poll() was longer than the configured max.poll.interval.ms, <span class="built_in">which</span> typically implies that the poll loop is spending too much time message processing. You can address this either by increasing the session timeout or by reducing the maximum size of batches returned <span class="keyword">in</span> poll() with max.poll.records. (org.apache.kafka.clients.consumer.internals.ConsumerCoordinator)</span><br></pre></td></tr></tbody></table></figure>
<h5 id="解决-16"><a href="#解决-16" class="headerlink" title="解决"></a>解决</h5><figure class="highlight"><table><tbody><tr><td class="code"><pre><span class="line">kafka {</span><br><span class="line">  codec =&gt; plain { format =&gt; "%{message}" }</span><br><span class="line">  bootstrap_servers =&gt; "eagle01:9092"</span><br><span class="line">  topic_id =&gt; "hbase_security_log"</span><br><span class="line">  batch_size =&gt; "1000"</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h5 id="参考-9"><a href="#参考-9" class="headerlink" title="参考"></a>参考</h5><ul>
<li><a href="https://www.elastic.co/guide/en/logstash/2.3/plugins-outputs-kafka.html#plugins-outputs-kafka-batch_size">Output plugins » kafka - batch_size</a></li>
</ul>
<h3 id="Eagle-1"><a href="#Eagle-1" class="headerlink" title="Eagle"></a>Eagle</h3><h4 id="java-lang-Exception-Exception-When-browsing-Files-in-HDFS-Message-java-net-UnknownHostException-sandbox-hortonworks-com"><a href="#java-lang-Exception-Exception-When-browsing-Files-in-HDFS-Message-java-net-UnknownHostException-sandbox-hortonworks-com" class="headerlink" title="java.lang.Exception:  Exception When browsing Files in HDFS .. Message :  java.net.UnknownHostException: sandbox.hortonworks.com"></a>java.lang.Exception:  Exception When browsing Files in HDFS .. Message :  java.net.UnknownHostException: sandbox.hortonworks.com</h4><h5 id="解决-17"><a href="#解决-17" class="headerlink" title="解决"></a>解决</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim conf/sandbox-hadoopjmx-pipeline.conf</span><br><span class="line">{</span><br><span class="line">  config {</span><br><span class="line">    envContextConfig {</span><br><span class="line">      <span class="string">"topologyName"</span> : <span class="string">"sandbox-hadoopjmx-pipeline"</span></span><br><span class="line">    }</span><br><span class="line">    eagleProps {</span><br><span class="line">      <span class="string">"site"</span> : <span class="string">"sandbox"</span></span><br><span class="line">      <span class="string">"application"</span>: <span class="string">"HADOOP"</span></span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  dataflow {</span><br><span class="line">    KafkaSource.hadoopNNJmxStream {</span><br><span class="line">      parallism = 1000</span><br><span class="line">      topic = <span class="string">"nn_jmx_metric_sandbox"</span></span><br><span class="line">      zkConnection = <span class="string">"localhost:2181"</span></span><br><span class="line">      zkConnectionTimeoutMS = 15000</span><br><span class="line">      consumerGroupId = <span class="string">"Consumer"</span></span><br><span class="line">      fetchSize = 1048586</span><br><span class="line">      transactionZKServers = <span class="string">"localhost"</span></span><br><span class="line">      transactionZKPort = 2181</span><br><span class="line">      transactionZKRoot = <span class="string">"/consumers"</span></span><br><span class="line">      transactionStateUpdateMS = 2000</span><br><span class="line">      deserializerClass = <span class="string">"org.apache.eagle.datastream.storm.JsonMessageDeserializer"</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    Alert.hadoopNNJmxStreamAlertExecutor {</span><br><span class="line">      upStreamNames = [hadoopNNJmxStream]</span><br><span class="line">      alertExecutorId = hadoopNNJmxStreamAlertExecutor</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    hadoopNNJmxStream -&gt; hadoopNNJmxStreamAlertExecutor{}</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"><span class="comment"># 修改其他配置 conf/sandbox-*</span></span><br><span class="line"><span class="comment"># 或者直接修改 /etc/hosts，添加 `127.0.0.1 sandbox.hortonworks.com`</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="sandbox-hortonworks-com-8020-failed-on-connection-exception"><a href="#sandbox-hortonworks-com-8020-failed-on-connection-exception" class="headerlink" title="sandbox.hortonworks.com:8020 failed on connection exception"></a>sandbox.hortonworks.com:8020 failed on connection exception</h4><h5 id="解决-18"><a href="#解决-18" class="headerlink" title="解决"></a>解决</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># http://eagle01:9099/eagle-service/ui/#/config/site</span></span><br><span class="line"><span class="comment"># 配置 Sites - Configuration - sandbox - Application - hdfsAuditLog</span></span><br><span class="line">classification.fs.defaultFS=hdfs://eagle01:9000</span><br><span class="line"><span class="comment"># 这里可以参考 core-site.xml 中的 fs.defaultFS 值</span></span><br><span class="line"><span class="comment"># 随后，`Save All`</span></span><br><span class="line"><span class="comment"># 访问 http://eagle01:9099/eagle-service/ui/#/classification/sensitivity，确认已生效</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="Topology-with-name-sandbox-hdfsAuditLog-topology-already-exists-on-cluster"><a href="#Topology-with-name-sandbox-hdfsAuditLog-topology-already-exists-on-cluster" class="headerlink" title="Topology with name sandbox-hdfsAuditLog-topology already exists on cluster"></a>Topology with name <code>sandbox-hdfsAuditLog-topology</code> already exists on cluster</h4><h5 id="解决-19"><a href="#解决-19" class="headerlink" title="解决"></a>解决</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ bin/eagle-topology.sh stop</span><br><span class="line"><span class="comment"># wait 30s(default) for `kill` command</span></span><br><span class="line">$ bin/eagle-topology.sh start</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Error-22-38-java-程序包-org-apache-eagle-service-hbase-不存在"><a href="#Error-22-38-java-程序包-org-apache-eagle-service-hbase-不存在" class="headerlink" title="Error:(22, 38) java: 程序包 org.apache.eagle.service.hbase 不存在"></a>Error:(22, 38) java: 程序包 org.apache.eagle.service.hbase 不存在</h4><h5 id="解决-20"><a href="#解决-20" class="headerlink" title="解决"></a>解决</h5><p>　本地运行单元测试 <code>TestHBaseWriteEntitiesPerformance</code> 的时候，报错 import 的某些包不存在</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 进入 Intellij Idea 的 Maven 配置界面，Setting - Maven - Repositeries</span></span><br><span class="line"><span class="comment"># 发现 repo.hortonworks.com &amp; repo.maven.apache.org 两个中央仓库 Update 的状态为 `Error`</span></span><br><span class="line"><span class="comment"># 点击 Update 进行更新</span></span><br></pre></td></tr></tbody></table></figure>
<p>　这里可能需要设置 Maven 的 Proxy 代理，详见我的另一篇博客《<a href="https://yuzhouwan.com/posts/2254/#Maven-Proxy">Maven 高级玩法</a>》</p>
<h2 id="社区跟进"><a href="#社区跟进" class="headerlink" title="社区跟进"></a>社区跟进</h2><ul>
<li><a href="https://issues.apache.org/jira/browse/EAGLE-981?jql=project%20%3D%20EAGLE%20AND%20reporter%20in%20(%22benedict%20jin%22)">Issues</a></li>
<li><a href="https://github.com/apache/eagle/pulls?utf8=%E2%9C%93&amp;q=is%3Apr%20author%3Aasdf2014%20">Pull Request</a></li>
</ul>
<p>　详见：《<a href="https://yuzhouwan.com/posts/19631/">如何成为 Apache 的 PMC</a>》</p>
<h2 id="资源"><a href="#资源" class="headerlink" title="资源"></a>资源</h2><h3 id="Doc"><a href="#Doc" class="headerlink" title="Doc"></a>Doc</h3><ul>
<li><a href="https://eagle.apache.org/docs/quick-start.html">Eagle Quick Start</a></li>
<li><a href="https://github.com/apache/eagle/blob/master/docs/docs/getting-started.md">getting-started.md</a></li>
<li><a href="https://eagle.apache.org/docs/deployment-env.html">Eagle Deploy Environment</a></li>
<li><a href="https://eagle.apache.org/docs/hbase-data-activity-monitoring.html">HBase Data Activity Monitoring</a></li>
<li><a href="https://eagle.apache.org/docs/index.html">Apache Eagle Introduction</a></li>
<li><a href="https://eagle.apache.org/docs/latest/">Apache Eagle Document</a></li>
</ul>
<h3 id="Blog"><a href="#Blog" class="headerlink" title="Blog"></a>Blog</h3><h4 id="Eagle-2"><a href="#Eagle-2" class="headerlink" title="Eagle"></a>Eagle</h4><ul>
<li><a href="http://blog.csdn.net/lookqlp/article/details/52355683">Apache Eagle 安装</a></li>
<li><a href="http://www.csdn.net/article/2015-10-29/2826076">Apache Eagle：eBay 开源分布式实时 Hadoop 数据安全方案</a></li>
</ul>
<h4 id="Hadoop-2"><a href="#Hadoop-2" class="headerlink" title="Hadoop"></a>Hadoop</h4><ul>
<li><a href="http://hadoop.apache.org/docs/r2.7.3/hadoop-project-dist/hadoop-hdfs/HDFSCommands.html">HDFS Commands Guide</a></li>
<li><a href="http://hadoop.apache.org/docs/r2.7.3/hadoop-project-dist/hadoop-common/FileSystemShell.html">FileSystemShell</a></li>
<li><a href="http://blog.csdn.net/u011281987/article/details/30034143">Hadoop 审计日志配置</a></li>
<li><a href="https://eagle.apache.org/docs/import-hdfs-auditLog.html">How to stream hdfs log data into Kafka</a></li>
</ul>
<h4 id="LogStash-3"><a href="#LogStash-3" class="headerlink" title="LogStash"></a>LogStash</h4><ul>
<li><a href="http://www.cnblogs.com/hanyifeng/p/5509985.html">Centos7 之安装 Logstash ELK stack 日志管理系统</a></li>
<li><a href="https://eagle.apache.org/docs/import-hdfs-auditLog.html">How to stream hdfs log data into Kafka</a></li>
</ul>
<h4 id="Kafka-2"><a href="#Kafka-2" class="headerlink" title="Kafka"></a>Kafka</h4><ul>
<li><a href="https://my.oschina.net/golang/blog/212769">CentOS 6 安装 Kafka 及使用一</a></li>
</ul>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt=""></a></td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>大数据</category>
      </categories>
      <tags>
        <tag>Apache Storm</tag>
        <tag>Apache Kafka</tag>
        <tag>Apache Hadoop</tag>
        <tag>Apache ZooKeeper</tag>
        <tag>ElasticSearch</tag>
        <tag>Apache Eagle</tag>
        <tag>Apache HBase</tag>
        <tag>Apache Yarn</tag>
        <tag>LogStash</tag>
      </tags>
  </entry>
  <entry>
    <title>Apache Superset 二次开发</title>
    <url>/posts/743/</url>
    <content><![CDATA[<h2 id="Apache-Superset-是什么？"><a href="#Apache-Superset-是什么？" class="headerlink" title="Apache Superset 是什么？"></a>Apache Superset 是什么？</h2><blockquote>
<p><strong><a href="https://superset.apache.org/">Apache Superset</a></strong>™ is a modern data exploration and visualization platform.</p>
</blockquote>
<h2 id="基础组件"><a href="#基础组件" class="headerlink" title="基础组件"></a>基础组件</h2><h3 id="Flask"><a href="#Flask" class="headerlink" title="Flask"></a>Flask</h3><p>　<a href="https://yuzhouwan.com/posts/43687/">Python</a> 几大著名 Web 框架之一，以其轻量级，高可扩展性而著名</p>
<ul>
<li><p>Jinja2<br>  模板引擎</p>
</li>
<li><p>Werkzeug<br>  WSGI 工具集</p>
</li>
</ul>
<h3 id="Gunicorn"><a href="#Gunicorn" class="headerlink" title="Gunicorn"></a>Gunicorn</h3><p>　Gunicorn 是一个开源的 Python WSGI HTTP 服务器，移植于 Ruby 的 Unicorn 项目的采用 pre-fork 模式的服务器</p>
<h4 id="WSGI"><a href="#WSGI" class="headerlink" title="WSGI"></a>WSGI</h4><p>　WSGI，即 Python <strong>W</strong>eb <strong>S</strong>erver <strong>G</strong>ateway <strong>I</strong>nterface，是专门用于 Python 应用程序或框架与 Web 服务器之间的一种接口，没有官方的实现，因为 WSGI 更像一个协议，只要遵照这些协议，WSGI 应用都可以在 任何服务器上运行，反之亦然</p>
<h4 id="Pre-Fork"><a href="#Pre-Fork" class="headerlink" title="Pre-Fork"></a>Pre-Fork</h4><p>　一个进程处理一个请求，基于 select 模型，所以最多一次创建 1024 个进程<br>　预先创建进程，pre-fork 采用的是预派生子进程方式，用子进程处理不同的请求，每个请求对应一个子进程，进程之间是彼此独立的<br>　一定程度上加快了进程的响应速度</p>
<a id="more"></a>
<h3 id="Django"><a href="#Django" class="headerlink" title="Django"></a>Django</h3><p>　Django 是一个开放源代码的 Web 应用框架，由 Python 写成。采用了 MVC 的软件设计模式，使得开发复杂的、数据库驱动的网站变得简单<br>　Django 注重组件的重用性和”可插拔性”，敏捷开发和 DRY 法则（Do not Repeat Yourself）</p>
<p>　核心组件</p>
<ul>
<li>物件导向的映射器，用作数据模型（以 Python 类的形式定义）和 关联性数据库间的媒介</li>
<li>基于正则表达式的 URL 分发器</li>
<li>视图系统，用于处理请求</li>
<li>模板系统</li>
</ul>
<h3 id="PyDruid"><a href="#PyDruid" class="headerlink" title="PyDruid"></a>PyDruid</h3><p>　A Python connector for Druid<br>　Exposes a simple API to create, execute, and analyze Druid queries</p>
<h3 id="Pandas"><a href="#Pandas" class="headerlink" title="Pandas"></a>Pandas</h3><p>　Pandas is a Python package providing fast, flexible, and expressive data structures designed to make working with “relational” or “labeled” data both easy and intuitive</p>
<h3 id="SciPy"><a href="#SciPy" class="headerlink" title="SciPy"></a>SciPy</h3><p>　SciPy 是基于 Numpy 构建的一个集成了多种数学算法和方便的函数的 Python 模块</p>
<h3 id="Scikit-learn"><a href="#Scikit-learn" class="headerlink" title="Scikit-learn"></a>Scikit-learn</h3><p>　Machine Learning in Python</p>
<h3 id="D3-js"><a href="#D3-js" class="headerlink" title="D3.js"></a>D3.js</h3><p>　<a href="https://d3js.org/">D3.js</a> 是一个操纵数据的 JavaScript 库</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h3 id="基础环境"><a href="#基础环境" class="headerlink" title="基础环境"></a>基础环境</h3><h4 id="OS"><a href="#OS" class="headerlink" title="OS"></a>OS</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ uname -a</span><br><span class="line">Linux 2.6.32-431.el6.x86_64 <span class="comment">#1 SMP Fri Nov 22 03:15:09 UTC 2013 x86_64 x86_64 x86_64 GNU/Linux</span></span><br><span class="line"></span><br><span class="line">$ cat /proc/version</span><br><span class="line">Linux version 2.6.32-431.el6.x86_64 (mockbuild@c6b8.bsys.dev.centos.org) (gcc version 4.4.7 20120313 (Red Hat 4.4.7-4) (GCC) ) <span class="comment">#1 SMP Fri Nov 22 03:15:09 UTC 2013</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># For Fedora and RHEL-derivatives</span></span><br><span class="line"><span class="comment"># [Doc]: Other System https://superset.apache.org/installation.html#os-dependencies</span></span><br><span class="line">$ sudo yum upgrade python-setuptools -y</span><br><span class="line">$ sudo yum install gcc libffi-devel python-devel python-pip python-wheel openssl-devel libsasl2-devel openldap-devel -y</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Machines"><a href="#Machines" class="headerlink" title="Machines"></a>Machines</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 外网（http://192.168.1.10:9097/）</span></span><br><span class="line">superset01		               192.168.1.10           Superset</span><br><span class="line">druid01		        	       192.168.1.11           Druid</span><br><span class="line">druid02		        	       192.168.1.12           MySQL</span><br><span class="line"></span><br><span class="line"><span class="comment"># Cluster 配置</span></span><br><span class="line">Cluster                         druid cluster</span><br><span class="line">Coordinator Host                192.168.1.11</span><br><span class="line">Coordinator Port                8081</span><br><span class="line">Coordinator Endpoint            druid/coordinator/v1/metadata</span><br><span class="line">Broker Host                     192.168.1.13</span><br><span class="line">Broker Port                     8082</span><br><span class="line">Broker Endpoint                 druid/v2</span><br><span class="line">Cache Timeout                   86400				<span class="comment"># 1day: result_backend</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 线上（http://192.168.2.10:9097）</span></span><br><span class="line">druid-prd01	                    192.168.2.10         Superset</span><br><span class="line">druid-prd02	                    192.168.2.11         Druid</span><br><span class="line"></span><br><span class="line"><span class="comment"># Cluster 配置</span></span><br><span class="line">Cluster                         druid cluster</span><br><span class="line">Coordinator Host                192.168.2.11</span><br><span class="line">Coordinator Port                8081</span><br><span class="line">Coordinator Endpoint            druid/coordinator/v1/metadata</span><br><span class="line">Broker Host                     192.168.2.13</span><br><span class="line">Broker Port                     8082</span><br><span class="line">Broker Endpoint                 druid/v2</span><br><span class="line">Cache Timeout                   86400                 <span class="comment"># 1day: result_backend</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="Python-相关"><a href="#Python-相关" class="headerlink" title="Python 相关"></a>Python 相关</h3><h4 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ python --version</span><br><span class="line">  Python 2.7.8</span><br><span class="line"></span><br><span class="line">[Note]: Superset is tested using Python 2.7 and Python 3.4+. Python 3 is the recommended version, Python 2.6 won<span class="string">'t be supported.'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 升级 Python（stable: Python 2.7.12 | 3.4.5, lastest: Python 3.5.2 [2016/12/15]）</span></span><br><span class="line">https://www.python.org/downloads/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 python ftp 服务器中下载到，对应版本的 python</span></span><br><span class="line">$ wget http://python.org/ftp/python/2.7.12/Python-2.7.12.tgz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译</span></span><br><span class="line">$ tar -zxvf Python-2.7.12.tgz</span><br><span class="line">$ <span class="built_in">cd</span> /root/software/Python-2.7.12</span><br><span class="line">$ ./configure --prefix=/usr/<span class="built_in">local</span>/python27</span><br><span class="line">$ make</span><br><span class="line">$ make install</span><br><span class="line"></span><br><span class="line">$ ls /usr/<span class="built_in">local</span>/python27/ -al</span><br><span class="line"></span><br><span class="line">  drwxr-xr-x.  6 root root 4096 12月 15 14:22 .</span><br><span class="line">  drwxr-xr-x. 13 root root 4096 12月 15 14:20 ..</span><br><span class="line">  drwxr-xr-x.  2 root root 4096 12月 15 14:22 bin</span><br><span class="line">  drwxr-xr-x.  3 root root 4096 12月 15 14:21 include</span><br><span class="line">  drwxr-xr-x.  4 root root 4096 12月 15 14:22 lib</span><br><span class="line">  drwxr-xr-x.  3 root root 4096 12月 15 14:22 share</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 覆盖原来的 python6</span></span><br><span class="line">$ <span class="built_in">which</span> python</span><br><span class="line">  /usr/<span class="built_in">local</span>/bin/python</span><br><span class="line"><span class="comment"># mv /usr/bin/python /usr/bin/python_old</span></span><br><span class="line">$ mv /usr/<span class="built_in">local</span>/bin/python /usr/<span class="built_in">local</span>/bin/python_old</span><br><span class="line">$ ln -s /usr/<span class="built_in">local</span>/python27/bin/python /usr/<span class="built_in">local</span>/bin/</span><br><span class="line">$ python --version</span><br><span class="line">  Python 2.7.12</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 yum 引用的 python 版本为旧版 2.6 的 python</span></span><br><span class="line">$ vim /usr/bin/yum</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 第一行修改为 python2.6</span></span><br><span class="line">  <span class="comment">#!/usr/bin/python2.6</span></span><br><span class="line"></span><br><span class="line">$ yum --version | sed <span class="string">'2,$d'</span></span><br><span class="line">  3.2.29</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Pip"><a href="#Pip" class="headerlink" title="Pip"></a>Pip</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ pip --version</span><br><span class="line">$ pip 9.0.1 from /usr/<span class="built_in">local</span>/lib/python2.7/site-packages (python 2.7)</span><br><span class="line"></span><br><span class="line"><span class="comment"># upgrade setup tools and pip</span></span><br><span class="line">$ pip install --upgrade setuptools pip</span><br><span class="line"></span><br><span class="line"><span class="comment">## Offline 环境下安装 pip</span></span><br><span class="line"><span class="comment"># https://pypi.python.org/pypi/setuptools#code-of-conduct 下载 setuptools-32.0.0.tar.gz</span></span><br><span class="line">$ tar zxvf setuptools-32.0.0.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> setuptools-32.0.0</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> setuptools-32.0.0</span><br><span class="line">$ python setup.py install</span><br><span class="line"></span><br><span class="line"><span class="comment"># https://pypi.python.org/pypi/pip 下载 pip-9.0.1.tar.gz</span></span><br><span class="line">$ wget --no-check-certificate https://pypi.python.org/packages/11/b6/abcb525026a4be042b486df43905d6893fb04f05aac21c32c638e939e447/pip-9.0.1.tar.gz<span class="comment">#md5=35f01da33009719497f01a4ba69d63c9</span></span><br><span class="line">$ tar zxvf pip-9.0.1.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> pip-9.0.1</span><br><span class="line">$ python setup.py install</span><br><span class="line">  Installed /usr/<span class="built_in">local</span>/python27/lib/python2.7/site-packages/pip-9.0.1-py2.7.egg</span><br><span class="line">  Processing dependencies <span class="keyword">for</span> pip==9.0.1</span><br><span class="line">  Finished processing dependencies <span class="keyword">for</span> pip==9.0.1</span><br><span class="line"></span><br><span class="line">$ pip --version</span><br><span class="line">  pip 9.0.1 from /root/software/pip-9.0.1 (python 2.7)</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Virtualenv"><a href="#Virtualenv" class="headerlink" title="Virtualenv"></a>Virtualenv</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ pip install virtualenv</span><br><span class="line"></span><br><span class="line"><span class="comment"># virtualenv is shipped in Python 3 as pyvenv</span></span><br><span class="line">$ virtualenv venv</span><br><span class="line">$ <span class="built_in">source</span> venv/bin/activate</span><br><span class="line"></span><br><span class="line"><span class="comment">## Offline 环境下安装 virtualenv</span></span><br><span class="line"><span class="comment"># https://pypi.python.org/pypi/virtualenv#downloads 下载 virtualenv-15.1.0.tar.gz</span></span><br><span class="line">$ tar zxvf virtualenv-15.1.0.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> virtualenv-15.1.0</span><br><span class="line">$ python setup.py install</span><br><span class="line"></span><br><span class="line">$ virtualenv --version</span><br><span class="line">  15.1.0</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Superset-相关"><a href="#Superset-相关" class="headerlink" title="Superset 相关"></a>Superset 相关</h3><h4 id="Superset-初始化"><a href="#Superset-初始化" class="headerlink" title="Superset 初始化"></a>Superset <a href="https://superset.incubator.apache.org/installation.html#making-your-own-build">初始化</a></h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ pip install superset</span><br><span class="line"></span><br><span class="line"><span class="comment">## Offline 环境下安装 superset</span></span><br><span class="line"><span class="comment"># https://pypi.python.org/pypi/superset 下载 superset-0.15.0.tar.gz</span></span><br><span class="line">$ tar zxvf superset-0.15.0.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> superset-0.15.0</span><br><span class="line">$ python setup.py install</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create an admin user</span></span><br><span class="line">$ fabmanager create-admin --app superset</span><br><span class="line"></span><br><span class="line">  Username [admin]:        <span class="comment"># login name</span></span><br><span class="line">  User first name [admin]: <span class="comment"># first name</span></span><br><span class="line">  User last name [user]:   <span class="comment"># lastname</span></span><br><span class="line">  Email [admin@fab.org]:   <span class="comment"># email, must unique</span></span><br><span class="line">  Password: </span><br><span class="line">  Repeat <span class="keyword">for</span> confirmation: </span><br><span class="line">  Error: the two entered values <span class="keyword">do</span> not match</span><br><span class="line">  Password:			 	<span class="comment">#superset</span></span><br><span class="line">  Repeat <span class="keyword">for</span> confirmation: <span class="comment">#superset</span></span><br><span class="line">  // ...</span><br><span class="line">  Recognized Database Authentications.</span><br><span class="line">  2016-12-14 17:53:40,945:INFO:flask_appbuilder.security.sqla.manager:Added user superset db upgrade</span><br><span class="line">  Admin User superset db upgrade created.</span><br><span class="line"></span><br><span class="line"><span class="comment"># Initialize the database</span></span><br><span class="line">$ superset db upgrade</span><br><span class="line"></span><br><span class="line">  // ...</span><br><span class="line">  INFO  [alembic.runtime.migration] Context impl SQLiteImpl.</span><br><span class="line">  INFO  [alembic.runtime.migration] Will assume transactional DDL.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Load some data to play with</span></span><br><span class="line">$ superset load_examples</span><br><span class="line"></span><br><span class="line">  Loading examples into &lt;SQLA engine=u<span class="string">'sqlite:////root/.superset/superset.db'</span>&gt;</span><br><span class="line">  Creating default CSS templates</span><br><span class="line">  Loading energy related dataset</span><br><span class="line">  Creating table [wb_health_population] reference</span><br><span class="line">  2016-12-14 17:58:09,568:INFO:root:Creating database reference</span><br><span class="line">  2016-12-14 17:58:09,575:INFO:root:sqlite:////root/.superset/superset.db</span><br><span class="line">  Loading [World Bank<span class="string">'s Health Nutrition and Population Stats]'</span></span><br><span class="line">  Creating table [wb_health_population] reference</span><br><span class="line">  2016-12-14 17:58:30,840:INFO:root:Creating database reference</span><br><span class="line">  2016-12-14 17:58:30,846:INFO:root:sqlite:////root/.superset/superset.db</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Create default roles and permissions</span></span><br><span class="line">$ superset init</span><br><span class="line"></span><br><span class="line">  Loading examples into &lt;SQLA engine=u<span class="string">'sqlite:////root/.superset/superset.db'</span>&gt;</span><br><span class="line">  Creating default CSS templates</span><br><span class="line">  Loading energy related dataset</span><br><span class="line">  Creating table [wb_health_population] reference</span><br><span class="line">  2016-12-14 17:58:09,568:INFO:root:Creating database reference</span><br><span class="line">  2016-12-14 17:58:09,575:INFO:root:sqlite:////root/.superset/superset.db</span><br><span class="line">  Loading [World Bank<span class="string">'s Health Nutrition and Population Stats]</span></span><br><span class="line"><span class="string">  Creating table [wb_health_population] reference</span></span><br><span class="line"><span class="string">  2016-12-14 17:58:30,840:INFO:root:Creating database reference</span></span><br><span class="line"><span class="string">  2016-12-14 17:58:30,846:INFO:root:sqlite:////root/.superset/superset.db</span></span><br><span class="line"><span class="string">  Creating slices</span></span><br><span class="line"><span class="string">  Creating a World'</span>s Health Bank dashboard</span><br><span class="line">  Loading [Birth names]</span><br><span class="line">  Done loading table!</span><br><span class="line">  --------------------------------------------------------------------------------</span><br><span class="line">  Creating table [birth_names] reference</span><br><span class="line">  2016-12-14 17:58:52,276:INFO:root:Creating database reference</span><br><span class="line">  2016-12-14 17:58:52,280:INFO:root:sqlite:////root/.superset/superset.db</span><br><span class="line">  Creating some slices</span><br><span class="line">  Creating a dashboard</span><br><span class="line">  Loading [Random time series data]</span><br><span class="line">  Done loading table!</span><br><span class="line">  --------------------------------------------------------------------------------</span><br><span class="line">  Creating table [random_time_series] reference</span><br><span class="line">  2016-12-14 17:58:53,953:INFO:root:Creating database reference</span><br><span class="line">  2016-12-14 17:58:53,957:INFO:root:sqlite:////root/.superset/superset.db</span><br><span class="line">  Creating a slice</span><br><span class="line">  Loading [Random long/lat data]</span><br><span class="line">  Done loading table!</span><br><span class="line">  --------------------------------------------------------------------------------</span><br><span class="line">  Creating table reference</span><br><span class="line">  2016-12-14 17:59:09,732:INFO:root:Creating database reference</span><br><span class="line">  2016-12-14 17:59:09,736:INFO:root:sqlite:////root/.superset/superset.db</span><br><span class="line">  Creating a slice</span><br><span class="line">  Loading [Multiformat time series]</span><br><span class="line">  Done loading table!</span><br><span class="line">  --------------------------------------------------------------------------------</span><br><span class="line">  Creating table [multiformat_time_series] reference</span><br><span class="line">  2016-12-14 17:59:10,421:INFO:root:Creating database reference</span><br><span class="line">  2016-12-14 17:59:10,426:INFO:root:sqlite:////root/.superset/superset.db</span><br><span class="line">  Creating some slices</span><br><span class="line">  Loading [Misc Charts] dashboard</span><br><span class="line">  Creating the dashboard</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Start the web server on port 8088</span></span><br><span class="line">$ superset runserver -p 8088</span><br><span class="line"></span><br><span class="line"><span class="comment"># To start a development web server, use the -d switch</span></span><br><span class="line"><span class="comment"># superset runserver -d</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Refresh Druid Datasource (after config it)</span></span><br><span class="line">$ superset refresh_druid</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Virtualenv-工作空间"><a href="#Virtualenv-工作空间" class="headerlink" title="Virtualenv 工作空间"></a>Virtualenv 工作空间</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># superset01 192.168.1.10</span></span><br><span class="line">$ <span class="built_in">cd</span> root</span><br><span class="line">$ virtualenv -p /usr/<span class="built_in">local</span>/bin/python --system-site-packages --always-copy superset</span><br><span class="line">$ <span class="built_in">source</span> superset/bin/activate</span><br><span class="line"></span><br><span class="line"><span class="comment"># 详见下文 `遇到的坑` - `安装 superset 需要下载依赖库` 部分</span></span><br><span class="line"><span class="comment"># 旧版</span></span><br><span class="line"><span class="comment"># pip install --download package -r requirements.txt</span></span><br><span class="line"><span class="comment"># 新版 (v19.0.3)</span></span><br><span class="line"><span class="comment"># pip download -d package -r requirements.txt</span></span><br><span class="line">$ pip install -r /root/requirements.txt</span><br><span class="line"></span><br><span class="line">$ superset runserver -a 0.0.0.0 -p 8088</span><br><span class="line"></span><br><span class="line"><span class="comment"># 建议使用 rsync，详见 `部署上线` 部分</span></span><br><span class="line">$ <span class="built_in">cd</span> /root</span><br><span class="line">$ tar zcvf virtualenv.tar.gz virtualenv/</span><br><span class="line">$ scp virtualenv.tar.gz root@192.168.1.13:/root/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 192.168.1.13</span></span><br><span class="line">$ <span class="built_in">cd</span> /root/virtualenv/superset</span><br><span class="line">$ <span class="built_in">source</span> bin/activate</span><br></pre></td></tr></tbody></table></figure>
<h4 id="VirtualenvWrapper"><a href="#VirtualenvWrapper" class="headerlink" title="VirtualenvWrapper"></a>VirtualenvWrapper</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">## 【拓展】</span></span><br><span class="line"><span class="comment"># virtualenvwrapper 是 virtualenv 的扩展工具，可以方便的创建、删除、复制、切换不同的虚拟环境</span></span><br><span class="line">$ pip install virtualenvwrapper</span><br><span class="line">$ mkdir ~/workspaces</span><br><span class="line">$ vim ~/.bashrc</span><br><span class="line">  <span class="comment"># 增加</span></span><br><span class="line">  <span class="built_in">export</span> WORKON_HOME=~/virtualenv</span><br><span class="line">  <span class="built_in">source</span> /usr/<span class="built_in">local</span>/bin/virtualenvwrapper.sh</span><br><span class="line"></span><br><span class="line">$ mkvirtualenv --python=/usr/bin/python superset</span><br><span class="line">  Running virtualenv with interpreter /usr/bin/python</span><br><span class="line">  New python executable <span class="keyword">in</span> /root/virtualenv/superset/bin/python</span><br><span class="line">  Installing setuptools, pip, wheel...done.</span><br><span class="line">  virtualenvwrapper.user_scripts creating /root/virtualenv/superset/bin/predeactivate</span><br><span class="line">  virtualenvwrapper.user_scripts creating /root/virtualenv/superset/bin/postdeactivate</span><br><span class="line">  virtualenvwrapper.user_scripts creating /root/virtualenv/superset/bin/preactivate</span><br><span class="line">  virtualenvwrapper.user_scripts creating /root/virtualenv/superset/bin/postactivate</span><br><span class="line">  virtualenvwrapper.user_scripts creating /root/virtualenv/superset/bin/get_env_details</span><br><span class="line">(superset) [root@superset01 virtualenv]<span class="comment"># </span></span><br><span class="line">(superset) [root@superset01 virtualenv]<span class="comment"># deactivate</span></span><br><span class="line"></span><br><span class="line">$ workon superset</span><br><span class="line">(superset) [root@superset01 virtualenv]<span class="comment"># lsvirtualenv -b</span></span><br><span class="line">superset</span><br></pre></td></tr></tbody></table></figure>
<h3 id="部署上线"><a href="#部署上线" class="headerlink" title="部署上线"></a>部署上线</h3><h4 id="拷贝"><a href="#拷贝" class="headerlink" title="拷贝"></a>拷贝</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># rsync 替换 scp 可以确保软链接 也能被 cp</span></span><br><span class="line">$ rsync -avuz -e ssh /home/superset/superset-0.15.4/ yuzhouwan@middle:/home/yuzhouwan/superset-0.15.4</span><br><span class="line"></span><br><span class="line">  //...</span><br><span class="line">  sent 142935894 bytes  received 180102 bytes  3920986.19 bytes/sec</span><br><span class="line">  total size is 359739823  speedup is 2.51</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 本机 和 目标机器 的 superset 目录下校验文件数量</span></span><br><span class="line">$ find | wc -l</span><br><span class="line">  10113</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重复以上步骤，从跳板机 rsync 到线上机器</span></span><br><span class="line">$ rsync -avuz -e ssh /home/yuzhouwan/superset-0.15.4/ root@192.168.2.10:/home/superset/superset-0.15.4</span><br><span class="line"></span><br><span class="line"><span class="comment"># virtualenv 创建依赖的 python</span></span><br><span class="line">$ rsync -avuz -e ssh /root/software yuzhouwan@middle:/home/yuzhouwan</span><br><span class="line">$ rsync -avuz -e ssh /home/yuzhouwan/software root@druid-prd01:/root</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> /root/software</span><br><span class="line">$ tar zxvf Python-2.7.12.tgz</span><br><span class="line">$ <span class="built_in">cd</span> Python-2.7.12</span><br><span class="line"></span><br><span class="line">$ ./configure --prefix=/usr --<span class="built_in">enable</span>-shared CFLAGS=-fPIC</span><br><span class="line">$ make &amp;&amp; make install</span><br><span class="line">$ /sbin/ldconfig -v | grep /		<span class="comment"># nessnary!!</span></span><br><span class="line">$ python -V</span><br><span class="line">  Python 2.7.12</span><br></pre></td></tr></tbody></table></figure>
<h4 id="动态链接库"><a href="#动态链接库" class="headerlink" title="动态链接库"></a>动态链接库</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 虽然软链接已经 rsync 过来了，但是 目标机器相关目录下，没有对应的 Python 的动态链接库</span></span><br><span class="line">$ file /root/superset/lib/python2.7/lib-dynload</span><br><span class="line"></span><br><span class="line">  /root/superset/lib/python2.7/lib-dynload: broken symbolic link to `/usr/<span class="built_in">local</span>/python27/lib/python2.7/lib-dynload`</span><br><span class="line"></span><br><span class="line"><span class="comment"># 需要和联网环境中，创建 VirtualEnv 时的 Python 全局环境一致</span></span><br><span class="line">$ ./configure --prefix=/usr/<span class="built_in">local</span>/python27 --<span class="built_in">enable</span>-shared CFLAGS=-fPIC</span><br><span class="line">$ make &amp;&amp; make install</span><br><span class="line">$ /sbin/ldconfig -v | grep /</span><br><span class="line"></span><br><span class="line">$ ls /usr/<span class="built_in">local</span>/python27/lib/python2.7/lib-dynload -sail</span><br></pre></td></tr></tbody></table></figure>
<h4 id="用户权限"><a href="#用户权限" class="headerlink" title="用户权限"></a>用户权限</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 创建用户</span></span><br><span class="line">$ adduser superset</span><br><span class="line">$ <span class="built_in">cd</span> /home/superset</span><br><span class="line"><span class="comment"># 如果存在版本号，需要创建 软链接</span></span><br><span class="line">$ chown -R superset:superset superset-0.15.4</span><br><span class="line">$ ln -s superset-0.15.4 superset</span><br><span class="line"></span><br><span class="line">$ chown -h superset:superset superset</span><br><span class="line">$ su - superset</span><br></pre></td></tr></tbody></table></figure>
<h4 id="元数据存储"><a href="#元数据存储" class="headerlink" title="元数据存储"></a>元数据存储</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 修改数据库</span></span><br><span class="line">$ vim ./lib/python2.7/site-packages/superset/config.py</span><br><span class="line"></span><br><span class="line">  <span class="comment"># SQLALCHEMY_DATABASE_URI = 'sqlite:///' + os.path.join(DATA_DIR, 'superset.db')</span></span><br><span class="line">  SQLALCHEMY_DATABASE_URI = <span class="string">'mysql+pymysql://user:password@mysql01:3306/superset1?charset=utf8'</span></span><br><span class="line"></span><br><span class="line">$ mysql -hmysql01 -p3306 -uuser -ppassword</span><br><span class="line">&gt; use superset1;</span><br><span class="line">&gt; show tables;</span><br><span class="line">  +-------------------------+</span><br><span class="line">  | Tables_in_superset1     |</span><br><span class="line">  +-------------------------+</span><br><span class="line">  | ab_permission           |</span><br><span class="line">  | ...                     |</span><br><span class="line">  | url                     |</span><br><span class="line">  +-------------------------+</span><br><span class="line">  28 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="comment"># mysqldump -hmysql01 -p3306 -uuser -ppassword superset1 &gt; superset1.sql</span></span><br><span class="line">$ mysqldump -hmysql01 -p3306 -uuser -ppassword --single-transaction superset1 &gt; superset1.sql</span><br></pre></td></tr></tbody></table></figure>
<h4 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/superset/superset-0.15.4</span><br><span class="line">$ <span class="built_in">source</span> bin/activate</span><br><span class="line">$ mkdir logs</span><br><span class="line">$ nohup superset runserver -a 0.0.0.0 -p 9097 2&gt;&amp;1 -w 4 &gt; logs/superset.log &amp;</span><br></pre></td></tr></tbody></table></figure>
<h2 id="本地运行"><a href="#本地运行" class="headerlink" title="本地运行"></a>本地运行</h2><h3 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h3><h4 id="Windows-相关"><a href="#Windows-相关" class="headerlink" title="Windows 相关"></a>Windows 相关</h4><h5 id="Microsoft-Visual-C-9-0-is-required-Unable-to-find-vcvarsall-bat"><a href="#Microsoft-Visual-C-9-0-is-required-Unable-to-find-vcvarsall-bat" class="headerlink" title="Microsoft Visual C++ 9.0 is required (Unable to find vcvarsall.bat)"></a>Microsoft Visual C++ 9.0 is required (Unable to find vcvarsall.bat)</h5><h6 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h6><p>　error: Microsoft Visual C++ 9.0 is required (Unable to find vcvarsall.bat). Get it from <a href="http://aka.ms/vcpython27">http://aka.ms/vcpython27</a></p>
<h6 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ pip install wheel setuptools</span><br><span class="line"><span class="comment"># VCForPython27.msi 下载安装</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="‘openssl-opensslv-h’-No-such-file-or-directory"><a href="#‘openssl-opensslv-h’-No-such-file-or-directory" class="headerlink" title="‘openssl/opensslv.h’: No such file or directory"></a>‘openssl/opensslv.h’: No such file or directory</h5><h6 id="解决-1"><a href="#解决-1" class="headerlink" title="解决"></a>解决</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># download openssl-0.9.8h-1-setup.exe from http://gnuwin32.sourceforge.net/packages/openssl.htm</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="Cannot-open-include-file-‘stdint-h’-No-such-file-or-directory"><a href="#Cannot-open-include-file-‘stdint-h’-No-such-file-or-directory" class="headerlink" title="Cannot open include file: ‘stdint.h’: No such file or directory"></a>Cannot open include file: ‘stdint.h’: No such file or directory</h5><h6 id="解决-2"><a href="#解决-2" class="headerlink" title="解决"></a>解决</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Microsoft Visual C++ 2015 Redistributable Update 3</span></span><br><span class="line"><span class="comment"># download vc_redist.x64.exe from https://www.microsoft.com/zh-CN/download/details.aspx?id=53840</span></span><br><span class="line">$ vim D:\apps\Python27\Lib\distutils\msvc9compiler.py</span><br><span class="line"></span><br><span class="line">  def get_build_version():</span><br><span class="line">    <span class="built_in">return</span> 9.0</span><br><span class="line">  def find_vcvarsall(version):</span><br><span class="line">    <span class="built_in">return</span> r<span class="string">'C:\Users\yuzhouwan\AppData\Local\Programs\Common\Microsoft\Visual C++ for Python\9.0\vcvarsall.bat'</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> superset-0.15.4</span><br><span class="line">$ python setup.py install</span><br><span class="line"></span><br><span class="line"><span class="comment"># Microsoft 提供的 VCForPython27.msi 默认使用 VC2008，而 stdint.h 是从 VC2012 开始支持的</span></span><br><span class="line"><span class="comment"># 2014 年之后，VCForPython27.msi 便不再维护，决定尝试用 ubuntu or remote debug ...</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="Python相关"><a href="#Python相关" class="headerlink" title="Python相关"></a>Python相关</h4><h5 id="Make-sure-that-you-use-the-correct-version-of-‘pip’"><a href="#Make-sure-that-you-use-the-correct-version-of-‘pip’" class="headerlink" title="Make sure that you use the correct version of ‘pip’"></a>Make sure that you use the correct version of ‘pip’</h5><h6 id="描述-1"><a href="#描述-1" class="headerlink" title="描述"></a>描述</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">Try to run this <span class="built_in">command</span> from the system terminal. Make sure that you use the correct version of <span class="string">'pip'</span> installed <span class="keyword">for</span> your Python interpreter located at <span class="string">'D:\apps\Python27\python.exe'</span></span><br></pre></td></tr></tbody></table></figure>
<h6 id="解决-3"><a href="#解决-3" class="headerlink" title="解决"></a>解决</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 安装 pip，下载 https://bootstrap.pypa.io/get-pip.py 安装文件</span></span><br><span class="line">$ python get-pip.py</span><br><span class="line"></span><br><span class="line">$ pip --version</span><br><span class="line">  pip 8.1.1 from d:\apps\python27\lib\site-packages (python 2.7)</span><br></pre></td></tr></tbody></table></figure>
<h5 id="‘Connection-to-pypi-python-org-timed-out-connect-timeout-15-’"><a href="#‘Connection-to-pypi-python-org-timed-out-connect-timeout-15-’" class="headerlink" title="‘Connection to pypi.python.org timed out. (connect timeout=15)’"></a>‘Connection to pypi.python.org timed out. (connect timeout=15)’</h5><h6 id="描述-2"><a href="#描述-2" class="headerlink" title="描述"></a>描述</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ pip install --upgrade pip</span><br><span class="line">  <span class="string">'Connection to pypi.python.org timed out. (connect timeout=15)'</span></span><br></pre></td></tr></tbody></table></figure>
<h6 id="解决-4"><a href="#解决-4" class="headerlink" title="解决"></a>解决</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 设置 proxy</span></span><br><span class="line">$ <span class="built_in">export</span> https_proxy=<span class="string">"http://10.10.10.10:8080"</span></span><br><span class="line">$ pip install --upgrade pip</span><br><span class="line">$ pip --version</span><br><span class="line">  pip 9.0.1 from d:\apps\python27\lib\site-packages (python 2.7)</span><br></pre></td></tr></tbody></table></figure>
<h5 id="setup-py-failed-with-error-code-1"><a href="#setup-py-failed-with-error-code-1" class="headerlink" title="setup.py failed with error code 1"></a>setup.py failed with error code 1</h5><h6 id="描述-3"><a href="#描述-3" class="headerlink" title="描述"></a>描述</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">Command <span class="string">"d:\apps\python27\python.exe -u -c "</span>import setuptools, tokenize;__file__=<span class="string">'c:\\users\\yuzhouwan\\appdata\\local\\temp\\pip-build-zzbhrq\\sasl\\setup.py'</span>;f=getattr(tokenize, <span class="string">'open'</span>, open)(__file__);code=f.read().replace(<span class="string">'\r\n'</span>, <span class="string">'\n'</span>);f.close();<span class="built_in">exec</span>(compile(code, __file__, <span class="string">'exec'</span>))<span class="string">" install --record c:\users\yuzhouwan\appdata\local\temp\pip-erwavd-record\install-record.txt --single-version-externally-managed --compile"</span> failed with error code 1 <span class="keyword">in</span> c:\users\yuzhouwan\appdata\<span class="built_in">local</span>\temp\pip-build-zzbhrq\sasl\</span><br></pre></td></tr></tbody></table></figure>
<h6 id="解决-5"><a href="#解决-5" class="headerlink" title="解决"></a>解决</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ pip install --upgrade setuptools pip</span><br><span class="line">$ pip install superset</span><br><span class="line"></span><br><span class="line"><span class="comment"># Download superset-0.15.4.tar.gz from https://pypi.python.org/pypi/superset</span></span><br><span class="line">$ tar zxvf superset-0.15.4.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> superset-0.15.4</span><br><span class="line">$ python setup.py install</span><br></pre></td></tr></tbody></table></figure>
<h2 id="基于-K8S-环境部署"><a href="#基于-K8S-环境部署" class="headerlink" title="基于 K8S 环境部署"></a>基于 <a href="https://yuzhouwan.com/posts/200919/">K8S</a> 环境部署</h2><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ helm install superset stable/superset --version 1.1.11</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">NAME: superset</span><br><span class="line">LAST DEPLOYED: Mon Jul 19 08:45:33 2020</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br><span class="line">TEST SUITE: None</span><br><span class="line">NOTES:</span><br><span class="line">Superset can be accessed via port 9000 on the following DNS name from within your cluster:</span><br><span class="line">superset.default.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Initially you can login with username/password: admin/admin.</span><br><span class="line">WARNING: Persistence is DISABLED !</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> -it superset-65c7696586-lhwpp bash</span><br><span class="line">$ <span class="built_in">export</span> FLASK_APP=superset &amp;&amp; flask fab create-admin</span><br><span class="line">$ <span class="built_in">exit</span></span><br><span class="line">$ <span class="built_in">kill</span> `ps -ef | grep 8088 | grep -v grep | awk <span class="string">'{print $2}'</span>`; <span class="built_in">export</span> POD_NAME=$(kubectl get pods | grep superset | awk <span class="string">'{print $1}'</span>) ; nohup kubectl port-forward <span class="variable">$POD_NAME</span> 8088:8088 --address 0.0.0.0 2&gt;&amp;1 &amp;</span><br><span class="line">$ open <span class="string">'http://localhost:8088/login/'</span></span><br></pre></td></tr></tbody></table></figure>
<p><img data-src="/picture/superset/apache_superset_login.png" alt="Apache Superset Login"><br><img data-src="/picture/superset/apache_superset_dashboards.png" alt="Apache Superset Dashboards"></p>
<center>（对 <a href="https://superset.apache.org/" target="_blank">Apache Superset</a>™ 可视化页面的截图）</center>





<h2 id="开发环境搭建"><a href="#开发环境搭建" class="headerlink" title="开发环境搭建"></a>开发环境搭建</h2><h3 id="依赖-1"><a href="#依赖-1" class="headerlink" title="依赖"></a>依赖</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /root/software</span><br><span class="line">$ tar zxvf Python-2.7.12.tgz</span><br><span class="line">$ <span class="built_in">cd</span> Python-2.7.12</span><br><span class="line"></span><br><span class="line">$ ./configure --prefix=/usr/<span class="built_in">local</span>/python27 --<span class="built_in">enable</span>-shared CFLAGS=-fPIC</span><br><span class="line">$ make &amp;&amp; make install</span><br><span class="line">$ /sbin/ldconfig -v | grep /</span><br><span class="line">$ python -V</span><br><span class="line">$ Python 2.7.12</span><br><span class="line"></span><br><span class="line">$ mv /usr/<span class="built_in">local</span>/bin/python /usr/<span class="built_in">local</span>/bin/python_bak</span><br><span class="line">$ ln -s /usr/<span class="built_in">local</span>/python27/bin/python /usr/<span class="built_in">local</span>/bin/python</span><br></pre></td></tr></tbody></table></figure>
<h3 id="虚拟环境"><a href="#虚拟环境" class="headerlink" title="虚拟环境"></a>虚拟环境</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /root</span><br><span class="line">$ virtualenv -p /usr/<span class="built_in">local</span>/bin/python --system-site-packages env</span><br><span class="line">$ <span class="built_in">cd</span> env</span><br><span class="line">$ mkdir code</span><br></pre></td></tr></tbody></table></figure>
<h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># windows</span></span><br><span class="line">$ <span class="built_in">cd</span> E:\Github\super\env</span><br><span class="line">$ git init</span><br><span class="line">$ git remote add origin master https://github.com/asdf2014/superset.git</span><br><span class="line">$ git pull origin master</span><br><span class="line"></span><br><span class="line"><span class="comment"># SFTP</span></span><br><span class="line"><span class="comment"># 上传到 /root/env/code</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /root/env/code</span><br><span class="line">$ <span class="built_in">source</span> /root/env/bin/activate</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> /root/env/code/superset/static</span><br><span class="line">$ mv assets assets_bak</span><br><span class="line">$ ln -s ../assets assets</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> /root/env/code</span><br><span class="line">$ python setup.py develop</span><br><span class="line"></span><br><span class="line">  Finished processing dependencies <span class="keyword">for</span> superset==0.15.4</span><br><span class="line"></span><br><span class="line">$ pip freeze | grep superset</span><br><span class="line">  superset==0.15.4</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create an admin user</span></span><br><span class="line">$ fabmanager create-admin --app superset</span><br><span class="line"></span><br><span class="line">  Username [admin]:        <span class="comment"># login name</span></span><br><span class="line">  User first name [admin]: <span class="comment"># first name</span></span><br><span class="line">  User last name [user]:   <span class="comment"># lastname</span></span><br><span class="line">  Email [admin@fab.org]:   <span class="comment"># email, must unique</span></span><br><span class="line">  Password: </span><br><span class="line">  Repeat <span class="keyword">for</span> confirmation: </span><br><span class="line">  Error: the two entered values <span class="keyword">do</span> not match</span><br><span class="line">  Password:			 	  <span class="comment">#superset</span></span><br><span class="line">  Repeat <span class="keyword">for</span> confirmation: <span class="comment">#superset</span></span><br><span class="line">  // ...</span><br><span class="line">  Recognized Database Authentications.</span><br><span class="line">  2016-12-14 17:53:40,945:INFO:flask_appbuilder.security.sqla.manager:Added user superset db upgrade</span><br><span class="line">  Admin User superset db upgrade created.</span><br><span class="line"></span><br><span class="line">$ superset db upgrade</span><br><span class="line">$ superset init</span><br><span class="line">$ superset load_examples</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Npm"><a href="#Npm" class="headerlink" title="Npm"></a>Npm</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># [Mac OS]</span></span><br><span class="line">$ sudo yum group install <span class="string">"Development Tools"</span> --<span class="built_in">setopt</span>=group_package_types=mandatory,default,optional --skip-broken -y</span><br><span class="line">$ sudo yum install curl git m4 ruby texinfo bzip2-devel curl-devel expat-devel ncurses-devel zlib-devel -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/linuxbrew/go/install)"    # Do not run this as root!</span></span><br><span class="line">$ wget https://raw.githubusercontent.com/Homebrew/linuxbrew/go/install --no-check-certificate</span><br><span class="line">$ mv install install.rb</span><br><span class="line">$ vim install.rb</span><br><span class="line"></span><br><span class="line">　<span class="comment"># abort "Don't run this as root!" if Process.uid == 0</span></span><br><span class="line"></span><br><span class="line">$ mkdir -p /root/.linuxbrew/bin</span><br><span class="line">$ <span class="built_in">export</span> PATH=<span class="string">"/root/.linuxbrew/bin:<span class="variable">$PATH</span>"</span></span><br><span class="line">$ ruby install.rb</span><br><span class="line"></span><br><span class="line">$ vim ~/.bashrc</span><br><span class="line"></span><br><span class="line">　<span class="built_in">export</span> PATH=<span class="string">"<span class="variable">$HOME</span>/.linuxbrew/bin:<span class="variable">$PATH</span>"</span></span><br><span class="line">　<span class="built_in">export</span> MANPATH=<span class="string">"<span class="variable">$HOME</span>/.linuxbrew/share/man:<span class="variable">$MANPATH</span>"</span></span><br><span class="line">　<span class="built_in">export</span> INFOPATH=<span class="string">"<span class="variable">$HOME</span>/.linuxbrew/share/info:<span class="variable">$INFOPATH</span>"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># [CentOS]</span></span><br><span class="line">$ yum install npm</span><br><span class="line">$ <span class="built_in">cd</span> /root/env/code/superset/assets	<span class="comment"># package.json</span></span><br><span class="line">$ npm install</span><br><span class="line"></span><br><span class="line"><span class="comment"># if visit https://github.com/jquery/jquery.git return timeout</span></span><br><span class="line">$ vim /etc/hosts</span><br><span class="line"></span><br><span class="line">　192.30.253.112 github.com</span><br><span class="line">　151.101.100.133 assets-cdn.github.com</span><br><span class="line">　192.30.253.117 api.github.com</span><br><span class="line">　192.30.253.121 codeload.github.com</span><br></pre></td></tr></tbody></table></figure>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /root/env/code</span><br><span class="line">$ chmod 777 *sh</span><br><span class="line">$ <span class="built_in">cd</span> /root/env/code/superset/bin</span><br><span class="line">$ chmod 777 superset</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> /root/env/code</span><br><span class="line">$ bash run_tests.sh</span><br></pre></td></tr></tbody></table></figure>
<h3 id="IDE-中远程开发"><a href="#IDE-中远程开发" class="headerlink" title="IDE 中远程开发"></a>IDE 中远程开发</h3><h4 id="Remote-Debug"><a href="#Remote-Debug" class="headerlink" title="Remote Debug"></a>Remote Debug</h4><p>　详见我的另一篇博客中 Remote Debug 部分：《<a href="https://yuzhouwan.com/posts/43687/#Remote-Debug">Python</a>》</p>
<h2 id="二次开发"><a href="#二次开发" class="headerlink" title="二次开发"></a>二次开发</h2><h3 id="Others-Category"><a href="#Others-Category" class="headerlink" title="Others Category"></a>Others Category</h3><h4 id="描述-4"><a href="#描述-4" class="headerlink" title="描述"></a>描述</h4><p>　对 <a href="https://yuzhouwan.com/posts/45888/">HBase</a> 的 Region 层面进行聚合，group 出来的 Region 会很多，在 <code>DistributionPieViz</code> 中展示会很卡顿，而且不美观</p>
<h4 id="解决-6"><a href="#解决-6" class="headerlink" title="解决"></a>解决</h4><h5 id="增加-row-limit-可以排除-topN-之外的数据"><a href="#增加-row-limit-可以排除-topN-之外的数据" class="headerlink" title="增加 row_limit 可以排除 topN 之外的数据"></a>增加 row_limit 可以排除 topN 之外的数据</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /root/superset-0.15.4</span><br><span class="line">$ vim ./lib/python2.7/site-packages/superset/viz.py</span><br><span class="line"></span><br><span class="line">  fieldsets = ({</span><br><span class="line">    <span class="string">'label'</span>: None,</span><br><span class="line">    <span class="string">'fields'</span>: (</span><br><span class="line">      <span class="string">'metrics'</span>, <span class="string">'groupby'</span>,</span><br><span class="line">      <span class="string">'limit'</span>,</span><br><span class="line">      <span class="string">'pie_label_type'</span>,</span><br><span class="line">      (<span class="string">'donut'</span>, <span class="string">'show_legend'</span>),</span><br><span class="line">      <span class="string">'labels_outside'</span>,</span><br><span class="line">      <span class="string">'row_limit'</span>,</span><br><span class="line">    )</span><br><span class="line">  },)</span><br></pre></td></tr></tbody></table></figure>
<h5 id="others-category-将-topN-之外的数据聚合"><a href="#others-category-将-topN-之外的数据聚合" class="headerlink" title="others_category 将 topN 之外的数据聚合"></a>others_category 将 topN 之外的数据聚合</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /root/superset-0.15.4</span><br><span class="line">$ vim ./lib/python2.7/site-packages/superset/viz.py</span><br><span class="line"></span><br><span class="line">  fieldsets = ({</span><br><span class="line">    <span class="string">'label'</span>: None,</span><br><span class="line">    <span class="string">'fields'</span>: (</span><br><span class="line">      <span class="string">'metrics'</span>, <span class="string">'groupby'</span>,</span><br><span class="line">      <span class="string">'limit'</span>,</span><br><span class="line">      <span class="string">'pie_label_type'</span>,</span><br><span class="line">      (<span class="string">'donut'</span>, <span class="string">'show_legend'</span>),</span><br><span class="line">      <span class="string">'labels_outside'</span>,</span><br><span class="line">      <span class="string">'row_limit'</span>,</span><br><span class="line">      <span class="string">'others_category'</span>,</span><br><span class="line">    )</span><br><span class="line">  },)</span><br><span class="line"></span><br><span class="line">$ vim ./lib/python2.7/site-packages/superset/forms.py</span><br><span class="line"></span><br><span class="line">  <span class="string">'others_category'</span>: (BetterBooleanField, {</span><br><span class="line">    <span class="string">"label"</span>: _(<span class="string">"Others category"</span>),</span><br><span class="line">    <span class="string">"default"</span>: True,</span><br><span class="line">    <span class="string">"description"</span>: _(<span class="string">"Aggregate data outside of topN into a single category"</span>)</span><br><span class="line">  }),</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># models.py</span></span><br><span class="line"><span class="comment"># Others 类别，没有被排在最后，而是重新又进行了一次排序</span></span><br><span class="line"><span class="comment"># "others_category": "y" 属性没有传递下来</span></span><br><span class="line"></span><br><span class="line">self.status = None</span><br><span class="line">self.error_message = None</span><br><span class="line">self.others_category = form_data.get(<span class="string">"others_category"</span>)</span><br><span class="line"></span><br><span class="line">top_n = 10</span><br><span class="line"><span class="keyword">if</span> top_n &gt; 0:</span><br><span class="line">df_head = df.head(top_n)</span><br><span class="line">df_tail = df.tail(len(df) - 10)</span><br><span class="line">other_metrics_sum = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(0, len(metrics) - 1):</span><br><span class="line">  metric = metrics[i]</span><br><span class="line">  other_metrics_sum[i] = df_tail[metric].sum()</span><br><span class="line">df_other = pd.DataFrame([[<span class="string">'Others'</span>, other_metrics_sum]], columns=df.columns)</span><br><span class="line">df = df_head.append(df_other, ignore_index=True)</span><br></pre></td></tr></tbody></table></figure>
<p>Tips: 已提 RP#2176 <a href="https://github.com/apache/superset/pull/2176">Aggregate data outside of topN into a single category</a></p>
<h3 id="Y-轴数据异常"><a href="#Y-轴数据异常" class="headerlink" title="Y 轴数据异常"></a>Y 轴数据异常</h3><h4 id="描述-5"><a href="#描述-5" class="headerlink" title="描述"></a>描述</h4><p>　Y 轴本应该是 0 的起点，变成 -997m 负数</p>
<h4 id="解决-7"><a href="#解决-7" class="headerlink" title="解决"></a>解决</h4><p>　已提 RP#2307 <a href="https://github.com/apache/superset/issues/2307">Some problem in Y Axis</a></p>
<h2 id="后期优化"><a href="#后期优化" class="headerlink" title="后期优化"></a>后期优化</h2><h3 id="MySQL-时区问题"><a href="#MySQL-时区问题" class="headerlink" title="MySQL 时区问题"></a>MySQL 时区问题</h3><h4 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h4><h5 id="描述-6"><a href="#描述-6" class="headerlink" title="描述"></a>描述</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ lib/python2.7/site-packages/superset/config.py</span><br><span class="line"></span><br><span class="line">　from dateutil import tz</span><br><span class="line"></span><br><span class="line">　<span class="comment"># Druid query timezone</span></span><br><span class="line">　<span class="comment"># tz.tzutc() : Using utc timezone</span></span><br><span class="line">　<span class="comment"># tz.tzlocal() : Using local timezone</span></span><br><span class="line">　<span class="comment"># other tz can be overridden by providing a local_config</span></span><br><span class="line">　DRUID_IS_ACTIVE = True</span><br><span class="line">　DRUID_TZ = tz.tzlocal()		<span class="comment"># +08:00</span></span><br><span class="line"></span><br><span class="line">　<span class="comment"># DRUID_TZ = tz.gettz('Asia/Shanghai')</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="解决-8"><a href="#解决-8" class="headerlink" title="解决"></a>解决</h5><p>　已提 RP#2143 <a href="https://github.com/apache/superset/pull/2143">Using the time zone with specific name for querying Druid</a></p>
<h4 id="展示"><a href="#展示" class="headerlink" title="展示"></a>展示</h4><h5 id="描述-7"><a href="#描述-7" class="headerlink" title="描述"></a>描述</h5><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line">dttm.tz_convert(dttm.tzinfo._filename.split(<span class="string">'zoneinfo/'</span>)[<span class="number">1</span>]) - pytz.timezone(dttm.tzinfo._filename.split(<span class="string">'zoneinfo/'</span>)[<span class="number">1</span>]).localize(EPOCH)</span><br></pre></td></tr></tbody></table></figure>
<h5 id="解决-9"><a href="#解决-9" class="headerlink" title="解决"></a>解决</h5><p>　已提 RP#2370 <a href="https://github.com/apache/superset/pull/2370">Fix timezone issues in slices</a></p>
<h3 id="Superset-升级"><a href="#Superset-升级" class="headerlink" title="Superset 升级"></a>Superset 升级</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 直接利用 pip install 的方式进行升级</span></span><br><span class="line">$ pip freeze | grep superset</span><br><span class="line">$ superset==0.13.2</span><br><span class="line"></span><br><span class="line">$ pip install superset==-1</span><br><span class="line">  versions: 0.12.0, 0.13.0, 0.13.1, 0.13.2, 0.14.0, 0.14.1, 0.15.0, 0.15.1, 0.15.3, 0.15.4</span><br><span class="line"></span><br><span class="line">$ pip install superset==0.15.4</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发现之前的配置数据 都消失了，需要做一些 config 的调整</span></span><br><span class="line">$ vim ./lib/python2.7/site-packages/superset/config.py</span><br><span class="line"></span><br><span class="line"><span class="comment"># SQLALCHEMY_DATABASE_URI = 'sqlite:///' + os.path.join(DATA_DIR, 'superset.db')</span></span><br><span class="line">  SQLALCHEMY_DATABASE_URI = <span class="string">'mysql+pymysql://root:root@192.168.1.12:3306/superset?charset=utf8'</span></span><br><span class="line"></span><br><span class="line">$ vim /root/superset-0.15.4/bin/activate</span><br><span class="line"></span><br><span class="line">  <span class="comment"># VIRTUAL_ENV="/root/superset"</span></span><br><span class="line">  VIRTUAL_ENV=<span class="string">"/root/superset-0.15.4"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># then could just run "superset runserver -a 0.0.0.0 -p 9097"</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="Unknown-column-‘datasources-filter-select-enabled’-in-‘field-list’"><a href="#Unknown-column-‘datasources-filter-select-enabled’-in-‘field-list’" class="headerlink" title="Unknown column ‘datasources.filter_select_enabled’ in ‘field list’"></a>Unknown column ‘datasources.filter_select_enabled’ in ‘field list’</h4><h5 id="描述-8"><a href="#描述-8" class="headerlink" title="描述"></a>描述</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">InternalError: (pymysql.err.InternalError) (1054, u<span class="string">"Unknown column 'datasources.filter_select_enabled' in 'field list'"</span>) [SQL: u<span class="string">'SELECT datasources.created_on AS datasources_created_on, datasources.changed_on AS datasources_changed_on, datasources.id AS datasources_id, datasources.datasource_name AS datasources_datasource_name, datasources.is_featured AS datasources_is_featured, datasources.is_hidden AS datasources_is_hidden, datasources.filter_select_enabled AS datasources_filter_select_enabled, datasources.description AS datasources_description, datasources.default_endpoint AS datasources_default_endpoint, datasources.user_id AS datasources_user_id, datasources.cluster_name AS datasources_cluster_name, datasources.offset AS datasources_offset, datasources.cache_timeout AS datasources_cache_timeout, datasources.params AS datasources_params, datasources.perm AS datasources_perm, datasources.changed_by_fk AS datasources_changed_by_fk, datasources.created_by_fk AS datasources_created_by_fk \nFROM datasources \nWHERE datasources.datasource_name = %(datasource_name_1)s \n LIMIT %(param_1)s'</span>] [parameters: {u<span class="string">'param_1'</span>: 1, u<span class="string">'datasource_name_1'</span>: u<span class="string">'bi-dfp-oms-detail'</span>}]</span><br></pre></td></tr></tbody></table></figure>
<h5 id="解决-10"><a href="#解决-10" class="headerlink" title="解决"></a>解决</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ superset db upgrade</span><br><span class="line">$ superset refresh_druid</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Issues-with-Druid-timezones"><a href="#Issues-with-Druid-timezones" class="headerlink" title="Issues with Druid timezones"></a>Issues with Druid timezones</h4><h5 id="描述-9"><a href="#描述-9" class="headerlink" title="描述"></a>描述</h5><p>　Those methods that named tzutc and tzlocal in tz work for me…<br>　Oh no.. They are not working when i upgrade superset from v0.13.2 into v0.15.4, even if i try to use DRUID_TZ = tz.gettz(‘Asia/Shanghai’) :-(</p>
<p>　详见：<a href="https://github.com/apache/superset/issues/1369">Issues with Druid timezones #1369</a></p>
<h5 id="解决-11"><a href="#解决-11" class="headerlink" title="解决"></a>解决</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /root/superset-0.15.4</span><br><span class="line">$ ./bin/python -m pip freeze | grep superset</span><br><span class="line"></span><br><span class="line">  superset==0.13.2</span><br><span class="line"></span><br><span class="line">$ ./bin/python -m pip uninstall superset</span><br><span class="line">$ ./bin/python -m pip install superset==0.15.4</span><br><span class="line">$ ./bin/python -m pip freeze | grep superset</span><br><span class="line"></span><br><span class="line">  superset==0.15.4</span><br><span class="line"></span><br><span class="line">$ ./bin/python ./bin/easy_install lib/pycharm-debug.egg</span><br><span class="line"><span class="comment"># config remote python</span></span><br><span class="line"></span><br><span class="line">$ ./bin/python ./bin/superset runserver -a 0.0.0.0 -p 9097</span><br><span class="line"><span class="comment"># nohup ./bin/python ./bin/superset runserver -a 0.0.0.0 -p 9097 2&gt;&amp;1 &gt; logs/superset.log &amp;</span></span><br><span class="line"></span><br><span class="line">$ ./bin/python ./bin/superset db upgrade</span><br><span class="line">$ ./bin/python ./bin/superset refresh_druid</span><br></pre></td></tr></tbody></table></figure>
<h4 id="pydevd-无法进行-remote-debug"><a href="#pydevd-无法进行-remote-debug" class="headerlink" title="pydevd 无法进行 remote debug"></a>pydevd 无法进行 remote debug</h4><h5 id="描述-10"><a href="#描述-10" class="headerlink" title="描述"></a>描述</h5><p>　版本从 0.13.2 升级到 0.15.4，在 debug 的时候会启动两个进程（会导致 pydevd 无法进行 remote debug）</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ ps -ef | grep superset | grep -v grep</span><br><span class="line"></span><br><span class="line">  root     22567  1632 19 12:05 pts/0    00:00:03 ./bin/python ./bin/superset runserver -d -p 9097</span><br><span class="line">  root     22578 22567 24 12:05 pts/0    00:00:03 /root/superset-0.15.4/bin/python ./bin/superset runserver -d -p 9097</span><br></pre></td></tr></tbody></table></figure>
<h5 id="解决-12"><a href="#解决-12" class="headerlink" title="解决"></a>解决</h5><h6 id="直接用-cli-py-启动-—not-ok"><a href="#直接用-cli-py-启动-—not-ok" class="headerlink" title="直接用 cli.py 启动    —not ok"></a>直接用 cli.py 启动    —not ok</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim ./lib/python2.7/site-packages/superset/config.py</span><br><span class="line"></span><br><span class="line">  <span class="comment"># append</span></span><br><span class="line">  manager.run()</span><br><span class="line"></span><br><span class="line">$ ./bin/python ./lib/python2.7/site-packages/superset/cli.py runserver -a 0.0.0.0  -p 9097</span><br><span class="line"></span><br><span class="line">$ ps -ef | grep superset | grep -v grep</span><br><span class="line"></span><br><span class="line">  root     25238  1632 35 13:07 pts/0    00:00:03 ./bin/python ./lib/python2.7/site-packages/superset/cli.py runserver -d -p 9097</span><br><span class="line">  root     25247 25238 55 13:07 pts/0    00:00:03 /root/superset-0.15.4/bin/python ./lib/python2.7/site-packages/superset/cli.py runserver -d -p 9097</span><br></pre></td></tr></tbody></table></figure>
<h6 id="尝试解决-WARNING-werkzeug-Debugger-is-active-问题"><a href="#尝试解决-WARNING-werkzeug-Debugger-is-active-问题" class="headerlink" title="尝试解决 WARNING:werkzeug: * Debugger is active! 问题"></a>尝试解决 WARNING:werkzeug: * Debugger is active! 问题</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim lib/python2.7/site-packages/werkzeug/serving.py</span><br><span class="line"></span><br><span class="line">  class ThreadedWSGIServer(ThreadingMixIn, BaseWSGIServer):</span><br><span class="line"></span><br><span class="line">    <span class="string">""</span><span class="string">"A WSGI server that does threading."</span><span class="string">""</span></span><br><span class="line">    multithread = True</span><br><span class="line"></span><br><span class="line">$ vim lib/python2.7/site-packages/flask/app.py</span><br><span class="line"></span><br><span class="line">  options.setdefault(<span class="string">'use_reloader'</span>, self.debug)</span><br><span class="line"></span><br><span class="line">$ superset/__init__.py</span><br></pre></td></tr></tbody></table></figure>
<p>　已提 RP#2136 <a href="https://github.com/apache/superset/pull/2136">Fix werkzeug instance was created twice in Debug Mode</a></p>
<h3 id="Sqlite3-切换为-MySQL"><a href="#Sqlite3-切换为-MySQL" class="headerlink" title="Sqlite3 切换为 MySQL"></a>Sqlite3 切换为 MySQL</h3><h4 id="尝试-SQLite-自带的-dump-命令"><a href="#尝试-SQLite-自带的-dump-命令" class="headerlink" title="尝试 SQLite 自带的 dump 命令"></a>尝试 SQLite 自带的 dump 命令</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># superset01				192.168.1.10		Superset</span></span><br><span class="line">$ <span class="built_in">cd</span> /root/.superset</span><br><span class="line">$ ll -sail</span><br><span class="line"></span><br><span class="line">  1285 43256 -rw-r--r--   1 root root 44288000 Jan 22 14:06 superset.db</span><br><span class="line"></span><br><span class="line">$ sqlite3 superset.db</span><br><span class="line">  sqlite&gt; .databases</span><br><span class="line">  seq  name             file                                                      </span><br><span class="line">  ---  ---------------  ----------------------------------------------------------</span><br><span class="line">  0    main             /root/.superset/superset.db</span><br><span class="line"></span><br><span class="line">  sqlite&gt; .tables</span><br><span class="line">  ab_permission            columns                  multiformat_time_series</span><br><span class="line">  ab_permission_view       css_templates            query                  </span><br><span class="line">  ab_permission_view_role  dashboard_slices         random_time_series     </span><br><span class="line">  ab_register_user         dashboard_user           slice_user             </span><br><span class="line">  ab_role                  dashboards               slices                 </span><br><span class="line">  ab_user                  datasources              sql_metrics            </span><br><span class="line">  ab_user_role             dbs                      table_columns          </span><br><span class="line">  ab_view_menu             energy_usage             tables                 </span><br><span class="line">  access_request           favstar                  url                    </span><br><span class="line">  alembic_version          logs                     wb_health_population   </span><br><span class="line">  birth_names              long_lat               </span><br><span class="line">  clusters                 metrics                </span><br><span class="line"></span><br><span class="line"><span class="comment"># not suit for mysql</span></span><br><span class="line"><span class="comment"># sqlite&gt; .output superset.sql</span></span><br><span class="line"><span class="comment"># sqlite&gt; .dump</span></span><br><span class="line"></span><br><span class="line">$ vim dump_for_mysql.py</span><br><span class="line"></span><br><span class="line">  <span class="comment"># https://github.com/EricHigdon/sqlite3tomysql</span></span><br><span class="line"></span><br><span class="line">$ sqlite3 superset.db .dump | python dump_for_mysql.py &gt; superset.sql</span><br><span class="line"></span><br><span class="line">$ ls -sail</span><br><span class="line"></span><br><span class="line">  1285 43256 -rw-r--r--   1 root root 44288000 Jan 22 14:06 superset.db</span><br><span class="line">  18631 76968 -rw-r--r--   1 root root 78812197 Jan 22 14:35 superset.sql</span><br><span class="line"></span><br><span class="line">$ vim superset.sql</span><br><span class="line"></span><br><span class="line">  id INTEGER NOT NULL, </span><br><span class="line">  <span class="comment"># 替换为 (主键) 自增长</span></span><br><span class="line">  id INTEGER PRIMARY KEY NOT NULL AUTO_INCREMENT, </span><br><span class="line"></span><br><span class="line">$ scp superset.sql root@192.168.1.12:/home/mysql</span><br></pre></td></tr></tbody></table></figure>
<h4 id="自己实现-sqlite3tomysql-py"><a href="#自己实现-sqlite3tomysql-py" class="headerlink" title="自己实现 sqlite3tomysql.py"></a>自己实现 sqlite3tomysql.py</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># druid02    192.168.1.12    MySQL</span></span><br><span class="line">$ ps -ef | grep mysql | grep -v druid | grep -v grep</span><br><span class="line"></span><br><span class="line">  mysql    11435  8530  0 14:13 pts/4    00:00:00 /bin/sh /home/mysql/bin/mysqld_safe --defaults-file=/home/mysql/my.cnf</span><br><span class="line">  mysql    12192 11435  0 14:13 pts/4    00:00:00 /home/mysql/bin/mysqld --defaults-file=/home/mysql/my.cnf --basedir=/home/mysql --datadir=/home/mysql/data --plugin-dir=/home/mysql/lib/mysql/plugin --<span class="built_in">log</span>-error=/home/mysql/data/druid02.err --open-files-limit=8192 --pid-file=/home/mysql/data/druid02.pid --socket=/home/mysql/data/mysql.sock --port=3306</span><br><span class="line">  mysql    12223  8530  0 14:13 pts/4    00:00:00 mysql -uroot -p -S /home/mysql/data/mysql.sock</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ su - mysql</span><br><span class="line">$ mysql -uroot -p -S /home/mysql/data/mysql.sock</span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">mysql&gt; create database superset;</span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">mysql&gt; use superset;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行 sqlite3tomysql.py</span></span><br><span class="line">  mysql -uroot -p superset2 -S /home/mysql/data/mysql.sock  --default-character-set=utf8 &lt; superset.sql.schema.sql</span><br><span class="line">  mysql -uroot -p superset2 -S /home/mysql/data/mysql.sock  --default-character-set=utf8 &lt; superset.sql.data.sql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 避免表之间 外键依赖，可以在 mysql 命令行中，使用 source .superset.sql.schema.sql 的方式，多次批量导入</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="元数据存储-1"><a href="#元数据存储-1" class="headerlink" title="元数据存储"></a>元数据存储</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># superset01				192.168.1.10		Superset</span></span><br><span class="line">$ <span class="built_in">cd</span> /root/superset</span><br><span class="line">$ find ./ -name config.py</span><br><span class="line">  ./lib/python2.7/site-packages/caravel/config.py</span><br><span class="line">  ./lib/python2.7/site-packages/sqlalchemy/testing/config.py</span><br><span class="line">  ./lib/python2.7/site-packages/pandas/core/config.py</span><br><span class="line">  ./lib/python2.7/site-packages/superset/config.py</span><br><span class="line">  ./lib/python2.7/site-packages/setuptools/config.py</span><br><span class="line">  ./lib/python2.7/site-packages/numpy/distutils/<span class="built_in">command</span>/config.py</span><br><span class="line">  ./lib/python2.7/site-packages/gunicorn/config.py</span><br><span class="line">  ./lib/python2.7/site-packages/panoramix/config.py</span><br><span class="line">  ./lib/python2.7/site-packages/flask/config.py</span><br><span class="line">  ./lib/python2.7/site-packages/alembic/testing/config.py</span><br><span class="line">  ./lib/python2.7/site-packages/alembic/config.py</span><br><span class="line"></span><br><span class="line">$ vim ./lib/python2.7/site-packages/superset/config.py</span><br><span class="line">  <span class="comment"># SQLALCHEMY_DATABASE_URI = 'sqlite:///' + os.path.join(DATA_DIR, 'superset.db')</span></span><br><span class="line">  SQLALCHEMY_DATABASE_URI = <span class="string">'mysql+pymysql://root:root@192.168.1.12:3306/superset?charset=utf8'</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="启动-1"><a href="#启动-1" class="headerlink" title="启动"></a>启动</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 先执行，一系列 superset 初始化工作</span></span><br><span class="line">$ nohup superset runserver -a 0.0.0.0 -p 9097 -w 4 2&gt;&amp;1 &gt; logs/superset.log &amp;</span><br></pre></td></tr></tbody></table></figure>
<p>Tips: 代码 &amp; 操作步骤，详见：<a href="https://github.com/asdf2014/yuzhouwan/tree/master/yuzhouwan-hacker/yuzhouwan-hacker-python#convert-sqlite-into-mysql">Convert SQLite into MySQL</a></p>
<h3 id="参数调优"><a href="#参数调优" class="headerlink" title="参数调优"></a>参数调优</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 适当增加 gunicorn 的 worker 数量（default：2）</span></span><br><span class="line">$ <span class="built_in">cd</span> /root/superset</span><br><span class="line">$ <span class="built_in">source</span> bin/activate</span><br><span class="line">$ mkdir logs</span><br><span class="line">$ nohup ./bin/python ./bin/superset runserver -a 0.0.0.0 -p 9097 -w 4 2&gt;&amp;1 &gt; logs/superset.log &amp;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h3><h4 id="ExtDeprecationWarning-Importing-flask-ext-cache-is-deprecated-use-flask-cache-instead"><a href="#ExtDeprecationWarning-Importing-flask-ext-cache-is-deprecated-use-flask-cache-instead" class="headerlink" title="ExtDeprecationWarning: Importing flask.ext.cache is deprecated, use flask_cache instead."></a>ExtDeprecationWarning: Importing flask.ext.cache is deprecated, use flask_cache instead.</h4><h5 id="描述-11"><a href="#描述-11" class="headerlink" title="描述"></a>描述</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">(superset) [root@superset01 superset-0.15.4]<span class="comment"># ./bin/python ./lib/python2.7/site-packages/superset/cli.py runserver -d -p 9097</span></span><br><span class="line">/root/superset-0.15.4/lib/python2.7/site-packages/flask/exthook.py:71: ExtDeprecationWarning: Importing flask.ext.script is deprecated, use flask_script instead.</span><br><span class="line">.format(x=modname), ExtDeprecationWarning</span><br><span class="line">/root/superset-0.15.4/lib/python2.7/site-packages/flask/exthook.py:71: ExtDeprecationWarning: Importing flask.ext.sqlalchemy is deprecated, use flask_sqlalchemy instead.</span><br><span class="line">.format(x=modname), ExtDeprecationWarning</span><br><span class="line">/root/superset-0.15.4/lib/python2.7/site-packages/flask/exthook.py:71: ExtDeprecationWarning: Importing flask.ext.sqlalchemy._compat is deprecated, use flask_sqlalchemy._compat instead.</span><br><span class="line">.format(x=modname), ExtDeprecationWarning</span><br><span class="line">/root/superset-0.15.4/lib/python2.7/site-packages/flask_cache/init.py:152: UserWarning: Flask-Cache: CACHE_TYPE is <span class="built_in">set</span> to null, caching is effectively disabled.</span><br><span class="line">warnings.warn(<span class="string">"Flask-Cache: CACHE_TYPE is set to null, "</span></span><br><span class="line">/root/superset-0.15.4/lib/python2.7/site-packages/flask/exthook.py:71: ExtDeprecationWarning: Importing flask.ext.cache is deprecated, use flask_cache instead.</span><br><span class="line">.format(x=modname), ExtDeprecationWarning</span><br></pre></td></tr></tbody></table></figure>
<h5 id="解决-13"><a href="#解决-13" class="headerlink" title="解决"></a>解决</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim ./bin/superset</span><br><span class="line"></span><br><span class="line">  +import warnings</span><br><span class="line">  +from flask.exthook import ExtDeprecationWarning</span><br><span class="line">  +warnings.simplefilter(<span class="string">'ignore'</span>, ExtDeprecationWarning)</span><br><span class="line">  +</span><br><span class="line">  from superset.cli import manager</span><br></pre></td></tr></tbody></table></figure>
<p>　已提 RP#2138 <a href="https://github.com/apache/superset/pull/2138">Fix ExtDeprecationWarning</a></p>
<h2 id="遇到的坑"><a href="#遇到的坑" class="headerlink" title="遇到的坑"></a>遇到的坑</h2><h3 id="创建-user-时，需保证-email-的唯一性"><a href="#创建-user-时，需保证-email-的唯一性" class="headerlink" title="创建 user 时，需保证 email 的唯一性"></a>创建 user 时，需保证 email 的唯一性</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">Recognized Database Authentications.</span><br><span class="line">2016-12-14 18:12:36,007:ERROR:flask_appbuilder.security.sqla.manager:Error adding new user to database. (sqlite3.IntegrityError) column email is not unique [SQL: u<span class="string">'INSERT INTO ab_user (first_name, last_name, username, password, active, email, last_login, login_count, fail_login_count, created_on, changed_on, created_by_fk, changed_by_fk) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)'</span>] [parameters: (u<span class="string">'superset'</span>, u<span class="string">'yuzhouwan'</span>, u<span class="string">'superset'</span>, <span class="string">'pbkdf2:sha1:1000$e3imUMx0$83b38fb2a0f628d1379379bb353fc80697c435a1'</span>, 1, u<span class="string">'yuzhouwan@gmail.com'</span>, None, None, None, <span class="string">'2016-12-14 18:12:36.004721'</span>, <span class="string">'2016-12-14 18:12:36.004773'</span>, None, None)]</span><br><span class="line">No user created an error occured</span><br></pre></td></tr></tbody></table></figure>
<p>　使用 admin / admin 用户登录，进行修改</p>
<h3 id="缺少的依赖包"><a href="#缺少的依赖包" class="headerlink" title="缺少的依赖包"></a>缺少的依赖包</h3><h4 id="描述-12"><a href="#描述-12" class="headerlink" title="描述"></a>描述</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">RuntimeError: Compression requires the (missing) zlib module</span><br></pre></td></tr></tbody></table></figure>
<h4 id="解决-14"><a href="#解决-14" class="headerlink" title="解决"></a>解决</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ yum install zlib</span><br><span class="line">$ yum install zlib-devel</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进到 python2.7 目录 重新编译安装，软链接不需要重建</span></span><br><span class="line">$ <span class="built_in">cd</span> /root/software/Python-2.7.12</span><br><span class="line">$ make</span><br><span class="line">$ make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进到 setup-tools 目录 重新安装</span></span><br><span class="line">$ <span class="built_in">cd</span> /root/software/setuptools-32.0.0</span><br><span class="line">$ python setup.py install</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Python-无法装载模块（RedHat-Problem）"><a href="#Python-无法装载模块（RedHat-Problem）" class="headerlink" title="Python 无法装载模块（RedHat Problem）"></a>Python 无法装载模块（RedHat Problem）</h3><h4 id="pip-command-not-found"><a href="#pip-command-not-found" class="headerlink" title="pip: command not found"></a>pip: command not found</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 利用装载模块的方式 使用 pip</span></span><br><span class="line">$ python -m pip --version</span><br><span class="line">  pip 9.0.1 from /root/software/pip-9.0.1 (python 2.7)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改命令别名</span></span><br><span class="line">$ vim ~/.bashrc</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 未生效可直接执行</span></span><br><span class="line">  <span class="built_in">alias</span> pip=<span class="string">'python -m pip'</span></span><br><span class="line"></span><br><span class="line">$ pip --version</span><br><span class="line">  pip 9.0.1 from /root/software/pip-9.0.1 (python 2.7)</span><br></pre></td></tr></tbody></table></figure>
<h4 id="virtualenv-command-not-found"><a href="#virtualenv-command-not-found" class="headerlink" title="virtualenv: command not found"></a>virtualenv: command not found</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim ~/.bashrc</span><br><span class="line">  <span class="built_in">alias</span> virtualenv=<span class="string">'python -m virtualenv'</span></span><br><span class="line"></span><br><span class="line">$ virtualenv --version</span><br><span class="line">  15.1.0</span><br></pre></td></tr></tbody></table></figure>
<h3 id="安装-superset-需要下载依赖库"><a href="#安装-superset-需要下载依赖库" class="headerlink" title="安装 superset 需要下载依赖库"></a>安装 superset 需要下载依赖库</h3><h4 id="sasl-sasl-h：没有那个文件或目录"><a href="#sasl-sasl-h：没有那个文件或目录" class="headerlink" title="sasl/sasl.h：没有那个文件或目录"></a>sasl/sasl.h：没有那个文件或目录</h4><h5 id="描述-13"><a href="#描述-13" class="headerlink" title="描述"></a>描述</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">gcc: error trying to <span class="built_in">exec</span> <span class="string">'cc1plus'</span>: execvp: 没有那个文件或目录</span><br><span class="line">error: <span class="built_in">command</span> <span class="string">'gcc'</span> failed with <span class="built_in">exit</span> status 1</span><br><span class="line"></span><br><span class="line">cc1plus: 警告：命令行选项 “-Wstrict-prototypes” 对 Ada/C/ObjC 是有效的，但对 C++ 无效</span><br><span class="line">在包含自 sasl/saslwrapper.cpp：254 的文件中:</span><br><span class="line">sasl/saslwrapper.h:22:23: 错误：sasl/sasl.h：没有那个文件或目录</span><br></pre></td></tr></tbody></table></figure>
<h5 id="解决-15"><a href="#解决-15" class="headerlink" title="解决"></a>解决</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gcc -v</span><br><span class="line">  使用内建 specs。</span><br><span class="line">  目标：x86_64-redhat-linux</span><br><span class="line">  配置为：../configure --prefix=/usr --mandir=/usr/share/man --infodir=/usr/share/info --with-bugurl=http://bugzilla.redhat.com/bugzilla --<span class="built_in">enable</span>-bootstrap --<span class="built_in">enable</span>-shared --<span class="built_in">enable</span>-threads=posix --<span class="built_in">enable</span>-checking=release --with-system-zlib --<span class="built_in">enable</span>-__cxa_atexit --<span class="built_in">disable</span>-libunwind-exceptions --<span class="built_in">enable</span>-gnu-unique-object --<span class="built_in">enable</span>-languages=c,c++,objc,obj-c++,java,fortran,ada --<span class="built_in">enable</span>-java-awt=gtk --<span class="built_in">disable</span>-dssi --with-java-home=/usr/lib/jvm/java-1.5.0-gcj-1.5.0.0/jre --<span class="built_in">enable</span>-libgcj-multifile --<span class="built_in">enable</span>-java-maintainer-mode --with-ecj-jar=/usr/share/java/eclipse-ecj.jar --<span class="built_in">disable</span>-libjava-multilib --with-ppl --with-cloog --with-tune=generic --with-arch_32=i686 --build=x86_64-redhat-linux</span><br><span class="line">  线程模型：posix</span><br><span class="line">  gcc 版本 4.4.7 20120313 (Red Hat 4.4.7-4) (GCC)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 g++</span></span><br><span class="line"><span class="comment"># g++是c++的编译器，安装好之后，gcc会自动寻找c++程序所需的编译环境，进而编译成功</span></span><br><span class="line"><span class="comment"># wget ftp://rpmfind.net/linux/centos/6.8/os/x86_64/Packages/gcc-c++-4.4.7-17.el6.x86_64.rpm (需要完全一致 gcc 4.4.7-4才行)</span></span><br><span class="line"><span class="comment"># http://rpm.pbone.net/index.php3/stat/4/idpl/25438297/dir/scientific_linux_6/com/gcc-c++-4.4.7-4.el6.x86_64.rpm.html</span></span><br><span class="line"><span class="comment"># http://rpm.pbone.net/index.php3/stat/4/idpl/25440518/dir/scientific_linux_6/com/libstdc++-devel-4.4.7-4.el6.x86_64.rpm.html</span></span><br><span class="line">$ rpm -ivh libstdc++-devel-4.4.7-4.el6.x86_64.rpm</span><br><span class="line">$ rpm -ivh gcc-c++-4.4.7-4.el6.x86_64.rpm</span><br><span class="line"></span><br><span class="line">$ g++ -v</span><br><span class="line">  使用内建 specs。</span><br><span class="line">  目标：x86_64-redhat-linux</span><br><span class="line">  配置为：../configure --prefix=/usr --mandir=/usr/share/man --infodir=/usr/share/info --with-bugurl=http://bugzilla.redhat.com/bugzilla --<span class="built_in">enable</span>-bootstrap --<span class="built_in">enable</span>-shared --<span class="built_in">enable</span>-threads=posix --<span class="built_in">enable</span>-checking=release --with-system-zlib --<span class="built_in">enable</span>-__cxa_atexit --<span class="built_in">disable</span>-libunwind-exceptions --<span class="built_in">enable</span>-gnu-unique-object --<span class="built_in">enable</span>-languages=c,c++,objc,obj-c++,java,fortran,ada --<span class="built_in">enable</span>-java-awt=gtk --<span class="built_in">disable</span>-dssi --with-java-home=/usr/lib/jvm/java-1.5.0-gcj-1.5.0.0/jre --<span class="built_in">enable</span>-libgcj-multifile --<span class="built_in">enable</span>-java-maintainer-mode --with-ecj-jar=/usr/share/java/eclipse-ecj.jar --<span class="built_in">disable</span>-libjava-multilib --with-ppl --with-cloog --with-tune=generic --with-arch_32=i686 --build=x86_64-redhat-linux</span><br><span class="line">  线程模型：posix</span><br><span class="line">  gcc 版本 4.4.7 20120313 (Red Hat 4.4.7-4) (GCC)</span><br></pre></td></tr></tbody></table></figure>
<h4 id="命令行选项-Wstrict-prototypes-对-Ada-C-ObjC-是有效的，但对-C-无效"><a href="#命令行选项-Wstrict-prototypes-对-Ada-C-ObjC-是有效的，但对-C-无效" class="headerlink" title="命令行选项 -Wstrict-prototypes 对 Ada/C/ObjC 是有效的，但对 C++ 无效"></a>命令行选项 -Wstrict-prototypes 对 Ada/C/ObjC 是有效的，但对 C++ 无效</h4><h5 id="描述-14"><a href="#描述-14" class="headerlink" title="描述"></a>描述</h5><p>　cc1plus: 警告：命令行选项 “-Wstrict-prototypes” 对 Ada/C/ObjC 是有效的，但对 C++ 无效</p>
<h5 id="解决-16"><a href="#解决-16" class="headerlink" title="解决"></a>解决</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># cmake 版本过低（这里是没有安装）</span></span><br><span class="line"><span class="comment"># https://cmake.org/ (stable: 3.6.3, lastest: 3.7.1, date: 2016/12/16)</span></span><br><span class="line"><span class="comment"># https://cmake.org/cmake/help/v3.6/</span></span><br><span class="line">$ wget --no-check-certificate  https://cmake.org/files/v3.6/cmake-3.6.3.tar.gz	<span class="comment"># To connect to cmake.org insecurely</span></span><br><span class="line">$ tar zxvf cmake-3.6.3.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> cmake-3.6.3</span><br><span class="line">$ ./bootstrap</span><br><span class="line">$ make</span><br><span class="line">$ gmake install</span><br><span class="line"></span><br><span class="line">$ cmake -version</span><br><span class="line">$ cmake version 3.6.3</span><br><span class="line">$ CMake suite maintained and supported by Kitware (kitware.com/cmake).</span><br><span class="line"></span><br><span class="line"><span class="comment"># reboot (should)</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> ~</span><br><span class="line">$ mkdir virtualenv</span><br><span class="line">$ <span class="built_in">cd</span> virtualenv</span><br><span class="line">$ virtualenv env1</span><br><span class="line">$ virtualenv --python=/usr/bin/python env1</span><br><span class="line"></span><br><span class="line"><span class="comment"># new problem</span></span><br><span class="line"><span class="comment"># IOError: [Errno 40] Too many levels of symbolic links: '/root/virtualenv/env1/bin/python'</span></span><br><span class="line"><span class="comment"># 不能直接 rm -rf env1，需要用 rmvirtualenv 才行</span></span><br><span class="line">$ rmvirtualenv env1</span><br><span class="line">$ <span class="built_in">cd</span> env1</span><br><span class="line">$ <span class="built_in">source</span> bin/activate		   <span class="comment"># 退出 deactivate</span></span><br><span class="line">(env1) [root@edeppreapp01 env1] <span class="comment"># python -V</span></span><br><span class="line">  Python 2.7.12</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Could-not-find-a-version-that-satisfies-the-requirement-pytz-gt-dev"><a href="#Could-not-find-a-version-that-satisfies-the-requirement-pytz-gt-dev" class="headerlink" title="Could not find a version that satisfies the requirement pytz>dev"></a>Could not find a version that satisfies the requirement pytz&gt;dev</h4><h5 id="描述-15"><a href="#描述-15" class="headerlink" title="描述"></a>描述</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 如果一个一个依赖去安装 会很麻烦</span></span><br><span class="line">Could not find a version that satisfies the requirement pytz&gt;dev (from celery==3.1.23) (from versions: )</span><br><span class="line">Could not find a version that satisfies the requirement billiard&lt;3.4,&gt;=3.3.0.23 (from celery==3.1.23) (from versions: )</span><br><span class="line">No matching distribution found <span class="keyword">for</span> amqp&lt;2.0,&gt;=1.4.9 (from kombu==3.0.35)</span><br><span class="line">No matching distribution found <span class="keyword">for</span> anyjson&gt;=0.3.3 (from kombu==3.0.35)</span><br><span class="line">No matching distribution found <span class="keyword">for</span> kombu&lt;3.1,&gt;=3.0.34 (from celery==3.1.23)</span><br><span class="line">No matching distribution found <span class="keyword">for</span> celery==3.1.23 (from superset)</span><br><span class="line">Could not find suitable distribution <span class="keyword">for</span> Requirement.parse(<span class="string">'werkzeug==0.11.10'</span>)</span><br><span class="line">pip install thrift-0.9.3.tar.gz</span><br><span class="line">No matching distribution found <span class="keyword">for</span> six (from sasl==0.2.1)</span><br><span class="line">No matching distribution found <span class="keyword">for</span> sasl&gt;=0.2.1 (from thrift-sasl==0.2.1)</span><br><span class="line">No <span class="built_in">local</span> packages or working download links found <span class="keyword">for</span> thrift-sasl&gt;=0.2.1</span><br></pre></td></tr></tbody></table></figure>
<h5 id="解决-17"><a href="#解决-17" class="headerlink" title="解决"></a>解决</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ pip list</span><br><span class="line">$ pip freeze &gt; requirements.txt</span><br><span class="line">$ mkdir packages</span><br><span class="line">$ pip install --download package -r requirements.txt</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> packages</span><br><span class="line">$ scp celery-3.1.23-py2.py3-none-any.whl root@druid01:/root/software/packages</span><br><span class="line"></span><br><span class="line"><span class="comment"># --find-links 可以在指定目录中，找到 superset 的相关依赖，依次安装好</span></span><br><span class="line">$ python -m pip install --no-index --find-links=packages superset <span class="comment"># -r requirements.txt</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="ImportError-No-module-named-ssl"><a href="#ImportError-No-module-named-ssl" class="headerlink" title="ImportError: No module named ssl"></a>ImportError: No module named ssl</h3><h4 id="解决-18"><a href="#解决-18" class="headerlink" title="解决"></a>解决</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 安装 ssl</span></span><br><span class="line">$ yum install yum-downloadonly -y</span><br><span class="line"></span><br><span class="line">$ yum -y install ncurses ncurses-devel gcc-c++ libxml2-devel gd gd-devel libpng libpng-devel libjpeg libjpeg-devel libmcrypt libmcrypt-devel openldap-devel openldap-servers openldap-clients autoconf freetype-devel libtool-ltdl-devel openssl openssl-devel gcc automake autoconf libtool make --downloadonly --downloaddir=.</span><br><span class="line"></span><br><span class="line">$ yum -y install GeoIP gmp libevent libmcrypt libtidy libXpm libxslt mhash mysql mysql-server nfs-utils nginx perl-DBD-MySQL perl-DBI php php-common php-fpm php-gd php-mbstring php-mcrypt php-mhash php-mysql php-pdo php-xml t1lib --downloadonly --downloaddir=.</span><br><span class="line"></span><br><span class="line">$ rpm -Uvh --force --nodeps *.rpm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新编译 Python</span></span><br><span class="line">$ <span class="built_in">cd</span> /root/software/Python-2.7.12</span><br><span class="line">$ vim Modules/Setup.dist</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 取消注释</span></span><br><span class="line">  SSL=/usr/<span class="built_in">local</span>/ssl</span><br><span class="line">  _ssl _ssl.c \</span><br><span class="line">         -DUSE_SSL -I$(SSL)/include -I$(SSL)/include/openssl \</span><br><span class="line">         -L$(SSL)/lib -lssl -lcrypto</span><br><span class="line"></span><br><span class="line">$ ./configure --<span class="built_in">enable</span>-shared CFLAGS=-fPIC //--<span class="built_in">enable</span>-shared option means to generate dynamic library libpython2.7.so.1.0</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># Not work</span></span><br><span class="line">$ python --version</span><br><span class="line">  Python 2.7.12</span><br><span class="line"></span><br><span class="line">$ python</span><br><span class="line">Python 2.7.12 (default, Dec 19 2016, 10:58:27) </span><br><span class="line">[GCC 4.4.7 20120313 (Red Hat 4.4.7-4)] on linux2</span><br><span class="line">Type <span class="string">"help"</span>, <span class="string">"copyright"</span>, <span class="string">"credits"</span> or <span class="string">"license"</span> <span class="keyword">for</span> more information.</span><br><span class="line">&gt;&gt;&gt; import ssl</span><br><span class="line">&gt;&gt;&gt; Traceback (most recent call last):</span><br><span class="line">&gt;&gt;&gt; File <span class="string">"&lt;stdin&gt;"</span>, line 1, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">&gt;&gt;&gt; File <span class="string">"/usr/local/lib/python2.7/ssl.py"</span>, line 97, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">&gt;&gt;&gt; import _ssl             <span class="comment"># if we can't import it, let the error propagate</span></span><br><span class="line">&gt;&gt;&gt; ImportError: No module named _ssl</span><br><span class="line">&gt;&gt;&gt; quit()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装缺少的 openssl-devel</span></span><br><span class="line">$ rpm -aq | grep openssl</span><br><span class="line">  openssl-1.0.1e-42.el6_7.4.x86_64</span><br><span class="line"></span><br><span class="line">$ yum install openssl-devel -y</span><br><span class="line"></span><br><span class="line">$ rpm -aq | grep openssl</span><br><span class="line">  openssl-1.0.1e-42.el6_7.4.x86_64</span><br><span class="line">  openssl-devel-1.0.1e-42.el6_7.4.x86_64</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改 Setup 文件</span></span><br><span class="line">$ vim /root/software/Python-2.7.12/Modules/Setup</span><br><span class="line">  <span class="comment"># Socket module helper for socket(2)</span></span><br><span class="line">  _socket socketmodule.c timemodule.c</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Socket module helper for SSL support; you must comment out the other</span></span><br><span class="line">  <span class="comment"># socket line above, and possibly edit the SSL variable:</span></span><br><span class="line">  <span class="comment">#SSL=/usr/local/ssl</span></span><br><span class="line">  _ssl _ssl.c \</span><br><span class="line">  -DUSE_SSL -I$(SSL)/include -I$(SSL)/include/openssl \</span><br><span class="line">  -L$(SSL)/lib -lssl -lcrypto</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新编译</span></span><br><span class="line">$ <span class="built_in">cd</span> /root/software/Python-2.7.12</span><br><span class="line">$ make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line">$ python</span><br><span class="line">Python 2.7.12 (default, Dec 19 2016, 11:08:33) </span><br><span class="line">[GCC 4.4.7 20120313 (Red Hat 4.4.7-4)] on linux2</span><br><span class="line">Type <span class="string">"help"</span>, <span class="string">"copyright"</span>, <span class="string">"credits"</span> or <span class="string">"license"</span> <span class="keyword">for</span> more information.</span><br><span class="line">&gt;&gt;&gt; import ssl</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> /root/virtualenv/superset/bin</span><br><span class="line">[root@olap03-sit bin]<span class="comment"># python</span></span><br><span class="line">Python 2.7.12 (default, Dec 19 2016, 11:08:33) </span><br><span class="line">[GCC 4.4.7 20120313 (Red Hat 4.4.7-4)] on linux2</span><br><span class="line">Type <span class="string">"help"</span>, <span class="string">"copyright"</span>, <span class="string">"credits"</span> or <span class="string">"license"</span> <span class="keyword">for</span> more information.</span><br><span class="line">&gt;&gt;&gt; import ssl</span><br><span class="line"></span><br><span class="line">$ /root/virtualenv/superset/bin/python</span><br><span class="line">Python 2.7.12 (default, Dec 16 2016, 16:23:17) </span><br><span class="line">[GCC 4.4.6 20120305 (Red Hat 4.4.6-4)] on linux2</span><br><span class="line">Type <span class="string">"help"</span>, <span class="string">"copyright"</span>, <span class="string">"credits"</span> or <span class="string">"license"</span> <span class="keyword">for</span> more information.</span><br><span class="line">&gt;&gt;&gt; import ssl</span><br><span class="line">&gt;&gt;&gt; Traceback (most recent call last):</span><br><span class="line">&gt;&gt;&gt; File <span class="string">"&lt;stdin&gt;"</span>, line 1, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">&gt;&gt;&gt; File <span class="string">"/usr/local/python27/lib/python2.7/ssl.py"</span>, line 97, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">&gt;&gt;&gt; import _ssl             <span class="comment"># if we can't import it, let the error propagate</span></span><br><span class="line">&gt;&gt;&gt; ImportError: No module named _ssl</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ mv /root/virtualenv/superset/bin/python /root/virtualenv/superset/bin/python_old</span><br><span class="line">$ ln -s /usr/<span class="built_in">local</span>/bin/python /root/virtualenv/superset/bin/</span><br><span class="line"></span><br><span class="line">$ ./python</span><br><span class="line">Python 2.7.12 (default, Dec 19 2016, 11:08:33) </span><br><span class="line">[GCC 4.4.7 20120313 (Red Hat 4.4.7-4)] on linux2</span><br><span class="line">Type <span class="string">"help"</span>, <span class="string">"copyright"</span>, <span class="string">"credits"</span> or <span class="string">"license"</span> <span class="keyword">for</span> more information.</span><br><span class="line">&gt;&gt;&gt; import ssl</span><br><span class="line">&gt;&gt;&gt; quit()</span><br><span class="line">&gt;&gt;&gt; [root@olap03-sit bin]<span class="comment"># </span></span><br><span class="line">&gt;&gt;&gt; [root@olap03-sit bin]<span class="comment"># </span></span><br><span class="line">&gt;&gt;&gt; [root@olap03-sit bin]<span class="comment"># pwd</span></span><br><span class="line">&gt;&gt;&gt; /root/virtualenv/superset/bin</span><br><span class="line">&gt;&gt;&gt; [root@olap03-sit bin]<span class="comment"># /root/virtualenv/superset/bin/python</span></span><br><span class="line">&gt;&gt;&gt; Python 2.7.12 (default, Dec 19 2016, 11:08:33) </span><br><span class="line">&gt;&gt;&gt; [GCC 4.4.7 20120313 (Red Hat 4.4.7-4)] on linux2</span><br><span class="line">&gt;&gt;&gt; Type <span class="string">"help"</span>, <span class="string">"copyright"</span>, <span class="string">"credits"</span> or <span class="string">"license"</span> <span class="keyword">for</span> more information.</span><br><span class="line">&gt;&gt;&gt; import ssl</span><br><span class="line">&gt;&gt;&gt; quit()</span><br><span class="line">&gt;&gt;&gt; [root@olap03-sit bin]<span class="comment"># python</span></span><br><span class="line">&gt;&gt;&gt; Python 2.7.12 (default, Dec 19 2016, 11:08:33) </span><br><span class="line">&gt;&gt;&gt; [GCC 4.4.7 20120313 (Red Hat 4.4.7-4)] on linux2</span><br><span class="line">&gt;&gt;&gt; Type <span class="string">"help"</span>, <span class="string">"copyright"</span>, <span class="string">"credits"</span> or <span class="string">"license"</span> <span class="keyword">for</span> more information.</span><br><span class="line">&gt;&gt;&gt; import ssl</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line">&gt;&gt;&gt; <span class="built_in">source</span> bin/activate</span><br><span class="line">&gt;&gt;&gt; (superset) [root@olap03-sit superset]<span class="comment"># which python</span></span><br><span class="line">&gt;&gt;&gt; /root/virtualenv/superset/bin/python</span><br><span class="line">&gt;&gt;&gt; (superset) [root@olap03-sit superset]<span class="comment"># python</span></span><br><span class="line">&gt;&gt;&gt; Python 2.7.12 (default, Dec 19 2016, 11:08:33) </span><br><span class="line">&gt;&gt;&gt; [GCC 4.4.7 20120313 (Red Hat 4.4.7-4)] on linux2</span><br><span class="line">&gt;&gt;&gt; Type <span class="string">"help"</span>, <span class="string">"copyright"</span>, <span class="string">"credits"</span> or <span class="string">"license"</span> <span class="keyword">for</span> more information.</span><br><span class="line">&gt;&gt;&gt; import ssl</span><br><span class="line">&gt;&gt;&gt; quit()</span><br><span class="line"></span><br><span class="line"><span class="comment"># ImportError: No module named gunicorn.app.base</span></span><br><span class="line">import gunicorn.app.base</span><br></pre></td></tr></tbody></table></figure>
<h3 id="python-error-while-loading-shared-libraries-libpython2-7-so-1-0"><a href="#python-error-while-loading-shared-libraries-libpython2-7-so-1-0" class="headerlink" title="python: error while loading shared libraries: libpython2.7.so.1.0"></a>python: error while loading shared libraries: libpython2.7.so.1.0</h3><h4 id="描述-16"><a href="#描述-16" class="headerlink" title="描述"></a>描述</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ ./configure --prefix=/usr/<span class="built_in">local</span>/python27 --<span class="built_in">enable</span>-shared CFLAGS=-fPIC //--<span class="built_in">enable</span>-shared option means to generate dynamic library libpython2.7.so.1.0</span><br><span class="line">$ make &amp;&amp; make install</span><br><span class="line">$ python -V</span><br><span class="line">  python: error <span class="keyword">while</span> loading shared libraries: libpython2.7.so.1.0: cannot open shared object file: No such file or directory</span><br></pre></td></tr></tbody></table></figure>
<h4 id="解决-19"><a href="#解决-19" class="headerlink" title="解决"></a>解决</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ yum reinstall python-libs		--not work</span><br><span class="line"></span><br><span class="line">$ ll /usr/<span class="built_in">local</span>/python27/lib/libpython2.7.so.1.0		--not work</span><br><span class="line">$ vim /etc/ld.so.conf</span><br><span class="line">  include ld.so.conf.d/*.conf</span><br><span class="line">  include /usr/<span class="built_in">local</span>/Python2.7/lib</span><br><span class="line"></span><br><span class="line">$ /sbin/ldconfig -v | grep /</span><br><span class="line">  /lib:</span><br><span class="line">  /lib64:</span><br><span class="line">  /usr/lib:</span><br><span class="line">  /usr/lib64:</span><br><span class="line">  /lib64/tls: (hwcap: 0x8000000000000000)</span><br><span class="line">  /usr/lib64/sse2: (hwcap: 0x0000000004000000)</span><br><span class="line">  /usr/lib64/tls: (hwcap: 0x8000000000000000)</span><br><span class="line"></span><br><span class="line">$ ./configure --prefix=/usr --<span class="built_in">enable</span>-shared CFLAGS=-fPIC</span><br><span class="line">$ make &amp;&amp; make install</span><br><span class="line">$ /sbin/ldconfig -v | grep /</span><br><span class="line">$ python -V</span><br><span class="line">  Python 2.7.12</span><br></pre></td></tr></tbody></table></figure>
<h3 id="ImportError-No-module-named-pysqlite2"><a href="#ImportError-No-module-named-pysqlite2" class="headerlink" title="ImportError: No module named pysqlite2"></a>ImportError: No module named pysqlite2</h3><h4 id="解决-20"><a href="#解决-20" class="headerlink" title="解决"></a>解决</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim /root/superset/lib/python2.7/site-packages/sqlalchemy/dialects/sqlite/pysqlite.py</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 sqlite3</span></span><br><span class="line">@classmethod</span><br><span class="line">def dbapi(cls):</span><br><span class="line">try:</span><br><span class="line">  <span class="comment"># 改为 from sqlite3 import dbapi2 as sqlite</span></span><br><span class="line">  from pysqlite2 import dbapi2 as sqlite</span><br><span class="line">except ImportError as e:</span><br><span class="line">  try:</span><br><span class="line">    from sqlite3 import dbapi2 as sqlite  <span class="comment"># try 2.5+ stdlib name.</span></span><br><span class="line">  except ImportError:</span><br><span class="line">    raise e</span><br><span class="line"><span class="built_in">return</span> sqlite</span><br><span class="line"></span><br><span class="line"><span class="comment"># Redhat 5.3 环境下，要源代码安装 sqlite3，然后安装 python 才能有 _sqlite3.so 这个文件</span></span><br><span class="line">$ wget https://sqlite.org/snapshot/sqlite-snapshot-201612131847.tar.gz</span><br><span class="line">$ sqlite3 --version</span><br><span class="line">  3.6.20</span><br></pre></td></tr></tbody></table></figure>
<h3 id="pip-is-configured-with-locations-that-require-TLS-SSL-however-the-ssl-module-in-Python-is-not-available"><a href="#pip-is-configured-with-locations-that-require-TLS-SSL-however-the-ssl-module-in-Python-is-not-available" class="headerlink" title="pip is configured with locations that require TLS/SSL, however the ssl module in Python is not available."></a>pip is configured with locations that require TLS/SSL, however the ssl module in Python is not available.</h3><h4 id="解决-21"><a href="#解决-21" class="headerlink" title="解决"></a>解决</h4><h5 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 清除所有的 alias 和 superset 源码中 python 路径的修改</span></span><br><span class="line">$ <span class="built_in">which</span> pip</span><br><span class="line">$ <span class="built_in">alias</span> pip=<span class="string">'python -m pip'</span></span><br><span class="line">$ /root/superset/bin/python</span><br><span class="line"></span><br><span class="line">$ vim ~/.bashrc</span><br><span class="line"><span class="comment"># alias pip='python -m pip'</span></span><br><span class="line"><span class="comment"># alias virtualenv='python -m virtualenv'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Source global definitions</span></span><br><span class="line"><span class="comment"># export WORKON_HOME=~/virtualenv</span></span><br><span class="line"><span class="comment"># source /usr/local/bin/virtualenvwrapper.sh</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">source</span> ~/.bashrc</span><br><span class="line">$ deactivate</span><br><span class="line">$ yum install python-pip</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">unalias</span> pip</span><br><span class="line">$ <span class="built_in">which</span> pip</span><br><span class="line">$ /usr/bin/pip</span><br><span class="line"></span><br><span class="line">$ superset runserver -a 0.0.0.0 -p 9999</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/lib/python2.7/site-packages</span><br><span class="line"></span><br><span class="line">$ python</span><br><span class="line">  Python 2.7.12 (default, Dec 19 2016, 11:08:33) </span><br><span class="line">  [GCC 4.4.7 20120313 (Red Hat 4.4.7-4)] on linux2</span><br><span class="line">  Type <span class="string">"help"</span>, <span class="string">"copyright"</span>, <span class="string">"credits"</span> or <span class="string">"license"</span> <span class="keyword">for</span> more information.</span><br><span class="line">  &gt;&gt;&gt; import ssl</span><br><span class="line">  &gt;&gt;&gt; ssl</span><br><span class="line">  &lt;module <span class="string">'ssl'</span> from <span class="string">'/usr/local/lib/python2.7/ssl.pyc'</span>&gt;</span><br><span class="line">  &gt;&gt;&gt; quit()</span><br><span class="line"></span><br><span class="line">$ vim mypkpath.pth</span><br><span class="line">  /usr/<span class="built_in">local</span>/lib/python2.7</span><br><span class="line"></span><br><span class="line">$ vim ~/.bashrc</span><br><span class="line">  <span class="built_in">alias</span> python=/usr/<span class="built_in">local</span>/bin/python</span><br><span class="line">  <span class="built_in">alias</span> pip=/usr/bin/pip</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">source</span> ~/.bashrc		--not work（superset 的 py程序开头都有 <span class="comment">#!/root/superset/bin/python）</span></span><br><span class="line">$ vim /root/superset/bin/superset</span><br><span class="line">  <span class="comment">#!/usr/local/bin/python</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 利用 prefix 将 python 的第三方库安装到 /usr/lib 中</span></span><br><span class="line">$ ./configure --prefix=/usr --<span class="built_in">enable</span>-shared CFLAGS=-fPIC</span><br><span class="line">$ make &amp;&amp; make install</span><br><span class="line">$ /sbin/ldconfig -v | grep /</span><br><span class="line">$ python -V</span><br><span class="line">  Python 2.7.12</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Error-while-processing-cluster-‘druid-cluster’-sqlite3-Operational-Error-database-is-locked"><a href="#Error-while-processing-cluster-‘druid-cluster’-sqlite3-Operational-Error-database-is-locked" class="headerlink" title="Error while processing cluster ‘druid cluster’ (sqlite3. Operational Error) database is locked"></a>Error while processing cluster ‘druid cluster’ (sqlite3. Operational Error) database is locked</h3><h4 id="描述-17"><a href="#描述-17" class="headerlink" title="描述"></a>描述</h4><p>　[Web UI] Sources - Druid Clusters 配置 - Refresh Druid Metadata</p>
<h4 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h4><p>　Web 中无法维持长连接，会超时</p>
<h4 id="解决-22"><a href="#解决-22" class="headerlink" title="解决"></a>解决</h4><p>　superset refresh_druid</p>
<p>Tips: 目前最新的 v0.22.1 版本中，已经解决了这个问题，可以在页面上直接点击 “Sources - Refresh Druid Metadata” 按钮，完成操作（2017-12-12）</p>
<h3 id="An-unknown-error-occurred-Status-0-Maybe-the-request-timed-out"><a href="#An-unknown-error-occurred-Status-0-Maybe-the-request-timed-out" class="headerlink" title="An unknown error occurred. (Status: 0) Maybe the request timed out?"></a>An unknown error occurred. (Status: 0) Maybe the request timed out?</h3><h4 id="描述-18"><a href="#描述-18" class="headerlink" title="描述"></a>描述</h4><p>　部分图标 无法正常显示</p>
<h4 id="解决-23"><a href="#解决-23" class="headerlink" title="解决"></a>解决</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 打开 debug 模式，查看详细日志，定位问题</span></span><br><span class="line">$ vim ./lib/python2.7/site-packages/superset/config.py</span><br><span class="line"></span><br><span class="line">  <span class="comment"># DEBUG = False</span></span><br><span class="line">  DEBUG = True</span><br></pre></td></tr></tbody></table></figure>
<h3 id="ImportError-No-module-named-pymysql"><a href="#ImportError-No-module-named-pymysql" class="headerlink" title="ImportError: No module named pymysql"></a>ImportError: No module named pymysql</h3><h4 id="解决-24"><a href="#解决-24" class="headerlink" title="解决"></a>解决</h4><p>　<code>pip install pymysql</code></p>
<h3 id="uHost-druid01-is-not-allowed-to-connect-to-this-MySQL-server"><a href="#uHost-druid01-is-not-allowed-to-connect-to-this-MySQL-server" class="headerlink" title="uHost druid01 is not allowed to connect to this MySQL server"></a>uHost druid01 is not allowed to connect to this MySQL server</h3><h4 id="描述-19"><a href="#描述-19" class="headerlink" title="描述"></a>描述</h4><p>　nohup superset runserver -a 0.0.0.0 -p 8888 2&gt;&amp;1 &amp;</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">2017-01-22 16:36:53,013:ERROR:flask_appbuilder.security.sqla.manager:DB Creation and initialization failed: (pymysql.err.InternalError) (1130, u<span class="string">"Host 'druid01' is not allowed to connect to this MySQL server"</span>)</span><br></pre></td></tr></tbody></table></figure>
<h4 id="解决-25"><a href="#解决-25" class="headerlink" title="解决"></a>解决</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">GRANT ALL PRIVILEGES ON *.* TO <span class="string">'root'</span>@<span class="string">'druid01'</span> IDENTIFIED BY <span class="string">'root'</span> WITH GRANT OPTION;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Permission-for-Druid"><a href="#Permission-for-Druid" class="headerlink" title="Permission for Druid"></a>Permission for Druid</h3><h4 id="解决-26"><a href="#解决-26" class="headerlink" title="解决"></a>解决</h4><p>　增加新的数据源之后，需要 <code>superset init</code>，来更新 permission 相关的数据表</p>
<h3 id="Update-Druid-Cluster’s-Name"><a href="#Update-Druid-Cluster’s-Name" class="headerlink" title="Update Druid Cluster’s Name"></a>Update Druid Cluster’s Name</h3><h4 id="解决-27"><a href="#解决-27" class="headerlink" title="解决"></a>解决</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">alter table datasources drop FOREIGN KEY `datasources_ibfk_2`;</span><br><span class="line">update clusters <span class="built_in">set</span> cluster_name=<span class="string">'Druid Cluster'</span> <span class="built_in">where</span> cluster_name=<span class="string">'druid cluster'</span>;</span><br><span class="line">update datasources <span class="built_in">set</span> cluster_name =<span class="string">'Druid Cluster'</span> <span class="built_in">where</span> cluster_name =<span class="string">'druid cluster'</span>;</span><br><span class="line">alter table datasources add constraint  `datasources_ibfk_2`  FOREIGN KEY (`cluster_name`) REFERENCES `clusters` (`cluster_name`);</span><br><span class="line"><span class="comment"># show create table datasources; # troubleshooting</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="An-unexpected-error-occurred-“https-registry-yarnpkg-com-convert-source-map-ETIMEDOUT”"><a href="#An-unexpected-error-occurred-“https-registry-yarnpkg-com-convert-source-map-ETIMEDOUT”" class="headerlink" title="An unexpected error occurred: “https://registry.yarnpkg.com/convert-source-map: ETIMEDOUT”"></a>An unexpected error occurred: “<a href="https://registry.yarnpkg.com/convert-source-map">https://registry.yarnpkg.com/convert-source-map</a>: ETIMEDOUT”</h3><h4 id="描述-20"><a href="#描述-20" class="headerlink" title="描述"></a>描述</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ yarn</span><br><span class="line">  yarn install v1.3.2</span><br><span class="line">  info No lockfile found.</span><br><span class="line">  [1/4] Resolving packages...</span><br><span class="line">  error An unexpected error occurred: <span class="string">"https://registry.yarnpkg.com/@vx%2fbounds: ETIMEDOUT"</span>.</span><br><span class="line">  info If you think this is a bug, please open a bug report with the information provided <span class="keyword">in</span> <span class="string">"/home/superset/software/incubator-superset-0.22.1/superset/assets/yarn-error.log"</span>.</span><br><span class="line">  info Visit https://yarnpkg.com/en/docs/cli/install <span class="keyword">for</span> documentation about this <span class="built_in">command</span>.</span><br></pre></td></tr></tbody></table></figure>
<h4 id="解决-28"><a href="#解决-28" class="headerlink" title="解决"></a>解决</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 由于不知名的外星力量，需要先替换掉原始的 IP 地址</span></span><br><span class="line">$ vim /etc/hosts</span><br><span class="line">  104.16.59.173 registry.yarnpkg.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 控制网络并发量，减少 TIMEOUT 发生的可能</span></span><br><span class="line">$ yarn --network-concurrency 1</span><br></pre></td></tr></tbody></table></figure>
<h2 id="社区跟进"><a href="#社区跟进" class="headerlink" title="社区跟进"></a>社区跟进</h2><ul>
<li><a href="https://github.com/apache/superset/issues?utf8=%E2%9C%93&amp;q=%20is%3Aissue%20author%3Aasdf2014%20">Issues</a></li>
<li><a href="https://github.com/apache/superset/pulls?utf8=%E2%9C%93&amp;q=%20is%3Apr%20author%3Aasdf2014%20">Pull Request</a></li>
</ul>
<p>　详见：《<a href="https://yuzhouwan.com/posts/19631/">如何成为 Apache 的 PMC</a>》</p>
<h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><h3 id="Doc"><a href="#Doc" class="headerlink" title="Doc"></a>Doc</h3><ul>
<li><a href="https://superset.apache.org/installation.html#getting-started">Superset Doc</a></li>
<li><a href="http://docs.gunicorn.org/en/stable/install.html">Gunicorn Doc</a></li>
<li><a href="http://docs.jinkan.org/docs/flask/">Flask Doc</a></li>
<li><a href="http://jinja.pocoo.org/docs/2.9/">Jinja Doc</a></li>
<li><a href="https://www.djangoproject.com/">Django Doc</a></li>
<li><a href="https://pythonhosted.org/pydruid/">Welcome to pydruid´s documentation!</a></li>
<li><a href="http://pandas.pydata.org/">Python Data Analysis Library</a></li>
<li><a href="http://www.scipy.org/stackspec.html">The SciPy Stack specification</a></li>
<li><a href="http://scikit-learn.org/stable/">Scikit-learn</a></li>
<li><a href="http://pandas.pydata.org">Pandas Doc</a></li>
</ul>
<h3 id="Book"><a href="#Book" class="headerlink" title="Book"></a>Book</h3><ul>
<li><a href="https://spacewander.github.io/explore-flask-zh/index.html">《Flask之旅》</a></li>
<li><a href="http://es6.ruanyifeng.com/">《ECMAScript 6 入门》</a></li>
</ul>
<h3 id="Source"><a href="#Source" class="headerlink" title="Source"></a>Source</h3><ul>
<li><a href="https://github.com/druid-io/pydruid#pydruid">pydruid (A Python connector for Druid)</a></li>
<li><a href="http://rpmfind.net/">rpmfind.net</a></li>
<li><a href="http://rpm.pbone.net/">rpm.pbone.net</a>  （better, download with <code>mirror.switch.ch</code>）</li>
</ul>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt=""></a></td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>大数据</category>
      </categories>
      <tags>
        <tag>Apache Druid</tag>
        <tag>Apache Superset</tag>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>Presto：分布式 SQL 查询引擎</title>
    <url>/posts/200906/</url>
    <content><![CDATA[<h2 id="Presto-是什么？"><a href="#Presto-是什么？" class="headerlink" title="Presto 是什么？"></a>Presto 是什么？</h2><blockquote>
<p><strong><a href="https://prestodb.io/">Presto</a></strong>™ (PrestoDB) is an open source distributed SQL query engine for running interactive analytic queries against data sources of all sizes ranging from gigabytes to petabytes.</p>
<p><strong><a href="https://prestosql.io/">Presto</a></strong>™ (PrestoSQL) is a high performance, distributed SQL query engine for big data.</p>
</blockquote>
<div class="note success">下文将详细介绍二者的区别</div>



<h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><h3 id="组件"><a href="#组件" class="headerlink" title="组件"></a>组件</h3><h4 id="Coordinator"><a href="#Coordinator" class="headerlink" title="Coordinator"></a>Coordinator</h4><p>　负责管理 Worker 和 MetaStore 节点，以及接受客户端查询请求，并进行 SQL 的语法解析（Parser）、执行计划生成与优化（Planner）和查询任务的调度（Scheduler）</p>
<div class="note info">Coordinator 通过 RESTful 接口与 Client 和 Worker 交互</div>

<h4 id="Worker"><a href="#Worker" class="headerlink" title="Worker"></a>Worker</h4><p>　负责具体的查询计算和数据读写</p>
<h4 id="Discovery-Server"><a href="#Discovery-Server" class="headerlink" title="Discovery Server"></a>Discovery Server</h4><p>　负责发现集群的各个节点，用于节点间心跳监控</p>
<div class="note success">一般 Discovery Server 混布在 Coordinator 节点上，也支持单独部署</div>

<a id="more"></a>
<h3 id="数据源"><a href="#数据源" class="headerlink" title="数据源"></a>数据源</h3><h4 id="Connector"><a href="#Connector" class="headerlink" title="Connector"></a>Connector</h4><p>　负责访问不同的数据源，相当于访问数据库的驱动</p>
<h4 id="Catalog"><a href="#Catalog" class="headerlink" title="Catalog"></a>Catalog</h4><p>　负责记录 Schema 信息和 DataSource 的引用。Presto 中一个完整的表名通过 <code>&lt;Catalog&gt;.&lt;Schema&gt;.&lt;Table&gt;</code> 组合表示。例如 <code>hive.test_data.test</code>，则表示：</p>
<ul>
<li>Catalog 为 <code>hive</code></li>
<li>Schema 为 <code>test_data</code></li>
<li>Table 为 <code>test</code></li>
</ul>
<h4 id="Schema"><a href="#Schema" class="headerlink" title="Schema"></a>Schema</h4><p>　一种组织 Table 的方式</p>
<h4 id="Table"><a href="#Table" class="headerlink" title="Table"></a>Table</h4><p>　等同于关系型数据库中表的概念</p>
<h3 id="查询模型"><a href="#查询模型" class="headerlink" title="查询模型"></a>查询模型</h3><h4 id="Statement"><a href="#Statement" class="headerlink" title="Statement"></a>Statement</h4><p>　兼容 ANSI 标准的 SQL 字符串</p>
<h4 id="Query"><a href="#Query" class="headerlink" title="Query"></a>Query</h4><p>　当 Presto 解析一条 SQL 语句时，会将其转换为 Query，并创建一个分布式 Query 执行计划</p>
<div class="note info">整个查询过程涉及 Stage、Task、Split、Connector 和 DataSource 等组件的协同工作</div>

<h4 id="Stage"><a href="#Stage" class="headerlink" title="Stage"></a>Stage</h4><p>　当 Presto 执行查询时，会进一步分为多个 Stage 阶段来执行</p>
<h4 id="Task"><a href="#Task" class="headerlink" title="Task"></a>Task</h4><p>　Stage 包含了一系列的 Task，而 Task 才是真正在 Worker 之上被执行的逻辑</p>
<h4 id="Split"><a href="#Split" class="headerlink" title="Split"></a>Split</h4><p>　Split 主要是为了拆分大规模数据集，以便 Task 在此之上执行</p>
<h4 id="Driver"><a href="#Driver" class="headerlink" title="Driver"></a>Driver</h4><p>　Driver 是一系列运算实例，可以理解为是内存中的一组物理运算符</p>
<div class="note info">Task 可以包含一个或者多个并行的 Driver</div>

<h4 id="Operator"><a href="#Operator" class="headerlink" title="Operator"></a>Operator</h4><p>　Operator 可以消费（Consume）、转换（Transform）和生产（Produce）数据。例如，一个 Table Scan 从一个 Connector 中 fetch 数据，并生产数据以供给 Operator 消费</p>
<h4 id="Exchange"><a href="#Exchange" class="headerlink" title="Exchange"></a>Exchange</h4><p>　Exchanage 负责在 Presto 的节点之间，传输一个 Query 的不同 Stage 的数据。Task 可以生产数据到一个 output 缓存区，也可以通过 Exchange 客户端消费其他 Task 生产的数据</p>
<h2 id="优缺点"><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h2><h3 id="优势"><a href="#优势" class="headerlink" title="优势"></a>优势</h3><ul>
<li><a href="https://zh.wikipedia.org/zh-hans/Ad_hoc">Ad Hoc</a>（即席查询，秒级或分钟级的查询响应）</li>
<li>比 Hive 快 10x 倍<ul>
<li>完全基于内存的并行计算</li>
<li>流水线</li>
<li>本地化计算</li>
<li>动态编译执行计划</li>
<li>内存规划</li>
<li>近似查询（类似于 <a href="https://github.com/sameeragarwal/blinkdb">BlinkDB</a>）</li>
<li><a href="https://yuzhouwan.com/posts/27328/">GC</a> 控制</li>
</ul>
</li>
<li>支持多种数据源（Hive、<a href="https://yuzhouwan.com/posts/5845/">Druid</a>、<a href="https://yuzhouwan.com/posts/26002/">Kafka</a>、<a href="https://yuzhouwan.com/posts/39683/#MySQL">MySQL</a>、MongoDB、<a href="https://yuzhouwan.com/posts/2129/">Redis</a>、<a href="https://yuzhouwan.com/posts/31915/#JMX">JMX</a>、<a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+ORC">ORC</a> 等）</li>
<li>Client 支持多种编程语言（<a href="https://yuzhouwan.com/posts/190413/">Java</a>、<a href="https://yuzhouwan.com/posts/43687/">Python</a>、Ruby、PHP、<a href="https://yuzhouwan.com/posts/23363/">Node.js</a> 等）</li>
<li>支持 JDBC / ODBC 连接</li>
<li>支持 Kerberos 认证</li>
<li>支持查询 LZO 压缩的数据</li>
<li>ANSI <a href="https://en.wikipedia.org/wiki/SQL">SQL</a>（窗口函数、Join、聚合、复杂查询等）</li>
</ul>
<div class="note info">Ad Hoc（拉丁短语，英语直译为 for this）即席查询，用户根据实际需求，灵活地选择查询条件，系统生成相应的统计报表。与普通应用查询不同的是，普通应用查询需要通过编程定制开发</div>
<div class="note info">即席（jí xí），表示入席、就位、当场等含义</div>
<div class="note info">ANSI（American National Standards Institute）美国国家标准学会</div>

<h3 id="劣势"><a href="#劣势" class="headerlink" title="劣势"></a>劣势</h3><ul>
<li>不支持 SQL 的隐式类型转换，而 <a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+Types">Hive 支持</a></li>
<li>不支持容错<br>查询请求会分发到多个 Worker 上，当任意一个 Worker 执行失败，Master 会感知到，并认为整个查询请求失败了。并且 Presto 并没有重试机制，所以需要业务端完成重试</li>
</ul>
<div class="note success">Presto 属于强数据类型，并不支持类型的隐式转换，所以无法进行不同数据类型之间的比较，例如 '2' &gt; 1 等。不过，在对应算子中增加新的语义行为即可支持。下文将介绍具体的编码过程</div>



<h2 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h2><h3 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a>架构图</h3><p><img data-src="/picture/presto/presto_architecture.png" alt="Presto Architecture"></p>
<center>（图片来源：<a href="https://medium.com/@adirmashiach/facebook-prestodb-full-review-4ba59720a92" target="_blank">medium.com</a>™）</center>

<p><img data-src="/picture/presto/presto_architecture_with_sql.png" alt="Presto Architecture with SQL"></p>
<center>（图片来源：<a href="https://www.slideshare.net/Hadoop_Summit/presto-facebook" target="_blank">slideshare.net</a>™）</center>

<div class="note info">从架构图可以看出，Presto 采用的是经典的 Master-Slave 模型</div>

<h3 id="SQL-执行流程图"><a href="#SQL-执行流程图" class="headerlink" title="SQL 执行流程图"></a>SQL 执行流程图</h3><p><img data-src="/picture/presto/presto_sql_execute.png" alt="Presto SQL Execute"></p>
<center>（图片来源：<a href="https://www.cnblogs.com/sorco/p/7060166.html" target="_blank">cnblogs.com</a>™）</center>

<h3 id="Connector-交互图"><a href="#Connector-交互图" class="headerlink" title="Connector 交互图"></a>Connector 交互图</h3><p><img data-src="/picture/presto/presto_connector.png" alt="Presto Connector"></p>
<center>（图片来源：<a href="https://www.slideshare.net/Hadoop_Summit/presto-facebook" target="_blank">slideshare.net</a>™）</center>

<h3 id="交互时序图"><a href="#交互时序图" class="headerlink" title="交互时序图"></a>交互时序图</h3><pre class="mermaid">sequenceDiagram

participant Client
participant Coordinator
participant Worker
participant Connector
participant Discovery Server

Client -&gt;&gt;+ Coordinator : query
Coordinator -&gt;&gt;+ Worker : choose workers
Worker -&gt;&gt;- Coordinator : return worker list
Coordinator -&gt;&gt;+ Worker : send task
Worker -&gt;&gt;+ Connector : load data
Connector -&gt;&gt;- Worker : return data
Worker -&gt;&gt; Worker : execute task
Worker -&gt;&gt;- Coordinator : return result
Coordinator -&gt;&gt;- Client : return result
loop regularly
  Coordinator --&gt;&gt; Discovery Server : heart beat
  Worker --&gt;&gt; Discovery Server : heart beat
end</pre>

<div class="note info">其中，与 Discovery Server 的心跳并不参与到查询过程中</div>
<div class="note info">集群状态感知的时间间隔为 5s，具体细节详见 io.prestosql.metadata.DiscoveryNodeManager#startPollingNodeStates</div>

<h3 id="Service-Discovery"><a href="#Service-Discovery" class="headerlink" title="Service Discovery"></a>Service Discovery</h3><p>　Presto 并不是由 Worker 主动发送心跳，而是 Discovery Server 定时探测节点是否存活。内部基于 <a href="https://github.com/airlift/discovery">Airlift</a> 框架来实现服务发现，通过 HTTP 协议进行通讯。在 <code>etc/config.properties</code> 文件中配置的 <code>discovery.uri</code> 参数，会透传给 Airlift 框架。如果，我们将 <code>discovery.uri</code> 参数，设置为 <code>http://127.0.0.1:9999</code>，则可以通过访问 <code>http://127.0.0.1:9999/v1/service</code> 地址，获取到所有注册的服务（包括服务类型、ID、通讯地址、服务所在的节点等信息），具体返回内容如下：</p>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"environment"</span>: <span class="string">"presto"</span>,</span><br><span class="line">  <span class="attr">"services"</span>: [</span><br><span class="line">    {</span><br><span class="line">      <span class="attr">"id"</span>: <span class="string">"1f538ad9-e4b0-40a2-88a7-8e901b6d8ce6"</span>,</span><br><span class="line">      <span class="attr">"nodeId"</span>: <span class="string">"presto_node_1"</span>,</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"presto-coordinator"</span>,</span><br><span class="line">      <span class="attr">"pool"</span>: <span class="string">"general"</span>,</span><br><span class="line">      <span class="attr">"location"</span>: <span class="string">"/presto_node_1"</span>,</span><br><span class="line">      <span class="attr">"properties"</span>: {</span><br><span class="line">        <span class="attr">"http"</span>: <span class="string">"http://127.0.0.1:9999"</span>,</span><br><span class="line">        <span class="attr">"http-external"</span>: <span class="string">"http://127.0.0.1:9999"</span></span><br><span class="line">      }</span><br><span class="line">    },</span><br><span class="line">    {</span><br><span class="line">      <span class="attr">"id"</span>: <span class="string">"89a0bf46-a949-4d62-8c65-c6fb9afe1bb2"</span>,</span><br><span class="line">      <span class="attr">"nodeId"</span>: <span class="string">"presto_node_1"</span>,</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"discovery"</span>,</span><br><span class="line">      <span class="attr">"pool"</span>: <span class="string">"general"</span>,</span><br><span class="line">      <span class="attr">"location"</span>: <span class="string">"/presto_node_1"</span>,</span><br><span class="line">      <span class="attr">"properties"</span>: {</span><br><span class="line">        <span class="attr">"http"</span>: <span class="string">"http://127.0.0.1:9999"</span>,</span><br><span class="line">        <span class="attr">"http-external"</span>: <span class="string">"http://127.0.0.1:9999"</span></span><br><span class="line">      }</span><br><span class="line">    },</span><br><span class="line">    {</span><br><span class="line">      <span class="attr">"id"</span>: <span class="string">"253a93c3-ebe9-46cf-a0ee-41e7de56c620"</span>,</span><br><span class="line">      <span class="attr">"nodeId"</span>: <span class="string">"presto_node_1"</span>,</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"presto"</span>,</span><br><span class="line">      <span class="attr">"pool"</span>: <span class="string">"general"</span>,</span><br><span class="line">      <span class="attr">"location"</span>: <span class="string">"/presto_node_1"</span>,</span><br><span class="line">      <span class="attr">"properties"</span>: {</span><br><span class="line">        <span class="attr">"node_version"</span>: <span class="string">"345"</span>,</span><br><span class="line">        <span class="attr">"coordinator"</span>: <span class="string">"true"</span>,</span><br><span class="line">        <span class="attr">"http"</span>: <span class="string">"http://127.0.0.1:9999"</span>,</span><br><span class="line">        <span class="attr">"http-external"</span>: <span class="string">"http://127.0.0.1:9999"</span>,</span><br><span class="line">        <span class="attr">"connectorIds"</span>: <span class="string">"system,druid"</span></span><br><span class="line">      }</span><br><span class="line">    },</span><br><span class="line">    {</span><br><span class="line">      <span class="attr">"id"</span>: <span class="string">"0a9970f3-6717-4979-8f28-7f12c7bd7c75"</span>,</span><br><span class="line">      <span class="attr">"nodeId"</span>: <span class="string">"presto_node_1"</span>,</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"jmx-http"</span>,</span><br><span class="line">      <span class="attr">"pool"</span>: <span class="string">"general"</span>,</span><br><span class="line">      <span class="attr">"location"</span>: <span class="string">"/presto_node_1"</span>,</span><br><span class="line">      <span class="attr">"properties"</span>: {</span><br><span class="line">        <span class="attr">"http"</span>: <span class="string">"http://127.0.0.1:9999"</span>,</span><br><span class="line">        <span class="attr">"http-external"</span>: <span class="string">"http://127.0.0.1:9999"</span></span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  ]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<div class="note info">上述 IP 地址相关信息已脱敏</div>

<p>　更加具体地来说，是在 <code>HeartbeatFailureDetector</code> 类中启动了一个执行周期为 5s 的定时任务，不断地调用 <code>updateMonitoredServices</code> 方法，来更新集群的服务状态。另外，<code>DiscoveryNodeManager</code> 类中也会启动一个执行周期为 5s 的定时任务，不断地调用 <code>pollWorkers</code> 方法，来检查各个节点的状态。Node 的状态主要分为 active、inactive、shuttingDown 三种，以集合的形式保存在了 AllNodes 类中。后续再选择 Worker 的时候会判断是否存活，并通过 AllNodes#getActiveNodes 方法获取到 active 状态的 Node 集合。另外，我们可以访问 <code>http://localhost:9999/v1/info/state</code> 地址，来检查节点是否处于 active 状态。如果节点存活，则会返回 <code>"ACTIVE"</code> 字符串</p>
<h3 id="MPP"><a href="#MPP" class="headerlink" title="MPP"></a>MPP</h3><p>　Presto 采用 MPP（<strong>M</strong>assively <strong>P</strong>arallel <strong>P</strong>rocessing）大规模并行处理架构，来解决大量数据分析的场景。该架构的主要特征，如下：</p>
<ul>
<li>任务并行执行</li>
<li>分布式计算</li>
<li>Shared Nothing</li>
<li>横向扩展</li>
<li>数据分布式存储（本地化）</li>
</ul>
<h3 id="SPI"><a href="#SPI" class="headerlink" title="SPI"></a>SPI</h3><p>　Presto 采用 <a href="https://yuzhouwan.com/posts/190413/#SPI-解耦">SPI</a>（<strong>S</strong>ervice <strong>P</strong>rovider <strong>I</strong>nterface）服务提供发现机制，来插件化地支持多种数据源，以实现联邦查询（<a href="https://en.wikipedia.org/wiki/Federated_search">Federation Query</a>，指能够通过一条 SQL 查询，对处于完全不同的系统中的不同的数据库和模式，进行引用和使用）</p>
<h2 id="比对"><a href="#比对" class="headerlink" title="比对"></a>比对</h2><h3 id="Presto-vs-Apache-Hive"><a href="#Presto-vs-Apache-Hive" class="headerlink" title="Presto vs Apache Hive"></a>Presto vs Apache Hive</h3><h4 id="优势比较"><a href="#优势比较" class="headerlink" title="优势比较"></a>优势比较</h4><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">Presto</th>
<th style="text-align:center">Apache Hive</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><strong>场景特征</strong></td>
<td style="text-align:center">交互式查询</td>
<td style="text-align:center">高吞吐</td>
</tr>
<tr>
<td style="text-align:center"><strong>Join</strong></td>
<td style="text-align:center">一个较大的事实表 + 多个较小的维度表</td>
<td style="text-align:center">事实表 + 事实表</td>
</tr>
<tr>
<td style="text-align:center"><strong>窗口函数</strong></td>
<td style="text-align:center">支持</td>
<td style="text-align:center">支持</td>
</tr>
<tr>
<td style="text-align:center"><strong>SQL 标准化</strong></td>
<td style="text-align:center">ANSI SQL</td>
<td style="text-align:center">HiveQL</td>
</tr>
</tbody>
</table>
</div>
<h4 id="架构比较"><a href="#架构比较" class="headerlink" title="架构比较"></a>架构比较</h4><p><img data-src="/picture/presto/presto_vs_hive.png" alt="Presto vs Hive on Architecture"></p>
<center>（图片来源：<a href="https://blog.treasuredata.com/blog/2015/03/20/presto-versus-hive/" target="_blank">treasuredata.com</a>™）</center>

<h3 id="Presto-vs-Amazon-Athena"><a href="#Presto-vs-Amazon-Athena" class="headerlink" title="Presto vs Amazon Athena"></a>Presto vs Amazon Athena</h3><p>　本质上，Amazon Athena（雅典娜）是一款完全支持标准 SQL 的 Presto</p>
<h3 id="PrestoDB-vs-PrestoSQL"><a href="#PrestoDB-vs-PrestoSQL" class="headerlink" title="PrestoDB vs PrestoSQL"></a>PrestoDB vs PrestoSQL</h3><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">PrestoDB</th>
<th style="text-align:center">PrestoSQL</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><strong>开源时间</strong></td>
<td style="text-align:center">2012</td>
<td style="text-align:center">2018</td>
</tr>
<tr>
<td style="text-align:center"><strong>研发主力</strong></td>
<td style="text-align:center">Facebook</td>
<td style="text-align:center">Martin、Dain 和 David</td>
</tr>
<tr>
<td style="text-align:center"><strong>通讯模式</strong></td>
<td style="text-align:center">支持 RESTful 和二进制</td>
<td style="text-align:center">仅支持 RESTful</td>
</tr>
<tr>
<td style="text-align:center"><strong>查询下推</strong></td>
<td style="text-align:center">支持</td>
<td style="text-align:center">支持</td>
</tr>
<tr>
<td style="text-align:center"><strong>技术输出</strong></td>
<td style="text-align:center">博客</td>
<td style="text-align:center">博客 + 视频 + 书籍</td>
</tr>
<tr>
<td style="text-align:center"><strong>Connector 数量</strong></td>
<td style="text-align:center">24</td>
<td style="text-align:center">30</td>
</tr>
<tr>
<td style="text-align:center"><strong>社区活跃度</strong></td>
<td style="text-align:center">相对不活跃</td>
<td style="text-align:center">相对活跃</td>
</tr>
<tr>
<td style="text-align:center"><strong>Contributor 数量</strong></td>
<td style="text-align:center">406</td>
<td style="text-align:center">434</td>
</tr>
<tr>
<td style="text-align:center"><strong>合并 PR 数量</strong></td>
<td style="text-align:center"><a href="https://github.com/prestodb/presto/pulse/monthly">90</a></td>
<td style="text-align:center"><a href="https://github.com/prestosql/presto/pulse/monthly">205</a></td>
</tr>
<tr>
<td style="text-align:center"><strong>解决 Issues 数量</strong></td>
<td style="text-align:center">52</td>
<td style="text-align:center">81</td>
</tr>
<tr>
<td style="text-align:center"><strong>改动的代码行数</strong></td>
<td style="text-align:center">20088</td>
<td style="text-align:center">63297</td>
</tr>
</tbody>
</table>
</div>
<div class="note info">上表中 PR、Issues 和代码行数的统计时间范围是最近一个月的</div>





<h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><div class="note info">这里我们以 PrestoSQL 为例，整体部署步骤与 PrestoDB 相似。不同的是，PrestoSQL 需要较新的 Java11，而 PrestoDB 仍然停留在 Java8</div>

<h3 id="单机版"><a href="#单机版" class="headerlink" title="单机版"></a>单机版</h3><h4 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ wget https://repo1.maven.org/maven2/io/prestosql/presto-server/345/presto-server-345.tar.gz</span><br><span class="line">$ tar zxvf presto-server-345.tar.gz</span><br><span class="line">$ ln -s presto-server-345 presto</span><br></pre></td></tr></tbody></table></figure>
<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> presto</span><br><span class="line">$ mkdir etc</span><br><span class="line">$ <span class="built_in">cd</span> etc</span><br><span class="line">$ touch node.properties jvm.config config.properties log.properties</span><br><span class="line">$ mkdir catalog</span><br><span class="line">$ touch catalog/jmx.properties</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim catalog/jmx.properties</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">connector.name</span>=<span class="string">jmx</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim config.properties</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">coordinator</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">node-scheduler.include-coordinator</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">query.max-memory</span>=<span class="string">8GB</span></span><br><span class="line"><span class="meta">query.max-memory-per-node</span>=<span class="string">1GB</span></span><br><span class="line"><span class="meta">http-server.http.port</span>=<span class="string">9999</span></span><br><span class="line"><span class="meta">discovery-server.enabled</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">discovery.uri</span>=<span class="string">http://127.0.0.1:9999</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim jvm.config</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">-server</span></span><br><span class="line"><span class="attr">-Xmx8G</span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">+UseG1GC</span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">G1HeapRegionSize=32M</span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">+UseGCOverheadLimit</span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">+ExplicitGCInvokesConcurrent</span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">+HeapDumpOnOutOfMemoryError</span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">+ExitOnOutOfMemoryError</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim node.properties</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">node.environment</span>=<span class="string">presto</span></span><br><span class="line"><span class="meta">node.id</span>=<span class="string">presto_node_1</span></span><br><span class="line"><span class="meta">node.data-dir</span>=<span class="string">/Users/benedictjin/apps/prestoData</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim launcher</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">export</span> <span class="string">JAVA_HOME=/Library/Java/JavaVirtualMachines/jdk-11.0.5.jdk/Contents/Home</span></span><br><span class="line"><span class="attr">export</span> <span class="string">PATH=$JAVA_HOME:$PATH</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ..</span><br><span class="line">$ bin/launcher start</span><br></pre></td></tr></tbody></table></figure>
<h4 id="查看运行状态"><a href="#查看运行状态" class="headerlink" title="查看运行状态"></a>查看运行状态</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ bin/launcher status</span><br></pre></td></tr></tbody></table></figure>
<h4 id="查看日志"><a href="#查看日志" class="headerlink" title="查看日志"></a>查看日志</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 启动日志</span></span><br><span class="line">$ tail -f ~/apps/prestoData/var/<span class="built_in">log</span>/launcher.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行日志</span></span><br><span class="line">$ tail -f ~/apps/prestoData/var/<span class="built_in">log</span>/server.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 请求日志</span></span><br><span class="line">$ tail -f ~/apps/prestoData/var/<span class="built_in">log</span>/http-request.log</span><br></pre></td></tr></tbody></table></figure>
<h4 id="可视化"><a href="#可视化" class="headerlink" title="可视化"></a>可视化</h4><p><img data-src="/picture/presto/prestosql_standalone_ui.jpg" alt="PrestoSQL Standalone UI"></p>
<p><img data-src="/picture/presto/prestosql_query_details.jpg" alt="PrestoSQL Query Details"></p>
<center>（对 <a href="https://prestosql.io/" target="_blank">PrestoSQL</a>™ 的截图）</center>

<h4 id="开启-Debug-模式"><a href="#开启-Debug-模式" class="headerlink" title="开启 Debug 模式"></a>开启 Debug 模式</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim etc/jvm.config</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">-agentlib:jdwp=transport=dt_socket,server=y,<span class="built_in">suspend</span>=n,address=5005</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ bin/launcher restart</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">Stopped 19181</span><br><span class="line">Started as 21861</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Docker-容器版"><a href="#Docker-容器版" class="headerlink" title="Docker 容器版"></a><a href="https://hub.docker.com/r/prestosql/presto">Docker 容器版</a></h3><h4 id="下载-1"><a href="#下载-1" class="headerlink" title="下载"></a>下载</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ docker pull prestosql/presto</span><br></pre></td></tr></tbody></table></figure>
<h4 id="启动-1"><a href="#启动-1" class="headerlink" title="启动"></a>启动</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ docker run -p 8080:8080 --name presto prestosql/presto</span><br></pre></td></tr></tbody></table></figure>
<h4 id="客户端连接"><a href="#客户端连接" class="headerlink" title="客户端连接"></a>客户端连接</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ docker <span class="built_in">exec</span> -it presto presto --catalog tpch --schema sf1</span><br></pre></td></tr></tbody></table></figure>
<h4 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">presto:sf1&gt; show tables;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">  Table</span><br><span class="line">----------</span><br><span class="line"> customer</span><br><span class="line"> lineitem</span><br><span class="line"> nation</span><br><span class="line"> orders</span><br><span class="line"> part</span><br><span class="line"> partsupp</span><br><span class="line"> region</span><br><span class="line"> supplier</span><br><span class="line">(8 rows)</span><br><span class="line"></span><br><span class="line">Query 20200906_033706_00013_ne522, FINISHED, 1 node</span><br><span class="line">Splits: 19 total, 19 <span class="keyword">done</span> (100.00%)</span><br><span class="line">0.28 [8 rows, 158B] [28 rows/s, 558B/s]</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">presto:sf1&gt; select * from customer <span class="built_in">limit</span> 3;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"> custkey |        name        |              address               | nationkey |      phone      | acctbal | mktsegment |</span><br><span class="line">---------+--------------------+------------------------------------+-----------+-----------------+---------+------------+------------------------------------------------</span><br><span class="line">   75001 | Customer<span class="comment">#000075001 | iQyegZCktrxX8jMFs9ip               |         3 | 13-826-812-1458 | 6154.12 | FURNITURE  | quickly ironic pinto beans up the blithely fluf</span></span><br><span class="line">   75002 | Customer<span class="comment">#000075002 | TRzWtXys54mXmbNLlZQ4UR,5VkzA4Ycjsx |        24 | 34-175-692-7923 | 8258.87 | FURNITURE  | tes. carefully even requests about the express,</span></span><br><span class="line">   75003 | Customer<span class="comment">#000075003 | OVaJQHekQKFzsjqYpkLD               |        24 | 34-440-315-8937 | 6870.87 | MACHINERY  |  even patterns. deposits unwind furiously. furi</span></span><br><span class="line">(3 rows)</span><br><span class="line"></span><br><span class="line">Query 20200906_033714_00014_ne522, FINISHED, 1 node</span><br><span class="line">Splits: 21 total, 19 <span class="keyword">done</span> (90.48%)</span><br><span class="line">0.25 [11K rows, 0B] [43.6K rows/s, 0B/s]</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Kubernetes-集群版"><a href="#Kubernetes-集群版" class="headerlink" title="Kubernetes 集群版"></a>Kubernetes 集群版</h3><p>　详见，我的另一篇博客：<a href="https://yuzhouwan.com/posts/200926/#%E6%90%AD%E5%BB%BA-PrestoDB-%E9%9B%86%E7%BE%A4">Helm 实战</a></p>
<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><h3 id="Apache-Druid-Connector"><a href="#Apache-Druid-Connector" class="headerlink" title="Apache Druid Connector"></a><a href="https://prestosql.io/docs/current/connector/druid.html">Apache Druid Connector</a></h3><h4 id="配置-Catalog"><a href="#配置-Catalog" class="headerlink" title="配置 Catalog"></a>配置 Catalog</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim etc/catalog/druid.properties</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">connector.name</span>=<span class="string">druid</span></span><br><span class="line"><span class="meta">connection-url</span>=<span class="string">jdbc:avatica:remote:url=http://remote_druid_cluster:8082/druid/v2/sql/avatica/</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="开放-Broker-端口"><a href="#开放-Broker-端口" class="headerlink" title="开放 Broker 端口"></a>开放 Broker 端口</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">kill</span> `ps -ef | grep 8082 | grep -v grep | awk <span class="string">'{print $2}'</span>`; <span class="built_in">export</span> POD_NAME=$(kubectl get pods --namespace default -l <span class="string">"app=druid,release=`helm list | grep druid- | awk '{print <span class="variable">$1</span>}'`"</span> | grep broker | awk <span class="string">'{print $1}'</span>) ; nohup kubectl port-forward <span class="variable">$POD_NAME</span> 8082:8082 --address 0.0.0.0 2&gt;&amp;1 &amp;</span><br></pre></td></tr></tbody></table></figure>
<h4 id="重启-Presto"><a href="#重启-Presto" class="headerlink" title="重启 Presto"></a>重启 Presto</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ bin/launcher restart</span><br></pre></td></tr></tbody></table></figure>
<h4 id="下载客户端"><a href="#下载客户端" class="headerlink" title="下载客户端"></a>下载客户端</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ wget -c https://repo1.maven.org/maven2/io/prestosql/presto-cli/345/presto-cli-345-executable.jar -O bin/presto</span><br><span class="line">$ chmod +x bin/presto</span><br></pre></td></tr></tbody></table></figure>
<h4 id="启动客户端"><a href="#启动客户端" class="headerlink" title="启动客户端"></a>启动客户端</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ bin/presto --catalog druid --server localhost:9999 --schema default</span><br></pre></td></tr></tbody></table></figure>
<h4 id="显示-Catalog"><a href="#显示-Catalog" class="headerlink" title="显示 Catalog"></a>显示 Catalog</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ presto:druid&gt; show catalogs;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"> Catalog</span><br><span class="line">---------</span><br><span class="line"> druid</span><br><span class="line"> system</span><br><span class="line">(2 rows)</span><br><span class="line"></span><br><span class="line">Query 20200906_125808_00062_pg9xm, FINISHED, 1 node</span><br><span class="line">Splits: 19 total, 19 <span class="keyword">done</span> (100.00%)</span><br><span class="line">0.30 [0 rows, 0B] [0 rows/s, 0B/s]</span><br></pre></td></tr></tbody></table></figure>
<h4 id="显示-Schema"><a href="#显示-Schema" class="headerlink" title="显示 Schema"></a>显示 Schema</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ presto:druid&gt; show schemas from druid;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">       Schema</span><br><span class="line">--------------------</span><br><span class="line"> druid</span><br><span class="line"> information_schema</span><br><span class="line">(2 rows)</span><br><span class="line"></span><br><span class="line">Query 20200906_125828_00063_pg9xm, FINISHED, 1 node</span><br><span class="line">Splits: 19 total, 19 <span class="keyword">done</span> (100.00%)</span><br><span class="line">5.14 [2 rows, 33B] [0 rows/s, 6B/s]</span><br></pre></td></tr></tbody></table></figure>
<h4 id="切换数据库"><a href="#切换数据库" class="headerlink" title="切换数据库"></a>切换数据库</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ presto:default&gt; use druid.druid;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">USE</span><br></pre></td></tr></tbody></table></figure>
<h4 id="显示所有表"><a href="#显示所有表" class="headerlink" title="显示所有表"></a>显示所有表</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">presto:druid&gt; show tables;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">   Table</span><br><span class="line">-----------</span><br><span class="line"> wikipedia</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">Query 20200906_083924_00017_pg9xm, FINISHED, 1 node</span><br><span class="line">Splits: 19 total, 19 <span class="keyword">done</span> (100.00%)</span><br><span class="line">0.29 [1 rows, 24B] [3 rows/s, 82B/s]</span><br></pre></td></tr></tbody></table></figure>
<h4 id="查询-1"><a href="#查询-1" class="headerlink" title="查询"></a>查询</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">presto:druid&gt; select * from wikipedia <span class="built_in">where</span> <span class="string">"cityName"</span> != <span class="string">''</span> order by <span class="string">"__time"</span> desc <span class="built_in">limit</span> 3;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">         __time          |    channel    | cityname |                                                            comment</span><br><span class="line">-------------------------+---------------+----------+--------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> 2016-06-27 21:00:00.000 | <span class="comment">#en.wikipedia | Glasgow  | /* Presenters */Dan Neal Is Guest Presenting But Is Not A Main Stand In.</span></span><br><span class="line"> 2016-06-27 21:00:00.000 | <span class="comment">#en.wikipedia | Bothell  | /* BAMN */</span></span><br><span class="line"> 2016-06-27 21:00:00.000 | <span class="comment">#de.wikipedia | Pamplona | /* Fahrzeuge mit Wankelmotor */  new entries, actual vehicles, easy to check on the web, no reason to delete or blo</span></span><br><span class="line">(3 rows)</span><br><span class="line"></span><br><span class="line">Query 20200906_084953_00028_pg9xm, FINISHED, 1 node</span><br><span class="line">Splits: 18 total, 18 <span class="keyword">done</span> (100.00%)</span><br><span class="line">0.69 [1.53K rows, 0B] [2.22K rows/s, 0B/s]</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Explain"><a href="#Explain" class="headerlink" title="Explain"></a><a href="https://prestosql.io/docs/current/sql/explain.html">Explain</a></h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">presto:druid&gt; explain select * from wikipedia <span class="built_in">where</span> <span class="string">"cityName"</span> != <span class="string">''</span> order by <span class="string">"__time"</span> desc <span class="built_in">limit</span> 3;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">-------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> Fragment <span class="number">0</span> [SINGLE]</span><br><span class="line">     Output layout: [__time, channel, cityname, comment, count, countryisocode, countryname, diffurl, flags, isanonymous, isminor, isnew, isrobot, isunpatrolled, metroco</span><br><span class="line">     Output partitioning: SINGLE []</span><br><span class="line">     Stage Execution Strategy: UNGROUPED_EXECUTION</span><br><span class="line">     Output[__time, channel, cityname, comment, count, countryisocode, countryname, diffurl, flags, isanonymous, isminor, isnew, isrobot, isunpatrolled, metrocode, names</span><br><span class="line">     │   Layout: [__time:timestamp(<span class="number">3</span>), channel:varchar, cityname:varchar, comment:varchar, count:bigint, countryisocode:varchar, countryname:varchar, diffurl:varchar, fl</span><br><span class="line">     │   Estimates: {rows: ? (?), cpu: ?, memory: ?, network: ?}</span><br><span class="line">     └─ TopN[<span class="number">3</span> by (__time DESC_NULLS_LAST)]</span><br><span class="line">        │   Layout: [__time:timestamp(<span class="number">3</span>), channel:varchar, cityname:varchar, comment:varchar, count:bigint, countryisocode:varchar, countryname:varchar, diffurl:varchar,</span><br><span class="line">        └─ LocalExchange[SINGLE] ()</span><br><span class="line">           │   Layout: [__time:timestamp(<span class="number">3</span>), channel:varchar, cityname:varchar, comment:varchar, count:bigint, countryisocode:varchar, countryname:varchar, diffurl:varch</span><br><span class="line">           │   Estimates: {rows: ? (?), cpu: ?, memory: ?, network: ?}</span><br><span class="line">           └─ RemoteSource[<span class="number">1</span>]</span><br><span class="line">                  Layout: [__time:timestamp(<span class="number">3</span>), channel:varchar, cityname:varchar, comment:varchar, count:bigint, countryisocode:varchar, countryname:varchar, diffurl:va</span><br><span class="line"></span><br><span class="line"> Fragment <span class="number">1</span> [SOURCE]</span><br><span class="line">     Output layout: [__time, channel, cityname, comment, count, countryisocode, countryname, diffurl, flags, isanonymous, isminor, isnew, isrobot, isunpatrolled, metroco</span><br><span class="line">     Output partitioning: SINGLE []</span><br><span class="line">     Stage Execution Strategy: UNGROUPED_EXECUTION</span><br><span class="line">     TopNPartial[<span class="number">3</span> by (__time DESC_NULLS_LAST)]</span><br><span class="line">     │   Layout: [__time:timestamp(<span class="number">3</span>), channel:varchar, cityname:varchar, comment:varchar, count:bigint, countryisocode:varchar, countryname:varchar, diffurl:varchar, fl</span><br><span class="line">     └─ TableScan[druid:druid.wikipedia druid.druid.wikipedia, grouped = <span class="keyword">false</span>]</span><br><span class="line">            Layout: [__time:timestamp(<span class="number">3</span>), channel:varchar, cityname:varchar, comment:varchar, count:bigint, countryisocode:varchar, countryname:varchar, diffurl:varchar,</span><br><span class="line">            Estimates: {rows: ? (?), cpu: ?, memory: <span class="number">0</span>B, network: <span class="number">0</span>B}</span><br><span class="line">            channel := channel:varchar:VARCHAR</span><br><span class="line">            flags := flags:varchar:VARCHAR</span><br><span class="line">            regionisocode := regionIsoCode:varchar:VARCHAR</span><br><span class="line">            isnew := isNew:varchar:VARCHAR</span><br><span class="line">            sum_deleted := sum_deleted:bigint:BIGINT</span><br><span class="line">            isunpatrolled := isUnpatrolled:varchar:VARCHAR</span><br><span class="line">            isminor := isMinor:varchar:VARCHAR</span><br><span class="line">            regionname := regionName:varchar:VARCHAR</span><br><span class="line">            isanonymous := isAnonymous:varchar:VARCHAR</span><br><span class="line">            sum_added := sum_added:bigint:BIGINT</span><br><span class="line">            sum_deltabucket := sum_deltaBucket:bigint:BIGINT</span><br><span class="line">            __time := __time:timestamp(<span class="number">3</span>):TIMESTAMP</span><br><span class="line">            diffurl := diffUrl:varchar:VARCHAR</span><br><span class="line">            isrobot := isRobot:varchar:VARCHAR</span><br><span class="line">            metrocode := metroCode:varchar:VARCHAR</span><br><span class="line">            cityname := cityName:varchar:VARCHAR</span><br><span class="line">            count := count:bigint:BIGINT</span><br><span class="line">            countryname := countryName:varchar:VARCHAR</span><br><span class="line">            countryisocode := countryIsoCode:varchar:VARCHAR</span><br><span class="line">            namespace := namespace:varchar:VARCHAR</span><br><span class="line">            comment := comment:varchar:VARCHAR</span><br><span class="line">            page := page:varchar:VARCHAR</span><br><span class="line">            sum_commentlength := sum_commentLength:bigint:BIGINT</span><br><span class="line">            user := user:varchar:VARCHAR</span><br><span class="line">            sum_delta := sum_delta:bigint:BIGINT</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(<span class="number">1</span> row)</span><br><span class="line"></span><br><span class="line">Query <span class="number">20200906_113246_00048</span>_pg9xm, FINISHED, <span class="number">1</span> node</span><br><span class="line">Splits: <span class="number">1</span> total, <span class="number">1</span> done (<span class="number">100.00</span>%)</span><br><span class="line"><span class="number">0.34</span> [<span class="number">0</span> rows, <span class="number">0</span>B] [<span class="number">0</span> rows/s, <span class="number">0</span>B/s]</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Explain-Anaylze"><a href="#Explain-Anaylze" class="headerlink" title="Explain Anaylze"></a><a href="https://prestosql.io/docs/current/sql/explain-analyze.html">Explain Anaylze</a></h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">presto:druid&gt; explain analyze select * from wikipedia <span class="built_in">where</span> <span class="string">"cityName"</span> != <span class="string">''</span> order by <span class="string">"__time"</span> desc <span class="built_in">limit</span> 3;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">-------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> Fragment <span class="number">1</span> [SINGLE]</span><br><span class="line">     CPU: <span class="number">3.74</span>ms, Scheduled: <span class="number">25.39</span>ms, Input: <span class="number">3</span> rows (<span class="number">1.18</span>kB); per task: avg.: <span class="number">3.00</span> std.dev.: <span class="number">0.00</span>, Output: <span class="number">3</span> rows (<span class="number">1.18</span>kB)</span><br><span class="line">     Output layout: [__time, channel, cityname, comment, count, countryisocode, countryname, diffurl, flags, isanonymous, isminor, isnew, isrobot, isunpatrolled, metroco</span><br><span class="line">     Output partitioning: SINGLE []</span><br><span class="line">     Stage Execution Strategy: UNGROUPED_EXECUTION</span><br><span class="line">     TopN[<span class="number">3</span> by (__time DESC_NULLS_LAST)]</span><br><span class="line">     │   Layout: [__time:timestamp(<span class="number">3</span>), channel:varchar, cityname:varchar, comment:varchar, count:bigint, countryisocode:varchar, countryname:varchar, diffurl:varchar, fl</span><br><span class="line">     │   CPU: <span class="number">0.00</span>ns (<span class="number">0.00</span>%), Scheduled: <span class="number">7.00</span>ms (<span class="number">1.65</span>%), Output: <span class="number">3</span> rows (<span class="number">1.18</span>kB)</span><br><span class="line">     │   Input avg.: <span class="number">3.00</span> rows, Input std.dev.: <span class="number">0.00</span>%</span><br><span class="line">     └─ LocalExchange[SINGLE] ()</span><br><span class="line">        │   Layout: [__time:timestamp(<span class="number">3</span>), channel:varchar, cityname:varchar, comment:varchar, count:bigint, countryisocode:varchar, countryname:varchar, diffurl:varchar,</span><br><span class="line">        │   Estimates: {rows: ? (?), cpu: ?, memory: ?, network: ?}</span><br><span class="line">        │   CPU: <span class="number">1.00</span>ms (<span class="number">2.78</span>%), Scheduled: <span class="number">2.00</span>ms (<span class="number">0.47</span>%), Output: <span class="number">3</span> rows (<span class="number">1.18</span>kB)</span><br><span class="line">        │   Input avg.: <span class="number">0.19</span> rows, Input std.dev.: <span class="number">387.30</span>%</span><br><span class="line">        └─ RemoteSource[<span class="number">2</span>]</span><br><span class="line">               Layout: [__time:timestamp(<span class="number">3</span>), channel:varchar, cityname:varchar, comment:varchar, count:bigint, countryisocode:varchar, countryname:varchar, diffurl:varch</span><br><span class="line">               CPU: <span class="number">0.00</span>ns (<span class="number">0.00</span>%), Scheduled: <span class="number">0.00</span>ns (<span class="number">0.00</span>%), Output: <span class="number">3</span> rows (<span class="number">1.18</span>kB)</span><br><span class="line">               Input avg.: <span class="number">0.19</span> rows, Input std.dev.: <span class="number">387.30</span>%</span><br><span class="line"></span><br><span class="line"> Fragment <span class="number">2</span> [SOURCE]</span><br><span class="line">     CPU: <span class="number">35.54</span>ms, Scheduled: <span class="number">413.99</span>ms, Input: <span class="number">1533</span> rows (<span class="number">547.77</span>kB); per task: avg.: <span class="number">1533.00</span> std.dev.: <span class="number">0.00</span>, Output: <span class="number">3</span> rows (<span class="number">1.18</span>kB)</span><br><span class="line">     Output layout: [__time, channel, cityname, comment, count, countryisocode, countryname, diffurl, flags, isanonymous, isminor, isnew, isrobot, isunpatrolled, metroco</span><br><span class="line">     Output partitioning: SINGLE []</span><br><span class="line">     Stage Execution Strategy: UNGROUPED_EXECUTION</span><br><span class="line">     TopNPartial[<span class="number">3</span> by (__time DESC_NULLS_LAST)]</span><br><span class="line">     │   Layout: [__time:timestamp(<span class="number">3</span>), channel:varchar, cityname:varchar, comment:varchar, count:bigint, countryisocode:varchar, countryname:varchar, diffurl:varchar, fl</span><br><span class="line">     │   CPU: <span class="number">2.00</span>ms (<span class="number">5.56</span>%), Scheduled: <span class="number">18.00</span>ms (<span class="number">4.26</span>%), Output: <span class="number">3</span> rows (<span class="number">1.18</span>kB)</span><br><span class="line">     │   Input avg.: <span class="number">1533.00</span> rows, Input std.dev.: <span class="number">0.00</span>%</span><br><span class="line">     └─ TableScan[druid:druid.wikipedia druid.druid.wikipedia, grouped = <span class="keyword">false</span>]</span><br><span class="line">            Layout: [__time:timestamp(<span class="number">3</span>), channel:varchar, cityname:varchar, comment:varchar, count:bigint, countryisocode:varchar, countryname:varchar, diffurl:varchar,</span><br><span class="line">            Estimates: {rows: ? (?), cpu: ?, memory: <span class="number">0</span>B, network: <span class="number">0</span>B}</span><br><span class="line">            CPU: <span class="number">33.00</span>ms (<span class="number">91.67</span>%), Scheduled: <span class="number">396.00</span>ms (<span class="number">93.62</span>%), Output: <span class="number">1533</span> rows (<span class="number">547.77</span>kB)</span><br><span class="line">            Input avg.: <span class="number">1533.00</span> rows, Input std.dev.: <span class="number">0.00</span>%</span><br><span class="line">            channel := channel:varchar:VARCHAR</span><br><span class="line">            flags := flags:varchar:VARCHAR</span><br><span class="line">            regionisocode := regionIsoCode:varchar:VARCHAR</span><br><span class="line">            isnew := isNew:varchar:VARCHAR</span><br><span class="line">            sum_deleted := sum_deleted:bigint:BIGINT</span><br><span class="line">            isunpatrolled := isUnpatrolled:varchar:VARCHAR</span><br><span class="line">            isminor := isMinor:varchar:VARCHAR</span><br><span class="line">            regionname := regionName:varchar:VARCHAR</span><br><span class="line">            isanonymous := isAnonymous:varchar:VARCHAR</span><br><span class="line">            sum_added := sum_added:bigint:BIGINT</span><br><span class="line">            sum_deltabucket := sum_deltaBucket:bigint:BIGINT</span><br><span class="line">            __time := __time:timestamp(<span class="number">3</span>):TIMESTAMP</span><br><span class="line">            diffurl := diffUrl:varchar:VARCHAR</span><br><span class="line">            isrobot := isRobot:varchar:VARCHAR</span><br><span class="line">            metrocode := metroCode:varchar:VARCHAR</span><br><span class="line">            cityname := cityName:varchar:VARCHAR</span><br><span class="line">            count := count:bigint:BIGINT</span><br><span class="line">            countryname := countryName:varchar:VARCHAR</span><br><span class="line">            countryisocode := countryIsoCode:varchar:VARCHAR</span><br><span class="line">            namespace := namespace:varchar:VARCHAR</span><br><span class="line">            comment := comment:varchar:VARCHAR</span><br><span class="line">            page := page:varchar:VARCHAR</span><br><span class="line">            sum_commentlength := sum_commentLength:bigint:BIGINT</span><br><span class="line">            user := user:varchar:VARCHAR</span><br><span class="line">            sum_delta := sum_delta:bigint:BIGINT</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(<span class="number">1</span> row)</span><br><span class="line"></span><br><span class="line">Query <span class="number">20200906_113431_00049</span>_pg9xm, FINISHED, <span class="number">1</span> node</span><br><span class="line">Splits: <span class="number">35</span> total, <span class="number">35</span> done (<span class="number">100.00</span>%)</span><br><span class="line"><span class="number">5.76</span> [<span class="number">1.53</span>K rows, <span class="number">0</span>B] [<span class="number">266</span> rows/s, <span class="number">0</span>B/s]</span><br></pre></td></tr></tbody></table></figure>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><div class="note info">鉴于诸多缘由，这里我们基于 PrestoSQL 进行分析</div>

<h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ java -version</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">java version <span class="string">"11.0.9"</span> 2020-10-20 LTS</span><br><span class="line">Java(TM) SE Runtime Environment 18.9 (build 11.0.9+7-LTS)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM 18.9 (build 11.0.9+7-LTS, mixed mode)</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> --depth 1 --single-branch --branch master https://github.com/prestosql/presto/</span><br><span class="line">$ <span class="built_in">cd</span> presto</span><br><span class="line">$ mvn clean install -T 1C -DskipTests -pl <span class="string">'!presto-docs'</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="启动流程"><a href="#启动流程" class="headerlink" title="启动流程"></a>启动流程</h3><pre class="mermaid">sequenceDiagram

participant PrestoServer
participant Platform
participant Server
participant Logger
participant ImmutableList
participant ImmutableList.Builder
participant Bootstrap
participant ConfigurationLoader

participant Injector
participant LifeCycleManager
participant StaticCatalogStore
participant PluginManager

participant ConfigurationFactory
participant Elements
participant RecordingBinder
participant Module

participant System

participant AbstractConfigurationAwareModule
participant ServerConfig

participant ServerMainModule
participant CoordinatorModule
participant WorkerModule

participant LifeCycleModule
participant ConfigurationModule

participant Guice


PrestoServer -&gt;&gt; PrestoServer : main


opt check the version of java
PrestoServer -&gt;&gt;+ Platform : nullToEmpty
Platform -&gt;&gt;- PrestoServer : java.version
alt java.version &lt; 11
PrestoServer -&gt;&gt; System : exit(100)
end
end


PrestoServer -&gt;&gt;+ Server : new
Server -&gt;&gt;- PrestoServer : Server
PrestoServer -&gt;&gt; Server : start
Server -&gt;&gt; Server : doStart

Server -&gt;&gt;+ ImmutableList : builder
ImmutableList -&gt;&gt;- Server : ImmutableList.Builder


opt init modules
Server -&gt;&gt;+ ServerMainModule : new
ServerMainModule -&gt;&gt;- Server : ServerMainModule
end


Server -&gt;&gt; ImmutableList.Builder : add
Server -&gt;&gt; ImmutableList.Builder : build
ImmutableList.Builder -&gt;&gt; Server : ImmutableList
Server -&gt;&gt; Bootstrap : new
Bootstrap -&gt;&gt; Server : Bootstrap
Bootstrap -&gt;&gt;+ Bootstrap : initialize


opt config
Bootstrap -&gt;&gt;+ ConfigurationLoader : loadPropertiesFrom(configFile)
ConfigurationLoader -&gt;&gt;- Bootstrap : Map<string, string=""> requiredProperties
Bootstrap -&gt;&gt;+ ConfigurationLoader : getSystemProperties
ConfigurationLoader -&gt;&gt;+ System : getProperties
System -&gt;&gt;- ConfigurationLoader : Properties
ConfigurationLoader -&gt;&gt;- Bootstrap : Map<string, string=""> systemProperties

Bootstrap -&gt;&gt;+ ConfigurationFactory : new
ConfigurationFactory -&gt;&gt;- Bootstrap : ConfigurationFactory
end



opt install module by airlift
ConfigurationFactory -&gt;&gt; ConfigurationFactory : registerConfigurationClasses

ConfigurationFactory -&gt;&gt;+ Elements : getElements(modules)
Elements -&gt;&gt;+ RecordingBinder : new
RecordingBinder -&gt;&gt;- Elements : RecordingBinder
Elements -&gt;&gt; RecordingBinder : install(module)

opt setup modules, for example, ServerMainModule
Elements -&gt;&gt; Module : configure(binder)
Module -&gt;&gt; AbstractConfigurationAwareModule : setup
AbstractConfigurationAwareModule -&gt;&gt; ServerMainModule : setup
ServerMainModule -&gt;&gt;+ AbstractConfigurationAwareModule : buildConfigObject
AbstractConfigurationAwareModule -&gt;&gt;- ServerMainModule : ServerConfig
ServerMainModule -&gt;&gt;+ ServerConfig : isCoordinator
ServerConfig -&gt;&gt;- ServerMainModule : boolean

alt true
ServerMainModule -&gt;&gt;+ CoordinatorModule : new
CoordinatorModule -&gt;&gt;+ ServerMainModule : CoordinatorModule
else false
ServerMainModule -&gt;&gt;+ WorkerModule : new
WorkerModule -&gt;&gt;+ ServerMainModule : WorkerModule
end

ServerMainModule -&gt;&gt; AbstractConfigurationAwareModule : install
end

Elements -&gt;&gt;+ RecordingBinder : binder.elements
RecordingBinder -&gt;&gt;- Elements : List<element>
Elements -&gt;&gt;- ConfigurationFactory : List<element>


ConfigurationFactory -&gt;&gt; ConfigurationFactory : validateRegisteredConfigurationProvider
end




opt system modules
Bootstrap -&gt;&gt;+ LifeCycleModule : new
LifeCycleModule -&gt;&gt;- Bootstrap : LifeCycleModule
Bootstrap -&gt;&gt;+ ConfigurationModule : new
ConfigurationModule -&gt;&gt;- Bootstrap : ConfigurationModule
end

opt create the injector
Bootstrap -&gt;&gt;+ Guice : createInjector
Guice -&gt;&gt;- Bootstrap : Injector
end

opt create the life-cycle manager and start it
Bootstrap -&gt;&gt;+ Injector : getInstance
Injector -&gt;&gt;- Bootstrap : LifeCycleManager
Bootstrap -&gt;&gt; LifeCycleManager : start
end


Bootstrap -&gt;&gt;- Bootstrap : Injector


opt load resources
Server -&gt;&gt;+ Injector : getInstance(PluginManager.class)
Injector -&gt;&gt;- Server : PluginManager
Server -&gt;&gt; PluginManager : loadPlugins

Server -&gt;&gt;+ Injector : getInstance(StaticCatalogStore.class)
Injector -&gt;&gt;- Server : StaticCatalogStore
Server -&gt;&gt; StaticCatalogStore : loadCatalogs
end

Server -&gt;&gt; Logger : "======== SERVER STARTED ========"</element></element></string,></string,></pre>

<div class="note success">点击<a href="/picture/presto/prestosql_init.svg" target="_blank">这里</a>查看完整大图</div>
<div class="note info">出于渲染复杂度的考虑，在 Module 初始化阶段省略了 NodeModule、DiscoveryModule、HttpServerModule、JsonModule、JaxrsModule、MBeanModule、PrefixObjectNameGeneratorModule、JmxModule、JmxHttpModule、LogJmxModule、TraceTokenModule、EventModule、JsonEventModule、ServerSecurityModule、AccessControlModule、EventListenerModule、GracefulShutdownModule、WarningCollectorModule；在资源加载阶段省略了 AccessControlManager、PasswordAuthenticatorManager、EventListenerManager、GroupProviderManager、CertificateAuthenticatorManager、Announcer、ServerInfoResource、ResourceGroupManager、SessionPropertyDefaults</div>

<h3 id="请求链路"><a href="#请求链路" class="headerlink" title="请求链路"></a>请求链路</h3><pre class="mermaid">sequenceDiagram

participant Client
participant QueuedStatementResource
participant QueuedStatementResource.Query
participant QueuedStatementResource#queries
participant DispatchManager
participant QueuedStatementResource.Query
participant ExecutingStatementResource
participant ExecutingStatementResource#queries
participant io.prestosql.server.protocol.Query
participant Futures

opt send query to queue
Client -&gt;&gt;+ QueuedStatementResource : POST /v1/statement

QueuedStatementResource -&gt;&gt; QueuedStatementResource : postStatement

QueuedStatementResource -&gt;&gt;+ QueuedStatementResource.Query : new
QueuedStatementResource.Query -&gt;&gt;+ DispatchManager : createQueryId
DispatchManager -&gt;&gt;- QueuedStatementResource.Query : QueryId
QueuedStatementResource.Query -&gt;&gt;- QueuedStatementResource : QueuedStatementResource.Query

QueuedStatementResource -&gt;&gt; QueuedStatementResource#queries : put with queryId

QueuedStatementResource -&gt;&gt;+ QueuedStatementResource.Query : getQueryResults

QueuedStatementResource.Query -&gt;&gt;+ QueuedStatementResource.Query : createQueryResults
QueuedStatementResource.Query -&gt;&gt;+ QueuedStatementResource.Query : getNextUri
QueuedStatementResource.Query -&gt;&gt;- QueuedStatementResource.Query : URI (http://localhost:9999/v1/statement/queued/20200906_093843_00041_pg9xm/y3f077eadf2dca6425d56173bac9afea11161cdd0/1)
QueuedStatementResource.Query -&gt;&gt;- QueuedStatementResource.Query : QueryResults

QueuedStatementResource.Query -&gt;&gt;- QueuedStatementResource : QueryResults

QueuedStatementResource -&gt;&gt;+ Response : ok
Response -&gt;&gt;- QueuedStatementResource : Response

QueuedStatementResource -&gt;&gt;- Client : Response
end






opt get query from queue and dispatch it

Client -&gt;&gt; QueuedStatementResource : GET /v1/statement/queued/{queryId}/{slug}/{token}

QueuedStatementResource -&gt;&gt;+ QueuedStatementResource : getQuery
QueuedStatementResource -&gt;&gt;+ QueuedStatementResource#queries : get by queryId
QueuedStatementResource#queries -&gt;&gt;+ QueuedStatementResource : QueuedStatementResource.Query
QueuedStatementResource -&gt;&gt;- QueuedStatementResource : QueuedStatementResource.Query

opt wait for query to be dispatched, up to the wait timeout
QueuedStatementResource -&gt;&gt;+ QueuedStatementResource.Query : waitForDispatched
QueuedStatementResource.Query -&gt;&gt;+ DispatchManager : waitForDispatched
DispatchManager -&gt;&gt;- QueuedStatementResource.Query : ListenableFuture<!--?-->
QueuedStatementResource.Query -&gt;&gt;- QueuedStatementResource : ListenableFuture<!--?-->
end

opt when state changes, fetch the next result
QueuedStatementResource -&gt;&gt; QueuedStatementResource.Query : getQueryResults
QueuedStatementResource.Query -&gt;&gt; QueuedStatementResource.Query : createQueryResults
QueuedStatementResource.Query -&gt;&gt;+ QueuedStatementResource.Query : getNextUri
QueuedStatementResource.Query -&gt;&gt;+ QueuedStatementResource.Query : getRedirectUri
QueuedStatementResource.Query -&gt;&gt;- QueuedStatementResource.Query : URI (http://localhost:9999/v1/statement/executing/20200906_093843_00041_pg9xm/y714bd6e0605f3fdf63d1aac8d10aa92f4c81cf23/0)
QueuedStatementResource.Query -&gt;&gt;- QueuedStatementResource.Query : URI
QueuedStatementResource.Query -&gt;&gt; QueuedStatementResource : QueryResults

QueuedStatementResource -&gt;&gt;+ Futures : transform
Futures -&gt;&gt;- QueuedStatementResource : ListenableFuture<queryresults>
end

opt transform to Response
QueuedStatementResource -&gt;&gt;+ Response : ok
Response -&gt;&gt;- QueuedStatementResource : Response

QueuedStatementResource -&gt;&gt;+ Futures : transform
Futures -&gt;&gt;- QueuedStatementResource : ListenableFuture<response>
end

QueuedStatementResource -&gt;&gt; QueuedStatementResource : bindAsyncResponse
QueuedStatementResource -&gt;&gt; Client : Response

end





opt execute

Client -&gt;&gt;+ ExecutingStatementResource : GET /v1/statement/executing/{queryId}/{slug}/{token}

opt get or recreate query
ExecutingStatementResource -&gt;&gt; ExecutingStatementResource : getQueryResults
ExecutingStatementResource -&gt;&gt;+ ExecutingStatementResource#queries : get by queryId

alt exist
ExecutingStatementResource#queries -&gt;&gt;- ExecutingStatementResource : io.prestosql.server.protocol.Query
else not-exist
ExecutingStatementResource -&gt;&gt;+ io.prestosql.server.protocol.Query : create
io.prestosql.server.protocol.Query -&gt;&gt;- ExecutingStatementResource : io.prestosql.server.protocol.Query
ExecutingStatementResource -&gt;&gt;+ ExecutingStatementResource#queries : computeIfAbsent
ExecutingStatementResource#queries -&gt;&gt;- ExecutingStatementResource : io.prestosql.server.protocol.Query
end

end

opt result
ExecutingStatementResource -&gt;&gt; ExecutingStatementResource : asyncQueryResults
ExecutingStatementResource -&gt;&gt;+ io.prestosql.server.protocol.Query : waitForResults
io.prestosql.server.protocol.Query -&gt;&gt;- ExecutingStatementResource : ListenableFuture<queryresults>
ExecutingStatementResource -&gt;&gt;+ ExecutingStatementResource : toResponse
ExecutingStatementResource -&gt;&gt;- ExecutingStatementResource : Response
ExecutingStatementResource -&gt;&gt;+ Futures : transform
Futures -&gt;&gt;- ExecutingStatementResource : ListenableFuture<response>
ExecutingStatementResource -&gt;&gt; ExecutingStatementResource : bindAsyncResponse
end

end

ExecutingStatementResource -&gt;&gt;- Client : Response</response></queryresults></response></queryresults></pre>

<div class="note success">点击<a href="/picture/presto/prestosql_request.svg" target="_blank">这里</a>查看完整大图</div>
<div class="note info">PrestoSQL 内部通过 getNextUri 方法，不断地获取下阶段需要调用的接口，推动完成整个请求链路的流转</div>
<div class="note info">取消已提交查询的流程与之类似，这里便不赘述</div>
<div class="note info">出于渲染复杂度的考虑，更细节的 Session、Transaction、StateMachine、Scheduler 和 Task 等概念，并没有在流程中体现出</div>






<h2 id="踩过的坑"><a href="#踩过的坑" class="headerlink" title="踩过的坑"></a>踩过的坑</h2><h3 id="不支持类型的隐式转换"><a href="#不支持类型的隐式转换" class="headerlink" title="不支持类型的隐式转换"></a>不支持类型的隐式转换</h3><h4 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h4><p>　原本只支持数值类型之间的比较，例如 <code>2 &gt; 1</code>：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@ScalarOperator(GREATER_THAN)</span></span><br><span class="line"><span class="meta">@SqlType(StandardTypes.BOOLEAN)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">greaterThan</span><span class="params">(<span class="meta">@SqlType(StandardTypes.BIGINT)</span> <span class="keyword">long</span> left, <span class="meta">@SqlType(StandardTypes.BIGINT)</span> <span class="keyword">long</span> right)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">return</span> left &gt; right;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h4><p>　增加以下方法，以支持字符串与数值之间的比较，例如 <code>'2' &gt; 1</code>：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@ScalarOperator(GREATER_THAN)</span></span><br><span class="line"><span class="meta">@SqlType(StandardTypes.BOOLEAN)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">greaterThan</span><span class="params">(<span class="meta">@SqlType(StandardTypes.VARCHAR)</span> String left, <span class="meta">@SqlType(StandardTypes.BIGINT)</span> <span class="keyword">long</span> right)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">return</span> Long.parseLong(left) &gt; right;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<div class="note success">当然也可以显示地调用 cast 函数进行类型转换</div>

<h3 id="compiler-message-file-broken"><a href="#compiler-message-file-broken" class="headerlink" title="compiler message file broken"></a>compiler message file broken</h3><h4 id="描述-1"><a href="#描述-1" class="headerlink" title="描述"></a>描述</h4><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">[INFO] --- maven-compiler-plugin:<span class="number">3.8</span>.<span class="number">0</span>:testCompile (<span class="keyword">default</span>-testCompile) @ presto-main ---</span><br><span class="line">[INFO] Changes detected - recompiling the <span class="keyword">module</span>!</span><br><span class="line">[INFO] Compiling <span class="number">942</span> source files to /Users/benedictjin/code/prestosql/presto-main/target/test-classes</span><br><span class="line">compiler message file broken: key=compiler.misc.msg.bug arguments=<span class="number">11.0</span>.<span class="number">5</span>, {<span class="number">1</span>}, {<span class="number">2</span>}, {<span class="number">3</span>}, {<span class="number">4</span>}, {<span class="number">5</span>}, {<span class="number">6</span>}, {<span class="number">7</span>}</span><br><span class="line">java.lang.NullPointerException</span><br><span class="line">    at jdk.compiler/com.sun.tools.javac.comp.Flow$FlowAnalyzer.visitApply(Flow.java:<span class="number">1235</span>)</span><br><span class="line">    at jdk.compiler/com.sun.tools.javac.tree.JCTree$JCMethodInvocation.accept(JCTree.java:<span class="number">1634</span>)</span><br><span class="line">    at jdk.compiler/com.sun.tools.javac.tree.TreeScanner.scan(TreeScanner.java:<span class="number">49</span>)</span><br><span class="line">    at jdk.compiler/com.sun.tools.javac.comp.Flow$BaseAnalyzer.scan(Flow.java:<span class="number">398</span>)</span><br><span class="line">    at jdk.compiler/com.sun.tools.javac.comp.Flow$FlowAnalyzer.visitVarDef(Flow.java:<span class="number">989</span>)</span><br><span class="line">    at jdk.compiler/com.sun.tools.javac.tree.JCTree$JCVariableDecl.accept(JCTree.java:<span class="number">956</span>)</span><br><span class="line">    at jdk.compiler/com.sun.tools.javac.tree.TreeScanner.scan(TreeScanner.java:<span class="number">49</span>)</span><br><span class="line">    at jdk.compiler/com.sun.tools.javac.comp.Flow$BaseAnalyzer.scan(Flow.java:<span class="number">398</span>)</span><br><span class="line">    at jdk.compiler/com.sun.tools.javac.tree.TreeScanner.scan(TreeScanner.java:<span class="number">57</span>)</span><br><span class="line">    at jdk.compiler/com.sun.tools.javac.comp.Flow$FlowAnalyzer.visitBlock(Flow.java:<span class="number">997</span>)</span><br><span class="line">    at jdk.compiler/com.sun.tools.javac.tree.JCTree$JCBlock.accept(JCTree.java:<span class="number">1020</span>)</span><br><span class="line">    at jdk.compiler/com.sun.tools.javac.tree.TreeScanner.scan(TreeScanner.java:<span class="number">49</span>)</span><br><span class="line">    at jdk.compiler/com.sun.tools.javac.comp.Flow$BaseAnalyzer.scan(Flow.java:<span class="number">398</span>)</span><br><span class="line">    at jdk.compiler/com.sun.tools.javac.comp.Flow$FlowAnalyzer.visitMethodDef(Flow.java:<span class="number">964</span>)</span><br><span class="line">    at jdk.compiler/com.sun.tools.javac.tree.JCTree$JCMethodDecl.accept(JCTree.java:<span class="number">866</span>)</span><br><span class="line">    at jdk.compiler/com.sun.tools.javac.tree.TreeScanner.scan(TreeScanner.java:<span class="number">49</span>)</span><br><span class="line">    at jdk.compiler/com.sun.tools.javac.comp.Flow$BaseAnalyzer.scan(Flow.java:<span class="number">398</span>)</span><br><span class="line">    at jdk.compiler/com.sun.tools.javac.comp.Flow$FlowAnalyzer.visitClassDef(Flow.java:<span class="number">927</span>)</span><br><span class="line">    at jdk.compiler/com.sun.tools.javac.tree.JCTree$JCClassDecl.accept(JCTree.java:<span class="number">774</span>)</span><br><span class="line">    at jdk.compiler/com.sun.tools.javac.tree.TreeScanner.scan(TreeScanner.java:<span class="number">49</span>)</span><br><span class="line">    at jdk.compiler/com.sun.tools.javac.comp.Flow$BaseAnalyzer.scan(Flow.java:<span class="number">398</span>)</span><br><span class="line">    at jdk.compiler/com.sun.tools.javac.comp.Flow$FlowAnalyzer.analyzeTree(Flow.java:<span class="number">1327</span>)</span><br><span class="line">    at jdk.compiler/com.sun.tools.javac.comp.Flow$FlowAnalyzer.analyzeTree(Flow.java:<span class="number">1317</span>)</span><br><span class="line">    at jdk.compiler/com.sun.tools.javac.comp.Flow.analyzeTree(Flow.java:<span class="number">218</span>)</span><br><span class="line">    at jdk.compiler/com.sun.tools.javac.main.JavaCompiler.flow(JavaCompiler.java:<span class="number">1401</span>)</span><br><span class="line">    at jdk.compiler/com.sun.tools.javac.main.JavaCompiler.flow(JavaCompiler.java:<span class="number">1375</span>)</span><br><span class="line">    at jdk.compiler/com.sun.tools.javac.main.JavaCompiler.compile(JavaCompiler.java:<span class="number">973</span>)</span><br><span class="line">    at jdk.compiler/com.sun.tools.javac.api.JavacTaskImpl.lambda$doCall$<span class="number">0</span>(JavacTaskImpl.java:<span class="number">104</span>)</span><br><span class="line">    at jdk.compiler/com.sun.tools.javac.api.JavacTaskImpl.handleExceptions(JavacTaskImpl.java:<span class="number">147</span>)</span><br><span class="line">    at jdk.compiler/com.sun.tools.javac.api.JavacTaskImpl.doCall(JavacTaskImpl.java:<span class="number">100</span>)</span><br><span class="line">    at jdk.compiler/com.sun.tools.javac.api.JavacTaskImpl.call(JavacTaskImpl.java:<span class="number">94</span>)</span><br><span class="line">    at org.codehaus.plexus.compiler.javac.JavaxToolsCompiler.compileInProcess(JavaxToolsCompiler.java:<span class="number">126</span>)</span><br><span class="line">    at org.codehaus.plexus.compiler.javac.JavacCompiler.performCompile(JavacCompiler.java:<span class="number">174</span>)</span><br><span class="line">    at org.apache.maven.plugin.compiler.AbstractCompilerMojo.execute(AbstractCompilerMojo.java:<span class="number">1129</span>)</span><br><span class="line">    at org.apache.maven.plugin.compiler.TestCompilerMojo.execute(TestCompilerMojo.java:<span class="number">181</span>)</span><br><span class="line">    at org.apache.maven.plugin.DefaultBuildPluginManager.executeMojo(DefaultBuildPluginManager.java:<span class="number">137</span>)</span><br><span class="line">    at org.apache.maven.lifecycle.internal.MojoExecutor.execute(MojoExecutor.java:<span class="number">210</span>)</span><br><span class="line">    at org.apache.maven.lifecycle.internal.MojoExecutor.execute(MojoExecutor.java:<span class="number">156</span>)</span><br><span class="line">    at org.apache.maven.lifecycle.internal.MojoExecutor.execute(MojoExecutor.java:<span class="number">148</span>)</span><br><span class="line">    at org.apache.maven.lifecycle.internal.LifecycleModuleBuilder.buildProject(LifecycleModuleBuilder.java:<span class="number">117</span>)</span><br><span class="line">    at org.apache.maven.lifecycle.internal.builder.multithreaded.MultiThreadedBuilder$<span class="number">1.</span>call(MultiThreadedBuilder.java:<span class="number">190</span>)</span><br><span class="line">    at org.apache.maven.lifecycle.internal.builder.multithreaded.MultiThreadedBuilder$<span class="number">1.</span>call(MultiThreadedBuilder.java:<span class="number">186</span>)</span><br><span class="line">    at java.base/java.util.concurrent.FutureTask.run(FutureTask.java:<span class="number">264</span>)</span><br><span class="line">    at java.base/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:<span class="number">515</span>)</span><br><span class="line">    at java.base/java.util.concurrent.FutureTask.run(FutureTask.java:<span class="number">264</span>)</span><br><span class="line">    at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1128</span>)</span><br><span class="line">    at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">628</span>)</span><br><span class="line">    at java.base/java.lang.Thread.run(Thread.java:<span class="number">834</span>)</span><br></pre></td></tr></tbody></table></figure>
<h4 id="解决-1"><a href="#解决-1" class="headerlink" title="解决"></a>解决</h4><p>　低版本 JDK11 的已知 <a href="https://bugs.openjdk.java.net/browse/JDK-8212586">Bug</a>，升级至当前最新的版本（JDK11.0.9+7-LTS）后解决</p>
<h3 id="Terminating-due-to-java-lang-OutOfMemoryError-Java-heap-space"><a href="#Terminating-due-to-java-lang-OutOfMemoryError-Java-heap-space" class="headerlink" title="Terminating due to java.lang.OutOfMemoryError: Java heap space"></a>Terminating due to java.lang.OutOfMemoryError: Java heap space</h3><h4 id="描述-2"><a href="#描述-2" class="headerlink" title="描述"></a>描述</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim etc/jvm.config</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">-server</span></span><br><span class="line"><span class="attr">-Xmx128M</span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">+UseG1GC</span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">G1HeapRegionSize=4M</span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">+UseGCOverheadLimit</span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">+ExplicitGCInvokesConcurrent</span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">+ExitOnOutOfMemoryError</span></span><br><span class="line"><span class="meta">-agentlib</span>:<span class="string">jdwp=transport=dt_socket,server=y,suspend=n,address=5005</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="解决-2"><a href="#解决-2" class="headerlink" title="解决"></a>解决</h4><ul>
<li><p>Dump 内存占用的情况</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim etc/jvm.config</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">-XX</span>:<span class="string">+HeapDumpOnOutOfMemoryError</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>定位出内存 OOM 的原因</p>
<p>通过 <a href="https://yuzhouwan.com/posts/190413/#MAT-%E5%86%85%E5%AD%98%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%EF%BC%88Memory-Analyzer-Tool%EF%BC%89">MAT</a> 工具分析发现是 System 的 ClassLoader 使用 <code>java.util.zip.ZipFile$Source</code> 加载 jar 包，并保存在堆内内存上，占用了 70% 多的内存资源。这是 JDK9 中做的一次改动，为了避免调用耗时的 JNI，以及 <a href="https://yuzhouwan.com/posts/15691/#mmap">MMap</a> 出现 Crash 的风险，详见 JDK-8145260</p>
</li>
<li><p>提高分配的内存大小</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim etc/jvm.config</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">-Xmx256M</span></span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<div class="note info">内存分配：小于 128MB 时，无法启动；小于 256MB 时，GC 频繁；大于 256MB 时，平稳运行</div>

<h3 id="jmx-properties-does-not-contain-connector-name"><a href="#jmx-properties-does-not-contain-connector-name" class="headerlink" title="jmx.properties does not contain connector.name"></a>jmx.properties does not contain connector.name</h3><h4 id="解决-3"><a href="#解决-3" class="headerlink" title="解决"></a>解决</h4><p>　JMX Connector 的 <code>connector.name</code> 属于必填字段，给 jmx.properties 增加一行 <code>connector.name=jmx</code> 即可</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim catalog/jmx.properties</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">connector.name</span>=<span class="string">jmx</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="社区发展"><a href="#社区发展" class="headerlink" title="社区发展"></a>社区发展</h2><h3 id="Star-趋势"><a href="#Star-趋势" class="headerlink" title="Star 趋势"></a>Star 趋势</h3><p><img data-src="/picture/presto/presto_star_history.jpg" alt="Presto Star History"></p>
<center>（图片来源：<a href="https://star-history.t9t.io/#prestodb/presto&amp;apache/hive&amp;prestosql/presto" target="_blank">star-history.t9t.io</a>™ 官网）</center>

<h3 id="个人贡献"><a href="#个人贡献" class="headerlink" title="个人贡献"></a>个人贡献</h3><ul>
<li>Pull Request<ul>
<li><a href="https://github.com/prestodb/presto/pulls?q=is%3Apr+author%3Aasdf2014">PrestoDB</a></li>
<li><a href="https://github.com/prestosql/presto/pulls?q=is%3Apr+author%3Aasdf2014">PrestoSQL</a></li>
</ul>
</li>
</ul>
<p>　详见：《<a href="https://yuzhouwan.com/posts/19631/">如何成为 Apache 的 PMC</a>》</p>
<h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><h3 id="Doc"><a href="#Doc" class="headerlink" title="Doc"></a>Doc</h3><ul>
<li><a href="https://prestodb.io/docs/current/connector.html">PrestoDB Connectors</a></li>
<li><a href="https://prestosql.io/docs/current/connector.html">PrestoSQL Connectors</a></li>
<li><a href="https://prestosql.io/docs/current/develop/example-http.html">Example HTTP Connector</a></li>
<li><a href="https://docs.starburstdata.com/latest/kubernetes/hpa.html">Horizontal scaling</a></li>
</ul>
<h3 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h3><ul>
<li><a href="https://prestosql.io/docs/current/connector/phoenix.html">PrestoSQL Phoenix Connector</a></li>
<li><a href="https://github.com/analysys/presto-hbase-connector">PrestoSQL HBase Connector</a></li>
</ul>
<h3 id="Book"><a href="#Book" class="headerlink" title="Book"></a>Book</h3><ul>
<li>Presto: The Definitive Guide</li>
</ul>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt=""></a></td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>SQL</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>Kubernetes</tag>
        <tag>Docker</tag>
        <tag>Maven</tag>
        <tag>Java</tag>
        <tag>Apache Druid</tag>
        <tag>PrestoDB</tag>
        <tag>Apache Hive</tag>
        <tag>Python</tag>
        <tag>Presto</tag>
        <tag>PrestoSQL</tag>
        <tag>MPP</tag>
        <tag>SPI</tag>
      </tags>
  </entry>
  <entry>
    <title>搜索引擎 ElasticSearch</title>
    <url>/posts/22654/</url>
    <content><![CDATA[<h2 id="ElasticSearch-是什么？"><a href="#ElasticSearch-是什么？" class="headerlink" title="ElasticSearch 是什么？"></a>ElasticSearch 是什么？</h2><p>　<a href="https://yuzhouwan.com/posts/22654/"><strong>ElasticSearch</strong></a>™ 是一款基于 Lucene 的搜索引擎，不但稳定、可靠、快速，同时具备良好的水平扩展能力</p>
<h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2><ul>
<li>功能丰富，且开箱即用</li>
<li>横向可扩展性</li>
<li>分片机制更好地解决热点问题</li>
<li>多副本有效保证了高可用</li>
<li>精确的熔断器机制</li>
<li>社区庞大，生态完善</li>
</ul>
<h2 id="主要概念"><a href="#主要概念" class="headerlink" title="主要概念"></a>主要概念</h2><h3 id="Cluster-集群"><a href="#Cluster-集群" class="headerlink" title="Cluster 集群"></a>Cluster 集群</h3><p>　在一个分布式系统里面，可以通过多个 ElasticSearch 节点组成一个<strong>集群</strong>。集群中会动态选举出一个主节点，保证了 ElasticSearch 集群不存在单点故障<br>　在同一子网内，只需要将进程设置为相同的集群名，ElasticSearch 就会把这些集群名相同的进程自动组成一个集群。集群中各节点间的通讯和数据负载均衡，全部都由 ElasticSearch 自动管理</p>
<h3 id="Node-节点"><a href="#Node-节点" class="headerlink" title="Node 节点"></a>Node 节点</h3><p>　每一个 ElasticSearch 进程称为一个 <strong>Node 节点</strong>。在测试环境中，可以在一台服务器上运行多个 ElasticSearch 进程；但生产环境中，则建议每台服务器只运行一个 ElasticSearch 进程</p>
<h3 id="Index-索引"><a href="#Index-索引" class="headerlink" title="Index 索引"></a>Index 索引</h3><p>　ElasticSearch 中的索引是文档数据存储的地方，相当于是传统关系数据库中的 DataBase 概念。更多逻辑上的对应关系，如下表所示：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">Relational DB</th>
<th style="text-align:center">HBase</th>
<th style="text-align:center">ElasticSearch</th>
<th style="text-align:center">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Database</td>
<td style="text-align:center">NameSpace</td>
<td style="text-align:center">Template</td>
<td style="text-align:center">一组索引的模板配置</td>
</tr>
<tr>
<td style="text-align:center">Table</td>
<td style="text-align:center">Table</td>
<td style="text-align:center">Index</td>
<td style="text-align:center">索引</td>
</tr>
<tr>
<td style="text-align:center">Row</td>
<td style="text-align:center">RowKey</td>
<td style="text-align:center">Document</td>
<td style="text-align:center">文档，和 Lucene 概念一致</td>
</tr>
<tr>
<td style="text-align:center">Column + Value</td>
<td style="text-align:center">Cell</td>
<td style="text-align:center">Field</td>
<td style="text-align:center">如果将文档理解为 JSON，那么 Field 就是字段和值</td>
</tr>
<tr>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
<td style="text-align:center">Term</td>
<td style="text-align:center">检索的基本单位，相当于是文本中的一个词</td>
</tr>
<tr>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
<td style="text-align:center">Token</td>
<td style="text-align:center">Term 内容、类型，以及 Term 在文本中的起始及偏移</td>
</tr>
</tbody>
</table>
</div>
<div class="note info">目前最新的 ElasticSearch 7.x 版本里面已经废弃了 Type 的概念</div>

<a id="more"></a>
<h3 id="Shard-分片"><a href="#Shard-分片" class="headerlink" title="Shard 分片"></a>Shard 分片</h3><p>　ElasticSearch 会把一个索引拆分为多个更细粒度的索引，并称之为 Shard<br>　完成分片之后，就可以把各个 Shard 分配到不同的节点中去。同时，ElasticSearch 会确保两个相同的 Shard 不会同时存在于一个 Node 上</p>
<h3 id="Replica-副本"><a href="#Replica-副本" class="headerlink" title="Replica 副本"></a>Replica 副本</h3><p>　ElasticSearch 的每一个 Shard 分片都可以有多个<strong>副本</strong>，而每一个副本也都是分片的完整拷贝。如此设计的好处是，既可以提升查询速度，也能提高系统的容错性<br>　一旦 ElasticSearch 的某个节点数据损坏或者服务不可用的时候，那么就可以用其他节点来代替故障的节点，以达到高可用的目标</p>
<h3 id="Recovery-故障恢复"><a href="#Recovery-故障恢复" class="headerlink" title="Recovery 故障恢复"></a>Recovery 故障恢复</h3><p>　ElasticSearch 的 Recovery 代表的是<strong>数据恢复</strong>或者称之为<strong>数据重新分布</strong><br>　当 ElasticSearch 集群中，有节点加入或退出时，它会根据机器负载对索引分片进行重新分配</p>
<div class="note info">另外，当挂掉的节点再次重新启动的时候也会进行数据恢复</div>


<h3 id="River-数据源"><a href="#River-数据源" class="headerlink" title="River 数据源"></a>River 数据源</h3><p>　River 代表的是一个<strong>数据源</strong>，这也是同步数据到 ElasticSearch 的一个方法<br>　主要流程是读取 River 中的数据，再将其索引到 ElasticSearch 中，并以插件方式对外提供服务。官方支持的 River 类型有 <a href="https://github.com/elastic/elasticsearch-river-couchdb">CouchDB</a>、<a href="https://github.com/elastic/elasticsearch-river-rabbitmq">RabbitMQ</a>、<a href="https://github.com/elastic/elasticsearch-river-twitter">Twitter</a>、<a href="https://github.com/elastic/elasticsearch-river-wikipedia">Wikipedia</a> 等</p>
<h3 id="Gateway-时空门"><a href="#Gateway-时空门" class="headerlink" title="Gateway 时空门"></a>Gateway 时空门</h3><p>　Gateway 是 ElasticSearch 索引的<strong>持久化存储</strong>方式，ElasticSearch 默认会先把索引存放到内存中去，当内存满了的时候再持久化到硬盘里。之后，当 ElasticSearch 集群重启时，就会从 Gateway 中读取索引数据<br>　Gateway 支持多种存储媒介，包括本地文件系统（默认）、分布式文件系统、<a href="https://yuzhouwan.com/posts/60504/">HDFS</a> 和 S3 云存储服务 等</p>
<h3 id="discovery-zen-节点发现"><a href="#discovery-zen-节点发现" class="headerlink" title="discovery.zen 节点发现"></a>discovery.zen 节点发现</h3><p>　discovery.zen 是 ElasticSearch 的<strong>自动节点发现机制</strong>，支持基于配置（静态配置中设置的主机列表）与基于文件（定时加载外部文件中的主机列表）两种模式<br>　集群会以广播的方式去寻找存在的 Node 节点，然后再通过多播协议来进行节点之间的通信，同时也支持点对点（P2P，Point 2 Point）的交互操作</p>
<h3 id="Transport-通讯机制"><a href="#Transport-通讯机制" class="headerlink" title="Transport 通讯机制"></a>Transport 通讯机制</h3><p>　Transport 是 ElasticSearch 内部的节点或者集群与客户端之间的交互方式，默认会使用 TCP 协议完成通讯</p>
<h2 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a>架构图</h2><p><img data-src="/picture/es/es_architecture.png" alt="ElasticSearch Architecture"></p>
<center>（利用 <a href="https://www.axure.com.cn/" target="_blank">Axure</a>™ 绘制而成）</center>





<h2 id="环境部署"><a href="#环境部署" class="headerlink" title="环境部署"></a>环境部署</h2><h3 id="单机版"><a href="#单机版" class="headerlink" title="单机版"></a>单机版</h3><h4 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h4><p>　首先从官方的<a href="https://www.elastic.co/cn/downloads/elasticsearch">下载页面</a>上，找到适合自己操作系统的安装包（这里我们以 MacOS 为例）</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.9.1-darwin-x86_64.tar.gz</span><br></pre></td></tr></tbody></table></figure>
<h4 id="解压"><a href="#解压" class="headerlink" title="解压"></a>解压</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ tar zxvf elasticsearch-7.9.1-darwin-x86_64.tar.gz</span><br><span class="line">$ ln -s elasticsearch-7.9.1 es</span><br><span class="line">$ <span class="built_in">cd</span> es</span><br></pre></td></tr></tbody></table></figure>
<h4 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim ~/.bashrc</span><br><span class="line">  <span class="built_in">export</span> ES_HOME=/apps/es</span><br><span class="line">  <span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$ES_HOME</span>/bin</span><br><span class="line">$ <span class="built_in">source</span> ~/.bashrc</span><br><span class="line">$ elasticsearch -version</span><br></pre></td></tr></tbody></table></figure>
<h4 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ elasticsearch</span><br><span class="line"></span><br><span class="line"><span class="comment"># 增加 -d 可以使得 ElasticSearch 进程在后台运行</span></span><br><span class="line">$ elasticsearch -d</span><br></pre></td></tr></tbody></table></figure>
<h4 id="校验"><a href="#校验" class="headerlink" title="校验"></a>校验</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ curl -XGET <span class="string">'http://localhost:9200/_cluster/health'</span> | python -m json.tool</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"cluster_name"</span>: <span class="string">"elasticsearch"</span>,</span><br><span class="line">  <span class="attr">"status"</span>: <span class="string">"green"</span>,</span><br><span class="line">  <span class="attr">"timed_out"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"number_of_nodes"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"number_of_data_nodes"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"active_primary_shards"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"active_shards"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"relocating_shards"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"initializing_shards"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"unassigned_shards"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"delayed_unassigned_shards"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"number_of_pending_tasks"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"number_of_in_flight_fetch"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"task_max_waiting_in_queue_millis"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"active_shards_percent_as_number"</span>: <span class="number">100.0</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="可视化"><a href="#可视化" class="headerlink" title="可视化"></a>可视化</h4><h5 id="本地-Kibana"><a href="#本地-Kibana" class="headerlink" title="本地 Kibana"></a><a href="https://www.elastic.co/cn/downloads/kibana">本地 Kibana</a></h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 下载</span></span><br><span class="line">$ wget https://artifacts.elastic.co/downloads/kibana/kibana-7.9.1-darwin-x86_64.tar.gz</span><br><span class="line">$ tar zxvf kibana-7.9.1-darwin-x86_64.tar.gz</span><br><span class="line">$ ln -s kibana-7.9.1-darwin-x86_64 kibana</span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">$ <span class="built_in">cd</span> kibana</span><br><span class="line">$ bin/kibana</span><br><span class="line"><span class="comment"># 使用</span></span><br><span class="line">$ open <span class="string">'http://localhost:5601'</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="Kubernetes-版"><a href="#Kubernetes-版" class="headerlink" title="Kubernetes 版"></a><a href="https://hub.helm.sh/charts/bitnami/elasticsearch">Kubernetes 版</a></h3><h4 id="安装-Helm-Charts"><a href="#安装-Helm-Charts" class="headerlink" title="安装 Helm Charts"></a>安装 Helm Charts</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ helm repo add bitnami https://charts.bitnami.com/bitnami</span><br><span class="line">$ helm install my-release bitnami/elasticsearch</span><br></pre></td></tr></tbody></table></figure>
<h4 id="校验-1"><a href="#校验-1" class="headerlink" title="校验"></a>校验</h4><p><img data-src="/picture/es/elasticsearch_on_kubernetes_dashboard.png" alt="ElasticSearch on Kubernetes Dashboard"></p>
<center>（图片来源：对 <a href="https://github.com/kubernetes/dashboard" target="_blank">Kubernetes Dashboard</a>™ 的截图）</center>



<h4 id="端口转发"><a href="#端口转发" class="headerlink" title="端口转发"></a>端口转发</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ kubectl port-forward --namespace default svc/my-release-elasticsearch-coordinating-only 9200:9200 &amp;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ curl http://127.0.0.1:9200/</span><br></pre></td></tr></tbody></table></figure>
<h4 id="可视化-1"><a href="#可视化-1" class="headerlink" title="可视化"></a>可视化</h4><h5 id="Kibana-on-Kubernetes"><a href="#Kibana-on-Kubernetes" class="headerlink" title="Kibana on Kubernetes"></a>Kibana on Kubernetes</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ helm repo add elastic https://helm.elastic.co</span><br><span class="line">$ helm install kibana elastic/kibana</span><br></pre></td></tr></tbody></table></figure>
<h2 id="实用技巧"><a href="#实用技巧" class="headerlink" title="实用技巧"></a>实用技巧</h2><div class="note success">以下介绍的内容均为 ElasticSearch 7.9.1 版本的用法</div>

<h3 id="写入数据"><a href="#写入数据" class="headerlink" title="写入数据"></a>写入数据</h3><h4 id="创建-Document"><a href="#创建-Document" class="headerlink" title="创建 Document"></a>创建 Document</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">POST yuzhouwan/_doc/</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"user"</span>: <span class="string">"BenedictJin"</span>,</span><br><span class="line">  <span class="attr">"end_time"</span>: <span class="string">"2038-01-19T03:14:07"</span>,</span><br><span class="line">  <span class="attr">"github"</span>: <span class="string">"asdf2014"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"_index"</span>: <span class="string">"yuzhouwan"</span>,</span><br><span class="line">  <span class="attr">"_type"</span>: <span class="string">"_doc"</span>,</span><br><span class="line">  <span class="attr">"_id"</span>: <span class="string">"Uqs7tm4B6KBuNSr8fQM0"</span>,</span><br><span class="line">  <span class="attr">"_version"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"result"</span>: <span class="string">"created"</span>,</span><br><span class="line">  <span class="attr">"_shards"</span>: {</span><br><span class="line">    <span class="attr">"total"</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">"successful"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"failed"</span>: <span class="number">0</span></span><br><span class="line">  },</span><br><span class="line">  <span class="attr">"_seq_no"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"_primary_term"</span>: <span class="number">1</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="指定-Document-ID"><a href="#指定-Document-ID" class="headerlink" title="指定 Document ID"></a>指定 Document ID</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">POST yuzhouwan/_doc/1</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"user"</span>: <span class="string">"BenedictJin"</span>,</span><br><span class="line">  <span class="attr">"end_time"</span>: <span class="string">"2038-01-19T03:14:07"</span>,</span><br><span class="line">  <span class="attr">"github"</span>: <span class="string">"asdf2014"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"_index"</span>: <span class="string">"yuzhouwan"</span>,</span><br><span class="line">  <span class="attr">"_type"</span>: <span class="string">"_doc"</span>,</span><br><span class="line">  <span class="attr">"_id"</span>: <span class="string">"1"</span>,</span><br><span class="line">  <span class="attr">"_version"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"result"</span>: <span class="string">"created"</span>,</span><br><span class="line">  <span class="attr">"_shards"</span>: {</span><br><span class="line">    <span class="attr">"total"</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">"successful"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"failed"</span>: <span class="number">0</span></span><br><span class="line">  },</span><br><span class="line">  <span class="attr">"_seq_no"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"_primary_term"</span>: <span class="number">1</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>　再次写入相同 Doc ID 的记录后，会更新 <code>_version</code></p>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"_index"</span>: <span class="string">"yuzhouwan"</span>,</span><br><span class="line">  <span class="attr">"_type"</span>: <span class="string">"_doc"</span>,</span><br><span class="line">  <span class="attr">"_id"</span>: <span class="string">"1"</span>,</span><br><span class="line">  <span class="attr">"_version"</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="attr">"result"</span>: <span class="string">"updated"</span>,</span><br><span class="line">  <span class="attr">"_shards"</span>: {</span><br><span class="line">    <span class="attr">"total"</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">"successful"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"failed"</span>: <span class="number">0</span></span><br><span class="line">  },</span><br><span class="line">  <span class="attr">"_seq_no"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"_primary_term"</span>: <span class="number">1</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="查询数据"><a href="#查询数据" class="headerlink" title="查询数据"></a>查询数据</h3><h4 id="匹配所有索引"><a href="#匹配所有索引" class="headerlink" title="匹配所有索引"></a><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-match-all-query.html">匹配所有索引</a></h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">GET _search</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"query"</span>: {</span><br><span class="line">    <span class="attr">"match_all"</span>: {}</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="指定索引"><a href="#指定索引" class="headerlink" title="指定索引"></a>指定索引</h4><h5 id="指定某一个索引"><a href="#指定某一个索引" class="headerlink" title="指定某一个索引"></a>指定某一个索引</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">GET /yuzhouwan/_search</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"took"</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="attr">"timed_out"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"_shards"</span>: {</span><br><span class="line">    <span class="attr">"total"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"successful"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"skipped"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"failed"</span>: <span class="number">0</span></span><br><span class="line">  },</span><br><span class="line">  <span class="attr">"hits"</span>: {</span><br><span class="line">    <span class="attr">"total"</span>: {</span><br><span class="line">      <span class="attr">"value"</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">"relation"</span>: <span class="string">"eq"</span></span><br><span class="line">    },</span><br><span class="line">    <span class="attr">"max_score"</span>: <span class="number">1.0</span>,</span><br><span class="line">    <span class="attr">"hits"</span>: [</span><br><span class="line">      {</span><br><span class="line">        <span class="attr">"_index"</span>: <span class="string">"yuzhouwan"</span>,</span><br><span class="line">        <span class="attr">"_type"</span>: <span class="string">"_doc"</span>,</span><br><span class="line">        <span class="attr">"_id"</span>: <span class="string">"Uqs7tm4B6KBuNSr8fQM0"</span>,</span><br><span class="line">        <span class="attr">"_score"</span>: <span class="number">1.0</span>,</span><br><span class="line">        <span class="attr">"_source"</span>: {</span><br><span class="line">          <span class="attr">"user"</span>: <span class="string">"BenedictJin"</span>,</span><br><span class="line">          <span class="attr">"end_time"</span>: <span class="string">"2038-01-19T03:14:07"</span>,</span><br><span class="line">          <span class="attr">"github"</span>: <span class="string">"asdf2014"</span></span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    ]</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h5 id="指定多个索引"><a href="#指定多个索引" class="headerlink" title="指定多个索引"></a>指定多个索引</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">GET /yuzhouwan01,yuzhouwan02/_search</span><br></pre></td></tr></tbody></table></figure>
<h5 id="通配符匹配多个索引"><a href="#通配符匹配多个索引" class="headerlink" title="通配符匹配多个索引"></a>通配符匹配多个索引</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">GET /yuzhouwan*/_search</span><br></pre></td></tr></tbody></table></figure>
<h4 id="控制展示数量"><a href="#控制展示数量" class="headerlink" title="控制展示数量"></a>控制展示数量</h4><p>　由于默认只会展示 10 个匹配结果，所以需要设置 <code>size</code> 参数来调整</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">GET /yuzhouwan/_search?size=100</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"query"</span>: {</span><br><span class="line">    <span class="attr">"match"</span>: {</span><br><span class="line">      <span class="attr">"pattern"</span>: <span class="string">"FLUSH"</span></span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">GET /yuzhouwan/_search</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"from"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">100</span>,</span><br><span class="line">  <span class="attr">"query"</span>: {</span><br><span class="line">    <span class="attr">"match"</span>: {</span><br><span class="line">      <span class="attr">"pattern"</span>: <span class="string">"FLUSH"</span></span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="指定返回字段"><a href="#指定返回字段" class="headerlink" title="指定返回字段"></a>指定返回字段</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">GET /yuzhouwan/_search</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"_source"</span>: [</span><br><span class="line">    <span class="string">"message"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"from"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">100</span>,</span><br><span class="line">  <span class="attr">"query"</span>: {</span><br><span class="line">    <span class="attr">"match_all"</span>: {}</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="范围查询"><a href="#范围查询" class="headerlink" title="范围查询"></a><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-range-query.html">范围查询</a></h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">GET /yuzhouwan/_search</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"query"</span>: {</span><br><span class="line">    <span class="attr">"range"</span>: {</span><br><span class="line">      <span class="attr">"CREATETIME"</span>: {</span><br><span class="line">        <span class="attr">"gte"</span>: <span class="string">"1496246400000"</span>,</span><br><span class="line">        <span class="attr">"lt"</span>: <span class="string">"1498838400000"</span></span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="聚合查询"><a href="#聚合查询" class="headerlink" title="聚合查询"></a>聚合查询</h4><h5 id="Group-Count"><a href="#Group-Count" class="headerlink" title="Group Count"></a><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-terms-aggregation.html">Group Count</a></h5><p>　对 <code>end_time</code> 字段进行 group 分组，再进行 count 计数，并过滤</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">GET /yuzhouwan/_search</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"aggs"</span>: {</span><br><span class="line">    <span class="attr">"group_by_link"</span>: {</span><br><span class="line">      <span class="attr">"terms"</span>: {</span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"end_time"</span>,</span><br><span class="line">        <span class="attr">"size"</span>: <span class="number">100</span></span><br><span class="line">      },</span><br><span class="line">      <span class="attr">"aggs"</span>: {</span><br><span class="line">        <span class="attr">"sales_bucket_filter"</span>: {</span><br><span class="line">          <span class="attr">"bucket_selector"</span>: {</span><br><span class="line">            <span class="attr">"buckets_path"</span>: {</span><br><span class="line">              <span class="attr">"the_doc_count"</span>: <span class="string">"_count"</span></span><br><span class="line">            },</span><br><span class="line">            <span class="attr">"script"</span>: <span class="string">"params.the_doc_count == 1"</span></span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"took"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"timed_out"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"_shards"</span>: {</span><br><span class="line">    <span class="attr">"total"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"successful"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"skipped"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"failed"</span>: <span class="number">0</span></span><br><span class="line">  },</span><br><span class="line">  <span class="attr">"hits"</span>: {</span><br><span class="line">    <span class="attr">"total"</span>: {</span><br><span class="line">      <span class="attr">"value"</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">"relation"</span>: <span class="string">"eq"</span></span><br><span class="line">    },</span><br><span class="line">    <span class="attr">"max_score"</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">"hits"</span>: []</span><br><span class="line">  },</span><br><span class="line">  <span class="attr">"aggregations"</span>: {</span><br><span class="line">    <span class="attr">"group_by_link"</span>: {</span><br><span class="line">      <span class="attr">"doc_count_error_upper_bound"</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"sum_other_doc_count"</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"buckets"</span>: [</span><br><span class="line">        {</span><br><span class="line">          <span class="attr">"key"</span>: <span class="number">2147483647000</span>,</span><br><span class="line">          <span class="attr">"key_as_string"</span>: <span class="string">"2038-01-19T03:14:07.000Z"</span>,</span><br><span class="line">          <span class="attr">"doc_count"</span>: <span class="number">1</span></span><br><span class="line">        }</span><br><span class="line">      ]</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="过滤查询"><a href="#过滤查询" class="headerlink" title="过滤查询"></a>过滤查询</h4><h5 id="数组长度"><a href="#数组长度" class="headerlink" title="数组长度"></a>数组长度</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">POST yuzhouwan/_doc/</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"user"</span>: <span class="string">"BenedictJin"</span>,</span><br><span class="line">  <span class="attr">"end_time"</span>: <span class="string">"2038-01-19T03:14:07"</span>,</span><br><span class="line">  <span class="attr">"github"</span>: <span class="string">"asdf2014"</span>,</span><br><span class="line">  <span class="attr">"follower"</span>: [</span><br><span class="line">    <span class="string">"f1"</span>,</span><br><span class="line">    <span class="string">"f2"</span>,</span><br><span class="line">    <span class="string">"f3"</span></span><br><span class="line">  ]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<div class="note info">过滤查询之前，需要修改 mapping，给 follower 字段增加 "fielddata": true 属性</div>

<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">GET /yuzhouwan/_search</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"query"</span>: {</span><br><span class="line">    <span class="attr">"bool"</span>: {</span><br><span class="line">      <span class="attr">"must"</span>: [</span><br><span class="line">        {</span><br><span class="line">          <span class="attr">"range"</span>: {</span><br><span class="line">            <span class="attr">"end_time"</span>: {</span><br><span class="line">              <span class="attr">"gte"</span>: <span class="string">"1514960000000"</span></span><br><span class="line">            }</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"filter"</span>: {</span><br><span class="line">        <span class="attr">"script"</span>: {</span><br><span class="line">          <span class="attr">"script"</span>: {</span><br><span class="line">            <span class="attr">"source"</span>: <span class="string">"doc['follower'].length == 3"</span></span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="删除数据"><a href="#删除数据" class="headerlink" title="删除数据"></a><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-delete-by-query.html">删除数据</a></h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">POST yuzhouwan/_delete_by_query</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"query"</span>: {</span><br><span class="line">    <span class="attr">"match"</span>: {</span><br><span class="line">      <span class="attr">"github"</span> : <span class="string">"asdf2014"</span></span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="清理缓存"><a href="#清理缓存" class="headerlink" title="清理缓存"></a><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-clearcache.html">清理缓存</a></h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 查看缓存情况</span></span><br><span class="line">GET /_stats/fielddata?fields=*</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理某一个索引的缓存</span></span><br><span class="line">POST /yuzhouwan/_cache/clear</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理全部索引的缓存</span></span><br><span class="line">POST /_cache/clear</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定缓存类型</span></span><br><span class="line">POST /yuzhouwan/_cache/clear?fielddata=<span class="literal">true</span>  </span><br><span class="line">POST /yuzhouwan/_cache/clear?query=<span class="literal">true</span>      </span><br><span class="line">POST /yuzhouwan/_cache/clear?request=<span class="literal">true</span>    </span><br></pre></td></tr></tbody></table></figure>
<h3 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h3><h4 id="获取索引"><a href="#获取索引" class="headerlink" title="获取索引"></a>获取索引</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 查看所有索引</span></span><br><span class="line">GET /_cat/indices</span><br><span class="line"><span class="comment"># 指定查看某一个索引</span></span><br><span class="line">GET /_cat/indices/yuzhouwan</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">yellow open yuzhouwan jslqKujdSUu6LTymB3Lq9A 1 1 1 0 10kb 10kb</span><br></pre></td></tr></tbody></table></figure>
<h4 id="获取-Mapping"><a href="#获取-Mapping" class="headerlink" title="获取 Mapping"></a><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-get-mapping.html">获取</a> Mapping</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 获取指定索引的 mapping</span></span><br><span class="line">GET /yuzhouwan/_mapping</span><br><span class="line">GET /yuzhouwan_day_20160527/_mapping</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取所有索引的 mapping</span></span><br><span class="line">GET /_all/_mapping</span><br><span class="line">GET /_mapping</span><br></pre></td></tr></tbody></table></figure>
<h4 id="更新-Mapping"><a href="#更新-Mapping" class="headerlink" title="更新 Mapping"></a>更新 Mapping</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">PUT /yuzhouwan/_mapping</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"properties"</span>: {</span><br><span class="line">    <span class="attr">"end_time"</span>: {</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"date"</span></span><br><span class="line">    },</span><br><span class="line">    <span class="attr">"follower"</span>: {</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"text"</span>,</span><br><span class="line">      <span class="attr">"fields"</span>: {</span><br><span class="line">        <span class="attr">"keyword"</span>: {</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"keyword"</span>,</span><br><span class="line">          <span class="attr">"ignore_above"</span>: <span class="number">256</span></span><br><span class="line">        }</span><br><span class="line">      },</span><br><span class="line">      <span class="attr">"fielddata"</span>: <span class="literal">true</span></span><br><span class="line">    },</span><br><span class="line">    <span class="attr">"github"</span>: {</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"text"</span>,</span><br><span class="line">      <span class="attr">"fields"</span>: {</span><br><span class="line">        <span class="attr">"keyword"</span>: {</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"keyword"</span>,</span><br><span class="line">          <span class="attr">"ignore_above"</span>: <span class="number">256</span></span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    },</span><br><span class="line">    <span class="attr">"star_num"</span>: {</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"long"</span></span><br><span class="line">    },</span><br><span class="line">    <span class="attr">"user"</span>: {</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"text"</span>,</span><br><span class="line">      <span class="attr">"fields"</span>: {</span><br><span class="line">        <span class="attr">"keyword"</span>: {</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"keyword"</span>,</span><br><span class="line">          <span class="attr">"ignore_above"</span>: <span class="number">256</span></span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="自动创建索引"><a href="#自动创建索引" class="headerlink" title="自动创建索引"></a><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-index_.html#index-creation">自动创建索引</a></h4><p>　默认的，<code>action.auto_create_index</code> 参数为 <code>true</code>，意味着任何索引都可以随着数据写入而被自动创建。反之，如果设置为 <code>false</code> 这不允许任何的索引被自动创建</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">PUT _cluster/settings</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"persistent"</span>: {</span><br><span class="line">    <span class="attr">"action.auto_create_index"</span>: <span class="string">"false"</span></span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>　<code>+*day*,-*</code> 意味着除了满足 <code>*day*</code> 正则表达式的索引，不允许其他任何索引的自动创建</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">PUT _cluster/settings</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"persistent"</span>: {</span><br><span class="line">    <span class="attr">"action.auto_create_index"</span>: <span class="string">"+*day*,-*"</span></span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<div class="note success">可以用于控制只允许按天新建索引</div>



<h4 id="TimeZone"><a href="#TimeZone" class="headerlink" title="TimeZone"></a>TimeZone</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim attack_alarm.json</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"query"</span>: {</span><br><span class="line">    <span class="attr">"bool"</span>: {</span><br><span class="line">      <span class="attr">"must"</span>: [</span><br><span class="line">        {</span><br><span class="line">          <span class="attr">"match"</span>: {</span><br><span class="line">            <span class="attr">"customerId"</span>: {</span><br><span class="line">              <span class="attr">"query"</span>: <span class="string">"69"</span></span><br><span class="line">            }</span><br><span class="line">          }</span><br><span class="line">        },</span><br><span class="line">        {</span><br><span class="line">          <span class="attr">"range"</span>: {</span><br><span class="line">            <span class="attr">"startTime"</span>: {</span><br><span class="line">              <span class="attr">"from"</span>: <span class="string">"2016-09-20 00:00:00,000"</span>,</span><br><span class="line">              <span class="attr">"to"</span>: <span class="string">"2016-09-20 17:47:57,887"</span>,</span><br><span class="line">              <span class="attr">"format"</span>: <span class="string">"yyyy-MM-dd HH:mm:ss,SSS"</span>,</span><br><span class="line">              <span class="attr">"include_lower"</span>: <span class="literal">true</span>,</span><br><span class="line">              <span class="attr">"include_upper"</span>: <span class="literal">false</span></span><br><span class="line">            }</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      ]</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ curl -XPOST -H <span class="string">'Content-Type: application/json'</span> http://localhost:9200/yuzhouwan_201609/attack_alarm/_search -d @attack_alarm.json</span><br></pre></td></tr></tbody></table></figure>
<p>　如果在构建 date 字段相关的查询是，可以直接传入 <code>yyyy-MM-dd HH:mm:ss,SSS</code> 格式的字符串，避免 <code>+08:00</code> 时区带来的困扰。也可以在程序中，将日期中的 local 时区去掉，从而使得日期和 ElasticSearch 本身的默认时区 <code>+00:00</code> 一致，具体写法如下</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">QueryBuilders.rangeQuery(params.get(<span class="string">"timeField"</span>))</span><br><span class="line">    .format(<span class="string">"yyyy-MM-dd HH:mm:ss,SSS"</span>)</span><br><span class="line">    .gte(<span class="string">"2016-09-20 00:00:00,000"</span>)</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Hot-warm"><a href="#Hot-warm" class="headerlink" title="Hot-warm"></a>Hot-warm</h4><p>　ElasticSearch 5.x 引入的新特性，可以通过 <code>node.attr.box_type</code> 参数，将 ElasticSearch 集群中部分高资源的节点配置为 <code>hot</code>，以存放需要频繁访问的数据，再将部分低资源的节点配置为 <code>warm</code>，以存放大量低频访问的数据。随后，在摄入业务数据的时候，可以通过设置 Index 索引的 <code>index.routing.allocation.require.box_type</code> 配置项，来指定数据具体存放在 <code>hot</code> 还是 <code>warm</code> 节点上。默认，可以将 Index 设置为 <code>hot</code>，在满足一定条件后，手动或通过 <a href="https://www.elastic.co/guide/en/elasticsearch/client/curator/current/installation.html">Curator</a> 工具自动将冷数据设置为 <code>warm</code></p>
<div class="note info">可以通过 rollover 查看 Index 中最早写入的一条数据距今已经过去多久、最大的文档数和磁盘空间大小</div>



<h4 id="合并索引"><a href="#合并索引" class="headerlink" title="合并索引"></a><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-reindex.html">合并索引</a></h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">POST _reindex</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"source"</span>: {</span><br><span class="line">    <span class="attr">"index"</span>: <span class="string">"yuzhouwan_by_day_20200101*"</span></span><br><span class="line">  },</span><br><span class="line">  <span class="attr">"dest"</span>: {</span><br><span class="line">    <span class="attr">"index"</span>: <span class="string">"yuzhouwan_by_month_20200101"</span></span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="合并-Segment"><a href="#合并-Segment" class="headerlink" title="合并 Segment"></a><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-forcemerge.html">合并 Segment</a></h4><p>　通过合并 Shard 下的 Segment 数量来解决小文件的问题，具体命令如下：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 指定某一个索引</span></span><br><span class="line">POST /yuzhouwan_by_month_20200101/_forcemerge</span><br><span class="line"><span class="comment"># 指定某一组索引</span></span><br><span class="line">POST /yuzhouwan_by_day_20200101*/_forcemerge</span><br><span class="line"><span class="comment"># 针对所有索引</span></span><br><span class="line">POST /_forcemerge</span><br><span class="line"><span class="comment"># 通过 max_num_segments 参数控制合并后的 Segment 数量</span></span><br><span class="line">POST /_forcemerge?max_num_segments=1</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Shrink"><a href="#Shrink" class="headerlink" title="Shrink"></a>Shrink</h4><h5 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h5><p>　ElasticSearch 5.x 引入的新特性，可以将一个索引中的 Shard 分片进行合并。而且其利用了操作系统的硬链接，使得该操作的完成可以控制在毫秒级。当然，如果操作系统不支持硬链接的话，则仍然需要拷贝 Segment 文件</p>
<h5 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">POST /yuzhouwan_source_index/_shrink/yuzhouwan_target_index</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"settings"</span>: {</span><br><span class="line">    <span class="attr">"index.number_of_replicas"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"index.number_of_shards"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"index.codec"</span>: <span class="string">"best_compression"</span></span><br><span class="line">  },</span><br><span class="line">  <span class="attr">"aliases"</span>: {</span><br><span class="line">    <span class="attr">"my_search_indices"</span>: {}</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Rollup"><a href="#Rollup" class="headerlink" title="Rollup"></a><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/rollup-apis.html">Rollup</a></h4><h5 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h5><p>　ElasticSearch 6.6 引入的新特性，可以通过启动 Rollup 任务的形式，对现有的 Index 索引进行 Rollup，以生成预聚合的新索引</p>
<h5 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h5><h6 id="命令行"><a href="#命令行" class="headerlink" title="命令行"></a>命令行</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">PUT _rollup/job/yuzhouwan</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="comment">// 匹配 Index</span></span><br><span class="line">  <span class="attr">"index_pattern"</span>: <span class="string">"yuzhouwan-*"</span>,</span><br><span class="line">  <span class="comment">// Rollup 后生成的 Index</span></span><br><span class="line">  <span class="attr">"rollup_index"</span>: <span class="string">"yuzhouwan_rollup"</span>,</span><br><span class="line">  <span class="comment">// 执行周期</span></span><br><span class="line">  <span class="attr">"cron"</span>: <span class="string">"*/30 * * * * ?"</span>,</span><br><span class="line">  <span class="comment">// 批处理的大小</span></span><br><span class="line">  <span class="attr">"page_size"</span>: <span class="number">1000</span>,</span><br><span class="line">  <span class="attr">"groups"</span>: {</span><br><span class="line">    <span class="comment">// 基于时间戳字段</span></span><br><span class="line">    <span class="comment">// Rollup 的时间粒度</span></span><br><span class="line">    <span class="comment">// 延迟 7 天后进行 Rollup，避免乱序数据无法被处理</span></span><br><span class="line">    <span class="attr">"date_histogram"</span>: {</span><br><span class="line">      <span class="attr">"field"</span>: <span class="string">"timestamp"</span>,</span><br><span class="line">      <span class="attr">"fixed_interval"</span>: <span class="string">"1h"</span>,</span><br><span class="line">      <span class="attr">"delay"</span>: <span class="string">"7d"</span></span><br><span class="line">    },</span><br><span class="line">    <span class="comment">// 聚合的维度</span></span><br><span class="line">    <span class="attr">"terms"</span>: {</span><br><span class="line">      <span class="attr">"fields"</span>: [</span><br><span class="line">        <span class="string">"node"</span></span><br><span class="line">      ]</span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  <span class="comment">// 聚合的度量，以及具体的聚合操作</span></span><br><span class="line">  <span class="attr">"metrics"</span>: [</span><br><span class="line">    {</span><br><span class="line">      <span class="attr">"field"</span>: <span class="string">"temperature"</span>,</span><br><span class="line">      <span class="attr">"metrics"</span>: [</span><br><span class="line">        <span class="string">"min"</span>,</span><br><span class="line">        <span class="string">"max"</span>,</span><br><span class="line">        <span class="string">"sum"</span></span><br><span class="line">      ]</span><br><span class="line">    },</span><br><span class="line">    {</span><br><span class="line">      <span class="attr">"field"</span>: <span class="string">"voltage"</span>,</span><br><span class="line">      <span class="attr">"metrics"</span>: [</span><br><span class="line">        <span class="string">"avg"</span></span><br><span class="line">      ]</span><br><span class="line">    }</span><br><span class="line">  ]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h6 id="Kibana"><a href="#Kibana" class="headerlink" title="Kibana"></a>Kibana</h6><ul>
<li>测试数据集</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">PUT _template/yuzhouwan_by_hour</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"index_patterns"</span>: [</span><br><span class="line">    <span class="string">"yuzhouwan_by_hour_*"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"settings"</span>: {</span><br><span class="line">    <span class="attr">"index"</span>: {</span><br><span class="line">      <span class="attr">"number_of_shards"</span>: <span class="number">3</span>,</span><br><span class="line">      <span class="attr">"number_of_replicas"</span>: <span class="number">1</span></span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  <span class="attr">"mappings"</span>: {</span><br><span class="line">    <span class="attr">"_source"</span>: {</span><br><span class="line">      <span class="attr">"enabled"</span>: <span class="literal">true</span></span><br><span class="line">    },</span><br><span class="line">    <span class="attr">"properties"</span>: {</span><br><span class="line">      <span class="attr">"user"</span>: {</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">      },</span><br><span class="line">      <span class="attr">"date"</span>: {</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"date"</span></span><br><span class="line">      },</span><br><span class="line">      <span class="attr">"url"</span>: {</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"object"</span></span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">POST yuzhouwan_by_hour_2020020200/_doc/1</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"user"</span>: <span class="string">"asdf2014"</span>,</span><br><span class="line">  <span class="attr">"date"</span>: <span class="string">"2020-02-02T00:00:00Z"</span>,</span><br><span class="line">  <span class="attr">"url"</span>: {</span><br><span class="line">    <span class="attr">"base"</span>: <span class="string">"/"</span>,</span><br><span class="line">    <span class="attr">"param"</span>: {}</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">POST yuzhouwan_by_hour_2020020201/_doc/1</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"user"</span>: <span class="string">"asdf2014"</span>,</span><br><span class="line">  <span class="attr">"date"</span>: <span class="string">"2020-02-02T01:00:00Z"</span>,</span><br><span class="line">  <span class="attr">"url"</span>: {</span><br><span class="line">    <span class="attr">"base"</span>: <span class="string">"/index"</span>,</span><br><span class="line">    <span class="attr">"param"</span>: {}</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>设置 Rollup 任务的名称，选择哪些 Index 被 Rollup，以及指定被 Rollup 后的新 Index 名称</li>
</ul>
<p><img data-src="/picture/es/es_rollup_1.png" alt=""></p>
<ul>
<li>设置执行周期、批处理的大小、延迟多久执行</li>
</ul>
<p><img data-src="/picture/es/es_rollup_2.png" alt=""></p>
<ul>
<li>指定时间维度和 Rollup 的聚合粒度</li>
</ul>
<p><img data-src="/picture/es/es_rollup_3.png" alt=""></p>
<ul>
<li>选择会被聚合查询的字段</li>
</ul>
<p><img data-src="/picture/es/es_rollup_4.png" alt=""></p>
<ul>
<li>选择会被用来作为直方图展示的数值型字段</li>
</ul>
<p><img data-src="/picture/es/es_rollup_5.png" alt=""></p>
<ul>
<li>选择 Rollup 的时候，需要做预聚合计算的字段</li>
</ul>
<p><img data-src="/picture/es/es_rollup_6.png" alt=""></p>
<ul>
<li>最终配置完成</li>
</ul>
<p><img data-src="/picture/es/es_rollup_7.png" alt=""></p>
<ul>
<li>查看 Rollup 任务列表</li>
</ul>
<p><img data-src="/picture/es/es_rollup_8.png" alt=""></p>
<ul>
<li>启停 Rollup 任务</li>
</ul>
<p><img data-src="/picture/es/es_rollup_9.png" alt=""></p>
<ul>
<li>等价于通过命令行配置 Rollup 任务</li>
</ul>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"config"</span>: {</span><br><span class="line">    <span class="attr">"id"</span>: <span class="string">"rollup"</span>,</span><br><span class="line">    <span class="attr">"index_pattern"</span>: <span class="string">"yuzhouwan_by_hour_20200202*"</span>,</span><br><span class="line">    <span class="attr">"rollup_index"</span>: <span class="string">"yuzhouwan_by_day_20200202"</span>,</span><br><span class="line">    <span class="attr">"cron"</span>: <span class="string">"0 0 0 * * ?"</span>,</span><br><span class="line">    <span class="attr">"groups"</span>: {</span><br><span class="line">      <span class="attr">"date_histogram"</span>: {</span><br><span class="line">        <span class="attr">"fixed_interval"</span>: <span class="string">"60m"</span>,</span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"date"</span>,</span><br><span class="line">        <span class="attr">"delay"</span>: <span class="string">"1d"</span>,</span><br><span class="line">        <span class="attr">"time_zone"</span>: <span class="string">"UTC"</span></span><br><span class="line">      },</span><br><span class="line">      <span class="attr">"terms"</span>: {</span><br><span class="line">        <span class="attr">"fields"</span>: [</span><br><span class="line">          <span class="string">"user"</span>,</span><br><span class="line">          <span class="string">"url.base.keyword"</span></span><br><span class="line">        ]</span><br><span class="line">      }</span><br><span class="line">    },</span><br><span class="line">    <span class="attr">"metrics"</span>: [],</span><br><span class="line">    <span class="attr">"timeout"</span>: <span class="string">"20s"</span>,</span><br><span class="line">    <span class="attr">"page_size"</span>: <span class="number">1000</span></span><br><span class="line">  },</span><br><span class="line">  <span class="attr">"status"</span>: {</span><br><span class="line">    <span class="attr">"job_state"</span>: <span class="string">"started"</span>,</span><br><span class="line">    <span class="attr">"upgraded_doc_id"</span>: <span class="literal">true</span></span><br><span class="line">  },</span><br><span class="line">  <span class="attr">"stats"</span>: {</span><br><span class="line">    <span class="attr">"pages_processed"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"documents_processed"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"rollups_indexed"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"trigger_count"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"index_time_in_ms"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"index_total"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"index_failures"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"search_time_in_ms"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"search_total"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"search_failures"</span>: <span class="number">0</span></span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h5 id="局限性"><a href="#局限性" class="headerlink" title="局限性"></a>局限性</h5><p>　截止到 ElasticSearch 7.9.1 版本，也只支持对 Date、Histogram 和 Terms 三种字段类型进行 Rollup 操作，且聚合算子也只有 max、min、sum、avg 和 count <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/rollup-put-job.html">五种</a></p>
<h3 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h3><h4 id="创建模板"><a href="#创建模板" class="headerlink" title="创建模板"></a><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-templates.html">创建模板</a></h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim template_yuzhouwan_day.json</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"index_patterns"</span>: [</span><br><span class="line">    <span class="string">"monitor_log_day_*"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"settings"</span>: {</span><br><span class="line">    <span class="attr">"index"</span>: {</span><br><span class="line">      <span class="attr">"number_of_shards"</span>: <span class="number">3</span>,</span><br><span class="line">      <span class="attr">"number_of_replicas"</span>: <span class="number">1</span></span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  <span class="attr">"mappings"</span>: {</span><br><span class="line">    <span class="attr">"_source"</span>: {</span><br><span class="line">      <span class="attr">"enabled"</span>: <span class="literal">true</span></span><br><span class="line">    },</span><br><span class="line">    <span class="attr">"properties"</span>: {</span><br><span class="line">      <span class="attr">"ip"</span>: {</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">      },</span><br><span class="line">      <span class="attr">"requestLength"</span>: {</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"integer"</span></span><br><span class="line">      },</span><br><span class="line">      <span class="attr">"spendMs"</span>: {</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"long"</span></span><br><span class="line">      },</span><br><span class="line">      <span class="attr">"attributes"</span>: {</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"object"</span></span><br><span class="line">      },</span><br><span class="line">      <span class="attr">"time"</span>: {</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"date"</span>,</span><br><span class="line">        <span class="attr">"format"</span>: <span class="string">"yyyy-MM-dd HH:mm:ss||strict_date_optional_time||epoch_millis"</span></span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ curl -XPUT -H <span class="string">'Content-Type: application/json'</span> localhost:9200/_template/template_yuzhouwan_day -d @template_yuzhouwan_day.json</span><br></pre></td></tr></tbody></table></figure>
<h4 id="获取模板"><a href="#获取模板" class="headerlink" title="获取模板"></a><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-get-template.html">获取模板</a></h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ curl -XGET localhost:9200/_template/template_yuzhouwan_day</span><br></pre></td></tr></tbody></table></figure>
<h4 id="删除模板"><a href="#删除模板" class="headerlink" title="删除模板"></a><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-delete-template.html">删除模板</a></h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ curl -XDELETE localhost:9200/_template/template_yuzhouwan_day</span><br></pre></td></tr></tbody></table></figure>
<h3 id="插件"><a href="#插件" class="headerlink" title="插件"></a><a href="https://www.elastic.co/guide/en/elasticsearch/plugins/current/installation.html">插件</a></h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ bin/elasticsearch-plugin install analysis-icu</span><br><span class="line">  -&gt; Downloading analysis-icu from elastic</span><br><span class="line">  [=================================================] 100%</span><br><span class="line">  -&gt; Installed analysis-icu</span><br></pre></td></tr></tbody></table></figure>
<h3 id="集群状态"><a href="#集群状态" class="headerlink" title="集群状态"></a>集群状态</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ curl -XGET <span class="string">'http://localhost:9200/_nodes/stats/_all'</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="熔断机制"><a href="#熔断机制" class="headerlink" title="熔断机制"></a>熔断机制</h3><p>　ElasticSearch 熔断器在接收到请求后，会评估出可能耗费的内存大小，如果超过了单机所能处理的最大内存限制时，就会拒绝请求，并返回异常。熔断机制通过一个总控熔断器和多个子类熔断器（字段数据加载、聚合请求计算需要的内存、请求本身的大小、加载后未释放的 Lucene Segment，以及内联脚本编译次数），对内存消耗进行控制，避免了 OOM 问题。相关的配置均属于集群层面，所以我们可以通过修改 <code>config/elasticsearch.yml</code> 配置文件或者调用 <code>PUT /_cluster/settings</code> 接口中进行设置</p>
<h3 id="基于磁盘容量的负载均衡"><a href="#基于磁盘容量的负载均衡" class="headerlink" title="基于磁盘容量的负载均衡"></a><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/disk-allocator.html">基于磁盘容量的负载均衡</a></h3><p>　ElasticSearch 在决定是向某一个节点分配新的 Shard，还是主动从该节点重新分配 Shard 之前，会先考虑节点上的可用磁盘空间。该特性通过 <code>cluster.routing.allocation.disk.threshold_enabled</code> 参数进行控制，默认是开启的。相关行为主要通过三个阀值进行控制：当磁盘使用率达到 <code>85%</code> 的时候，就不再往该节点分配新的 Shard；当磁盘使用率达到 <code>90%</code> 的时候，将触发负载均衡，将 Shard 重定向到其他空闲节点上；而当磁盘使用率达到 <code>95%</code> 的时候，将会给所有的索引加上 read-only 的锁。此时，数据将无法写入，需要显示地将 <code>index.blocks.read_only_allow_delete</code> 参数设置为 <code>false</code> 才可以解除只读锁。具体的操作方法，详见下文 “踩过的坑 - blocked by: [FORBIDDEN/12/index read-only / allow delete (api)]”</p>
<h2 id="整合其他框架"><a href="#整合其他框架" class="headerlink" title="整合其他框架"></a>整合其他框架</h2><h3 id="ElasticSearch-Kafka-整合"><a href="#ElasticSearch-Kafka-整合" class="headerlink" title="ElasticSearch + Kafka 整合"></a>ElasticSearch + Kafka 整合</h3><p>　详见：我的另一篇博客《<a href="https://yuzhouwan.com/posts/26002/#Kafka-2-ElasticSearch">Apache Kafka 分布式消息队列框架</a>》</p>
<h3 id="ElasticSearch-Flume-整合"><a href="#ElasticSearch-Flume-整合" class="headerlink" title="ElasticSearch + Flume 整合"></a>ElasticSearch + Flume 整合</h3><p>　详见：Flume <a href="https://flume.apache.org/FlumeUserGuide.html#elasticsearchsink">官网文档</a></p>
<h3 id="ElasticSearch-IK-中文分词"><a href="#ElasticSearch-IK-中文分词" class="headerlink" title="ElasticSearch + IK 中文分词"></a>ElasticSearch + IK 中文分词</h3><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><p>　详见：IK <a href="https://github.com/medcl/elasticsearch-analysis-ik">官网文档</a></p>
<h4 id="中文分词器比对表"><a href="#中文分词器比对表" class="headerlink" title="中文分词器比对表"></a>中文分词器比对表</h4><div class="table-container">
<table>
<thead>
<tr>
<th>分词器</th>
<th>分词粒度</th>
<th>出错情况</th>
<th>支持处理字符</th>
<th>新词识别</th>
<th>词性标注</th>
<th>认证方法</th>
<th>接口</th>
</tr>
</thead>
<tbody>
<tr>
<td>BosonNLP</td>
<td>多选择</td>
<td>无</td>
<td>识别繁体字</td>
<td>有</td>
<td>有</td>
<td>Token</td>
<td>RESTful</td>
</tr>
<tr>
<td>IKAnalyzer</td>
<td>多选择</td>
<td>无</td>
<td>兼容韩文日文</td>
<td>有</td>
<td>无</td>
<td>无</td>
<td>Jar</td>
</tr>
<tr>
<td>NLPIR</td>
<td>多选择</td>
<td>中文间隔符</td>
<td>未知</td>
<td>有</td>
<td>有</td>
<td>无</td>
<td>多语言接口</td>
</tr>
<tr>
<td>SCWS</td>
<td>多选择</td>
<td>无</td>
<td>未知</td>
<td>有</td>
<td>有</td>
<td>无</td>
<td>PHP、Cli</td>
</tr>
<tr>
<td>结巴分词</td>
<td>多选择</td>
<td>无</td>
<td>识别繁体字</td>
<td>有</td>
<td>有</td>
<td>无</td>
<td>Python</td>
</tr>
<tr>
<td>盘古分词</td>
<td>多选择</td>
<td>无</td>
<td>识别繁体字</td>
<td>有</td>
<td>无</td>
<td>无</td>
<td>无</td>
</tr>
<tr>
<td>庖丁解牛</td>
<td>多选择</td>
<td>无</td>
<td>是</td>
<td>有</td>
<td>无</td>
<td>无</td>
<td>Jar</td>
</tr>
<tr>
<td>搜狗分词</td>
<td>小</td>
<td>字符长度过大</td>
<td>识别繁体字</td>
<td>未知</td>
<td>有</td>
<td>无</td>
<td>上传文档</td>
</tr>
<tr>
<td>腾讯文智</td>
<td>小</td>
<td>空白字符</td>
<td>未知</td>
<td>有</td>
<td>中文词性</td>
<td>Signature</td>
<td>RESTful</td>
</tr>
<tr>
<td>新浪云</td>
<td>大</td>
<td>无</td>
<td>未知</td>
<td>有</td>
<td>有</td>
<td>创建仓库</td>
<td>RESTful</td>
</tr>
<tr>
<td>语言云</td>
<td>适中</td>
<td>无</td>
<td>识别繁体字</td>
<td>有</td>
<td>有</td>
<td>Token</td>
<td>RESTful</td>
</tr>
</tbody>
</table>
</div>
<h2 id="技术内幕"><a href="#技术内幕" class="headerlink" title="技术内幕"></a>技术内幕</h2><h3 id="ElasticSearch-和-Lucene-的本质是什么，为什么会选型-ElasticSearch？"><a href="#ElasticSearch-和-Lucene-的本质是什么，为什么会选型-ElasticSearch？" class="headerlink" title="ElasticSearch 和 Lucene 的本质是什么，为什么会选型 ElasticSearch？"></a>ElasticSearch 和 Lucene 的本质是什么，为什么会选型 ElasticSearch？</h3><h4 id="本质"><a href="#本质" class="headerlink" title="本质"></a>本质</h4><p>　Lucene 是基于 Java 的全文检索库，而 ElasticSearch 是一款功能丰富的分布式搜索引擎</p>
<h4 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h4><h5 id="Lucene"><a href="#Lucene" class="headerlink" title="Lucene"></a>Lucene</h5><p>　需要为分布式、高可用性和实时写入（索引建立 -&gt; 可检索）等特性，进行额外的编码工作</p>
<h5 id="ElasticSearch"><a href="#ElasticSearch" class="headerlink" title="ElasticSearch"></a>ElasticSearch</h5><p>　具备分布式、实时分发、实时搜索、易用性（Multi-tenancy 多租户 / Gateway 备份）、高可用性（各节点组成对等的网络结构，方便故障转移）等特性</p>
<h4 id="进一步思考"><a href="#进一步思考" class="headerlink" title="进一步思考"></a>进一步思考</h4><h5 id="Solr、Lucene-作为全文检索系统，和-ElasticSearch-这种搜索引擎又有什么本质的区别？"><a href="#Solr、Lucene-作为全文检索系统，和-ElasticSearch-这种搜索引擎又有什么本质的区别？" class="headerlink" title="Solr、Lucene 作为全文检索系统，和 ElasticSearch 这种搜索引擎又有什么本质的区别？"></a>Solr、Lucene 作为全文检索系统，和 ElasticSearch 这种搜索引擎又有什么本质的区别？</h5><p>　<strong>搜索引擎</strong>，包含网页数据的快速采集、海量数据的索引和存储、搜索结果的相关性排序、搜索效率的毫秒级要求、分布式处理和负载均衡、自然语言的理解技术 等等</p>
<p>　<strong>全文检索</strong>，即文本全文检索，包括信息的存储、组织、表现、查询、存取等各个方面，其核心为文本信息的索引和检索</p>
<h3 id="为什么-ElasticSearch-集群使用-Hash-路由，而不是-Paxos，这两个算法有什么区别，各自最适的应用场景在哪里？"><a href="#为什么-ElasticSearch-集群使用-Hash-路由，而不是-Paxos，这两个算法有什么区别，各自最适的应用场景在哪里？" class="headerlink" title="为什么 ElasticSearch 集群使用 Hash 路由，而不是 Paxos，这两个算法有什么区别，各自最适的应用场景在哪里？"></a>为什么 ElasticSearch 集群使用 Hash 路由，而不是 Paxos，这两个算法有什么区别，各自最适的应用场景在哪里？</h3><p>　Hash 路由，主要用于解决数据均衡分布的问题。而 Paxos 主要用于保证分布式数据副本的一致性</p>
<p>　ElasticSearch 中的 Hash Router 会对每次请求的 <code>_id</code> 属性（即 Document ID，默认的 ElasticSearch 会自动为每一个 Document 分配一个长度为 20 的 UUID 字符串，也可以指定其他的字段）进行 Hash 操作，再对 Shard 数量进行取模</p>
<p>　实际上，二者根本不是一个层面上的概念，更应该拿 ElasticSearch 的 Gossip + Bully 选举机制来和 Paxos 进行比较。下文会有对 Gossip + Bully 选主算法的详细说明，这里就多介绍了</p>
<p>（更多相关内容详见，我的另外两篇博客《<a href="https://yuzhouwan.com/posts/54206/">大数据生态圈的一致性算法</a>》和《<a href="https://yuzhouwan.com/posts/31915/">ZooKeeper 原理与优化</a>》）</p>
<h3 id="ElasticSearch-倒排索引的原理"><a href="#ElasticSearch-倒排索引的原理" class="headerlink" title="ElasticSearch 倒排索引的原理"></a>ElasticSearch 倒排索引的原理</h3><h4 id="图解"><a href="#图解" class="headerlink" title="图解"></a>图解</h4><p>　已经有太多的书和博客来介绍，这里就不班门弄斧了，就简单画个图来帮助理解“倒排索引”的流程吧</p>
<p><img data-src="/picture/es/es_reverted_index.png" alt="Elasticsearch Reverted Index"></p>
<center>（利用 <a href="https://products.office.com/en-us/visio/visio-online" target="_blank">Visio</a>™ 绘制而成）</center>



<h3 id="Lucene-4-实现的-DocValues-特性，为什么可以加速聚合运算？"><a href="#Lucene-4-实现的-DocValues-特性，为什么可以加速聚合运算？" class="headerlink" title="Lucene 4 实现的 DocValues 特性，为什么可以加速聚合运算？"></a>Lucene 4 实现的 DocValues 特性，为什么可以加速聚合运算？</h3><h4 id="DocValues-是什么？"><a href="#DocValues-是什么？" class="headerlink" title="DocValues 是什么？"></a>DocValues 是什么？</h4><p>　Lucene 在构建倒排索引时，额外建立的一个有序的、基于 Document -&gt; Field Value 的映射列表</p>
<h4 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h4><ul>
<li>对字段进行排序或聚合</li>
<li>某些过滤，比如地理位置过滤</li>
<li>某些与字段相关的脚本计算</li>
</ul>
<h4 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h4><p>　可以通过 <code>doc_values</code> 字段控制 DocValues 特性是否开启。默认地，会对除了 <code>analyzed strings</code> 之外的所有字段启用（即数字、地理坐标、日期、IP 和  <code>not_analyzed</code> 字符类型）</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">PUT yuzhouwan_index</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"mappings"</span>: {</span><br><span class="line">    <span class="attr">"yuzhouwan_type"</span>: {</span><br><span class="line">      <span class="attr">"properties"</span>: {</span><br><span class="line">        <span class="attr">"blog"</span>: {</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"string"</span>,</span><br><span class="line">          <span class="attr">"index"</span>: <span class="string">"not_analyzed"</span>,</span><br><span class="line">          <span class="attr">"doc_values"</span>: <span class="literal">true</span></span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><p>　倒排索引建立的是 KeyWord -&gt; Document 的映射关系，以便在文本检索时，通过类似 Hash 算法，来快速定位到 KeyWord，再从索引中获取到包含该 KeyWord 的 Document ID 集合。虽然，该方法保证了高效的检索，但在对数据做聚合运算时，却需要将所有出现了 KeyWord 的 Document 加载到内存中，很容易导致进程的内存溢出问题</p>
<p>　针对该问题，DocValues 便应运而生了。其会对开启了该特性的字段，额外构建一个 Document -&gt; Field Value 的正排索引。此时，聚合操作的流程就变成了，先找到 KeyWord 的 Document，再从 DocValues 中加载 Document 对应的 Filed Value 到内存中进行运算即可。同时，如果 Field Value 占用的内存远小于节点的可用内存，则会自动常驻在内存中，进而保证了性能；反之，则会序列化到磁盘中，避免出现 OOM 问题。另外，因为其列式存储的特性，使得压缩效率也很高</p>
<h4 id="进一步思考-1"><a href="#进一步思考-1" class="headerlink" title="进一步思考"></a>进一步思考</h4><h5 id="设置-stored-”true”-属性同样会构建正排索引，它和-DocValues-又有何不同？"><a href="#设置-stored-”true”-属性同样会构建正排索引，它和-DocValues-又有何不同？" class="headerlink" title="设置 stored=”true” 属性同样会构建正排索引，它和 DocValues 又有何不同？"></a>设置 stored=”true” 属性同样会构建正排索引，它和 DocValues 又有何不同？</h5><p>　主要区别在于，<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-store.html">前者</a>是行式存储，而<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/doc-values.html">后者</a>是列式存储；且前者直接存储字段原始值，而后者会进行分词</p>
<h3 id="ElasticSearch-5-0-内核迁移为-Lucene-6-x，是如何利用-Block-K-d-Tree-来解决-深度分页-问题？"><a href="#ElasticSearch-5-0-内核迁移为-Lucene-6-x，是如何利用-Block-K-d-Tree-来解决-深度分页-问题？" class="headerlink" title="ElasticSearch 5.0 内核迁移为 Lucene 6.x，是如何利用 Block K-d Tree 来解决 深度分页 问题？"></a>ElasticSearch 5.0 内核迁移为 Lucene 6.x，是如何利用 Block K-d Tree 来解决 深度分页 问题？</h3><h4 id="ElasticSearch-2-x-现状"><a href="#ElasticSearch-2-x-现状" class="headerlink" title="ElasticSearch 2.x 现状"></a>ElasticSearch 2.x 现状</h4><p>　使用 form + size 或者 scroll 的方式效率很低</p>
<h4 id="算法简介"><a href="#算法简介" class="headerlink" title="算法简介"></a>算法简介</h4><p>　K-d Tree，利用 <strong>方差 + 中位数</strong> 分割数据入 <strong>二叉树</strong>，再利用 <strong>二叉查找 + 递归溯源</strong> 的方式来查找数据。而 Block K-d Tree 则是一组 K-d Tree，解决了多维空间数据搜索，较高的空间利用率，高性能的查询和更新。使得 ElasticSearch 处理数值型数据和高维数据的性能提高了约 30%，同时存储空间大小节约了约 60%</p>
<h4 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h4><p>　在搜索过程中，N 个节点、K 维 的 K-d Tree 最坏的时间复杂度为：$T_{worst} = O(K*N^{1-\frac{1}{K}})$，所以其无法很好地处理高维数据；</p>
<p>　而 Block K-d Tree 虽然在插入性能方面比 K-d Tree 提升了几个数量级，但是如果系统使用的是非 SSD 硬盘，则可能会出现严重的毛刺现象</p>
<h2 id="源码阅读"><a href="#源码阅读" class="headerlink" title="源码阅读"></a>源码阅读</h2><div class="note success">源码分析是基于 ElasticSearch 7.9.1 和 Lucene 8.6.2 版本进行的</div>

<h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a><a href="https://yuzhouwan.com/posts/190816/">环境搭建</a></h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Lucene</span></span><br><span class="line">$ ant ivy-bootstrap</span><br><span class="line">$ ant idea</span><br><span class="line"></span><br><span class="line"><span class="comment"># ElasticSearch</span></span><br><span class="line">$ ./gradlew clean</span><br><span class="line">$ ./gradlew idea</span><br></pre></td></tr></tbody></table></figure>
<div class="note info">如果遇到未完全下载等问题，可以通过执行 rm -rf ~/.ivy2/cache 清理缓存的命令来解决</div>



<h3 id="Lucene-1"><a href="#Lucene-1" class="headerlink" title="Lucene"></a>Lucene</h3><h4 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h4><h5 id="索引（Index）"><a href="#索引（Index）" class="headerlink" title="索引（Index）"></a>索引（Index）</h5><p>　在 Lucene 中一个索引是放在一个文件夹中的，同一文件夹中的所有的文件构成一个 Lucene 索引</p>
<h5 id="段（Segment）"><a href="#段（Segment）" class="headerlink" title="段（Segment）"></a>段（Segment）</h5><p>　一个索引可以包含多个段，段与段之间是独立的，添加新文档可以生成新的段，不同的段可以进行合并。从文件名来看，<code>_0</code>、<code>_1</code> 或者 <code>_N</code> 开头的一组文件用于表示属于某一个段，<code>segments.gen</code> 和 <code>segments_N</code> 文件则保存了 Segment 相关的元数据信息</p>
<h5 id="文档（Document）"><a href="#文档（Document）" class="headerlink" title="文档（Document）"></a>文档（Document）</h5><p>　文档是创建索引的基本单位，不同的文档会保存在不同的段中，即一个段可以包含多个文档。新写入的文档会单独保存在一个新生成的段中，在随后的段合并操作中，不同的文档才合并到同一个 Segment 中</p>
<h5 id="域（Field）"><a href="#域（Field）" class="headerlink" title="域（Field）"></a>域（Field）</h5><p>　一个文档包含不同类型的信息，分别存在不同的域中，也就是文档的字段</p>
<h5 id="词典（Term-Directory）"><a href="#词典（Term-Directory）" class="headerlink" title="词典（Term Directory）"></a>词典（Term Directory）</h5><p>　字段内容经过分词、归一化、还原词根等处理之后，得到的所有单词的集合</p>
<h5 id="词（Term）"><a href="#词（Term）" class="headerlink" title="词（Term）"></a>词（Term）</h5><p>　词是索引的最小单位，本质上是词法分析和语言处理后的一个字符串</p>
<div class="note info">包含关系（一对多）依次是：Index &gt; Segment &gt; Document &gt; Field &gt; Term Directory &gt; Term</div>



<h4 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h4><h5 id="下载-Lucene"><a href="#下载-Lucene" class="headerlink" title="下载 Lucene"></a><a href="https://lucene.apache.org/core/downloads.html">下载 Lucene</a></h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ wget http://mirrors.tuna.tsinghua.edu.cn/apache/lucene/java/8.6.2/lucene-8.6.2.tgz</span><br><span class="line">$ tar zxvf lucene-8.6.2.tgz</span><br><span class="line">$ ln -s lucene-8.6.2 lucene</span><br><span class="line">$ <span class="built_in">cd</span> lucene</span><br></pre></td></tr></tbody></table></figure>
<h5 id="构造需要被索引的数据"><a href="#构造需要被索引的数据" class="headerlink" title="构造需要被索引的数据"></a>构造需要被索引的数据</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim blog.txt</span><br><span class="line">  google.com</span><br><span class="line">  yuzhouwan.com</span><br></pre></td></tr></tbody></table></figure>
<h5 id="创建索引文件"><a href="#创建索引文件" class="headerlink" title="创建索引文件"></a>创建索引文件</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ java -classpath <span class="string">'demo/lucene-demo-8.6.2.jar:core/lucene-core-8.6.2.jar'</span> org.apache.lucene.demo.IndexFiles -docs blog.txt</span><br><span class="line">  Indexing to directory <span class="string">'index'</span>...</span><br><span class="line">  adding blog.txt</span><br><span class="line">  368 total milliseconds</span><br></pre></td></tr></tbody></table></figure>
<h5 id="检索文件"><a href="#检索文件" class="headerlink" title="检索文件"></a>检索文件</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ java -classpath <span class="string">'demo/lucene-demo-8.6.2.jar:core/lucene-core-8.6.2.jar:queryparser/lucene-queryparser-8.6.2.jar'</span> org.apache.lucene.demo.SearchFiles</span><br><span class="line">  Enter query:</span><br><span class="line">  blog</span><br><span class="line">  Searching <span class="keyword">for</span>: blog</span><br><span class="line">  0 total matching documents</span><br><span class="line"></span><br><span class="line">  Enter query:</span><br><span class="line">  yuzhouwan</span><br><span class="line">  Searching <span class="keyword">for</span>: yuzhouwan</span><br><span class="line">  0 total matching documents</span><br><span class="line"></span><br><span class="line">  Enter query:</span><br><span class="line">  yuzhouwan.com</span><br><span class="line">  Searching <span class="keyword">for</span>: yuzhouwan.com</span><br><span class="line">  1 total matching documents</span><br><span class="line">  1. blog.txt</span><br></pre></td></tr></tbody></table></figure>
<h5 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ tree -L 2 index</span><br><span class="line">  index</span><br><span class="line">  ├── _0.cfe</span><br><span class="line">  ├── _0.cfs</span><br><span class="line">  ├── _0.si</span><br><span class="line">  ├── segments_1</span><br><span class="line">  └── write.lock</span><br></pre></td></tr></tbody></table></figure>
<h4 id="编程"><a href="#编程" class="headerlink" title="编程"></a>编程</h4><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// index</span></span><br><span class="line"><span class="keyword">try</span> (Directory index = <span class="keyword">new</span> NIOFSDirectory(Paths.get(<span class="string">"/tmp/index"</span>))) {</span><br><span class="line">    <span class="comment">// add</span></span><br><span class="line">    <span class="keyword">try</span> (IndexWriter writer = <span class="keyword">new</span> IndexWriter(index, <span class="keyword">new</span> IndexWriterConfig(<span class="keyword">new</span> StandardAnalyzer()))) {</span><br><span class="line">        Document doc = <span class="keyword">new</span> Document();</span><br><span class="line">        doc.add(<span class="keyword">new</span> TextField(<span class="string">"blog"</span>, <span class="string">"yuzhouwan.com"</span>, Field.Store.YES));</span><br><span class="line">        doc.add(<span class="keyword">new</span> StringField(<span class="string">"github"</span>, <span class="string">"asdf2014"</span>, Field.Store.YES));</span><br><span class="line">        writer.addDocument(doc);</span><br><span class="line">        writer.commit();</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// search</span></span><br><span class="line">    <span class="keyword">try</span> (DirectoryReader reader = DirectoryReader.open(index)) {</span><br><span class="line">        IndexSearcher searcher = <span class="keyword">new</span> IndexSearcher(reader);</span><br><span class="line">        QueryParser parser = <span class="keyword">new</span> QueryParser(<span class="string">"blog"</span>, <span class="keyword">new</span> StandardAnalyzer());</span><br><span class="line">        Query query = parser.parse(<span class="string">"yuzhouwan.com"</span>);</span><br><span class="line">        ScoreDoc[] hits = searcher.search(query, <span class="number">1000</span>).scoreDocs;</span><br><span class="line">        <span class="keyword">for</span> (ScoreDoc hit : hits) {</span><br><span class="line">            Document hitDoc = searcher.doc(hit.doc);</span><br><span class="line">            System.out.println(hitDoc.get(<span class="string">"blog"</span>));</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>Tips: Full code is <a href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-bigdata/yuzhouwan-bigdata-lucene/src/main/java/com/yuzhouwan/bigdata/lucene/LuceneExample.java">here</a>.</p>
<h4 id="文件格式"><a href="#文件格式" class="headerlink" title="文件格式"></a>文件格式</h4><h5 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h5><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">名称</th>
<th style="text-align:center">文件后缀</th>
<th style="text-align:center">简要描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><a href="https://lucene.apache.org/core/8_6_2/core/org/apache/lucene/index/SegmentInfos.html"><code>Segments File</code></a></td>
<td style="text-align:center">segments_N</td>
<td style="text-align:center">Stores information about a commit point</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://lucene.apache.org/core/8_6_2/core/org/apache/lucene/codecs/lucene84/package-summary.html#Lock_File"><code>Lock File</code></a></td>
<td style="text-align:center">write.lock</td>
<td style="text-align:center">The Write lock prevents multiple IndexWriters from writing to the same file.</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://lucene.apache.org/core/8_6_2/core/org/apache/lucene/codecs/lucene86/Lucene86SegmentInfoFormat.html"><code>Segment Info</code></a></td>
<td style="text-align:center">.si</td>
<td style="text-align:center">Stores metadata about a segment</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://lucene.apache.org/core/8_6_2/core/org/apache/lucene/codecs/lucene50/Lucene50CompoundFormat.html"><code>Compound File</code></a></td>
<td style="text-align:center">.cfs、.cfe</td>
<td style="text-align:center">An optional “virtual” file consisting of all the other index files for systems that frequently run out of file handles.</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://lucene.apache.org/core/8_6_2/core/org/apache/lucene/codecs/lucene50/Lucene50FieldInfosFormat.html"><code>Fields</code></a></td>
<td style="text-align:center">.fnm</td>
<td style="text-align:center">Stores information about the fields</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://lucene.apache.org/core/8_6_2/core/org/apache/lucene/codecs/lucene50/Lucene50StoredFieldsFormat.html"><code>Field Index</code></a></td>
<td style="text-align:center">.fdx</td>
<td style="text-align:center">Contains pointers to field data</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://lucene.apache.org/core/8_6_2/core/org/apache/lucene/codecs/lucene50/Lucene50StoredFieldsFormat.html"><code>Field Data</code></a></td>
<td style="text-align:center">.fdt</td>
<td style="text-align:center">The stored fields for documents</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://lucene.apache.org/core/8_6_2/core/org/apache/lucene/codecs/lucene84/Lucene84PostingsFormat.html"><code>Term Dictionary</code></a></td>
<td style="text-align:center">.tim</td>
<td style="text-align:center">The term dictionary, stores term info</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://lucene.apache.org/core/8_6_2/core/org/apache/lucene/codecs/lucene84/Lucene84PostingsFormat.html"><code>Term Index</code></a></td>
<td style="text-align:center">.tip</td>
<td style="text-align:center">The index into the Term Dictionary</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://lucene.apache.org/core/8_6_2/core/org/apache/lucene/codecs/lucene84/Lucene84PostingsFormat.html"><code>Frequencies</code></a></td>
<td style="text-align:center">.doc</td>
<td style="text-align:center">Contains the list of docs which contain each term along with frequency</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://lucene.apache.org/core/8_6_2/core/org/apache/lucene/codecs/lucene84/Lucene84PostingsFormat.html"><code>Positions</code></a></td>
<td style="text-align:center">.pos</td>
<td style="text-align:center">Stores position information about where a term occurs in the index</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://lucene.apache.org/core/8_6_2/core/org/apache/lucene/codecs/lucene84/Lucene84PostingsFormat.html"><code>Payloads</code></a></td>
<td style="text-align:center">.pay</td>
<td style="text-align:center">Stores additional per-position metadata information such as character offsets and user payloads</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://lucene.apache.org/core/8_6_2/core/org/apache/lucene/codecs/lucene80/Lucene80NormsFormat.html"><code>Norms</code></a></td>
<td style="text-align:center">.nvd、.nvm</td>
<td style="text-align:center">Encodes length and boost factors for docs and fields</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://lucene.apache.org/core/8_6_2/core/org/apache/lucene/codecs/lucene80/Lucene80DocValuesFormat.html"><code>Per-Document Values</code></a></td>
<td style="text-align:center">.dvd、.dvm</td>
<td style="text-align:center">Encodes additional scoring factors or other per-document information.</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://lucene.apache.org/core/8_6_2/core/org/apache/lucene/codecs/lucene50/Lucene50TermVectorsFormat.html"><code>Term Vector Index</code></a></td>
<td style="text-align:center">.tvx</td>
<td style="text-align:center">Stores offset into the document data file</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://lucene.apache.org/core/8_6_2/core/org/apache/lucene/codecs/lucene50/Lucene50TermVectorsFormat.html"><code>Term Vector Data</code></a></td>
<td style="text-align:center">.tvd</td>
<td style="text-align:center">Contains term vector data.</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://lucene.apache.org/core/8_6_2/core/org/apache/lucene/codecs/lucene50/Lucene50LiveDocsFormat.html"><code>Live Documents</code></a></td>
<td style="text-align:center">.liv</td>
<td style="text-align:center">Info about what documents are live</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://lucene.apache.org/core/8_6_2/core/org/apache/lucene/codecs/lucene86/Lucene86PointsFormat.html"><code>Point values</code></a></td>
<td style="text-align:center">.dii、.dim</td>
<td style="text-align:center">Holds indexed points, if any</td>
</tr>
</tbody>
</table>
</div>
<center>（表格来源：<a href="https://lucene.apache.org/core/8_6_2/core/org/apache/lucene/codecs/lucene86/package-summary.html" target="_blank">lucene.apache.org</a> 官方文档）</center>

<h5 id="正排索引"><a href="#正排索引" class="headerlink" title="正排索引"></a>正排索引</h5><ul>
<li><code>segments_N</code> 保存了此 Index 包含多少个 Segment，每个 Segment 包含多少 Document</li>
<li><code>.fnm</code> 保存了此 Segment 包含了多少个 Field，每个 Field 的名称及索引方式</li>
<li><code>.fdx</code> 和 <code>.fdt</code> 保存了此 Segment 包含的所有 Document，各个 Document 包含了哪些 Field，以及每个 Field 保存了哪些信息</li>
<li><code>.tvx</code> 和 <code>.tvd</code> 保存了此 Segment 包含多少 Document，各个 Document 包含了多少 Field，每个 Field 包含了多少 Term，每个 Term 字符串的位置信息等</li>
</ul>
<h5 id="倒排索引"><a href="#倒排索引" class="headerlink" title="倒排索引"></a>倒排索引</h5><ul>
<li><p><code>.tim</code> 保存了 Term Directory，并以字典序保存 Term，方便进行高效的二分查找（ $O(\log_2^n)$） </p>
</li>
<li><p><code>.tip</code> 保存了 Term 到 Term Directory 的倒排索引。这里使用的数据结构是 FST（<strong>F</strong>inite <strong>S</strong>tate <strong>T</strong>ransducers，有限状态传感器），构建了一个 Term 的前缀树，不仅压缩了存储空间，还提高了查询速度（ $O(len(str))$） </p>
<p><img data-src="/picture/lucene/lucene_term_directory_inverted_index.png" alt="Term to Term Directory Inverted Index"></p>
<center>（图片来源：easynosql.com™，该网站已故障，侵删谢谢）</center>
</li>
<li><p><code>.doc</code> 保存了倒排表（即每个 Term 到 Document ID 的列表），同时也保存了 Document 中 Term 出现的频率</p>
</li>
</ul>
<h5 id="全文检索"><a href="#全文检索" class="headerlink" title="全文检索"></a>全文检索</h5><ul>
<li><code>.pos</code> 保存了倒排表中每个 Term，以及在 Document 中的位置</li>
<li><code>.nvd</code> 和 <code>.nvm</code> 保存 Field 得分信息</li>
</ul>
<h5 id="列式存储"><a href="#列式存储" class="headerlink" title="列式存储"></a>列式存储</h5><ul>
<li><code>.dvd</code> 和 <code>.dvm</code> 保存 DocValues 信息，用以加速聚合排序等查询</li>
</ul>
<div class="note info">其中，`.fdx`、`.tip` 和 `.dvm` 文件会被加载于内存中，以确保集群的高效运作；如果 `.liv` 文件不存在，则表示没有需要被删除的 Document</div>






<h4 id="Document-模块"><a href="#Document-模块" class="headerlink" title="Document 模块"></a>Document 模块</h4><h5 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h5><p>　定义 Document 和各种相关的数据类型</p>
<h5 id="主体"><a href="#主体" class="headerlink" title="主体"></a>主体</h5><ul>
<li><p>org.apache.lucene.document.<strong>Document</strong></p>
<p>由 Field 组成的文档记录的</p>
</li>
<li><p>org.apache.lucene.document.<strong>Field</strong></p>
<p>Document 中的一个字段</p>
</li>
</ul>
<h4 id="Codecs-模块"><a href="#Codecs-模块" class="headerlink" title="Codecs 模块"></a>Codecs 模块</h4><h5 id="功能-1"><a href="#功能-1" class="headerlink" title="功能"></a>功能</h5><p>　基础数据结构和编码压缩算法的实现，包括 skipList，docValue 等</p>
<h4 id="Analysis-模块"><a href="#Analysis-模块" class="headerlink" title="Analysis 模块"></a>Analysis 模块</h4><h5 id="功能-2"><a href="#功能-2" class="headerlink" title="功能"></a>功能</h5><p>　词法分析，并输出索引的最小单位 Term</p>
<h5 id="主体-1"><a href="#主体-1" class="headerlink" title="主体"></a>主体</h5><ul>
<li><p>org.apache.lucene.analysis.<strong>Analyzer</strong></p>
<p>分析器会对内容进行过滤，分词，转换等，把过滤之后的数据交给 IndexWriter 进行索引</p>
</li>
</ul>
<h4 id="Index-模块"><a href="#Index-模块" class="headerlink" title="Index 模块"></a>Index 模块</h4><h5 id="功能-3"><a href="#功能-3" class="headerlink" title="功能"></a>功能</h5><p>　创建索引</p>
<h5 id="主体-2"><a href="#主体-2" class="headerlink" title="主体"></a>主体</h5><ul>
<li><p>org.apache.lucene.index.<strong>IndexWriter</strong></p>
<p>索引写操作的核心类</p>
<ul>
<li><p>addDocument</p>
<p>将 Document 添加到索引中</p>
</li>
<li><p>updateDocument</p>
<p>更新 Document，等同于 delete by term + add document 两个操作的组合，并确保了其原子性</p>
</li>
<li><p>deleteDocument</p>
<p>删除 Document，支持 delete by term 和 delete by query</p>
</li>
<li><p>prepareCommit</p>
<p>二阶段提交的第一步</p>
</li>
<li><p>commit</p>
<p>二阶段提交的第二步，成功之后会生成一个 segment_N 文件新的 N 值，也只有 commit 成功之后，数据才可以被检索到</p>
</li>
<li><p>rollback</p>
<p>prepareCommit 或者 commit 任何一个操作失败之后，都会回滚到提交前的状态</p>
</li>
<li><p>maybeMerge</p>
<p>触发一次 MergePolicy 的执行，不满足条件的情况下，并不会执行 merge 操作</p>
</li>
<li><p>forceMerge</p>
<p>强制触发一次 merge 操作</p>
</li>
</ul>
</li>
<li><p>org.apache.lucene.index.<strong>SegmentInfos</strong></p>
<ul>
<li><p>getLastCommitGeneration(org.apache.lucene.store.Directory)</p>
<p>获取索引目录下最近一次的 commit 号，以定位最大的 segment_N 文件</p>
</li>
</ul>
</li>
<li><p>org.apache.lucene.index.<strong>Term</strong></p>
<p>Term 是文本检索的基本单元，一个 Term 由 KeyValue 组成，Key 为需要检索的字段名称，Value 为字段的值</p>
</li>
</ul>
<h5 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h5><ul>
<li><p>wait_for_active_shards</p>
<p>集群中至少有多少存活的 Shard 才执行写入操作，可以设置为 <code>all</code> 表示需要主 Shard 和所有的副 Shard 均存活才执行写操作，默认值：<code>1</code>（即只需要主 Shard 存活即可写入）</p>
</li>
</ul>
<h4 id="Store-模块"><a href="#Store-模块" class="headerlink" title="Store 模块"></a>Store 模块</h4><h5 id="功能-4"><a href="#功能-4" class="headerlink" title="功能"></a>功能</h5><p>　读写索引</p>
<h5 id="主体-3"><a href="#主体-3" class="headerlink" title="主体"></a>主体</h5><ul>
<li><p>org.apache.lucene.store.<strong>Directory</strong></p>
<p>IndexWriter 通过获取 Directory 的一个具体实现，在 Directory 指向的位置中操作索引</p>
<ul>
<li><p>FSDirectory</p>
<p>表示一个存储在文件系统中的索引的位置</p>
</li>
<li><p>ByteBuffersDirectory</p>
<p>表示一个存储在内存当中的索引的位置</p>
</li>
</ul>
</li>
</ul>
<h4 id="Parser-模块"><a href="#Parser-模块" class="headerlink" title="Parser 模块"></a>Parser 模块</h4><h5 id="功能-5"><a href="#功能-5" class="headerlink" title="功能"></a>功能</h5><p>　查询的语法分析</p>
<h4 id="Search-模块"><a href="#Search-模块" class="headerlink" title="Search 模块"></a>Search 模块</h4><h5 id="功能-6"><a href="#功能-6" class="headerlink" title="功能"></a>功能</h5><p>　搜索索引</p>
<h5 id="主体-4"><a href="#主体-4" class="headerlink" title="主体"></a>主体</h5><ul>
<li><p>org.apache.lucene.search.<strong>IndexSearcher</strong></p>
<p>以只读的方式打开一个索引，并进行检索</p>
<ul>
<li><p>search</p>
<p>从索引中检索 Document</p>
</li>
</ul>
</li>
<li><p>org.apache.lucene.search.<strong>Query</strong></p>
<p>封装查询请求</p>
<ul>
<li><p>TermQuery</p>
<p>最基本的 Term 查询</p>
</li>
<li><p>BooleanQuery</p>
<p>可以组合多个查询条件</p>
</li>
<li><p>PointRangeQuery</p>
<p>数值区间查询，可以通过 <code>IntPoint#newRangeQuery</code>、<code>LongPoint#newRangeQuery</code>、<code>FloatPoint#newRangeQuery</code> 和 <code>DoublePoint#newRangeQuery</code> 等方式进行创建</p>
</li>
<li><p>PrefixQuery</p>
<p>前缀查询</p>
</li>
<li><p>FuzzyQuery</p>
<p>模糊查询</p>
</li>
<li><p>WildcardQuery</p>
<p>通配符查询</p>
</li>
<li><p>RegexpQuery</p>
<p>正则表达式查询</p>
</li>
<li><p>MultiFieldQueryParser</p>
<p>多值查询</p>
</li>
<li><p>TopDocs</p>
<p>TopN 查询</p>
</li>
</ul>
</li>
</ul>
<h4 id="Similarity-模块"><a href="#Similarity-模块" class="headerlink" title="Similarity 模块"></a>Similarity 模块</h4><h5 id="功能-7"><a href="#功能-7" class="headerlink" title="功能"></a>功能</h5><p>　相关度打分</p>
<h4 id="Geo-模块"><a href="#Geo-模块" class="headerlink" title="Geo 模块"></a>Geo 模块</h4><h5 id="功能-8"><a href="#功能-8" class="headerlink" title="功能"></a>功能</h5><p>　空间查询</p>
<h3 id="ElasticSearch-1"><a href="#ElasticSearch-1" class="headerlink" title="ElasticSearch"></a>ElasticSearch</h3><h4 id="Transport-模块"><a href="#Transport-模块" class="headerlink" title="Transport 模块"></a><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-transport.html">Transport</a> 模块</h4><h5 id="功能-9"><a href="#功能-9" class="headerlink" title="功能"></a>功能</h5><p>　保障了集群内各节点之间可以进行网络通讯</p>
<h5 id="主体-5"><a href="#主体-5" class="headerlink" title="主体"></a>主体</h5><ul>
<li><p>org.elasticsearch.cli.<strong>Command</strong>#main</p>
</li>
<li><p>org.elasticsearch.cli.<strong>EnvironmentAwareCommand</strong>#execute</p>
</li>
<li><p>org.elasticsearch.bootstrap.<strong>Elasticsearch</strong>#execute</p>
</li>
<li><p>org.elasticsearch.bootstrap.<strong>Bootstrap</strong></p>
</li>
<li><p>org.elasticsearch.node.<strong>Node</strong></p>
</li>
<li><p>org.elasticsearch.transport.<strong>TransportService</strong></p>
<ul>
<li><p>connectToNode</p>
<p>连接集群中的其他 Node 节点</p>
</li>
<li><p>sendRequest</p>
<p>发送请求</p>
</li>
<li><p>registerRequestHandler</p>
<p>注册 TransportRequestHandler，用于处理接收到的请求</p>
</li>
</ul>
</li>
<li><p>org.elasticsearch.transport.<strong>Transport</strong></p>
</li>
<li><p>org.elasticsearch.transport.netty4.<strong>Netty4Transport</strong>（transport-netty4 模块）</p>
</li>
<li><p>org.elasticsearch.transport.netty4.<strong>Netty4MessageChannelHandler</strong></p>
</li>
</ul>
<h5 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h5><ul>
<li><p>transport.port</p>
<p>Transport 服务绑定的端口范围，默认值为 <code>9300-9400</code></p>
</li>
<li><p>transport.type</p>
<p>控制 Transport 通讯时的网络类型，默认值为 <code>netty4</code></p>
</li>
<li><p>transport.compress</p>
<p>控制是否针对 Request 请求和 Response 返回结果进行压缩，默认值为 <code>false</code></p>
</li>
</ul>
<h5 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h5><p>　Command 完成 ElasticSearch 进程的启动，随后依次初始化 Bootstrap、Node、Transport 和 TransportService 并启动。节点间通讯的消息处理，最终由 Netty4MessageChannelHandler 进行处理。该 Handler 的注册操作，则会在 Netty4Transport 中完成</p>
<h4 id="Zen-Discovery-模块"><a href="#Zen-Discovery-模块" class="headerlink" title="Zen Discovery 模块"></a>Zen Discovery 模块</h4><h5 id="功能-10"><a href="#功能-10" class="headerlink" title="功能"></a>功能</h5><p>　可以让 ElasticSearch 节点自动互相发现，并组成一个集群，且能通过选举机制找到一个 Master 节点</p>
<h5 id="配置-2"><a href="#配置-2" class="headerlink" title="配置"></a>配置</h5><ul>
<li><p>node.master</p>
<p>如果设置为 true，则可以参与到 Master 选举过程中，默认值为 <code>true</code></p>
</li>
<li><p>node.data</p>
<p>如果设置为 true，则可以存储数据，并处理与数据相关的 CRUD、查询和聚合等操作，默认值为 <code>true</code></p>
<p>排列组合 <code>node.master</code> 和 <code>node.data</code> 这两个参数的结果，如下表所示：</p>
</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">data: true</th>
<th style="text-align:center">data: false</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><strong>master: true</strong></td>
<td style="text-align:center">既是种子节点，又是数据节点</td>
<td style="text-align:center">单纯的种子节点</td>
</tr>
<tr>
<td style="text-align:center"><strong>master: false</strong></td>
<td style="text-align:center">单纯的数据节点</td>
<td style="text-align:center">最简单的协调节点</td>
</tr>
</tbody>
</table>
</div>
  <div class="note info">其中，协调节点负责查询时的数据收集、合并以及聚合等操作。默认的，ElasticSearch 集群中所有节点都是协调节点。其实严格来说，除了 node.master 和 node.data 设置为 false，还需要将 node.ingest 也设置为 false 之后，才能算纯粹的 Coordinating 节点</div>

<ul>
<li><p>node.ingest</p>
<p>如果设置为 true，则可以创建一个 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/pipeline.html">ingest pipeline</a> 任务，对未被索引到 Index 之前的 Document 数据进行预处理，例如设置某一些字段值或者增加一个新字段（如记录摄入时间的新字段）。考虑到可能会增加机器的负载，生产环境中，最好将 Master 节点和 Node 节点上的这个功能关闭，默认值为 <code>true</code></p>
</li>
<li><p>xpack.ml.enabled</p>
<p>如果设置为 true，则可以处理 ElasticSearch 机器学习的接口请求，默认值为 <code>true</code></p>
</li>
<li><p>node.ml</p>
<p>如果设置为 true，则可以运行机器学习相关的任务，默认值为 <code>true</code></p>
</li>
<li><p>discovery.seed_hosts</p>
<p>提供一组可以成为 Master 的种子节点的 IP 地址，如果未指定端口号，将会自动使用 <code>transport.port</code> 的配置值（默认 9300）</p>
</li>
<li><p>discovery.seed_providers</p>
<p>另一种提供种子节点 IP 地址的方式，指定一个存放 IP 地址的文件，可以动态加载，避免集群扩缩容时需要重启 ElasticSearch 进程的问题</p>
</li>
<li><p>discovery.find_peers_interval</p>
<p>Discovery 机制的周期频率，默认值为 <code>1s</code></p>
</li>
</ul>
<h5 id="流程-1"><a href="#流程-1" class="headerlink" title="流程"></a>流程</h5><p>　ElasticSearch 将集群内的节点分为了四种类型，分别是 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html#master-node">Master-eligible node</a>、<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html#data-node">Data node</a>、<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/ingest.html">Ingest node</a> 和 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html#ml-node">Machine learning node</a>。Master 选举只会在 Master-eligible 种子节点之间进行，触发条件为：</p>
<ol>
<li>当前 Master-eligible 节点不是 Master 节点</li>
<li>当前 Master-eligible 节点与其它的节点通信后发现不存在 Master</li>
</ol>
<p>　发起 <a href="https://yuzhouwan.com/posts/22654/#Gossip">Gossip</a> + <a href="https://yuzhouwan.com/posts/22654/#Bully">Bully</a> 的选举流程：</p>
<ol>
<li>寻找 clusterStateVersion 比自己高的 Master-eligible 的节点，向其发送选票</li>
<li>如果 clusterStatrVersion 一样，则计算自己能找到的 Master-eligible 节点中（包括自己）ID 最小的一个节点，向该节点发送选票</li>
<li>如果一个节点收到过半的选票，并且它也向自己投票了，那么该节点成为 Master 节点</li>
</ol>
<p>　成功从 Master-eligible 节点中选举出 Master 节点之后，那么这个 Master 节点将会负责集群（集群信息、集群健康、集群状态、集群配置、所有分片、节点关闭、集群路由）和索引（索引的创建与删除、索引 Template 和 Mapping 的创建删除与更新、索引 Warmer 创建删除与获取、索引的打开与关闭）相关的所有请求</p>
<h5 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h5><h6 id="Bully"><a href="#Bully" class="headerlink" title="Bully"></a>Bully</h6><p>　Bully 算法会假定所有节点都有一个惟一的 ID，并可以依据 ID 对集群内节点进行排序，而拥有最高 ID 的那个节点则会成为 Master 节点</p>
<h6 id="Gossip"><a href="#Gossip" class="headerlink" title="Gossip"></a>Gossip</h6><p>　Gossip 本质上就是一个并行的图广度优先遍历搜索算法，可以借助一个动图来直观感受一下：</p>
<p><img data-src="/picture/es/es_grossip.gif" alt="Gossip"></p>
<center>（图片来源：jianshu.com™，已联系作者，获得授权。不过最近发现该文章已下线，侵删谢谢）</center>

<h6 id="单播-vs-组播-vs-广播"><a href="#单播-vs-组播-vs-广播" class="headerlink" title="单播 vs 组播 vs 广播"></a>单播 vs 组播 vs 广播</h6><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">网络模型</th>
<th style="text-align:center">优点</th>
<th style="text-align:center">缺点</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">单播（unicast）</td>
<td style="text-align:center"><img data-src="/picture/es/es_unicast.svg"></td>
<td style="text-align:center">点对点通讯可以保证低响应延迟</td>
<td style="text-align:center">服务端流量消耗较大</td>
</tr>
<tr>
<td style="text-align:center">组播（multicast）</td>
<td style="text-align:center"><img data-src="/picture/es/es_multicast.svg"></td>
<td style="text-align:center">共享数据流可以减少带宽负载</td>
<td style="text-align:center">无纠错机制，发生丢包或错包之后，很难弥补</td>
</tr>
<tr>
<td style="text-align:center">广播（broadcast）</td>
<td style="text-align:center"><img data-src="/picture/es/es_broadcast.svg"></td>
<td style="text-align:center">网络设备简单可以减少布网和维护的成本</td>
<td style="text-align:center">无法提供定制化服务，且客户端的网络带宽将成为瓶颈</td>
</tr>
</tbody>
</table>
</div>
<center>（图片来源：<a href="https://en.wikipedia.org/wiki/Unicast" target="_blank">wikipedia.org</a>™，已确认无版权）</center>



<h4 id="数据写入"><a href="#数据写入" class="headerlink" title="数据写入"></a>数据写入</h4><h5 id="流程-2"><a href="#流程-2" class="headerlink" title="流程"></a>流程</h5><p>　因为 ElasticSearch 内所有节点都默认属于 Coordinating 节点，这意味着每个节点都有能力处理任何一种请求</p>
<p><img data-src="/picture/es/es_write_1.png" alt="ElasticSearch Write"></p>
<center>（图片来源：<a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/how-primary-and-replica-shards-interact.html" target="_blank">ElasticSearch</a>™ 官方文档）</center>

<p>　这里我们以单 Index、两 Shard、三 Replication、三 Node 的 ElasticSearch 集群为例</p>
<p><img data-src="/picture/es/es_write_2.png" alt="ElasticSearch Write"></p>
<center>（图片来源：<a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/distrib-write.html" target="_blank">ElasticSearch</a>™ 官方文档）</center>

<ol>
<li>客户端向 <code>NODE 1</code> 发送新建、索引或者删除请求</li>
<li>节点使用 Document 的 <code>_id</code> 确定 Document 属于 Shard 0。请求会被转发到 <code>NODE 3</code>，因为分片 0 的主分片目前被分配在 <code>NODE 3</code> 上</li>
<li><code>NODE 3</code> 在主分片上面执行请求。如果成功了，它将请求并行转发到 <code>NODE 1</code> 和 <code>NODE 2</code> 的副本分片上。一旦所有的副本分片都成功返回，<code>Node 3</code> 将向协调节点报告成功，随后协调节点再向客户端反馈请求成功</li>
</ol>
<p>　而内部持久化到磁盘的流程和 <a href="https://yuzhouwan.com/posts/45888/">HBase</a> 很像，所以还可以借鉴 HBase 的概念进行理解：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>HBase</th>
<th>ElasticSearch</th>
</tr>
</thead>
<tbody>
<tr>
<td>MemStore</td>
<td>IndexBuffer</td>
</tr>
<tr>
<td>HFile</td>
<td>Segment</td>
</tr>
<tr>
<td>WAL</td>
<td>Translog</td>
</tr>
<tr>
<td>Compaction</td>
<td>Merge</td>
</tr>
</tbody>
</table>
</div>
<p>　写入的数据都会先存放在 Buffer 中，以保证写入的效率。之后，每隔一段时间（默认 5s，最小 100ms），ElasticSearch 会批量将 Buffer 中的数据，Sync 到磁盘上的 Segment 中。此时，Segment 处于打开状态，可以被查询检索到。而为了确保数据不会丢失，ElasticSearch 会将每一个事务操作都记录到 Translog 中。每次 Sync 操作只会清空 Buffer 中的数据，并不会清空 Translog 中的事务日志。只有写入一段时间后，进行全量 Sync 操作的时候，才会将 Translog 清空（默认是 Translog 达到 512M 或者 12 小时之后）</p>
<p><img data-src="/picture/es/es_write_3.png" alt="ElasticSearch Flush"></p>
<center>（图片来源：<a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/merge-process.html" target="_blank">ElasticSearch</a>™ 官方文档）</center>



<h4 id="数据查询"><a href="#数据查询" class="headerlink" title="数据查询"></a>数据查询</h4><h5 id="流程-3"><a href="#流程-3" class="headerlink" title="流程"></a>流程</h5><p>　和数据写入不同的是，数据查询是可以在主分片或者其任意副本分片上，完成文档检索的。同时，为了保证负载均衡，每次请求的时候，还会轮询地去查询副本分片</p>
<p><img data-src="/picture/es/es_read.png" alt="ElasticSearch Read"></p>
<center>（图片来源：<a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/distrib-read.html" target="_blank">ElasticSearch</a>™ 官方文档）</center>

<p>　这里我们仍然以单 Index、两 Shard、三 Replication、三 Node 的 ElasticSearch 集群为例</p>
<ol>
<li>客户端向 <code>NODE 1</code> 发送查询请求</li>
<li>节点使用 Document 的 <code>_id</code> 来确定 Document 属于 Shard <code>0</code>。而所有节点上都存在着 Shard <code>0</code> 的副本分片。这种情况下，它将请求转发到 <code>NODE 2</code> </li>
<li><code>NODE 2</code> 将文档返回给 <code>NODE 1</code>，然后将文档返回给客户端</li>
</ol>
<div class="note info">可以通过 index.queries.cache.enabled 参数，来控制是否对查询结果进行缓存，默认是开启的</div>




<h4 id="段合并"><a href="#段合并" class="headerlink" title="段合并"></a>段合并</h4><h5 id="流程-4"><a href="#流程-4" class="headerlink" title="流程"></a>流程</h5><p>　为了避免 Segment 小文件过多，ElasticSearch 会定时进行 Segment 合并操作。因为段合并需要消耗大量的磁盘 IO 和 CPU，所以为了不影响正常的集群运行，ElasticSearch 会进行严格的限流，默认 20MB/s</p>
<p><img data-src="/picture/es/es_segment_merge_before.png" alt="Before ElasticSearch Segment Merge"></p>
<p><img data-src="/picture/es/es_segment_merge_after.png" alt="After ElasticSearch Segment Merge"></p>
<center>（图片来源：<a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/merge-process.html" target="_blank">ElasticSearch</a>™ 官方文档）</center>



<h4 id="熔断器"><a href="#熔断器" class="headerlink" title="熔断器"></a><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/circuit-breaker.html">熔断器</a></h4><h5 id="功能-11"><a href="#功能-11" class="headerlink" title="功能"></a>功能</h5><p>　熔断器（Circuit Breaker）用于防止 OOM 异常，以增强集群稳定性。更多介绍，详见上文 “使用技巧 - 熔断机制” 小节</p>
<h5 id="配置-3"><a href="#配置-3" class="headerlink" title="配置"></a>配置</h5><h6 id="Parent-Circuit-Breaker"><a href="#Parent-Circuit-Breaker" class="headerlink" title="Parent Circuit Breaker"></a><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/circuit-breaker.html#parent-circuit-breaker">Parent Circuit Breaker</a></h6><ul>
<li><p>indices.breaker.total.use_real_memory</p>
<p>是否通过 <code>ManagementFactory.getMemoryMXBean().getHeapMemoryUsage().getUsed()</code> 的方式获取更加精准的内存使用指标，默认值为 <code>true</code></p>
</li>
<li><p>indices.breaker.total.limit</p>
<p>父熔断器限制内存使用的比例，默认值为 <code>70%</code>（上一个参数 <code>use_real_memory</code> 为 <code>false</code>） 或 <code>95%</code>（反之为 <code>true</code>）</p>
</li>
</ul>
<h6 id="Field-Data-Circuit-Breaker"><a href="#Field-Data-Circuit-Breaker" class="headerlink" title="Field Data Circuit Breaker"></a><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/circuit-breaker.html#fielddata-circuit-breaker">Field Data Circuit Breaker</a></h6><ul>
<li><p>indices.breaker.fielddata.limit</p>
<p>字段数据熔断器，限制内存中加载的 Field 只能占到总内存的比例，默认值为 <code>40%</code></p>
</li>
<li><p>indices.breaker.fielddata.overhead</p>
<p>用来和字段数据估计值相乘的常数，默认值为 <code>1.03</code></p>
</li>
</ul>
<h6 id="Request-Circuit-Breaker"><a href="#Request-Circuit-Breaker" class="headerlink" title="Request Circuit Breaker"></a><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/circuit-breaker.html#request-circuit-breaker">Request Circuit Breaker</a></h6><ul>
<li><p>indices.breaker.request.limit</p>
<p>请求熔断器，主要限制的是请求在执行过程中的可能会消耗的内存（例如，用于在请求期间计算聚合的内存），默认值为 <code>60%</code></p>
</li>
<li><p>indices.breaker.request.overhead</p>
<p>用来和请求内存消耗的估计值相乘的常数，默认值为 <code>1</code></p>
</li>
</ul>
<h6 id="In-Flight-Requests-Circuit-Breaker"><a href="#In-Flight-Requests-Circuit-Breaker" class="headerlink" title="In Flight Requests Circuit Breaker"></a><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/circuit-breaker.html#in-flight-circuit-breaker">In Flight Requests Circuit Breaker</a></h6><ul>
<li><p>network.breaker.inflight_requests.limit</p>
<p>飞行中请求熔断器，则是作用于尚未开始执行的请求，主要限制的是，请求本身的内容长度，会在 HTTP 层面上对所有当前活跃的传入请求的内存大小进行限制，默认值为 <code>100%</code>（这意味着可能会在父熔断器允许的范围内将内存耗尽）</p>
</li>
<li><p>network.breaker.inflight_requests.overhead</p>
<p>用来和飞行中请求内存消耗的估计值相乘的常数，默认值为 <code>2</code></p>
</li>
</ul>
<h6 id="Accounting-Requests-Circuit-Breaker"><a href="#Accounting-Requests-Circuit-Breaker" class="headerlink" title="Accounting Requests Circuit Breaker"></a><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/circuit-breaker.html#accounting-circuit-breaker">Accounting Requests Circuit Breaker</a></h6><ul>
<li><p>indices.breaker.accounting.limit</p>
<p>计费熔断器，限制的是请求完成时，未被释放的内容的内存大小（例如，Lucene 段内存等），默认值为 <code>100%</code>（这意味着可能会在父熔断器允许的范围内将内存耗尽）</p>
</li>
<li><p>indices.breaker.accounting.overhead</p>
<p>用来和计费熔断器的估计值相乘的常数，默认值为 <code>1</code></p>
</li>
</ul>
<h6 id="Script-Compilation-Circuit-Breaker"><a href="#Script-Compilation-Circuit-Breaker" class="headerlink" title="Script Compilation Circuit Breaker"></a><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/circuit-breaker.html#script-compilation-circuit-breaker">Script Compilation Circuit Breaker</a></h6><ul>
<li><p>script.max_compilations_rate</p>
<p>脚本编译熔断器，限制的是一段时间内的内联脚本编译次数，默认值为 <code>75/5m</code></p>
</li>
</ul>
<h5 id="主体-6"><a href="#主体-6" class="headerlink" title="主体"></a>主体</h5><ul>
<li><p>org.elasticsearch.common.breaker.<strong>CircuitBreaker</strong></p>
<p>最上层的接口，定义了除脚本编译熔断器（ScriptService）之外的所有内置的 Breaker：</p>
<ul>
<li><code>PARENT</code></li>
<li><code>FIELDDATA</code></li>
<li><code>REQUEST</code></li>
<li><code>IN_FLIGHT_REQUESTS</code></li>
<li><code>ACCOUNTING</code></li>
</ul>
<p>和相应的类型：</p>
<ul>
<li><p><code>MEMORY</code></p>
<p>子熔断器</p>
</li>
<li><p><code>PARENT</code></p>
<p>父熔断器</p>
</li>
<li><p><code>NOOP</code></p>
<p>不会触发任何熔断行为的熔断器</p>
</li>
</ul>
<p>以及 Breaker 相关的行为：</p>
<ul>
<li><code>addEstimateBytesAndMaybeBreak</code></li>
<li><code>addWithoutBreaking</code></li>
<li><code>getUsed</code></li>
<li><code>getLimit</code></li>
<li><code>getOverhead</code></li>
<li><code>getTrippedCount</code></li>
<li><code>getName</code></li>
<li><code>getDurability</code></li>
</ul>
</li>
<li><p>org.elasticsearch.common.breaker.<strong>ChildMemoryCircuitBreaker</strong></p>
</li>
<li><p>org.elasticsearch.indices.breaker.<strong>HierarchyCircuitBreakerService</strong></p>
<ul>
<li><p><code>#breakers</code></p>
<p>记录所有的 Breaker，即 <code>&lt;熔断器名称，CircuitBreaker 实例&gt;</code></p>
</li>
<li><p><code>checkParentLimit</code></p>
<p>检查父熔断器是否已跳闸</p>
</li>
<li><p><code>registerBreaker</code></p>
<p>注册熔断器（支持注册自定义的熔断器，如果自定义的熔断器名称和已存在的熔断器的名称相同，将会覆盖掉已存在的熔断器）</p>
</li>
</ul>
</li>
<li><p>org.elasticsearch.indices.breaker.<strong>BreakerSettings</strong></p>
<ul>
<li><p><code>#name</code></p>
<p>熔断器的名称</p>
</li>
<li><p><code>#limitBytes</code></p>
<p>阀值</p>
</li>
<li><p><code>#overhead</code></p>
<p>计算内存消耗时的因子</p>
</li>
<li><p><code>#type</code></p>
<p>熔断器的类型</p>
</li>
</ul>
</li>
</ul>
<h4 id="Rollup-1"><a href="#Rollup-1" class="headerlink" title="Rollup"></a>Rollup</h4><h5 id="主体-7"><a href="#主体-7" class="headerlink" title="主体"></a>主体</h5><ul>
<li>org.elasticsearch.xpack.rollup.<strong>Rollup</strong></li>
<li>org.elasticsearch.xpack.rollup.job.<strong>RollupJobTask</strong></li>
<li>org.elasticsearch.xpack.rollup.job.RollupJobTask.<strong>RollupJobPersistentTasksExecutor</strong></li>
</ul>
<h5 id="时序图"><a href="#时序图" class="headerlink" title="时序图"></a>时序图</h5><pre class="mermaid">sequenceDiagram

participant User

participant TransportPutRollupJobAction
participant RollupJob
participant PersistentTasksService
participant ElasticsearchClient
participant AbstractClient
participant OriginSettingClient
participant ActionListener

User -&gt;&gt;+ TransportPutRollupJobAction : masterOperation
TransportPutRollupJobAction -&gt;&gt; TransportPutRollupJobAction : createRollupJob
TransportPutRollupJobAction -&gt;&gt;+ RollupJob : &lt;&lt; new &gt;&gt;
RollupJob --&gt;&gt;- TransportPutRollupJobAction : Instance
TransportPutRollupJobAction -&gt;&gt; TransportPutRollupJobAction : createIndex
TransportPutRollupJobAction -&gt;&gt;+ TransportPutRollupJobAction : startPersistentTask
TransportPutRollupJobAction -&gt;&gt; PersistentTasksService : sendStartRequest
PersistentTasksService -&gt;&gt;+ PersistentTasksService : execute
PersistentTasksService -&gt;&gt;+ ElasticsearchClient : execute
ElasticsearchClient -&gt;&gt;+ AbstractClient : doExecute
AbstractClient -&gt;&gt;+ OriginSettingClient : doExecute
OriginSettingClient --&gt;&gt;- AbstractClient : done
AbstractClient --&gt;&gt;- ElasticsearchClient : done
ElasticsearchClient --&gt;&gt;- PersistentTasksService : done
PersistentTasksService -&gt;&gt; PersistentTasksService : waitForPersistentTaskCondition
PersistentTasksService -&gt;&gt;+ ActionListener : onResponse | onFailure | onTimeout
ActionListener --&gt;&gt;- PersistentTasksService : done
PersistentTasksService --&gt;&gt;- TransportPutRollupJobAction : done
TransportPutRollupJobAction --&gt;&gt;- User : done</pre>







<h2 id="踩过的坑"><a href="#踩过的坑" class="headerlink" title="踩过的坑"></a>踩过的坑</h2><h3 id="Unknown-Analyzer-type-org-ElasticSearch-index-analysis-IkAnalyzerProvider-for-ik"><a href="#Unknown-Analyzer-type-org-ElasticSearch-index-analysis-IkAnalyzerProvider-for-ik" class="headerlink" title="Unknown Analyzer type [org.ElasticSearch.index.analysis.IkAnalyzerProvider] for [ik]"></a>Unknown Analyzer type [org.ElasticSearch.index.analysis.IkAnalyzerProvider] for [ik]</h3><p>　属于配置的问题，需注意 ElasticSearch 和 IK 中文分词插件的版本，不同的版本中支持的配置项也会不一样</p>
<h3 id="The-number-of-object-passed-must-be-even-but-was-1"><a href="#The-number-of-object-passed-must-be-even-but-was-1" class="headerlink" title="The number of object passed must be even but was [1]"></a>The number of object passed must be even but was [1]</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 建议不使用 JSON.toJSONString，而是自己在 POJO 中拼装 Map&lt;String, Object&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">toJSON</span><span class="params">()</span> </span>{</span><br><span class="line">  HashMap&lt;String, Object&gt; json = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">  json.put(<span class="string">"systemName"</span>, systemName);</span><br><span class="line">  json.put(<span class="string">"ip"</span>, ip);</span><br><span class="line">  json.put(<span class="string">"path"</span>, path);</span><br><span class="line">  json.put(<span class="string">"time"</span>, time);</span><br><span class="line">  json.put(<span class="string">"message"</span>, message);</span><br><span class="line">  <span class="keyword">return</span> json;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">(ElasticsearchSinkFunction&lt;HBaseServerLog&gt;) (element, ctx, indexer) -&gt; {</span><br><span class="line">  _log.debug(<span class="string">"Message: {} in ES Sink"</span>, element);</span><br><span class="line">  <span class="keyword">if</span> (element == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line">  indexer.add(indexRequest()</span><br><span class="line">         .index(HBASE_SERVER_LOG_INDEX_NAME)</span><br><span class="line">         .type(HBASE_SERVER_LOG_TYPE_NAME)</span><br><span class="line">         .source(element.toJSON()));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="blocked-by-FORBIDDEN-12-index-read-only-allow-delete-api"><a href="#blocked-by-FORBIDDEN-12-index-read-only-allow-delete-api" class="headerlink" title="blocked by: [FORBIDDEN/12/index read-only / allow delete (api)]"></a>blocked by: [FORBIDDEN/12/index read-only / allow delete (api)]</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">PUT _settings</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"index"</span>: {</span><br><span class="line">    <span class="attr">"blocks"</span>: {</span><br><span class="line">      <span class="attr">"read_only_allow_delete"</span>: <span class="string">"false"</span></span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<div class="note success">从 ElasticSearch 7.4.0 版本开始，支持在磁盘水位下降后，自动释放索引的 read-only 锁</div>



<h3 id="Docker-中无法开启-bootstrap-memory-lock-参数"><a href="#Docker-中无法开启-bootstrap-memory-lock-参数" class="headerlink" title="Docker 中无法开启 bootstrap.memory_lock 参数"></a>Docker 中无法开启 bootstrap.memory_lock 参数</h3><p>　非容器环境下，在 limits.conf 文件中增加 memlock 相关的配置即可（这里了的 admin 是 ElasticSearch 运行的用户，可以根据实际情况更换）</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ su -</span><br><span class="line">$ vim /etc/security/limits.conf</span><br><span class="line">  admin soft memlock unlimited</span><br><span class="line">  admin hard memlock unlimited</span><br></pre></td></tr></tbody></table></figure>
<p>　容器环境下，则需要用如下方式进行修改：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ grep locked /proc/$(ps --no-headers -o pid -C dockerd | tr -d <span class="string">' '</span>)/limits</span><br><span class="line">  Max locked memory         65536                65536                bytes</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> -e <span class="string">"[Service]\nLimitMEMLOCK=infinity"</span> | SYSTEMD_EDITOR=tee systemctl edit docker.service</span><br><span class="line">  [Service]</span><br><span class="line">  LimitMEMLOCK=infinity</span><br><span class="line"></span><br><span class="line">$ systemctl daemon-reload</span><br><span class="line">$ systemctl restart docker</span><br><span class="line"></span><br><span class="line">$ grep locked /proc/$(ps --no-headers -o pid -C dockerd | tr -d <span class="string">' '</span>)/limits</span><br><span class="line">  Max locked memory         unlimited            unlimited            bytes</span><br></pre></td></tr></tbody></table></figure>
<h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><h3 id="Doc"><a href="#Doc" class="headerlink" title="Doc"></a>Doc</h3><h4 id="Lucene-2"><a href="#Lucene-2" class="headerlink" title="Lucene"></a>Lucene</h4><ul>
<li><a href="https://lucene.apache.org/core/8_6_2/changes/Changes.html">Lucene 8.6.2 Release Notes</a></li>
<li><a href="http://lucene.apache.org/core/8_6_2/demo/overview-summary.html">Lucene 8.6.2 demo API</a></li>
<li><a href="https://github.com/apache/lucene-solr/blob/master/README.md#building-lucenesolr">Building Lucene</a></li>
<li><a href="https://lucene.apache.org/solr/guide/6_6/docvalues.html">Lucene: DocValues</a></li>
</ul>
<h4 id="ElasticSearch-2"><a href="#ElasticSearch-2" class="headerlink" title="ElasticSearch"></a>ElasticSearch</h4><ul>
<li><a href="https://www.elastic.co/products/elasticsearch/features">Elasticsearch features</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/index.html">Elasticsearch Reference</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/sql-limitations.html">SQL Limitations</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/breaking-changes-7.0.html">Breaking changes in 7.0</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-types.html">Field datatypes</a></li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">主分类</th>
<th style="text-align:center">子分类</th>
<th style="text-align:center">字段类型</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">核心类型</td>
<td style="text-align:center">字符串类型</td>
<td style="text-align:center">text / keyword</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">整数类型</td>
<td style="text-align:center">long /integer / short / byte</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">浮点类型</td>
<td style="text-align:center">double / float / half_float / scaled_float</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">逻辑类型</td>
<td style="text-align:center">boolean</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">日期类型</td>
<td style="text-align:center">date</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">范围类型</td>
<td style="text-align:center">integer_range / float_range / long_range / double_range / date_range</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">二进制类型</td>
<td style="text-align:center">binary</td>
</tr>
<tr>
<td style="text-align:center">复合类型</td>
<td style="text-align:center">对象类型</td>
<td style="text-align:center">object</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">嵌套类型</td>
<td style="text-align:center">nested</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">数组类型</td>
<td style="text-align:center">不存在数组类型，所有的字段都有存储多个相同类型的字段值</td>
</tr>
<tr>
<td style="text-align:center">地理类型</td>
<td style="text-align:center">地理坐标类型</td>
<td style="text-align:center">geo_point</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">地理地图</td>
<td style="text-align:center">geo_shape</td>
</tr>
<tr>
<td style="text-align:center">特殊类型</td>
<td style="text-align:center">IP 类型</td>
<td style="text-align:center">ip</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">范围类型</td>
<td style="text-align:center">completion</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">令牌计数类型</td>
<td style="text-align:center">token_count</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">存储索引的 Hash 值类型</td>
<td style="text-align:center">murmur3</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">抽取类型</td>
<td style="text-align:center">percolator</td>
</tr>
</tbody>
</table>
</div>
<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/doc-values.html">ElasticSearch: doc_values</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/rollup-apis.html">Rollup APIs</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/rollup-agg-limitations.html">Rollup aggregation limitations</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/xpack-rollup.html">Rolling up historical data</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/tune-for-indexing-speed.html">Tune for indexing speed</a></li>
</ul>
<h3 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h3><ul>
<li><a href="https://github.com/apache/lucene-solr">Lucene</a></li>
<li><a href="https://github.com/opendistro-for-elasticsearch/security">Open Distro for Elasticsearch Security</a></li>
<li><a href="https://github.com/elastic/elasticsearch-formal-models">Formal models of core Elasticsearch algorithms</a></li>
<li><a href="https://github.com/elastic/elasticsearch/pull/46169">Fix G1 GC default IHOP</a></li>
</ul>
<h3 id="Paper"><a href="#Paper" class="headerlink" title="Paper"></a>Paper</h3><ul>
<li><a href="https://cs.nyu.edu/~mohri/pub/fla.pdf">Weighted Finite-State Transducer Algorithms</a></li>
</ul>
<h3 id="Book"><a href="#Book" class="headerlink" title="Book"></a>Book</h3><ul>
<li><a href="https://www.amazon.com/Mastering-ElasticSearch-Rafal-Kuc/dp/178328143X">Mastering ElasticSearch</a></li>
<li><a href="https://www.amazon.com/Monitoring-ElasticSearch-Dan-Noble/dp/1784397806">Monitoring ElasticSearch</a></li>
<li><a href="https://www.amazon.com/ElasticSearch-Cookbook-Second-Alberto-Paro/dp/1783554835">ElasticSearch Cookbook, 2nd Edition</a></li>
<li><a href="https://www.amazon.com/Elasticsearch-Action-Radu-Gheorghe/dp/1617291625">Elasticsearch in Action</a></li>
<li><a href="https://www.amazon.com/ElasticSearch-Indexing-Huseyin-Akdogan/dp/1783987022">Elasticsearch Indexing</a></li>
<li><a href="https://www.amazon.com/ElasticSearch-Server-Second-Rafal-Kuc/dp/1783980524">Elasticsearch Server, 2nd Edition</a></li>
<li><a href="https://www.amazon.com/Elasticsearch-Definitive-Distributed-Real-Time-Analytics/dp/1449358543">Elasticsearch：The Definitive Guide</a></li>
</ul>
<h3 id="Tool"><a href="#Tool" class="headerlink" title="Tool"></a>Tool</h3><ul>
<li><a href="https://home.apache.org/~mikemccand/geobench.html">Lucene Geo benchmarks</a></li>
<li><a href="https://elasticsearch-benchmarks.elastic.co/">ElasticSearch Benchmark</a></li>
</ul>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt=""></a></td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>大数据</category>
      </categories>
      <tags>
        <tag>Kubernetes</tag>
        <tag>Java</tag>
        <tag>Helm</tag>
        <tag>ElasticSearch</tag>
        <tag>Lucene</tag>
        <tag>Kafka</tag>
        <tag>Flume</tag>
        <tag>HBase</tag>
      </tags>
  </entry>
  <entry>
    <title>人工智能</title>
    <url>/posts/42737/</url>
    <content><![CDATA[<h2 id="什么是人工智能"><a href="#什么是人工智能" class="headerlink" title="什么是人工智能"></a>什么是人工智能</h2><p>　<strong>人工智能</strong>（<strong>A</strong>rtificial <strong>I</strong>ntelligence, <strong>AI</strong>）亦称<strong>机器智能</strong>，是指由人工制造出来的系统所表现出来的智能。 — <a href="https://zh.wikipedia.org/wiki/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD">wikipedia.org</a></p>
<p>　从 深蓝到 <a href="https://arxiv.org/pdf/1712.01815.pdf">AlphaZero</a>，人工智能的智力水平、普适性、学习能力 正在以爆炸式地速度快速发展；<br>　从 棋类到 医学，人工智能开始在各类应用领域，都在大展身手；<br>　从 CPU / GPU 到 <a href="https://cloud.google.com/blog/big-data/2017/05/an-in-depth-look-at-googles-first-tensor-processing-unit-tpu">TPU</a>，人工智能的计算能力正向着无法穷举的极限不断逼近 …</p>
<p>　但是，我们并不浮躁，踏踏实实地点亮 AI 知识树的每个枝叶，才是我们每位富有科学精神的人所应该做的</p>
<h2 id="关于本文"><a href="#关于本文" class="headerlink" title="关于本文"></a>关于本文</h2><p>　我们将分为三块对 AI 进行诠释</p>
<p>　首先，将介绍人工智能的<strong>主流思想</strong>和<strong>实用技巧</strong>，通过一些耳熟能详的<a href="https://yuzhouwan.com/posts/4534/">有趣定理</a>，我们可以对人工智能有些直观、初步的认识；随后，言归正传，我们将开始接触 AI 领域的几大<strong>理论支柱</strong>，由浅入深地学习 <a href="https://yuzhouwan.com/posts/42737/#统计学">统计学</a>、<a href="https://yuzhouwan.com/posts/42737/#微积分">微积分</a>、<a href="https://yuzhouwan.com/posts/42737/#线性代数">线性代数</a>、<a href="https://yuzhouwan.com/posts/42737/#概率论">概率论</a> 等知识体系；最后，落地到实践，我们需要紧跟人工智能的<strong>技术发展前沿</strong>，对重大的突破性项目进行了解、学习，以及运用。如此，对人工智能领域进行横向分层，可以很方便地找到我们学习的突破点</p>
<p>　不过，出于文章编排的考虑，可能部分编码就要放在其他博文中了，如有不便，还望见谅（<a href="https://yuzhouwan.com/posts/43687/#Python-第三方库">Python</a>、Prolog、R、<a href="https://yuzhouwan.com/posts/27328/">Java</a>）。本文持续更新中，若有不妥之处，还请不吝赐教哈 (^o^)/</p>
<h2 id="主流思想"><a href="#主流思想" class="headerlink" title="主流思想"></a>主流思想</h2><h3 id="演绎法-amp-溯因法-amp-归纳法"><a href="#演绎法-amp-溯因法-amp-归纳法" class="headerlink" title="演绎法 &amp; 溯因法 &amp; 归纳法"></a>演绎法 &amp; 溯因法 &amp; 归纳法</h3><p><img data-src="/picture/ai/ai_cause_rule_effect.png" alt=""></p>
<center>（利用 <a href="https://www.axure.com.cn/" target="_blank">Axure</a>™ 绘制而成）</center>



<h2 id="实用技巧"><a href="#实用技巧" class="headerlink" title="实用技巧"></a>实用技巧</h2><h3 id="Occam-剃刀原理"><a href="#Occam-剃刀原理" class="headerlink" title="Occam 剃刀原理"></a>Occam 剃刀原理</h3><p>　<strong>奥卡姆剃刀</strong>（Occam´s Razor），意为<strong>简约之法</strong>，是由 14 世纪<a href="https://zh.wikipedia.org/wiki/%E9%80%BB%E8%BE%91%E5%AD%A6">逻辑学</a>家、<a href="https://zh.wikipedia.org/wiki/%E8%81%96%E6%96%B9%E6%BF%9F%E5%90%84%E6%9C%83">圣方济各会</a><a href="https://zh.wikipedia.org/wiki/%E4%BF%AE%E5%A3%AB">修士</a><a href="https://zh.wikipedia.org/wiki/%E5%A5%A5%E5%8D%A1%E5%A7%86%E7%9A%84%E5%A8%81%E5%BB%89">奥卡姆的威廉</a>提出的一个解决问题的法则，即<code>"切勿浪费较多资源，去做'用较少的资源，同样可以做好'的事情"</code>，相同思想见于郑板桥的<strong>删繁就简三秋树</strong></p>
<a id="more"></a>
<p>　在机器学习中的解释，就是 <code>在所有可能选择的模型中，能够很好地解释已知数据且十分简单的才是最好的模型</code>。并由此引入了<strong><a href="https://www.zhihu.com/question/20924039">正则化</a></strong>的理念。<a href="http://www.cnblogs.com/jianxinzhou/p/4083921.html">正则化</a>方法的思想是，处理最优化函数问题时，在目标函数中加入对参数的<strong>约束惩罚项</strong>，从而达到<strong>简化模型</strong>的目的。其中，<a href="http://blog.csdn.net/zouxy09/article/details/24971995">L0，L1 和 L2</a> <a href="https://zh.wikipedia.org/wiki/%E8%8C%83%E6%95%B0">范数</a> 指的就是三种不同惩罚函数的形式，用数学公式来表达就是 $L_p$ = $\mid\mid\beta\mid\mid_p$ = $(\mid \beta_1 \mid ^p + \mid \beta_2 \mid^p$ $+ \ldots +$ $\mid\,\beta_n \mid^p)^{\frac1p}$</p>
<ul>
<li><strong>L0 范数</strong> 是指向量中非 0 元素的个数（如果我们用 L0 范数来规则化一个参数矩阵 W 的话，就是希望 W 的大部分元素都是 0，即让参数矩阵 W 是稀疏的）</li>
<li><strong>L1 范数</strong> 是指向量中各系数绝对值之和（又称为 <a href="http://blog.csdn.net/zouxy09/article/details/24971995">LASSO</a>）</li>
<li><strong>L2 范数</strong> 是指向量中各系数平方和的平方根（在计量经济学里面，它又被称为 <a href="http://www.ics.uci.edu/~welling/teaching/KernelsICS273B/Kernel-Ridge.pdf">岭回归</a>）</li>
</ul>
<h3 id="大数定律"><a href="#大数定律" class="headerlink" title="大数定律"></a>大数定律</h3><p>　<strong>大数定律</strong>又称大数法则、大数律，是描述相当多次数重复实验的结果的定律。根据这个定律知道，样本数量越多，则其平均就越趋近<a href="https://zh.wikipedia.org/wiki/%E6%9C%9F%E6%9C%9B%E5%80%BC">期望值</a></p>
<p>　在概率论中，细分为<strong>弱大数定律</strong>和<strong>强大数定律</strong></p>
<h4 id="前要定义"><a href="#前要定义" class="headerlink" title="前要定义"></a>前要定义</h4><p>　独立同分布的随机变量序列：$X_1, X_2, \dots, X_n$</p>
<p>　样本均值：$M_n = \frac{ \sum_{i=1}^nX_i }n$</p>
<p>　当样本量很大的时候，从 $X$ 抽取的样本平均值：$E[X]$（可得，$E[M_n] = \mu$）</p>
<p>　设在某一试验中，$A$ 是一个事件，满足条件 $P(A) &gt; 0$，又设 $X$ 和 $Y$ 是在同一个试验中的两个随机变量。若 $X$ 和 $Y$ 相互独立，则 $var(X + Y) =$ $var(X) + var(Y)$（可得，$var(M_n) = \frac{ \sigma^2 }n$）</p>
<h4 id="弱大数定律"><a href="#弱大数定律" class="headerlink" title="弱大数定律"></a>弱大数定律</h4><p>　设 $X_1, X_2, \dots, X_n$ 独立同分布，其公共分布的均值为 $\mu$，则对任意的 $\epsilon \gt 0$，当 $n \to +\infty$ 时，$P(\mid M_n - \mu \mid \ge \epsilon) = $ $P(\mid \frac{ \sum_{i=1}^n{X_i} }n - \mu\,\mid$ $ \ge \epsilon) \to 0$</p>
<p>　<strong>弱大数定律</strong>出给的结论是，$M_n$ 落在 $[\mu - \epsilon, \mu + \epsilon]$ 区间（即 $\mu$ 的 $\epsilon$ 邻域）内的概率会非常大（也可以表述为 “$M_n$ 收敛于 $\mu$”）。同时可以看出，随着 $n$ 值的增大，$M_n$ 落在 $\mu$ 邻域内的概率也会变大</p>
<h4 id="强大数定律"><a href="#强大数定律" class="headerlink" title="强大数定律"></a>强大数定律</h4><p>　设 $X_1, X_2, \dots, X_n$ 是均值为 $\mu$ 的独立同分布随机变量序列，则样本均值 $M_n$ 以概率 $1$ 收敛于 $\mu$，即 $P(\lim_{n \to +\infty}M_n = \mu) = 1$</p>
<p>　在无穷序列中，弱大数定律无法给出到底存在多少元素显著性偏离了 $\mu$。而利用<strong>强大数定律</strong>则可得出，$M_n$ 以概率 $1$（即几乎处处）收敛于 $\mu$ 的结论，意味着对于任何 $\epsilon \gt 0$，偏离 $\mid M_n - \mu\mid$ 超过 $\epsilon$ 的元素只会存在有限多个</p>
<h2 id="统计学"><a href="#统计学" class="headerlink" title="统计学"></a>统计学</h2><h3 id="什么是统计学"><a href="#什么是统计学" class="headerlink" title="什么是统计学"></a>什么是统计学</h3><p>　统计学（Statistics）是一套用以<strong>收集数据</strong>、<strong>分析数据</strong>和<strong>由数据得出结论</strong>的概念、原则和方法。  — <a href="http://www.swarthmore.edu/SocSci/cwareha1/iversen.html">Gudmund R.Iversen</a></p>
<h3 id="主要思想"><a href="#主要思想" class="headerlink" title="主要思想"></a>主要思想</h3><h4 id="随机性-amp-规律性"><a href="#随机性-amp-规律性" class="headerlink" title="随机性 &amp; 规律性"></a>随机性 &amp; 规律性</h4><p>　随机性，指不能预测某一特定事件的结果<br>　规律性，指从大量的收集数据中发现的模式</p>
<p>　可以说，统计就是在<strong>随机性</strong>中寻找<strong>规律性</strong></p>
<h3 id="数据集描述"><a href="#数据集描述" class="headerlink" title="数据集描述"></a>数据集描述</h3><h4 id="数据分布中心"><a href="#数据分布中心" class="headerlink" title="数据分布中心"></a>数据分布中心</h4><h5 id="均值（Mean）"><a href="#均值（Mean）" class="headerlink" title="均值（Mean）"></a><a href="https://www.zybuluo.com/spiritnotes/note/297176">均值</a>（Mean）</h5><p>　算术平均值：$\mu = \frac{ \Sigma X }N$ 或 $\bar x = \frac{ \sum_{i=1}^n X_i }n$</p>
<h5 id="中位数（Median）"><a href="#中位数（Median）" class="headerlink" title="中位数（Median）"></a>中位数（Median）</h5><p>　高偏斜分布（存在异常值）的情况下，中位数则能更好地反映数据的集中趋势</p>
<h5 id="众数（Mode）"><a href="#众数（Mode）" class="headerlink" title="众数（Mode）"></a>众数（Mode）</h5><p>　平均分布的情况下，则无法得出众数</p>
<p>　另外，在正太分布的数据集中，均值、中位数、众数均相等</p>
<h4 id="稳健统计"><a href="#稳健统计" class="headerlink" title="稳健统计"></a>稳健统计</h4><h5 id="值域（Range）"><a href="#值域（Range）" class="headerlink" title="值域（Range）"></a><a href="https://zh.wikipedia.org/zh-hans/%E5%80%BC%E5%9F%9F">值域</a>（Range）</h5><p>　函数的<strong>值域</strong>（Range）是由定义域中一切<strong>元素</strong>所能产生的所有函数值的<strong>集合</strong>（也被称为<strong>函数的像</strong>）</p>
<h5 id="四分位数（Quartile）"><a href="#四分位数（Quartile）" class="headerlink" title="四分位数（Quartile）"></a>四分位数（Quartile）</h5><p>　<a href="https://zh.wikipedia.org/wiki/%E7%BB%9F%E8%AE%A1%E5%AD%A6">统计学</a>中<a href="https://zh.wikipedia.org/wiki/%E5%88%86%E4%BD%8D%E6%95%B0">分位数</a>的一种，即把所有数值由小到大排列并分成四等份，处于三个分割点位置的数值就是四分位数</p>
<p>　数学表达式：$L_p = n \frac{ p }{100}$，其中，$p$ 为四分位的百分比值，$n$ 为样本总量</p>
<h5 id="四分位距（IQR-Interquartile-Range）"><a href="#四分位距（IQR-Interquartile-Range）" class="headerlink" title="四分位距（IQR, Interquartile Range）"></a><a href="https://zh.wikipedia.org/wiki/%E5%9B%9B%E5%88%86%E4%BD%8D%E8%B7%9D">四分位距</a>（IQR, <strong>I</strong>nter<strong>q</strong>uartile <strong>R</strong>ange）</h5><p>　第三<a href="https://zh.wikipedia.org/wiki/%E5%9B%9B%E5%88%86%E4%BD%8D%E6%95%B0">四分位数</a>和第一四分位数的差距，即 $Q_3 - Q_1$</p>
<p>　可以使用 $Q_1-1.5 \cdot IQR$ 和 $Q_3+1.5 \cdot IQR$ 区间，来判断离群值（Outlier）</p>
<p><img data-src="/picture/ai/ai_boxplot_vs_pdf.png" alt=""></p>
<center>（图片来源：<a href="https://zh.wikipedia.org/wiki/%E6%AD%A3%E6%80%81%E5%88%86%E5%B8%83" target="_blank">wikipedia.org</a>™，已确认版权为 CC BY 2.5 协议）</center>




<h5 id="四分位差（QD-Quartile-Deviation）"><a href="#四分位差（QD-Quartile-Deviation）" class="headerlink" title="四分位差（QD, Quartile Deviation）"></a>四分位差（QD, <strong>Q</strong>uartile <strong>D</strong>eviation）</h5><p>　四分位差是指 $Q_1$ 和 $Q_3$ 的差距，即 $QD = Q_3 - Q_1$（这里单独提出来，是因为旧版教材中的公式为 $QD = \frac{ Q_3 - Q_1 }2$）</p>
<h4 id="偏差"><a href="#偏差" class="headerlink" title="偏差"></a>偏差</h4><h5 id="离均差（Deviation-from-Average）"><a href="#离均差（Deviation-from-Average）" class="headerlink" title="离均差（Deviation from Average）"></a>离均差（Deviation from Average）</h5><p>　$x_i - \bar x$</p>
<h5 id="平均偏差（Average-Deviation）"><a href="#平均偏差（Average-Deviation）" class="headerlink" title="平均偏差（Average Deviation）"></a>平均偏差（Average Deviation）</h5><p>　$\frac{ \sum_{i = 1}^n (x_i - \bar x) }n$</p>
<h5 id="标准偏差（Standard-Deviation）"><a href="#标准偏差（Standard-Deviation）" class="headerlink" title="标准偏差（Standard Deviation）"></a>标准偏差（Standard Deviation）</h5><p>　标准差的概念，由<a href="https://zh.wikipedia.org/wiki/%E5%8D%A1%E5%B0%94%C2%B7%E7%9A%AE%E5%B0%94%E9%80%8A">卡尔·皮尔逊</a>引入到概率统计中，是测量<strong>离散程度</strong>最为常用的方法。公式是 $\sigma = \sqrt{\frac{ \sum_{i=1}^n(x_i - \bar x)^2 }n}$ = $\sqrt{\frac{ (x_1 - \bar x)^2 + (x_2 - \bar x)^2 + \ldots + (x_i - \bar x)^2 }n}$。该方法避免了负值的出现，并且能够保证得到的结果，具备和被测量数据一样的度量单位，方便进行比对</p>
<p>　标准差还可以用于判断数据集是否属于<a href="https://zh.wikipedia.org/wiki/%E5%B8%B8%E6%85%8B%E5%88%86%E4%BD%88">正态分布</a>。若其符合正态概率分布，则如下图所示，约<strong>68.3%</strong> 的数值会分布在距离 平均值$\bar x$ 的 1个 标准差$\sigma$ 范围之内，约<strong>95.4%</strong> 的数值分布在距离 平均值$\bar x$ 的 2个 标准差$\sigma$ 范围之内，以及 约<strong>99.73%</strong> 的数值分布在距离 平均值$\bar x$ 的 3个 标准差$\sigma$ 范围之内。这一现象我们称之为 “<strong>68-95-99.7法则</strong>” 或 “<strong>经验法则</strong>”</p>
<p><img data-src="/picture/ai/ai_standard_deviation_diagram.png" alt=""></p>
<center>（图片来源：<a href="https://zh.wikipedia.org/wiki/%E6%AD%A3%E6%80%81%E5%88%86%E5%B8%83" target="_blank">wikipedia.org</a>™，已确认无版权）</center>

<h5 id="贝塞尔校正"><a href="#贝塞尔校正" class="headerlink" title="贝塞尔校正"></a>贝塞尔校正</h5><p>　又因为样本抽选的数据，很容易落入平均值附近，导致低估了整体数据集的偏差。因此引入了贝塞尔校正，使得标准差的值变大，来更好地表达<strong>样本标准差</strong>（<strong>S</strong>ample <strong>S</strong>tandard <strong>D</strong>eviation）</p>
<p>　$s = \sqrt {\frac{ \sum_{i=1}^n(x_i - \bar x)^2 }{n - 1}}$</p>
<h3 id="回归分析"><a href="#回归分析" class="headerlink" title="回归分析"></a>回归分析</h3><h4 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h4><p>　<strong><a href="https://zh.wikipedia.org/zh-hans/迴歸分析">回归分析</a></strong>（<strong>R</strong>egression <strong>A</strong>nalysis）是一种确定两种或多个变量间相互依赖的定量关系的统计分析方法</p>
<h4 id="组成"><a href="#组成" class="headerlink" title="组成"></a>组成</h4><p>　包括未知参数 $\beta$（表示一个标量或者向量）、自变量 $X$ 和 因变量 $Y$<br>　回归模型则是将三者关联起来，表示为 $Y \approx f(X, \beta)$</p>
<h4 id="种类"><a href="#种类" class="headerlink" title="种类"></a>种类</h4><h5 id="分类方式"><a href="#分类方式" class="headerlink" title="分类方式"></a>分类方式</h5><p>　按照涉及的变量的多少，分为<strong>一元</strong>回归和<strong>多元</strong>回归分析<br>　按照因变量的多少，分为<strong>简单</strong>回归分析和<strong>多重</strong>回归分析<br>　按照自变量和因变量之间的关系类型，分为<strong>线性</strong>回归分析和<strong>非线性</strong>回归分析</p>
<h5 id="常见类型"><a href="#常见类型" class="headerlink" title="常见类型"></a>常见类型</h5><h6 id="一元线性回归"><a href="#一元线性回归" class="headerlink" title="一元线性回归"></a>一元线性回归</h6><p>　如果在回归分析中，只包括一个自变量和一个因变量，且二者的关系可用一条直线近似表示，这种回归分析称为<strong>一元线性回归分析</strong></p>
<h6 id="多重线性回归"><a href="#多重线性回归" class="headerlink" title="多重线性回归"></a>多重线性回归</h6><p>　如果回归分析中包括两个或两个以上的自变量，且自变量之间存在线性相关，则称为<strong>多重线性回归分析</strong></p>
<h6 id="多元线性回归"><a href="#多元线性回归" class="headerlink" title="多元线性回归"></a>多元线性回归</h6><p>　<strong>多元线性回归</strong>可表示为 $Y = a + b_1 X_1 + b_2 X_2 + e$，其中 $a$ 表示截距，$b$ 表示直线的斜率，$e$ 是误差项。多元线性回归可以根据给定的预测变量 $s$ 来预测目标变量的值</p>
<h2 id="微积分"><a href="#微积分" class="headerlink" title="微积分"></a>微积分</h2><h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><h4 id="增量"><a href="#增量" class="headerlink" title="增量"></a>增量</h4><p>　点 $(x_1, y_1)$ 移动到 点 $(x_2, y_2)$，其坐标的<strong>增量</strong>为 $\Delta x = x_2 - x_1$ 和 $\Delta y = y_2 - y_1$</p>
<h4 id="平行线-amp-垂直线"><a href="#平行线-amp-垂直线" class="headerlink" title="平行线 &amp; 垂直线"></a>平行线 &amp; 垂直线</h4><p>　斜率 $m$ = $\frac{ \Delta y }{ \Delta x }$，直线 $L_1$ 和 $L_2$ 的斜率分别记作 $m_1$ 和 $m_2$<br>　如果 $m_1 = m_2$，则 $L_1$ 与 $L_2$ <strong>平行</strong>或重合，记作 $L_1 \mid \mid L_2$；如果 $m_1m_2 = -1$，则两者互相<strong>垂直</strong>，记作 $L_1$ ⊥ $L_2$</p>
<h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h3><h4 id="定义-1"><a href="#定义-1" class="headerlink" title="定义"></a>定义</h4><p>　<strong>函数</strong>是将一个对象转化为另一个对象的规则 $f$。函数必须要给每个有效输入指定唯一的输出。这里我们输入的集合 $x$ 称之为<strong>定义域</strong>、输出的集合 $f(x)$ 称之为<strong>值域</strong></p>
<h5 id="常用集合"><a href="#常用集合" class="headerlink" title="常用集合"></a>常用集合</h5><p>　$Z$ 整数集，$N$ 非负数集，$Q$ 有理数集</p>
<h5 id="常用函数的定义域和值域"><a href="#常用函数的定义域和值域" class="headerlink" title="常用函数的定义域和值域"></a>常用函数的定义域和值域</h5><div class="table-container">
<table>
<thead>
<tr>
<th>函数</th>
<th>定义域</th>
<th>值域</th>
<th>图形</th>
</tr>
</thead>
<tbody>
<tr>
<td>$y = \frac{ 1 }{ x }$</td>
<td>$(-\infty, +\infty)$</td>
<td>$(-\infty, 0) \,\bigcup\, (0, +\infty)$</td>
<td><img data-src="/picture/ai/ai_math_1_of_x.png" alt=""></td>
</tr>
<tr>
<td>$y = \sqrt{x}$</td>
<td>$[0, +\infty)$</td>
<td>$[0, +\infty)$</td>
<td><img data-src="/picture/ai/ai_math_sqrt_x.png" alt=""></td>
</tr>
<tr>
<td>$y = x$</td>
<td>$(-\infty, +\infty)$</td>
<td>$(-\infty, +\infty)$</td>
<td><img data-src="/picture/ai/ai_math_x.png" alt=""></td>
</tr>
<tr>
<td>$y = x^2$</td>
<td>$(-\infty, +\infty)$</td>
<td>$[0, +\infty)$</td>
<td><img data-src="/picture/ai/ai_math_x_2.png" alt=""></td>
</tr>
<tr>
<td>$y = \sin(x)$</td>
<td>$(-\infty, +\infty)$</td>
<td>$[-1, 1]$</td>
<td><img data-src="/picture/ai/ai_math_sin_x.png" alt=""></td>
</tr>
<tr>
<td>$y = \cos(x)$</td>
<td>$(-\infty, +\infty)$</td>
<td>$[-1, 1]$</td>
<td><img data-src="/picture/ai/ai_math_cos_x.png" alt=""></td>
</tr>
<tr>
<td>$y = \tan(x)$</td>
<td>$(-\frac{ \pi }{ 2 } + 2k\pi,$ $\frac{ \pi }{ 2 } + 2k\pi)$, $k \in Z$</td>
<td>$(-\infty, +\infty)$</td>
<td><img data-src="/picture/ai/ai_math_tan_x.png" alt=""></td>
</tr>
</tbody>
</table>
</div>
<center>（使用 <a href="https://www.intmath.com/functions-and-graphs/graphs-using-svg.php" target="_blank">intmath.com</a> 绘制而成）</center>




<h4 id="反函数"><a href="#反函数" class="headerlink" title="反函数"></a>反函数</h4><p>　对于 $y = f(x)$，如果将其逆转变换后，仍然满足 $f(x) = y$，则称新函数为 $f$ 的<strong>反函数</strong>，并记作 $f^{-1}$</p>
<h4 id="函数复合"><a href="#函数复合" class="headerlink" title="函数复合"></a>函数复合</h4><p>　$f(x) = h(g(x)) = h \circ g$</p>
<h4 id="奇偶性"><a href="#奇偶性" class="headerlink" title="奇偶性"></a>奇偶性</h4><h5 id="奇函数"><a href="#奇函数" class="headerlink" title="奇函数"></a>奇函数</h5><p>　$f(x) = -f(-x)$</p>
<h5 id="偶函数"><a href="#偶函数" class="headerlink" title="偶函数"></a>偶函数</h5><p>　$f(x) = f(-x)$</p>
<h4 id="线性函数"><a href="#线性函数" class="headerlink" title="线性函数"></a>线性函数</h4><p>　$f(x) = mx + b$</p>
<h5 id="点斜式"><a href="#点斜式" class="headerlink" title="点斜式"></a>点斜式</h5><p>　直线通过一个点 $(x_0, y_0)$，斜率为 $m$，则方程可表示为 $y - y_0 = m (x - x_0)$<br>　直线通过两个点 $(x_1, y_1)$ 和 $(x_2, y_2)$，则斜率为 $m$ = $\frac{ y_2 - y_1 }{ x_2 - x_1 }$ = $\frac{ \Delta y }{ \Delta x }$，则方程式表示为 $y - y_1$= $\frac{ \Delta y }{ \Delta x }$ $(x - x_1)$<br>　已知斜率 $m$ 和截距 $b$，可以直接求得直线方程式 $y = m(x - 0) + b = mx + b$</p>
<h4 id="多项式"><a href="#多项式" class="headerlink" title="多项式"></a>多项式</h4><p>　$p(x)$ = $a_nx^n + \ldots + a_2x^2 + a_1x + a_0$</p>
<h4 id="二次函数"><a href="#二次函数" class="headerlink" title="二次函数"></a>二次函数</h4><p>　<strong>二次函数</strong>是一个最高次为 $2$ 的多项式，表示为 $p(x) = ax^2 + bx + c$</p>
<p>　依据 $\Delta = b^2 - 4ac$ 判别式，可知：</p>
<ul>
<li>当 $\Delta \gt 0$ 时，$p(x)$ 有<strong>两个不同解</strong>，且解为 $\frac{ -b \pm \sqrt{b^2 - 4ac} }{ 2a }$；</li>
<li>当 $\Delta = 0$ 时，$p(x)$ 有两个相同的解，即<strong>只有一个解</strong>；</li>
<li>当 $\Delta \lt 0$ 时，$p(x)$ <strong>无解</strong></li>
</ul>
<h5 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h5><h6 id="求解-3x-2-5x-7-0"><a href="#求解-3x-2-5x-7-0" class="headerlink" title="求解 $3x^2 -5x + 7 = 0$"></a>求解 $3x^2 -5x + 7 = 0$</h6><p>　因为 $\Delta = (-5)^2 - 4 \cdot 3 \cdot 7$ $= -59 \lt 0$，所有该方程无解</p>
<p>　可以将方程拆解组合，进行证明：</p>
<script type="math/tex; mode=display">
3(x^2 - \frac{ 5 }3x + \frac{ 7 }3) = 0</script><script type="math/tex; mode=display">
x^2 - \frac{ 5 }3x + \frac{ 7 }3 = 0</script><script type="math/tex; mode=display">
x^2 - \frac{ 5 }3x + \frac{ 25 }{ 36 } + \frac{ 7 }3 - \frac{ 25 }{ 36 } = 0</script><script type="math/tex; mode=display">
(x - \frac{ 5 }6)^2 + \frac{ 59 }{ 36 } = 0</script><script type="math/tex; mode=display">
(x - \frac{ 5 }6)^2 = - \frac{ 59 }{ 36 }</script><p>　可见等式左边是恒为非负数的，因此，是不可能存在 $x$ 使等式成立的，即方程无解</p>
<h4 id="有理函数"><a href="#有理函数" class="headerlink" title="有理函数"></a>有理函数</h4><p>　若 $p$ 和 $q$ 均为多项式，则形如 $\frac{ p(x) }{ q(x) }$ 的函数，我们称之为 <strong>有理函数</strong></p>
<h4 id="指数函数"><a href="#指数函数" class="headerlink" title="指数函数"></a>指数函数</h4><p>　$y = a^x$</p>
<h4 id="对数函数"><a href="#对数函数" class="headerlink" title="对数函数"></a>对数函数</h4><p>　将 指数函数 以 $y = x$ 做镜像，则得到 $y = \log_a(x)$ 指数函数</p>
<h4 id="带绝对值的函数"><a href="#带绝对值的函数" class="headerlink" title="带绝对值的函数"></a>带绝对值的函数</h4><script type="math/tex; mode=display">
f(|x|) = 
\begin{cases}
f(x), x \geq 0 \\
f(-x), x \lt 0
\end{cases}</script><h3 id="求导"><a href="#求导" class="headerlink" title="求导"></a>求导</h3><h4 id="分数求导"><a href="#分数求导" class="headerlink" title="分数求导"></a>分数求导</h4><p>　$f(x) = \frac{ g(x) }{ h(x) }$ 的导数为 $f^\prime(x) = \frac{ g^\prime(x)h(x)-h^\prime(x)g(x) }{ h(x)^2 }$</p>
<h4 id="复合函数求导"><a href="#复合函数求导" class="headerlink" title="复合函数求导"></a><a href="https://zh.wikipedia.org/wiki/%E9%93%BE%E5%BC%8F%E6%B3%95%E5%88%99">复合函数</a>求导</h4><p>　$(f \circ g)(x)$ 的导数为 $(f \circ g)^\prime(x) = f^\prime(g(x))g^\prime(x)$</p>
<h3 id="极限"><a href="#极限" class="headerlink" title="极限"></a>极限</h3><h4 id="定义-2"><a href="#定义-2" class="headerlink" title="定义"></a>定义</h4><h5 id="邻域"><a href="#邻域" class="headerlink" title="邻域"></a>邻域</h5><p>　以点 $x_0$ 为中心的任何开区间，称之为点 $x_0$ 的邻域，记做 $U(x_0)$</p>
<ul>
<li><p>$\delta$ 邻域</p>
<p>设 $\delta$ 为正数，则称开区间 $(x_0 - \delta, \, x_0 + \delta)$ 为点 $x_0$ 的 $\delta$ 邻域，记做 $U(x_0, \, \delta)$ = $\{x \mid x_0 - \delta \lt x \lt x_0 + \delta\}$。其中，点 $x_0$ 称为邻域的中心，$\delta$ 为邻域的半径</p>
</li>
<li><p>$\delta$ 去心邻域</p>
<p>$\mathring{U}(x_0, \delta)$ = $\{ x \mid 0 \lt \mid x - x_0 \mid \lt \delta \}$</p>
</li>
</ul>
<ul>
<li><p>二维 $\delta$ 邻域</p>
<p>设 $P_0(x_0, \, y_0)$ 为 $xOy$ 平面上的一个点，$\delta$ 为某个正数，与点 $P_0(x_0, \, y_0)$ 距离小于 $\delta$ 的点 $P(x, \, y)$ 的全体，称之为点 $P_0$ 的 $\delta$ 邻域，记做 $U(P_0, \delta)$ = $\{ x \mid \sqrt{(x - x_0)^2 + (y - y_0)^2} \lt \delta \}$</p>
</li>
</ul>
<h5 id="函数极限"><a href="#函数极限" class="headerlink" title="函数极限"></a>函数极限</h5><p>　设函数 $f(x)$ 在点 $x_0$ 的某一去心邻域内有定义，若存在常数 $A$，对于任意给定的 $\epsilon \gt 0$（无论 $\epsilon$ 有多小），总存在正数 $\delta$，使得当 $0 \lt \mid x - x_0 \mid \lt \delta$ 时，对应函数的值 $f(x)$ 都满足不等式 $\mid f(x) - A \mid \lt \epsilon$，则 $A$ 就叫做函数 $f(x)$ 当 $x \to x_0$ 的极限，记做 $\lim_{x \to x_0}f(x)=A$，或 $f(x) \to A$（当 $x \to x_0$）</p>
<p>　换一种说法是，$\lim_{x \to x_0}f(x) = A \Leftrightarrow \forall \epsilon \gt 0$，$\exists \delta \gt 0$，当 $0 \lt \mid x - x_0 \mid \lt \delta$ 时，$\mid f(x) - A \mid \lt \epsilon$</p>
<h2 id="线性代数"><a href="#线性代数" class="headerlink" title="线性代数"></a>线性代数</h2><h3 id="基本概念-1"><a href="#基本概念-1" class="headerlink" title="基本概念"></a>基本概念</h3><h4 id="行列式"><a href="#行列式" class="headerlink" title="行列式"></a><a href="https://zh.wikipedia.org/wiki/%E8%A1%8C%E5%88%97%E5%BC%8F">行列式</a></h4><p>　<strong>行列式</strong>（<strong>D</strong>eterminant）是数学中的一个将 $n \cdot n$ 的矩阵 $A$ 映射到一个<a href="https://zh.wikipedia.org/wiki/%E7%B4%94%E9%87%8F">标量</a>的函数，记作 $det(A)$ 或 $\mid A \mid$。行列式可以看做是有向面积或体积的概念，在欧几里得空间中的推广。或者说，在 $n$ 维欧几里得空间中，行列式描述的是一个<strong>线性变换</strong>对体积所造成的影响</p>
<h4 id="单位矩阵"><a href="#单位矩阵" class="headerlink" title="单位矩阵"></a>单位矩阵</h4><p>　<strong>单位矩阵</strong> 是主对角线为 $1$，其余元素为 $0$ 的方形矩阵，记作 $I$ 或 $E$</p>
<p>$I_n = \begin{bmatrix} 1 &amp; 0 &amp; \cdots &amp; 0 \\ 0 &amp; 1 &amp; \cdots &amp; 0 \\ \vdots &amp; \vdots &amp; \ddots &amp; \vdots \\ 0 &amp; 0 &amp; \cdots &amp; 1 \\ \end{bmatrix}$</p>
<h4 id="初等矩阵"><a href="#初等矩阵" class="headerlink" title="初等矩阵"></a>初等矩阵</h4><p>　<strong>初等矩阵</strong>（又称为<strong>基本矩阵</strong>）是由一个 $n$ 阶单位矩阵 $E$，经过一次<strong>初等行列变换</strong>所得的矩阵。我们称之为 $n$ 阶初等矩阵</p>
<h4 id="增广矩阵"><a href="#增广矩阵" class="headerlink" title="增广矩阵"></a><a href="https://zh.wikipedia.org/zh-hans/%E5%A2%9E%E5%B9%BF%E7%9F%A9%E9%98%B5">增广矩阵</a></h4><p>　<strong>增广矩阵</strong>是由系数矩阵的右边，添上线性方程组等号右边的常数列 得到的矩阵<br>　方程 $AX=b$ 系数矩阵为 $A$，常数列为 $b$，则它的增广矩阵表示为 $(A \mid b)$，形式如下</p>
<script type="math/tex; mode=display">
(A \mid b) = 
\left[
\begin{array}{cc|c}
1 & 0 & 1 \\
0 & 1 & 1
\end{array}
\right]</script><p>　通过对增广矩阵进行初等行变换，可判断线性方程组是否有解，以及化简原方程组，方便求解</p>
<h3 id="实用技巧-1"><a href="#实用技巧-1" class="headerlink" title="实用技巧"></a>实用技巧</h3><h4 id="消元法"><a href="#消元法" class="headerlink" title="消元法"></a>消元法</h4><h4 id="高斯-约当（Gauss-Jordan）消元法"><a href="#高斯-约当（Gauss-Jordan）消元法" class="headerlink" title="高斯-约当（Gauss-Jordan）消元法"></a><a href="https://zh.wikipedia.org/zh-hans/%E9%AB%98%E6%96%AF-%E8%8B%A5%E7%88%BE%E7%95%B6%E6%B6%88%E5%85%83%E6%B3%95">高斯-约当</a>（Gauss-Jordan）消元法</h4><p>　直接上一个例子，会比较直观一些</p>
<script type="math/tex; mode=display">
\left[
\begin{array}{ccc|c}
3 & 7 & 1 & 1 \\
1 & 1 & -6 & 0 \\
2 & 6 & 7 & 1
\end{array}
\right]</script><script type="math/tex; mode=display">
\require{AMScd}\begin{CD}
@>{R_1 - R_2 - R_3, \, R_1 \longleftrightarrow R_3}>>
\end{CD}</script><script type="math/tex; mode=display">
\left[
\begin{array}{ccc|c}
2 & 6 & 7 & 1 \\
1 & 1 & -6 & 0 \\
0 & 0 & 0 & 0
\end{array}
\right]</script><script type="math/tex; mode=display">
\require{AMScd}\begin{CD}
@>{R_1 \longleftrightarrow R_2, \, R_2 - 2R_1, \, 1/4R_2}>>
\end{CD}</script><script type="math/tex; mode=display">
\left[
\begin{array}{ccc|c}
1 & 1 & -6 & 0 \\
0 & 1 & 19/4 & 1/4 \\
0 & 0 & 0 & 0
\end{array}
\right]</script><script type="math/tex; mode=display">
\require{AMScd}\begin{CD}
@>{R_1 - R_2}>>
\end{CD}</script><script type="math/tex; mode=display">
\left[
\begin{array}{ccc|c}
1 & 0 & -43/4 & -1/4 \\
0 & 1 & 19/4 & 1/4 \\
0 & 0 & 0 & 0
\end{array}
\right]</script><p>　化简到上三角形式方程组后，就可以一眼看出，当自由列取值为 $0$ 时，能得到一个特解：</p>
<script type="math/tex; mode=display">
\left[
\begin{matrix}
-1/4 \\
1/4 \\
0
\end{matrix}
\right]</script><h4 id="克拉默法则（Gramer´s-Rule）"><a href="#克拉默法则（Gramer´s-Rule）" class="headerlink" title="克拉默法则（Gramer´s Rule）"></a><a href="https://zh.wikipedia.org/wiki/%E5%85%8B%E8%90%8A%E5%A7%86%E6%B3%95%E5%89%87">克拉默法则</a>（Gramer´s Rule）</h4><script type="math/tex; mode=display">
给定 \, f(x) = 
\begin{cases}
a_{11}x_1 + a_{12}x_2 = b_1 \\
a_{21}x_1 + a_{22}x_2 = b_2
\end{cases} 方程组，</script><p>　可以通过消元代入法，得到 $x_1 = \frac{ b_1a_{22} - b_2a_{12} }{a_{11}a_{22} - a_{12}a_{21}}$，$x_2 = \frac{b_2a_{11} - b_1a_{21}}{a_{11}a_{22} - a_{12}a_{21}}$，换成行列式表达式形式，则可表示为</p>
<script type="math/tex; mode=display">
x_1 = 
\frac{
  \begin{vmatrix}
  b_1 & a_{12} \\
  b_2 & a_{22}
\end{vmatrix}}
{
  \begin{vmatrix}
  a_{11} & a_{12} \\
  a_{21} & a_{22}
  \end{vmatrix}
}，
x_2 = 
\frac{
  \begin{vmatrix}
  a_{11} & b_1 \\
  b_{21} & b_2
\end{vmatrix}}
{
  \begin{vmatrix}
  a_{11} & a_{12} \\
  a_{21} & a_{22}
  \end{vmatrix}
}</script><h2 id="概率论"><a href="#概率论" class="headerlink" title="概率论"></a>概率论</h2><h3 id="集合"><a href="#集合" class="headerlink" title="集合"></a>集合</h3><p>　将一些研究对象放在一起，形成<strong>集合</strong>，而这些对象就称为集合的元素</p>
<h3 id="概率模型"><a href="#概率模型" class="headerlink" title="概率模型"></a>概率模型</h3><p>　<strong>概率模型</strong>是对不确定现象的一种数学描述</p>
<h4 id="主要构成"><a href="#主要构成" class="headerlink" title="主要构成"></a>主要构成</h4><h5 id="样本空间"><a href="#样本空间" class="headerlink" title="样本空间"></a>样本空间</h5><p>　用 $\Omega$ 表示一个试验中所有可能结果的集合</p>
<h5 id="概率律"><a href="#概率律" class="headerlink" title="概率律"></a>概率律</h5><p>　用一个非负数 $P(A)$ 表示某一个事件 $A$ 在试验结果中出现的概率</p>
<h6 id="公理"><a href="#公理" class="headerlink" title="公理"></a>公理</h6><ul>
<li><strong>非负性</strong><br>对于一切事件 $A$，满足 $P(A) \geq 0$</li>
<li><strong>可加性</strong><br>对于 $A_1, A_2, \ldots, A_n$ 互不相交的集合，满足 $P(A_1 \bigcup A_2 \bigcup \ldots \bigcup A_n)$ = $P(A_1) + P(A_2) + \ldots + P(A_n)$</li>
<li><strong>归一化</strong><br>$P(\Omega) = 1$<br>综合推导，可得 $P(\emptyset)$ = $1- P(\Omega) + P(\emptyset)$ = $1 - P(\Omega \bigcup \emptyset)$ = $1 - P(\Omega) = 0$</li>
</ul>
<h6 id="性质"><a href="#性质" class="headerlink" title="性质"></a>性质</h6><ul>
<li>若 $A \subset B$，则 $P(A) \leq P(B)$</li>
<li>$P(A \bigcup B)$ = $P(A) + P(B) - P(A \bigcap B)$</li>
<li>$P(A \bigcup B)$ $\leq$ $P(A) + P(B)$</li>
<li>由上式推广，可得 $P(A_1 \bigcup A_2 \bigcup \ldots \bigcup A_n)$ $\leq \sum_{i=1}^nP(A_i)$</li>
<li>$P(A \bigcup B \bigcup C)$ = $P(A) + P(A^c \bigcap B)$ $+ P(A^c \bigcap B^c \bigcap C)$</li>
</ul>
<h2 id="技术发展史"><a href="#技术发展史" class="headerlink" title="技术发展史"></a>技术发展史</h2><h3 id="机器学习发展总图"><a href="#机器学习发展总图" class="headerlink" title="机器学习发展总图"></a>机器学习发展总图</h3><div class="note info">To be continued...</div>



<h3 id="深度学习发展总图"><a href="#深度学习发展总图" class="headerlink" title="深度学习发展总图"></a>深度学习发展总图</h3><pre class="mermaid">graph TD
start[Start] --&gt; nerve_cell(生物神经元)
nerve_cell --&gt; mp_model(MP 模型)
mp_model --&gt; weight{自主学习权重}
weight --&gt; |No| non_perceptron[参数权重需要人为设定]
weight --&gt; |Yes| perceptron(感知器)
perceptron --&gt; bp{BP 反向传播}
bp --&gt; |No| non_mlp[无法解决最简单的线性不可分问题]
bp --&gt; |Yes| mlp(多层感知器)
mlp --&gt; pre_train{预训练 + 激活函数}
pre_train --&gt; |No| no_dnn[局部最优解 + 指数梯度衰减]
pre_train --&gt; |Yes| dnn(深度神经网络)
dnn --&gt; kernal{卷积核}
kernal --&gt; |No| non_cnn[过拟合 + 运算时间成本高]
kernal --&gt; |Yes| cnn(卷积神经网络)
cnn --&gt; directed{神经元间链成有向图}
directed --&gt; |No| non_rnn[无法对事件序列建模]
directed --&gt; |Yes| rnn(递归神经网络)
rnn --&gt; cell{细胞状态}
cell --&gt; |No| non_lstm[无法捕获间隔太长的事件间关系]
cell --&gt; |Yes| lstm(长短期记忆网络)
lstm --&gt; e[End?]</pre>



<h4 id="麦卡洛克-皮茨神经元模型（McCulloch-Pitts-Neuron-Model）"><a href="#麦卡洛克-皮茨神经元模型（McCulloch-Pitts-Neuron-Model）" class="headerlink" title="麦卡洛克-皮茨神经元模型（McCulloch - Pitts Neuron Model）"></a>麦卡洛克-皮茨神经元模型（McCulloch - Pitts Neuron Model）</h4><p>　<strong>麦卡洛克-皮茨神经元模型</strong>（<strong>M</strong>cCulloch - <strong>P</strong>itts Neuron <strong>Model</strong>）是模仿生物学神经元功能的简单线性模型，由心理学家 Warren McCulloch 和 数学家 Walter Pitts 在 1943 年提出。该模型针对输入的 $x_1, x_2, \dots, x_n$，分别赋予不同的权重 $w_1, w_2, \dots, w_n$，形成 $f(x, w) = \sum_{i = 1}^nx_iw_i$ 检验函数用以模仿生物神经元的<strong>膜电位</strong>，再通过 $o_j(t + 1)$ = $f\{[\sum_{i=1}^nw_{ij}x_i(t)] - T_j\}$ 模仿在每个 $t$ 时刻<strong>神经元细胞的输出</strong>（信号空间的求和与神经元阀值 $T_j$ 差值的正负），完成分类。同时 MP 模型也存在不足之处，即权重需要人为给定，一旦权重分配不合理，将无法得出期望的分类结果</p>
<h4 id="感知器（Perceptron）"><a href="#感知器（Perceptron）" class="headerlink" title="感知器（Perceptron）"></a>感知器（<a href="https://zh.wikipedia.org/wiki/%E6%84%9F%E7%9F%A5%E5%99%A8">Perceptron</a>）</h4><p>　<strong>感知器</strong>（<strong>P</strong>erceptron）是 Frank Rosenblatt 在 1957 年就职于 Cornell 航空实验室（Cornell Aeronautical Laboratory）时所发明的一种<a href="https://zh.wikipedia.org/wiki/%E4%BA%BA%E5%B7%A5%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C">人工神经网络</a>。它可以被视为一种最简单形式的<a href="https://zh.wikipedia.org/wiki/%E5%89%8D%E9%A6%88%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C">前馈神经网络</a>，是一种二元<a href="https://zh.wikipedia.org/wiki/%E7%BA%BF%E6%80%A7%E5%88%86%E7%B1%BB%E5%99%A8">线性分类器</a>。感知器，解决了 MP 模型的无法自主学习的问题，成为第一个能根据每个类别的输入样本来学习权重的模型。此外，Frank Rosenblatt 给出了相应的感知器学习算法，常用的有 感知器学习、最小二乘法和梯度下降法。譬如，感知器利用梯度下降法对损失函数进行极小化，求出可将训练数据进行线性划分的分离超平面，从而求得感知器模型。感知器也被称为 单层人工神经网络，以区别于较复杂的<a href="https://zh.wikipedia.org/wiki/%E5%A4%9A%E5%B1%82%E6%84%9F%E7%9F%A5%E6%9C%BA">多层感知器</a>（<strong>M</strong>ulti<strong>l</strong>ayer <strong>P</strong>erceptron）。尽管结构简单，感知器却能学习并解决相当复杂的问题。不过，感知器存在本质上的缺陷，就是无法处理<a href="http://blog.csdn.net/puqutogether/article/details/41309745">线性不可分</a>问题</p>
<h4 id="多层感知器（MLP-Multilayer-Perceptron）"><a href="#多层感知器（MLP-Multilayer-Perceptron）" class="headerlink" title="多层感知器（MLP, Multilayer Perceptron）"></a>多层感知器（MLP, Multilayer Perceptron）</h4><p>　<strong>多层感知器</strong>（<strong>MLP</strong>, <strong>M</strong>ulti<strong>l</strong>ayer <strong>P</strong>erceptron）是一种<a href="https://zh.wikipedia.org/wiki/%E5%89%8D%E9%A6%88%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C">前馈神经网络</a>（Feedforward Neural Network），映射一组输入向量到一组输出向量。MLP 可以被看作是一个有向图，由多个的节点层所组成，每一层都全连接到下一层。除了输入节点，每个节点都是一个带有非线性<a href="https://zh.wikipedia.org/wiki/%E6%BF%80%E6%B4%BB%E5%87%BD%E6%95%B0">激活函数</a>的神经元（或称处理单元）。另外，MLP 是（单层）<a href="https://zh.wikipedia.org/wiki/%E6%84%9F%E7%9F%A5%E5%99%A8">感知器</a>的推广，摆脱了早期离散传输函数的束缚，使用 激活函数（Sigmoid / Tanh / ReLU / …）模拟神经元对激励的响应，在训练算法上则使用<a href="https://zh.wikipedia.org/wiki/%E5%8F%8D%E5%90%91%E4%BC%A0%E6%92%AD%E7%AE%97%E6%B3%95">反向传播算法</a>，解决了感知器不能对<a href="https://www.zhihu.com/question/27210162">线性不可分</a>数据进行处理的问题</p>
<h4 id="深度神经网络（DNN-Deep-Neural-Networks）"><a href="#深度神经网络（DNN-Deep-Neural-Networks）" class="headerlink" title="深度神经网络（DNN, Deep Neural Networks）"></a>深度神经网络（<a href="https://zh.wikipedia.org/wiki/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0#.E6.B7.B1.E5.BA.A6.E7.A5.9E.E7.BB.8F.E7.BD.91.E7.BB.9C">DNN</a>, Deep Neural Networks）</h4><p>　<strong>深度神经网络</strong>（<strong>DNN</strong>, <strong>D</strong>eep <strong>N</strong>eural <strong>N</strong>etworks）是一种<a href="https://zh.wikipedia.org/wiki/%E5%88%A4%E5%88%AB%E6%A8%A1%E5%9E%8B">判别模型</a>，可以使用<a href="https://zh.wikipedia.org/wiki/%E5%8F%8D%E5%90%91%E4%BC%A0%E6%92%AD%E7%AE%97%E6%B3%95">反向传播算法</a>进行训练。DNN 通过 “预训练” 和 “ReLU、Maxout 等激活函数” 解决了 多层感知器 中的 “局部最优解” 和 “<a href="http://www.cnblogs.com/maybe2030/p/6336896.html#_label2">梯度衰减</a>” 问题。不过，与其他神经网络模型类似，如果仅仅是简单地训练，深度神经网络可能会存在很多问题。常见的两类问题是<a href="https://zh.wikipedia.org/wiki/%E8%BF%87%E6%8B%9F%E5%90%88">过拟合</a>（Overfiting）和过长的运算时间</p>
<p>　因为增加了隐藏层，会使得模型对训练数据中较为罕见的依赖关系进行建模，所以深度神经网络很容易出现<strong>过拟合</strong>现象。对此，可以利用 <strong>稀疏</strong>（$L_1$ 正则化）或者 <strong>权重递减</strong>（$L_2$ 正则化） 等方法在训练过程中减少过拟合现象。另外，还有一种叫做丢弃法（Dropout）的正则化方法，即在训练中随机<strong>丢弃一部分隐层单元</strong>，来避免对较为罕见的依赖进行建模</p>
<p>　<strong>反向传播算法</strong>和<strong>梯度下降法</strong>由于其实现简单，并且相比其他方法，能够收敛到更好的局部最优值，因而成为神经网络训练的通行方法。但是，这些方法的计算代价很高，尤其是在训练 DNN 时，因为其规模（即层数和每层的节点数）、学习率、初始权重等众多参数都需要考虑。考虑到<strong>时间代价</strong>，想要扫描所有的参数是不可行的，因而考虑将多个训练样本组合进行 <strong>小批量训练</strong>（mini-batching），而非每次只使用一个样本进行训练，从而加速模型训练。而最显著地速度提升来自 GPU，因为矩阵和向量计算非常适合使用 GPU 实现。但使用大规模集群进行 DNN 训练仍然存在瓶颈，因而在并行化方面仍有很大的提升空间</p>
<h4 id="卷积神经网络（CNN-Convolutional-Neural-Network）"><a href="#卷积神经网络（CNN-Convolutional-Neural-Network）" class="headerlink" title="卷积神经网络（CNN, Convolutional Neural Network）"></a>卷积神经网络（CNN, Convolutional Neural Network）</h4><p>　<strong>卷积神经网络</strong>（<strong>CNN</strong>, <strong>C</strong>onvolutional <strong>N</strong>eural <strong>N</strong>etwork）是一种<a href="https://zh.wikipedia.org/wiki/%E5%89%8D%E9%A6%88%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C">前馈神经网络</a>，由哈弗医学院生理学家 Hubel 和 Wiesel 通过对猫视觉皮层细胞的研究，在 1962 年提出了<strong>感受野</strong>（Receptive Field）的概念，随后在 1984 年日本学者 Fukushima 基于 RF 的概念，设计出了神经感知机（Neocognitron）。其人工神经元可以响应一部分覆盖范围内的周围单元，对于图像处理和语音识别有着出色的表现</p>
<p>　卷积神经网络由一个或多个卷积层和顶端的全连通层（对应经典的神经网络）组成，同时也包括关联权重和池化层（Pooling Layer）。这一结构使得 CNN 能够利用输入数据的二维结构，也可以使用<a href="https://zh.wikipedia.org/wiki/%E5%8F%8D%E5%90%91%E4%BC%A0%E6%92%AD%E7%AE%97%E6%B3%95">反向传播算法</a>进行训练。相比较其他的前馈神经网络，CNN 通过<strong>卷积核</strong>控制只在同一个核内的神经元进行全连接，使得需要估计的参数很少，从而在根本上解决了 DNN 的<strong>参数膨胀</strong>的问题。但是，CNN 仍然存在无法对时间序列进行建模的缺陷</p>
<h4 id="递归神经网络（RNN-Recurrent-Neural-Networks）"><a href="#递归神经网络（RNN-Recurrent-Neural-Networks）" class="headerlink" title="递归神经网络（RNN, Recurrent Neural Networks）"></a>递归神经网络（<a href="https://zh.wikipedia.org/zh-hans/%E9%80%92%E5%BD%92%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C">RNN</a>, Recurrent Neural Networks）</h4><p>　<strong>递归神经网络</strong>（<strong>RNN</strong>, <strong>R</strong>ecurrent <strong>N</strong>eural <strong>N</strong>etworks）是两种<a href="https://zh.wikipedia.org/wiki/%E4%BA%BA%E5%B7%A5%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C">人工神经网络</a>的总称。一种是<strong>时间递归神经网络</strong>（Recurrent Neural Network），另一种是<strong>结构递归神经网络</strong>（Recursive Neural Network）。前者的神经元间连接构成<a href="https://zh.wikipedia.org/wiki/%E6%9C%89%E5%90%91%E5%9B%BE">有向图</a>，而后者利用相似的 神经网络结构 递归构造更为复杂的深度网络。RNN 一般指代 时间递归神经网络。单纯递归神经网络因为无法处理随着递归，权重指数级爆炸或消失的问题（Vanishing Gradient Problem），所以难以捕捉长期时间的关联；而结合不同变种的 <strong>LSTM</strong> 网络 可以很好解决这个问题</p>
<h4 id="长短期记忆网络（LSTM-Long-Short-Term-Memory-Networks）"><a href="#长短期记忆网络（LSTM-Long-Short-Term-Memory-Networks）" class="headerlink" title="长短期记忆网络（LSTM, Long Short Term Memory Networks）"></a>长短期记忆网络（<a href="https://zh.wikipedia.org/wiki/%E9%95%B7%E7%9F%AD%E6%9C%9F%E8%A8%98%E6%86%B6">LSTM</a>, <a href="http://colah.github.io/posts/2015-08-Understanding-LSTMs/">Long Short Term Memory Networks</a>）</h4><p>　<strong>长短期记忆</strong>（<strong>LSTM</strong>, <strong>L</strong>ong <strong>S</strong>hort <strong>T</strong>erm <strong>M</strong>emory <strong>N</strong>etworks）是 <a href="https://zh.wikipedia.org/wiki/%E9%80%92%E5%BD%92%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C">时间递归神经网络</a>（RNN） 的一种，论文首次发表于 1997 年。由于巧妙的设计结构，LSTM 适合于处理和预测<a href="https://zh.wikipedia.org/wiki/%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97">时间序列</a>中间隔和延迟非常长的重要事件。因为 时间递归神经网络 和 <a href="https://zh.wikipedia.org/wiki/%E5%89%8D%E9%A6%88%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C">前馈神经网络</a>（Feedforward Neural Network）接受较特定结构的输入不同，RNN 将状态（Cell State） 在自身网络中循环传递，使得 LSTM 可以接受更广泛的<a href="https://zh.wikipedia.org/wiki/%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97">时间序列</a>结构的输入，进而更好地描述动态时间行为</p>
<p>　一般的，LSTM 的表现会比 <a href="https://zh.wikipedia.org/wiki/%E9%80%92%E5%BD%92%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C">时间递归神经网络</a>（RNN）及<a href="https://zh.wikipedia.org/wiki/%E9%9A%90%E9%A9%AC%E5%B0%94%E7%A7%91%E5%A4%AB%E6%A8%A1%E5%9E%8B">隐马尔科夫模型</a>（HMM）更好，比如用在不分段连续<a href="https://zh.wikipedia.org/wiki/%E6%89%8B%E5%86%99%E8%AF%86%E5%88%AB">手写识别</a>上。在 2009 年，用 LSTM 构建的人工神经网络模型就赢过了 ICDAR 手写识别比赛冠军。同时，LSTM 还普遍应用于自主<a href="https://zh.wikipedia.org/wiki/%E8%AF%AD%E9%9F%B3%E8%AF%86%E5%88%AB">语音识别</a>，2013 年运用 <a href="https://en.wikipedia.org/wiki/TIMIT">TIMIT</a> 自然演讲数据库达成 17.7% 错误率的纪录。而作为<a href="https://zh.wikipedia.org/wiki/%E9%9D%9E%E7%BA%BF%E6%80%A7">非线性</a>模型，LSTM 又可当作复杂的非线性单元用于构造更庞大的<a href="https://zh.wikipedia.org/wiki/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0">深度神经网络</a></p>
<h2 id="机器学习"><a href="#机器学习" class="headerlink" title="机器学习"></a>机器学习</h2><p>　其实将机器学习和深度学习分为两个章节来讲，会容易让人产生错觉，误以为机器学习和深度学习是两个不相干的领域。实际上，后者只是前者的一个子集。针对两者关系，更详细的描述可以参见后面 “<a href="https://yuzhouwan.com/posts/42737/#AI-到底是什么">AI 到底是什么</a>” 部分</p>
<h3 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h3><h4 id="分类与回归"><a href="#分类与回归" class="headerlink" title="分类与回归"></a>分类与回归</h4><p>　机器学习任务中，预测值为<strong>离散</strong>类型的，则称该任务为<strong>分类</strong>任务（Classification）；反之，预测值为<strong>连续</strong>类型的，则称该任务为<strong>回归</strong>任务（Regression）</p>
<h3 id="贝叶斯定理"><a href="#贝叶斯定理" class="headerlink" title="贝叶斯定理"></a><a href="https://zh.wikipedia.org/wiki/%E8%B4%9D%E5%8F%B6%E6%96%AF%E5%AE%9A%E7%90%86">贝叶斯定理</a></h3><h4 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h4><script type="math/tex; mode=display">P(B \mid A) = \frac{P(B)\,P(A \mid B)}{P(A)}</script><p>　其中，$P(A \mid B)$ 是在 $B$ 发生的情况下 $A$ 发生的可能性，称为 $A$ 的<a href="https://zh.wikipedia.org/wiki/%E5%90%8E%E9%AA%8C%E6%A6%82%E7%8E%87">后验概率</a>。相应的，$P(B \mid A)$ 则称为 $B$ 后验概率；$P(A)$ 是不考虑任何 $B$ 方面的因素下 $A$ 发生的可能性，称为 $A$ 的<a href="https://zh.wikipedia.org/wiki/%E5%85%88%E9%AA%8C%E6%A6%82%E7%8E%87">先验概率</a>（或<a href="https://zh.wikipedia.org/wiki/%E8%BE%B9%E7%BC%98%E6%A6%82%E7%8E%87">边缘概率</a>）。相应的，$P(B)$ 则称为 $B$ 的先验概率</p>
<h4 id="种类-1"><a href="#种类-1" class="headerlink" title="种类"></a>种类</h4><h5 id="特征独立性"><a href="#特征独立性" class="headerlink" title="特征独立性"></a>特征独立性</h5><p>　按照特征之间<strong>独立性</strong>的强弱，可以分为 <a href="https://zhuanlan.zhihu.com/p/25097242">朴素贝叶斯</a>、半朴素贝叶斯、（一般的）贝叶斯 等</p>
<h5 id="分布情况"><a href="#分布情况" class="headerlink" title="分布情况"></a>分布情况</h5><p>　按照属性和特征的<strong>分布</strong>情况，又可以分为 高斯贝叶斯、多项式贝叶斯、伯努利贝叶斯 等</p>
<h5 id="离散程度"><a href="#离散程度" class="headerlink" title="离散程度"></a>离散程度</h5><p>　按照训练集的<strong>离散</strong>程度，还可以分为 离散型贝叶斯、连续型贝叶斯、混合型贝叶斯 等</p>
<h4 id="编码实战"><a href="#编码实战" class="headerlink" title="编码实战"></a>编码实战</h4><p>　The set <code>A</code> contains 30 <code>a</code> and 10 <code>b</code>, and the set <code>B</code> contains 20 <code>a</code> and 20 <code>b</code>, then what is the value of <code>P(A|a)</code>?</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line">situations = dict()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">priori_probability</span>(<span class="params">situation, probability</span>):</span></span><br><span class="line">    situations[situation] = probability  <span class="comment"># P(A), P(B)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">posterior_probability</span>(<span class="params">situation, probability</span>):</span></span><br><span class="line">    old_prob = situations[situation]</span><br><span class="line">    situations[situation] = old_prob * probability  <span class="comment"># P(A)P(a|A), P(B)P(a|B)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">normalize</span>():</span></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> situation <span class="keyword">in</span> situations.values():</span><br><span class="line">        count += situation  <span class="comment"># P(A)P(a|A) + P(B)P(a|B)</span></span><br><span class="line">    <span class="keyword">for</span> situation, probability <span class="keyword">in</span> situations.items():</span><br><span class="line">        <span class="comment"># P(A)P(a|A)/(P(A)P(a|A) + P(B)P(a|B)), P(B)P(a|B)/(P(A)P(a|A) + P(B)P(a|B))</span></span><br><span class="line">        situations[situation] = situations[situation] / count</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">prob</span>(<span class="params">hypothis</span>):</span></span><br><span class="line">    <span class="keyword">return</span> situations[hypothis]  <span class="comment"># P(A|a), P(B|a)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">priori_probability(<span class="string">'A'</span>, <span class="number">0.5</span>)  <span class="comment"># P(A)=1/2</span></span><br><span class="line">priori_probability(<span class="string">'B'</span>, <span class="number">0.5</span>)  <span class="comment"># P(B)=1/2</span></span><br><span class="line"></span><br><span class="line">posterior_probability(<span class="string">'A'</span>, <span class="number">0.75</span>)  <span class="comment"># P(a|A)=3/4</span></span><br><span class="line">posterior_probability(<span class="string">'B'</span>, <span class="number">0.5</span>)   <span class="comment"># P(a|B)=1/2</span></span><br><span class="line"></span><br><span class="line">normalize()</span><br><span class="line">prob = prob(<span class="string">'A'</span>)  <span class="comment"># P(A|a)</span></span><br><span class="line">print(<span class="string">'The probability of getting `a` that belongs to set `A`: %s'</span> % prob)</span><br><span class="line"><span class="comment"># P(a|A): 从 A 中获取 a</span></span><br><span class="line"><span class="comment"># P(A|a): 获取 a，并且 a 恰巧是属于 A 的</span></span><br><span class="line"><span class="comment"># 这两个描述的场景完全不同，对应的概率也因而不同</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h4><p>　当存在多个特征变量时，表达式可扩展为</p>
<script type="math/tex; mode=display">P(C \mid F_1,\dots,F_n) = \frac{P(C) \, P(F_1,\dots,F_n \mid C)}{P(F_1,\dots,F_n)} = \frac{1}{Z} P(C)\prod_{i=1}^n P(F_i \mid C)</script><p>　其中，$\frac{1}{Z}$ 是一个只与 $F_i$ 相关的缩放因子，且当特征变量的值固定时，$\frac{1}{Z}$ 为常量</p>
<h2 id="深度学习"><a href="#深度学习" class="headerlink" title="深度学习"></a>深度学习</h2><h3 id="深度网络概要"><a href="#深度网络概要" class="headerlink" title="深度网络概要"></a>深度网络概要</h3><h4 id="激活函数（Activation-Function）"><a href="#激活函数（Activation-Function）" class="headerlink" title="激活函数（Activation Function）"></a><a href="https://en.wikipedia.org/wiki/Activation_function">激活函数</a>（Activation Function）</h4><h5 id="定义-3"><a href="#定义-3" class="headerlink" title="定义"></a>定义</h5><p>　<strong>激活函数</strong> 就是在神经网络的神经元上运行的函数，负责将神经元的输入映射到输出端。主要解决线性不可分问题，如 <a href="https://www.zhihu.com/question/22334626">XOR 异或</a> 等</p>
<h5 id="种类-2"><a href="#种类-2" class="headerlink" title="种类"></a>种类</h5><h6 id="Sigmoid"><a href="#Sigmoid" class="headerlink" title="Sigmoid"></a>Sigmoid</h6><p>　<strong>Sigmoid</strong> 激活函数的表达式为 $f(x)$ = $\frac{e^x}{e^x + 1}$ = $\frac{1}{1 + e^{-x}}$</p>
<p><img data-src="/picture/ai/ai_sigmoid.png" alt=""></p>
<center>（图片来源：<a href="https://en.wikipedia.org/wiki/Sigmoid_function" target="_blank">wikipedia.org</a>，已确认版权为 CC BY-SA 3.0 协议）</center>



<h6 id="TanHyperbolic（Tanh）"><a href="#TanHyperbolic（Tanh）" class="headerlink" title="TanHyperbolic（Tanh）"></a>TanHyperbolic（Tanh）</h6><p>　<strong>Tanh</strong> 激活函数的表达式为 $f(x)$ = $\frac{e^x - e^{-x}}{e^x + e^{-x}}$，属于<a href="https://zh.wikipedia.org/wiki/%E5%8F%8C%E6%9B%B2%E5%87%BD%E6%95%B0">双曲</a>正切函数，如下图表示</p>
<p><img data-src="/picture/ai/ai_tanh.png" alt=""></p>
<center>（图片来源：<a href="https://en.wikipedia.org/wiki/Hyperbolic_function" target="_blank">wikipedia.org</a>，已确认无版权）</center>



<h6 id="ReLU-amp-Softplus"><a href="#ReLU-amp-Softplus" class="headerlink" title="ReLU &amp; Softplus"></a>ReLU &amp; Softplus</h6><p>　<strong>ReLU</strong> 激活函数表达式为 $f(x)$ = $max(0, x)$</p>
<p>　<strong>Softplus</strong> 激活函数表达式为 $f(x)$ = $\log(1+e^x)$</p>
<p><img data-src="/picture/ai/ai_relu.png" alt=""></p>
<center>（图片来源：<a href="https://en.wikipedia.org/wiki/Rectifier_(neural_networks)" target="_blank">wikipedia.org</a>，已确认版权为 CC0 1.0 协议）</center>



<h6 id="LReLU-amp-PReLU-amp-RReLU"><a href="#LReLU-amp-PReLU-amp-RReLU" class="headerlink" title="LReLU &amp; PReLU &amp; RReLU"></a>LReLU &amp; PReLU &amp; RReLU</h6><p><img data-src="/picture/ai/ai_relu_prelu_rrelu.png" alt=""></p>
<center>（图片来源：<a href="https://stats.stackexchange.com/questions/115258/comprehensive-list-of-activation-functions-in-neural-networks-with-pros-cons" target="_blank">stackexchange.com</a>，已确认版权为 CC BY-SA 3.0 协议）</center>



<h6 id="Maxout"><a href="#Maxout" class="headerlink" title="Maxout"></a><a href="https://arxiv.org/pdf/1302.4389.pdf">Maxout</a></h6><p>　<strong>Maxout</strong> 激活函数表达式为 $f(x)$ = $max_{j\in[1, k]}z_{ij}$，其中，$x \in R$，$z_{ij}$ = $x^TW_{\dots ij} + b_{ij}$，$W \in R^{d \cdot m \cdot k}$，$b \in R^{m \cdot k}$</p>
<h6 id="Swish"><a href="#Swish" class="headerlink" title="Swish"></a><a href="https://arxiv.org/pdf/1710.05941.pdf">Swish</a></h6><p>　<strong>Swish</strong> 激活函数表达式为 $f(x)$ = $x \cdot sigmoid(x)$</p>
<h4 id="代价函数（Cost-Function）"><a href="#代价函数（Cost-Function）" class="headerlink" title="代价函数（Cost Function）"></a>代价函数（Cost Function）</h4><h5 id="定义-4"><a href="#定义-4" class="headerlink" title="定义"></a>定义</h5><p>　<strong>代价函数</strong>（又称为 <strong>损失函数</strong> 或 <strong>成本函数</strong>）用来估量模型预测值 $f(x)$ 与 真实值 $Y$ 的偏差程度，通常表示为 $L(Y, f(x))$。代价函数的值越小，说明模型的鲁棒性越好。在特定的领域中，代价函数又会被称为 <a href="https://en.wikipedia.org/wiki/Reward_function">回报函数</a>，<a href="https://en.wikipedia.org/wiki/Profit_function">利润函数</a>，<a href="https://en.wikipedia.org/wiki/Utility_function">效用函数</a>，<a href="https://en.wikipedia.org/wiki/Fitness_function">适应度函数</a> 等</p>
<h5 id="种类-3"><a href="#种类-3" class="headerlink" title="种类"></a>种类</h5><h6 id="二次代价函数（Quadratic-Cost）"><a href="#二次代价函数（Quadratic-Cost）" class="headerlink" title="二次代价函数（Quadratic Cost）"></a>二次代价函数（Quadratic Cost）</h6><p>　<strong>二次代价函数</strong>表达式为 $C$ = $\frac{1}{2n}\sum\mid\mid y(x)$ - $a^L(x)\mid\mid^2$，其中 $x$ 代表样本，$y$ 代表实际值，$a$ 代表输出值，$n$ 代表样本的总量</p>
<p>　当 $n = 1$ 时，样本集中只有一个样本，则二次代价函数可表示为 $C = \frac{1}{2}(((y - a)^1)^{\frac{1}1})^2$ = $\frac{(y - a)^2}{2}$，其中信号总量表示为 $z = \sum{W_jX_j} + b$, 激活函数表示为 $a = \sigma(z)$，则 $C = \frac{(y - \sigma(\sum{W_jX_j} + b))^2}{2}$。此时，我们对 $C$ 分别求 权重值 $w$ 和 偏置量 $b$ 的偏导，则得到 $\frac{\partial C}{\partial w}$ = $(a - y)\sigma^\prime(z) x$ 和 $\frac{\partial C}{\partial b}$ = $(a - y)\sigma^\prime(z)$。由此可见，$w$ 和 $b$ 的梯度和 $\sigma$ 的梯度成正比，$\sigma$ 的梯度越大，$w$ 和 $b$ 的调整速度越快，训练收敛便越快（推导过程相对比较简单，只用到了 <a href="https://zh.wikipedia.org/wiki/%E5%BA%A6%E9%87%8F">度量空间求向量距离</a> 和 <a href="https://zh.wikipedia.org/wiki/%E9%93%BE%E5%BC%8F%E6%B3%95%E5%88%99">复合函数求偏导</a>）</p>
<h6 id="交叉熵（Cross-Entropy）"><a href="#交叉熵（Cross-Entropy）" class="headerlink" title="交叉熵（Cross Entropy）"></a>交叉熵（Cross Entropy）</h6><p>　<strong>交叉熵代价函数</strong>表达式为 $C = -\frac{1}{n}\sum_{x=1}^{n}[y\ln a + (1 - y)\ln(1 - a)]$，其中 $x$ 代表样本，$y$ 代表实际值，$a$ 代表输出值，$n$ 代表样本的总量</p>
<p>　和二次代价函数一样，不改变其激活函数，信号总量表示为 $z = \sum{W_jX_j} + b$, 激活函数表示为 $a = \sigma(z)$，则 $\sigma^\prime(z) = \sigma(x)(1 - \sigma(z))$。再次对 $C$ 求 $w$ 和 $b$ 的偏导分别为 $\frac{\partial C}{\partial w_j} = \frac{1}n\sum_{x=1}^nx_j(\sigma(z)-y)$ 和 $\frac{\partial C}{\partial b} = \frac{1}n\sum_{x=1}^n(\sigma(z) - y)$。由此可见，$w$ 和 $b$ 的调整与 $\sigma^\prime(z)$ 无关，并且，当 $\sigma(z) - y$ 预测值与实际值误差越大，$C$ 的梯度（求导）也就越大，训练的收敛速度也就越大。因此，$sigmoid$ 此类 $S$ 形激活函数，则不适合使用上文中介绍的二次代价函数；不过如果激活函数是线性的，则可能二次代价函数的表现更佳</p>
<h6 id="对数似然代价函数（Log-likelihood-Cost）"><a href="#对数似然代价函数（Log-likelihood-Cost）" class="headerlink" title="对数似然代价函数（Log-likelihood Cost）"></a>对数似然代价函数（Log-likelihood Cost）</h6><p>　<strong>对数似然代价函数</strong>常用于 <a href="http://blog.csdn.net/u014313009/article/details/51045303">Softmax</a> 归一化指数函数，可以有效地解决学习速度变慢的问题；但是，如果输出层神经元是 <a href="https://hit-scir.gitbooks.io/neural-networks-and-deep-learning-zh_cn/content/chap1/c1s2.html">Sigmoid</a>，则建议采用交叉熵代价函数</p>
<h4 id="优化器（Optimizer）"><a href="#优化器（Optimizer）" class="headerlink" title="优化器（Optimizer）"></a>优化器（Optimizer）</h4><p>　<a href="http://en.wikipedia.org/wiki/Stochastic_gradient_descent">SGD</a>, <a href="http://www.jmlr.org/proceedings/papers/v28/sutskever13.pdf">Momentum</a>, <a href="http://books.google.com.tr/books?id=2-ElBQAAQBAJ&amp;printsec=frontcover&amp;source=gbs_ge_summary_r&amp;cad=0#v=onepage&amp;q&amp;f=false">NAG</a>, <a href="http://www.jmlr.org/papers/volume12/duchi11a/duchi11a.pdf">Adagrad</a>, <a href="http://arxiv.org/abs/1212.5701">Adadelta</a>, <a href="https://class.coursera.org/neuralnets-2012-001/lecture/67">RMSprop</a></p>
<p><img data-src="/picture/ai/ai_noisy_moons.gif" alt=""></p>
<p><img data-src="/picture/ai/ai_beale_function.gif" alt=""></p>
<p><img data-src="/picture/ai/ai_long_valley.gif" alt=""></p>
<p><img data-src="/picture/ai/ai_saddle_point.gif" alt=""></p>
<center>（图片来源：<a href="http://www.denizyuret.com/2015/03/alec-radfords-animations-for.html" target="_blank">denizyuret.com</a>，已询问作者）</center>




<h3 id="卷积神经网络"><a href="#卷积神经网络" class="headerlink" title="卷积神经网络"></a>卷积神经网络</h3><h4 id="卷积"><a href="#卷积" class="headerlink" title="卷积"></a>卷积</h4><h4 id="池化"><a href="#池化" class="headerlink" title="池化"></a>池化</h4><h5 id="常见类型-1"><a href="#常见类型-1" class="headerlink" title="常见类型"></a>常见类型</h5><h6 id="Max-Pooling"><a href="#Max-Pooling" class="headerlink" title="Max Pooling"></a>Max Pooling</h6><p><img data-src="/picture/ai/ai_max_pooling.png" alt=""></p>
<center>（图片来源：<a href="https://en.wikipedia.org/wiki/Convolutional_neural_network#Pooling" target="_blank">wikipedia.org</a>，已确认版权为 CC BY-SA 4.0 协议）</center>


<h6 id="Mean-Pooling"><a href="#Mean-Pooling" class="headerlink" title="Mean Pooling"></a>Mean Pooling</h6><h6 id="L2-norm-pooling"><a href="#L2-norm-pooling" class="headerlink" title="L2-norm pooling"></a>L2-norm pooling</h6><h6 id="Down-Pooling"><a href="#Down-Pooling" class="headerlink" title="Down Pooling"></a><a href="http://www.cnblogs.com/wangduo/p/6762914.html">Down Pooling</a></h6><h4 id="Padding"><a href="#Padding" class="headerlink" title="Padding"></a>Padding</h4><h5 id="Same-Padding"><a href="#Same-Padding" class="headerlink" title="Same Padding"></a>Same Padding</h5><p>　给采样平面外部补 $0$，使得卷积窗口采样之后，可以得到一个与被采样平面，大小一样的结果平面</p>
<h5 id="Valid-Padding"><a href="#Valid-Padding" class="headerlink" title="Valid Padding"></a>Valid Padding</h5><p>　不会超出采样平面，卷积窗口采样之后，会到得到一个比原来平面小的结果平面</p>
<h2 id="开源项目"><a href="#开源项目" class="headerlink" title="开源项目"></a>开源项目</h2><h3 id="Tensorflow-Tensorflow"><a href="#Tensorflow-Tensorflow" class="headerlink" title="Tensorflow / Tensorflow"></a><a href="https://github.com/tensorflow">Tensorflow</a> / <strong><a href="https://github.com/tensorflow/tensorflow">Tensorflow</a></strong></h3><h4 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h4><p>　<strong>TensorFlow</strong>™ 是一个端到端开源机器学习平台。它拥有一个全面而灵活的生态系统，其中包含各种工具、库和社区资源，可助力研究人员推动先进机器学习技术的发展，并使开发者能够轻松地构建和部署由机器学习提供支持的应用。  — <a href="https://www.tensorflow.org/">tensorflow.org</a></p>
<h5 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h5><ul>
<li>高度的灵活性</li>
<li>可移植性</li>
<li>极大地提高了科研产出率</li>
<li>自动求微分</li>
<li>多语言支持（<a href="https://yuzhouwan.com/posts/43687/">Python</a> / C++ / <a href="https://yuzhouwan.com/posts/27328/">Java</a> / Golang）</li>
<li>最大化硬件的性能</li>
</ul>
<h5 id="基本概念-2"><a href="#基本概念-2" class="headerlink" title="基本概念"></a>基本概念</h5><ul>
<li>使用 <strong>图</strong>（Graph）来表示计算任务</li>
<li>在被称之为 <strong>会话</strong>（Session）的<strong>上下文</strong>（Context）中执行图</li>
<li>使用 <strong>Tensor</strong> 表示数据</li>
<li>通过 <strong>变量</strong>（Variable）维护状态</li>
<li>使用 <code>feed</code> 和 <code>fetch</code> 可以为任意的<strong>操作</strong>（Arbitrary Operation）赋值或从中获取数据</li>
</ul>
<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><h5 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h5><p>　需要注意的是，如果是在 Windows 环境下，只能<a href="https://www.python.org/downloads/">安装</a> <code>Python3.5+</code> 版本。详细安装步骤见《<a href="https://yuzhouwan.com/posts/43687/#环境部署">Python - 环境部署</a>》</p>
<h5 id="Anaconda3"><a href="#Anaconda3" class="headerlink" title="Anaconda3"></a>Anaconda3</h5><p>　下载地址：<a href="https://repo.continuum.io/archive/">Download Page</a></p>
<p>　启动程序的快捷链接，都自动创建在了 <code>C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Anaconda3 (64-bit)</code> 目录下</p>
<p>　在运行 <code>Jupyter</code> 之前，需要简单设置下，文件的存放路径（如果只想使用 Jupyter，相关安装步骤见《<a href="https://yuzhouwan.com/posts/43687/#科学分析工具">Python - 科学分析工具</a>》）</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ jupyter notebook --generate-config</span><br><span class="line">  Writing default config to: C:\Users\Benedict Jin\.jupyter\jupyter_notebook_config.py</span><br><span class="line"></span><br><span class="line">$ vim jupyter_notebook_config.py</span><br><span class="line">  <span class="comment">## The directory to use for notebooks and kernels.</span></span><br><span class="line">  c.NotebookApp.notebook_dir = <span class="string">'E:\Jupyter\TensorFlow'</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="TensorFlow"><a href="#TensorFlow" class="headerlink" title="TensorFlow"></a><a href="https://www.tensorflow.org/install/">TensorFlow</a></h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">## 安装</span></span><br><span class="line"><span class="comment"># cpu</span></span><br><span class="line">$ pip3 install tensorflow</span><br><span class="line"><span class="comment"># gpu</span></span><br><span class="line">$ pip3 install tensorflow-gpu</span><br><span class="line"></span><br><span class="line"><span class="comment">## 升级</span></span><br><span class="line"><span class="comment"># cpu</span></span><br><span class="line">$ pip3 install --upgrade tensorflow</span><br><span class="line"><span class="comment"># gpu</span></span><br><span class="line">$ pip3 install --upgrade tensorflow-gpu</span><br><span class="line"></span><br><span class="line"><span class="comment">## 测试</span></span><br><span class="line">$ python</span><br><span class="line">&gt;&gt;&gt; import tensorflow as tf</span><br><span class="line">&gt;&gt;&gt; hello = tf.constant(<span class="string">'Hello, TensorFlow!'</span>)</span><br><span class="line">&gt;&gt;&gt; sess = tf.Session()</span><br><span class="line">&gt;&gt;&gt; <span class="built_in">print</span>(sess.run(hello))</span><br><span class="line">  b<span class="string">'Hello, TensorFlow!'</span></span><br></pre></td></tr></tbody></table></figure>
<p>Tips: 当然还有其他的方式，可以帮助我们更方便地使用这些科学分析库，包括 <a href="http://winpython.sourceforge.net/">WinPython</a>、<a href="https://www.enthought.com/product/canopy/">Enthought Canopy</a> etc.</p>
<h4 id="编程实战"><a href="#编程实战" class="headerlink" title="编程实战"></a>编程实战</h4><h5 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h5><h6 id="加减"><a href="#加减" class="headerlink" title="加减"></a>加减</h6><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建变量</span></span><br><span class="line">a = tf.Variable([<span class="number">1</span>, <span class="number">0</span>])</span><br><span class="line">b = tf.Variable([<span class="number">0</span>, <span class="number">1</span>])</span><br><span class="line"><span class="comment"># sub/add 两个 operation</span></span><br><span class="line">sub = tf.subtract(a, b)</span><br><span class="line">add = tf.add(a, b)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化变量</span></span><br><span class="line">init = tf.global_variables_initializer()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行 Session</span></span><br><span class="line"><span class="keyword">with</span> tf.Session() <span class="keyword">as</span> sess:</span><br><span class="line">    sess.run(init)</span><br><span class="line">    print(sess.run(sub))</span><br><span class="line">    print(sess.run(add))</span><br><span class="line"></span><br><span class="line">  <span class="comment">#[1 -1]</span></span><br><span class="line">  <span class="comment">#[1 1]</span></span><br></pre></td></tr></tbody></table></figure>
<h6 id="累计"><a href="#累计" class="headerlink" title="累计"></a>累计</h6><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Counter</span></span><br><span class="line">counter = tf.Variable(<span class="number">0</span>, name = <span class="string">"counter"</span>)</span><br><span class="line">add_one = tf.add(counter, <span class="number">1</span>)</span><br><span class="line">assign = tf.assign(counter, add_one)</span><br><span class="line">init = tf.global_variables_initializer()</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> tf.Session() <span class="keyword">as</span> sess:</span><br><span class="line">    sess.run(init)</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">        sess.run(assign)</span><br><span class="line">        print(sess.run(counter))</span><br><span class="line"></span><br><span class="line">  <span class="number">1</span></span><br><span class="line">  <span class="number">2</span></span><br><span class="line">  <span class="number">3</span></span><br><span class="line">  <span class="number">4</span></span><br><span class="line">  <span class="number">5</span></span><br></pre></td></tr></tbody></table></figure>
<p>Tips: Full code is <a href="http://nbviewer.jupyter.org/github/asdf2014/yuzhouwan/blob/master/yuzhouwan-ai/yuzhouwan-ai-tensorflow/src/main/resources/ipython/Variable.ipynb">here</a>.</p>
<h5 id="矩阵积"><a href="#矩阵积" class="headerlink" title="矩阵积"></a>矩阵积</h5><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 一行两列</span></span><br><span class="line">matrix1 = tf.constant([[<span class="number">1</span>, <span class="number">0</span>]])</span><br><span class="line"><span class="comment"># 两行一列</span></span><br><span class="line">matrix2 = tf.constant([[<span class="number">1</span>], [<span class="number">0</span>]])</span><br><span class="line"><span class="comment"># 矩阵相乘</span></span><br><span class="line">matmul = tf.matmul(matrix1, matrix2)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印结果（Tensor 而不是结果 2）</span></span><br><span class="line">print(matmul)</span><br><span class="line"></span><br><span class="line">  Tensor(<span class="string">"MatMul:0"</span>, shape = (<span class="number">1</span>, <span class="number">1</span>), dtype = int32)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义会话</span></span><br><span class="line">sess = tf.Session()</span><br><span class="line"><span class="comment"># 真正开始执行</span></span><br><span class="line">print(sess.run(matmul))</span><br><span class="line">sess.close()</span><br><span class="line"></span><br><span class="line">  [[<span class="number">1</span>]]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 改写成 `with ... as ...`，则可以保证 Session 会自动关闭</span></span><br><span class="line"><span class="keyword">with</span> tf.Session() <span class="keyword">as</span> sess:</span><br><span class="line">    print(sess.run(matmul))</span><br></pre></td></tr></tbody></table></figure>
<p>Tips: Full code is <a href="http://nbviewer.jupyter.org/github/asdf2014/yuzhouwan/blob/master/yuzhouwan-ai/yuzhouwan-ai-tensorflow/src/main/resources/ipython/Matrix.ipynb">here</a>.</p>
<h5 id="Fetch-amp-Feed"><a href="#Fetch-amp-Feed" class="headerlink" title="Fetch &amp; Feed"></a>Fetch &amp; Feed</h5><h6 id="Fetch"><a href="#Fetch" class="headerlink" title="Fetch"></a>Fetch</h6><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Fetch</span></span><br><span class="line">a = tf.constant(<span class="number">1.0</span>)</span><br><span class="line">b = tf.constant(<span class="number">2.0</span>)</span><br><span class="line">c = tf.constant(<span class="number">3.0</span>)</span><br><span class="line">multiply = tf.multiply(a, b)</span><br><span class="line">add = tf.add(matmul, c)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Fetch 可以运行多个 Op</span></span><br><span class="line"><span class="keyword">with</span> tf.Session() <span class="keyword">as</span> sess:</span><br><span class="line">    print(sess.run([add, multiply]))</span><br><span class="line"></span><br><span class="line">  <span class="comment">#[5.0, 2.0]</span></span><br></pre></td></tr></tbody></table></figure>
<h6 id="Feed"><a href="#Feed" class="headerlink" title="Feed"></a>Feed</h6><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Feed</span></span><br><span class="line">ph1 = tf.placeholder(tf.float32)</span><br><span class="line">ph2 = tf.placeholder(tf.float32)</span><br><span class="line">m = tf.multiply(ph1, ph2)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在真正执行的时候，再将数据以字典的形式传入</span></span><br><span class="line"><span class="keyword">with</span> tf.Session() <span class="keyword">as</span> sess:</span><br><span class="line">    print(sess.run(m, feed_dict={ph1: [<span class="number">1.0</span>], ph2: [<span class="number">2.0</span>]}))</span><br><span class="line"></span><br><span class="line">  <span class="comment">#[ 2.]</span></span><br></pre></td></tr></tbody></table></figure>
<p>Tips: Full code is <a href="http://nbviewer.jupyter.org/github/asdf2014/yuzhouwan/blob/master/yuzhouwan-ai/yuzhouwan-ai-tensorflow/src/main/resources/ipython/Feed%20%26%20Fetch.ipynb">here</a>.</p>
<h5 id="二次代价函数-amp-梯度下降"><a href="#二次代价函数-amp-梯度下降" class="headerlink" title="二次代价函数 &amp; 梯度下降"></a>二次代价函数 &amp; 梯度下降</h5><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">x_data = np.random.rand(<span class="number">100</span>)</span><br><span class="line">y_data = x_data * <span class="number">0.1</span> + <span class="number">0.2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 线性模型的斜率 &amp; 偏置量</span></span><br><span class="line">k = tf.Variable(<span class="number">0.</span>)</span><br><span class="line">b = tf.Variable(<span class="number">0.</span>)</span><br><span class="line">y = k * x_data + b</span><br><span class="line"></span><br><span class="line"><span class="comment"># 二次代价函数</span></span><br><span class="line">loss = tf.reduce_mean(tf.square(y_data - y))</span><br><span class="line"><span class="comment"># 梯度下降</span></span><br><span class="line">optimizer = tf.train.GradientDescentOptimizer(<span class="number">0.2</span>)</span><br><span class="line"><span class="comment"># 最小化代价函数</span></span><br><span class="line">train = optimizer.minimize(loss)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 线性模型中，k、b 作为变量，会在梯度下降法的作用下不断变化，以使得 loss 函数越来越小</span></span><br><span class="line"><span class="keyword">with</span> tf.Session() <span class="keyword">as</span> sess:</span><br><span class="line">    tf.global_variables_initializer().run()</span><br><span class="line">    <span class="keyword">for</span> step <span class="keyword">in</span> range(<span class="number">501</span>):</span><br><span class="line">        sess.run(train)</span><br><span class="line">        <span class="keyword">if</span> step % <span class="number">100</span> == <span class="number">0</span>:</span><br><span class="line">            print(<span class="string">"Step: "</span>, step, <span class="string">"[k, b]"</span>, sess.run([k, b]))</span><br><span class="line"></span><br><span class="line">  Step:  <span class="number">0</span> [k, b] [<span class="number">0.054201454</span>, <span class="number">0.10031855</span>]</span><br><span class="line">  Step:  <span class="number">100</span> [k, b] [<span class="number">0.10048652</span>, <span class="number">0.19973609</span>]</span><br><span class="line">  Step:  <span class="number">200</span> [k, b] [<span class="number">0.10003704</span>, <span class="number">0.1999799</span>]</span><br><span class="line">  Step:  <span class="number">300</span> [k, b] [<span class="number">0.10000283</span>, <span class="number">0.19999847</span>]</span><br><span class="line">  Step:  <span class="number">400</span> [k, b] [<span class="number">0.10000023</span>, <span class="number">0.19999987</span>]</span><br><span class="line">  Step:  <span class="number">500</span> [k, b] [<span class="number">0.10000023</span>, <span class="number">0.19999987</span>]</span><br></pre></td></tr></tbody></table></figure>
<p>Tips: Full code is <a href="http://nbviewer.jupyter.org/github/asdf2014/yuzhouwan/blob/master/yuzhouwan-ai/yuzhouwan-ai-tensorflow/src/main/resources/ipython/Loss%20Function%20%26%20GD.ipynb">here</a>.</p>
<h5 id="非线性回归"><a href="#非线性回归" class="headerlink" title="非线性回归"></a>非线性回归</h5><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 [-0.5, 0.5] 区间内生成随机数</span></span><br><span class="line">x_data = np.linspace(<span class="number">-0.5</span>, <span class="number">0.5</span>, <span class="number">100</span>)[:, np.newaxis]</span><br><span class="line"><span class="comment"># 在 100 个随机数基础上，增加噪音</span></span><br><span class="line">noise = np.random.normal(<span class="number">0</span>, <span class="number">0.02</span>, x_data.shape)</span><br><span class="line">y_data = np.square(x_data) + noise</span><br><span class="line"></span><br><span class="line">x = tf.placeholder(tf.float32, [<span class="literal">None</span>, <span class="number">1</span>])</span><br><span class="line">y = tf.placeholder(tf.float32, [<span class="literal">None</span>, <span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 神经网络 中间层</span></span><br><span class="line">weight_L1 = tf.Variable(tf.random_normal([<span class="number">1</span>, <span class="number">10</span>]))</span><br><span class="line">biase_L1 = tf.Variable(tf.zeros([<span class="number">1</span>, <span class="number">10</span>]))</span><br><span class="line">w_plus_b_L1 = tf.matmul(x, weight_L1) + biase_L1</span><br><span class="line"><span class="comment"># 激活函数</span></span><br><span class="line">L1 = tf.nn.tanh(w_plus_b_L1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 神经网络 输出层</span></span><br><span class="line">wegith_L2 = tf.Variable(tf.random_normal([<span class="number">10</span>, <span class="number">1</span>]))</span><br><span class="line">biase_L2 = tf.Variable(tf.zeros([<span class="number">1</span>, <span class="number">1</span>]))</span><br><span class="line">w_plus_b_L2 = tf.matmul(L1, wegith_L2) + biase_L2</span><br><span class="line">prediction = tf.nn.tanh(w_plus_b_L2)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Loss Function</span></span><br><span class="line">loss = tf.reduce_mean(tf.square(y - prediction))</span><br><span class="line">train = tf.train.GradientDescentOptimizer(<span class="number">0.1</span>).minimize(loss)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> tf.Session() <span class="keyword">as</span> sess:</span><br><span class="line">    tf.global_variables_initializer().run()</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">1500</span>):</span><br><span class="line">        sess.run(train, feed_dict = {x: x_data, y: y_data})</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 使用训练好的模式进行预测</span></span><br><span class="line">    prediction_result = sess.run(prediction, feed_dict = {x: x_data})</span><br><span class="line"></span><br><span class="line">    plt.figure()</span><br><span class="line">    plt.scatter(x_data, y_data)</span><br><span class="line">    plt.plot(x_data, prediction_result, <span class="string">'r-'</span>, lw = <span class="number">5</span>)</span><br><span class="line">    plt.show()</span><br></pre></td></tr></tbody></table></figure>
<p><img data-src="/picture/ai/ai_linear_regression.png" alt=""></p>
<center>（使用 <a href="https://yuzhouwan.com/posts/43687/#Matplotlib" target="_blank">Matplotlib</a> 绘制而成）</center>

<p>Tips: Full code is <a href="http://nbviewer.jupyter.org/github/asdf2014/yuzhouwan/blob/master/yuzhouwan-ai/yuzhouwan-ai-tensorflow/src/main/resources/ipython/Non%20Linear%20Regression.ipynb">here</a>.</p>
<h5 id="手写数字识别"><a href="#手写数字识别" class="headerlink" title="手写数字识别"></a><a href="https://www.tensorflow.org/get_started/mnist/beginners">手写数字识别</a></h5><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Download MNIST datasource</span></span><br><span class="line"><span class="comment"># 6w 个 28*28 个像素的手写数字图片集</span></span><br><span class="line"><span class="comment"># 用 [60000, 784] 的张量表示 [图片索引，图片像素点索引]</span></span><br><span class="line"><span class="keyword">from</span> tensorflow.examples.tutorials.mnist <span class="keyword">import</span> input_data</span><br><span class="line"></span><br><span class="line"><span class="comment"># `one-hot vectors`：向量中只有一个数据为 1，其余维度只能为 0</span></span><br><span class="line"><span class="comment"># 转化为 [60000, 10] 的张量表示 [图片索引，图片表示的数值]</span></span><br><span class="line">mnist = input_data.read_data_sets(<span class="string">"MNIST_data/"</span>, one_hot = <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 28 * 28 = 784 的占位符</span></span><br><span class="line"><span class="comment"># None 表示可能是任何数值</span></span><br><span class="line">x = tf.placeholder(tf.float32, [<span class="literal">None</span>, <span class="number">784</span>])</span><br><span class="line">y = tf.placeholder(tf.float32, [<span class="literal">None</span>, <span class="number">10</span>])</span><br><span class="line">z = tf.placeholder(tf.float32)                        <span class="comment"># 用于 drop_out 操作时的依据（0.8：80% 的神经元在工作）</span></span><br><span class="line">lr = tf.Variable(<span class="number">0.001</span>, dtype = tf.float32)           <span class="comment"># 用于不断递减的学习率，使得梯度下降到最低点时，能更好地命中</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 权重值（截断的随机正太分布）和 偏置量（0.1）</span></span><br><span class="line">W1 = tf.Variable(tf.truncated_normal([<span class="number">784</span>, <span class="number">600</span>], stddev = <span class="number">0.1</span>))</span><br><span class="line">b1 = tf.Variable(tf.zeros([<span class="number">600</span>]) + <span class="number">0.1</span>)</span><br><span class="line">L1 = tf.nn.tanh(tf.matmul(x, W1) + b1)</span><br><span class="line">L1_drop = tf.nn.dropout(L1, z)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 隐藏层</span></span><br><span class="line">W2 = tf.Variable(tf.truncated_normal([<span class="number">600</span>, <span class="number">400</span>], stddev = <span class="number">0.1</span>))</span><br><span class="line">b2 = tf.Variable(tf.zeros([<span class="number">400</span>]) + <span class="number">0.1</span>)</span><br><span class="line">L2 = tf.nn.tanh(tf.matmul(L1_drop, W2) + b2)</span><br><span class="line">L2_drop = tf.nn.dropout(L2, z)</span><br><span class="line"></span><br><span class="line">W3 = tf.Variable(tf.truncated_normal([<span class="number">400</span>, <span class="number">10</span>], stddev = <span class="number">0.1</span>))</span><br><span class="line">b3 = tf.Variable(tf.zeros([<span class="number">10</span>]) + <span class="number">0.1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># softmax 回归模型</span></span><br><span class="line">prediction = tf.nn.softmax(tf.matmul(L2_drop, W3) + b3)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 二次 Loss Func</span></span><br><span class="line"><span class="comment"># loss = tf.reduce_mean(tf.square(y - prediction))</span></span><br><span class="line"><span class="comment"># 交叉熵 Loss Func</span></span><br><span class="line"><span class="comment"># loss = tf.reduce_mean(- tf.reduce_sum(y * tf.log(prediction), reduction_indices = [1]))</span></span><br><span class="line">loss = tf.reduce_mean(tf.nn.softmax_cross_entropy_with_logits(labels = y, logits = prediction))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 梯度下降</span></span><br><span class="line"><span class="comment"># train_step = tf.train.GradientDescentOptimizer(0.2).minimize(loss)</span></span><br><span class="line">train_step = tf.train.AdamOptimizer(lr).minimize(loss)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 评估模型</span></span><br><span class="line"><span class="comment"># 判断 一维张量 y、prediction 中最大值的位置是否相等</span></span><br><span class="line">correct_prediction = tf.equal(tf.argmax(y, <span class="number">1</span>), tf.argmax(prediction, <span class="number">1</span>))</span><br><span class="line"><span class="comment"># 准确率</span></span><br><span class="line"><span class="comment"># 将 布尔型列表 corrent_prediction 转化为 float32 类型</span></span><br><span class="line"><span class="comment"># [true, false, false, ...]  =&gt; [1.0, 0., 0., ...]</span></span><br><span class="line">accuracy = tf.reduce_mean(tf.cast(correct_prediction, tf.float32))</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> tf.device(<span class="string">'/gpu:0'</span>):</span><br><span class="line">    <span class="keyword">with</span> tf.Session() <span class="keyword">as</span> sess:</span><br><span class="line">        tf.global_variables_initializer().run()</span><br><span class="line"></span><br><span class="line">        batch_size = <span class="number">100</span></span><br><span class="line">        batch = (int) (<span class="number">60000</span> / batch_size)</span><br><span class="line">        <span class="comment"># batch = mnist.train.num_examples</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">101</span>):</span><br><span class="line">            sess.run(tf.assign(lr, <span class="number">0.001</span> * (<span class="number">0.95</span> ** _)))</span><br><span class="line">            <span class="keyword">for</span> batch_step <span class="keyword">in</span> range(batch):</span><br><span class="line">                batch_xs, batch_ys = mnist.train.next_batch(batch_size)</span><br><span class="line">                sess.run(train_step, feed_dict = {x: batch_xs, y: batch_ys, z: <span class="number">0.9973</span>})</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (_ % <span class="number">10</span>) == <span class="number">0</span>:</span><br><span class="line">                test_accuracy = sess.run(accuracy, feed_dict = {x: mnist.test.images, y: mnist.test.labels, z: <span class="number">1.0</span>})</span><br><span class="line">                train_accuracy = sess.run(accuracy, feed_dict = {x: mnist.train.images, y: mnist.train.labels, z: <span class="number">1.0</span>})</span><br><span class="line">                print(<span class="string">"Batch: "</span>, _, <span class="string">"Accuracy: ["</span>, test_accuracy, <span class="string">","</span>, train_accuracy, <span class="string">"]"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 二次 Loss Func</span></span><br><span class="line">Batch:  <span class="number">0</span> Accuracy:  <span class="number">0.8394</span></span><br><span class="line">Batch:  <span class="number">10</span> Accuracy:  <span class="number">0.9067</span></span><br><span class="line">Batch:  <span class="number">20</span> Accuracy:  <span class="number">0.9142</span></span><br><span class="line">Batch:  <span class="number">30</span> Accuracy:  <span class="number">0.9187</span></span><br><span class="line">Batch:  <span class="number">40</span> Accuracy:  <span class="number">0.9199</span></span><br><span class="line">Batch:  <span class="number">50</span> Accuracy:  <span class="number">0.9219</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 交叉熵 Loss Func</span></span><br><span class="line">Batch:  <span class="number">0</span> Accuracy:  <span class="number">0.8262</span></span><br><span class="line">Batch:  <span class="number">10</span> Accuracy:  <span class="number">0.9183</span></span><br><span class="line">Batch:  <span class="number">20</span> Accuracy:  <span class="number">0.9224</span></span><br><span class="line">Batch:  <span class="number">30</span> Accuracy:  <span class="number">0.9232</span></span><br><span class="line">Batch:  <span class="number">40</span> Accuracy:  <span class="number">0.9273</span></span><br><span class="line">Batch:  <span class="number">50</span> Accuracy:  <span class="number">0.9274</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 隐藏层 + DropOut</span></span><br><span class="line">Batch:  <span class="number">0</span> Accuracy: [ <span class="number">0.9176</span> , <span class="number">0.915527</span> ]</span><br><span class="line">Batch:  <span class="number">10</span> Accuracy: [ <span class="number">0.9565</span> , <span class="number">0.963182</span> ]</span><br><span class="line">Batch:  <span class="number">20</span> Accuracy: [ <span class="number">0.9669</span> , <span class="number">0.975236</span> ]</span><br><span class="line">Batch:  <span class="number">30</span> Accuracy: [ <span class="number">0.9718</span> , <span class="number">0.982</span> ]</span><br><span class="line">Batch:  <span class="number">40</span> Accuracy: [ <span class="number">0.9737</span> , <span class="number">0.984836</span> ]</span><br><span class="line">Batch:  <span class="number">50</span> Accuracy: [ <span class="number">0.9768</span> , <span class="number">0.987036</span> ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># AdamOptimizer + GPU</span></span><br><span class="line">Batch:  <span class="number">0</span> Accuracy: [ <span class="number">0.9573</span> , <span class="number">0.962128</span> ]</span><br><span class="line">Batch:  <span class="number">10</span> Accuracy: [ <span class="number">0.9803</span> , <span class="number">0.994455</span> ]</span><br><span class="line">Batch:  <span class="number">20</span> Accuracy: [ <span class="number">0.9795</span> , <span class="number">0.997073</span> ]</span><br><span class="line">Batch:  <span class="number">30</span> Accuracy: [ <span class="number">0.9816</span> , <span class="number">0.997709</span> ]</span><br><span class="line">Batch:  <span class="number">40</span> Accuracy: [ <span class="number">0.9828</span> , <span class="number">0.997946</span> ]</span><br><span class="line">Batch:  <span class="number">50</span> Accuracy: [ <span class="number">0.9823</span> , <span class="number">0.998128</span> ]</span><br><span class="line">Batch:  <span class="number">60</span> Accuracy: [ <span class="number">0.9828</span> , <span class="number">0.998237</span> ]</span><br><span class="line">Batch:  <span class="number">70</span> Accuracy: [ <span class="number">0.9828</span> , <span class="number">0.998309</span> ]</span><br><span class="line">Batch:  <span class="number">80</span> Accuracy: [ <span class="number">0.9831</span> , <span class="number">0.998346</span> ]</span><br><span class="line">Batch:  <span class="number">90</span> Accuracy: [ <span class="number">0.9828</span> , <span class="number">0.9984</span> ]</span><br><span class="line">Batch:  <span class="number">100</span> Accuracy: [ <span class="number">0.9831</span> , <span class="number">0.9984</span> ]</span><br></pre></td></tr></tbody></table></figure>
<p>Tips: <strong>Softmax</strong> 公式为：$softmax(x)_i$ = $\frac{exp(x_i)}{\sum_j{exp(x_j)}}$ = $\frac{e^{x_i}}{\sum_j{e^{x_j}}}$<br>Tips: Full code is <a href="http://nbviewer.jupyter.org/github/asdf2014/yuzhouwan/blob/master/yuzhouwan-ai/yuzhouwan-ai-tensorflow/src/main/resources/ipython/MNIST.ipynb">here</a>.</p>
<h4 id="TensorBoard-可视化"><a href="#TensorBoard-可视化" class="headerlink" title="TensorBoard 可视化"></a>TensorBoard 可视化</h4><h5 id="Scalar-amp-NameScope-amp-Embedding"><a href="#Scalar-amp-NameScope-amp-Embedding" class="headerlink" title="Scalar &amp; NameScope &amp; Embedding"></a>Scalar &amp; NameScope &amp; Embedding</h5><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="comment"># Download MNIST datasource</span></span><br><span class="line"><span class="comment"># 6w 个 28*28 个像素的手写数字图片集</span></span><br><span class="line"><span class="comment"># 用 [60000, 784] 的张量表示 [图片索引，图片像素点索引]</span></span><br><span class="line"><span class="keyword">from</span> tensorflow.examples.tutorials.mnist <span class="keyword">import</span> input_data</span><br><span class="line"><span class="keyword">from</span> tensorflow.contrib.tensorboard.plugins <span class="keyword">import</span> projector</span><br><span class="line"></span><br><span class="line"><span class="comment"># `one-hot vectors`：向量中只有一个数据为 1，其余维度只能为 0</span></span><br><span class="line"><span class="comment"># 转化为 [60000, 10] 的张量表示 [图片索引，图片表示的数值]</span></span><br><span class="line">mnist = input_data.read_data_sets(<span class="string">"MNIST_data/"</span>, one_hot = <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">image_num = <span class="number">10000</span></span><br><span class="line">embedding = tf.Variable(tf.stack(mnist.test.images[:image_num]), trainable = <span class="literal">False</span>, name = <span class="string">'embedding'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义求统计指标的方法</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">summaries</span>(<span class="params">var</span>):</span></span><br><span class="line">    <span class="comment"># 申明一个命名空间</span></span><br><span class="line">    <span class="keyword">with</span> tf.name_scope(<span class="string">'summaries'</span>):</span><br><span class="line">        tf.summary.scalar(<span class="string">'max'</span>, tf.reduce_max(var))        <span class="comment"># 最大值</span></span><br><span class="line">        tf.summary.scalar(<span class="string">'min'</span>, tf.reduce_min(var))        <span class="comment"># 最小值</span></span><br><span class="line">        mean = tf.reduce_mean(var)</span><br><span class="line">        tf.summary.scalar(<span class="string">'mean'</span>, mean)                     <span class="comment"># 平均值</span></span><br><span class="line">        <span class="keyword">with</span> tf.name_scope(<span class="string">'stddev'</span>):</span><br><span class="line">            stddev = tf.sqrt(tf.reduce_mean(tf.square(var - mean)))</span><br><span class="line">        tf.summary.scalar(<span class="string">'stddev'</span>, stddev)                 <span class="comment"># 标准差</span></span><br><span class="line">        tf.summary.histogram(<span class="string">'histogram'</span>, var)              <span class="comment"># 直方图</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> tf.name_scope(<span class="string">'input'</span>):</span><br><span class="line">    <span class="comment"># 28 * 28 = 784 的占位符</span></span><br><span class="line">    <span class="comment"># None 表示可能是任何数值</span></span><br><span class="line">    x = tf.placeholder(tf.float32, [<span class="literal">None</span>, <span class="number">784</span>], name = <span class="string">'x_input'</span>)</span><br><span class="line">    y = tf.placeholder(tf.float32, [<span class="literal">None</span>, <span class="number">10</span>], name = <span class="string">'y_input'</span>)</span><br><span class="line">    <span class="comment"># 用于 drop_out 操作时的依据（0.8：80% 的神经元在工作）</span></span><br><span class="line">    z = tf.placeholder(tf.float32, name = <span class="string">'drop_output_input'</span>)</span><br><span class="line">    lr = tf.Variable(<span class="number">0.001</span>, dtype = tf.float32)           <span class="comment"># 用于不断递减的学习率，使得梯度下降到最低点时，能更好地命中</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> tf.name_scope(<span class="string">'layer'</span>):</span><br><span class="line">    <span class="keyword">with</span> tf.name_scope(<span class="string">'layer_1'</span>):</span><br><span class="line">        <span class="comment"># 权重值（截断的随机正太分布）和 偏置量（0.1）</span></span><br><span class="line">        W1 = tf.Variable(tf.truncated_normal([<span class="number">784</span>, <span class="number">600</span>], stddev = <span class="number">0.1</span>), name = <span class="string">'W1'</span>)</span><br><span class="line">        b1 = tf.Variable(tf.zeros([<span class="number">600</span>]) + <span class="number">0.1</span>, name = <span class="string">'b1'</span>)</span><br><span class="line">        <span class="comment"># 调用函数求权重、偏置值的统计指标</span></span><br><span class="line">        summaries(W1)</span><br><span class="line">        summaries(b1)</span><br><span class="line">        L1 = tf.nn.tanh(tf.matmul(x, W1) + b1)</span><br><span class="line">        L1_drop = tf.nn.dropout(L1, z)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> tf.name_scope(<span class="string">'layer_2'</span>):</span><br><span class="line">        <span class="comment"># 隐藏层</span></span><br><span class="line">        W2 = tf.Variable(tf.truncated_normal([<span class="number">600</span>, <span class="number">400</span>], stddev = <span class="number">0.1</span>), name = <span class="string">'W2'</span>)</span><br><span class="line">        b2 = tf.Variable(tf.zeros([<span class="number">400</span>]) + <span class="number">0.1</span>, name = <span class="string">'b2'</span>)</span><br><span class="line">        summaries(W2)</span><br><span class="line">        summaries(b2)</span><br><span class="line">        L2 = tf.nn.tanh(tf.matmul(L1_drop, W2) + b2)</span><br><span class="line">        L2_drop = tf.nn.dropout(L2, z)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> tf.name_scope(<span class="string">'layer_output'</span>):</span><br><span class="line">        W3 = tf.Variable(tf.truncated_normal([<span class="number">400</span>, <span class="number">10</span>], stddev = <span class="number">0.1</span>), name = <span class="string">'W3'</span>)</span><br><span class="line">        b3 = tf.Variable(tf.zeros([<span class="number">10</span>]) + <span class="number">0.1</span>, name = <span class="string">'b3'</span>)</span><br><span class="line">        summaries(W3)</span><br><span class="line">        summaries(b3)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> tf.name_scope(<span class="string">'softmax'</span>):</span><br><span class="line">        <span class="comment"># softmax 回归模型</span></span><br><span class="line">        prediction = tf.nn.softmax(tf.matmul(L2_drop, W3) + b3)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> tf.name_scope(<span class="string">'loss'</span>):</span><br><span class="line">    <span class="comment"># 二次 Loss Func</span></span><br><span class="line">    <span class="comment"># loss = tf.reduce_mean(tf.square(y - prediction))</span></span><br><span class="line">    <span class="comment"># 交叉熵 Loss Func</span></span><br><span class="line">    <span class="comment"># loss = tf.reduce_mean(-tf.reduce_sum(y * tf.log(prediction), reduction_indices=[1]))</span></span><br><span class="line">    loss = tf.reduce_mean(tf.nn.softmax_cross_entropy_with_logits(labels = y, logits = prediction))</span><br><span class="line">    tf.summary.scalar(<span class="string">'loss'</span>, loss)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> tf.name_scope(<span class="string">'train'</span>):</span><br><span class="line">    <span class="comment"># 梯度下降</span></span><br><span class="line">    <span class="comment"># train_step = tf.train.GradientDescentOptimizer(0.2).minimize(loss)</span></span><br><span class="line">    train_step = tf.train.AdamOptimizer(lr).minimize(loss)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> tf.name_scope(<span class="string">'accuracy'</span>):</span><br><span class="line">    <span class="keyword">with</span> tf.name_scope(<span class="string">'correct_prediction'</span>):</span><br><span class="line">        <span class="comment"># 评估模型</span></span><br><span class="line">        <span class="comment"># 判断 一维张量 y、prediction 中最大值的位置是否相等</span></span><br><span class="line">        correct_prediction = tf.equal(tf.argmax(y, <span class="number">1</span>), tf.argmax(prediction, <span class="number">1</span>))</span><br><span class="line">    <span class="keyword">with</span> tf.name_scope(<span class="string">'accuracy'</span>):</span><br><span class="line">        <span class="comment"># 准确率</span></span><br><span class="line">        <span class="comment"># 将 布尔型列表 corrent_prediction 转化为 float32 类型</span></span><br><span class="line">        <span class="comment"># [true, false, false, ...]  =&gt; [1.0, 0., 0., ...]</span></span><br><span class="line">        accuracy = tf.reduce_mean(tf.cast(correct_prediction, tf.float32))</span><br><span class="line">        tf.summary.scalar(<span class="string">'accuracy'</span>, accuracy)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获得所有定义的 Summary</span></span><br><span class="line">summary_all = tf.summary.merge_all()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置运行资源</span></span><br><span class="line">session_config = tf.ConfigProto(device_count={<span class="string">"CPU"</span>: <span class="number">8</span>}, inter_op_parallelism_threads = <span class="number">32</span>, intra_op_parallelism_threads = <span class="number">48</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> tf.Session(config = session_config) <span class="keyword">as</span> sess:</span><br><span class="line">    tf.global_variables_initializer().run()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 产生 MetaData 文件 [注意，这里只能使用绝对路径]</span></span><br><span class="line">    base_path = <span class="string">'E:/Jupyter/_drafts/ipython/TensorFlow/tensorboard/'</span></span><br><span class="line">    metadata_path = base_path + <span class="string">'metadata.tsv'</span></span><br><span class="line">    <span class="keyword">if</span> tf.gfile.Exists(metadata_path):</span><br><span class="line">        tf.gfile.DeleteRecursively(metadata_path)</span><br><span class="line">    <span class="keyword">with</span> open(metadata_path, <span class="string">'w'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        labels = sess.run(tf.argmax(mnist.test.labels[:], <span class="number">1</span>))</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(image_num):</span><br><span class="line">            f.write(str(labels[i]) + <span class="string">'\n'</span>)   </span><br><span class="line"></span><br><span class="line">    writer = tf.summary.FileWriter(base_path, sess.graph)</span><br><span class="line"></span><br><span class="line">    saver = tf.train.Saver()</span><br><span class="line">    config = projector.ProjectorConfig()</span><br><span class="line">    embed = config.embeddings.add()</span><br><span class="line">    embed.tensor_name = embedding.name</span><br><span class="line">    embed.metadata_path = metadata_path</span><br><span class="line">    embed.sprite.image_path = base_path + <span class="string">'data/mnist_10k_sprite.png'</span></span><br><span class="line">    embed.sprite.single_image_dim.extend([<span class="number">28</span>, <span class="number">28</span>])</span><br><span class="line">    projector.visualize_embeddings(writer, config)</span><br><span class="line"></span><br><span class="line">    batch_size = <span class="number">100</span></span><br><span class="line">    batch = (int) (<span class="number">60000</span> / batch_size)</span><br><span class="line">    <span class="comment"># batch = mnist.train.num_examples</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 这里主要是为了测试 TensorBoard，所以只训练 5 次</span></span><br><span class="line">    summary_count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">        sess.run(tf.assign(lr, <span class="number">0.001</span> * (<span class="number">0.95</span> ** _)))</span><br><span class="line">        <span class="keyword">for</span> batch_step <span class="keyword">in</span> range(batch):</span><br><span class="line">            batch_xs, batch_ys = mnist.train.next_batch(batch_size)</span><br><span class="line">            <span class="comment"># 真正开始生成 metadata</span></span><br><span class="line">            run_options = tf.RunOptions(trace_level = tf.RunOptions.FULL_TRACE)</span><br><span class="line">            run_metadata = tf.RunMetadata()</span><br><span class="line">            summary_, result = sess.run([summary_all, train_step], feed_dict = {x: batch_xs, y: batch_ys, z: <span class="number">0.997</span>}, options = run_options, run_metadata = run_metadata)</span><br><span class="line">            summary_count = summary_count + <span class="number">1</span></span><br><span class="line">            writer.add_run_metadata(run_metadata, <span class="string">'step%03d'</span> % summary_count)</span><br><span class="line">            writer.add_summary(summary_, summary_count)</span><br><span class="line"></span><br><span class="line">        test_accuracy = sess.run(accuracy, feed_dict = {x: mnist.test.images, y: mnist.test.labels, z: <span class="number">1.0</span>})</span><br><span class="line">        train_accuracy = sess.run(accuracy, feed_dict = {x: mnist.train.images, y: mnist.train.labels, z: <span class="number">1.0</span>})</span><br><span class="line">        print(<span class="string">"Batch: "</span>, _, <span class="string">"Accuracy: ["</span>, test_accuracy, <span class="string">","</span>, train_accuracy, <span class="string">"]"</span>)</span><br><span class="line"></span><br><span class="line">    saver.save(sess, base_path + <span class="string">'minst_model.ckpt'</span>, global_step = summary_count)</span><br></pre></td></tr></tbody></table></figure>
<p>Tips: Full code is <a href="http://nbviewer.jupyter.org/github/asdf2014/yuzhouwan/blob/master/yuzhouwan-ai/yuzhouwan-ai-tensorflow/src/main/resources/ipython/TensorBoard.ipynb">here</a>.</p>
<h5 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 执行完，会在程序中指定的目录下生成文件 events.out.tfevents.1502692143.BENEDICT_JIN</span></span><br><span class="line">$ tensorboard --logdir=E:\Jupyter\_drafts\ipython\TensorFlow\tensorboard</span><br><span class="line">  Starting TensorBoard b<span class="string">'54'</span> at http://Benedict_Jin:6006</span><br><span class="line">  (Press CTRL+C to quit)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里 windows 用户需要注意，使用 `cmd` 而不要使用 `git bash` 等工具，同时，还需要切换盘符</span></span><br><span class="line"><span class="comment"># 第二次执行，需要删除生成的文件，使用 `Kernel` - `Restart &amp; Run all` 清理缓存</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="Scalars"><a href="#Scalars" class="headerlink" title="Scalars"></a>Scalars</h5><p><img data-src="/picture/ai/ai_tensorboard_scalars.png" alt=""></p>
<center>（对 <a href="https://www.tensorflow.org" target="_blank">TensorBoard</a> 可视化界面的截图）</center>


<h5 id="Graphs"><a href="#Graphs" class="headerlink" title="Graphs"></a>Graphs</h5><p><img data-src="/picture/ai/ai_tensorboard_graph.png" alt=""></p>
<center>（对 <a href="https://www.tensorflow.org" target="_blank">TensorBoard</a> 可视化界面的截图）</center>


<h5 id="Embedding"><a href="#Embedding" class="headerlink" title="Embedding"></a>Embedding</h5><p><img data-src="/picture/ai/ai_tensorboard_embeddings.png" alt=""></p>
<center>（对 <a href="https://www.tensorflow.org" target="_blank">TensorBoard</a> 可视化界面的截图）</center>



<h4 id="GPU-加速"><a href="#GPU-加速" class="headerlink" title="GPU 加速"></a>GPU 加速</h4><h5 id="准备-NVIDIA-显卡"><a href="#准备-NVIDIA-显卡" class="headerlink" title="准备 NVIDIA 显卡"></a>准备 NVIDIA 显卡</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">显卡2详情</span><br><span class="line">显卡名称  NVIDIA GeForce GTX 960M</span><br><span class="line">显卡厂商  英伟达</span><br><span class="line">显存大小  4095 MB</span><br><span class="line">内核名称  GeForce GTX 960M</span><br><span class="line">内核频率  324 MHz</span><br><span class="line">显存频率  405 MHz</span><br><span class="line">驱动版本  21.21.13.7651</span><br></pre></td></tr></tbody></table></figure>
<h5 id="CUDA（Compute-Unified-Device-Architecture）"><a href="#CUDA（Compute-Unified-Device-Architecture）" class="headerlink" title="CUDA（Compute Unified Device Architecture）"></a>CUDA（Compute Unified Device Architecture）</h5><p>　在 <a href="https://developer.nvidia.com/cuda-downloads">下载地址</a> 找到系统对应的版本进行下载安装（<code>Windows</code> - <code>x86_64</code> - <code>10</code> - <code>exe</code> - <code>cuda_8.0.61_win10.exe</code>）</p>
<p>　安装成功后，将 <code>bin</code> 和 <code>lib/x64</code> 添加到系统 <code>PATH</code> 环境变量中</p>
<h5 id="cuDNN"><a href="#cuDNN" class="headerlink" title="cuDNN"></a>cuDNN</h5><p>　在 <a href="https://developer.nvidia.com/rdp/cudnn-download">登陆页面</a> 注册好 Nvidia 的账户后，下载对应 CUDA 版本的 cuDNN 即可（<code>cudnn-8.0-windows10-x64-v5.1.zip</code>）</p>
<p>　将压缩包中 <code>bin</code> / <code>include</code> / <code>lib</code> 中的文件，拷贝到 <code>C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v8.0</code> 下对应目录中。最后，将 <code>C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v8.0\extras\CUPTI\libx64\cupti64_80.dll</code> 文件复制到 <code>C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v8.0\bin</code> 下</p>
<h5 id="tensorflow-gpu"><a href="#tensorflow-gpu" class="headerlink" title="tensorflow-gpu"></a>tensorflow-gpu</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ pip uninstall tensorflow</span><br><span class="line">$ pip install tensorflow-gpu</span><br><span class="line"><span class="comment"># 如果只有一颗 gpu，程序是不需要修改的，默认会直接使用该 gpu 进行运算</span></span><br><span class="line"><span class="comment"># 如果有多个，可以使用 with tf.device('/gpu:1'): 进行指定</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="nvidia-smi-命令"><a href="#nvidia-smi-命令" class="headerlink" title="nvidia-smi 命令"></a>nvidia-smi 命令</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># nvidia-smi 可以查看 GPU 的资源、监控 GPU 运行状态、设置 GPU 超频 等等</span></span><br><span class="line">$ <span class="string">"C:\Program Files\NVIDIA Corporation\NVSMI\nvidia-smi.exe"</span></span><br><span class="line">  Tue Sep 19 23:33:29 2017</span><br><span class="line">  +-----------------------------------------------------------------------------+</span><br><span class="line">  | NVIDIA-SMI 385.41                 Driver Version: 385.41                    |</span><br><span class="line">  |-------------------------------+----------------------+----------------------+</span><br><span class="line">  | GPU  Name            TCC/WDDM | Bus-Id        Disp.A | Volatile Uncorr. ECC |</span><br><span class="line">  | Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |</span><br><span class="line">  |===============================+======================+======================|</span><br><span class="line">  |   0  GeForce GTX 960M   WDDM  | 00000000:02:00.0 Off |                  N/A |</span><br><span class="line">  | N/A   55C    P8    N/A /  N/A |     30MiB /  4096MiB |      0%      Default |</span><br><span class="line">  +-------------------------------+----------------------+----------------------+</span><br><span class="line"></span><br><span class="line">  +-----------------------------------------------------------------------------+</span><br><span class="line">  | Processes:                                                       GPU Memory |</span><br><span class="line">  |  GPU       PID   Type   Process name                             Usage      |</span><br><span class="line">  |=============================================================================|</span><br><span class="line">  |  No running processes found                                                 |</span><br><span class="line">  +-----------------------------------------------------------------------------+</span><br></pre></td></tr></tbody></table></figure>
<h4 id="CNN"><a href="#CNN" class="headerlink" title="CNN"></a>CNN</h4><h5 id="CNN-版手写数字识别"><a href="#CNN-版手写数字识别" class="headerlink" title="CNN 版手写数字识别"></a>CNN 版手写数字识别</h5><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">from</span> tensorflow.examples.tutorials.mnist <span class="keyword">import</span> input_data</span><br><span class="line"></span><br><span class="line">mnist = input_data.read_data_sets(<span class="string">'MNIST_data'</span>, one_hot=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 权值</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">weight_variable</span>(<span class="params">shape</span>):</span></span><br><span class="line">    initial = tf.truncated_normal(shape=shape, stddev=<span class="number">0.1</span>)</span><br><span class="line">    <span class="keyword">return</span> tf.Variable(initial_value=initial)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 偏置值</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bias_variable</span>(<span class="params">shape</span>):</span></span><br><span class="line">    initial = tf.constant(<span class="number">0.1</span>, shape=shape)</span><br><span class="line">    <span class="keyword">return</span> tf.Variable(initial_value=initial)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 卷积层</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">conv2d</span>(<span class="params">x, W</span>):</span></span><br><span class="line">    <span class="comment"># x:  `  [batch, in_height, in_width, in_channels]`</span></span><br><span class="line">    <span class="comment">#        [批次大小，输入图片的长和宽，通道数（黑白：2；彩色：3）]</span></span><br><span class="line">    <span class="comment"># W: `[filter_height, filter_width, in_channels, out_channels]`</span></span><br><span class="line">    <span class="comment">#     [滤波器长，宽，输入通道数，输出通道数]</span></span><br><span class="line">    <span class="comment"># strides: `[1, stride, stride, 1]`</span></span><br><span class="line">    <span class="comment">#           [固定为 1，x/y 方向的步长，固定为 1]</span></span><br><span class="line">    <span class="comment"># padding: 是否在外部补零</span></span><br><span class="line">    <span class="keyword">return</span> tf.nn.conv2d(x, W, strides=[<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>], padding=<span class="string">'SAME'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 池化层</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">max_pool_2x2</span>(<span class="params">x</span>):</span></span><br><span class="line">    <span class="comment"># x:  `  [batch, in_height, in_width, in_channels]`</span></span><br><span class="line">    <span class="comment">#        [批次大小，输入图片的长和宽，通道数（黑白：2；彩色：3）]</span></span><br><span class="line">    <span class="comment"># ksize: [固定为 1，窗口大小，固定为 1]</span></span><br><span class="line">    <span class="comment"># strides: `[1, stride, stride, 1]`</span></span><br><span class="line">    <span class="comment">#           [固定为 1，x/y 方向的步长，固定为 1]</span></span><br><span class="line">    <span class="comment"># padding: 是否在外部补零</span></span><br><span class="line">    <span class="keyword">return</span> tf.nn.max_pool(x, ksize=[<span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>], strides=[<span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>], padding=<span class="string">'SAME'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Place Holder</span></span><br><span class="line">x = tf.placeholder(tf.float32, [<span class="literal">None</span>, <span class="number">784</span>])</span><br><span class="line">y = tf.placeholder(tf.float32, [<span class="literal">None</span>, <span class="number">10</span>])</span><br><span class="line"><span class="comment"># Learn Rate 学习率</span></span><br><span class="line">lr = tf.Variable(<span class="number">0.001</span>, dtype = tf.float32)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 x 的转化为 4D 向量</span></span><br><span class="line"><span class="comment"># [batch, in_height, in_width, in_channels]</span></span><br><span class="line">x_image = tf.reshape(x, [<span class="number">-1</span>, <span class="number">28</span>, <span class="number">28</span>, <span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化第一个卷积层 权值和偏置值</span></span><br><span class="line"><span class="comment"># 5*5 的采样窗口，32 个卷积核（输出 channels 数）从 1 个平面（输入 channels 数）抽取特征，获得 32 个特征平面</span></span><br><span class="line">W_conv1 = weight_variable([<span class="number">5</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">32</span>])</span><br><span class="line"><span class="comment"># 32 个卷积核，每个卷积核对应一个偏置值</span></span><br><span class="line">b_conv1 = bias_variable([<span class="number">32</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行卷积采样操作，并加上偏置值</span></span><br><span class="line">conv2d_1 = conv2d(x_image, W_conv1) + b_conv1</span><br><span class="line"><span class="comment"># ReLU 激活函数，获得第一个卷积层，计算得到的结果</span></span><br><span class="line">h_conv1 = tf.nn.relu(conv2d_1)</span><br><span class="line"><span class="comment"># 执行 pooling 池化操作</span></span><br><span class="line">h_pool1 = max_pool_2x2(h_conv1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第二个卷积层 + 激活函数 + 池化层</span></span><br><span class="line">W_conv2 = weight_variable([<span class="number">5</span>, <span class="number">5</span>, <span class="number">32</span>, <span class="number">64</span>])</span><br><span class="line">b_conv2 = bias_variable([<span class="number">64</span>])</span><br><span class="line">conv2d_2 = conv2d(h_pool1, W_conv2) + b_conv2</span><br><span class="line">h_conv2 = tf.nn.relu(conv2d_2)</span><br><span class="line">h_pool2 = max_pool_2x2(h_conv2)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第一次卷积操作后，28 * 28 图片仍然是 28 * 28</span></span><br><span class="line"><span class="comment"># 第一次池化之后，因为 2 * 2 的窗口，所以变成了 14 * 14</span></span><br><span class="line"><span class="comment"># 第二次卷积之后，仍然保持 14 * 14 的平面大小</span></span><br><span class="line"><span class="comment"># 第二次池化之后，因为 2 * 2 的窗口，所以变成了 7 * 7</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 全连接层一共有 1000 个神经元，连接上一层的 7 * 7* 64 = 3136 个神经元</span></span><br><span class="line">W_fc1 = weight_variable([<span class="number">7</span> * <span class="number">7</span> * <span class="number">64</span>, <span class="number">1000</span>])</span><br><span class="line">b_fc1 = bias_variable([<span class="number">1000</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 把上一层的池化层，转化为 1 维（-1 代表任意值）</span></span><br><span class="line">h_pool2_flat = tf.reshape(h_pool2, [<span class="number">-1</span>, <span class="number">7</span> * <span class="number">7</span> * <span class="number">64</span>])</span><br><span class="line"><span class="comment"># 矩阵相乘，并加上偏置值</span></span><br><span class="line">wx_plus_b1 = tf.matmul(h_pool2_flat, W_fc1) + b_fc1</span><br><span class="line"><span class="comment"># ReLU 激活函数</span></span><br><span class="line">h_fc1 = tf.nn.relu(wx_plus_b1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># dropout 正则化</span></span><br><span class="line">keep_prob = tf.placeholder(tf.float32)</span><br><span class="line">h_fc1_drop = tf.nn.dropout(h_fc1, keep_prob)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第二个全连接层</span></span><br><span class="line">W_fc2 = weight_variable([<span class="number">1000</span>, <span class="number">10</span>])</span><br><span class="line">b_fc2 = bias_variable([<span class="number">10</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算输出</span></span><br><span class="line">wx_plus_b2 = tf.matmul(h_fc1_drop, W_fc2) + b_fc2</span><br><span class="line">prediction = tf.nn.softmax(wx_plus_b2)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 交叉熵 Loss Function</span></span><br><span class="line">cross_entropy = tf.reduce_mean(tf.nn.softmax_cross_entropy_with_logits(labels=y, logits=prediction))  </span><br><span class="line"><span class="comment"># Adam 优化器，配合一个不断下降的学习率</span></span><br><span class="line">train_step = tf.train.AdamOptimizer(lr).minimize(cross_entropy)</span><br><span class="line"></span><br><span class="line"><span class="comment"># argmax 方法，会返回一维张量中最大值所在的位置</span></span><br><span class="line"><span class="comment"># 计算正确率</span></span><br><span class="line">correct_prediction = tf.equal(tf.argmax(prediction, <span class="number">1</span>), tf.argmax(y, <span class="number">1</span>))</span><br><span class="line">accuracy = tf.reduce_mean(tf.cast(correct_prediction, tf.float32))</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> tf.device(<span class="string">'/gpu:0'</span>):</span><br><span class="line">    <span class="keyword">with</span> tf.Session() <span class="keyword">as</span> sess:</span><br><span class="line">        tf.global_variables_initializer().run()</span><br><span class="line"></span><br><span class="line">        batch_size = <span class="number">100</span></span><br><span class="line">        batch = (int) (<span class="number">60000</span> / batch_size)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">101</span>):</span><br><span class="line">            sess.run(tf.assign(lr, <span class="number">0.0001</span> * (<span class="number">0.95</span> ** _)))</span><br><span class="line">            <span class="keyword">for</span> batch_step  <span class="keyword">in</span> range(batch):</span><br><span class="line">                batch_xs, batch_ys = mnist.train.next_batch(batch_size)</span><br><span class="line">                sess.run(train_step, feed_dict={x: batch_xs, y: batch_ys, keep_prob: <span class="number">0.68</span>})</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> _ % <span class="number">20</span> == <span class="number">0</span>:</span><br><span class="line">                test_acc = sess.run(accuracy,feed_dict={x: mnist.test.images, y: mnist.test.labels, keep_prob: <span class="number">1.0</span>})</span><br><span class="line">                print(<span class="string">"Iterator: "</span>, _, <span class="string">"Accuracy:"</span>, test_acc)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  Iterator:  <span class="number">0</span> Accuracy: <span class="number">0.954</span></span><br><span class="line">  Iterator:  <span class="number">20</span> Accuracy: <span class="number">0.9912</span></span><br><span class="line">  Iterator:  <span class="number">40</span> Accuracy: <span class="number">0.9916</span></span><br><span class="line">  Iterator:  <span class="number">60</span> Accuracy: <span class="number">0.9924</span></span><br><span class="line">  Iterator:  <span class="number">80</span> Accuracy: <span class="number">0.9924</span></span><br><span class="line">  Iterator:  <span class="number">100</span> Accuracy: <span class="number">0.9926</span></span><br></pre></td></tr></tbody></table></figure>
<p>Tips: Full code is <a href="http://nbviewer.jupyter.org/github/asdf2014/yuzhouwan/blob/master/yuzhouwan-ai/yuzhouwan-ai-tensorflow/src/main/resources/ipython/MNIST_CNN.ipynb">here</a>, and Kaggle competition is <a href="https://www.kaggle.com/c/digit-recognizer/leaderboard">here</a>.</p>
<h4 id="RNN"><a href="#RNN" class="headerlink" title="RNN"></a>RNN</h4><h5 id="LSTM-版手写数字识别"><a href="#LSTM-版手写数字识别" class="headerlink" title="LSTM 版手写数字识别"></a>LSTM 版手写数字识别</h5><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">from</span> tensorflow.examples.tutorials.mnist <span class="keyword">import</span> input_data</span><br><span class="line"></span><br><span class="line">mnist = input_data.read_data_sets(<span class="string">"MNIST_data/"</span>, one_hot=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输入的图片，每张 28*28 个像素</span></span><br><span class="line">n_inputs = <span class="number">28</span>      <span class="comment"># 输入的每行有 28 个数据，输入层 神经元的个数</span></span><br><span class="line">max_time = <span class="number">28</span>      <span class="comment"># 输入的次数为 28 次</span></span><br><span class="line">lstm_size = <span class="number">100</span>    <span class="comment"># 隐藏层 block 单元</span></span><br><span class="line">n_classes = <span class="number">10</span>     <span class="comment"># 分类个数</span></span><br><span class="line">batch_size = <span class="number">50</span>    <span class="comment"># 单批次的样本数量</span></span><br><span class="line">n_batch = mnist.train.num_examples / batch_size   <span class="comment"># 一共会分成多少批次</span></span><br><span class="line"></span><br><span class="line">x = tf.placeholder(tf.float32, [<span class="literal">None</span>, <span class="number">784</span>])</span><br><span class="line">y = tf.placeholder(tf.float32, [<span class="literal">None</span>, <span class="number">10</span>])</span><br><span class="line">weights = tf.Variable(tf.truncated_normal([lstm_size, n_classes], stddev=<span class="number">0.1</span>))</span><br><span class="line">biases = tf.Variable(tf.constant(<span class="number">0.1</span>, shape=[n_classes]))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">LSTM</span>(<span class="params">x, weights, biases</span>):</span></span><br><span class="line">    inputs = tf.reshape(x, [<span class="number">-1</span>, max_time, n_inputs])</span><br><span class="line">    <span class="comment"># 定义隐藏层 block 单元</span></span><br><span class="line">    lstm_cell = tf.contrib.rnn.BasicLSTMCell(lstm_size)</span><br><span class="line">    <span class="comment"># final_state[0]: cell state</span></span><br><span class="line">    <span class="comment"># final_state[1]: hidden_state</span></span><br><span class="line">    outputs, final_state = tf.nn.dynamic_rnn(lstm_cell, inputs, dtype=tf.float32)</span><br><span class="line">    <span class="keyword">return</span> tf.nn.softmax(tf.matmul(final_state[<span class="number">1</span>], weights) + biases)</span><br><span class="line"></span><br><span class="line">prediction = LSTM(x, weights, biases)</span><br><span class="line">cross_entropy = tf.reduce_mean(tf.nn.softmax_cross_entropy_with_logits(logits=prediction, labels=y))</span><br><span class="line">train_step = tf.train.AdamOptimizer(<span class="number">1e-4</span>).minimize(cross_entropy)</span><br><span class="line">correct_prediction = tf.equal(tf.argmax(y, <span class="number">1</span>), tf.argmax(prediction, <span class="number">1</span>))</span><br><span class="line">accuracy = tf.reduce_mean(tf.cast(correct_prediction, tf.float32))</span><br><span class="line">init = tf.global_variables_initializer()</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> tf.Session() <span class="keyword">as</span> sess:</span><br><span class="line">    sess.run(init)</span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> range(<span class="number">101</span>):</span><br><span class="line">        <span class="keyword">for</span> batch <span class="keyword">in</span> range(int(n_batch)):</span><br><span class="line">            batch_xs, batch_ys = mnist.train.next_batch(batch_size)</span><br><span class="line">            sess.run(train_step, feed_dict={x: batch_xs, y: batch_ys})</span><br><span class="line">        <span class="keyword">if</span> epoch % <span class="number">10</span> == <span class="number">0</span>:</span><br><span class="line">            acc = sess.run(accuracy, feed_dict={x:mnist.test.images, y:mnist.test.labels})</span><br><span class="line">            print(<span class="string">"Iterator:"</span>, str(epoch), <span class="string">", Accuracy:"</span>, str(acc))</span><br><span class="line"></span><br><span class="line">  Iterator: <span class="number">0</span> , Accuracy: <span class="number">0.7244</span></span><br><span class="line">  Iterator: <span class="number">10</span> , Accuracy: <span class="number">0.946</span></span><br><span class="line">  Iterator: <span class="number">20</span> , Accuracy: <span class="number">0.9646</span></span><br><span class="line">  Iterator: <span class="number">30</span> , Accuracy: <span class="number">0.9696</span></span><br><span class="line">  Iterator: <span class="number">40</span> , Accuracy: <span class="number">0.9717</span></span><br><span class="line">  Iterator: <span class="number">50</span> , Accuracy: <span class="number">0.9764</span></span><br><span class="line">  Iterator: <span class="number">60</span> , Accuracy: <span class="number">0.9776</span></span><br><span class="line">  Iterator: <span class="number">70</span> , Accuracy: <span class="number">0.9801</span></span><br><span class="line">  Iterator: <span class="number">80</span> , Accuracy: <span class="number">0.9814</span></span><br><span class="line">  Iterator: <span class="number">90</span> , Accuracy: <span class="number">0.9793</span></span><br><span class="line">  Iterator: <span class="number">100</span> , Accuracy: <span class="number">0.9814</span></span><br></pre></td></tr></tbody></table></figure>
<p>Tips: Full code is <a href="http://nbviewer.jupyter.org/github/asdf2014/yuzhouwan/blob/master/yuzhouwan-ai/yuzhouwan-ai-tensorflow/src/main/resources/ipython/MNIST_LSTM.ipynb">here</a>.</p>
<h3 id="pyTorch-pyTorch"><a href="#pyTorch-pyTorch" class="headerlink" title="pyTorch / pyTorch"></a><a href="https://github.com/pytorch">pyTorch</a> / <a href="https://github.com/pytorch/pytorch"><strong>pyTorch</strong></a></h3><h4 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h4><p>　<strong>PyTorch</strong>™ is a Python package that provides two high-level features: Tensor computation (like NumPy) with strong GPU acceleration and Deep neural networks built on a tape-based autograd system</p>
<h4 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h4><p>　到 <a href="https://github.com/peterjc123/pytorch-scripts">pytorch-scripts</a> 项目中，下载当前最新的 <a href="https://github.com/pytorch/pytorch/releases">release</a> 版本 <a href="https://ci.appveyor.com/api/buildjobs/9gexsv1wq91hj2hj/artifacts/output%2Ftorch-0.3.0b0%2B591e73e-cp35-cp35m-win_amd64.whl">torch-0.3.0b0+591e73e-cp35-cp35m-win_amd64.whl</a>，并<a href="http://pytorch.org/#pip-install-pytorch">安装</a></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ pip install <span class="string">"torch-0.3.0b0+591e73e-cp35-cp35m-win_amd64.whl"</span></span><br></pre></td></tr></tbody></table></figure>
<p>Tips: Full code is <a href="http://nbviewer.jupyter.org/github/asdf2014/yuzhouwan/blob/master/yuzhouwan-ai/yuzhouwan-ai-pytorch/src/main/resources/ipython/hello_world.ipynb">here</a>.</p>
<h4 id="编程实战-1"><a href="#编程实战-1" class="headerlink" title="编程实战"></a>编程实战</h4><h5 id="Hello-world"><a href="#Hello-world" class="headerlink" title="Hello-world"></a>Hello-world</h5><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"></span><br><span class="line">t = torch.Tensor(<span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">print(t)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 1.00000e-29 *</span></span><br><span class="line">  <span class="comment">#   2.7413</span></span><br><span class="line">  <span class="comment"># [torch.FloatTensor of size 1]</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="BVLC-Caffe"><a href="#BVLC-Caffe" class="headerlink" title="BVLC / Caffe"></a><a href="https://github.com/BVLC">BVLC</a> / <a href="https://github.com/BVLC/caffe"><strong>Caffe</strong></a></h3><h4 id="介绍-2"><a href="#介绍-2" class="headerlink" title="介绍"></a>介绍</h4><p>　<strong>Caffe</strong>™ (<strong>C</strong>onvolutional <strong>A</strong>rchitecture for <strong>F</strong>ast <strong>F</strong>eature <strong>E</strong>mbedding) is a deep learning framework made with expression, speed, and modularity in mind. It is developed by Berkeley AI Research (<a href="http://bair.berkeley.edu/">BAIR</a>) and by community contributors. <a href="http://daggerfs.com/">Yangqing Jia</a> created the project during his PhD at UC Berkeley. Caffe is released under the <a href="https://github.com/BVLC/caffe/blob/master/LICENSE">BSD 2-Clause license</a>.</p>
<h3 id="dmlc-xgboost"><a href="#dmlc-xgboost" class="headerlink" title="dmlc / xgboost"></a><a href="https://github.com/dmlc">dmlc</a> / <a href="https://github.com/dmlc/xgboost"><strong>xgboost</strong></a></h3><h4 id="介绍-3"><a href="#介绍-3" class="headerlink" title="介绍"></a>介绍</h4><p>　<strong>XGBoost</strong>™ is an optimized distributed gradient boosting library designed to be highly efficient, flexible and portable. It implements machine learning algorithms under the Gradient Boosting framework. <a href="http://blog.csdn.net/sb19931201/article/details/52557382">XGBoost</a> provides a parallel tree boosting (also known as GBDT, GBM) that solve many data science problems in a fast and accurate way. The same code runs on major distributed environment (Hadoop, SGE, MPI) and can solve problems beyond billions of examples.</p>
<h3 id="Apache-PredictionIO"><a href="#Apache-PredictionIO" class="headerlink" title="Apache / PredictionIO"></a><a href="https://github.com/apache">Apache</a> / <a href="https://github.com/apache/predictionio">PredictionIO</a></h3><h4 id="介绍-4"><a href="#介绍-4" class="headerlink" title="介绍"></a>介绍</h4><p>　<strong>Apache PredictionIO</strong>™ is an open source Machine Learning Server built on top of a state-of-the-art open source stack for developers and data scientists to create predictive engines for any machine learning task.</p>
<h3 id="Numenta-NuPIC"><a href="#Numenta-NuPIC" class="headerlink" title="Numenta / NuPIC"></a><a href="https://github.com/numenta">Numenta</a> / <strong><a href="https://github.com/numenta/nupic">NuPIC</a></strong></h3><h4 id="介绍-5"><a href="#介绍-5" class="headerlink" title="介绍"></a>介绍</h4><p>　<strong>NuPIC</strong>™<code>(Numenta Platform for Intelligent Computing, Numenta 智能计算平台)</code> 是一个与众不同的开源人工智能平台，它基于一种<code>脑皮质学习算法</code>，即 “层级实时记忆”（<strong>H</strong>ierarchical <strong>T</strong>emporal <strong>M</strong>emory, <a href="https://numenta.com/assets/pdf/whitepapers/hierarchical-temporal-memory-cortical-learning-algorithm-0.2.1-en.pdf">HTM</a>）。该算法旨在模拟新大脑皮层的工作原理，将复杂的问题转化为模式匹配与预测，而传统的 AI算法大多是针对特定的任务目标而设计的<br>　NuPIC 聚焦于分析实时数据流，可以通过学习数据之间基于时间的状态变化，对未知数据进行预测，并揭示其中的非常规特性</p>
<h5 id="特性-1"><a href="#特性-1" class="headerlink" title="特性"></a>特性</h5><ul>
<li>持续的在线学习（根据快速变化的数据流进行<strong>实时调整</strong>）</li>
<li>时间和空间分析（可以同时模拟<strong>时间</strong>和<strong>空间的变化</strong>）</li>
<li>通过<strong>通用性</strong>的大脑皮层算法，进行预测和建模</li>
<li>强大的异常检测能力（实时检测数据流的扰动，不依靠<strong>僵化的阈值</strong>设置和过时的算法）</li>
<li>层级实时存储算法</li>
</ul>
<h4 id="安装-2"><a href="#安装-2" class="headerlink" title="安装"></a>安装</h4><h5 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ yum install glibc-devel.i686 gcc -y</span><br><span class="line">$ python -V</span><br><span class="line">  Python 2.7.12</span><br><span class="line">$ pip -V</span><br><span class="line">  pip 9.0.1 from /usr/<span class="built_in">local</span>/lib/python2.7/site-packages (python 2.7)</span><br><span class="line">$ pip install nupic</span><br></pre></td></tr></tbody></table></figure>
<h5 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h5><p>　可能部分版本不支持，需要结合 Nupic 的 <a href="https://github.com/numenta/nupic/releases">Release</a> 和 <a href="https://pypi.python.org/pypi/nupic.bindings">PyPi 平台</a>找到合适的版本</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ pip install https://s3-us-west-2.amazonaws.com/artifacts.numenta.org/numenta/nupic.core/releases/nupic.bindings/nupic.bindings-0.4.5-cp27-none-linux_x86_64.whl</span><br><span class="line">$ pip install nupic==0.4.5</span><br></pre></td></tr></tbody></table></figure>
<h2 id="AI-到底是什么？"><a href="#AI-到底是什么？" class="headerlink" title="AI 到底是什么？"></a>AI 到底是什么？</h2><h3 id="套娃"><a href="#套娃" class="headerlink" title="套娃"></a>套娃</h3><p>　从体系组成成分的角度来讲，人工智能，包含<a href="https://en.wikipedia.org/wiki/Machine_learning">机器学习</a>。而机器学习，又包含了<a href="https://en.wikipedia.org/wiki/Deep_learning">深度学习</a></p>
<h3 id="四象限"><a href="#四象限" class="headerlink" title="四象限"></a>四象限</h3><p>　从 “是否类人类”、“是否产生动作” 两个方向，又可以将人工智能化分为四个象限</p>
<p>　在 $x$ 轴正方向上，我们希望 AI 系统只需给出某类问题的最优解，并不用考虑是否会和人类一样去思考这个问题，例如地图导航系统，只需要算出两点的最佳路径即可。而 $x$ 轴的负方向上，则希望 AI 系统能表现出人类的思想活动，比如能听着音乐点头、摇摆的机器人，能去享受旋律；另一方面，在 $y$ 轴的正方向上，AI 系统更侧重于思考，譬如 类似 Siri™ 助理系统，可以处理人们通过语音输入的指令，并能思考出最为合理的反应。而 $y$ 轴的负方向上，则会偏向于动作的产生，比方说流水线上完成材料加工、处理工作的工业机器人</p>
<p><img data-src="/picture/ai/ai_four.png" alt=""></p>
<center>（使用 <a href="https://www.apple.com/cn/ipad/" target="_blank">iPad</a>™ 手绘而成）</center>






<h2 id="常见误区"><a href="#常见误区" class="headerlink" title="常见误区"></a>常见误区</h2><h3 id="OverSampling-和-Data-Augmentation-的区别"><a href="#OverSampling-和-Data-Augmentation-的区别" class="headerlink" title="OverSampling 和 Data Augmentation 的区别"></a><a href="https://stats.stackexchange.com/questions/249142/over-sampling-for-minority-classes">OverSampling</a> 和 <a href="https://arxiv.org/pdf/1609.08764.pdf">Data Augmentation</a> 的区别</h3><h3 id="Transfer-Learning-和-Fine-tuning-的区别"><a href="#Transfer-Learning-和-Fine-tuning-的区别" class="headerlink" title="Transfer Learning 和 Fine-tuning 的区别"></a>Transfer Learning 和 Fine-tuning 的<a href="https://www.zhihu.com/question/49534423">区别</a></h3><h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><h3 id="Doc"><a href="#Doc" class="headerlink" title="Doc"></a>Doc</h3><ul>
<li><a href="http://nupic.docs.numenta.org/stable/quick-start/index.html">NuPIC Quick Start</a></li>
<li><a href="https://github.com/lxzheng/machine_learning/wiki/TFlearn---%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8">TFlearn 快速入门</a></li>
<li><a href="https://gym.openai.com/docs/">OpenAI Gym is a toolkit for developing and comparing reinforcement learning algorithms</a></li>
<li><a href="http://pytorch.org/tutorials/">Welcome to PyTorch Tutorials</a></li>
</ul>
<h3 id="Blog"><a href="#Blog" class="headerlink" title="Blog"></a>Blog</h3><h4 id="机器学习-1"><a href="#机器学习-1" class="headerlink" title="机器学习"></a>机器学习</h4><ul>
<li><a href="http://blog.csdn.net/zouxy09">zouxy09 的专栏</a></li>
<li><a href="https://www.zhihu.com/question/20224890">机器学习领域有哪些著名的期刊和会议?</a></li>
<li><a href="http://blog.csdn.net/v_july_v/article/details/7624837">支持向量机通俗导论（理解 SVM 的三层境界）</a></li>
</ul>
<h4 id="人工智能"><a href="#人工智能" class="headerlink" title="人工智能"></a>人工智能</h4><ul>
<li><a href="https://www.zhihu.com/question/54884091">有哪些 AI 开源框架可供开发者使用？</a></li>
<li><a href="http://blog.csdn.net/shinanhualiu/article/details/49864219">理解 LSTM 网络</a></li>
<li><a href="http://blog.csdn.net/diamonjoy_zone/article/details/70904212">Deep Learning-TensorFlow（14）CNN 卷积神经网络：深度残差网络 ResNet</a></li>
<li><a href="http://www.primaryobjects.com/2013/01/27/using-artificial-intelligence-to-write-self-modifying-improving-programs/">Using Artificial Intelligence to Write Self-Modifying/Improving Programs</a></li>
<li><a href="http://www.infoq.com/cn/articles/cnn-and-imagenet-champion-model-analysis">CNN 浅析和历年 ImageNet 冠军模型解析</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/28749411">变形卷积核、可分离卷积？卷积神经网络中十大拍案叫绝的操作。</a></li>
<li><a href="http://blog.echen.me/2017/05/30/exploring-lstms/">Exploring LSTMs</a></li>
<li><a href="http://colah.github.io/posts/2015-08-Backprop/">Calculus on Computational Graphs: Backpropagation</a></li>
<li><a href="https://harishnarayanan.org/writing/artistic-style-transfer/">Convolutional neural networks for artistic style transfer</a></li>
</ul>
<h4 id="强化学习"><a href="#强化学习" class="headerlink" title="强化学习"></a>强化学习</h4><ul>
<li><a href="https://zhuanlan.zhihu.com/p/21498750">深度强化学习导引</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/22542101">深度强化学习 强化学习概述</a></li>
<li><a href="http://blog.greenwicher.com/2016/12/18/drl-general_ai-intro/">走向通用人工智能之路</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/21609472?refer=intelligentunit">DQN 从入门到放弃系列</a></li>
<li><a href="https://www.zhihu.com/question/49230922">强化学习（reinforcement learning）有什么好的开源项目、网站、文章推荐一下？</a></li>
<li><a href="http://karpathy.github.io/2016/05/31/rl/">Deep Reinforcement Learning: Pong from Pixels</a></li>
<li><a href="http://mnemstudio.org/path-finding-q-learning-tutorial.htm">Q-learning</a></li>
<li><a href="https://devblogs.nvidia.com/parallelforall/train-reinforcement-learning-agents-openai-gym/">Train Your Reinforcement Learning Agents at the OpenAI Gym</a></li>
<li><a href="http://icml.cc/2016/tutorials/deep_rl_tutorial.pdf">David silve’s tutorial on ICML’16</a></li>
</ul>
<h4 id="胶囊网络"><a href="#胶囊网络" class="headerlink" title="胶囊网络"></a>胶囊网络</h4><ul>
<li><a href="https://papers.nips.cc/paper/6975-dynamic-routing-between-capsules.pdf">Dynamic Routing Between Capsules</a></li>
<li><a href="https://medium.com/ai%C2%B3-theory-practice-business/understanding-hintons-capsule-networks-part-i-intuition-b4b559d1159b">Part I: Intuition</a></li>
<li><a href="https://medium.com/ai%C2%B3-theory-practice-business/understanding-hintons-capsule-networks-part-ii-how-capsules-work-153b6ade9f66">Part II: How Capsules Work</a></li>
<li><a href="https://medium.com/@pechyonkin/understanding-hintons-capsule-networks-part-iii-dynamic-routing-between-capsules-349f6d30418">Part III: Dynamic Routing Between Capsules</a></li>
<li><a href="https://medium.com/@pechyonkin/part-iv-capsnet-architecture-6a64422f7dce">Part IV: CapsNet Architecture</a></li>
</ul>
<h3 id="Book"><a href="#Book" class="headerlink" title="Book"></a>Book</h3><h4 id="统计学-1"><a href="#统计学-1" class="headerlink" title="统计学"></a>统计学</h4><ul>
<li><a href="https://book.douban.com/subject/1588297/">统计学（第二版 David Freedman 等著）</a></li>
<li><a href="https://book.douban.com/subject/1230154/">统计学：基本概念与方法</a></li>
<li><a href="https://www.amazon.cn/%E5%9B%BE%E4%B9%A6/dp/1461381738">The Making of Statisticians</a></li>
</ul>
<h4 id="微积分-1"><a href="#微积分-1" class="headerlink" title="微积分"></a>微积分</h4><ul>
<li><a href="https://www.amazon.cn/%E5%9B%BE%E4%B9%A6/dp/B01M28M4G6">普林斯顿微积分读本（修订版）</a></li>
<li><a href="https://book.douban.com/subject/1231399/">托马斯微积分（第 11 版）</a></li>
</ul>
<h4 id="概率论-1"><a href="#概率论-1" class="headerlink" title="概率论"></a>概率论</h4><ul>
<li><a href="https://www.amazon.cn/%E5%9B%BE%E4%B9%A6/dp/B019NB0UZQ">概率导论（第二版 修订版）</a></li>
</ul>
<h4 id="机器学习-2"><a href="#机器学习-2" class="headerlink" title="机器学习"></a>机器学习</h4><ul>
<li><a href="https://book.douban.com/subject/26708119/">机器学习（周志华 著）</a> <code>又名"西瓜书"</code></li>
</ul>
<h4 id="人工智能-1"><a href="#人工智能-1" class="headerlink" title="人工智能"></a>人工智能</h4><ul>
<li><a href="https://book.douban.com/subject/1834728/">人工智能的未来</a></li>
<li><a href="https://exacity.github.io/deeplearningbook-chinese/">Deep Learning（Yoshua Bengio 著）</a> <code>又名"花书"</code></li>
<li><a href="https://book.douban.com/subject/26976457/">Tensorflow：实战 Google 深度学习框架</a></li>
<li><a href="https://www.amazon.cn/%E5%9B%BE%E4%B9%A6/dp/B01HQHPSS8">深度学习：21 天实战 Caffe</a></li>
<li><a href="https://www.amazon.cn/%E5%9B%BE%E4%B9%A6/dp/B01N3KU68R">深度学习：Caffe 之经典模型详解与实战</a></li>
</ul>
<h4 id="强化学习-1"><a href="#强化学习-1" class="headerlink" title="强化学习"></a>强化学习</h4><ul>
<li><a href="https://www.amazon.com/Reinforcement-Learning-Introduction-Adaptive-Computation/dp/0262193981">Reinforcement Learning: An Introduction</a></li>
<li><a href="https://www.amazon.com/Reinforcement-Learning-TensorFlow-Keras-Python/dp/1484232844">Reinforcement Learning: With Open AI, TensorFlow and Keras Using Python</a></li>
<li><a href="https://www.amazon.com/Algorithms-Reinforcement-Synthesis-Artificial-Intelligence/dp/1608454924">Algorithms for Reinforcement Learning</a></li>
<li><a href="https://www.amazon.com/Reinforcement-Learning-State-Art-Optimization/dp/364244685X">Reinforcement Learning State-of-the-Art</a></li>
</ul>
<h3 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h3><ul>
<li><a href="http://nbviewer.jupyter.org/github/numenta/nupic/blob/master/examples/NuPIC%20Walkthrough.ipynb">Code for “Beginner’s Guide to NuPIC”</a></li>
<li><a href="https://web.stanford.edu/class/cs221/">Car Tracking</a></li>
</ul>
<h3 id="Course"><a href="#Course" class="headerlink" title="Course"></a>Course</h3><ul>
<li><a href="https://www.datacamp.com/">Learn Data Science Online</a></li>
<li><a href="https://github.com/kailashahirwar/cheatsheets-ai">Cheat Sheets for AI</a></li>
<li><a href="https://www.rstudio.com/resources/cheatsheets/">RStudio Cheat Sheets</a></li>
<li><a href="http://www.fast.ai/">fast.ai</a></li>
</ul>
<h3 id="Data"><a href="#Data" class="headerlink" title="Data"></a>Data</h3><ul>
<li><a href="https://www.kaggle.com/">Your Home for Data Science</a></li>
<li><a href="https://www.data.gov/">The home of the U.S. Government´s open data</a></li>
<li>NASA + ImageNet + Google + 新闻 + 自动驾驶 + 图像 + 生物 数据集 <code>(加群后免费获取)</code></li>
</ul>
<h3 id="Resource"><a href="#Resource" class="headerlink" title="Resource"></a>Resource</h3><ul>
<li><a href="https://github.com/vinta/awesome-python#awesome-python-">A curated list of awesome Python frameworks, libraries, software and resources.</a></li>
</ul>
<h3 id="Markdown"><a href="#Markdown" class="headerlink" title="Markdown"></a>Markdown</h3><ul>
<li><a href="https://www.zybuluo.com/codeep/note/163962">Cmd Markdown 公式指导手册</a></li>
<li><a href="http://www.jianshu.com/p/7bcf4ad609cf">在 Markdown 中使用 HTML 中的特殊符号</a></li>
<li><a href="http://detexify.kirelabs.org/classify.html">Draw Markdown</a></li>
<li><a href="http://webdemo.myscript.com/views/math/index.html">手写生成 LaTex 代码</a></li>
<li><a href="https://support.typora.io/Draw-Diagrams-With-Markdown/">Draw Diagrams With Markdown</a></li>
</ul>
<h3 id="Paper"><a href="#Paper" class="headerlink" title="Paper"></a>Paper</h3><ul>
<li><a href="https://numenta.org/resources/HTM_CorticalLearningAlgorithms.pdf">HIERARCHICAL TEMPORAL MEMORY including HTM Cortical Learning Algorithms</a></li>
<li><a href="http://gogameguru.com/i/2016/03/deepmind-mastering-go.pdf"><strong>AlphaGo</strong>: Mastering the Game of Go with Deep Neural Networks and Tree Search</a></li>
<li><a href="https://www.nature.com/nature/journal/v550/n7676/full/nature24270.html"><strong>AlphaGo Zero</strong>: Mastering the game of Go without human knowledge</a> <code>(加群后免费获取)</code></li>
<li><a href="https://arxiv.org/pdf/1712.01815.pdf"><strong>AlphaZero</strong>: Mastering Chess and Shogi by Self-Play with a General Reinforcement Learning Algorithm</a></li>
<li><a href="https://github.com/junhyukoh/deep-reinforcement-learning-papers">Deep Reinforcement Learning Papers</a></li>
<li><a href="https://github.com/aikorea/awesome-rl">Awesome Reinforcement Learning</a></li>
</ul>
<h3 id="Video"><a href="#Video" class="headerlink" title="Video"></a>Video</h3><ul>
<li><a href="http://open.163.com/special/opencourse/daishu.html">麻省理工公开课：线性代数</a></li>
<li><a href="http://cs229.stanford.edu/"><strong>CS229</strong>: Machine Learning</a></li>
<li><a href="https://web.stanford.edu/class/cs224n/index.html"><strong>CS224n</strong>: Natural Language Processing with Deep Learning</a></li>
<li><a href="https://www.youtube.com/watch?v=i0o-ui1N35U"><strong>CS188</strong>: Artificial Intelligence</a></li>
<li><a href="https://www.youtube.com/watch?v=aUrX-rP_ss4"><strong>CS294</strong>: Deep Reinforcement Learning</a></li>
<li><a href="https://katefvision.github.io/"><strong>CMU10703</strong>: Deep Reinforcement Learning and Control</a></li>
<li><a href="http://selfdrivingcars.mit.edu/"><strong>6.S094</strong>: Deep Learning for Self-Driving Cars</a></li>
<li><a href="http://www0.cs.ucl.ac.uk/staff/d.silver/web/Teaching.html">UCL Course on RL</a></li>
<li><a href="https://www.coursera.org/learn/neural-networks-deep-learning">Andrew Ng: Neural Networks and Deep Learning</a></li>
<li><a href="https://www.youtube.com/watch?v=BCwOgbSSDM4">Beginner´s Guide to NuPIC</a></li>
<li><a href="https://www.youtube.com/playlist?list=PL3yXMgtrZmDqhsFQzwUC9V8MeeVOQ7eZ9">HTM School</a></li>
<li><a href="https://github.com/numenta/nupic/tree/master/examples/opf/clients/hotgym/anomaly/one_gym">One Hot Gym Anomaly Tutorial</a></li>
<li><a href="http://videolectures.net/deeplearning2016_pineau_reinforcement_learning/">Introduction to Reinforcement Learning</a></li>
</ul>
<h3 id="Tool"><a href="#Tool" class="headerlink" title="Tool"></a>Tool</h3><ul>
<li><a href="https://www.intmath.com/functions-and-graphs/graphs-using-svg.php">Online Graphing Calculator: Plot your own SVG Math Graphs</a></li>
</ul>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt=""></a></td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>人工智能</category>
      </categories>
      <tags>
        <tag>机器学习</tag>
        <tag>TensorFlow</tag>
        <tag>微积分</tag>
        <tag>人工智能</tag>
        <tag>MP Model</tag>
        <tag>Perceptron</tag>
        <tag>MLP</tag>
        <tag>DNN</tag>
        <tag>CNN</tag>
        <tag>RNN</tag>
        <tag>LSTM</tag>
        <tag>统计学</tag>
        <tag>线性代数</tag>
        <tag>概率论</tag>
        <tag>深度学习</tag>
        <tag>PyTorch</tag>
        <tag>Caffe</tag>
        <tag>xgboost</tag>
        <tag>Apache PredictionIO</tag>
        <tag>NuPIC</tag>
      </tags>
  </entry>
  <entry>
    <title>那些绕不过去的 Java 知识点</title>
    <url>/posts/190413/</url>
    <content><![CDATA[<h2 id="关于本文"><a href="#关于本文" class="headerlink" title="关于本文"></a>关于本文</h2><p>　虽然接触 Java 已经 8 年之久，可惜学习之初的笔记文档没能很好地保存下来。本文是近几年工作学习中遇到的一些零散的知识点，包括了 基础概念、实用的编程技巧、代码可读性、设计模式、性能优化（工具 &amp; 编码）、测试相关、JVM 相关、常用的工具和常见问题。本着好记性不如烂笔头的初衷，在不断地踩坑和爬坑的过程中，慢慢地记录成文。期待着本文能起到抛砖引玉的作用，以看到大家的真知灼见。</p>
<h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><h3 id="注解"><a href="#注解" class="headerlink" title="注解"></a>注解</h3><h4 id="GuardedBy"><a href="#GuardedBy" class="headerlink" title="GuardedBy"></a>GuardedBy</h4><p>　<code>@GuardedBy</code> 注解可以作用于某一个属性或者方法，约定在访问这些被注解标记的资源时，能被同步代码块保护着。简单的使用案例如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@GuardedBy("obj")</span></span><br><span class="line"><span class="keyword">private</span> ConcurrentMap&lt;String, String&gt; map = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Object obj = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(String k, String v)</span> </span>{</span><br><span class="line">    <span class="keyword">synchronized</span> (obj) {</span><br><span class="line">        map.put(k, v);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * If you use `error prone` tool to check this, this annotation should be `<span class="doctag">@SuppressWarnings</span>("GuardedBy")`</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@see</span> https://errorprone.info/bugpattern/GuardedBy}</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@see</span> https://github.com/apache/druid/pull/6868#discussion_r249639199}</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressWarnings("FieldAccessNotGuarded")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(String k)</span> </span>{</span><br><span class="line">    map.remove(k);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">synchronized</span> (obj) {</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"GuardedByExample{"</span> +</span><br><span class="line">                <span class="string">"map="</span> + map +</span><br><span class="line">                <span class="string">'}'</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>Tips: <a href="https://github.com/apache/druid/pull/6903">Code Example</a> from <a href="https://yuzhouwan.com/posts/5845/">Apache Druid</a>；另外，<strong>error-prone</strong> 工具支持对<a href="https://github.com/google/error-prone/blob/master/docs/bugpattern/GuardedBy.md#guardedby">多种版本</a>的 <code>@GuardedBy</code> 进行检查</p>
<a id="more"></a>
<h4 id="InterfaceStability"><a href="#InterfaceStability" class="headerlink" title="InterfaceStability"></a>InterfaceStability</h4><ul>
<li><p>@InterfaceStability.Stable<br>主版本是稳定的，不同主版本间，可能不兼容</p>
</li>
<li><p>@InterfaceStability.Evolving<br>不断变化中，不同的次版本间，可能不兼容</p>
</li>
<li><p>@InterfaceStability.Unstable<br>不对可靠性和健壮性做任何保证</p>
</li>
</ul>
<h4 id="InterfaceAudience"><a href="#InterfaceAudience" class="headerlink" title="InterfaceAudience"></a>InterfaceAudience</h4><ul>
<li><p>@InterfaceAudience.Public<br>对所有工程可用</p>
</li>
<li><p>@InterfaceAudience.LimitedPrivate<br>仅限特定的工程，如 <a href="https://yuzhouwan.com/posts/45888/">HBase</a>、<a href="https://yuzhouwan.com/posts/31915/">ZooKeeper</a>、<a href="https://yuzhouwan.com/posts/60504/">HDFS</a> 等（以 Hadoop 为例）</p>
</li>
<li><p>@InterfaceAudience.Private<br>仅限于工程内部使用</p>
</li>
</ul>
<h4 id="JsonIgnoreProperties"><a href="#JsonIgnoreProperties" class="headerlink" title="JsonIgnoreProperties"></a>JsonIgnoreProperties</h4><p>　通过增加 Class 级别的 <code>@JsonIgnoreProperties(ignoreUnknown = true)</code> 注解，可以避免在解析不支持的字段时抛出 UnrecognizedPropertyException 异常</p>
<h3 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h3><h4 id="transient"><a href="#transient" class="headerlink" title="transient"></a>transient</h4><p>　给实现了 <code>Serializable</code> 接口的类中的字段，增加 <code>transient</code> 修饰符，则可以让该字段跳过序列化的过程</p>
<p>Tips: Full code is <a href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-hacker/src/test/java/com/yuzhouwan/hacker/javaProhibited/serializable/bean/Country.java">here</a> and <a href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-hacker/src/test/java/com/yuzhouwan/hacker/javaProhibited/serializable/SerializableTest.java#L45">here</a>.</p>
<h4 id="类中包含没有实现-Serializable-接口的字段"><a href="#类中包含没有实现-Serializable-接口的字段" class="headerlink" title="类中包含没有实现 Serializable 接口的字段"></a>类中包含没有实现 Serializable 接口的字段</h4><p>　需要自己实现 <code>serialize</code> 和 <code>deserialize</code> 方法</p>
<p>Tips: Full code is <a href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-hacker/src/test/java/com/yuzhouwan/hacker/javaProhibited/serializable/converter/SerializationConverter.java">here</a> and <a href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-hacker/src/test/java/com/yuzhouwan/hacker/javaProhibited/serializable/SerializableTest.java#L27">here</a>.</p>
<h2 id="实用技巧"><a href="#实用技巧" class="headerlink" title="实用技巧"></a>实用技巧</h2><h3 id="Collection-内元素类型转换"><a href="#Collection-内元素类型转换" class="headerlink" title="Collection 内元素类型转换"></a>Collection 内元素类型转换</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 对集合里面的元素类型进行转换（A -&gt; B）</span></span><br><span class="line">List&lt;B&gt; variable = (List&lt;B&gt;)(List&lt;?&gt;) collectionOfListA;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="集合的差集、交集、并集"><a href="#集合的差集、交集、并集" class="headerlink" title="集合的差集、交集、并集"></a>集合的差集、交集、并集</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 使用 Guava 中封装的 Sets 类</span></span><br><span class="line"><span class="keyword">import</span> com.google.common.collect.Sets;</span><br><span class="line"></span><br><span class="line">Sets.difference(set1, set2)</span><br><span class="line">Sets.intersection(set1, set2)</span><br><span class="line">Sets.union(set1, set2)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="数组转为-Set"><a href="#数组转为-Set" class="headerlink" title="数组转为 Set"></a>数组转为 Set</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// JDK8</span></span><br><span class="line"><span class="keyword">new</span> HashSet&lt;&gt;(Arrays.asList(str.trim().split(<span class="string">","</span>)))</span><br><span class="line"><span class="comment">// JDK9+</span></span><br><span class="line">Set.of(str.trim().split(<span class="string">","</span>));</span><br></pre></td></tr></tbody></table></figure>
<h3 id="TransmittableThreadLocal-解决跨父子线程和线程池缓存问题"><a href="#TransmittableThreadLocal-解决跨父子线程和线程池缓存问题" class="headerlink" title="TransmittableThreadLocal 解决跨父子线程和线程池缓存问题"></a>TransmittableThreadLocal 解决跨父子线程和线程池缓存问题</h3><h4 id="编码"><a href="#编码" class="headerlink" title="编码"></a>编码</h4><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">String tlMsg = <span class="string">"tl"</span>;</span><br><span class="line">String ttlMsg = <span class="string">"ttl"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> ThreadLocal&lt;String&gt; tl = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</span><br><span class="line">tl.set(tlMsg);</span><br><span class="line"><span class="keyword">final</span> TransmittableThreadLocal&lt;String&gt; ttl = <span class="keyword">new</span> TransmittableThreadLocal&lt;&gt;();</span><br><span class="line">ttl.set(ttlMsg);</span><br><span class="line"></span><br><span class="line">assertEquals(tl.get(), tlMsg);</span><br><span class="line">assertEquals(ttl.get(), ttlMsg);</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Thread(() -&gt; {</span><br><span class="line">    assertNull(tl.get());</span><br><span class="line">    assertEquals(ttl.get(), ttlMsg);</span><br><span class="line">}).start();</span><br></pre></td></tr></tbody></table></figure>
<p>Tips: Full code is <a href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-hacker/src/test/java/com/yuzhouwan/hacker/algorithms/thread/ttl/TransmittableThreadLocalTest.java">here</a>.</p>
<h3 id="计算中位数"><a href="#计算中位数" class="headerlink" title="计算中位数"></a>计算中位数</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> COUNT;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> PriorityQueue&lt;Double&gt; MAX = <span class="keyword">new</span> PriorityQueue&lt;&gt;(Collections.reverseOrder());</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> PriorityQueue&lt;Double&gt; MIN = <span class="keyword">new</span> PriorityQueue&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">    add(<span class="number">1D</span>);</span><br><span class="line">    add(<span class="number">2D</span>);</span><br><span class="line">    add(<span class="number">3D</span>);</span><br><span class="line">    add(<span class="number">4D</span>);</span><br><span class="line">    add(<span class="number">4D</span>);</span><br><span class="line">    <span class="comment">// 3.0</span></span><br><span class="line">    System.out.println(median());</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">double</span> v)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (!Double.isNaN(v)) {</span><br><span class="line">        <span class="keyword">if</span> (COUNT % <span class="number">2</span> == <span class="number">0</span>) {</span><br><span class="line">            MIN.add(v);</span><br><span class="line">            MAX.add(MIN.peek());</span><br><span class="line">            MIN.poll();</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            MAX.add(v);</span><br><span class="line">            MIN.add(MAX.peek());</span><br><span class="line">            MAX.poll();</span><br><span class="line">        }</span><br><span class="line">        COUNT++;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings("ConstantConditions")</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">double</span> <span class="title">median</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (COUNT == <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">return</span> Double.NaN;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (COUNT % <span class="number">2</span> == <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">return</span> (MAX.peek() + MIN.peek()) / <span class="number">2.0</span>;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">return</span> MAX.peek();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Shutdown-Hook"><a href="#Shutdown-Hook" class="headerlink" title="Shutdown Hook"></a>Shutdown Hook</h3><h4 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h4><p>　进程异常退出时，可能 <code>try-finally</code> 也无法保证可以及时释放类似数据库连接资源或清理临时文件，使用 Shutdown Hook 则可以避免该问题。不过也有可能存在无法触发 Shutdown Hook 的情况，例如执行 <code>kill -9</code> 退出进程等，但绝大部分的情况下，都能成功触发，具体如下：</p>
<ul>
<li>程序正常退出</li>
<li>使用 <code>System.exit()</code></li>
<li><code>OutOfMemory</code> 宕机</li>
<li>终端 <code>Ctrl+C</code> 触发的中断</li>
<li>使用 <code>kill pid</code> 命令退出进程</li>
</ul>
<h4 id="编码-1"><a href="#编码-1" class="headerlink" title="编码"></a>编码</h4><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">System.out.println(<span class="string">"registering"</span>);</span><br><span class="line">Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> Thread(() -&gt; System.out.println(<span class="string">"shutdown1..."</span>)));</span><br><span class="line">Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> Thread(() -&gt; System.out.println(<span class="string">"shutdown2..."</span>)));</span><br><span class="line">Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> Thread(() -&gt; System.out.println(<span class="string">"shutdown3..."</span>)));</span><br><span class="line">System.out.println(<span class="string">"registered"</span>);</span><br><span class="line">System.out.println(<span class="string">"exit"</span>);</span><br><span class="line">System.exit(<span class="number">0</span>);</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">registering</span><br><span class="line">registered</span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">shutdown2...</span><br><span class="line">shutdown3...</span><br><span class="line">shutdown1...</span><br></pre></td></tr></tbody></table></figure>
<div class="note info">这里需要注意的是，注册的多个 Shutdown Hook 由各自不同的线程执行完成，是无法保证执行的先后顺序的</div>

<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a><a href="https://stefanbirkner.github.io/system-rules/">测试</a></h4><figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.stefanbirkner<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>system-rules<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.Rule;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.contrib.java.lang.system.ExpectedSystemExit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShutdownHookTest</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Rule</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> ExpectedSystemExit exit = ExpectedSystemExit.none();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test_shutdown_hook</span><span class="params">()</span> </span>{</span><br><span class="line">        Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> Thread(() -&gt; System.out.println(<span class="string">"shutdown..."</span>)));</span><br><span class="line"></span><br><span class="line">        exit.expectSystemExit();</span><br><span class="line">        System.exit(<span class="number">0</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<div class="note success">使用 ExpectedSystemExit 可以避免执行 System.exit 后所有测试用例都被终止的问题</div>



<h3 id="SPI-解耦"><a href="#SPI-解耦" class="headerlink" title="SPI 解耦"></a>SPI 解耦</h3><h4 id="定义"><a href="#定义" class="headerlink" title="定义"></a><a href="https://docs.oracle.com/en/java/javase/13/docs/api/java.base/java/util/ServiceLoader.html">定义</a></h4><blockquote>
<p>A service is a well-known interface or class for which zero, one, or many service providers exist. A service provider (or just provider) is a class that implements or subclasses the well-known interface or class. A ServiceLoader is an object that locates and loads service providers deployed in the run time environment at a time of an application´s choosing. Application code refers only to the service, not to service providers, and is assumed to be capable of choosing between multiple service providers (based on the functionality they expose through the service), and handling the possibility that no service providers are located.</p>
</blockquote>
<h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a><a href="https://github.com/asdf2014/yuzhouwan/tree/master/yuzhouwan-hacker/src/main/java/com/yuzhouwan/hacker/spi">示例</a></h4><ul>
<li>定义 SPI 接口</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IStore</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">record</span><span class="params">(String data)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>实现 SPI 接口</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ESStore</span> <span class="keyword">implements</span> <span class="title">IStore</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">record</span><span class="params">(String data)</span> </span>{</span><br><span class="line">        System.err.println(<span class="string">"Recording "</span> + data + <span class="string">" to ES ..."</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HBaseStore</span> <span class="keyword">implements</span> <span class="title">IStore</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">record</span><span class="params">(String data)</span> </span>{</span><br><span class="line">        System.err.println(<span class="string">"Recording "</span> + data + <span class="string">" to HBase ..."</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>配置子类的全限定名</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim src/main/resources/META-INF/services/com.yuzhouwan.hacker.spi.IStore</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">com.yuzhouwan.hacker.spi.ESStore</span><br><span class="line">com.yuzhouwan.hacker.spi.HBaseStore</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>通过 ServiceLoader.load 加载 SPI 接口的实现</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (IStore store : ServiceLoader.load(IStore.class)) {</span><br><span class="line">    System.err.println(<span class="string">"Loaded "</span> + store.getClass().getSimpleName());</span><br><span class="line">    store.record(<span class="string">"yuzhouwan.com"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">Loaded ESStore</span><br><span class="line">Recording yuzhouwan.com to ES ...</span><br><span class="line">Loaded HBaseStore</span><br><span class="line">Recording yuzhouwan.com to HBase ...</span><br></pre></td></tr></tbody></table></figure>
<h4 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h4><ul>
<li>解耦</li>
<li>插件化</li>
<li>通过 <code>stream()</code> 遍历可以实现懒加载，避免一次性加载所有的实现（JDK9+）</li>
</ul>
<h3 id="避免使用-Properties-的-put-和-putAll-方法"><a href="#避免使用-Properties-的-put-和-putAll-方法" class="headerlink" title="避免使用 Properties 的 put 和 putAll 方法"></a>避免使用 Properties 的 put 和 putAll 方法</h3><p>　因为 <code>Properties</code> 继承于 <code>Hashtable</code>，所以可以调用父类 <code>Hashtable</code> 的 <code>put</code> 和 <code>putAll</code> 方法。但是并不建议这样用，而是希望使用 <code>setProperty</code> 方法。因为 <code>setProperty</code> 方法限制了 Key 和 Value 的数据类型为 <code>String</code>，而 <code>put</code> 和 <code>putAll</code> 方法却不会。虽然，<code>put</code> 写入和 <code>get</code> 读取非 <code>String</code> 的数据是没问题的，但是在 <code>store</code> 和 <code>save</code> 调用的时候却会出错，抛出 <code>ClassCastException</code> 异常。例如：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">Properties p = <span class="keyword">new</span> Properties();</span><br><span class="line">p.put(<span class="number">1</span>, <span class="string">"yuzhouwan"</span>);</span><br><span class="line">p.store(System.out, <span class="string">""</span>);</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">Exception in thread <span class="string">"main"</span> java.lang.ClassCastException: java.lang.Integer cannot be cast to java.lang.String</span><br><span class="line">  at java.util.Properties.store0(Properties.java:<span class="number">833</span>)</span><br><span class="line">  at java.util.Properties.store(Properties.java:<span class="number">818</span>)</span><br></pre></td></tr></tbody></table></figure>
<h2 id="可读性"><a href="#可读性" class="headerlink" title="可读性"></a>可读性</h2><h3 id="魔法数字"><a href="#魔法数字" class="headerlink" title="魔法数字"></a>魔法数字</h3><p>　编码过程中，应该避免出现没有声明含义的纯数字</p>
<h4 id="反面示例"><a href="#反面示例" class="headerlink" title="反面示例"></a>反面示例</h4><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// org.apache.kafka.connect.runtime.distributed.DistributedHerder#stop</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>{</span><br><span class="line">  <span class="keyword">if</span> (!forwardRequestExecutor.awaitTermination(<span class="number">10000L</span>, TimeUnit.MILLISECONDS))</span><br><span class="line">    forwardRequestExecutor.shutdownNow();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="正面示例"><a href="#正面示例" class="headerlink" title="正面示例"></a>正面示例</h4><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 这里除了需要将 10000L 抽象成 FORWARD_REQUEST_SHUTDOWN_TIMEOUT_MS 静态变量</span></span><br><span class="line"><span class="comment">// 还可以进一步使用 10_000L 方便阅读</span></span><br><span class="line"><span class="comment">// 因为这里和时间有关，更进一步，可以使用 TimeUnit.SECONDS.toMillis(10) 来代替纯数字</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> FORWARD_REQUEST_SHUTDOWN_TIMEOUT_MS = TimeUnit.SECONDS.toMillis(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>{</span><br><span class="line">  <span class="keyword">if</span> (!forwardRequestExecutor.awaitTermination(FORWARD_REQUEST_SHUTDOWN_TIMEOUT_MS, TimeUnit.MILLISECONDS))</span><br><span class="line">    forwardRequestExecutor.shutdownNow();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>Tips: Full code is <a href="https://github.com/apache/kafka/pull/4799/files">here</a> and <a href="https://github.com/apache/druid/pull/6158/files">here</a>.</p>
<h3 id="字符串判空"><a href="#字符串判空" class="headerlink" title="字符串判空"></a>字符串判空</h3><h4 id="反面示例-1"><a href="#反面示例-1" class="headerlink" title="反面示例"></a>反面示例</h4><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// org.apache.kafka.connect.runtime.distributed.DistributedHerder#reconfigureConnector</span></span><br><span class="line">leaderUrl.equals(<span class="string">""</span>)</span><br></pre></td></tr></tbody></table></figure>
<h4 id="正面示例-1"><a href="#正面示例-1" class="headerlink" title="正面示例"></a>正面示例</h4><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 一方面，需要考虑不能将对象放在 equals 方法之前，避免空指针异常</span></span><br><span class="line"><span class="comment">// 另一方面，使用 `str.length() == 0` 的方式，效率会高一些</span></span><br><span class="line"><span class="comment">// 进一步，使用 isEmpty() 方法，则可以使得代码更加可读</span></span><br><span class="line">leaderUrl == <span class="keyword">null</span> || leaderUrl.trim().isEmpty()</span><br></pre></td></tr></tbody></table></figure>
<p>Tips: Full code is <a href="https://github.com/apache/kafka/pull/4798/files">here</a>.</p>
<h3 id="箭头型代码"><a href="#箭头型代码" class="headerlink" title="箭头型代码"></a>箭头型代码</h3><h4 id="反面示例-2"><a href="#反面示例-2" class="headerlink" title="反面示例"></a>反面示例</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">public void m(String s) {</span><br><span class="line">    <span class="keyword">if</span> (s != null) {</span><br><span class="line">        <span class="keyword">if</span> (s.trim().length() &gt; 0) {</span><br><span class="line">            <span class="keyword">if</span> (s.contains(<span class="string">"yuzhouwan"</span>)) {</span><br><span class="line">                System.out.println(<span class="string">"https://yuzhouwan.com"</span>);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="正面示例-2"><a href="#正面示例-2" class="headerlink" title="正面示例"></a>正面示例</h4><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">m</span><span class="params">(String s)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (s == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (s.trim().length() == <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (!s.contains(<span class="string">"yuzhouwan"</span>)) {</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    System.out.println(<span class="string">"https://yuzhouwan.com"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="函数式编程"><a href="#函数式编程" class="headerlink" title="函数式编程"></a>函数式编程</h3><h4 id="Optional"><a href="#Optional" class="headerlink" title="Optional"></a>Optional</h4><h5 id="反面示例-3"><a href="#反面示例-3" class="headerlink" title="反面示例"></a>反面示例</h5><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Long <span class="title">deserialize</span><span class="params">(ByteArrayDataInput in)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> isNullByteSet(in) ? <span class="keyword">null</span> : in.readLong();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h5 id="正面示例-3"><a href="#正面示例-3" class="headerlink" title="正面示例"></a>正面示例</h5><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> Optional.ofNullable(in)</span><br><span class="line">               .filter(InputRowSerde::isNotNullByteSet)</span><br><span class="line">               .map(ByteArrayDataInput::readLong)</span><br><span class="line">               .get();</span><br></pre></td></tr></tbody></table></figure>
<h4 id="anyMatch"><a href="#anyMatch" class="headerlink" title="anyMatch"></a>anyMatch</h4><h5 id="反面示例-4"><a href="#反面示例-4" class="headerlink" title="反面示例"></a>反面示例</h5><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isTaskPending</span><span class="params">(Task task)</span> </span>{</span><br><span class="line">    <span class="keyword">for</span> (TaskRunnerWorkItem workItem : taskRunner.getPendingTasks()) {</span><br><span class="line">        <span class="keyword">if</span> (workItem.getTaskId().equals(task.getId())) {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h5 id="正面示例-4"><a href="#正面示例-4" class="headerlink" title="正面示例"></a>正面示例</h5><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> String taskId = task.getId();</span><br><span class="line"><span class="keyword">return</span> taskRunner.getPendingTasks()</span><br><span class="line">                 .stream()</span><br><span class="line">                 .anyMatch(t -&gt; taskId.equals(t.getTaskId()));</span><br></pre></td></tr></tbody></table></figure>
<h4 id="list-去重统计"><a href="#list-去重统计" class="headerlink" title="list 去重统计"></a>list 去重统计</h4><h5 id="反面示例-5"><a href="#反面示例-5" class="headerlink" title="反面示例"></a>反面示例</h5><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">5</span>);</span><br><span class="line">list.add(<span class="string">"a"</span>);</span><br><span class="line">list.add(<span class="string">"a"</span>);</span><br><span class="line">list.add(<span class="string">"a"</span>);</span><br><span class="line">list.add(<span class="string">"b"</span>);</span><br><span class="line">list.add(<span class="string">"c"</span>);</span><br><span class="line"><span class="keyword">final</span> Map&lt;String, Integer&gt; res = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span> (String s : list) {</span><br><span class="line">    <span class="keyword">if</span> (res.containsKey(s)) {</span><br><span class="line">        res.put(s, res.get(s) + <span class="number">1</span>);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        res.put(s, <span class="number">1</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="comment">// {"a":3,"b":1,"c":1}</span></span><br><span class="line">System.out.println(JSON.toJSONString(res));</span><br></pre></td></tr></tbody></table></figure>
<h5 id="正面示例-5"><a href="#正面示例-5" class="headerlink" title="正面示例"></a>正面示例</h5><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">5</span>);</span><br><span class="line">list.add(<span class="string">"a"</span>);</span><br><span class="line">list.add(<span class="string">"a"</span>);</span><br><span class="line">list.add(<span class="string">"a"</span>);</span><br><span class="line">list.add(<span class="string">"b"</span>);</span><br><span class="line">list.add(<span class="string">"c"</span>);</span><br><span class="line"><span class="keyword">final</span> Map&lt;String, Integer&gt; res = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">list.forEach(s -&gt; res.compute(s, (k, v) -&gt; (v == <span class="keyword">null</span>) ? <span class="number">1</span> : ++v));</span><br><span class="line"><span class="comment">// {"a":3,"b":1,"c":1}</span></span><br><span class="line">System.out.println(JSON.toJSONString(res));</span><br></pre></td></tr></tbody></table></figure>
<h4 id="嵌套-list-遍历求和"><a href="#嵌套-list-遍历求和" class="headerlink" title="嵌套 list 遍历求和"></a>嵌套 list 遍历求和</h4><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">List&lt;List&lt;Integer&gt;&gt; l = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">List&lt;Integer&gt; l0 = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">l0.add(<span class="number">1</span>);</span><br><span class="line">l0.add(<span class="number">2</span>);</span><br><span class="line">l.add(l0);</span><br><span class="line">l.add(Collections.singletonList(<span class="number">3</span>));</span><br><span class="line"><span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (List&lt;Integer&gt; ints : l) {</span><br><span class="line">    <span class="keyword">for</span> (Integer i : ints) {</span><br><span class="line">        sum += i;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">Assert.assertEquals(<span class="number">6</span>, sum);</span><br></pre></td></tr></tbody></table></figure>
<h5 id="正面示例-6"><a href="#正面示例-6" class="headerlink" title="正面示例"></a>正面示例</h5><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">List&lt;List&lt;Integer&gt;&gt; l = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">List&lt;Integer&gt; l0 = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">l0.add(<span class="number">1</span>);</span><br><span class="line">l0.add(<span class="number">2</span>);</span><br><span class="line">l.add(l0);</span><br><span class="line">l.add(Collections.singletonList(<span class="number">3</span>));</span><br><span class="line"><span class="keyword">int</span> sum = l.stream()</span><br><span class="line">        .flatMap(Collection::stream)</span><br><span class="line">        .mapToInt(Integer::intValue)</span><br><span class="line">        .sum();</span><br><span class="line">Assert.assertEquals(<span class="number">6</span>, sum);</span><br></pre></td></tr></tbody></table></figure>
<h2 id="设计模式"><a href="#设计模式" class="headerlink" title="设计模式"></a>设计模式</h2><h3 id="单一功能原则"><a href="#单一功能原则" class="headerlink" title="单一功能原则"></a><a href="https://zh.wikipedia.org/wiki/%E5%8D%95%E4%B8%80%E5%8A%9F%E8%83%BD%E5%8E%9F%E5%88%99">单一功能原则</a></h3><p>　在面向对象编程领域中，<strong>单一功能原则</strong>（<strong>S</strong>ingle <strong>r</strong>esponsibility <strong>p</strong>rinciple，<strong>SRP</strong>）规定每个类都应该有一个单一的功能，并且该功能应该由这个类完全封装起来。所有它的（这个类的）服务都应该严密的和该功能平行（功能平行，意味着没有依赖）</p>
<h3 id="开闭原则"><a href="#开闭原则" class="headerlink" title="开闭原则"></a><a href="https://zh.wikipedia.org/wiki/%E5%BC%80%E9%97%AD%E5%8E%9F%E5%88%99">开闭原则</a></h3><p>　在面向对象编程领域中，<strong>开闭原则</strong>（<strong>O</strong>pen-<strong>c</strong>losed <strong>p</strong>rinciple，<strong>OCP</strong>）规定“软件中的对象（类，模块，函数等等）应该对于扩展是开放的，但是对于修改是封闭的”，这意味着一个实体是允许在不改变它的源代码的前提下变更它的行为</p>
<h3 id="里氏替换原则"><a href="#里氏替换原则" class="headerlink" title="里氏替换原则"></a><a href="https://zh.wikipedia.org/wiki/%E9%87%8C%E6%B0%8F%E6%9B%BF%E6%8D%A2%E5%8E%9F%E5%88%99">里氏替换原则</a></h3><p>　<strong>里氏替换原则</strong>（<strong>L</strong>iskov <strong>s</strong>ubstitution <strong>p</strong>rinciple，<strong>LSP</strong>）强调的是 面向对象程序设计中的 <strong>可替代性</strong>，说明在计算机程序中，如果 S 是 T 的子类型，那么类型 T 的对象可以用类型 S 的对象替换（即 T 类型的对象可以被任何子类型 S 的对象替换），而不改变程序的任何期望属性（正确地执行的任务等）</p>
<h3 id="接口隔离原则"><a href="#接口隔离原则" class="headerlink" title="接口隔离原则"></a><a href="https://zh.wikipedia.org/wiki/%E6%8E%A5%E5%8F%A3%E9%9A%94%E7%A6%BB%E5%8E%9F%E5%88%99">接口隔离原则</a></h3><p>　<strong>接口隔离原则</strong>（<strong>I</strong>nterface-<strong>s</strong>egregation <strong>p</strong>rinciples，<strong>ISP</strong>）指明客户（client）应该不依赖于它不使用的方法。接口隔离原则拆分非常庞大臃肿的接口，成为更小的和更具体的接口，这样客户将只需要知道他们感兴趣的方法。这种缩小的接口也被称为角色接口（Role interfaces）。接口隔离原则的目的是系统解开耦合，从而容易重构，更改和重新部署</p>
<h3 id="依赖反转原则"><a href="#依赖反转原则" class="headerlink" title="依赖反转原则"></a><a href="https://zh.wikipedia.org/wiki/%E4%BE%9D%E8%B5%96%E5%8F%8D%E8%BD%AC%E5%8E%9F%E5%88%99">依赖反转原则</a></h3><p>　在面向对象编程领域中，<strong>依赖反转原则</strong>（<strong>D</strong>ependency <strong>i</strong>nversion <strong>p</strong>rinciple，<strong>DIP</strong>）是指一种特定的解耦（传统的依赖关系创建在高层次上，而具体的策略设置则应用在低层次的模块上）形式，使得高层次的模块不依赖于低层次的模块的实现细节，依赖关系被颠倒（反转），从而使得低层次模块依赖于高层次模块的需求抽象。 该原则规定：</p>
<ul>
<li>高层次的模块不应该依赖于低层次的模块，两者都应该依赖于抽象接口</li>
<li>抽象接口不应该依赖于具体实现。而具体实现则应该依赖于抽象接口</li>
</ul>
<div class="note success">五大原则的速记：SOLID</div>





<h2 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h2><h3 id="工具层面"><a href="#工具层面" class="headerlink" title="工具层面"></a>工具层面</h3><h4 id="性能指标监控"><a href="#性能指标监控" class="headerlink" title="性能指标监控"></a>性能指标监控</h4><figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">metrics.version</span>&gt;</span>3.2.0<span class="tag">&lt;/<span class="name">metrics.version</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.dropwizard.metrics<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>metrics-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>${metrics.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="JMH-基准测试"><a href="#JMH-基准测试" class="headerlink" title="JMH 基准测试"></a>JMH 基准测试</h4><h5 id="增加-Maven-依赖"><a href="#增加-Maven-依赖" class="headerlink" title="增加 Maven 依赖"></a>增加 <a href="https://yuzhouwan.com/posts/2254/">Maven</a> 依赖</h5><figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">jmh.version</span>&gt;</span>1.19<span class="tag">&lt;/<span class="name">jmh.version</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- JMH --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.openjdk.jmh<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jmh-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>${jmh.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.openjdk.jmh<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jmh-generator-annprocess<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>${jmh.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="编写-JMH-测试案例"><a href="#编写-JMH-测试案例" class="headerlink" title="编写 JMH 测试案例"></a>编写 JMH 测试案例</h5><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.openjdk.jmh.annotations.*;</span><br><span class="line"><span class="keyword">import</span> org.openjdk.jmh.runner.Runner;</span><br><span class="line"><span class="keyword">import</span> org.openjdk.jmh.runner.RunnerException;</span><br><span class="line"><span class="keyword">import</span> org.openjdk.jmh.runner.options.Options;</span><br><span class="line"><span class="keyword">import</span> org.openjdk.jmh.runner.options.OptionsBuilder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="meta">@BenchmarkMode(Mode.Throughput)</span></span><br><span class="line"><span class="meta">@OutputTimeUnit(TimeUnit.MILLISECONDS)</span></span><br><span class="line"><span class="meta">@State(Scope.Thread)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BenchmarkSimple</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Benchmark</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bench</span><span class="params">()</span> </span>{</span><br><span class="line">        add(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> a + b;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Benchmark               Mode    Cnt     Score        Error     Units</span></span><br><span class="line"><span class="comment">    BenchmarkSimple.bench   thrpt    5  13352311.603 ± 767137.272  ops/ms</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> RunnerException </span>{</span><br><span class="line">        Options opt = <span class="keyword">new</span> OptionsBuilder()</span><br><span class="line">                .include(BenchmarkSimple.class.getSimpleName())</span><br><span class="line">                .forks(<span class="number">1</span>)</span><br><span class="line">                .warmupIterations(<span class="number">5</span>)</span><br><span class="line">                .measurementIterations(<span class="number">5</span>)</span><br><span class="line">                .threads(<span class="number">10</span>)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="keyword">new</span> Runner(opt).run();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>Tips: Full code is <a href="https://github.com/asdf2014/yuzhouwan/tree/master/yuzhouwan-bigdata/yuzhouwan-bigdata-zookeeper/src/test/java/com/yuzhouwan/bigdata/zookeeper/benchmark">here</a>.</p>
<h5 id="优势"><a href="#优势" class="headerlink" title="优势"></a>优势</h5><ul>
<li>不和会 JUnit 冲突，不用担心 Jenkins 会自动跑 Benchmark 测试而影响效率（否则需要添加 <code>@Ignore</code> 让 CI 系统忽略掉性能相关的 JUnit 测试用例）</li>
<li>支持 <code>warm up</code>，可以解决 JIT 预热问题</li>
</ul>
<h4 id="BTrace"><a href="#BTrace" class="headerlink" title="BTrace"></a><a href="https://github.com/btraceio/btrace">BTrace</a></h4><p>　BTrace is a safe, dynamic tracing tool for the Java platform. BTrace can be used to dynamically trace a running Java program (similar to DTrace for OpenSolaris applications and OS). BTrace dynamically instruments the classes of the target application to inject tracing code (“bytecode tracing”).</p>
<h4 id="LooseJar"><a href="#LooseJar" class="headerlink" title="LooseJar"></a>LooseJar</h4><h5 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h5><p>　分析没有被加载任何 class 的 jar 包，帮助删除工程中不必要的 jar 包。不过，需要注意的是，有些类是动态加载的（比如数据类型转换类的，只有加载数据时才会用到），需要尽可能地多测试，才能保证 LooseJar 分析准确</p>
<h5 id="使用步骤"><a href="#使用步骤" class="headerlink" title="使用步骤"></a>使用步骤</h5><ul>
<li><p>下载<br>在 LooseJar 的 <a href="https://github.com/kyrill007/loosejar/releases">release 页面</a>，下载 <a href="https://github.com/kyrill007/loosejar/releases/download/1.1.0/loosejar-1.1.0.jar">loosejar-1.1.0.jar</a></p>
</li>
<li><p>拷贝<br>将 loosejar.jar 放到应用的 WEB-INF 下的 lib 目录中，比如说路径是 <code>/yuzhouwan/yuzhouwan-site/yuzhouwan-site-web/src/main/webapp/WEB-INF/lib/loosejar.jar</code></p>
</li>
<li><p>配置<br>在 IDE 中的 installed JRES 里面的 JDK 处配置 <code>-Dfile.encoding=uft8 -javaagent:/yuzhouwan/yuzhouwan-site/yuzhouwan-site-web/src/main/webapp/WEB-INF/lib/loosejar.jar</code></p>
</li>
<li><p>启动<br>启动应用，尽可能做到路径全覆盖地测试应用，让每段代码都被执行到</p>
</li>
<li><p>查看结果<br>运行 JDK 自带的 Jconsole 工具，选择 BootStrap 的那个端口，然后选择 MBean 下的 <code>com.googlecode.loosejar</code>，并点击 summary，即可看到分析结果</p>
</li>
</ul>
<h3 id="编码层面"><a href="#编码层面" class="headerlink" title="编码层面"></a>编码层面</h3><h4 id="并发相关"><a href="#并发相关" class="headerlink" title="并发相关"></a>并发相关</h4><h5 id="synchronized"><a href="#synchronized" class="headerlink" title="synchronized"></a>synchronized</h5><p>　详见，《如何运用 JVM 知识提高编程水平 - <a href="https://yuzhouwan.com/posts/27328/#synchronized-的性能之争">synchronized 的性能之争</a>》</p>
<h5 id="StampedLock"><a href="#StampedLock" class="headerlink" title="StampedLock"></a>StampedLock</h5><p>　StampedLock 是 JDK8 新引入的一个针对读写锁进行改进的类。其主要思想是，如果在读的同时又发生了写，则应当重读，而不是在读的时候阻塞写。如此可以做到，不仅读操作之间不会相互阻塞，还可以保证读操作不会阻塞写操作</p>
<h4 id="集合优化"><a href="#集合优化" class="headerlink" title="集合优化"></a>集合优化</h4><h5 id="HashMap"><a href="#HashMap" class="headerlink" title="HashMap"></a>HashMap</h5><h6 id="为什么-Java-8-版本中引入红黑树"><a href="#为什么-Java-8-版本中引入红黑树" class="headerlink" title="为什么 Java 8 版本中引入红黑树"></a>为什么 Java 8 版本中引入红黑树</h6><ul>
<li><p>原因</p>
<p>JDK8 以前 HashMap 的实现是 <strong>数组+链表</strong>，即使哈希函数取得再好，也很难达到元素百分百均匀分布</p>
<p>当 HashMap 中有大量的元素都存放到同一个桶中时，这个桶下有一条长长的链表，这个时候 HashMap 就相当于一个单链表，假如单链表有 n 个元素，遍历的时间复杂度就是 $O(n)$，完全失去了它的优势</p>
<p>针对这种情况，JDK8 中引入了 <strong>红黑树</strong>（查找时间复杂度为 $O(\log n)$）来优化这个问题</p>
</li>
</ul>
<ul>
<li><p>流程</p>
<p>添加时，当桶中链表个数超过 8 时会转换成红黑树</p>
<p>删除、扩容时，如果桶中结构为红黑树，并且树中元素个数太少的话，会进行修剪或者直接还原成链表结构</p>
<p>查找时即使哈希函数设计不合理，大量元素集中在一个桶中，由于有红黑树结构，性能也不会差</p>
</li>
</ul>
<h5 id="Collections-类"><a href="#Collections-类" class="headerlink" title="Collections 类"></a>Collections 类</h5><h6 id="空集合"><a href="#空集合" class="headerlink" title="空集合"></a>空集合</h6><p>　<code>Collections.emptyList()</code> 重用一个对象而不是创建一个新对象，就像 <code>Arrays.asList()</code> 一样。不同的是，<code>Collections.singletonList(something)</code> 是不可变的，而 <code>Arrays.asList(something)</code> 是一个固定大小的 List，其中 List 和 Array 在 Heap 中已经连接。</p>
<h5 id="LinkedList-vs-ArrayList-vs-ArrayDeque"><a href="#LinkedList-vs-ArrayList-vs-ArrayDeque" class="headerlink" title="LinkedList vs ArrayList vs ArrayDeque"></a>LinkedList vs ArrayList vs ArrayDeque</h5><p>　绝对大部分的场景，都能用 ArrayList 和 ArrayDeque 满足需求。而 LinkedList 唯一最擅长的场景是，遍历元素的时候，删除当前元素。ArrayList 使用下标访问元素时，因为不需要遍历链表，所以比 LinkedList 快很多。而 ArrayDeque 对开头和结尾进行增加或者删除时，因为不涉及分配链表节点和 GC 成本，所以也比 LinkedList 更快。不过，<code>ArrayDeque</code> 不支持 <code>null</code> 是硬伤</p>
<h5 id="java-util-Random-vs-java-util-concurrent-ThreadLocalRandom-vs-java-util-SplittableRandom"><a href="#java-util-Random-vs-java-util-concurrent-ThreadLocalRandom-vs-java-util-SplittableRandom" class="headerlink" title="java.util.Random vs java.util.concurrent.ThreadLocalRandom vs java.util.SplittableRandom"></a>java.util.Random vs java.util.concurrent.ThreadLocalRandom vs java.util.SplittableRandom</h5><p>　目前，JDK 中存在三种常用的方法来产生随机数，分别是 JDK1.0 的 <code>java.util.Random</code>、JDK1.7 的 <code>java.util.concurrent.ThreadLocalRandom</code> 和 JDK1.8 的 <code>java.util.SplittableRandom</code>（另外，<code>java.lang.Math.random()</code> 本质上还是 <code>java.util.Random</code>；而 <code>java.security.SecureRandom</code> 主要适用于加密场景，这里不做展开）。其中，<code>java.util.Random</code> 使用的是最普遍使用的线性同余法，该方法主要思路是通过对前一个数进行线性运算并取模从而得到下一个随机数。如此会带来一个问题，如果想保证线程安全，就需要在多线程之间共享 seed 值，同步的过程就会导致性能的损失。而 <code>ThreadLocalRandom</code> 和 <code>SplittableRandom</code> 为了避免该问题，则使用新发明的 SPLITMIX 算法，通过构建图谱和混合函数的方式，避免了加锁或 CAS 的过程。后两者都是基于同一个算法实现，不过也有稍微的区别，比如混合函数中引起<a href="https://en.wikipedia.org/wiki/Avalanche_effect">雪崩效应</a>的常数值不一致等。从工程实现角度来看，相比于 <code>Random</code>，后两者基于 Fork-Join 思想，使得其在并发场景下，性能更佳。并且，<code>ThreadLocalRandom</code> 继承于 <code>Random</code>，而 <code>SplittableRandom</code> 则是完全独立的类。<br>　从 Doug Lea 的论文可以看出，后两者无论是单线程还是多线程的场景下，都是优于 <code>java.util.Random</code> 的。而针对 32-bits 和 64-bits 两种场景下，<code>ThreadLocalRandom</code> 和 <code>SplittableRandom</code> 则各有千秋。</p>
<p><img data-src="/picture/java/java_random_sequential_throughput.png" alt="Sequential Throughput for Random"></p>
<p><img data-src="/picture/java/java_random_parallel_stream_throughput.png" alt="Parallel Stream Throughput for Random"></p>
<center>（图片来源：《Fast Splittable Pseudorandom Number Generators》）</center>




<h5 id="contains-方法"><a href="#contains-方法" class="headerlink" title="contains 方法"></a>contains 方法</h5><h6 id="HashSet"><a href="#HashSet" class="headerlink" title="HashSet"></a>HashSet</h6><p>　时间复杂度 和 内存使用率 角度看，<code>HashSet</code> 为最佳之选</p>
<h5 id="toArray-方法"><a href="#toArray-方法" class="headerlink" title="toArray 方法"></a>toArray 方法</h5><h6 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h6><p>　使用 <code>Collection.toArray</code> 将集合转数组的时候，应该传入长度为 <code>0</code> 的数组（例如，<code>new String[0])</code>），而非预分配大小的。如此不仅代码可读性更佳，性能也会更好。</p>
<p>　JDK6 之前推荐传入预分配大小的数组，是因为 <code>toArray</code> 会调用 <code>Array.newArray</code>，而该方法使用了反射的方式初始化数组，因而性能低下。而在 JDK6 之后，JVM 将 <code>newArray</code> 调用标记为 <code>@HotSpotIntrinsicCandidate</code> 方法，使得其直接调用 JVM 内部实现而不走正常 JNI 逻辑，从而规避了昂贵的反射操作。另外，数组在初始化的时候，需要通过 zeroing 的过程，将已经分配给数组的内存空间覆盖为初始值。而长度为 <code>0</code> 的数组，则可以节省下这部分的性能开销。</p>
<h6 id="压测"><a href="#压测" class="headerlink" title="压测"></a>压测</h6><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@State(Scope.Thread)</span></span><br><span class="line"><span class="meta">@OutputTimeUnit(TimeUnit.NANOSECONDS)</span></span><br><span class="line"><span class="meta">@BenchmarkMode(Mode.AverageTime)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ToArrayBenchmark</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Param({"1", "100", "1000", "5000", "10000", "100000"})</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> n;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Object&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Setup</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">populateList</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) {</span><br><span class="line">            list.add(<span class="number">0</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Benchmark</span></span><br><span class="line">    <span class="keyword">public</span> Object[] preSize() {</span><br><span class="line">        <span class="keyword">return</span> list.toArray(<span class="keyword">new</span> Object[n]);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Benchmark</span></span><br><span class="line">    <span class="keyword">public</span> Object[] resize() {</span><br><span class="line">        <span class="keyword">return</span> list.toArray(<span class="keyword">new</span> Object[<span class="number">0</span>]);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Integer List:</span></span><br><span class="line"><span class="comment">    Benchmark                    (n)  Mode  Cnt       Score        Error  Units</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.preSize       1  avgt    3      41.552 ±    108.030  ns/op</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.preSize     100  avgt    3     216.449 ±    799.501  ns/op</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.preSize    1000  avgt    3    2087.965 ±   6027.778  ns/op</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.preSize    5000  avgt    3    9098.358 ±  14603.493  ns/op</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.preSize   10000  avgt    3   24204.199 ± 121468.232  ns/op</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.preSize  100000  avgt    3  188183.618 ± 369455.090  ns/op</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.resize        1  avgt    3      18.987 ±     36.449  ns/op</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.resize      100  avgt    3     265.549 ±   1125.008  ns/op</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.resize     1000  avgt    3    1560.713 ±   2922.186  ns/op</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.resize     5000  avgt    3    7804.810 ±   8333.390  ns/op</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.resize    10000  avgt    3   24791.026 ±  78459.936  ns/op</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.resize   100000  avgt    3  158891.642 ±  56055.895  ns/op</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    Object List:</span></span><br><span class="line"><span class="comment">    Benchmark                    (n)  Mode  Cnt      Score       Error  Units</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.preSize       1  avgt    3     36.306 ±    96.612  ns/op</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.preSize     100  avgt    3     52.372 ±    84.159  ns/op</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.preSize    1000  avgt    3    449.807 ±   215.692  ns/op</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.preSize    5000  avgt    3   2080.172 ±  2003.726  ns/op</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.preSize   10000  avgt    3   4657.937 ±  8432.624  ns/op</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.preSize  100000  avgt    3  51980.829 ± 46920.314  ns/op</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.resize        1  avgt    3     16.747 ±    85.131  ns/op</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.resize      100  avgt    3     43.803 ±    28.704  ns/op</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.resize     1000  avgt    3    404.681 ±   132.986  ns/op</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.resize     5000  avgt    3   1972.649 ±   174.691  ns/op</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.resize    10000  avgt    3   4021.440 ±  1114.212  ns/op</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.resize   100000  avgt    3  44204.167 ± 76714.850  ns/op</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        Options opt = <span class="keyword">new</span> OptionsBuilder()</span><br><span class="line">                .include(ToArrayBenchmark.class.getSimpleName())</span><br><span class="line">                .forks(<span class="number">1</span>)</span><br><span class="line">                .warmupIterations(<span class="number">1</span>)</span><br><span class="line">                .measurementIterations(<span class="number">3</span>)</span><br><span class="line">                .threads(<span class="number">1</span>)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="keyword">new</span> Runner(opt).run();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>Tips: Full code is <a href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-hacker/src/test/java/com/yuzhouwan/hacker/algorithms/collection/ToArrayBenchmark.java">here</a>.</p>
<h5 id="instanceof"><a href="#instanceof" class="headerlink" title="instanceof"></a>instanceof</h5><div class="table-container">
<table>
<thead>
<tr>
<th>Operation</th>
<th>Runtime in nanoseconds per operation</th>
<th>Relative to instanceof</th>
</tr>
</thead>
<tbody>
<tr>
<td>INSTANCEOF</td>
<td>39,598 ± 0,022 ns/op</td>
<td>100,00 %</td>
</tr>
<tr>
<td>GETCLASS</td>
<td>39,687 ± 0,021 ns/op</td>
<td>100,22 %</td>
</tr>
<tr>
<td>TYPE</td>
<td>46,295 ± 0,026 ns/op</td>
<td>116,91 %</td>
</tr>
<tr>
<td>OO</td>
<td>48,078 ± 0,026 ns/op</td>
<td>121,42 %</td>
</tr>
</tbody>
</table>
</div>
<h4 id="字符串相关"><a href="#字符串相关" class="headerlink" title="字符串相关"></a>字符串相关</h4><h5 id="repeat"><a href="#repeat" class="headerlink" title="repeat"></a>repeat</h5><p>　借鉴 JDK11 中新增的 <code>String#repeat</code> 特性，实现高效的 repeat 工具方法</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns a string whose value is the concatenation of the</span></span><br><span class="line"><span class="comment"> * string {<span class="doctag">@code</span> s} repeated {<span class="doctag">@code</span> count} times.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * If count or length is zero then the empty string is returned.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * This method may be used to create space padding for</span></span><br><span class="line"><span class="comment"> * formatting text or zero padding for formatting numbers.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> count number of times to repeat</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> A string composed of this string repeated</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@code</span> count} times or the empty string if count</span></span><br><span class="line"><span class="comment"> * or length is zero.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IllegalArgumentException if the {<span class="doctag">@code</span> count} is negative.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@link</span> https://bugs.openjdk.java.net/browse/JDK-8197594</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">repeat</span><span class="params">(String s, <span class="keyword">int</span> count)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (count &lt; <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"count is negative, "</span> + count);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (count == <span class="number">1</span>) {</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">byte</span>[] value = s.getBytes(StandardCharsets.UTF_8);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> len = value.length;</span><br><span class="line">    <span class="keyword">if</span> (len == <span class="number">0</span> || count == <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (len == <span class="number">1</span>) {</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">byte</span>[] single = <span class="keyword">new</span> <span class="keyword">byte</span>[count];</span><br><span class="line">        Arrays.fill(single, value[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String(single, StandardCharsets.UTF_8);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (Integer.MAX_VALUE / count &lt; len) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> OutOfMemoryError();</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> limit = len * count;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">byte</span>[] multiple = <span class="keyword">new</span> <span class="keyword">byte</span>[limit];</span><br><span class="line">    System.arraycopy(value, <span class="number">0</span>, multiple, <span class="number">0</span>, len);</span><br><span class="line">    <span class="keyword">int</span> copied = len;</span><br><span class="line">    <span class="keyword">for</span> (; copied &lt; limit - copied; copied &lt;&lt;= <span class="number">1</span>) {</span><br><span class="line">        System.arraycopy(multiple, <span class="number">0</span>, multiple, copied, copied);</span><br><span class="line">    }</span><br><span class="line">    System.arraycopy(multiple, <span class="number">0</span>, multiple, copied, limit - copied);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> String(multiple, StandardCharsets.UTF_8);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Fork-Join-思想"><a href="#Fork-Join-思想" class="headerlink" title="Fork / Join 思想"></a>Fork / Join 思想</h4><p>　这里以查找最小数为例，具体实现如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ForkJoinPool;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.RecursiveTask;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Copyright @ 2019 yuzhouwan.com</span></span><br><span class="line"><span class="comment"> * All right reserved.</span></span><br><span class="line"><span class="comment"> * Function：Minimum Finder</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Benedict Jin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2019/4/13</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MinimumFinder</span> <span class="keyword">extends</span> <span class="title">RecursiveTask</span>&lt;<span class="title">Integer</span>&gt; </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> JOIN_THRESHOLD = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span>[] data;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> start;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> end;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">MinimumFinder</span><span class="params">(<span class="keyword">int</span>[] data, <span class="keyword">int</span> start, <span class="keyword">int</span> end)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">        <span class="keyword">this</span>.start = start;</span><br><span class="line">        <span class="keyword">this</span>.end = end;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">MinimumFinder</span><span class="params">(<span class="keyword">int</span>[] data)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>(data, <span class="number">0</span>, data.length);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Integer <span class="title">compute</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> len = end - start;</span><br><span class="line">        <span class="keyword">if</span> (len &lt; JOIN_THRESHOLD) {</span><br><span class="line">            <span class="keyword">return</span> internal();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> split = len / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">final</span> MinimumFinder left = <span class="keyword">new</span> MinimumFinder(data, start, start + split);</span><br><span class="line">        left.fork();</span><br><span class="line">        <span class="keyword">final</span> MinimumFinder right = <span class="keyword">new</span> MinimumFinder(data, start + split, end);</span><br><span class="line">        <span class="keyword">return</span> Math.min(right.compute(), left.join());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Integer <span class="title">internal</span><span class="params">()</span> </span>{</span><br><span class="line">        System.out.println(Thread.currentThread() + <span class="string">" computing: "</span> + start + <span class="string">" to "</span> + end);</span><br><span class="line">        <span class="keyword">int</span> min = Integer.MAX_VALUE;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = start; i &lt; end; i++) {</span><br><span class="line">            <span class="keyword">if</span> (data[i] &lt; min) {</span><br><span class="line">                min = data[i];</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> min;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span>[] data = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1000</span>];</span><br><span class="line">        <span class="keyword">final</span> Random random = <span class="keyword">new</span> Random(System.nanoTime());</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; data.length; i++) {</span><br><span class="line">            data[i] = random.nextInt(<span class="number">100</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">final</span> ForkJoinPool pool = <span class="keyword">new</span> ForkJoinPool(Runtime.getRuntime().availableProcessors());</span><br><span class="line">        <span class="keyword">final</span> MinimumFinder finder = <span class="keyword">new</span> MinimumFinder(data);</span><br><span class="line">        System.out.println(pool.invoke(finder));</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>　另外，JDK8+ 中使用 <code>parallelStream()</code> 方法将集合转为并行的 Stream 进行处理，内部使用的便是 Fork/Join 思想。需要注意的是，parallelStream 内部创建的线程池大小可以通过 <code>java.util.concurrent.ForkJoinPool.common.parallelism</code> 参数来控制，最大不能超过 <code>ForkJoinPool#MAX_CAP</code>，即 <code>32767</code>。默认情况下，直接使用 CPU 的虚拟核数作为线程池大小。</p>
<h4 id="Memoization"><a href="#Memoization" class="headerlink" title="Memoization"></a>Memoization</h4><p>　摘自一段来自 <a href="https://en.wikipedia.org/wiki/Memoization">wikipedia.org</a> 的定义，如下</p>
<blockquote>
<p>In computing, memoization or memoisation is an optimization technique used primarily to speed up computer programs by storing the results of expensive function calls and returning the cached result when the same inputs occur again.</p>
</blockquote>
<p>　由此可见，Memoization 也就是我们常用的单例设计模式的由来。如果项目中使用到了 Guava，则可以很方便地通过调用 <code>Suppliers.memoize(() -&gt; {...})</code> 来实现。其<a href="https://github.com/google/guava/blob/master/guava/src/com/google/common/base/Suppliers.java#L85">内部</a>实现了一个 <code>2-field</code> 变种的 Double-check 锁，具体如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns a supplier which caches the instance retrieved during the first</span></span><br><span class="line"><span class="comment"> * call to {<span class="doctag">@code</span> get()} and returns that value on subsequent calls to</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@code</span> get()}. See:</span></span><br><span class="line"><span class="comment"> * &lt;a href="http://en.wikipedia.org/wiki/Memoization"&gt;memoization&lt;/a&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;The returned supplier is thread-safe. The supplier's serialized form</span></span><br><span class="line"><span class="comment"> * does not contain the cached value, which will be recalculated when {<span class="doctag">@code</span></span></span><br><span class="line"><span class="comment"> * get()} is called on the reserialized instance.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;If {<span class="doctag">@code</span> delegate} is an instance created by an earlier call to {<span class="doctag">@code</span></span></span><br><span class="line"><span class="comment"> * memoize}, it is returned directly.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Supplier&lt;T&gt; <span class="title">memoize</span><span class="params">(Supplier&lt;T&gt; delegate)</span> </span>{</span><br><span class="line">  <span class="keyword">return</span> (delegate <span class="keyword">instanceof</span> MemoizingSupplier)</span><br><span class="line">         ? delegate</span><br><span class="line">         : <span class="keyword">new</span> MemoizingSupplier&lt;T&gt;(Preconditions.checkNotNull(delegate));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@VisibleForTesting</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MemoizingSupplier</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Supplier</span>&lt;<span class="title">T</span>&gt;, <span class="title">Serializable</span> </span>{</span><br><span class="line">  <span class="keyword">final</span> Supplier&lt;T&gt; delegate;</span><br><span class="line">  <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> initialized;</span><br><span class="line">  <span class="comment">// "value" does not need to be volatile; visibility piggy-backs</span></span><br><span class="line">  <span class="comment">// on volatile read of "initialized".</span></span><br><span class="line">  <span class="keyword">transient</span> T value;</span><br><span class="line"></span><br><span class="line">  MemoizingSupplier(Supplier&lt;T&gt; delegate) {</span><br><span class="line">    <span class="keyword">this</span>.delegate = delegate;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> T <span class="title">get</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// A 2-field variant of Double Checked Locking.</span></span><br><span class="line">    <span class="keyword">if</span> (!initialized) {</span><br><span class="line">      <span class="keyword">synchronized</span> (<span class="keyword">this</span>) {</span><br><span class="line">        <span class="keyword">if</span> (!initialized) {</span><br><span class="line">          T t = delegate.get();</span><br><span class="line">          value = t;</span><br><span class="line">          initialized = <span class="keyword">true</span>;</span><br><span class="line">          <span class="keyword">return</span> t;</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Suppliers.memoize("</span> + delegate + <span class="string">")"</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="堆栈优化"><a href="#堆栈优化" class="headerlink" title="堆栈优化"></a>堆栈优化</h4><h5 id="ByteBuffer"><a href="#ByteBuffer" class="headerlink" title="ByteBuffer"></a>ByteBuffer</h5><p>　通过 <code>allocateDirect(int capacity)</code> 方法可以避开堆栈，直接通过操作系统创建内存块作为缓冲区。该方式与操作系统能更好地耦合，因而能进一步提高 I/O 操作的速度。缺点是，分配直接缓冲区的系统开销很大。因此，只有在缓冲区较大并会长期存在，或者需要经常重用时，才使用这种缓冲区</p>
<h4 id="位运算"><a href="#位运算" class="headerlink" title="位运算"></a>位运算</h4><h5 id="奇偶数"><a href="#奇偶数" class="headerlink" title="奇偶数"></a>奇偶数</h5><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isEven</span><span class="params">(<span class="keyword">int</span> i)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> (i &amp; <span class="number">1</span>) == <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h5 id="毫秒"><a href="#毫秒" class="headerlink" title="毫秒"></a>毫秒</h5><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> SECOND_MASK = <span class="number">0xFFFFFFFF00000000L</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isMillis</span><span class="params">(<span class="keyword">long</span> timestamp)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> (timestamp &amp; SECOND_MASK) != <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="时间戳"><a href="#时间戳" class="headerlink" title="时间戳"></a>时间戳</h4><p>　<code>System.currentTimeMillis()</code> 通过 <code>GetSystemTimeAsFileTime</code> API 可以快速地获取系统的全局变量值，以得到毫秒值。但是，这个接口取决于操作系统底层的实现，所以有可能该全局变量值的更新频率不高，导致无法满足毫秒级别的精度。如果，是在高精度监控或者游戏等，对时间精度要求很高的领域，则需要使用 <code>System.nanoTime()</code>。后者，使用了 PIT（programmable-interval-timer）、PMT（power management timer）或 TSC（CPU-level timestamp-counter）几种高精度的时间计数器，以保证准确性。但 <code>System.nanoTime()</code> 的执行过程会存在微秒级别的耗时，所以也很难真正达到纳秒级的精度</p>
<h4 id="强引用-vs-软引用-vs-弱引用-vs-虚引用"><a href="#强引用-vs-软引用-vs-弱引用-vs-虚引用" class="headerlink" title="强引用 vs 软引用 vs 弱引用 vs 虚引用"></a>强引用 vs 软引用 vs 弱引用 vs 虚引用</h4><p>　合理地利用软引用和弱引用，可以有效解决 OOM 问题，下表是关于四种引用类型的比对：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th></th>
<th>例子</th>
<th>用途</th>
<th>生命周期</th>
<th>触发回收的时刻</th>
</tr>
</thead>
<tbody>
<tr>
<td>强引用</td>
<td><code>Object o = new Object()</code></td>
<td>对象的一般状态</td>
<td>JVM 停止运行时终止</td>
<td>从来不会</td>
</tr>
<tr>
<td>软引用</td>
<td><code>new SoftReference&lt;&gt;("yuzhouwan")</code></td>
<td>对象缓存</td>
<td>内存不足时终止</td>
<td>内存不足时</td>
</tr>
<tr>
<td>弱引用</td>
<td><code>new WeakReference&lt;&gt;("asdf")</code></td>
<td>对象缓存</td>
<td>GC 运行后终止</td>
<td>垃圾回收时</td>
</tr>
<tr>
<td>虚引用</td>
<td><code>new PhantomReference&lt;&gt;("2014", new ReferenceQueue&lt;&gt;())</code></td>
<td>跟踪对象被垃圾回收器回收的活动</td>
<td>无生命周期</td>
<td>任何时候</td>
</tr>
</tbody>
</table>
</div>
<h2 id="测试相关"><a href="#测试相关" class="headerlink" title="测试相关"></a>测试相关</h2><h3 id="参数驱动"><a href="#参数驱动" class="headerlink" title="参数驱动"></a>参数驱动</h3><p>　利用 <code>@Parameterized.Parameters</code> 注解可以指定多个可能的传值，使得当前测试类下的所有测试用例可以被多次复用。但是该注解并不能让参数之间自行组合，所以严格来说，并不是参数驱动（后续介绍的 HttpRunner 框架则是严格意义上的参数驱动）</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.yuzhouwan.compression.CompressionType;</span><br><span class="line"><span class="keyword">import</span> org.junit.FixMethodOrder;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.junit.runners.MethodSorters;</span><br><span class="line"><span class="keyword">import</span> org.junit.runners.Parameterized;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="meta">@FixMethodOrder(MethodSorters.JVM)</span></span><br><span class="line"><span class="meta">@RunWith(Parameterized.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CompressionTest</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Parameterized</span>.Parameter()</span><br><span class="line">    <span class="keyword">public</span> CompressionType compressionType4ts;</span><br><span class="line">    <span class="meta">@Parameterized</span>.Parameter(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">public</span> CompressionType compressionType4longValue;</span><br><span class="line">    <span class="meta">@Parameterized</span>.Parameter(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">public</span> CompressionType compressionType4doubleValue;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Parameterized</span>.Parameters</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Iterable&lt;Object[]&gt; getParameters() {</span><br><span class="line">        <span class="keyword">return</span> Arrays.asList(<span class="keyword">new</span> Object[][]{</span><br><span class="line">                {CompressionType.NONE, CompressionType.NONE, CompressionType.NONE},</span><br><span class="line">                {CompressionType.SIMPLE8B, CompressionType.NONE, CompressionType.GORILLA},</span><br><span class="line">                {CompressionType.SIMPLE8B_WITH_RLE, CompressionType.ZIGZAG_WITH_SIMPLE8B, CompressionType.NONE},</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * NONE - NONE - NONE</span></span><br><span class="line"><span class="comment">     * SIMPLE8B - NONE - GORILLA</span></span><br><span class="line"><span class="comment">     * SIMPLE8B_WITH_RLE - ZIGZAG_WITH_SIMPLE8B - NONE</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>{</span><br><span class="line">        System.out.println(compressionType4ts + <span class="string">" - "</span> + compressionType4longValue + <span class="string">" - "</span> + compressionType4doubleValue);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="自动化测试"><a href="#自动化测试" class="headerlink" title="自动化测试"></a>自动化测试</h3><h4 id="HttpRunner"><a href="#HttpRunner" class="headerlink" title="HttpRunner"></a>HttpRunner</h4><h5 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h5><p>　<a href="https://v2.httprunner.org/">HttpRunner</a>™ 是一款面向 HTTP(S) 协议的通用测试框架，只需编写维护一份 <code>YAML/JSON</code> 脚本，即可实现自动化测试、性能测试、线上监控、持续集成等多种测试需求。这里将以测试 OpenTSDB 为例，更加具象地介绍 HttpRunner</p>
<h5 id="QuickStart"><a href="#QuickStart" class="headerlink" title="QuickStart"></a>QuickStart</h5><h6 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ pip install httprunner==1.5.15</span><br><span class="line"></span><br><span class="line">$ hrun -V</span><br><span class="line">  1.5.15</span><br><span class="line"></span><br><span class="line">$ har2case -V</span><br><span class="line">  0.2.0</span><br></pre></td></tr></tbody></table></figure>
<h6 id="启动-Flask"><a href="#启动-Flask" class="headerlink" title="启动 Flask"></a>启动 Flask</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ pip install flask</span><br><span class="line"></span><br><span class="line">$ mkdir docs/data/</span><br><span class="line">$ wget https://v2.httprunner.org/data/api_server.py -P docs/data/</span><br><span class="line">$ <span class="built_in">export</span> FLASK_APP=docs/data/api_server.py</span><br><span class="line">$ <span class="built_in">export</span> FLASK_ENV=development</span><br><span class="line">$ flask run</span><br><span class="line"></span><br><span class="line">$ curl localhost:5000                                          </span><br><span class="line">  Hello World!</span><br></pre></td></tr></tbody></table></figure>
<h6 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ wget https://v2.httprunner.org/data/demo-quickstart.har -P docs/data/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 demo-quickstart.har 转换为 HttpRunner 的测试用例文件</span></span><br><span class="line"><span class="comment"># 默认输出 JSON 文件，加 `-2y` 参数，可以转化为 YAML</span></span><br><span class="line">$ har2case docs/data/demo-quickstart.har</span><br><span class="line">$ hrun docs/data/demo-quickstart.json</span><br></pre></td></tr></tbody></table></figure>
<h5 id="新建测试项目"><a href="#新建测试项目" class="headerlink" title="新建测试项目"></a>新建测试项目</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 新建目录</span></span><br><span class="line">$ httprunner --startproject yuzhouwan</span><br><span class="line"></span><br><span class="line">$ ls -sail</span><br><span class="line">  12891420763 4 -rw-r--r--  1 benedictjin wheel   44 Feb  2 11:37 .env</span><br><span class="line">  12891384628 0 drwxr-xr-x  2 benedictjin wheel   64 Feb  1 16:44 api/</span><br><span class="line">  12891454305 4 -rw-r--r--  1 benedictjin wheel 2389 Feb  2 14:34 debugtalk.py</span><br><span class="line">  12891454901 4 -rw-r--r--  1 benedictjin wheel 1452 Feb  2 15:21 locustfile.py</span><br><span class="line">  12891454386 0 drwxr-xr-x  8 benedictjin wheel  256 Feb  2 15:30 reports/</span><br><span class="line">  12891384629 0 drwxr-xr-x  7 benedictjin wheel  224 Feb  2 14:47 testcases/</span><br><span class="line">  12891384630 0 drwxr-xr-x  2 benedictjin wheel   64 Feb  1 16:44 testsuites/</span><br><span class="line"><span class="comment"># .env         存放环境变量的 properties 文件</span></span><br><span class="line"><span class="comment"># testcases    存放所有 httprunner 的 json 测试实例</span></span><br><span class="line"><span class="comment"># debugtalk.py 存放所有 httprunner 测试实例中，需要用到自定义函数</span></span><br><span class="line"><span class="comment"># reports      生成的 html 结果页面</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="性能测试"><a href="#性能测试" class="headerlink" title="性能测试"></a>性能测试</h5><h6 id="环境部署"><a href="#环境部署" class="headerlink" title="环境部署"></a>环境部署</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ python -m pip install --trusted-host pypi.python.org --trusted-host files.pythonhosted.org --trusted-host pypi.org locustio</span><br><span class="line"></span><br><span class="line">$ locusts -V</span><br><span class="line">  [2019-02-02 10:17:55,387] BenedictJin.local/INFO/stdout: Locust 0.9.0</span><br><span class="line">  [2019-02-02 10:17:55,387] BenedictJin.local/INFO/stdout:</span><br><span class="line"></span><br><span class="line">$ locusts -f put_one_point_with_variable_data_types.json --processes 4</span><br><span class="line">  [2019-02-02 10:18:53,668] BenedictJin.local/INFO/locust.main: Starting web monitor at *:8089</span><br><span class="line">  [2019-02-02 10:18:53,668] BenedictJin.local/INFO/locust.main: Starting Locust 0.9.0</span><br></pre></td></tr></tbody></table></figure>
<h6 id="测试限流"><a href="#测试限流" class="headerlink" title="测试限流"></a>测试限流</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 需要先打开服务端的限流</span></span><br><span class="line">$ <span class="built_in">source</span> .env</span><br><span class="line">$ locusts -f testcases/<span class="built_in">limit</span>/limit_tps_with_number.json --processes 4 -H <span class="variable">${base_url_from_env}</span> -L DEBUG</span><br><span class="line">$ locusts -f testcases/<span class="built_in">limit</span>/limit_tps_with_string.json --processes 4 -H <span class="variable">${base_url_from_env}</span> -L DEBUG</span><br></pre></td></tr></tbody></table></figure>
<p><img data-src="/picture/java/java_limit_tps_with_string.png" alt=""></p>
<center>（对 <a href="https://github.com/HttpRunner" target="_blank">HttpRunner</a>™ 的截图）</center>


<h5 id="抓包并转为-TestCase"><a href="#抓包并转为-TestCase" class="headerlink" title="抓包并转为 TestCase"></a>抓包并转为 TestCase</h5><h6 id="使用-Charles-抓包工具"><a href="#使用-Charles-抓包工具" class="headerlink" title="使用 Charles 抓包工具"></a>使用 Charles 抓包工具</h6><p>　通过该方法，可以将现有的测试用例，轻松地转为 http_runner 的表现形式。具体步骤如下：</p>
<p>a) 安装 Charles Proxy</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Mac</span></span><br><span class="line"><span class="comment"># https://www.charlesproxy.com/download/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Linux</span></span><br><span class="line">$ cat &lt;&lt;EOF &gt; /etc/yum.repos.d/Charles.repo</span><br><span class="line">  [charlesproxy]</span><br><span class="line">  name=Charles Proxy Repository</span><br><span class="line">  baseurl=https://www.charlesproxy.com/packages/yum</span><br><span class="line">  gpgkey=https://www.charlesproxy.com/packages/yum/PublicKey</span><br><span class="line">  EOF</span><br><span class="line"></span><br><span class="line">$ sudo yum install charles-proxy</span><br></pre></td></tr></tbody></table></figure>
<p>b) 关闭 browsermob-proxy</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ pkill -1 -f browsermob-proxy</span><br></pre></td></tr></tbody></table></figure>
<p>c) 在 Http Request 中增加 Proxy</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">request.setConfig(RequestConfig.custom().setProxy(<span class="keyword">new</span> HttpHost(<span class="string">"127.0.0.1"</span>, <span class="number">8888</span>)).build());</span><br><span class="line"><span class="comment">// 修改好之后，重新打包编译即可</span></span><br></pre></td></tr></tbody></table></figure>
<h6 id="使用-browsermobproxy-代理库"><a href="#使用-browsermobproxy-代理库" class="headerlink" title="使用 browsermobproxy 代理库"></a>使用 browsermobproxy 代理库</h6><p>　也可以通过编写 Python 脚本，来创建 Proxy，并使用 Json 库将 Proxy 抓包内容以 har 的形式保存为文件</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> psutil</span><br><span class="line"><span class="keyword">from</span> browsermobproxy <span class="keyword">import</span> Server</span><br><span class="line"></span><br><span class="line"><span class="comment"># pkill -1 -f browsermob-proxy</span></span><br><span class="line"><span class="keyword">for</span> proc <span class="keyword">in</span> psutil.process_iter():</span><br><span class="line">    <span class="keyword">if</span> proc.name() == <span class="string">"browsermob-proxy"</span>:</span><br><span class="line">        proc.kill()</span><br><span class="line"></span><br><span class="line">server = Server(path=<span class="string">"/apps/browsermob-proxy-2.1.4/bin/browsermob-proxy"</span>,</span><br><span class="line">                options={<span class="string">'port'</span>: <span class="number">8880</span>})</span><br><span class="line">server.start()</span><br><span class="line"></span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">proxy = server.create_proxy(params={<span class="string">'port'</span>: <span class="number">8881</span>})</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'testcases.txt'</span>, <span class="string">"r+"</span>, encoding=<span class="string">"utf8"</span>) <span class="keyword">as</span> of:</span><br><span class="line">    os.chdir(<span class="string">"/code/yuzhouwan-test-cloud"</span>)</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> of.readlines():</span><br><span class="line"></span><br><span class="line">        line = line.strip(<span class="string">'\n'</span>)</span><br><span class="line">        print(line)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'.'</span> <span class="keyword">not</span> <span class="keyword">in</span> line:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        splits = line.split(<span class="string">'.'</span>)</span><br><span class="line">        clazz = splits[<span class="number">0</span>]</span><br><span class="line">        method = splits[<span class="number">1</span>]</span><br><span class="line">        proxy.new_har(<span class="string">"com.yuzhouwan.yuzhouwan.client.%s,%s"</span> % (clazz, method),</span><br><span class="line">                      options={<span class="string">'captureHeaders'</span>: <span class="literal">True</span>, <span class="string">'captureContent'</span>: <span class="literal">True</span>, <span class="string">'captureBinaryContent'</span>: <span class="literal">True</span>})</span><br><span class="line"></span><br><span class="line">        command = <span class="string">'java -ea -Didea.test.cyclic.buffer.size=1048576 -javaagent:'</span> \</span><br><span class="line">                  <span class="string">'&lt;...&gt;" '</span> \</span><br><span class="line">                  <span class="string">'com.intellij.rt.execution.junit.JUnitStarter -ideVersion5 -junit4 '</span> \</span><br><span class="line">                  <span class="string">'com.yuzhouwan.yuzhouwan.client.%s,%s'</span> % (clazz, method)</span><br><span class="line">        os.system(command)</span><br><span class="line"></span><br><span class="line">        json_obj = json.dumps(proxy.har)</span><br><span class="line"></span><br><span class="line">        file_dir = <span class="string">'/Users/benedictjin/Documents/http_runner/%s/'</span> % clazz</span><br><span class="line">        file_name = method</span><br><span class="line">        file_extension = <span class="string">'.har'</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(file_dir):</span><br><span class="line">            os.makedirs(file_dir)</span><br><span class="line"></span><br><span class="line">        fileObject = open(file_dir + file_name + file_extension, <span class="string">'w'</span>)</span><br><span class="line">        fileObject.write(json_obj)</span><br><span class="line">        fileObject.close()</span><br><span class="line"></span><br><span class="line">server.stop()</span><br></pre></td></tr></tbody></table></figure>
<h5 id="二次开发"><a href="#二次开发" class="headerlink" title="二次开发"></a>二次开发</h5><h6 id="解决-http-runner-中只能解析部分-parameters-的问题"><a href="#解决-http-runner-中只能解析部分-parameters-的问题" class="headerlink" title="解决 http_runner 中只能解析部分 parameters 的问题"></a>解决 http_runner 中只能解析部分 parameters 的问题</h6><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># vim httprunner/parser.py</span></span><br><span class="line">parsed_parameters_list = []</span><br><span class="line"><span class="keyword">for</span> parameter <span class="keyword">in</span> parameters:</span><br><span class="line">    parameter_name, parameter_content = list(parameter.items())[<span class="number">0</span>]</span><br><span class="line">    parameter_name_list = parameter_name.split(<span class="string">"-"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 改为</span></span><br><span class="line">parsed_parameters_list = []</span><br><span class="line"><span class="keyword">for</span> parameter_name, parameter_content <span class="keyword">in</span> parameters.items():</span><br><span class="line">    parameter_name_list = parameter_name.split(<span class="string">"-"</span>)</span><br></pre></td></tr></tbody></table></figure>
<h6 id="使得-har2case-支持-list-结构的-JSON"><a href="#使得-har2case-支持-list-结构的-JSON" class="headerlink" title="使得 har2case 支持 list 结构的 JSON"></a>使得 har2case 支持 list 结构的 JSON</h6><p>　详见：Let <code>_make_validate</code> method supports the <code>list</code> structures JSON <a href="https://github.com/HttpRunner/har2case/pull/18/files">#18</a></p>
<h6 id="使得-har2case-支持普通文本的返回类型"><a href="#使得-har2case-支持普通文本的返回类型" class="headerlink" title="使得 har2case 支持普通文本的返回类型"></a>使得 har2case 支持普通文本的返回类型</h6><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># vim har2case/core.py</span></span><br><span class="line">mime_type = resp_content_dict.get(<span class="string">"mimeType"</span>)</span><br><span class="line"><span class="keyword">if</span> mime_type <span class="keyword">and</span> mime_type.startswith(<span class="string">"application/json"</span>):</span><br><span class="line"></span><br><span class="line">    encoding = resp_content_dict.get(<span class="string">"encoding"</span>)</span><br><span class="line">    <span class="keyword">if</span> encoding <span class="keyword">and</span> encoding == <span class="string">"base64"</span>:</span><br><span class="line">        content = base64.b64decode(text).decode(<span class="string">'utf-8'</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            resp_content_json = json.loads(content)</span><br><span class="line">        <span class="keyword">except</span> JSONDecodeError:</span><br><span class="line">            logging.warning(<span class="string">"response content can not be loaded as json."</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        resp_content_json = json.loads(text)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 改为</span></span><br><span class="line">mime_type = resp_content_dict.get(<span class="string">"mimeType"</span>)</span><br><span class="line"><span class="keyword">if</span> mime_type <span class="keyword">and</span> mime_type.startswith(<span class="string">"application/json"</span>):</span><br><span class="line"></span><br><span class="line">    encoding = resp_content_dict.get(<span class="string">"encoding"</span>)</span><br><span class="line">    <span class="keyword">if</span> encoding <span class="keyword">and</span> encoding == <span class="string">"base64"</span>:</span><br><span class="line">        text = base64.b64decode(text).decode(<span class="string">'utf-8'</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        resp_content_json = json.loads(text)</span><br><span class="line">    <span class="keyword">except</span> JSONDecodeError:</span><br><span class="line">        logging.warning(<span class="string">"response content can not be loaded as json."</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    print(<span class="string">"resp_content_json"</span>, resp_content_json)</span><br></pre></td></tr></tbody></table></figure>
<h6 id="使二次开发的改动生效"><a href="#使二次开发的改动生效" class="headerlink" title="使二次开发的改动生效"></a>使二次开发的改动生效</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ pip uninstall har2case -y</span><br><span class="line">$ <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/har2case/har2case</span><br><span class="line">$ python setup.py install</span><br><span class="line"></span><br><span class="line">$ har2case --<span class="built_in">log</span>-level DEBUG test.har</span><br></pre></td></tr></tbody></table></figure>
<h5 id="可视化管理系统"><a href="#可视化管理系统" class="headerlink" title="可视化管理系统"></a>可视化管理系统</h5><h6 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h6><p>　按照<a href="https://github.com/HttpRunner/HttpRunnerManager#%E6%9C%AC%E5%9C%B0%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2">部署手册</a>即可部署成功。相关的，比如，<a href="https://www.jianshu.com/p/07a9826898c0">MySQL 安装</a>、<a href="https://blog.csdn.net/jeikerxiao/article/details/73822184">RabbitMQ 安装</a>，都能找到很多资料。这里，主要记录几个可能踩到的坑</p>
<h6 id="可视化管理页面"><a href="#可视化管理页面" class="headerlink" title="可视化管理页面"></a>可视化管理页面</h6><p>　配置环境、增加测试用例、组合测试套件等，效果如下图所示：</p>
<p><img data-src="/picture/java/java_http_runner_suit.png" alt=""></p>
<p>　运行结果报告页面，效果如下图所示：</p>
<p><img data-src="/picture/java/java_http_runner_report.png" alt=""></p>
<p>　支持权限管理，超级管理员可以配置整个管理系统，效果如下图所示：</p>
<p><img data-src="/picture/java/java_http_runner_super_user.png" alt=""></p>
<center>（对 <a href="https://github.com/HttpRunner" target="_blank">HttpRunner</a>™ 的截图）</center>



<h5 id="踩到的坑"><a href="#踩到的坑" class="headerlink" title="踩到的坑"></a>踩到的坑</h5><h6 id="MySQL-默认编码导致-Django-报错-OperationalError"><a href="#MySQL-默认编码导致-Django-报错-OperationalError" class="headerlink" title="MySQL 默认编码导致 Django 报错 OperationalError"></a>MySQL 默认编码导致 Django 报错 OperationalError</h6><ul>
<li>描述</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ python manage.py migrate</span><br><span class="line"><span class="comment"># 报错 django.db.utils.OperationalError: (1366, "Incorrect string value for column 'name' at row 1")</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>解决</li>
</ul>
<p>　这个问题是因为新安装的 MySQL 默认的编码不是 <code>UTF-8</code> 导致的，停掉 <code>mysql</code> 实例配置 <code>my.cnf</code> 再重启即可。如果停止不掉，可以 <code>pkill mysql</code> 强制停止。之前创建的数据库也需要删掉重新创建</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/mysql/support-files</span><br><span class="line">$ sudo ./mysql.server stop</span><br><span class="line">$ vim my.cnf</span><br><span class="line">  [client]</span><br><span class="line">  default-character-set=utf8</span><br><span class="line"></span><br><span class="line">  [mysql]</span><br><span class="line">  default-character-set=utf8</span><br><span class="line"></span><br><span class="line">  [mysqld]</span><br><span class="line">  collation-server=utf8_unicode_ci</span><br><span class="line">  init-connect=<span class="string">'SET NAMES utf8'</span></span><br><span class="line">  character-set-server=utf8</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果 my.cnf 没有生效，可能需要拷贝一份到 /private/etc 目录下</span></span><br><span class="line">$ <span class="built_in">cd</span> /private/etc</span><br><span class="line">$ sudo cp /usr/<span class="built_in">local</span>/mysql/support-files/my.cnf .</span><br><span class="line"></span><br><span class="line">$ sudo ./mysql.server restart</span><br><span class="line">$ mysql -u root -p</span><br><span class="line">mysql&gt; show variables like <span class="string">'%char%'</span>;</span><br><span class="line">+--------------------------+-----------------------------------------------------------+</span><br><span class="line">| Variable_name            | Value                                                     |</span><br><span class="line">+--------------------------+-----------------------------------------------------------+</span><br><span class="line">| character_set_client     | utf8                                                      |</span><br><span class="line">| character_set_connection | utf8                                                      |</span><br><span class="line">| character_set_database   | utf8                                                      |</span><br><span class="line">| character_set_filesystem | binary                                                    |</span><br><span class="line">| character_set_results    | utf8                                                      |</span><br><span class="line">| character_set_server     | utf8                                                      |</span><br><span class="line">| character_set_system     | utf8                                                      |</span><br><span class="line">| character_sets_dir       | /usr/<span class="built_in">local</span>/mysql-5.7.25-macos10.14-x86_64/share/charsets/ |</span><br><span class="line">+--------------------------+-----------------------------------------------------------+</span><br><span class="line">8 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; drop database HttpRunner;</span><br><span class="line">Query OK, 27 rows affected (0.05 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; create database HttpRunner;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 增加 `TEST_CHARSET` 连接配置</span></span><br><span class="line">$ vim HttpRunnerManager/settings.py</span><br><span class="line">  DATABASES = {</span><br><span class="line">      <span class="string">'default'</span>: {</span><br><span class="line">          <span class="comment"># ...</span></span><br><span class="line">          <span class="string">'TEST_CHARSET'</span>: <span class="string">'utf-8'</span></span><br><span class="line">      }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">$ python manage.py migrate</span><br></pre></td></tr></tbody></table></figure>
<h2 id="JVM-相关"><a href="#JVM-相关" class="headerlink" title="JVM 相关"></a><a href="https://yuzhouwan.com/posts/27328/">JVM 相关</a></h2><h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><h4 id="堆内-vs-堆外"><a href="#堆内-vs-堆外" class="headerlink" title="堆内 vs 堆外"></a>堆内 vs 堆外</h4><h5 id="堆内内存"><a href="#堆内内存" class="headerlink" title="堆内内存"></a>堆内内存</h5><p>　一般情况下，Java 中分配的非空对象都是由 Java 虚拟机的垃圾收集器管理的，也称为<strong>堆内内存</strong>（on-heap memory）</p>
<h5 id="堆外内存"><a href="#堆外内存" class="headerlink" title="堆外内存"></a>堆外内存</h5><p>　<strong>堆外内存</strong>（off-heap memory）意味着把内存对象分配在 Java 虚拟机的堆以外的内存，这些内存直接受操作系统管理（而不是虚拟机）</p>
<h5 id="堆外内存的优势"><a href="#堆外内存的优势" class="headerlink" title="堆外内存的优势"></a>堆外内存的优势</h5><ul>
<li>对于大内存有良好的伸缩性</li>
<li>对垃圾回收停顿的改善可以明显感觉到</li>
<li>在进程间可以共享，减少虚拟机间的复制</li>
</ul>
<h5 id="堆外内存的劣势"><a href="#堆外内存的劣势" class="headerlink" title="堆外内存的劣势"></a>堆外内存的劣势</h5><ul>
<li>数据结构变得不那么直观，发生内存溢出的时候，排查定位会很麻烦</li>
<li>如果数据结构比较复杂，就要对它进行串行化（serialization），而串行化本身也会影响性能</li>
<li>可以使用更大的内存的同时，需要担心虚拟内存（即硬盘）的速度对应用的影响</li>
</ul>
<h5 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h5><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">-XX:MaxDirectMemorySize=64M 可以控制堆外内存大小，默认在 VM 静态变量 directMemory 为 64M</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">maxDirectMemory: 67108864</span></span><br><span class="line"><span class="comment">isDirect: true</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>{</span><br><span class="line">    System.out.println(<span class="string">"maxDirectMemory: "</span> + VM.maxDirectMemory());</span><br><span class="line">    ByteBuffer buffer = ByteBuffer.allocateDirect(<span class="number">1024</span> * <span class="number">1024</span> * <span class="number">64</span>);</span><br><span class="line">    Thread.sleep(<span class="number">200</span>);</span><br><span class="line">    <span class="keyword">boolean</span> isDirect = buffer.isDirect();</span><br><span class="line">    System.out.println(<span class="string">"isDirect: "</span> + isDirect);</span><br><span class="line">    <span class="keyword">if</span> (isDirect) ((DirectBuffer) buffer).cleaner().clean();</span><br><span class="line">    <span class="keyword">else</span> buffer.clear();</span><br><span class="line">    Thread.sleep(<span class="number">200</span>);</span><br><span class="line">    System.exit(<span class="number">0</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="指针压缩"><a href="#指针压缩" class="headerlink" title="指针压缩"></a>指针压缩</h4><h5 id="定义-1"><a href="#定义-1" class="headerlink" title="定义"></a>定义</h5><p>　64 位环境下，寄存器是 64 位的，对应指针也就成 64 位了，也就是 8 字节。我们知道 4 字节可以表示 4G，实际中基本不会有需要加载这么多对象的情况。因此 8 字节就显得浪费了，narrowKlass 只使用 4 个字节，预分配给 _metadata 的 8 字节中的另外 4 字节就可以用做它用了。看似 4 个字节无关紧要，但是堆中存在上千万到亿个对象时，省下的内存就是几百兆啊</p>
<h5 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h5><p>基于以下事实</p>
<ul>
<li>CPU 使用的虚拟地址是 64 位的，访问内存时，必须使用 64 位的指针访问内存对象</li>
<li>Java 对象是分配于具体的某个内存位置的，对其访问必须使用 64 位地址</li>
<li>对 Java 对象内的引用字段进行访问时，必须经过虚拟机这一层，操作某个对象引用不管是 getfield 还是 putfield，都是由虚拟机来执行。或者简单来说，要改变 Java 对象某个引用字段，必须经过虚拟机的参与</li>
</ul>
<p>　细心的你从上面一定可以看出一点线索，由于存一个对象引用和取一个对象引用必须经过虚拟机，所以完全可以在虚拟机这一层做些手脚。对于外部来说，putfield 提供的对象地址是 64 位的，经过虚拟机的转换，映射到 32 位，然后存入对象；getfield 指定目标对象的 64 位地址和其内部引用字段的偏移，取 32 位的数据，然后反映射到 64 位内存地址。对于外部来说，只看见 64 位的对象放进去，拿出来，内部的转换是透明的（本质上，就是按字节寻址，变成了按字寻址）</p>
<h5 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h5><h6 id="描述-1"><a href="#描述-1" class="headerlink" title="描述"></a>描述</h6><p>　CompressedOops 的原理是，解释器在解释字节码时，植入压缩指令（不影响正常和 JVM 优化后的指令顺序）<br>　具体逻辑是，当对象被读取时，解压，存入 heap 时，压缩</p>
<h6 id="压缩指令伪码"><a href="#压缩指令伪码" class="headerlink" title="压缩指令伪码"></a>压缩指令伪码</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">! int R8; oop[] R9; // R9 is 64 bits</span><br><span class="line">! oop R10 = R9[R8]; // R10 is 32 bits</span><br><span class="line">! load compressed ptr from wide base ptr:</span><br><span class="line">movl R10, [R9 + R8&lt;&lt;3 + 16]</span><br><span class="line">! klassOop R11 = R10._klass; // R11 is 32 bits</span><br><span class="line">! void* const R12 = GetHeapBase();</span><br><span class="line">! load compressed klass ptr from compressed base ptr:</span><br><span class="line">movl R11, [R12 + R10&lt;&lt;3 + 8]</span><br></pre></td></tr></tbody></table></figure>
<h5 id="零基压缩优化（Zero-Based-Compressd-Oops）"><a href="#零基压缩优化（Zero-Based-Compressd-Oops）" class="headerlink" title="零基压缩优化（Zero Based Compressd Oops）"></a>零基压缩优化（Zero Based Compressd Oops）</h5><p>　零基压缩是针对压解压动作的进一步优化。它通过改变正常指针的随机地址分配特性，强制从零开始做分配（需要 OS 支持），进一步提高了压解压效率</p>
<p>　要启用零基压缩，你分配给 JVM 的内存大小必须控制在 4G 以上，32G 以下<br>　如果小于 4G，那么 JVM 会使用低虚拟地址空间（low virutal address space，64 位下模拟 32 位），这样就不需要做压解压动作了<br>　而对于大于 32G，将采用默认的随机地址分配特性，进行压解压</p>
<h5 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h5><p>　CompressedOops，可以让跑在 64 位平台下的 JVM，不需要因为更宽的寻址，而付出 Heap 容量损失的代价。<br>　不过，它的实现方式是在机器码中植入压缩与解压指令，可能会给 JVM 增加额外的开销</p>
<h5 id="参数控制"><a href="#参数控制" class="headerlink" title="参数控制"></a>参数控制</h5><p>　<code>-XX:+UseCompressedOops</code> 开启（<code>jdk1.6.0_14+</code>）<br>　<code>-XX:-UseCompressedOops</code> 关闭</p>
<h5 id="零基压缩的边界"><a href="#零基压缩的边界" class="headerlink" title="零基压缩的边界"></a>零基压缩的边界</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ JAVA_HOME=`/usr/libexec/java_home -v 1.8` java -Xmx32766m -XX:+PrintFlagsFinal 2&gt; /dev/null | grep UseCompressedOops</span><br><span class="line">  bool UseCompressedOops   := <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">$ JAVA_HOME=`/usr/libexec/java_home -v 1.8` java -Xmx32767m -XX:+PrintFlagsFinal 2&gt; /dev/null | grep UseCompressedOops</span><br><span class="line">  bool UseCompressedOops   = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果已经 JVM 进程已经启动了，可以通过 jinfo 进行查询</span></span><br><span class="line">$ jinfo -flag UseCompressedOops 18979</span><br><span class="line">  -XX:-UseCompressedOops</span><br></pre></td></tr></tbody></table></figure>
<h5 id="压缩-class-信息中的指针"><a href="#压缩-class-信息中的指针" class="headerlink" title="压缩 class 信息中的指针"></a>压缩 class 信息中的指针</h5><p>　从 JDK6_u23 开始 UseCompressedOops 被默认打开了。因此既能享受 64bit 带来的好处，又避免了 64bit 带来的性能损耗。当然，如果你有机会使用超过 32G 的堆内存，记得把这个选项关了</p>
<p>　到了 Java8，永久代被干掉了，有了 “meta space” 的概念，存储 JVM 中的元数据，包括 Byte code，class 等信息。Java8 在 UseCompressedOops 之外，额外增加了一个新选项叫做 UseCompressedClassPointer。这个选项打开后，class 信息中的指针也用 32bit 的 Compressed 版本。而这些指针指向的空间被称作 “Compressed Class Space”。默认大小是 1G，但可以通过 “CompressedClassSpaceSize” 调整</p>
<p>　如果你的 Java 程序引用了太多的包，有可能会造成这个空间不够用，于是会看到</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">java.lang.OutOfMemoryError: Compressed <span class="class"><span class="keyword">class</span> <span class="title">space</span></span></span><br></pre></td></tr></tbody></table></figure>
<p>　这时，一般调大 CompreseedClassSpaceSize 就可以了</p>
<h3 id="常用-Collector"><a href="#常用-Collector" class="headerlink" title="常用 Collector"></a>常用 Collector</h3><h4 id="CMS"><a href="#CMS" class="headerlink" title="CMS"></a>CMS</h4><h5 id="定义-2"><a href="#定义-2" class="headerlink" title="定义"></a>定义</h5><p>　<strong>CMS</strong>，全称 <strong>C</strong>oncurrent <strong>M</strong>ark <strong>S</strong>weep，是一款并发的、使用<strong>标记-清除</strong>算法的垃圾回收器</p>
<h5 id="内存碎片"><a href="#内存碎片" class="headerlink" title="内存碎片"></a>内存碎片</h5><p>　CMS 本身是不会移动内存的，长时间运行后，会产生很多内存碎片，导致没有一段足够大的连续区域可以存放大对象，导致 <code>promotion failed</code>、<code>concurrent mode failure</code> 等异常，从而触发 Full GC</p>
<p>　启用 <code>-XX:+UseCMSCompactAtFullCollection</code> 参数之后，会在 Full GC 的时候，对年老代的内存进行压缩。再配合 <code>-XX:CMSFullGCsBeforeCompaction=0</code> 参数可以控制多少次 FGC 后对老年代做压缩操作。默认值为 0，代表每次都压缩。该参数开启后，会把对象移动到内存的最左边，可能会影响性能，但是可以消除碎片</p>
<h5 id="浮动垃圾"><a href="#浮动垃圾" class="headerlink" title="浮动垃圾"></a>浮动垃圾</h5><p>　由于 CMS 并发清理阶段用户线程还在运行着，伴随程序运行自然就还会有新的垃圾不断产生，这一部分垃圾出现在标记过程之后，CMS 无法在当次收集中处理掉它们，只好留待下一次 GC 时再清理掉。这些无法被 GC 掉，留到下一次 GC 的垃圾，称之为<strong>浮动垃圾</strong></p>
<h3 id="常用参数"><a href="#常用参数" class="headerlink" title="常用参数"></a>常用参数</h3><h4 id="默认配置"><a href="#默认配置" class="headerlink" title="默认配置"></a>默认配置</h4><h5 id="Xss-堆栈大小"><a href="#Xss-堆栈大小" class="headerlink" title="-Xss 堆栈大小"></a>-Xss 堆栈大小</h5><div class="table-container">
<table>
<thead>
<tr>
<th>Platform</th>
<th>Default（KB）</th>
</tr>
</thead>
<tbody>
<tr>
<td>Windows IA32</td>
<td>64</td>
</tr>
<tr>
<td>Linux IA32</td>
<td>128</td>
</tr>
<tr>
<td>Windows x86_64</td>
<td>128</td>
</tr>
<tr>
<td>Linux x86_64</td>
<td>256</td>
</tr>
<tr>
<td>Windows IA64</td>
<td>320</td>
</tr>
<tr>
<td>Linux IA64</td>
<td>1024</td>
</tr>
<tr>
<td>Solaris Sparc</td>
<td>512</td>
</tr>
</tbody>
</table>
</div>
<p>Tips: <a href="https://github.com/OpenTSDB/opentsdb/issues/334#issuecomment-482528576">实际案例</a> OpenTSDB 大查询导致 <code>java.long.StackOverflowError</code> 后，调整 <code>-Xss32m</code> 得以解决</p>
<h4 id="日志方面"><a href="#日志方面" class="headerlink" title="日志方面"></a>日志方面</h4><h5 id="常用的配置项"><a href="#常用的配置项" class="headerlink" title="常用的配置项"></a>常用的配置项</h5><div class="table-container">
<table>
<thead>
<tr>
<th>Flag</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>-verbose:gc</td>
<td>The <code>-verbose:gc</code> option enables logging of garbage collection (GC) information.</td>
</tr>
<tr>
<td>-XX:+PrintGCDetails -XX:+PrintGCTimeStamps</td>
<td><code>-XX:+PrintGCDetails</code> and <code>-XX:+PrintGCTimeStamps</code> are used to print detailed information about garbage collection.（这里由于 <code>-verbose:gc</code> 相当于 <code>-XX:+PrintGCDetails</code> 的别名，避免冗余，应该去掉 <code>-verbose:gc</code>）</td>
</tr>
<tr>
<td>-XX:-PrintTenuringDistribution</td>
<td>Print tenuring age information.</td>
</tr>
<tr>
<td>-XX:-UseGCLogFileRotation</td>
<td>Enabled GC log rotation, requires -Xloggc.</td>
</tr>
<tr>
<td>-XX:NumberOfGCLogFiles=3</td>
<td>Set the number of files to use when rotating logs, must be &gt;= 1. The rotated log files will use the following naming scheme, <code>&lt;filename&gt;</code>.0, <code>&lt;filename&gt;</code>.1, …, <code>&lt;filename&gt;</code>.n-1.</td>
</tr>
<tr>
<td>-XX:GCLogFileSize=8K</td>
<td>The size of the log file at which point the log will be rotated, must be &gt;= 8K.</td>
</tr>
<tr>
<td>-XX:ErrorFile=./hs_err_pid_%p.log</td>
<td>当 JVM 进程发生 Crash 的时候，会记录下相关的错误信息、信号信息、寄存器信息，以及内存分配情况等。其中 <code>%p</code> 是当前 JVM 进程的 pid 值。默认该日志会创建在当前 JVM 进程的工作目录下</td>
</tr>
</tbody>
</table>
</div>
<h5 id="实际效果"><a href="#实际效果" class="headerlink" title="实际效果"></a>实际效果</h5><h6 id="描述-2"><a href="#描述-2" class="headerlink" title="描述"></a>描述</h6><p>　以 <a href="https://yuzhouwan.com/posts/5845/">Apache Druid</a> 为例，在 Tranquility 组件启动时，加上 <code>-XX:+PrintTenuringDistribution</code> 参数后的效果如下：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ nohup ./bin/tranquility -J-XX:+HeapDumpOnOutOfMemoryError -J-XX:HeapDumpPath=/data02/druid/ -J-verbose:gc -J-XX:+PrintGCDetails -J-XX:+PrintGCDateStamps -J-XX:+PrintGCDetails -J-XX:+PrintTenuringDistribution -J-Xloggc:/data02/druid/gc.log -Ddruid.extensions.directory=/home/druid/software/druid/extensions -Ddruid.extensions.loadList=<span class="string">'["druid-avro-extensions"]'</span> kafka -configFile conf/service/hbase_metrics_kafka2_avro.json &gt; /home/druid/logs/tranquility/hbase_metrics_kafka2_avro.log 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment"># before</span></span><br><span class="line">2017-03-23T14:38:23.582+0800: 90.288: [GC (Allocation Failure) [PSYoungGen: 9934821K-&gt;5622K(10469376K)] 12602986K-&gt;7093554K(28291584K), 0.6114898 secs] [Times: user=13.74 sys=0.06, real=0.61 secs] </span><br><span class="line">2017-03-23T14:38:24.801+0800: 91.507: [GC (Allocation Failure) [PSYoungGen: 10071976K-&gt;3022K(10469376K)] 17159909K-&gt;8861529K(28291584K), 0.1748974 secs] [Times: user=3.91 sys=0.03, real=0.17 secs] </span><br><span class="line">2017-03-23T14:38:26.178+0800: 92.884: [GC (Allocation Failure) [PSYoungGen: 10303201K-&gt;3733K(10469376K)] 19161707K-&gt;9746931K(28291584K), 0.1744318 secs] [Times: user=3.89 sys=0.02, real=0.17 secs] </span><br><span class="line">2017-03-23T14:38:27.277+0800: 93.983: [GC (Allocation Failure) [PSYoungGen: 10091092K-&gt;902K(10469888K)] 19834290K-&gt;10628837K(28292096K), 0.1108355 secs] [Times: user=2.48 sys=0.01, real=0.12 secs] </span><br><span class="line">2017-03-23T14:38:28.586+0800: 95.292: [GC (Allocation Failure) [PSYoungGen: 10089131K-&gt;1078K(10472448K)] 20717066K-&gt;11513094K(28294656K), 0.1054663 secs] [Times: user=2.34 sys=0.01, real=0.11 secs] </span><br><span class="line">2017-03-23T14:38:29.840+0800: 96.546: [GC (Allocation Failure) [PSYoungGen: 10400114K-&gt;1501K(10461696K)] 21912131K-&gt;13281552K(28283904K), 0.1337201 secs] [Times: user=2.99 sys=0.01, real=0.13 secs] </span><br><span class="line">2017-03-23T14:38:30.865+0800: 97.571: [GC (Allocation Failure) [PSYoungGen: 10133038K-&gt;1099K(10472448K)] 23413089K-&gt;15049201K(28294656K), 0.1312707 secs] [Times: user=2.94 sys=0.02, real=0.13 secs] </span><br><span class="line">2017-03-23T14:38:30.996+0800: 97.702: [Full GC (Ergonomics) [PSYoungGen: 1099K-&gt;0K(10472448K)] [ParOldGen: 15048102K-&gt;1783009K(17664000K)] 15049201K-&gt;1783009K(28136448K), [Metaspace: 54341K-&gt;54341K(1095680K)], 0.3020992 secs] [Times: user=3.90 sys=0.00, real=0.31 secs]</span><br><span class="line"></span><br><span class="line"><span class="comment"># after</span></span><br><span class="line">2017-03-23T14:41:03.576+0800: 31.699: [GC (Allocation Failure) </span><br><span class="line">Desired survivor size 23592960 bytes, new threshold 1 (max 15)</span><br><span class="line">[PSYoungGen: 9975727K-&gt;6112K(10454016K)] 13540045K-&gt;6222293K(27026432K), 0.2530233 secs] [Times: user=5.67 sys=0.03, real=0.25 secs] </span><br><span class="line">2017-03-23T14:41:05.031+0800: 33.154: [GC (Allocation Failure) </span><br><span class="line">Desired survivor size 23592960 bytes, new threshold 1 (max 15)</span><br><span class="line">[PSYoungGen: 10241863K-&gt;11872K(10457088K)] 16458045K-&gt;8885401K(27029504K), 0.2811251 secs] [Times: user=6.27 sys=0.05, real=0.29 secs] </span><br><span class="line">2017-03-23T14:41:06.022+0800: 34.145: [GC (Allocation Failure) </span><br><span class="line">Desired survivor size 25165824 bytes, new threshold 1 (max 15)</span><br><span class="line">[PSYoungGen: 10378567K-&gt;15664K(10458624K)] 19252097K-&gt;10661383K(27031040K), 0.2552984 secs] [Times: user=5.70 sys=0.05, real=0.25 secs] </span><br><span class="line">2017-03-23T14:41:06.893+0800: 35.016: [GC (Allocation Failure) </span><br><span class="line">Desired survivor size 24117248 bytes, new threshold 1 (max 15)</span><br><span class="line">[PSYoungGen: 10054634K-&gt;10669K(10460160K)] 20700353K-&gt;12431545K(27032576K), 0.3152384 secs] [Times: user=6.89 sys=0.19, real=0.31 secs] </span><br><span class="line">2017-03-23T14:41:07.208+0800: 35.33</span><br><span class="line">1: [Full GC (Ergonomics) [PSYoungGen: 10669K-&gt;0K(10460160K)] [ParOldGen: 12420876K-&gt;1803376K(14484992K)] 12431545K-&gt;1803376K(24945152K), [Metaspace: 54185K-&gt;54185K(1095680K)], 0.2905749 secs] [Times: user=4.77 sys=0.00, real=0.29 secs] </span><br></pre></td></tr></tbody></table></figure>
<h4 id="内存方面"><a href="#内存方面" class="headerlink" title="内存方面"></a>内存方面</h4><h5 id="XX-AlwaysPreTouch"><a href="#XX-AlwaysPreTouch" class="headerlink" title="-XX:+AlwaysPreTouch"></a>-XX:+AlwaysPreTouch</h5><p>　<a href="https://yuzhouwan.com/posts/31915/#swappiness">Pre-touch</a> the Java heap during JVM initialization. Every page of the heap is thus demand-zeroed during initialization rather than incrementally during application execution.</p>
<h5 id="XX-UseStringDeduplication"><a href="#XX-UseStringDeduplication" class="headerlink" title="-XX:+UseStringDeduplication"></a>-XX:+UseStringDeduplication</h5><p>　在 JDK 1.7.0_6 版本之后，每个 String 对象内部都持有一个私有 <code>char[]</code> 数组。因为该数组没有暴露出来，所以 JVM 可以先判断两个 String 的内容是否一致，再将 <code>char[]</code> 替换成另一个字符串的 <code>char[]</code>。该特性在 <a href="https://openjdk.java.net/jeps/192">JDK 1.8.0_20</a> 版本中引入，但只有在 JVM 使用了 G1GC 的情况下，才可以开启。相关的还有两个参数，其一是 <code>-XX:StringDeduplicationAgeThreshold</code>（默认值：3，即多次 GC 后仍然存活的 String 对象），用来避免作用于生命周期短的字符串；其二是  <code>+PrintStringDeduplicationStatistics</code>，用来打印一些统计信息，以判断特性是否生效。最后，需要注意的是，该特性的执行是发生在 GC 过程中的，如果 String 去重率不高的话，有可能会得不偿失，反而导致 GC 时间变长</p>
<h4 id="启动方面"><a href="#启动方面" class="headerlink" title="启动方面"></a>启动方面</h4><h5 id="ea"><a href="#ea" class="headerlink" title="-ea"></a>-ea</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Usage:</span></span><br><span class="line">  -enableassertions[:&lt;packageName&gt;<span class="string">"..."</span> | :&lt;className&gt;]</span><br><span class="line">  -ea[:&lt;packageName&gt;<span class="string">"..."</span> | :&lt;className&gt;]</span><br><span class="line"></span><br><span class="line">  该参数用来设置 jvm 是否启动断言机制（从 JDK 1.4 开始支持），默认 JVM 是关闭断言机制的，增加 `-ea` 参数可打开断言机制</span><br><span class="line">  不指定 packageName 和 className 时运行所有包和类中的断言</span><br><span class="line">  如果希望只运行某些包或类中的断言，可将包名或类名加到 `-ea` 之后</span><br><span class="line">  比如想要启动包 `com.yuzhouwan.common` 下的断言机制，可用命令 `java -ea:com.yuzhouwan.common...&lt;Main Class&gt;`</span><br></pre></td></tr></tbody></table></figure>
<h3 id="实战技巧"><a href="#实战技巧" class="headerlink" title="实战技巧"></a>实战技巧</h3><h4 id="查看-JVM-参数的默认值"><a href="#查看-JVM-参数的默认值" class="headerlink" title="查看 JVM 参数的默认值"></a>查看 JVM 参数的默认值</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 查看 JDK8 中是否默认打开了 “对象头压缩” 开关</span></span><br><span class="line"><span class="comment"># 实际上，JDK6u23 版本之后，Hotspot 都已经打开了 -XX:+UseCompressedOops 功能（OOP，Ordinary Object Pointer）</span></span><br><span class="line">$ java -XX:+PrintFlagsFinal -version | grep UseCompressedOops</span><br><span class="line">       bool UseCompressedOops                        := <span class="literal">true</span></span><br><span class="line">            {lp64_product}</span><br><span class="line">  java version <span class="string">"1.8.0_111"</span></span><br><span class="line">  Java(TM) SE Runtime Environment (build 1.8.0_111-b14)</span><br><span class="line">  Java HotSpot(TM) 64-Bit Server VM (build 25.111-b14, mixed mode)</span><br></pre></td></tr></tbody></table></figure>
<h4 id="查看-Java-进程的-JVM-参数"><a href="#查看-Java-进程的-JVM-参数" class="headerlink" title="查看 Java 进程的 JVM 参数"></a>查看 Java 进程的 JVM 参数</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ jcmd 666 VM.flags</span><br><span class="line">  666:</span><br><span class="line">  -XX:CICompilerCount=15 -XX:ConcGCThreads=6 -XX:G1HeapRegionSize=33554432 -XX:InitialHeapSize=197904039936 -XX:MarkStackSize=4194304 -XX:MaxGCPauseMillis=200 -XX:MaxHeapSize=197904039936 -XX:MaxNewSize=118715580416 -XX:MinHeapDeltaBytes=33554432 -XX:+PrintGC -XX:+PrintGCDateStamps -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+UseFastUnorderedTimeStamps -XX:+UseG1GC</span><br></pre></td></tr></tbody></table></figure>
<h4 id="堆内内存分析"><a href="#堆内内存分析" class="headerlink" title="堆内内存分析"></a>堆内内存分析</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ jmap -histo:live &lt;pid&gt; | less</span><br></pre></td></tr></tbody></table></figure>
<h4 id="堆外内存分析"><a href="#堆外内存分析" class="headerlink" title="堆外内存分析"></a>堆外内存分析</h4><h5 id="google-perftools"><a href="#google-perftools" class="headerlink" title="google-perftools"></a>google-perftools</h5><h6 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 先安装 g++</span></span><br><span class="line">$ yum -y install gcc gcc-c++</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 libunwind</span></span><br><span class="line">$ wget http://download.savannah.gnu.org/releases/libunwind/libunwind-0.99.tar.gz</span><br><span class="line">$ tar -xzvf libunwind-0.99.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> libunwind-0.99</span><br><span class="line">$ ./configure --prefix=/data0/java/deploy/google-perftools/<span class="built_in">local</span>/libunwind</span><br><span class="line">$ make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 gperftools</span></span><br><span class="line">$ wget https://github.com/gperftools/gperftools/releases/download/gperftools-2.5/gperftools-2.5.tar.gz</span><br><span class="line">$ tar -xzvf gperftools-2.5.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> gperftools-2.5</span><br><span class="line">$ ./configure --prefix=/data0/java/deploy/google-perftools/<span class="built_in">local</span>/gperftools-2.5/</span><br><span class="line">$ make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使配置生效</span></span><br><span class="line">$ vim /etc/ld.so.conf.d/usr_local_lib.conf</span><br><span class="line">  /data0/java/deploy/google-perftools/<span class="built_in">local</span>/libunwind/lib</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行 ldconfig 命令，使libunwind生效。 需要 sudo 权限</span></span><br><span class="line">$ /sbin/ldconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 tmp 目录</span></span><br><span class="line">$ mkdir -p /data0/java/deploy/google-perftools/<span class="built_in">local</span>/tmp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加入环境变量</span></span><br><span class="line"><span class="comment"># 不要加在 .bashrc 里面，放在 jvm 启动脚本里面即可</span></span><br><span class="line">  <span class="built_in">export</span> LD_PRELOAD=/data0/java/deploy/google-perftools/<span class="built_in">local</span>/gperftools-2.5/lib/libtcmalloc.so</span><br><span class="line">  <span class="built_in">export</span> HEAPPROFILE=/data0/java/deploy/google-perftools/<span class="built_in">local</span>/tmp/gzip</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 jvm 进程，就会在 /data0/java/deploy/google-perftools/local/ 目录下生成 heap 文件</span></span><br><span class="line">$ bin/hitsdb restart</span><br></pre></td></tr></tbody></table></figure>
<h6 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 分析函数调用</span></span><br><span class="line">$ /data0/java/deploy/google-perftools/<span class="built_in">local</span>/gperftools-2.5/bin/pprof --text /usr/<span class="built_in">local</span>/jdk1.8.0_181/bin/java /data0/java/deploy/google-perftools/<span class="built_in">local</span>/tmp/gzip.0001.heap</span><br><span class="line"></span><br><span class="line">  Using <span class="built_in">local</span> file /usr/<span class="built_in">local</span>/jdk1.8.0_181/bin/java.</span><br><span class="line">  Using <span class="built_in">local</span> file /data0/java/deploy/google-perftools/<span class="built_in">local</span>/tmp/gzip.0001.heap.</span><br><span class="line">  Total: 0.0 MB</span><br><span class="line">       0.0  87.9%  87.9%      0.0 100.0% __FRAME_END__</span><br><span class="line">       0.0   9.6%  97.5%      0.0   9.6% _nl_intern_locale_data</span><br><span class="line">       0.0   1.2%  98.7%      0.0   1.2% __gconv_lookup_cache</span><br><span class="line">       0.0   0.6%  99.3%      0.0   0.6% new_composite_name</span><br><span class="line">       0.0   0.3%  99.6%      0.0  10.0% _nl_load_locale_from_archive</span><br><span class="line">       0.0   0.2%  99.8%      0.0   0.2% __GI___strdup</span><br><span class="line">       0.0   0.1%  99.9%      0.0   1.3% __wcsmbs_load_conv</span><br><span class="line">       0.0   0.1% 100.0%      0.0   0.1% __bindtextdomain</span><br><span class="line">       0.0   0.0% 100.0%      0.0  10.7% __GI_setlocale</span><br><span class="line">       0.0   0.0% 100.0%      0.0   1.3% __btowc</span><br><span class="line">       0.0   0.0% 100.0%      0.0   1.2% __gconv_find_transform</span><br><span class="line">       0.0   0.0% 100.0%      0.0 100.0% __libc_start_main</span><br><span class="line">       0.0   0.0% 100.0%      0.0   0.0% __textdomain</span><br><span class="line">       0.0   0.0% 100.0%      0.0  10.0% _nl_find_locale</span><br></pre></td></tr></tbody></table></figure>
<h2 id="常用工具"><a href="#常用工具" class="headerlink" title="常用工具"></a>常用工具</h2><h3 id="JMC-监控报警工具（Java-Mission-Control）"><a href="#JMC-监控报警工具（Java-Mission-Control）" class="headerlink" title="JMC 监控报警工具（Java Mission Control）"></a>JMC 监控报警工具（Java Mission Control）</h3><p>　JMC 工具是 JDK 里面自带的，只需要运行 <code>jmc</code> 命令即可</p>
<p><img data-src="/picture/java/java_jvm_jmc_java_mission_control.png" alt=""></p>
<center>（对 <a href="https://www.oracle.com/technetwork/java/javaseproducts/mission-control/index.html" target="_blank">JMC</a>™ 的截图）</center>


<h3 id="GCViewer"><a href="#GCViewer" class="headerlink" title="GCViewer"></a>GCViewer</h3><h4 id="安装-2"><a href="#安装-2" class="headerlink" title="安装"></a>安装</h4><p>　在 GCViewer 的<a href="https://github.com/chewiebug/GCViewer/releases">下载页面</a>，找到当前最新版本 <a href="http://sourceforge.net/projects/gcviewer/files/gcviewer-1.35.jar/download">gcviewer-1.35.jar</a> 进行下载</p>
<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 文件 gc.log 是由增加了 `-verbose:gc -XX:+PrintGCDetails -XX:+PrintGCDateStamps -Xloggc:/home/yuzhouwan/gc.log` 参数的 JVM 进程生成的 GC 日志</span></span><br><span class="line">$ java -jar gcviewer-1.35.jar gc.log</span><br></pre></td></tr></tbody></table></figure>
<h4 id="效果图"><a href="#效果图" class="headerlink" title="效果图"></a>效果图</h4><p><img data-src="/picture/java/java_jvm_gcviewer_throughput_100_percent.png" alt="JVM GCViewer"></p>
<center>（对 <a href="https://github.com/chewiebug/GCViewer" target="_blank">GCViewer</a>™ 的截图）</center>



<h3 id="MAT-内存分析工具（Memory-Analyzer-Tool）"><a href="#MAT-内存分析工具（Memory-Analyzer-Tool）" class="headerlink" title="MAT 内存分析工具（Memory Analyzer Tool）"></a><a href="https://www.eclipse.org/mat/">MAT</a> 内存分析工具（Memory Analyzer Tool）</h3><h4 id="创建-dump-文件"><a href="#创建-dump-文件" class="headerlink" title="创建 dump 文件"></a>创建 dump 文件</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 如果指定 live 参数的话，将会在 dump 之前，强制进行一次 Full GC</span></span><br><span class="line">$ jmap -dump:[live,]format=b,file=&lt;file_name&gt;.hprof &lt;pid&gt;</span><br></pre></td></tr></tbody></table></figure>
<div class="note info">如果 hprof 文件过大，打开时可能会有 OOM 的报错，此时则需要修改 /Applications/mat.app/Contents/Eclipse/MemoryAnalyzer.ini 文件中的 -Xmx1024m 默认参数为 -Xmx4096m，并重启 MAT</div>
<div class="note info">通过 Window - Preferences - Memory Analyzer - Bytes Display 选项卡，可以设置字节占用的展示单位为 GB，默认为 Bytes</div>



<h3 id="火焰图"><a href="#火焰图" class="headerlink" title="火焰图"></a>火焰图</h3><h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>　火焰图是一个二维图片，火焰图的 <strong>X</strong> 轴代表<strong>采样总量</strong>，而 <strong>Y</strong> 轴代表<strong>栈深度</strong>。每个框就代表了一个栈里的函数，其宽度代表了所占用的 <strong>CPU 总时间</strong>。因此，比较宽的框就表示，该函数运行时间较慢或被调用次数较多，从而占用的 CPU 时间多</p>
<h4 id="以往获得火焰图所需要的复杂步骤"><a href="#以往获得火焰图所需要的复杂步骤" class="headerlink" title="以往获得火焰图所需要的复杂步骤"></a>以往获得火焰图所需要的复杂步骤</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line">$ yum install perf -y</span><br><span class="line">$ yum install gcc -y</span><br><span class="line">$ yum install gcc-c++</span><br><span class="line">$ yum install cmake -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 perf</span></span><br><span class="line">$ git <span class="built_in">clone</span> --depth=1 https://github.com/jrudolph/perf-map-agent</span><br><span class="line">$ <span class="built_in">cd</span> perf-map-agent</span><br><span class="line">$ cmake .</span><br><span class="line">$ make</span><br><span class="line">$ bin/create-links-in /usr/bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 FlameGraph</span></span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/brendangregg/FlameGraph.git</span><br><span class="line">$ <span class="built_in">export</span> FLAMEGRAPH_DIR=/root/git/FlameGraph</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动程序时，增加 JVM 参数 -XX:+PreserveFramePointer</span></span><br><span class="line">$ perf-java-flames &lt;pid&gt;</span><br></pre></td></tr></tbody></table></figure>
<h4 id="使用新版-JVM-Profile-功能之后一键搞定"><a href="#使用新版-JVM-Profile-功能之后一键搞定" class="headerlink" title="使用新版 JVM Profile 功能之后一键搞定"></a>使用新版 JVM Profile 功能之后一键搞定</h4><div class="note success">这里我们以 2018.3 版本为例，但只要是高于该版本的 IDEA 也都是默认支持的</div>


<p>　打开下载 Intellij Idea 下载页面，找到 <a href="https://www.jetbrains.com/idea/nextversion/">Coming in 2018.3</a>，然后下载 EAP 版本的 Intellij Idea</p>
<p><img data-src="/picture/java/java_intellij_2018_3_coming_in.png" alt=""></p>
<p>　打开项目后，使用快捷键 <code>⌘⌥⇧/</code> 打开 <code>Maintenance</code> 面板，选择 <code>Experimantal features</code>，勾选 <code>linux.native.menu</code> 和 <code>idea.profiler.enabled</code></p>
<p><img data-src="/picture/java/java_idea_profiler_enabled.png" alt=""></p>
<p>　使用 <code>Run xxx with Async Profiler</code> 执行任意程序</p>
<p><img data-src="/picture/java/java_run_with_async_profiler.png" alt=""></p>
<p>　即可获得火焰图、方法调用链、方法列表</p>
<p><img data-src="/picture/java/java_jvm_profiler.png" alt=""></p>
<center>（对 <a href="https://www.jetbrains.com/idea/" target="_blank">Intellij IDEA</a>™ 的截图）</center>

<p><strong>火焰图</strong>，主要用于分析 CPU 性能消耗。可以交互式地分析 JVM 进程中所有线程的 CPU 消耗火焰图，也可以选择某一个线程来分析；<br><strong>方法调用链</strong>，可以找到在某个线程中，消耗 CPU 最多的方法<br><strong>方法列表</strong>，可以看到每个方法的调用次数，展开后还可以看到详细的调用栈</p>
<h3 id="序列化-ID-排查工具"><a href="#序列化-ID-排查工具" class="headerlink" title="序列化 ID 排查工具"></a>序列化 ID 排查工具</h3><h4 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">serialver [ options ] [ classnames ]</span><br><span class="line"></span><br><span class="line">  options</span><br><span class="line">    The <span class="built_in">command</span>-line options. See Options.</span><br><span class="line"></span><br><span class="line">  classnames</span><br><span class="line">    The classes <span class="keyword">for</span> <span class="built_in">which</span> the serialVersionUID is to be returned.</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Arthas-诊断工具"><a href="#Arthas-诊断工具" class="headerlink" title="Arthas 诊断工具"></a>Arthas 诊断工具</h3><h4 id="介绍-2"><a href="#介绍-2" class="headerlink" title="介绍"></a>介绍</h4><p><img data-src="/picture/java/java_arthas_logo.png" alt=""></p>
<center>（图片来源：<a href="https://github.com/alibaba/arthas/issues/371#issuecomment-457469188" target="_blank">Arthas</a>™ 官网，已获得 Collaborator 的授权）</center>

<p>　如果你想要对线上运行的 JVM 进程进行逻辑或性能分析，但是此时如果进程本身重启很耗时，或者进程内存很大无法进行 Dump 操作，亦或是不想有任何的代码侵入，就统计出各个方法的调用次数和耗时，那么，Arthas 绝对是不二之选</p>
<h4 id="使用-2"><a href="#使用-2" class="headerlink" title="使用"></a><a href="https://arthas.aliyun.com/doc/quick-start.html">使用</a></h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ curl -O https://arthas.aliyun.com/arthas-boot.jar</span><br><span class="line">$ java -jar arthas-boot.jar</span><br></pre></td></tr></tbody></table></figure>
<h3 id="tsar-资源监控工具"><a href="#tsar-资源监控工具" class="headerlink" title="tsar 资源监控工具"></a><a href="https://github.com/alibaba/tsar">tsar</a> 资源监控工具</h3><h4 id="安装-3"><a href="#安装-3" class="headerlink" title="安装"></a>安装</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ wget -O tsar.zip https://github.com/alibaba/tsar/archive/master.zip --no-check-certificate</span><br><span class="line">$ unzip tsar.zip</span><br><span class="line">$ <span class="built_in">cd</span> tsar-master</span><br><span class="line">$ make</span><br><span class="line">$ make install</span><br></pre></td></tr></tbody></table></figure>
<h4 id="使用-3"><a href="#使用-3" class="headerlink" title="使用"></a>使用</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ tsar -l -i 1</span><br></pre></td></tr></tbody></table></figure>
<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h3 id="编码相关"><a href="#编码相关" class="headerlink" title="编码相关"></a>编码相关</h3><h4 id="SimpleDateFormat-多线程安全问题"><a href="#SimpleDateFormat-多线程安全问题" class="headerlink" title="SimpleDateFormat 多线程安全问题"></a>SimpleDateFormat 多线程安全问题</h4><p>　不安全的主要原因是，SimpleDateFormat 继承的 DateTime 类，本身就是不安全的。而根本原因是 DateTime 的类属性中 <code>Calendar</code> 实例，并没有使用同步代码块进行多线程安全处理。如果在执行 <code>format(...)</code> 方法的同时，有其他线程调用 <code>setCalendar(Calendar newCalendar)</code> 方法，则会出现混乱。处理的方法有很多，除了在每次需要使用重新初始化 SimpleDateFormat 实例，另外还可使用 ThreadLocal 对其进行缓存，再或者使用 Joda-time 替换 Jdk 原生的 SimpleDateFormat 和 Java 8 里面的 DateTimeFormatter（注意别触发 <a href="https://bugs.java.com/view_bug.do?bug_id=JDK-8031085">JDK-8031085</a>，该问题在 JDK9 才修复），亦可</p>
<p>Tips: Full code is <a href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-hacker/src/test/java/com/yuzhouwan/hacker/joda/JodaTimeHaveATry.java">here</a> and <a href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-common/src/main/java/com/yuzhouwan/common/util/TimeUtils.java#L99">here</a>.</p>
<h4 id="java-lang-IllegalThreadStateException"><a href="#java-lang-IllegalThreadStateException" class="headerlink" title="java.lang.IllegalThreadStateException"></a>java.lang.IllegalThreadStateException</h4><p>　报错是因为 <code>Thread</code> 不可以使用 <code>start()</code> 启动多次，可以将逻辑放在 <code>Runnable</code> 对象中，每次启动的时候，再通过  <code>new Thread(runnable).start()</code> 初始化一个 <code>Thread</code> 对象来启动即可</p>
<h4 id="java-util-ConcurrentModificationException"><a href="#java-util-ConcurrentModificationException" class="headerlink" title="java.util.ConcurrentModificationException"></a><a href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-hacker/src/test/java/com/yuzhouwan/hacker/algorithms/collection/FastFailTest.java">java.util.ConcurrentModificationException</a></h4><p>　对集合遍历的时候，同时执行了 remove 元素的操作，就会出现该问题。除了“通过一个临时集合保存需要删除的元素，在遍历结束后，执行 removeAll 进行清理”这种方案外，还可以通过 Iterator 直接进行 remove。后者虽然可以节省了新集合的内存消耗，但是却不能使用增强 for 循环的特性。具体如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">Iterator&lt;String&gt; iterator = parameters.keySet().iterator();</span><br><span class="line">String key;</span><br><span class="line"><span class="keyword">while</span> (iterator.hasNext()) {</span><br><span class="line">    key = iterator.next();</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">"c"</span>.equals(key)) {</span><br><span class="line">        parameters.remove(key);</span><br><span class="line">    }</span><br><span class="line">    assertEquals(<span class="number">1</span>, parameters.size());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="取消数值的科学计数法"><a href="#取消数值的科学计数法" class="headerlink" title="取消数值的科学计数法"></a>取消数值的科学计数法</h4><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 数值过大后，double、long 的 toString 可能会出现科学计数法</span></span><br><span class="line"><span class="comment">// 可以通过 NumberFormat 来解决</span></span><br><span class="line">NumberFormat nf = NumberFormat.getInstance();</span><br><span class="line">nf.setGroupingUsed(<span class="keyword">false</span>);</span><br><span class="line">nf.setMaximumFractionDigits(<span class="number">0</span>);</span><br><span class="line">nf.setMaximumIntegerDigits(<span class="number">64</span>);</span><br><span class="line"></span><br><span class="line">assertEquals(<span class="string">"1234567890123456789"</span>, nf.format(<span class="number">1234567890123456789L</span>));</span><br><span class="line">assertEquals(<span class="number">1234567890123456789L</span>, Long.valueOf(nf.format(<span class="number">1234567890123456789L</span>)).longValue());</span><br><span class="line"><span class="comment">// 或者转换 double 的字符串为 long</span></span><br><span class="line">assertEquals(<span class="number">0L</span>, Long.valueOf(nf.format(<span class="number">0.0</span>)).longValue());</span><br><span class="line"></span><br><span class="line">nf.setMaximumFractionDigits(<span class="number">64</span>);</span><br><span class="line">assertEquals(<span class="string">"0.12345678901234568"</span>, nf.format(<span class="number">0.1234567890_12345678D</span>));</span><br><span class="line">assertEquals(<span class="number">0.12345678901234568D</span>, Double.valueOf(nf.format(<span class="number">0.1234567890_12345678D</span>)), <span class="number">64</span>);</span><br></pre></td></tr></tbody></table></figure>
<h4 id="File-toURL-过期"><a href="#File-toURL-过期" class="headerlink" title="File#toURL 过期"></a>File#toURL 过期</h4><p>　使用 <code>file.toURI().toURL()</code> 替代</p>
<h4 id="Jersey-的-Produces-默认不设置-UTF-8-存在中文乱码"><a href="#Jersey-的-Produces-默认不设置-UTF-8-存在中文乱码" class="headerlink" title="Jersey 的 @Produces 默认不设置 UTF-8 存在中文乱码"></a>Jersey 的 @Produces 默认不设置 UTF-8 存在中文乱码</h4><h5 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h5><p>　实现 ContainerResponseFilter 接口，给 <code>@Produces</code> 注解增加 <code>charset=UTF-8</code> 属性</p>
<h5 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h5><h6 id="编码-MediaTypeFilter"><a href="#编码-MediaTypeFilter" class="headerlink" title="编码 MediaTypeFilter"></a>编码 MediaTypeFilter</h6><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.jersey.core.util.Priority;</span><br><span class="line"><span class="keyword">import</span> com.sun.jersey.spi.container.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.ws.rs.Priorities;</span><br><span class="line"><span class="keyword">import</span> javax.ws.rs.Produces;</span><br><span class="line"><span class="keyword">import</span> javax.ws.rs.core.MediaType;</span><br><span class="line"><span class="keyword">import</span> javax.ws.rs.ext.Provider;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Annotation;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Provider</span></span><br><span class="line"><span class="meta">@Priority(Priorities.HEADER_DECORATOR)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MediaTypeFilter</span> <span class="keyword">implements</span> <span class="title">ResourceFilter</span>, <span class="title">ContainerResponseFilter</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ContainerResponse <span class="title">filter</span><span class="params">(ContainerRequest request, ContainerResponse response)</span> </span>{</span><br><span class="line">        Annotation[] annotations = response.getAnnotations();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; annotations.length; i++) {</span><br><span class="line">            <span class="keyword">if</span> (!(annotations[i] <span class="keyword">instanceof</span> Produces)) {</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            }</span><br><span class="line">            Produces produces = (Produces) annotations[i];</span><br><span class="line">            String[] producesValues = produces.value();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; producesValues.length; j++) {</span><br><span class="line">                <span class="keyword">if</span> (!MediaType.APPLICATION_JSON.equals(producesValues[j]) &amp;&amp; !MediaType.TEXT_PLAIN.equals(producesValues[j])) {</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                }</span><br><span class="line">                producesValues[j] += <span class="string">";charset=UTF-8"</span>;</span><br><span class="line">            }</span><br><span class="line">            annotations[i] = produces;</span><br><span class="line">        }</span><br><span class="line">        response.setAnnotations(annotations);</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ContainerRequestFilter <span class="title">getRequestFilter</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ContainerResponseFilter <span class="title">getResponseFilter</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h6 id="在-BrokerResource-中使用"><a href="#在-BrokerResource-中使用" class="headerlink" title="在 BrokerResource 中使用"></a>在 BrokerResource 中使用</h6><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.google.common.collect.ImmutableMap;</span><br><span class="line"><span class="keyword">import</span> com.google.inject.Inject;</span><br><span class="line"><span class="keyword">import</span> com.sun.jersey.spi.container.ResourceFilters;</span><br><span class="line"><span class="keyword">import</span> org.apache.druid.client.BrokerServerView;</span><br><span class="line"><span class="keyword">import</span> org.apache.druid.server.http.security.StateResourceFilter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.ws.rs.GET;</span><br><span class="line"><span class="keyword">import</span> javax.ws.rs.Path;</span><br><span class="line"><span class="keyword">import</span> javax.ws.rs.Produces;</span><br><span class="line"><span class="keyword">import</span> javax.ws.rs.core.MediaType;</span><br><span class="line"><span class="keyword">import</span> javax.ws.rs.core.Response;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Path("/druid/broker/v1")</span></span><br><span class="line"><span class="meta">@ResourceFilters({StateResourceFilter.class, MediaTypeFilter.class})</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrokerResource</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> BrokerServerView brokerServerView;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Inject</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">BrokerResource</span><span class="params">(BrokerServerView brokerServerView)</span></span></span><br><span class="line"><span class="function">  </span>{</span><br><span class="line">    <span class="keyword">this</span>.brokerServerView = brokerServerView;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="meta">@GET</span></span><br><span class="line">  <span class="meta">@Path("/loadstatus")</span></span><br><span class="line">  <span class="meta">@Produces(MediaType.APPLICATION_JSON)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Response <span class="title">getLoadStatus</span><span class="params">()</span></span></span><br><span class="line"><span class="function">  </span>{</span><br><span class="line">    <span class="keyword">return</span> Response.ok(ImmutableMap.of(<span class="string">"inventoryInitialized"</span>, brokerServerView.isInitialized())).build();</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="FastJSON-默认将浮点型反序列化为-BigDecimal"><a href="#FastJSON-默认将浮点型反序列化为-BigDecimal" class="headerlink" title="FastJSON 默认将浮点型反序列化为 BigDecimal"></a>FastJSON 默认将浮点型反序列化为 BigDecimal</h4><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 全局</span></span><br><span class="line">JSON.DEFAULT_PARSER_FEATURE &amp;= ~Feature.UseBigDecimal.getMask();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 局部</span></span><br><span class="line"><span class="keyword">int</span> disable = JSON.DEFAULT_PARSER_FEATURE &amp; ~Feature.UseBigDecimal.getMask();</span><br><span class="line">JSON.parseObject(json, clazz, disable);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当然也可以通过 JSON.DEFAULT_PARSER_FEATURE |= Feature.UseBigDecimal.getMask() 重新打开该特性</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="IDE-相关"><a href="#IDE-相关" class="headerlink" title="IDE 相关"></a>IDE 相关</h3><h4 id="Intellij-Idea-Code-Check-中设置行长度为-120，却仍然有一条虚线竖在-80"><a href="#Intellij-Idea-Code-Check-中设置行长度为-120，却仍然有一条虚线竖在-80" class="headerlink" title="[Intellij Idea] Code Check 中设置行长度为 120，却仍然有一条虚线竖在 80"></a>[Intellij Idea] Code Check 中设置行长度为 120，却仍然有一条虚线竖在 80</h4><p>　依次选择菜单 <code>Settings</code> - <code>Editor</code> - <code>Code Style</code> - <code>Java</code>，这时候可以将默认的 <code>Scheme</code> 设置成想要的方案，也可以在 <code>Wrapping  and Braces</code> 中修改 <code>Hard wrap at</code> 为 <code>120</code>，以达到想要的效果</p>
<h3 id="版本相关"><a href="#版本相关" class="headerlink" title="版本相关"></a>版本相关</h3><h4 id="Unsupported-major-minor-version-52-0"><a href="#Unsupported-major-minor-version-52-0" class="headerlink" title="Unsupported major.minor version 52.0"></a>Unsupported major.minor version 52.0</h4><p>　此类报错，是因为用低版本 JDK 去运行高版本的 Java 程序了</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>JDK 版本</th>
<th>Major Version Number</th>
</tr>
</thead>
<tbody>
<tr>
<td>Java SE 11</td>
<td>55</td>
</tr>
<tr>
<td>Java SE 10</td>
<td>54</td>
</tr>
<tr>
<td>Java SE 9</td>
<td>53</td>
</tr>
<tr>
<td>Java SE 8</td>
<td>52</td>
</tr>
<tr>
<td>Java SE 7</td>
<td>51</td>
</tr>
<tr>
<td>Java SE 6.0</td>
<td>50</td>
</tr>
<tr>
<td>Java SE 5.0</td>
<td>49</td>
</tr>
<tr>
<td>JDK 1.4</td>
<td>48</td>
</tr>
<tr>
<td>JDK 1.3</td>
<td>47</td>
</tr>
<tr>
<td>JDK 1.2</td>
<td>46</td>
</tr>
<tr>
<td>JDK 1.1</td>
<td>45</td>
</tr>
</tbody>
</table>
</div>
<h3 id="Maven-相关"><a href="#Maven-相关" class="headerlink" title="Maven 相关"></a>Maven 相关</h3><h4 id="需要正确地在-Maven-的-checkstyle-插件的-Regexp-正则中使用-XML-关键字"><a href="#需要正确地在-Maven-的-checkstyle-插件的-Regexp-正则中使用-XML-关键字" class="headerlink" title="需要正确地在 Maven 的 checkstyle 插件的 Regexp 正则中使用 XML 关键字"></a>需要正确地在 Maven 的 checkstyle 插件的 Regexp 正则中使用 XML 关键字</h4><p>　如果不对下面 5 个符号加 <code>\</code> 反斜杠转义的话，就需要使用 HTML 来表示</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>原始符号</th>
<th>含义</th>
<th>HTML</th>
</tr>
</thead>
<tbody>
<tr>
<td>$\lt$</td>
<td>小于</td>
<td><code>&amp;lt;</code></td>
</tr>
<tr>
<td>$\gt$</td>
<td>大于</td>
<td><code>&amp;gt;</code></td>
</tr>
<tr>
<td>&amp;</td>
<td>和</td>
<td><code>&amp;amp;</code></td>
</tr>
<tr>
<td>‘</td>
<td>单引号</td>
<td><code>&amp;apos;</code></td>
</tr>
<tr>
<td>“</td>
<td>双引号</td>
<td><code>&amp;quot;</code></td>
</tr>
</tbody>
</table>
</div>
<h3 id="LogBack-相关"><a href="#LogBack-相关" class="headerlink" title="LogBack 相关"></a>LogBack 相关</h3><h4 id="日志文件过大"><a href="#日志文件过大" class="headerlink" title="日志文件过大"></a>日志文件过大</h4><h5 id="描述-3"><a href="#描述-3" class="headerlink" title="描述"></a>描述</h5><p>　多个 JVM 进程将日志写入同一个日志文件中，导致按照文件大小切割的策略失效，<code>xxx.log.1</code> 会持续写下去，以至于磁盘被撑爆</p>
<h5 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h5><p>　在日志路径上增加 <code>${JVM_PREFIX}</code> 变量，并在不同的 JVM 启动的时候，通过 <code>-DJVM_PREFIX="process001"</code> 的方式传入，使得不同的 JVM 进程将日志写入各自的日志文件中</p>
<h3 id="配置相关"><a href="#配置相关" class="headerlink" title="配置相关"></a>配置相关</h3><h4 id="ConfigFactory-load-只能加载固定目录下的配置文件"><a href="#ConfigFactory-load-只能加载固定目录下的配置文件" class="headerlink" title="ConfigFactory.load() 只能加载固定目录下的配置文件"></a>ConfigFactory.load() 只能加载固定目录下的配置文件</h4><p>　对于 Java 开发而言，要实现加载配置文件的功能，一般都会选用 typesafe 下 <a href="https://github.com/lightbend/config">config</a> 框架，它具备纯 Java 源码和无任何外部依赖的优点。而调用 <code>ConfigFactory.load()</code> 方法只能加载 <code>src/main/resources</code> 下配置文件的问题。针对该问题，只需调用 <code>ConfigFactory.parseFile(new File("yuzhouwan.conf"))</code> 方法，即可指定其他任意位置的配置文件</p>
<h3 id="JVM-相关-1"><a href="#JVM-相关-1" class="headerlink" title="JVM 相关"></a>JVM 相关</h3><h4 id="Too-small-initial-heap"><a href="#Too-small-initial-heap" class="headerlink" title="Too small initial heap"></a>Too small initial heap</h4><p>　<code>-Xmx1024 -Xms512</code> 应改为 <code>-Xmx1024M -Xms512M</code></p>
<h4 id="定位-OOM"><a href="#定位-OOM" class="headerlink" title="定位 OOM"></a>定位 OOM</h4><p>　<code>-XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=xxx</code></p>
<h4 id="堆外内存使用不当，导致-OOM-问题"><a href="#堆外内存使用不当，导致-OOM-问题" class="headerlink" title="堆外内存使用不当，导致 OOM 问题"></a>堆外内存使用不当，导致 OOM 问题</h4><h5 id="描述-4"><a href="#描述-4" class="headerlink" title="描述"></a>描述</h5><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">java.lang.OutOfMemoryError: Direct buffer memory</span><br><span class="line">  at java.nio.Bits.reserveMemory(Bits.java:<span class="number">658</span>)</span><br><span class="line">  at java.nio.DirectByteBuffer.&lt;init&gt;(DirectByteBuffer.java:<span class="number">123</span>)</span><br><span class="line">  at java.nio.ByteBuffer.allocateDirect(ByteBuffer.java:<span class="number">311</span>)</span><br><span class="line">  at org.jboss.netty.channel.socket.nio.SocketReceiveBufferAllocator.newBuffer(SocketReceiveBufferAllocator.java:<span class="number">64</span>)</span><br><span class="line">  at org.jboss.netty.channel.socket.nio.SocketReceiveBufferAllocator.get(SocketReceiveBufferAllocator.java:<span class="number">41</span>)</span><br><span class="line">  at org.jboss.netty.channel.socket.nio.NioWorker.read(NioWorker.java:<span class="number">62</span>)</span><br><span class="line">  at org.jboss.netty.channel.socket.nio.AbstractNioWorker.process(AbstractNioWorker.java:<span class="number">108</span>)</span><br><span class="line">  at org.jboss.netty.channel.socket.nio.AbstractNioSelector.run(AbstractNioSelector.java:<span class="number">337</span>)</span><br><span class="line">  at org.jboss.netty.channel.socket.nio.AbstractNioWorker.run(AbstractNioWorker.java:<span class="number">89</span>)</span><br><span class="line">  at org.jboss.netty.channel.socket.nio.NioWorker.run(NioWorker.java:<span class="number">178</span>)</span><br><span class="line">  at org.jboss.netty.util.ThreadRenamingRunnable.run(ThreadRenamingRunnable.java:<span class="number">108</span>)</span><br><span class="line">  at org.jboss.netty.util.internal.DeadLockProofWorker$<span class="number">1.</span>run(DeadLockProofWorker.java:<span class="number">42</span>)</span><br><span class="line">  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1142</span>)</span><br><span class="line">  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">617</span>)</span><br><span class="line">  at java.lang.Thread.run(Thread.java:<span class="number">745</span>)</span><br></pre></td></tr></tbody></table></figure>
<h5 id="解决-1"><a href="#解决-1" class="headerlink" title="解决"></a>解决</h5><p>　升级 JDK 版本到 <a href="https://bugs.openjdk.java.net/browse/JDK-8147468">1.8u102+</a>，并使用 <code>-Djdk.nio.maxCachedBufferSize</code> 参数限制每个线程的 <code>DirectByteBuffer</code> 大小</p>
<div class="note info">该参数不支持 M、G 这些单位，只能填写数字，且单位为 Byte</div>
<div class="note info">该参数默认值是 Integer.MAX_VALUE</div>



<h4 id="G1GC-报错-To-space-Exhausted"><a href="#G1GC-报错-To-space-Exhausted" class="headerlink" title="G1GC 报错 To-space Exhausted"></a>G1GC 报错 To-space Exhausted</h4><h5 id="描述-5"><a href="#描述-5" class="headerlink" title="描述"></a>描述</h5><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="number">2018</span>-<span class="number">08</span>-<span class="number">12</span>T00:<span class="number">52</span>:<span class="number">36.255</span>+<span class="number">0800</span>: <span class="number">17308164.871</span>: [<span class="function">GC <span class="title">pause</span> <span class="params">(G1 Evacuation Pause)</span> <span class="params">(young)</span> <span class="params">(to-space exhausted)</span>, 2.3349764 secs]</span></span><br><span class="line"><span class="function">   [Parallel Time: 331.1 ms, GC Workers: 23]</span></span><br><span class="line"><span class="function">      [GC Worker <span class="title">Start</span> <span class="params">(ms)</span>: Min: 17308164872.2, Avg: 17308164872.3, Max: 17308164872.3, Diff: 0.2]</span></span><br><span class="line"><span class="function">      [Ext Root <span class="title">Scanning</span> <span class="params">(ms)</span>: Min: 0.7, Avg: 1.0, Max: 3.1, Diff: 2.4, Sum: 23.1]</span></span><br><span class="line"><span class="function">      [Update <span class="title">RS</span> <span class="params">(ms)</span>: Min: 56.3, Avg: 58.3, Max: 59.2, Diff: 2.9, Sum: 1341.8]</span></span><br><span class="line"><span class="function">         [Processed Buffers: Min: 75, Avg: 95.6, Max: 133, Diff: 58, Sum: 2199]</span></span><br><span class="line"><span class="function">      [Scan <span class="title">RS</span> <span class="params">(ms)</span>: Min: 0.8, Avg: 1.4, Max: 1.5, Diff: 0.7, Sum: 33.0]</span></span><br><span class="line"><span class="function">      [Code Root <span class="title">Scanning</span> <span class="params">(ms)</span>: Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.1]</span></span><br><span class="line"><span class="function">      [Object <span class="title">Copy</span> <span class="params">(ms)</span>: Min: 269.3, Avg: 269.5, Max: 269.8, Diff: 0.6, Sum: 6197.7]</span></span><br><span class="line"><span class="function">      [<span class="title">Termination</span> <span class="params">(ms)</span>: Min: 0.0, Avg: 0.4, Max: 0.6, Diff: 0.5, Sum: 9.3]</span></span><br><span class="line"><span class="function">         [Termination Attempts: Min: 1, Avg: 290.0, Max: 325, Diff: 324, Sum: 6669]</span></span><br><span class="line"><span class="function">      [GC Worker <span class="title">Other</span> <span class="params">(ms)</span>: Min: 0.0, Avg: 0.1, Max: 0.2, Diff: 0.2, Sum: 3.0]</span></span><br><span class="line"><span class="function">      [GC Worker <span class="title">Total</span> <span class="params">(ms)</span>: Min: 330.7, Avg: 330.8, Max: 331.0, Diff: 0.3, Sum: 7608.0]</span></span><br><span class="line"><span class="function">      [GC Worker <span class="title">End</span> <span class="params">(ms)</span>: Min: 17308165202.9, Avg: 17308165203.0, Max: 17308165203.1, Diff: 0.2]</span></span><br><span class="line"><span class="function">   [Code Root Fixup: 0.2 ms]</span></span><br><span class="line"><span class="function">   [Code Root Purge: 0.0 ms]</span></span><br><span class="line"><span class="function">   [Clear CT: 1.1 ms]</span></span><br><span class="line"><span class="function">   [Other: 2002.7 ms]</span></span><br><span class="line"><span class="function">      [Evacuation Failure: 779.0 ms]</span></span><br><span class="line"><span class="function">      [Choose CSet: 0.0 ms]</span></span><br><span class="line"><span class="function">      [Ref Proc: 1217.9 ms]</span></span><br><span class="line"><span class="function">      [Ref Enq: 1.6 ms]</span></span><br><span class="line"><span class="function">      [Redirty Cards: 0.8 ms]</span></span><br><span class="line"><span class="function">      [Humongous Register: 0.2 ms]</span></span><br><span class="line"><span class="function">      [Humongous Reclaim: 0.9 ms]</span></span><br><span class="line"><span class="function">      [Free CSet: 1.5 ms]</span></span><br><span class="line"><span class="function">   [Eden: 8520.0<span class="title">M</span><span class="params">(<span class="number">8520.0</span>M)</span>-&gt;0.0<span class="title">B</span><span class="params">(<span class="number">3536.0</span>M)</span> Survivors: 368.0M-&gt;440.0M Heap: 14.8<span class="title">G</span><span class="params">(<span class="number">16.0</span>G)</span>-&gt;10.4<span class="title">G</span><span class="params">(<span class="number">16.0</span>G)</span>]</span></span><br><span class="line"><span class="function"> [Times: user</span>=<span class="number">25.22</span> sys=<span class="number">0.29</span>, real=<span class="number">2.33</span> secs] </span><br></pre></td></tr></tbody></table></figure>
<h5 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h5><p>　在日志中看到类似 Evacuation Failure、To-space Exhausted 或者 To-space Overflow 这样的输出（取决于不同版本的 JVM，输出略有不同）。这是 G1GC 收集器在将某个需要垃圾回收的分区进行回收时，无法找到一个能将其中存活对象拷贝过去的空闲分区。这种情况被称为 Evacuation Failure，常常会引发 Full GC</p>
<h5 id="解决-2"><a href="#解决-2" class="headerlink" title="解决"></a>解决</h5><ol>
<li>增加 <code>-XX:G1ReservePercent</code> 选项的值（并相应增加总的堆大小），为<strong>目标空间</strong>增加预留内存量</li>
<li>将 <code>-XX:InitiatingHeapOccupancyPercent</code> 参数调低（默认值是45），可以使 G1GC 收集器更早开始 Mixed GC；但另一方面，会增加 GC 发生频率</li>
<li>提高 <code>-XX:ConcGCThreads</code> 的值，在 Mixed GC 阶段投入更多的并发线程，争取提高每次暂停的效率。但是此参数会占用一定的有效工作线程资源</li>
</ol>
<h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><h3 id="Doc"><a href="#Doc" class="headerlink" title="Doc"></a>Doc</h3><ul>
<li><a href="https://tools.ietf.org/html/rfc5789">PATCH Method for HTTP</a></li>
<li><a href="https://docs.oracle.com/javase/8/docs/index.html">Java Platform Standard Edition 8 Documentation</a></li>
</ul>
<h3 id="Tool"><a href="#Tool" class="headerlink" title="Tool"></a>Tool</h3><ul>
<li><a href="http://jd.benow.ca/">JD-GUI</a></li>
<li><a href="https://abi-laboratory.pro/index.php?view=tracker&amp;lang=java">ABI Laboratory</a></li>
</ul>
<h3 id="Blog"><a href="#Blog" class="headerlink" title="Blog"></a>Blog</h3><ul>
<li><a href="http://mail.openjdk.java.net/pipermail/openjfx-dev/2015-April/017063.html">Private APIs not usable in Java 9?</a><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">getTotalPhysicalMemorySize</span><span class="params">()</span> </span>{</span><br><span class="line">    com.sun.management.OperatingSystemMXBean os = (com.sun.management.OperatingSystemMXBean)</span><br><span class="line">            java.lang.management.ManagementFactory.getOperatingSystemMXBean();</span><br><span class="line">    <span class="keyword">return</span> os.getTotalPhysicalMemorySize();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt=""></a></td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>语言</category>
      </categories>
      <tags>
        <tag>Maven</tag>
        <tag>Java</tag>
        <tag>JVM</tag>
        <tag>SPI</tag>
        <tag>HttpRunner</tag>
        <tag>JMC</tag>
        <tag>MAT</tag>
        <tag>Arthas</tag>
        <tag>Jersey</tag>
        <tag>LogBack</tag>
      </tags>
  </entry>
  <entry>
    <title>Apache Kafka 分布式消息队列框架</title>
    <url>/posts/26002/</url>
    <content><![CDATA[<h2 id="Kafka-是什么？"><a href="#Kafka-是什么？" class="headerlink" title="Kafka 是什么？"></a>Kafka 是什么？</h2><p>　<strong>Kafka</strong> is a distributed, partitioned, replicated commit log service. It provides the functionality of a messaging system, but with a unique design.</p>
<h2 id="为什么要有-Kafka"><a href="#为什么要有-Kafka" class="headerlink" title="为什么要有 Kafka?"></a>为什么要有 Kafka?</h2><h3 id="分布式"><a href="#分布式" class="headerlink" title="分布式"></a>分布式</h3><p>　具备经济、快速、可靠、易扩充、数据共享、设备共享、通讯方便、灵活等，分布式所具备的特性</p>
<h3 id="高吞吐量"><a href="#高吞吐量" class="headerlink" title="高吞吐量"></a>高吞吐量</h3><p>　同时为数据生产者和消费者提高吞吐量</p>
<h3 id="高可靠性"><a href="#高可靠性" class="headerlink" title="高可靠性"></a>高可靠性</h3><p>　支持多个消费者，当某个消费者失败的时候，能够自动负载均衡</p>
<h3 id="离线-amp-实时性"><a href="#离线-amp-实时性" class="headerlink" title="离线 &amp; 实时性"></a>离线 &amp; 实时性</h3><p>　能将消息持久化，进行批量处理</p>
<h3 id="解耦"><a href="#解耦" class="headerlink" title="解耦"></a>解耦</h3><p>　作为各个系统连接的桥梁，避免系统之间的耦合</p>
<a id="more"></a>
<h2 id="Kafka-工作机制"><a href="#Kafka-工作机制" class="headerlink" title="Kafka 工作机制"></a>Kafka 工作机制</h2><h3 id="一些主要概念"><a href="#一些主要概念" class="headerlink" title="一些主要概念"></a>一些主要概念</h3><ul>
<li><p>Topic（主题）<br> A <strong>topic</strong> is a category or feed name to which messages are published.</p>
</li>
<li><p>Producers（发布者）<br> <strong>Producers</strong> publish data to the topics of their choice. The producer is responsible for choosing which message to assign to which partition within the topic.</p>
</li>
<li><p>Consumers（订阅者）<br> <strong>Consumers</strong> label themselves with a <em>consumer group</em> name, and each record published to a topic is delivered to one consumer instance within each subscribing consumer group. Consumer instances can be in separate processes or on separate machines.</p>
</li>
</ul>
<h3 id="示意图"><a href="#示意图" class="headerlink" title="示意图"></a>示意图</h3><p><img data-src="/picture/kafka/kafka_consumer_groups.png" alt="Kafka Consumer Groups"></p>
<center>（图片来源：<a href="https://kafka.apache.org/intro" target="_blank">Kafka</a>™ 官网）</center>



<h2 id="Kafka-Connect"><a href="#Kafka-Connect" class="headerlink" title="Kafka Connect"></a>Kafka Connect</h2><h3 id="Kafka-Connect-是什么？"><a href="#Kafka-Connect-是什么？" class="headerlink" title="Kafka Connect 是什么？"></a>Kafka Connect 是什么？</h3><p>　<strong>Kafka Connect</strong> 是一款可扩展且稳定的、可在 Apache Kafka 和其他系统之间进行数据传输的框架。能够快速定义，将大量数据导入导出 Kafka 的连接器。Source Connector 可以接受整个数据库，将表转化为 Stream 更新到 Kafka Topic 中。也支持将应用服务器的指标收集到 Kafka Topic，使得数据可用于低延迟场景的<strong>流处理</strong>。Sink Connector 则可以将数据从 Kafka Topic 传送到搜索引擎（如 <a href="https://yuzhouwan.com/posts/22654/">ElasticSearch</a>）或<strong>离线分析</strong>系统（如 <a href="https://yuzhouwan.com/posts/60504/">Hadoop</a>）</p>
<p><img data-src="/picture/kafka/kafka_connect.png" alt="Kafka Connect"></p>
<center>（图片来源：<a href="https://kafka.apache.org/intro" target="_blank">Kafka</a>™ 官网）</center>



<h3 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h3><ul>
<li>Kafka Connector 通用框架，提供统一的 API 集成接口</li>
<li>支持单机和分布式模式</li>
<li>提供 <a href="https://yuzhouwan.com/posts/26002/#RESTful-接口">RESTful 接口</a>，用来查看和管理 Kafka Connectors</li>
<li>自动化的 Offset 管理</li>
<li>分布式、可扩展，基于现有的 Group 管理协议，可以通过增加 Task / Worker 实现动态扩展</li>
<li>更方便集成其他 流 / 批 处理系统</li>
<li>丰富的 Metrics 监控指标</li>
<li>支持 C / C++ / Go / <a href="https://yuzhouwan.com/posts/27328/">Java</a> / JMS / .Net / <a href="https://yuzhouwan.com/posts/43687/">Python</a> 等多种语言的<a href="https://www.confluent.io/clients/">客户端</a></li>
</ul>
<h3 id="设计目标"><a href="#设计目标" class="headerlink" title="设计目标"></a>设计目标</h3><ul>
<li>只专注于可靠、可扩展地<strong>同步数据</strong>（将转换、抽取等任务交给专门的数据处理框架）</li>
<li>尽可能地保持<strong>粗粒度</strong>（比如，同步数据库时，是将整个数据库作为默认的处理单元，而不是一张张表）</li>
<li><strong>并行</strong>地数据同步（支持数据处理能力的自动扩展）</li>
<li>支持 <strong>exactly-once</strong> 强语义（包括，类似 HDFS 这样没有主键用于区分重复的存储系统）</li>
<li>当源系统提供了数据结构和类型之后，需要在数据同步过程中保存<strong>元数据</strong></li>
<li>API 定义需要<strong>简洁</strong>、可重用、易于理解，方便实现自定义的 Connector</li>
<li>同时支持<strong>单机</strong>开发测试，也支持<strong>分布式</strong>生产应用</li>
</ul>
<h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><h4 id="Connector"><a href="#Connector" class="headerlink" title="Connector"></a>Connector</h4><p>　<strong>Connector</strong> 是为了方便协调数据流任务，而提出的高层抽象</p>
<h4 id="Task"><a href="#Task" class="headerlink" title="Task"></a>Task</h4><p>　具体实现数据从 Kafka 导入导出的功能</p>
<p>　同时具备 <strong>Task</strong> 自动容灾的能力（不过 Worker 本身<a href="https://docs.confluent.io/current/connect/userguide.html#deployment-considerations">不支持</a> 自动重启和扩容进程资源的功能）</p>
<h4 id="Worker"><a href="#Worker" class="headerlink" title="Worker"></a>Worker</h4><p>　执行 Connector 和 Task 的进程</p>
<h4 id="Converter"><a href="#Converter" class="headerlink" title="Converter"></a>Converter</h4><p>　用于转化 Kafka Connect 和 其他系统之间交互的数据格式</p>
<h4 id="Transform"><a href="#Transform" class="headerlink" title="Transform"></a>Transform</h4><p>　对 Connector 接收和发送的数据进行一些简单的处理逻辑</p>
<h3 id="架构"><a href="#架构" class="headerlink" title="架构"></a><a href="https://docs.confluent.io/current/connect/design.html#architecture">架构</a></h3><h4 id="Connector-model"><a href="#Connector-model" class="headerlink" title="Connector model"></a><strong>Connector model</strong></h4><p>　Connector 模型，定义了 Kafka Connector 与外部系统的操作接口，包括 Connector 和 Task</p>
<p>　Connector 是一个指定的 <code>Connector</code> 实现类，配置了需要拷贝哪些数据，以及如何处理数据的相关属性。Connector 实例由一组 Tasks 组成。Kafka Connect 实际管理 Tasks，Connector 只负责生成 Tasks，并在框架指定更新的时候，完成配置更改。<code>Source</code> 端 / <code>Sink</code> 端 的 <code>Connectors</code>/<code>Tasks</code> API 接口是独立定义的，主要为了能够保证 API 定义的简洁性</p>
<h4 id="Worker-model"><a href="#Worker-model" class="headerlink" title="Worker model"></a><strong>Worker model</strong></h4><p>　Worker 模型，管理 Connector 和 Task 的生命周期，包括 启动、暂停、恢复、重启、停止 等</p>
<p>　Kafka Connect 群集由一组 Worker 进程组成，这些进程是执行 Connector 和 Task 的容器。Worker 自动和其他分布式的 Worker 协调工作，提供可扩展性和容错性。同时 Worker 进程的<strong>资源管理</strong>可以托管于 Yarn / Mesos，<strong>配置管理</strong>可以与 Chef / Puppet 框架整合，<strong>生命周期管理</strong>也可以使用 Oozie / <a href="http://falcon.apache.org/FalconDocumentation.html">Falcon</a> 等</p>
<h4 id="Data-model"><a href="#Data-model" class="headerlink" title="Data model"></a><strong>Data model</strong></h4><p>　数据模型，定义了 Kafka Connector 管理的数据结构、记录的序列化</p>
<p>　Connectors 复制数据流从一个 partitioned 输入流到一个 partitioned 输出流，其中输入输出端至少有一个总是 Kafka。每一个 Stream 都是一个有序的数据流，流里面的消息都有一个对应的偏移量。这些偏移量的格式和语义由 Connector 定义，以支持与各种系统的集成；然而，为了在故障的情况下实现某些传递语义，需要确保 Stream 内的偏移是唯一的，并且流可以 seek 任意的偏移。同时，Kafka Connect 支持插件式的转换器，以便支持各种序列化格式，来存储这些数据。另外，Schema 是内置的，使得关于数据格式的重要元数据，得以在复杂的数据管道中传播。但是，当 Schema 不可用时，也可以使用无模式的数据</p>
<h3 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h3><h4 id="基础环境"><a href="#基础环境" class="headerlink" title="基础环境"></a>基础环境</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 增加用户，并赋予其密码</span></span><br><span class="line">$ adduser connect</span><br><span class="line">$ passwd connect            <span class="comment"># ur password for connect user</span></span><br><span class="line"><span class="comment"># 赋予用户可以 sudo 的权限</span></span><br><span class="line">$ chmod u+w /etc/sudoers</span><br><span class="line">$ vim /etc/sudoers</span><br><span class="line">  <span class="comment"># 找到 `root ALL=(ALL) ALL` 这行，并在下面添加 connect 用户</span></span><br><span class="line">  connect    ALL=(ALL)    ALL</span><br><span class="line"></span><br><span class="line">$ chmod u-w /etc/sudoers</span><br><span class="line"><span class="comment"># 切换到 connect 用户</span></span><br><span class="line">$ su - connect</span><br><span class="line">$ <span class="built_in">cd</span> /home/connect</span><br><span class="line"><span class="comment"># 存放软件目录 &amp; 安装目录 &amp; 日志目录</span></span><br><span class="line">$ mkdir install &amp;&amp; mkdir software &amp;&amp; mkdir logs</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Confluent"><a href="#Confluent" class="headerlink" title="Confluent"></a>Confluent</h4><h5 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h5><p>　在 <a href="https://www.confluent.io/download/">https://www.confluent.io/download/</a> 页面中下载 <a href="http://packages.confluent.io/archive/3.3/confluent-oss-3.3.1-2.11.tar.gz">confluent-oss-3.3.1-2.11.tar.gz</a> 安装包</p>
<h5 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/install/</span><br><span class="line">$ tar zxvf confluent-oss-3.3.1-2.11.tar.gz -C ~/software/</span><br><span class="line">$ <span class="built_in">cd</span> ~/software/</span><br><span class="line">$ ln -s confluent-3.3.1/ confluent</span><br><span class="line">$ vim ~/.bashrc</span><br><span class="line">  <span class="built_in">export</span> CONFLUENT_HOME=/home/connect/software/confluent</span><br><span class="line">  <span class="built_in">export</span> PATH=<span class="variable">$CONFLUENT_HOME</span>/bin:<span class="variable">$PATH</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">source</span> ~/.bashrc</span><br></pre></td></tr></tbody></table></figure>
<h5 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 启动 ZooKeeper, Kafka, Schema Registry</span></span><br><span class="line">$ confluent start schema-registry</span><br><span class="line">  Starting zookeeper</span><br><span class="line">  zookeeper is [UP]</span><br><span class="line">  Starting kafka</span><br><span class="line">  kafka is [UP]</span><br><span class="line">  Starting schema-registry</span><br><span class="line">  schema-registry is [UP]</span><br><span class="line"></span><br><span class="line">$ jps -ml</span><br><span class="line">  32680 org.apache.zookeeper.server.quorum.QuorumPeerMain /tmp/confluent.A8TzcjSE/zookeeper/zookeeper.properties</span><br><span class="line">  348 io.confluent.support.metrics.SupportedKafka /tmp/confluent.A8TzcjSE/kafka/kafka.properties</span><br><span class="line">  483 io.confluent.kafka.schemaregistry.rest.SchemaRegistryMain /tmp/confluent.A8TzcjSE/schema-registry/schema-registry.properties</span><br></pre></td></tr></tbody></table></figure>
<h5 id="发送-avro-数据"><a href="#发送-avro-数据" class="headerlink" title="发送 avro 数据"></a>发送 avro 数据</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/software/confluent/</span><br><span class="line">$ ./bin/kafka-avro-console-producer --broker-list localhost:9092 --topic <span class="built_in">test</span> --property value.schema=<span class="string">'{"type":"record","name":"myrecord","fields":[{"name":"f1","type":"string"}]}'</span></span><br><span class="line">  <span class="comment"># 输入以下三行 JSON 串</span></span><br><span class="line">  {<span class="string">"f1"</span>: <span class="string">"value1"</span>}</span><br><span class="line">  {<span class="string">"f1"</span>: <span class="string">"value2"</span>}</span><br><span class="line">  {<span class="string">"f1"</span>: <span class="string">"value3"</span>}</span><br><span class="line">  <span class="comment"># Ctrl+C 停止进程</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="接受-avro-数据"><a href="#接受-avro-数据" class="headerlink" title="接受 avro 数据"></a>接受 avro 数据</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ ./bin/kafka-avro-console-consumer --topic <span class="built_in">test</span> --zookeeper localhost:2181 --from-beginning</span><br><span class="line">  <span class="comment"># 接收到 producer 发送的三行 JSON 串</span></span><br><span class="line">  {<span class="string">"f1"</span>:<span class="string">"value1"</span>}</span><br><span class="line">  {<span class="string">"f1"</span>:<span class="string">"value2"</span>}</span><br><span class="line">  {<span class="string">"f1"</span>:<span class="string">"value3"</span>}</span><br><span class="line">  <span class="comment"># Ctrl+C 停止进程</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="发送数据格式不对的-avro-数据"><a href="#发送数据格式不对的-avro-数据" class="headerlink" title="发送数据格式不对的 avro 数据"></a>发送数据格式不对的 avro 数据</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ ./bin/kafka-avro-console-producer --broker-list localhost:9092 --topic <span class="built_in">test</span> --property value.schema=<span class="string">'{"type":"int"}'</span></span><br><span class="line">  <span class="comment"># 输入以下一行 JSON 串</span></span><br><span class="line">  {<span class="string">"f1"</span>:<span class="string">"value1"</span>}</span><br><span class="line">  <span class="comment"># 获得如下报错</span></span><br><span class="line">  org.apache.kafka.common.errors.SerializationException: Error deserializing json {<span class="string">"f1"</span>:<span class="string">"value1"</span>} to Avro of schema <span class="string">"int"</span></span><br><span class="line">  Caused by: org.apache.avro.AvroTypeException: Expected int. Got START_OBJECT</span><br><span class="line">      at org.apache.avro.io.JsonDecoder.error(JsonDecoder.java:698)</span><br><span class="line">      at org.apache.avro.io.JsonDecoder.readInt(JsonDecoder.java:172)</span><br><span class="line">      at org.apache.avro.io.ValidatingDecoder.readInt(ValidatingDecoder.java:83)</span><br><span class="line">      at org.apache.avro.generic.GenericDatumReader.readInt(GenericDatumReader.java:503)</span><br><span class="line">      at org.apache.avro.generic.GenericDatumReader.readWithoutConversion(GenericDatumReader.java:183)</span><br><span class="line">      at org.apache.avro.generic.GenericDatumReader.read(GenericDatumReader.java:153)</span><br><span class="line">      at org.apache.avro.generic.GenericDatumReader.read(GenericDatumReader.java:145)</span><br><span class="line">      at io.confluent.kafka.formatter.AvroMessageReader.jsonToAvro(AvroMessageReader.java:191)</span><br><span class="line">      at io.confluent.kafka.formatter.AvroMessageReader.readMessage(AvroMessageReader.java:158)</span><br><span class="line">      at kafka.tools.ConsoleProducer$.main(ConsoleProducer.scala:58)</span><br><span class="line">      at kafka.tools.ConsoleProducer.main(ConsoleProducer.scala)</span><br></pre></td></tr></tbody></table></figure>
<h5 id="停止"><a href="#停止" class="headerlink" title="停止"></a>停止</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ confluent stop schema-registry</span><br><span class="line">  Stopping connect</span><br><span class="line">  connect is [DOWN]</span><br><span class="line">  Stopping kafka-rest</span><br><span class="line">  kafka-rest is [DOWN]</span><br><span class="line">  Stopping schema-registry</span><br><span class="line">  schema-registry is [DOWN]</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Kafka-Connect-1"><a href="#Kafka-Connect-1" class="headerlink" title="Kafka Connect"></a><a href="https://docs.confluent.io/current/connect/connect-hdfs/docs/hdfs_connector.html">Kafka Connect</a></h4><h5 id="启动-confluent"><a href="#启动-confluent" class="headerlink" title="启动 confluent"></a>启动 confluent</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ confluent start</span><br><span class="line">  zookeeper is already running. Try restarting <span class="keyword">if</span> needed</span><br><span class="line">  kafka is already running. Try restarting <span class="keyword">if</span> needed</span><br><span class="line">  Starting schema-registry</span><br><span class="line">  schema-registry is [UP]</span><br><span class="line">  Starting kafka-rest</span><br><span class="line">  kafka-rest is [UP]</span><br><span class="line">  Starting connect</span><br><span class="line">  connect is [UP]</span><br></pre></td></tr></tbody></table></figure>
<h5 id="查看-connect-日志"><a href="#查看-connect-日志" class="headerlink" title="查看 connect 日志"></a>查看 connect 日志</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ confluent <span class="built_in">log</span> connect</span><br><span class="line">$ confluent current</span><br><span class="line">  /tmp/confluent.A8TzcjSE</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> /tmp/confluent.A8TzcjSE</span><br><span class="line">$ less connect/connect.stderr</span><br></pre></td></tr></tbody></table></figure>
<h5 id="查看支持的-connect-类型"><a href="#查看支持的-connect-类型" class="headerlink" title="查看支持的 connect 类型"></a>查看支持的 connect 类型</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ confluent list connectors</span><br><span class="line">  Bundled Predefined Connectors (edit configuration under etc/):</span><br><span class="line">    elasticsearch-sink</span><br><span class="line">    file-source</span><br><span class="line">    file-sink</span><br><span class="line">    jdbc-source</span><br><span class="line">    jdbc-sink</span><br><span class="line">    hdfs-sink</span><br><span class="line">    s3-sink</span><br><span class="line"></span><br><span class="line">$ ll etc/</span><br><span class="line">  drwxr-xr-x 2 connect connect 4096 Jul 28 08:07 camus</span><br><span class="line">  drwxr-xr-x 2 connect connect 4096 Jul 28 07:41 confluent-common</span><br><span class="line">  drwxr-xr-x 2 connect connect 4096 Jul 28 07:28 kafka</span><br><span class="line">  drwxr-xr-x 2 connect connect 4096 Jul 28 07:50 kafka-connect-elasticsearch</span><br><span class="line">  drwxr-xr-x 2 connect connect 4096 Jul 28 07:58 kafka-connect-hdfs</span><br><span class="line">  drwxr-xr-x 2 connect connect 4096 Jul 28 08:06 kafka-connect-jdbc</span><br><span class="line">  drwxr-xr-x 2 connect connect 4096 Jul 28 08:04 kafka-connect-s3</span><br><span class="line">  drwxr-xr-x 2 connect connect 4096 Jul 28 07:52 kafka-connect-storage-common</span><br><span class="line">  drwxr-xr-x 2 connect connect 4096 Jul 28 07:48 kafka-rest</span><br><span class="line">  drwxr-xr-x 2 connect connect 4096 Jul 28 07:42 rest-utils</span><br><span class="line">  drwxr-xr-x 2 connect connect 4096 Jul 28 07:45 schema-registry</span><br></pre></td></tr></tbody></table></figure>
<h5 id="使用-file-source"><a href="#使用-file-source" class="headerlink" title="使用 file-source"></a>使用 file-source</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 配置 file-source</span></span><br><span class="line">$ cat ./etc/kafka/connect-file-source.properties</span><br><span class="line">  name=<span class="built_in">local</span>-file-source</span><br><span class="line">  connector.class=FileStreamSource</span><br><span class="line">  tasks.max=1</span><br><span class="line">  file=test.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果不需要 Schema Registry 功能，需要同时制定 key.converter 和 value.converter 参数为org.apache.kafka.connect.json.JsonConverter</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 往 test.txt 里面写入测试数据</span></span><br><span class="line">$ <span class="keyword">for</span> i <span class="keyword">in</span> {1..3}; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">"log line <span class="variable">$i</span>"</span>; <span class="keyword">done</span> &gt; test.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 装载 file-source 连接器，并确认 file-source 的配置</span></span><br><span class="line">$ confluent load file-source</span><br><span class="line">  {<span class="string">"name"</span>:<span class="string">"file-source"</span>,<span class="string">"config"</span>:{<span class="string">"connector.class"</span>:<span class="string">"FileStreamSource"</span>,<span class="string">"tasks.max"</span>:<span class="string">"1"</span>,<span class="string">"file"</span>:<span class="string">"test.txt"</span>,<span class="string">"topic"</span>:<span class="string">"connect-test"</span>,<span class="string">"name"</span>:<span class="string">"file-source"</span>},<span class="string">"tasks"</span>:[]}</span><br><span class="line"></span><br><span class="line"><span class="comment"># 确认 connecter 是否已经装载</span></span><br><span class="line">$ confluent status connectors</span><br><span class="line">  [<span class="string">"file-source"</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查 file-source 连接器的运行状态</span></span><br><span class="line">$ confluent status file-source</span><br><span class="line">  {<span class="string">"name"</span>:<span class="string">"file-source"</span>,<span class="string">"connector"</span>:{<span class="string">"state"</span>:<span class="string">"RUNNING"</span>,<span class="string">"worker_id"</span>:<span class="string">"192.168.1.101:8083"</span>},<span class="string">"tasks"</span>:[{<span class="string">"state"</span>:<span class="string">"RUNNING"</span>,<span class="string">"id"</span>:0,<span class="string">"worker_id"</span>:<span class="string">"192.168.1.101:8083"</span>}]}</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查 Kafka 是否接收到数据</span></span><br><span class="line">$ kafka-avro-console-consumer --bootstrap-server localhost:9092 --topic connect-test --from-beginning</span><br><span class="line">  <span class="string">"log line 1"</span></span><br><span class="line">  <span class="string">"log line 2"</span></span><br><span class="line">  <span class="string">"log line 3"</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="使用-file-sink"><a href="#使用-file-sink" class="headerlink" title="使用 file-sink"></a>使用 file-sink</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 配置 file-sink</span></span><br><span class="line">$ cat ./etc/kafka/connect-file-sink.properties</span><br><span class="line">  name=<span class="built_in">local</span>-file-sink</span><br><span class="line">  connector.class=FileStreamSink</span><br><span class="line">  tasks.max=1</span><br><span class="line">  file=test.sink.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 装载 file-sink 连接器，并确认 file-sink 的配置</span></span><br><span class="line">$ confluent load file-sink</span><br><span class="line">  {<span class="string">"name"</span>:<span class="string">"file-sink"</span>,<span class="string">"config"</span>:{<span class="string">"connector.class"</span>:<span class="string">"FileStreamSink"</span>,<span class="string">"tasks.max"</span>:<span class="string">"1"</span>,<span class="string">"file"</span>:<span class="string">"test.sink.txt"</span>,<span class="string">"topics"</span>:<span class="string">"connect-test"</span>,<span class="string">"name"</span>:<span class="string">"file-sink"</span>},<span class="string">"tasks"</span>:[]}</span><br><span class="line"></span><br><span class="line"><span class="comment"># 确认 connecter 是否已经装载</span></span><br><span class="line">$ confluent status connectors</span><br><span class="line">  [<span class="string">"file-source"</span>,<span class="string">"file-sink"</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查 file-sink 连接器的运行状态</span></span><br><span class="line">$ confluent status file-sink</span><br><span class="line">  {<span class="string">"name"</span>:<span class="string">"file-sink"</span>,<span class="string">"connector"</span>:{<span class="string">"state"</span>:<span class="string">"RUNNING"</span>,<span class="string">"worker_id"</span>:<span class="string">"192.168.1.101:8083"</span>},<span class="string">"tasks"</span>:[{<span class="string">"state"</span>:<span class="string">"RUNNING"</span>,<span class="string">"id"</span>:0,<span class="string">"worker_id"</span>:<span class="string">"192.168.1.101:8083"</span>}]}</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查 Kafka 数据是否已经写入到文件</span></span><br><span class="line">$ tail -f test.sink.txt</span><br><span class="line">  <span class="built_in">log</span> line 1</span><br><span class="line">  <span class="built_in">log</span> line 2</span><br><span class="line">  <span class="built_in">log</span> line 3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 另起窗口，并执行写入 test.txt 数据的脚本，可以看到对应 test.sink.txt 里面已经被写入数据</span></span><br><span class="line">$ <span class="keyword">for</span> i <span class="keyword">in</span> {4..1000}; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">"log line <span class="variable">$i</span>"</span>; <span class="keyword">done</span> &gt;&gt; test.txt</span><br></pre></td></tr></tbody></table></figure>
<h5 id="清理工作"><a href="#清理工作" class="headerlink" title="清理工作"></a>清理工作</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 卸载 file-source / file-sink connector</span></span><br><span class="line">$ confluent unload file-source</span><br><span class="line">$ confluent unload file-sink</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭 connect 进程</span></span><br><span class="line">$ confluent stop connect</span><br><span class="line">  Stopping connect</span><br><span class="line">  connect is [DOWN]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止所有 confluent 进程</span></span><br><span class="line">$ confluent stop</span><br><span class="line">  Stopping connect</span><br><span class="line">  connect is [DOWN]</span><br><span class="line">  Stopping kafka-rest</span><br><span class="line">  kafka-rest is [DOWN]</span><br><span class="line">  Stopping schema-registry</span><br><span class="line">  schema-registry is [DOWN]</span><br><span class="line">  Stopping kafka</span><br><span class="line">  kafka is [DOWN]</span><br><span class="line">  Stopping zookeeper</span><br><span class="line">  zookeeper is [DOWN]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止所有 confluent 进程，并删除临时文件</span></span><br><span class="line">$ confluent destroy</span><br><span class="line">  Stopping connect</span><br><span class="line">  connect is [DOWN]</span><br><span class="line">  Stopping kafka-rest</span><br><span class="line">  kafka-rest is [DOWN]</span><br><span class="line">  Stopping schema-registry</span><br><span class="line">  schema-registry is [DOWN]</span><br><span class="line">  Stopping kafka</span><br><span class="line">  kafka is [DOWN]</span><br><span class="line">  Stopping zookeeper</span><br><span class="line">  zookeeper is [DOWN]</span><br><span class="line">  Deleting: /tmp/confluent.A8TzcjSE</span><br></pre></td></tr></tbody></table></figure>
<h3 id="支持的组件"><a href="#支持的组件" class="headerlink" title="支持的组件"></a><a href="https://www.confluent.io/product/connectors/">支持的组件</a></h3><h4 id="Kafka-2-HDFS"><a href="#Kafka-2-HDFS" class="headerlink" title="Kafka 2 HDFS"></a><a href="https://github.com/confluentinc/kafka-connect-hdfs">Kafka 2 HDFS</a></h4><h5 id="特性-1"><a href="#特性-1" class="headerlink" title="特性"></a><a href="https://docs.confluent.io/current/connect/connect-hdfs/docs/hdfs_connector.html#features">特性</a></h5><h6 id="Exactly-Once-Delivery"><a href="#Exactly-Once-Delivery" class="headerlink" title="Exactly Once Delivery"></a><strong>Exactly Once Delivery</strong></h6><p>　Connector 使用 WAL 文件保证每条导入到 HDFS 的数据都是<strong>有且仅有一条</strong>的<br>　通过将 Kafka offset 信息编码到 WAL 文件中，就可以在 task 失败或者重启的时候，获取到最后一条提交的 offset 了</p>
<h6 id="Extensible-Data-Format"><a href="#Extensible-Data-Format" class="headerlink" title="Extensible Data Format"></a><strong>Extensible Data Format</strong></h6><p>　原生支持 <code>Avro</code> / <code>Parquet</code> 格式，其他数据格式，可以通过扩展 <code>Format</code> 类获得支持</p>
<h6 id="Hive-Integration"><a href="#Hive-Integration" class="headerlink" title="Hive Integration"></a><strong>Hive Integration</strong></h6><p>　支持 Hive 的整合<br>　激活该功能后，Connector 会自动给每一个导入 HDFS 的 topic 创建 Hive 的外部分区表</p>
<h6 id="Schema-Evolution"><a href="#Schema-Evolution" class="headerlink" title="Schema Evolution"></a><strong>Schema Evolution</strong></h6><p>　支持模式演进和不同的 Schema 兼容级别<br>　整合 Hive 时，支持给 <code>schema.compatibility</code> 配置 <code>BACKWARD</code> / <code>FORWARD</code> / <code>FULL</code> 三种模式<br>　Hive 表可以查询同一个 Topic 下，以不同 Schema 写入的所有表数据</p>
<h6 id="Secure-HDFS-and-Hive-Metastore-Support"><a href="#Secure-HDFS-and-Hive-Metastore-Support" class="headerlink" title="Secure HDFS and Hive Metastore Support"></a><strong>Secure HDFS and Hive Metastore Support</strong></h6><p>　支持 <code>Kerberos</code> 权限控制，所以可以和带权限控制的 HDFS 或 Hive metastore 进行整合</p>
<h6 id="Pluggable-Partitioner"><a href="#Pluggable-Partitioner" class="headerlink" title="Pluggable Partitioner"></a><strong>Pluggable Partitioner</strong></h6><p>　支持默认的 Partitioner、基于 field 的 Partitioner、基于时间的 Partitioner（包括 daily / hourly 等粒度）<br>　可以实现 <code>Partitioner</code> 类扩展自己的 Partitioner<br>　也可以实现 <code>TimeBasedPartitioner</code> 类扩展基于时间的 Partitioner</p>
<h5 id="实战-HDFS"><a href="#实战-HDFS" class="headerlink" title="实战 HDFS"></a>实战 HDFS</h5><h6 id="安装-HDFS"><a href="#安装-HDFS" class="headerlink" title="安装 HDFS"></a>安装 HDFS</h6><p>　此处略，详见我的另一篇博客《<a href="https://yuzhouwan.com/posts/39683/#Hadoop">Apache Eagle</a>》</p>
<h6 id="配置-Confluent"><a href="#配置-Confluent" class="headerlink" title="配置 Confluent"></a>配置 Confluent</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim etc/kafka-connect-hdfs/quickstart-hdfs.properties</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">name</span>=<span class="string">hdfs-sink</span></span><br><span class="line"><span class="meta">connector.class</span>=<span class="string">io.confluent.connect.hdfs.HdfsSinkConnector</span></span><br><span class="line"><span class="meta">tasks.max</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">topics</span>=<span class="string">test_hdfs</span></span><br><span class="line"><span class="meta">hdfs.url</span>=<span class="string">hdfs://localhost:9000</span></span><br><span class="line"><span class="meta">flush.size</span>=<span class="string">3</span></span><br></pre></td></tr></tbody></table></figure>
<h6 id="启用"><a href="#启用" class="headerlink" title="启用"></a>启用</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ confluent start</span><br><span class="line">  Starting zookeeper</span><br><span class="line">  zookeeper is [UP]</span><br><span class="line">  Starting kafka</span><br><span class="line">  kafka is [UP]</span><br><span class="line">  Starting schema-registry</span><br><span class="line">  schema-registry is [UP]</span><br><span class="line">  Starting kafka-rest</span><br><span class="line">  kafka-rest is [UP]</span><br><span class="line">  Starting connect</span><br><span class="line">  connect is [UP]</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> ~/software/confluent</span><br><span class="line">$ ./bin/kafka-avro-console-producer --broker-list localhost:9092 --topic test_hdfs --property value.schema=<span class="string">'{"type":"record","name":"myrecord","fields":[{"name":"f1","type":"string"}]}'</span></span><br><span class="line">  <span class="comment"># 输入一下三行数据</span></span><br><span class="line">  {<span class="string">"f1"</span>: <span class="string">"value1"</span>}</span><br><span class="line">  {<span class="string">"f1"</span>: <span class="string">"value2"</span>}</span><br><span class="line">  {<span class="string">"f1"</span>: <span class="string">"value3"</span>}</span><br><span class="line"></span><br><span class="line">$ confluent load hdfs-sink -d etc/kafka-connect-hdfs/quickstart-hdfs.properties</span><br><span class="line">  {</span><br><span class="line">      <span class="string">"name"</span>:<span class="string">"hdfs-sink"</span>,</span><br><span class="line">      <span class="string">"config"</span>:{</span><br><span class="line">          <span class="string">"connector.class"</span>:<span class="string">"io.confluent.connect.hdfs.HdfsSinkConnector"</span>,</span><br><span class="line">          <span class="string">"tasks.max"</span>:<span class="string">"1"</span>,</span><br><span class="line">          <span class="string">"topics"</span>:<span class="string">"test_hdfs"</span>,</span><br><span class="line">          <span class="string">"hdfs.url"</span>:<span class="string">"hdfs://localhost:9000"</span>,</span><br><span class="line">          <span class="string">"flush.size"</span>:<span class="string">"3"</span>,</span><br><span class="line">          <span class="string">"name"</span>:<span class="string">"hdfs-sink"</span></span><br><span class="line">      },</span><br><span class="line">      <span class="string">"tasks"</span>:[</span><br><span class="line">          {</span><br><span class="line">              <span class="string">"connector"</span>:<span class="string">"hdfs-sink"</span>,</span><br><span class="line">              <span class="string">"task"</span>:0</span><br><span class="line">          }</span><br><span class="line">      ]</span><br><span class="line">  }</span><br></pre></td></tr></tbody></table></figure>
<h6 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ hadoop fs -ls /topics/test_hdfs/partition=0</span><br><span class="line">  Found 1 items</span><br><span class="line">  -rw-r--r--   3 connect supergroup        197 2017-11-12 16:58 /topics/test_hdfs/partition=0/test_hdfs+0+0000000000+0000000002.avro</span><br><span class="line"></span><br><span class="line">$ wget http://mirror.metrocast.net/apache/avro/avro-1.8.2/java/avro-tools-1.8.2.jar</span><br><span class="line"><span class="comment"># 直接在线上执行 avro 2 json 操作</span></span><br><span class="line">$ hadoop jar avro-tools-1.8.2.jar tojson hdfs://localhost:9000/topics/test_hdfs/partition=0/test_hdfs+0+0000000000+0000000002.avro</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者，拷贝 avro 文件到本地，再执行 avro 2 json 操作</span></span><br><span class="line">$ hadoop fs -copyToLocal /topics/test_hdfs/partition=0/test_hdfs+0+0000000000+0000000002.avro /tmp/test_hdfs+0+0000000000+0000000002.avro</span><br><span class="line">$ java -jar avro-tools-1.8.2.jar tojson /tmp/test_hdfs+0+0000000000+0000000002.avro</span><br><span class="line">  {<span class="string">"f1"</span>:<span class="string">"value1"</span>}</span><br><span class="line">  {<span class="string">"f1"</span>:<span class="string">"value2"</span>}</span><br><span class="line">  {<span class="string">"f1"</span>:<span class="string">"value3"</span>}</span><br></pre></td></tr></tbody></table></figure>
<h5 id="实战-Hive"><a href="#实战-Hive" class="headerlink" title="实战 Hive"></a>实战 Hive</h5><h6 id="安装-Hive"><a href="#安装-Hive" class="headerlink" title="安装 Hive"></a>安装 Hive</h6><p>a) 下载 <a href="http://archive.apache.org/dist/hive/hive-2.1.1/apache-hive-2.1.1-bin.tar.gz">apache-hive-2.1.1-bin.tar.gz</a></p>
<p>b) 修改环境变量</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim ~/.bashrc</span><br><span class="line">  <span class="built_in">export</span> HIVE_HOME=/usr/<span class="built_in">local</span>/hadoop/hive</span><br><span class="line">  <span class="built_in">export</span> PATH=<span class="variable">$HIVE_HOME</span>/bin:<span class="variable">$HIVE_HOME</span>/conf:<span class="variable">$PATH</span></span><br></pre></td></tr></tbody></table></figure>
<p>c) 修改配置文件</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim hive-env.sh</span><br><span class="line">  <span class="built_in">export</span> HADOOP_HEAPSIZE=1024</span><br><span class="line">  <span class="comment"># Set HADOOP_HOME to point to a specific hadoop install directory</span></span><br><span class="line">  HADOOP_HOME=/usr/<span class="built_in">local</span>/hadoop</span><br><span class="line">  <span class="comment"># Hive Configuration Directory can be controlled by:</span></span><br><span class="line">  <span class="built_in">export</span> HIVE_CONF_DIR=/usr/<span class="built_in">local</span>/hadoop/hive/conf</span><br><span class="line">  <span class="comment"># Folder containing extra ibraries required for hive compilation/execution can be controlled by:</span></span><br><span class="line">  <span class="built_in">export</span> HIVE_AUX_JARS_PATH=/usr/<span class="built_in">local</span>/hadoop/hive/lib</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim hive-site.xml</span><br><span class="line">  <span class="comment"># 该参数指定了 Hive 的数据存储目录，默认位置在 HDFS 上面的 /user/hive/warehouse 路径下</span></span><br><span class="line">  hive.metastore.warehouse.dir</span><br><span class="line">  <span class="comment"># 该参数指定了 Hive 的数据临时文件目录，默认位置为 HDFS 上面的 /tmp/hive 路径下</span></span><br><span class="line">  hive.exec.scratchdir</span><br></pre></td></tr></tbody></table></figure>
<p>d) 初始化和启动运行</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 初始化</span></span><br><span class="line">$ ./schematool -initSchema -dbType derby</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">$ nohup bin/hive --service metastore &gt; logs/metastore.log &amp;</span><br><span class="line">$ nohup bin/hive --service hiveserver2 &gt; logs/hiveserver2.log &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证</span></span><br><span class="line">$ bin/hive</span><br><span class="line">  &gt; show databases;</span><br></pre></td></tr></tbody></table></figure>
<h6 id="配置-Confluent-1"><a href="#配置-Confluent-1" class="headerlink" title="配置 Confluent"></a>配置 Confluent</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim etc/kafka-connect-hdfs/quickstart-hdfs.properties</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># hdfs 部分</span></span><br><span class="line"><span class="attr">name</span>=<span class="string">hdfs_sink_18</span></span><br><span class="line"><span class="meta">connector.class</span>=<span class="string">io.confluent.connect.hdfs.HdfsSinkConnector</span></span><br><span class="line"><span class="meta">topics.dir</span>=<span class="string">/user/connect/topics</span></span><br><span class="line"><span class="meta">flush.size</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">topics</span>=<span class="string">hdfs_sink_18</span></span><br><span class="line"><span class="meta">tasks.max</span>=<span class="string">1</span></span><br><span class="line"><span class="meta">hdfs.url</span>=<span class="string">hdfs://192.168.1.101:9000</span></span><br><span class="line"><span class="meta">logs.dir</span>=<span class="string">/user/connect/logs</span></span><br><span class="line"><span class="meta">schema.cache.size</span>=<span class="string">1</span></span><br><span class="line"><span class="meta">value.converter.schema.registry.url</span>=<span class="string">http://localhost:8081</span></span><br><span class="line"><span class="meta">format.class</span>=<span class="string">io.confluent.connect.hdfs.avro.AvroFormat</span></span><br><span class="line"><span class="meta">value.converter</span>=<span class="string">io.confluent.connect.avro.AvroConverter</span></span><br><span class="line"><span class="meta">key.converter</span>=<span class="string">io.confluent.connect.avro.AvroConverter</span></span><br><span class="line"><span class="meta">key.converter.schema.registry.url</span>=<span class="string">http://localhost:8081</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># hive 部分</span></span><br><span class="line"><span class="meta">hive.integration</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">hive.metastore.uris</span>=<span class="string">thrift://192.168.1.101:9083</span></span><br><span class="line"><span class="meta">schema.compatibility</span>=<span class="string">BACKWARD</span></span><br><span class="line"><span class="meta">hive.database</span>=<span class="string">hive</span></span><br><span class="line"><span class="meta">hive.conf.dir</span>=<span class="string">/home/connect/software/hive/conf</span></span><br><span class="line"><span class="meta">hive.home</span>=<span class="string">/home/connect/software/hive</span></span><br></pre></td></tr></tbody></table></figure>
<h6 id="启用-1"><a href="#启用-1" class="headerlink" title="启用"></a>启用</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ confluent load hdfs-sink-18 -d etc/kafka-connect-hdfs/quickstart-schema.properties</span><br><span class="line">$ <span class="built_in">cd</span> ~/software/confluent</span><br><span class="line">$ ./bin/kafka-avro-console-producer --broker-list 192.168.1.101:9092,192.168.1.102:9092,192.168.1.103:9092 --topic hdfs_sink_18 --property value.schema=<span class="string">'{"type":"record","name":"myrecord","fields":[{"name":"f1","type":"string"}]}'</span></span><br><span class="line">  <span class="comment"># 输入以下数据</span></span><br><span class="line">  {<span class="string">"f1"</span>:<span class="string">"value1"</span>}</span><br><span class="line">  {<span class="string">"f1"</span>:<span class="string">"value2"</span>}</span><br><span class="line">  {<span class="string">"f1"</span>:<span class="string">"value3"</span>}</span><br><span class="line">  {<span class="string">"f1"</span>:<span class="string">"value4"</span>}</span><br><span class="line">  {<span class="string">"f1"</span>:<span class="string">"value4"</span>}</span><br><span class="line">  {<span class="string">"f1"</span>:<span class="string">"value4"</span>}</span><br><span class="line">  {<span class="string">"f1"</span>:<span class="string">"value4"</span>}</span><br><span class="line">  {<span class="string">"f1"</span>:<span class="string">"value4"</span>}</span><br><span class="line">  {<span class="string">"f1"</span>:<span class="string">"value4"</span>}</span><br><span class="line">  {<span class="string">"f1"</span>:<span class="string">"value5"</span>}</span><br><span class="line">  {<span class="string">"f1"</span>:<span class="string">"value6"</span>}</span><br></pre></td></tr></tbody></table></figure>
<h6 id="验证-1"><a href="#验证-1" class="headerlink" title="验证"></a>验证</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ bin/hive</span><br><span class="line">$ use hive;</span><br><span class="line">$ select * from hdfs_sink_18 <span class="built_in">limit</span> 10;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">OK</span><br><span class="line">value4  0</span><br><span class="line">value4  0</span><br><span class="line">value6  0</span><br><span class="line">value2  1</span><br><span class="line">value4  1</span><br><span class="line">value4  1</span><br><span class="line">value5  1</span><br><span class="line">value1  2</span><br><span class="line">value4  2</span><br><span class="line">value4  2</span><br><span class="line">Time taken: 8.458 seconds, Fetched: 10 row(s)</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Kafka-2-ElasticSearch"><a href="#Kafka-2-ElasticSearch" class="headerlink" title="Kafka 2 ElasticSearch"></a><a href="https://github.com/confluentinc/kafka-connect-elasticsearch">Kafka 2 ElasticSearch</a></h4><h5 id="特性-2"><a href="#特性-2" class="headerlink" title="特性"></a><a href="https://docs.confluent.io/current/connect/connect-elasticsearch/docs/elasticsearch_connector.html">特性</a></h5><h6 id="Exactly-Once-Delivery-1"><a href="#Exactly-Once-Delivery-1" class="headerlink" title="Exactly Once Delivery"></a><strong>Exactly Once Delivery</strong></h6><p>　Connect 使用 ElasticSearch 的幂等写入语句和设置 ES Document IDs，来确保写入 ES 的数据都是<strong>有且仅有一条</strong>的<br>　如果 Kafka 消息里面包含了 Key 值，那么这些 Key 值会自动转化为 ES Document IDs；相反，如果 Kafka 消息里面没有包含这些 Key 值，或者是明确指定不要使用 Kafka 消息里面的 Key 值，Kafka Connect 将会自动使用 <code>topic+partition+offset</code> 作为 Key 值，以确保每一条写入 ES 的数据，都有一个唯一对应的 Document</p>
<h6 id="Mapping-Inference"><a href="#Mapping-Inference" class="headerlink" title="Mapping Inference"></a><strong>Mapping Inference</strong></h6><p>　启用该功能时，Connector 可以<strong>自动</strong>依据 Schema Register 来<strong>推断</strong> ES <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping.html">mapping</a> 结构<br>　但是，该功能的推断受限于 field 类型和默认值。如果需要增加更多的限制（例如，用户自定义的解析器），则需要自己手动创建 mapping</p>
<h6 id="Schema-Evolution-1"><a href="#Schema-Evolution-1" class="headerlink" title="Schema Evolution"></a><strong>Schema Evolution</strong></h6><p>　支持<strong>模式演进</strong>和不同的 Schema 兼容级别<br>　可以处理一些模式不兼容的更改，比如</p>
<ul>
<li><p>增加字段</p>
<p>当增加一个或者多个 field 到 Kafka 消息中，并且 ES 开启了 <code>dynamic mapping</code> 功能，那么 ES 将会自动增加新的 field 到 mapping 中</p>
</li>
<li><p>移除字段</p>
<p>当从 Kafka 消息中移除一个或者多个 field 时，则这些缺失的值，将会被作为 <code>null</code> 值进行处理</p>
</li>
<li><p>更改字段类型</p>
<p>例如将一个 field 从 <code>string</code> 改成 <code>integer</code> 类型，ES 将会自动将 <code>string</code> 转化为 <code>integer</code></p>
</li>
</ul>
<h6 id="Delivery-Semantics"><a href="#Delivery-Semantics" class="headerlink" title="Delivery Semantics"></a><strong>Delivery Semantics</strong></h6><p>　Connector 支持 <strong>batch</strong> 和 <strong>pipeline</strong> 两种写入 ES 的模式，以此来增加吞吐量。batch 模式下，允许并行地处理多个 batch<br>　通过使用分区级 Kafka 偏移量作为 ES <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-index_.html#index-versioning">文档版本</a>，并使用 <code>version_mode = external</code> 配置，来确保文档级（Document-level）更新顺序</p>
<h6 id="Reindexing-with-Zero-Downtime"><a href="#Reindexing-with-Zero-Downtime" class="headerlink" title="Reindexing with Zero Downtime"></a><strong>Reindexing with Zero Downtime</strong></h6><p>　利用 ES 的 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-reindex.html">Index Aliases</a> 接口，可以完成零停机 reindexing 操作（ES 本身提供了 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-reindex.html">Reindex</a> 接口，不过性能不高），具体对 ES 集群操作的步骤如下</p>
<ol>
<li>Create an alias for the index with the old mapping.</li>
<li>The applications that uses the index are pointed to the alias.</li>
<li>Create a new index with the updated mapping.</li>
<li>Move data from old to the new index.</li>
<li>Atomically move the alias to the new index.</li>
<li>Delete the old index.</li>
</ol>
<p>　为了保证用户无感知，需要在 reindexing 期间，仍然可以处理写数据的请求。但是别名是无法同时往新旧 index 写入数据的。为了解决这个问题，可以使用两个 ElasticSearch Connector 同时将相同的数据，写入到新旧 index 中，具体对 ES Connector 的操作步骤如下</p>
<ol>
<li>The connector job that ingest data to the old indices continue writing to the old indices.</li>
<li>Create a new connector job that writes to new indices. This will copy both some old data and new data to the new indices as long as the data is in Kafka.</li>
<li>Once the data in the old indices are moved to the new indices by the reindexing process, we can stop the old connector job.</li>
</ol>
<h5 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h5><h6 id="安装-ElasticSearch"><a href="#安装-ElasticSearch" class="headerlink" title="安装 ElasticSearch"></a>安装 ElasticSearch</h6><p>　此处略写，详见我的另一篇博客《<a href="https://yuzhouwan.com/posts/22654/#安装">ElasticSearch</a>》</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 下载</span></span><br><span class="line">$ <span class="built_in">cd</span> ~/install</span><br><span class="line">$ curl -L -O https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.6.4.tar.gz</span><br><span class="line">$ tar zxvf elasticsearch-5.6.4.tar.gz -C ~/software/</span><br><span class="line">$ <span class="built_in">cd</span> ~/software</span><br><span class="line">$ ln -s elasticsearch-5.6.4/ elasticsearch</span><br><span class="line"></span><br><span class="line"><span class="comment"># 环境变量</span></span><br><span class="line">$ vim ~/.bashrc</span><br><span class="line">  <span class="built_in">export</span> JAVA_HOME=~/software/java</span><br><span class="line">  <span class="built_in">export</span> ELASTIC_SEARCH_HOME=~/software/elasticsearch</span><br><span class="line">  <span class="built_in">export</span> PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$ELASTIC_SEARCH_HOME</span>/bin:<span class="variable">$PATH</span></span><br><span class="line">$ <span class="built_in">source</span> ~/.bashrc</span><br><span class="line">$ elasticsearch -version</span><br><span class="line">  Version: 5.6.4, Build: 8bbedf5/2017-10-31T18:55:38.105Z, JVM: 1.8.0_131</span><br><span class="line"></span><br><span class="line"><span class="comment"># 后台启动</span></span><br><span class="line">$ elasticsearch -Ecluster.name=yuzhouwan -Enode.name=yuzhouwan_kafka_connect_test -d</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查</span></span><br><span class="line">$ jps -ml</span><br><span class="line">  25332 org.elasticsearch.bootstrap.Elasticsearch -Ecluster.name=yuzhouwan -Enode.name=yuzhouwan_kafka_connect_test -d</span><br><span class="line">$ netstat -nap | grep 9200</span><br><span class="line">  tcp        0      0 ::ffff:127.0.0.1:9200       :::*                        LISTEN      25332/java</span><br><span class="line">  tcp        0      0 ::1:9200                    :::*                        LISTEN      25332/java</span><br><span class="line"></span><br><span class="line">$ curl -XGET <span class="string">'http://localhost:9200/_cluster/health'</span> | jq</span><br><span class="line">  {</span><br><span class="line">    <span class="string">"cluster_name"</span>: <span class="string">"yuzhouwan"</span>,</span><br><span class="line">    <span class="string">"status"</span>: <span class="string">"yellow"</span>,</span><br><span class="line">    <span class="string">"timed_out"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"number_of_nodes"</span>: 1,</span><br><span class="line">    <span class="string">"number_of_data_nodes"</span>: 1,</span><br><span class="line">    <span class="string">"active_primary_shards"</span>: 5,</span><br><span class="line">    <span class="string">"active_shards"</span>: 5,</span><br><span class="line">    <span class="string">"relocating_shards"</span>: 0,</span><br><span class="line">    <span class="string">"initializing_shards"</span>: 0,</span><br><span class="line">    <span class="string">"unassigned_shards"</span>: 5,</span><br><span class="line">    <span class="string">"delayed_unassigned_shards"</span>: 0,</span><br><span class="line">    <span class="string">"number_of_pending_tasks"</span>: 0,</span><br><span class="line">    <span class="string">"number_of_in_flight_fetch"</span>: 0,</span><br><span class="line">    <span class="string">"task_max_waiting_in_queue_millis"</span>: 0,</span><br><span class="line">    <span class="string">"active_shards_percent_as_number"</span>: 50</span><br><span class="line">  }</span><br></pre></td></tr></tbody></table></figure>
<h6 id="配置-Confluent-2"><a href="#配置-Confluent-2" class="headerlink" title="配置 Confluent"></a><a href="https://github.com/confluentinc/kafka-connect-elasticsearch/blob/master/docs/configuration_options.rst">配置</a> Confluent</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim etc/kafka-connect-elasticsearch/quickstart-elasticsearch.properties</span><br><span class="line">  name=elasticsearch-sink</span><br><span class="line">  connector.class=io.confluent.connect.elasticsearch.ElasticsearchSinkConnector</span><br><span class="line">  tasks.max=1</span><br><span class="line">  topics=<span class="built_in">test</span>-elasticsearch-sink</span><br><span class="line">  key.ignore=<span class="literal">true</span></span><br><span class="line">  connection.url=http://localhost:9200</span><br><span class="line">  type.name=kafka-connect</span><br></pre></td></tr></tbody></table></figure>
<h6 id="启用-2"><a href="#启用-2" class="headerlink" title="启用"></a>启用</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/software/confluent</span><br><span class="line">$ ./bin/zookeeper-server-start ./etc/kafka/zookeeper.properties</span><br><span class="line">$ ./bin/kafka-server-start ./etc/kafka/server.properties</span><br><span class="line">$ ./bin/schema-registry-start ./etc/schema-registry/schema-registry.properties</span><br><span class="line">$ ./bin/kafka-rest-start ./etc/kafka-rest/kafka-rest.properties</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> ~/software/confluent</span><br><span class="line">$ ./bin/kafka-avro-console-producer --broker-list localhost:9092 --topic <span class="built_in">test</span>-elasticsearch-sink --property value.schema=<span class="string">'{"type":"record","name":"myrecord","fields":[{"name":"f1","type":"string"}]}'</span></span><br><span class="line">  <span class="comment"># 输入一下三行数据</span></span><br><span class="line">  {<span class="string">"f1"</span>: <span class="string">"value1"</span>}</span><br><span class="line">  {<span class="string">"f1"</span>: <span class="string">"value2"</span>}</span><br><span class="line">  {<span class="string">"f1"</span>: <span class="string">"value3"</span>}</span><br><span class="line"></span><br><span class="line">$ ./bin/connect-standalone etc/schema-registry/connect-avro-standalone.properties etc/kafka-connect-elasticsearch/quickstart-elasticsearch.properties</span><br><span class="line"></span><br><span class="line">$ confluent load elasticsearch-sink | jq</span><br><span class="line">  {</span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"elasticsearch-sink"</span>,</span><br><span class="line">    <span class="string">"config"</span>: {</span><br><span class="line">      <span class="string">"connector.class"</span>: <span class="string">"io.confluent.connect.elasticsearch.ElasticsearchSinkConnector"</span>,</span><br><span class="line">      <span class="string">"tasks.max"</span>: <span class="string">"1"</span>,</span><br><span class="line">      <span class="string">"topics"</span>: <span class="string">"test-elasticsearch-sink"</span>,</span><br><span class="line">      <span class="string">"key.ignore"</span>: <span class="string">"true"</span>,</span><br><span class="line">      <span class="string">"connection.url"</span>: <span class="string">"http://localhost:9200"</span>,</span><br><span class="line">      <span class="string">"type.name"</span>: <span class="string">"kafka-connect"</span>,</span><br><span class="line">      <span class="string">"name"</span>: <span class="string">"elasticsearch-sink"</span></span><br><span class="line">    },</span><br><span class="line">    <span class="string">"tasks"</span>: [</span><br><span class="line">      {</span><br><span class="line">        <span class="string">"connector"</span>: <span class="string">"elasticsearch-sink"</span>,</span><br><span class="line">        <span class="string">"task"</span>: 0</span><br><span class="line">      }</span><br><span class="line">    ]</span><br><span class="line">  }</span><br></pre></td></tr></tbody></table></figure>
<h6 id="验证-2"><a href="#验证-2" class="headerlink" title="验证"></a>验证</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ curl -XGET <span class="string">'http://localhost:9200/test-elasticsearch-sink/_search?pretty'</span></span><br><span class="line">  {</span><br><span class="line">    <span class="string">"took"</span> : 2,</span><br><span class="line">    <span class="string">"timed_out"</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"_shards"</span> : {</span><br><span class="line">      <span class="string">"total"</span> : 5,</span><br><span class="line">      <span class="string">"successful"</span> : 5,</span><br><span class="line">      <span class="string">"skipped"</span> : 0,</span><br><span class="line">      <span class="string">"failed"</span> : 0</span><br><span class="line">    },</span><br><span class="line">    <span class="string">"hits"</span> : {</span><br><span class="line">      <span class="string">"total"</span> : 3,</span><br><span class="line">      <span class="string">"max_score"</span> : 1.0,</span><br><span class="line">      <span class="string">"hits"</span> : [</span><br><span class="line">        {</span><br><span class="line">          <span class="string">"_index"</span> : <span class="string">"test-elasticsearch-sink"</span>,</span><br><span class="line">          <span class="string">"_type"</span> : <span class="string">"kafka-connect"</span>,</span><br><span class="line">          <span class="string">"_id"</span> : <span class="string">"test-elasticsearch-sink+0+0"</span>,</span><br><span class="line">          <span class="string">"_score"</span> : 1.0,</span><br><span class="line">          <span class="string">"_source"</span> : {</span><br><span class="line">            <span class="string">"f1"</span> : <span class="string">"value1"</span></span><br><span class="line">          }</span><br><span class="line">        },</span><br><span class="line">        {</span><br><span class="line">          <span class="string">"_index"</span> : <span class="string">"test-elasticsearch-sink"</span>,</span><br><span class="line">          <span class="string">"_type"</span> : <span class="string">"kafka-connect"</span>,</span><br><span class="line">          <span class="string">"_id"</span> : <span class="string">"test-elasticsearch-sink+0+2"</span>,</span><br><span class="line">          <span class="string">"_score"</span> : 1.0,</span><br><span class="line">          <span class="string">"_source"</span> : {</span><br><span class="line">            <span class="string">"f1"</span> : <span class="string">"value3"</span></span><br><span class="line">          }</span><br><span class="line">        },</span><br><span class="line">        {</span><br><span class="line">          <span class="string">"_index"</span> : <span class="string">"test-elasticsearch-sink"</span>,</span><br><span class="line">          <span class="string">"_type"</span> : <span class="string">"kafka-connect"</span>,</span><br><span class="line">          <span class="string">"_id"</span> : <span class="string">"test-elasticsearch-sink+0+1"</span>,</span><br><span class="line">          <span class="string">"_score"</span> : 1.0,</span><br><span class="line">          <span class="string">"_source"</span> : {</span><br><span class="line">            <span class="string">"f1"</span> : <span class="string">"value2"</span></span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      ]</span><br><span class="line">    }</span><br><span class="line">  }</span><br></pre></td></tr></tbody></table></figure>
<h5 id="踩过的坑"><a href="#踩过的坑" class="headerlink" title="踩过的坑"></a>踩过的坑</h5><h6 id="max-file-descriptors-32768-for-elasticsearch-process-is-too-low-increase-to-at-least-65536"><a href="#max-file-descriptors-32768-for-elasticsearch-process-is-too-low-increase-to-at-least-65536" class="headerlink" title="max file descriptors [32768] for elasticsearch process is too low, increase to at least [65536]"></a>max file descriptors [32768] for elasticsearch process is too low, increase to at least [65536]</h6><ul>
<li>解决</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ su root</span><br><span class="line">$ vim /etc/security/limits.d/90-nproc.conf</span><br><span class="line">  *    -    nproc      20480</span><br><span class="line">  *    -    nofile     65536</span><br><span class="line">  *    -    memlock    unlimited</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Kafka-2-Druid"><a href="#Kafka-2-Druid" class="headerlink" title="Kafka 2 Druid"></a><a href="https://github.com/gianm/kafka-connect-druid">Kafka 2 Druid</a></h4><p>　官方<a href="https://github.com/gianm/kafka-connect-druid/issues/1">决定</a>使用 <a href="http://druid.io/docs/latest/development/extensions-core/kafka-ingestion.html">Kafka Indexing Service</a> 方案，方便构建自己的生态圈。不过，目前的 Kafka Indexing Service 仍然存在一定的<a href="https://groups.google.com/forum/#!topic/druid-user/S7UKNsSCMGI">缺陷</a>。因此，Kafka Connect 2 <a href="https://yuzhouwan.com/posts/5845/">Druid</a> 功能需要自己基于 Druid Tranquility 组件进行定制开发。同时，可以在关闭 Kafka Auto Commit 功能后，自己控制事务提交，来保证不丢不重，进而弥补了 Tranquility 组件没有 Exactly-once 特性的缺陷</p>
<p>Tips: <a href="https://github.com/Landoop/stream-reactor">Stream Reactor</a> 中基于 Tranquility 实现了 K2D</p>
<h4 id="Kafka-2-Kafka"><a href="#Kafka-2-Kafka" class="headerlink" title="Kafka 2 Kafka"></a><a href="https://docs.confluent.io/current/connect/connect-replicator/docs/connect_replicator.html">Kafka 2 Kafka</a></h4><p>　Connect Replicator 可以轻松可靠地将 Topic 从一个 Kafka 集群复制到另一个。除了复制消息之外，此连接器还会根据需要创建主题，以保留源群集中的 Topic 配置。这包括保留分区数量，副本数以及为单个 Topic 指定对任何配置的覆盖</p>
<p>　下图显示了一个典型的<strong>多数据中心</strong>（<strong>D</strong>ata <strong>C</strong>enter）部署，其中来自位于不同数据中心的两个 Kafka 群集的数据聚合在位于另一个数据中心的单独群集中。这里，复制数据的来源称为<strong>源簇</strong>，而复制数据的目标称为<strong>目的地</strong></p>
<h5 id="特性-3"><a href="#特性-3" class="headerlink" title="特性"></a>特性</h5><ul>
<li>Topic 的选择，可以使用白名单、黑名单和正则表达式</li>
<li>支持使用匹配的 Partition 数量、 Replicaton 因子和 Topic 配置覆盖，在目标集群动态创建 Topic</li>
<li>当新的 partition 被加入到源集群之后，目标集群会自动扩容对应的 Topic</li>
<li>其他源集群的配置更改，都会被自动同步到目标集群</li>
</ul>
<h3 id="单机版-Worker"><a href="#单机版-Worker" class="headerlink" title="单机版 Worker"></a>单机版 Worker</h3><h4 id="启动-1"><a href="#启动-1" class="headerlink" title="启动"></a>启动</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ bin/connect-standalone worker.properties connector1.properties [connector2.properties connector3.properties ...]</span><br></pre></td></tr></tbody></table></figure>
<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 存储 connector 的 offset</span></span><br><span class="line">offset.storage.file.filename</span><br><span class="line"></span><br><span class="line"><span class="comment"># RESTful 端口，接受 HTTP 请求</span></span><br><span class="line">rest.port</span><br></pre></td></tr></tbody></table></figure>
<p>Tips: 单机模式下，偏移量 offset 保存在 <code>/tmp/connect.offset</code> 中</p>
<h3 id="分布式-Worker"><a href="#分布式-Worker" class="headerlink" title="分布式 Worker"></a>分布式 Worker</h3><h4 id="启动-Confluent"><a href="#启动-Confluent" class="headerlink" title="启动 Confluent"></a>启动 Confluent</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/software/confluent</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 ZooKeeper</span></span><br><span class="line">$ nohup ./bin/zookeeper-server-start ./etc/kafka/zookeeper.properties &gt; zookeeper.log &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 Kafka</span></span><br><span class="line">$ nohup ./bin/kafka-server-start ./etc/kafka/server.properties &gt; kafka.log &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 Schema Registry</span></span><br><span class="line">$ nohup ./bin/schema-registry-start ./etc/schema-registry/schema-registry.properties &gt; schema.log &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 Kafka REST</span></span><br><span class="line">$ nohup ./bin/kafka-rest-start ./etc/kafka-rest/kafka-rest.properties &gt; kafka-rest.log &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 以分布式模式启动 Connect</span></span><br><span class="line">$ nohup ./bin/connect-distributed ./etc/kafka/connect-distributed.properties &gt; connect-distribute.log &amp;</span><br></pre></td></tr></tbody></table></figure>
<h4 id="创建-Topic"><a href="#创建-Topic" class="headerlink" title="创建 Topic"></a>创建 Topic</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 获取帮助文档</span></span><br><span class="line">$ bin/kafka-topics --<span class="built_in">help</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 connect-configs / connect-offsets / connect-status 三个 Topic</span></span><br><span class="line"><span class="comment"># connect-configs 存储 connector 和 task 的配置信息</span></span><br><span class="line">$ bin/kafka-topics --create --zookeeper localhost:2181 --topic connect-configs --replication-factor 3 --partitions 1 --config cleanup.policy=compact</span><br><span class="line"><span class="comment"># connect-offsets 存储 connector 和 task 的 offset 信息</span></span><br><span class="line">$ bin/kafka-topics --create --zookeeper localhost:2181 --topic connect-offsets --replication-factor 3 --partitions 50 --config cleanup.policy=compact</span><br><span class="line"><span class="comment"># connect-status 存储 connector 和 task 的状态变更信息</span></span><br><span class="line">$ bin/kafka-topics --create --zookeeper localhost:2181 --topic connect-status --replication-factor 3 --partitions 10 --config cleanup.policy=compact</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看已存在的 topic</span></span><br><span class="line">$ bin/kafka-topics --list --zookeeper localhost:2181</span><br><span class="line">  __consumer_offsets</span><br><span class="line">  _schemas</span><br><span class="line">  connect-configs</span><br><span class="line">  connect-offsets</span><br><span class="line">  connect-statuses</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查 topic 状态</span></span><br><span class="line">$ bin/kafka-topics --describe --zookeeper localhost:2181 --topic connect-configs</span><br><span class="line">  Topic:connect-configs  PartitionCount:1  ReplicationFactor:1   Configs:</span><br><span class="line">  Topic:connect-configs  Partition: 0      Leader: 0    Replicas: 0   Isr: 0</span><br></pre></td></tr></tbody></table></figure>
<h4 id="删除-Topic"><a href="#删除-Topic" class="headerlink" title="删除 Topic"></a>删除 Topic</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim etc/kafka/server.properties</span><br><span class="line">  <span class="comment"># 如果需要删除 topic，需要先设置 delete.topic.enable 为 true</span></span><br><span class="line">  delete.topic.enable=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">$ bin/kafka-topics --delete --zookeeper localhost:2181 --topic connect-configs</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Connector-和-Task-状态"><a href="#Connector-和-Task-状态" class="headerlink" title="Connector 和 Task 状态"></a><a href="https://docs.confluent.io/current/connect/managing.html#connector-and-task-status">Connector 和 Task 状态</a></h4><p>　所有 Connector 和隶属于这些 Connector 的 Tasks，都通过 <code>status.storage.topic</code> 发布状态更新。因为 Worker 消费 <code>status.storage.topic</code> 是异步的，所以从 API 获取最新状态的时候，会存在一些短暂的延迟</p>
<p>　Connector 或者某个 Task 的状态，可能为：</p>
<ul>
<li><p><strong>UNASSIGNED</strong></p>
<p>Connector 或者 Task 尚未被分配到某个 Worker 上</p>
</li>
<li><p><strong>RUNNING</strong></p>
<p>运行中</p>
</li>
<li><p><strong>PAUSED</strong></p>
<p>Connector 或者 Task 被管理员暂停</p>
</li>
<li><p><strong>FAILED</strong></p>
<p>通常因为出现异常，导致 Connector 或者 Task 失败</p>
</li>
</ul>
<p>　一般 Pause / Resume API 的操作，适用的场景是 消费端系统需要维护，通过停止掉 Kafka Connector，来避免数据一直被积压着。同时，停止操作不是临时的，即便重启了集群，仍需要再次操作 Resume 接口，暂停的 Connector 才会恢复到 Running 状态。另外，FAILED 状态的任务是不允许执行 Pause 操作的，需要重启恢复到 Running 状态才行</p>
<h4 id="Worker-之间如何建立通讯"><a href="#Worker-之间如何建立通讯" class="headerlink" title="Worker 之间如何建立通讯"></a>Worker 之间如何建立通讯</h4><p>　只要保证各个 Worker 使用的是统一的 <code>group.id</code>（可以看做是 Cluster Name），还有 <code>config.storage.topic</code>、<code>offset.storage.topic</code> 和 <code>status.storage.topic</code> 三个 Topic 也需要保持一致，Worker 就会自动发现同一个集群中的其他 Worker 进程</p>
<h4 id="Relance-机制"><a href="#Relance-机制" class="headerlink" title="Relance 机制"></a>Relance 机制</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">[2017-12-04 11:32:18,607] INFO Rebalance started (org.apache.kafka.connect.runtime.distributed.DistributedHerder:1187)</span><br><span class="line">[2017-12-04 11:32:18,608] INFO Finished stopping tasks <span class="keyword">in</span> preparation <span class="keyword">for</span> rebalance (org.apache.kafka.connect.runtime.distributed.DistributedHerder:1217)</span><br><span class="line">[2017-12-04 11:32:18,608] INFO (Re-)joining group connect-cluster (org.apache.kafka.clients.consumer.internals.AbstractCoordinator:442)</span><br><span class="line">[2017-12-04 11:32:18,612] INFO Successfully joined group connect-cluster with generation 2 (org.apache.kafka.clients.consumer.internals.AbstractCoordinator:409)</span><br><span class="line">[2017-12-04 11:32:18,612] INFO Joined group and got assignment: Assignment{error=0, leader=<span class="string">'connect-1-efb9e92c-27a6-4062-9fcc-92480f8e9e03'</span>, leaderUrl=<span class="string">'http://192.168.1.101:8083/'</span>, offset=-1, connectorIds=[], taskIds=[]} (org.apache.kafka.connect.runtime.distributed.DistributedHerder:1166)</span><br><span class="line">[2017-12-04 11:32:18,612] INFO Starting connectors and tasks using config offset -1 (org.apache.kafka.connect.runtime.distributed.DistributedHerder:815)</span><br><span class="line">[2017-12-04 11:32:18,613] INFO Finished starting connectors and tasks (org.apache.kafka.connect.runtime.distributed.DistributedHerder:825)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="完全分布式"><a href="#完全分布式" class="headerlink" title="完全分布式"></a>完全分布式</h3><h4 id="替换原生的-ZooKeeper"><a href="#替换原生的-ZooKeeper" class="headerlink" title="替换原生的 ZooKeeper"></a>替换原生的 ZooKeeper</h4><p>　具体安装过程略，详见我的另一篇博客《<a href="https://yuzhouwan.com/posts/31915/#环境搭建">ZooKeeper 原理与优化</a>》</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/connect/software/confluent</span><br><span class="line">$ vim ./etc/kafka/server.properties</span><br><span class="line">  zookeeper.connect=192.168.1.101:2181,192.168.1.102:2181,192.168.1.103:2181</span><br><span class="line">  zookeeper.connection.timeout.ms=6000</span><br><span class="line"></span><br><span class="line">$ vim ./etc/schema-registry/connect-avro-distributed.properties</span><br><span class="line">  id=kafka-rest-test-server</span><br><span class="line">  schema.registry.url=http://localhost:8081</span><br><span class="line">  zookeeper.connect=192.168.1.101:2181,192.168.1.102:2181,192.168.1.103:2181</span><br><span class="line"></span><br><span class="line">$ zkServer.sh start</span><br></pre></td></tr></tbody></table></figure>
<h4 id="替换原生的-Kafka"><a href="#替换原生的-Kafka" class="headerlink" title="替换原生的 Kafka"></a>替换原生的 Kafka</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 创建日志目录</span></span><br><span class="line">$ mkdir -p /home/connect/kafka_log</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> /home/connect/software/kafka</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 Kafka Server</span></span><br><span class="line">$ vim config/server.properties</span><br><span class="line">  <span class="comment"># 每个 Kafka Broker 节点，配置不同的 broker.id</span></span><br><span class="line">  broker.id=0</span><br><span class="line">  <span class="comment"># 允许删除 topic</span></span><br><span class="line">  delete.topic.enable=<span class="literal">true</span></span><br><span class="line">  <span class="comment"># 配置成当前 Kafka Borker 节点的 IP</span></span><br><span class="line">  listeners=PLAINTEXT://192.168.1.101:9092</span><br><span class="line">  advertised.listeners=PLAINTEXT://192.168.1.101:9092</span><br><span class="line">  log.dirs=/home/connect/kafka_log</span><br><span class="line">  zookeeper.connect=192.168.1.101:2181,192.168.1.102:2181,192.168.1.103:2181</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 Kafka ZooKeeper</span></span><br><span class="line">$ vim config/zookeeper.properties</span><br><span class="line">  dataDir=/home/connect/zkdata</span><br><span class="line">  clientPort=2181</span><br><span class="line">  maxClientCnxns=60</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 Kafka Consumer</span></span><br><span class="line">$ vim config/consumer.properties</span><br><span class="line">  zookeeper.connect=192.168.1.101:2181,192.168.1.102:2181,192.168.1.103:2181</span><br><span class="line">  zookeeper.connection.timeout.ms=6000</span><br><span class="line">  group.id=<span class="built_in">test</span>-consumer-group</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 Kafka</span></span><br><span class="line">$ nohup /home/connect/software/kafka/bin/kafka-server-start.sh /home/connect/software/kafka/config/server.properties &gt; /home/connect/kafka_log/kafka.server.log 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Kafka 日志</span></span><br><span class="line">$ tail -f ~/kafka_log/kafka.server.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新 Confluent 配置</span></span><br><span class="line">$ <span class="built_in">cd</span> /home/connect/software/confluent</span><br><span class="line">$ vim etc/kafka/connect-distributed.properties</span><br><span class="line">  bootstrap.servers=192.168.1.101:9092,192.168.1.102:9092,192.168.1.103:9092</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 connect-configs / connect-offsets / connect-status 三个 Topic</span></span><br><span class="line"><span class="comment"># connect-configs 存储 connector 和 task 的配置信息</span></span><br><span class="line">$ bin/kafka-topics.sh --create --zookeeper 192.168.1.101:2181,192.168.1.102:2181,192.168.1.103:2181 --topic connect-configs --replication-factor 3 --partitions 1 --config cleanup.policy=compact</span><br><span class="line"><span class="comment"># connect-offsets 存储 connector 和 task 的 offset 信息</span></span><br><span class="line">$ bin/kafka-topics.sh --create --zookeeper 192.168.1.101:2181,192.168.1.102:2181,192.168.1.103:2181 --topic connect-offsets --replication-factor 3 --partitions 1 --config cleanup.policy=compact</span><br><span class="line"><span class="comment"># connect-status 存储 connector 和 task 的状态变更信息</span></span><br><span class="line">$ bin/kafka-topics.sh --create --zookeeper 192.168.1.101:2181,192.168.1.102:2181,192.168.1.103:2181 --topic connect-status --replication-factor 3 --partitions 1 --config cleanup.policy=compact</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看已存在的 topic</span></span><br><span class="line">$ bin/kafka-topics.sh --list --zookeeper 192.168.1.101:2181,192.168.1.102:2181,192.168.1.103:2181</span><br><span class="line">  __consumer_offsets</span><br><span class="line">  connect-configs</span><br><span class="line">  connect-offsets</span><br><span class="line">  connect-status</span><br><span class="line">  <span class="built_in">test</span>-elasticsearch-sink</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查 topic 状态</span></span><br><span class="line">$ bin/kafka-topics --describe --zookeeper 192.168.1.101:2181,192.168.1.102:2181,192.168.1.103:2181 --topic connect-configs</span><br><span class="line">  Topic:connect-configs   PartitionCount:1  ReplicationFactor:3   Configs:cleanup.policy=compact</span><br><span class="line">  Topic:connect-configs   Partition: 0      Leader: 2             Replicas: 0,2,1     Isr: 2,0,1</span><br></pre></td></tr></tbody></table></figure>
<h4 id="更新-Kafka-Rest-配置"><a href="#更新-Kafka-Rest-配置" class="headerlink" title="更新 Kafka Rest 配置"></a>更新 Kafka Rest 配置</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/connect/software/confluent</span><br><span class="line">$ vim etc/kafka-rest/kafka-rest.properties</span><br><span class="line">  id=kafka-rest-test-server</span><br><span class="line">  schema.registry.url=http://192.168.1.103:8081</span><br><span class="line">  zookeeper.connect=192.168.1.101:2181,192.168.1.102:2181,192.168.1.103:2181</span><br><span class="line"></span><br><span class="line">$ nohup ./bin/kafka-rest-start ./etc/kafka-rest/kafka-rest.properties &amp;</span><br></pre></td></tr></tbody></table></figure>
<h4 id="更新-Schema-Register-配置"><a href="#更新-Schema-Register-配置" class="headerlink" title="更新 Schema Register 配置"></a>更新 Schema Register 配置</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/connect/software/confluent</span><br><span class="line">$ vim etc/schema-registry/schema-registry.properties</span><br><span class="line">  listeners=http://0.0.0.0:8081</span><br><span class="line">  kafkastore.connection.url=192.168.1.101:2181,192.168.1.102:2181,192.168.1.103:2181</span><br><span class="line">  kafkastore.topic=_schemas</span><br><span class="line">  debug=<span class="literal">false</span></span><br><span class="line"></span><br><span class="line">$ nohup ./bin/schema-registry-start ./etc/schema-registry/schema-registry.properties &amp;</span><br><span class="line">$ tail -f logs/schema-registry.log</span><br></pre></td></tr></tbody></table></figure>
<h4 id="更新-Worker-配置"><a href="#更新-Worker-配置" class="headerlink" title="更新 Worker 配置"></a>更新 Worker 配置</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim /home/connect/software/confluent/etc/kafka/connect-distributed.properties</span><br><span class="line"></span><br><span class="line">  bootstrap.servers=192.168.1.101:9092,192.168.1.102:9092,192.168.1.103:9092</span><br><span class="line"></span><br><span class="line">  group.id=connect-cluster</span><br><span class="line">  key.converter=org.apache.kafka.connect.json.JsonConverter</span><br><span class="line">  value.converter=org.apache.kafka.connect.json.JsonConverter</span><br><span class="line">  <span class="comment"># 考虑到方便压测，可以关闭 schema 功能，将下面两个配置项置为 false</span></span><br><span class="line">  key.converter.schemas.enable=<span class="literal">true</span></span><br><span class="line">  value.converter.schemas.enable=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  internal.key.converter=org.apache.kafka.connect.json.JsonConverter</span><br><span class="line">  internal.value.converter=org.apache.kafka.connect.json.JsonConverter</span><br><span class="line">  internal.key.converter.schemas.enable=<span class="literal">false</span></span><br><span class="line">  internal.value.converter.schemas.enable=<span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  key.converter=io.confluent.connect.avro.AvroConverter</span><br><span class="line">  key.converter.schema.registry.url=http://192.168.1.103:8081</span><br><span class="line">  value.converter=io.confluent.connect.avro.AvroConverter</span><br><span class="line">  value.converter.schema.registry.url=http://192.168.1.103:8081</span><br><span class="line"></span><br><span class="line">$ nohup /home/connect/software/confluent/bin/connect-distributed /home/connect/software/confluent/etc/kafka/connect-distributed.properties &gt; /home/connect/software/confluent/logs/connect-distributed.log &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分发配置，并在各节点启动 worker</span></span><br><span class="line">$ scp /home/connect/software/confluent/etc/schema-registry/connect-avro-distributed.properties 192.168.1.102:/home/connect/software/confluent/etc/schema-registry/connect-avro-distributed.properties</span><br><span class="line"></span><br><span class="line">$ scp /home/connect/software/confluent/etc/schema-registry/connect-avro-distributed.properties 192.168.1.103:/home/connect/software/confluent/etc/schema-registry/connect-avro-distributed.properties</span><br></pre></td></tr></tbody></table></figure>
<h4 id="踩过的坑-1"><a href="#踩过的坑-1" class="headerlink" title="踩过的坑"></a>踩过的坑</h4><h5 id="WARNING-REMOTE-HOST-IDENTIFICATION-HAS-CHANGED"><a href="#WARNING-REMOTE-HOST-IDENTIFICATION-HAS-CHANGED" class="headerlink" title="WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!"></a>WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!</h5><h6 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim .ssh/known_hosts</span><br><span class="line">  <span class="comment"># 删除本机 IP 下的秘钥</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="Timed-out-while-checking-for-or-creating-topic-s-‘connect-offsets’"><a href="#Timed-out-while-checking-for-or-creating-topic-s-‘connect-offsets’" class="headerlink" title="Timed out while checking for or creating topic(s) ‘connect-offsets’"></a>Timed out while checking for or creating topic(s) ‘connect-offsets’</h5><h6 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h6><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">[<span class="number">2017</span>-<span class="number">12</span>-<span class="number">01</span> <span class="number">17</span>:<span class="number">39</span>:<span class="number">13</span>,<span class="number">503</span>] ERROR Uncaught exception in herder work thread, exiting:  (org.apache.kafka.connect.runtime.distributed.DistributedHerder:<span class="number">206</span>)</span><br><span class="line">org.apache.kafka.connect.errors.ConnectException: <span class="function">Timed out <span class="keyword">while</span> checking <span class="keyword">for</span> or creating <span class="title">topic</span><span class="params">(s)</span> 'connect-offsets'. This could indicate a connectivity issue, unavailable topic partitions, or <span class="keyword">if</span> <span class="keyword">this</span> is your first use of the topic it may have taken too <span class="keyword">long</span> to create.</span></span><br><span class="line"><span class="function">	at org.apache.kafka.connect.util.TopicAdmin.<span class="title">createTopics</span><span class="params">(TopicAdmin.java:<span class="number">243</span>)</span></span></span><br><span class="line"><span class="function">	at org.apache.kafka.connect.storage.KafkaOffsetBackingStore$1.<span class="title">run</span><span class="params">(KafkaOffsetBackingStore.java:<span class="number">99</span>)</span></span></span><br><span class="line"><span class="function">	at org.apache.kafka.connect.util.KafkaBasedLog.<span class="title">start</span><span class="params">(KafkaBasedLog.java:<span class="number">126</span>)</span></span></span><br><span class="line"><span class="function">	at org.apache.kafka.connect.storage.KafkaOffsetBackingStore.<span class="title">start</span><span class="params">(KafkaOffsetBackingStore.java:<span class="number">109</span>)</span></span></span><br><span class="line"><span class="function">	at org.apache.kafka.connect.runtime.Worker.<span class="title">start</span><span class="params">(Worker.java:<span class="number">146</span>)</span></span></span><br><span class="line"><span class="function">	at org.apache.kafka.connect.runtime.AbstractHerder.<span class="title">startServices</span><span class="params">(AbstractHerder.java:<span class="number">99</span>)</span></span></span><br><span class="line"><span class="function">	at org.apache.kafka.connect.runtime.distributed.DistributedHerder.<span class="title">run</span><span class="params">(DistributedHerder.java:<span class="number">194</span>)</span></span></span><br><span class="line"><span class="function">	at java.util.concurrent.Executors$RunnableAdapter.<span class="title">call</span><span class="params">(Executors.java:<span class="number">511</span>)</span></span></span><br><span class="line"><span class="function">	at java.util.concurrent.FutureTask.<span class="title">run</span><span class="params">(FutureTask.java:<span class="number">266</span>)</span></span></span><br><span class="line"><span class="function">	at java.util.concurrent.ThreadPoolExecutor.<span class="title">runWorker</span><span class="params">(ThreadPoolExecutor.java:<span class="number">1142</span>)</span></span></span><br><span class="line"><span class="function">	at java.util.concurrent.ThreadPoolExecutor$Worker.<span class="title">run</span><span class="params">(ThreadPoolExecutor.java:<span class="number">617</span>)</span></span></span><br><span class="line"><span class="function">	at java.lang.Thread.<span class="title">run</span><span class="params">(Thread.java:<span class="number">748</span>)</span></span></span><br><span class="line"><span class="function">Caused by: org.apache.kafka.common.errors.TimeoutException: Timed out waiting to send the call.</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="Request-to-leader-to-reconfigure-connector-tasks-failed"><a href="#Request-to-leader-to-reconfigure-connector-tasks-failed" class="headerlink" title="Request to leader to reconfigure connector tasks failed"></a>Request to leader to reconfigure connector tasks failed</h5><h6 id="描述-1"><a href="#描述-1" class="headerlink" title="描述"></a>描述</h6><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">[<span class="number">2018</span>-<span class="number">03</span>-<span class="number">13</span> <span class="number">10</span>:<span class="number">30</span>:<span class="number">28</span>,<span class="number">303</span>] ERROR Unexpected error during connector task reconfiguration:  (org.apache.kafka.connect.runtime.distributed.DistributedHerder:<span class="number">933</span>)</span><br><span class="line">[<span class="number">2018</span>-<span class="number">03</span>-<span class="number">13</span> <span class="number">10</span>:<span class="number">30</span>:<span class="number">28</span>,<span class="number">303</span>] ERROR Task reconfiguration <span class="keyword">for</span> FileStreamSinkConnector failed unexpectedly, <span class="keyword">this</span> connector will not be properly reconfigured unless manually triggered. (org.apache.kafka.connect.runtime.distributed.DistributedHerder:<span class="number">934</span>)</span><br><span class="line">[<span class="number">2018</span>-<span class="number">03</span>-<span class="number">13</span> <span class="number">10</span>:<span class="number">30</span>:<span class="number">28</span>,<span class="number">306</span>] INFO <span class="number">192.168</span>.<span class="number">1.102</span> - - [<span class="number">13</span>/Mar/<span class="number">2018</span>:<span class="number">02</span>:<span class="number">30</span>:<span class="number">28</span> +<span class="number">0000</span>] <span class="string">"POST /connectors/FileStreamSinkConnector/tasks?forward=false HTTP/1.1"</span> <span class="number">409</span> <span class="number">113</span>  <span class="number">1</span> (org.apache.kafka.connect.runtime.rest.RestServer:<span class="number">60</span>)</span><br><span class="line">[<span class="number">2018</span>-<span class="number">03</span>-<span class="number">13</span> <span class="number">10</span>:<span class="number">30</span>:<span class="number">28</span>,<span class="number">307</span>] INFO <span class="number">192.168</span>.<span class="number">1.102</span> - - [<span class="number">13</span>/Mar/<span class="number">2018</span>:<span class="number">02</span>:<span class="number">30</span>:<span class="number">28</span> +<span class="number">0000</span>] <span class="string">"POST /connectors/FileStreamSinkConnector/tasks?forward=true HTTP/1.1"</span> <span class="number">409</span> <span class="number">113</span>  <span class="number">3</span> (org.apache.kafka.connect.runtime.rest.RestServer:<span class="number">60</span>)</span><br><span class="line">[<span class="number">2018</span>-<span class="number">03</span>-<span class="number">13</span> <span class="number">10</span>:<span class="number">30</span>:<span class="number">28</span>,<span class="number">307</span>] INFO <span class="number">192.168</span>.<span class="number">1.102</span> - - [<span class="number">13</span>/Mar/<span class="number">2018</span>:<span class="number">02</span>:<span class="number">30</span>:<span class="number">28</span> +<span class="number">0000</span>] <span class="string">"POST /connectors/FileStreamSinkConnector/tasks HTTP/1.1"</span> <span class="number">409</span> <span class="number">113</span>  <span class="number">4</span> (org.apache.kafka.connect.runtime.rest.RestServer:<span class="number">60</span>)</span><br><span class="line">[<span class="number">2018</span>-<span class="number">03</span>-<span class="number">13</span> <span class="number">10</span>:<span class="number">30</span>:<span class="number">28</span>,<span class="number">307</span>] <span class="function">ERROR Request to leader to reconfigure connector tasks <span class="title">failed</span> <span class="params">(org.apache.kafka.connect.runtime.distributed.DistributedHerder:<span class="number">996</span>)</span></span></span><br><span class="line"><span class="function">org.apache.kafka.connect.runtime.rest.errors.ConnectRestException: Cannot complete request because of a conflicting <span class="title">operation</span> <span class="params">(e.g. worker rebalance)</span></span></span><br><span class="line"><span class="function">        at org.apache.kafka.connect.runtime.rest.RestServer.<span class="title">httpRequest</span><span class="params">(RestServer.java:<span class="number">229</span>)</span></span></span><br><span class="line"><span class="function">        at org.apache.kafka.connect.runtime.distributed.DistributedHerder$18.<span class="title">run</span><span class="params">(DistributedHerder.java:<span class="number">993</span>)</span></span></span><br><span class="line"><span class="function">        at java.util.concurrent.Executors$RunnableAdapter.<span class="title">call</span><span class="params">(Executors.java:<span class="number">511</span>)</span></span></span><br><span class="line"><span class="function">        at java.util.concurrent.FutureTask.<span class="title">run</span><span class="params">(FutureTask.java:<span class="number">266</span>)</span></span></span><br><span class="line"><span class="function">        at java.util.concurrent.ThreadPoolExecutor.<span class="title">runWorker</span><span class="params">(ThreadPoolExecutor.java:<span class="number">1142</span>)</span></span></span><br><span class="line"><span class="function">        at java.util.concurrent.ThreadPoolExecutor$Worker.<span class="title">run</span><span class="params">(ThreadPoolExecutor.java:<span class="number">617</span>)</span></span></span><br><span class="line"><span class="function">        at java.lang.Thread.<span class="title">run</span><span class="params">(Thread.java:<span class="number">748</span>)</span></span></span><br><span class="line"><span class="function">[2018-03-13 10:30:28,307] ERROR Failed to reconfigure connector´s tasks, retrying after backoff: <span class="params">(org.apache.kafka.connect.runtime.distributed.DistributedHerder:<span class="number">922</span>)</span></span></span><br><span class="line"><span class="function">org.apache.kafka.connect.runtime.rest.errors.ConnectRestException: Cannot complete request because of a conflicting <span class="title">operation</span> <span class="params">(e.g. worker rebalance)</span></span></span><br><span class="line"><span class="function">        at org.apache.kafka.connect.runtime.rest.RestServer.<span class="title">httpRequest</span><span class="params">(RestServer.java:<span class="number">229</span>)</span></span></span><br><span class="line"><span class="function">        at org.apache.kafka.connect.runtime.distributed.DistributedHerder$18.<span class="title">run</span><span class="params">(DistributedHerder.java:<span class="number">993</span>)</span></span></span><br><span class="line"><span class="function">        at java.util.concurrent.Executors$RunnableAdapter.<span class="title">call</span><span class="params">(Executors.java:<span class="number">511</span>)</span></span></span><br><span class="line"><span class="function">        at java.util.concurrent.FutureTask.<span class="title">run</span><span class="params">(FutureTask.java:<span class="number">266</span>)</span></span></span><br><span class="line"><span class="function">        at java.util.concurrent.ThreadPoolExecutor.<span class="title">runWorker</span><span class="params">(ThreadPoolExecutor.java:<span class="number">1142</span>)</span></span></span><br><span class="line"><span class="function">        at java.util.concurrent.ThreadPoolExecutor$Worker.<span class="title">run</span><span class="params">(ThreadPoolExecutor.java:<span class="number">617</span>)</span></span></span><br><span class="line"><span class="function">        at java.lang.Thread.<span class="title">run</span><span class="params">(Thread.java:<span class="number">748</span>)</span></span></span><br><span class="line"><span class="function">[2018-03-13 10:30:28,557] INFO SinkConnectorConfig values:</span></span><br><span class="line"><span class="function">        connector.class </span>= org.apache.kafka.connect.file.FileStreamSinkConnector</span><br><span class="line">        key.converter = <span class="keyword">null</span></span><br><span class="line">        name = FileStreamSinkConnector</span><br><span class="line">        tasks.max = <span class="number">1</span></span><br><span class="line">        topics = [kafka-connect-ui-file-sink]</span><br><span class="line">        transforms = <span class="keyword">null</span></span><br><span class="line">        value.converter = <span class="keyword">null</span></span><br><span class="line"> (org.apache.kafka.connect.runtime.SinkConnectorConfig:<span class="number">223</span>)</span><br><span class="line">[<span class="number">2018</span>-<span class="number">03</span>-<span class="number">13</span> <span class="number">10</span>:<span class="number">30</span>:<span class="number">28</span>,<span class="number">558</span>] INFO EnrichedConnectorConfig values:</span><br><span class="line">        connector.class = org.apache.kafka.connect.file.FileStreamSinkConnector</span><br><span class="line">        key.converter = <span class="keyword">null</span></span><br><span class="line">        name = FileStreamSinkConnector</span><br><span class="line">        tasks.max = <span class="number">1</span></span><br><span class="line">        topics = [kafka-connect-ui-file-sink]</span><br><span class="line">        transforms = <span class="keyword">null</span></span><br><span class="line">        value.converter = <span class="keyword">null</span></span><br></pre></td></tr></tbody></table></figure>
<h6 id="解决-1"><a href="#解决-1" class="headerlink" title="解决"></a>解决</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim etc/kafka/connect-distributed.properties</span><br><span class="line">  <span class="comment"># These are provided to inform the user about the presence of the REST host and port configs </span></span><br><span class="line">  <span class="comment"># Hostname &amp; Port for the REST API to listen on. If this is set, it will bind to the interface used to listen to requests.</span></span><br><span class="line">  rest.host.name=0.0.0.0</span><br><span class="line">  rest.port=8083</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 增加如下两个配置</span></span><br><span class="line">  <span class="comment"># The Hostname &amp; Port that will be given out to other workers to connect to i.e. URLs that are routable from other servers.</span></span><br><span class="line">  rest.advertised.host.name=192.168.1.101  <span class="comment"># 当前机器 IP 地址</span></span><br><span class="line">  rest.advertised.port=8083</span><br></pre></td></tr></tbody></table></figure>
<h5 id="io-confluent-kafka-schemaregistry-client-rest-RestService-Connection-refused"><a href="#io-confluent-kafka-schemaregistry-client-rest-RestService-Connection-refused" class="headerlink" title="io.confluent.kafka.schemaregistry.client.rest.RestService Connection refused"></a>io.confluent.kafka.schemaregistry.client.rest.RestService Connection refused</h5><h6 id="描述-2"><a href="#描述-2" class="headerlink" title="描述"></a>描述</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ ./bin/kafka-avro-console-producer --broker-list localhost:9092 --topic kafka-connect-ui-file-sink --property value.schema=<span class="string">'{"type":"record","name":"myrecord","fields":[{"name":"f1","type":"string"}]}'</span></span><br><span class="line">  <span class="comment"># 发送数据</span></span><br><span class="line">  {<span class="string">"f1"</span>: <span class="string">"value1"</span>}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">[<span class="number">2018</span>-<span class="number">03</span>-<span class="number">13</span> <span class="number">10</span>:<span class="number">48</span>:<span class="number">24</span>,<span class="number">211</span>] ERROR Failed to send HTTP request to endpoint: http:<span class="comment">//localhost:8081/subjects/kafka-connect-ui-file-sink-value/versions (io.confluent.kafka.schemaregistry.client.rest.RestService:156)</span></span><br><span class="line">java.net.ConnectException: <span class="function">Connection <span class="title">refused</span> <span class="params">(Connection refused)</span></span></span><br><span class="line"><span class="function">	at java.net.PlainSocketImpl.<span class="title">socketConnect</span><span class="params">(Native Method)</span></span></span><br><span class="line"><span class="function">	at java.net.AbstractPlainSocketImpl.<span class="title">doConnect</span><span class="params">(AbstractPlainSocketImpl.java:<span class="number">350</span>)</span></span></span><br><span class="line"><span class="function">	at java.net.AbstractPlainSocketImpl.<span class="title">connectToAddress</span><span class="params">(AbstractPlainSocketImpl.java:<span class="number">206</span>)</span></span></span><br><span class="line"><span class="function">	at java.net.AbstractPlainSocketImpl.<span class="title">connect</span><span class="params">(AbstractPlainSocketImpl.java:<span class="number">188</span>)</span></span></span><br><span class="line"><span class="function">	at java.net.SocksSocketImpl.<span class="title">connect</span><span class="params">(SocksSocketImpl.java:<span class="number">392</span>)</span></span></span><br><span class="line"><span class="function">	at java.net.Socket.<span class="title">connect</span><span class="params">(Socket.java:<span class="number">589</span>)</span></span></span><br><span class="line"><span class="function">	at java.net.Socket.<span class="title">connect</span><span class="params">(Socket.java:<span class="number">538</span>)</span></span></span><br><span class="line"><span class="function">	at sun.net.NetworkClient.<span class="title">doConnect</span><span class="params">(NetworkClient.java:<span class="number">180</span>)</span></span></span><br><span class="line"><span class="function">	at sun.net.www.http.HttpClient.<span class="title">openServer</span><span class="params">(HttpClient.java:<span class="number">463</span>)</span></span></span><br><span class="line"><span class="function">	at sun.net.www.http.HttpClient.<span class="title">openServer</span><span class="params">(HttpClient.java:<span class="number">558</span>)</span></span></span><br><span class="line"><span class="function">	at sun.net.www.http.HttpClient.&lt;init&gt;<span class="params">(HttpClient.java:<span class="number">242</span>)</span></span></span><br><span class="line"><span class="function">	at sun.net.www.http.HttpClient.<span class="title">New</span><span class="params">(HttpClient.java:<span class="number">339</span>)</span></span></span><br><span class="line"><span class="function">	at sun.net.www.http.HttpClient.<span class="title">New</span><span class="params">(HttpClient.java:<span class="number">357</span>)</span></span></span><br></pre></td></tr></tbody></table></figure>
<h6 id="解决-2"><a href="#解决-2" class="headerlink" title="解决"></a>解决</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 检查 schema register 进程是否存在</span></span><br><span class="line">$ nohup ./bin/schema-registry-start ./etc/schema-registry/schema-registry.properties &amp;</span><br><span class="line">$ tail -f logs/schema-registry.log</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Docker-镜像"><a href="#Docker-镜像" class="headerlink" title="Docker 镜像"></a>Docker 镜像</h3><h4 id="Docker-环境安装"><a href="#Docker-环境安装" class="headerlink" title="Docker 环境安装"></a>Docker 环境安装</h4><h5 id="更新镜像源"><a href="#更新镜像源" class="headerlink" title="更新镜像源"></a>更新镜像源</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 添加国内 yum 源</span></span><br><span class="line">$ sudo yum-config-manager --add-repo https://mirrors.ustc.edu.cn/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"><span class="comment"># 更新 yum 软件源缓存</span></span><br><span class="line">$ sudo yum makecache fast</span><br></pre></td></tr></tbody></table></figure>
<h5 id="安装-Docker-CE"><a href="#安装-Docker-CE" class="headerlink" title="安装 Docker-CE"></a>安装 Docker-CE</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 安装 依赖包</span></span><br><span class="line">$ sudo yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="line"><span class="comment"># 安装 docker-ce</span></span><br><span class="line">$ sudo yum install docker-ce</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者直接一键安装</span></span><br><span class="line">$ curl -fsSL get.docker.com -o get-docker.sh</span><br><span class="line">$ sudo sh get-docker.sh --mirror Aliyun</span><br></pre></td></tr></tbody></table></figure>
<h5 id="启动-2"><a href="#启动-2" class="headerlink" title="启动"></a>启动</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ sudo systemctl <span class="built_in">enable</span> docker</span><br><span class="line">$ sudo systemctl start docker</span><br></pre></td></tr></tbody></table></figure>
<h5 id="建立-Docker-用户组"><a href="#建立-Docker-用户组" class="headerlink" title="建立 Docker 用户组"></a>建立 Docker 用户组</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 建立 docker 组</span></span><br><span class="line">$ sudo groupadd docker</span><br><span class="line"><span class="comment"># 将当前用户加入 docker 组</span></span><br><span class="line">$ sudo usermod -aG docker <span class="variable">$USER</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="MySQL-Kafka-Connect-HDFS-实战"><a href="#MySQL-Kafka-Connect-HDFS-实战" class="headerlink" title="MySQL - Kafka Connect - HDFS 实战"></a>MySQL - Kafka Connect - HDFS 实战</h4><h5 id="下载-1"><a href="#下载-1" class="headerlink" title="下载"></a>下载</h5><p>　<code>MySQL - Kafka Connect - HDFS</code> 的集成环境，官方已经提供了 <a href="https://s3-us-west-2.amazonaws.com/confluent-files/kafka_connect_blog.ova">kafka_connect_blog.ova</a> 镜像文件</p>
<h5 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h5><h6 id="VirtualBox"><a href="#VirtualBox" class="headerlink" title="VirtualBox"></a>VirtualBox</h6><p>　Vagrant 来管理和安装 VirtualBox 虚拟机，相关安装步骤，详见我的另一篇博客《<a href="https://yuzhouwan.com/posts/43687/#Vagrant">Python</a>》</p>
<h5 id="导入虚拟机镜像"><a href="#导入虚拟机镜像" class="headerlink" title="导入虚拟机镜像"></a>导入虚拟机镜像</h5><p>　选择合适的资源，导入 <code>kafka_connect_blog.ova</code> 文件即可<br>　默认用户名密码均为 <code>vagrant</code></p>
<h5 id="操作虚拟机镜像"><a href="#操作虚拟机镜像" class="headerlink" title="操作虚拟机镜像"></a>操作虚拟机镜像</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 更新下载源索引</span></span><br><span class="line">$ sudo apt-get update</span><br><span class="line">$ ./setup.sh</span><br><span class="line">$ ./start.sh</span><br></pre></td></tr></tbody></table></figure>
<p>Tips: 机器配置过低 和 网络代理受阻 的原因，未完待续…</p>
<h4 id="踩过的坑-2"><a href="#踩过的坑-2" class="headerlink" title="踩过的坑"></a>踩过的坑</h4><h5 id="bridge-nf-call-iptables-is-disabled"><a href="#bridge-nf-call-iptables-is-disabled" class="headerlink" title="bridge-nf-call-iptables is disabled"></a>bridge-nf-call-iptables is disabled</h5><h6 id="描述-3"><a href="#描述-3" class="headerlink" title="描述"></a>描述</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">WARNING: bridge-nf-call-iptables is disabled</span><br><span class="line">WARNING: bridge-nf-call-ip6tables is disabled</span><br></pre></td></tr></tbody></table></figure>
<h6 id="解决-3"><a href="#解决-3" class="headerlink" title="解决"></a>解决</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 添加内核配置参数</span></span><br><span class="line">$ sudo tee -a /etc/sysctl.conf &lt;&lt;-EOF</span><br><span class="line">  net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">  net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">  EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新加载 sysctl.conf</span></span><br><span class="line">$ sudo sysctl -p</span><br></pre></td></tr></tbody></table></figure>
<h3 id="常用配置"><a href="#常用配置" class="headerlink" title="常用配置"></a>常用配置</h3><h4 id="Worker-通用配置"><a href="#Worker-通用配置" class="headerlink" title="Worker 通用配置"></a>Worker 通用配置</h4><h5 id="bootstrap-servers"><a href="#bootstrap-servers" class="headerlink" title="bootstrap.servers"></a>bootstrap.servers</h5><figure class="highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 建立到 Kafka 的初始连接</span></span><br><span class="line"><span class="comment"># Bootstrap Kafka servers. If multiple servers are specified, they should be comma-separated.</span></span><br><span class="line"><span class="meta">bootstrap.servers</span>=<span class="string">localhost:9092</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="key-value-converter"><a href="#key-value-converter" class="headerlink" title="[key | value].converter"></a>[key | value].converter</h5><figure class="highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 指定 Kafka 中的数据如何转为到 Connect</span></span><br><span class="line"><span class="comment"># The converters specify the format of data in Kafka and how to translate it into Connect data.</span></span><br><span class="line"><span class="comment"># Every Connect user will need to configure these based on the format they want their data in</span></span><br><span class="line"><span class="comment"># when loaded from or stored into Kafka</span></span><br><span class="line"><span class="meta">key.converter</span>=<span class="string">io.confluent.connect.avro.AvroConverter</span></span><br><span class="line"><span class="meta">key.converter.schema.registry.url</span>=<span class="string">http://localhost:8081</span></span><br><span class="line"><span class="meta">value.converter</span>=<span class="string">io.confluent.connect.avro.AvroConverter</span></span><br><span class="line"><span class="meta">value.converter.schema.registry.url</span>=<span class="string">http://localhost:8081</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="internal-key-value-converter"><a href="#internal-key-value-converter" class="headerlink" title="internal.[key | value].converter"></a>internal.[key | value].converter</h5><figure class="highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 指定 Connect 内部的数据转化</span></span><br><span class="line"><span class="comment"># The offsets, status, and configurations are written to the topics using converters specified through the following required properties.</span></span><br><span class="line"><span class="comment"># Most users will always want to use the JSON converter without schemas. </span></span><br><span class="line"><span class="comment"># Offset and config data is never visible outside of Connect in this format.</span></span><br><span class="line"><span class="meta">internal.key.converter</span>=<span class="string">org.apache.kafka.connect.json.JsonConverter</span></span><br><span class="line"><span class="meta">internal.value.converter</span>=<span class="string">org.apache.kafka.connect.json.JsonConverter</span></span><br><span class="line"><span class="meta">internal.key.converter.schemas.enable</span>=<span class="string">false</span></span><br><span class="line"><span class="meta">internal.value.converter.schemas.enable</span>=<span class="string">false</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="rest-host-name-amp-rest-port"><a href="#rest-host-name-amp-rest-port" class="headerlink" title="rest.host.name &amp; rest.port"></a>rest.host.name &amp; rest.port</h5><figure class="highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 配置 RESTful 服务的 IP 和 Port</span></span><br><span class="line"><span class="comment"># These are provided to inform the user about the presence of the REST host and port configs</span></span><br><span class="line"><span class="comment"># Hostname &amp; Port for the REST API to listen on. If this is set, it will bind to the interface used to listen to requests.</span></span><br><span class="line"><span class="meta">rest.host.name</span>=<span class="string">0.0.0.0</span></span><br><span class="line"><span class="meta">rest.port</span>=<span class="string">8083</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="plugin-path"><a href="#plugin-path" class="headerlink" title="plugin.path"></a>plugin.path</h5><figure class="highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Set to a list of filesystem paths separated by commas (,) to enable class loading isolation for plugins</span></span><br><span class="line"><span class="comment"># (connectors, converters, transformations). The list should consist of top level directories that include </span></span><br><span class="line"><span class="comment"># any combination of: </span></span><br><span class="line"><span class="comment"># a) directories immediately containing jars with plugins and their dependencies</span></span><br><span class="line"><span class="comment"># b) uber-jars with plugins and their dependencies</span></span><br><span class="line"><span class="comment"># c) directories immediately containing the package directory structure of classes of plugins and their dependencies</span></span><br><span class="line"><span class="comment"># Examples: </span></span><br><span class="line"><span class="comment"># plugin.path=/usr/local/share/java,/usr/local/share/kafka/plugins,/opt/connectors,</span></span><br><span class="line"><span class="meta">plugin.path</span>=<span class="string">/home/connect/plugins</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="分布式-Worker-配置"><a href="#分布式-Worker-配置" class="headerlink" title="分布式 Worker 配置"></a>分布式 Worker 配置</h4><h5 id="group-id"><a href="#group-id" class="headerlink" title="group.id"></a>group.id</h5><figure class="highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># The group ID is a unique identifier for the set of workers that form a single Kafka Connect cluster</span></span><br><span class="line"><span class="meta">group.id</span>=<span class="string">connect-cluster</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="config-offset-status-storage-topic"><a href="#config-offset-status-storage-topic" class="headerlink" title="[config | offset | status].storage.topic"></a>[config | offset | status].storage.topic</h5><figure class="highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Internal Storage Topics.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Kafka Connect distributed workers store the connector and task configurations, connector offsets,</span></span><br><span class="line"><span class="comment"># and connector statuses in three internal topics. These topics MUST be compacted.</span></span><br><span class="line"><span class="comment"># When the Kafka Connect distributed worker starts, it will check for these topics and attempt to create them</span></span><br><span class="line"><span class="comment"># as compacted topics if they don't yet exist, using the topic name, replication factor, and number of partitions</span></span><br><span class="line"><span class="comment"># as specified in these properties, and other topic-specific settings inherited from your brokers'</span></span><br><span class="line"><span class="comment"># auto-creation settings. If you need more control over these other topic-specific settings, you may want to</span></span><br><span class="line"><span class="comment"># manually create these topics before starting Kafka Connect distributed workers.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The following properties set the names of these three internal topics for storing configs, offsets, and status.</span></span><br><span class="line"><span class="meta">config.storage.topic</span>=<span class="string">connect-configs</span></span><br><span class="line"><span class="meta">offset.storage.topic</span>=<span class="string">connect-offsets</span></span><br><span class="line"><span class="meta">status.storage.topic</span>=<span class="string">connect-statuses</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="config-offset-status-storage-replication-factor"><a href="#config-offset-status-storage-replication-factor" class="headerlink" title="[config | offset | status].storage.replication.factor"></a>[config | offset | status].storage.replication.factor</h5><figure class="highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># The following properties set the replication factor for the three internal topics, defaulting to 3 for each</span></span><br><span class="line"><span class="comment"># and therefore requiring a minimum of 3 brokers in the cluster. Since we want the examples to run with</span></span><br><span class="line"><span class="comment"># only a single broker, we set the replication factor here to just 1. That´s okay for the examples, but</span></span><br><span class="line"><span class="comment"># ALWAYS use a replication factor of AT LEAST 3 for production environments to reduce the risk of </span></span><br><span class="line"><span class="comment"># losing connector offsets, configurations, and status.</span></span><br><span class="line"><span class="meta">config.storage.replication.factor</span>=<span class="string">1</span></span><br><span class="line"><span class="meta">offset.storage.replication.factor</span>=<span class="string">1</span></span><br><span class="line"><span class="meta">status.storage.replication.factor</span>=<span class="string">1</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="offset-status-storage-partitions"><a href="#offset-status-storage-partitions" class="headerlink" title="[offset | status].storage.partitions"></a>[offset | status].storage.partitions</h5><figure class="highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># The config storage topic must have a single partition, and this cannot be changed via properties. </span></span><br><span class="line"><span class="comment"># Offsets for all connectors and tasks are written quite frequently and therefore the offset topic</span></span><br><span class="line"><span class="comment"># should be highly partitioned; by default it is created with 25 partitions, but adjust accordingly</span></span><br><span class="line"><span class="comment"># with the number of connector tasks deployed to a distributed worker cluster. Kafka Connect records</span></span><br><span class="line"><span class="comment"># the status less frequently, and so by default the topic is created with 5 partitions.</span></span><br><span class="line"><span class="meta">offset.storage.partitions</span>=<span class="string">25</span></span><br><span class="line"><span class="meta">status.storage.partitions</span>=<span class="string">5</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="Connector-配置"><a href="#Connector-配置" class="headerlink" title="Connector 配置"></a>Connector 配置</h4><h5 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Unique name for the connector. Attempting to register again with the same name will fail.</span></span><br><span class="line">name</span><br><span class="line"><span class="comment"># The Java class for the connector</span></span><br><span class="line">connector.class</span><br><span class="line"><span class="comment"># The maximum number of tasks that should be created for this connector. The connector may create fewer tasks if it cannot achieve this level of parallelism.</span></span><br><span class="line">tasks.max</span><br><span class="line"><span class="comment"># (optional) Override the default key converter class set by the worker.</span></span><br><span class="line">key.converter</span><br><span class="line"><span class="comment"># (optional) Override the default value converter class set by the worker.</span></span><br><span class="line">value.converter</span><br><span class="line"></span><br><span class="line"><span class="comment"># Sink connectors also have one additional option to control their input</span></span><br><span class="line"><span class="comment"># A list of topics to use as input for this connector</span></span><br><span class="line">topics</span><br></pre></td></tr></tbody></table></figure>
<h5 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h5><h6 id="单机版-Connector-配置"><a href="#单机版-Connector-配置" class="headerlink" title="单机版 Connector 配置"></a>单机版 Connector 配置</h6><figure class="highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">name</span>=<span class="string">local-file-sink</span></span><br><span class="line"><span class="meta">connector.class</span>=<span class="string">FileStreamSinkConnector</span></span><br><span class="line"><span class="meta">tasks.max</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">file</span>=<span class="string">test.sink.txt</span></span><br><span class="line"><span class="attr">topics</span>=<span class="string">connect-test</span></span><br></pre></td></tr></tbody></table></figure>
<h6 id="分布式-Connector-配置"><a href="#分布式-Connector-配置" class="headerlink" title="分布式 Connector 配置"></a>分布式 Connector <a href="https://docs.confluent.io/current/connect/userguide.html#distributed-worker-configuration">配置</a></h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ curl -X POST -H <span class="string">"Content-Type: application/json"</span> --data <span class="string">'{"name": "local-file-sink", "config": {"connector.class":"FileStreamSinkConnector", "tasks.max":"1", "file":"test.sink.txt", "topics":"connect-test" }}'</span> http://localhost:8083/connectors</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者直接指定一个包含了 JSON 格式的配置文件</span></span><br><span class="line">$ curl -X POST -H <span class="string">"Content-Type: application/json"</span> --data @config.json http://localhost:8083/connectors</span><br></pre></td></tr></tbody></table></figure>
<h3 id="RESTful-接口"><a href="#RESTful-接口" class="headerlink" title="RESTful 接口"></a><a href="http://kafka.apache.org/documentation.html#connect_rest">RESTful</a> 接口</h3><h4 id="说明-1"><a href="#说明-1" class="headerlink" title="说明"></a>说明</h4><p>　Since Kafka Connect is intended to be run as a service, it also provides a REST API for managing connectors. By default, this service runs on port 8083.</p>
<p>　The following are the currently supported endpoints:</p>
<ul>
<li><code>GET /connectors</code> - return a list of active connectors</li>
<li><code>POST /connectors</code> - create a new connector; the request body should be a JSON object containing a string <code>name</code> field and an object <code>config</code> field with the connector configuration parameters</li>
<li><code>GET /connectors/{name}</code> - get information about a specific connector</li>
<li><code>GET /connectors/{name}/config</code> - get the configuration parameters for a specific connector</li>
<li><code>PUT /connectors/{name}/config</code> - update the configuration parameters for a specific connector</li>
<li><code>GET /connectors/{name}/status</code> - get current status of the connector, including if it is running, failed, paused, etc., which worker it is assigned to, error information if it has failed, and the state of all its tasks</li>
<li><code>GET /connectors/{name}/tasks</code> - get a list of tasks currently running for a connector</li>
<li><code>GET /connectors/{name}/tasks/{taskid}/status</code> - get current status of the task, including if it is running, failed, paused, etc., which worker it is assigned to, and error information if it has failed</li>
<li><code>PUT /connectors/{name}/pause</code> - pause the connector and its tasks, which stops message processing until the connector is resumed</li>
<li><code>PUT /connectors/{name}/resume</code> - resume a paused connector (or do nothing if the connector is not paused)</li>
<li><code>POST /connectors/{name}/restart</code> - restart a connector (typically because it has failed)</li>
<li><code>POST /connectors/{name}/tasks/{taskId}/restart</code> - restart an individual task (typically because it has failed)</li>
<li><code>DELETE /connectors/{name}</code> - delete a connector, halting all tasks and deleting its configuration</li>
</ul>
<p>　Kafka Connect also provides a REST API for getting information about connector plugins:</p>
<ul>
<li><code>GET /connector-plugins</code>- return a list of connector plugins installed in the Kafka Connect cluster. Note that the API only checks for connectors on the worker that handles the request, which means you may see inconsistent results, especially during a rolling upgrade if you add new connector jars</li>
<li><code>PUT /connector-plugins/{connector-type}/config/validate</code> - validate the provided configuration values against the configuration definition. This API performs per config validation, returns suggested values and error messages during validation.</li>
</ul>
<h4 id="实例-1"><a href="#实例-1" class="headerlink" title="实例"></a>实例</h4><h5 id="Worker-版本信息"><a href="#Worker-版本信息" class="headerlink" title="Worker 版本信息"></a>Worker 版本信息</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ curl localhost:8083/ | jq</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"0.10.0.1-cp1"</span>,</span><br><span class="line">  <span class="attr">"commit"</span>: <span class="string">"ea5fcd28195f168b"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h5 id="Worker-支持的-Connector-插件"><a href="#Worker-支持的-Connector-插件" class="headerlink" title="Worker 支持的 Connector 插件"></a>Worker 支持的 Connector 插件</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ curl localhost:8083/connector-plugins | jq</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">[</span><br><span class="line">  {</span><br><span class="line">    <span class="attr">"class"</span>: <span class="string">"io.confluent.connect.elasticsearch.ElasticsearchSinkConnector"</span>,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"sink"</span>,</span><br><span class="line">    <span class="attr">"version"</span>: <span class="string">"3.3.1"</span></span><br><span class="line">  },</span><br><span class="line">  {</span><br><span class="line">    <span class="attr">"class"</span>: <span class="string">"io.confluent.connect.hdfs.HdfsSinkConnector"</span>,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"sink"</span>,</span><br><span class="line">    <span class="attr">"version"</span>: <span class="string">"3.3.1"</span></span><br><span class="line">  },</span><br><span class="line">  {</span><br><span class="line">    <span class="attr">"class"</span>: <span class="string">"io.confluent.connect.hdfs.tools.SchemaSourceConnector"</span>,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"source"</span>,</span><br><span class="line">    <span class="attr">"version"</span>: <span class="string">"0.11.0.0-cp1"</span></span><br><span class="line">  },</span><br><span class="line">  {</span><br><span class="line">    <span class="attr">"class"</span>: <span class="string">"io.confluent.connect.jdbc.JdbcSinkConnector"</span>,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"sink"</span>,</span><br><span class="line">    <span class="attr">"version"</span>: <span class="string">"3.3.1"</span></span><br><span class="line">  },</span><br><span class="line">  {</span><br><span class="line">    <span class="attr">"class"</span>: <span class="string">"io.confluent.connect.jdbc.JdbcSourceConnector"</span>,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"source"</span>,</span><br><span class="line">    <span class="attr">"version"</span>: <span class="string">"3.3.1"</span></span><br><span class="line">  },</span><br><span class="line">  {</span><br><span class="line">    <span class="attr">"class"</span>: <span class="string">"io.confluent.connect.s3.S3SinkConnector"</span>,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"sink"</span>,</span><br><span class="line">    <span class="attr">"version"</span>: <span class="string">"3.3.1"</span></span><br><span class="line">  },</span><br><span class="line">  {</span><br><span class="line">    <span class="attr">"class"</span>: <span class="string">"io.confluent.connect.storage.tools.SchemaSourceConnector"</span>,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"source"</span>,</span><br><span class="line">    <span class="attr">"version"</span>: <span class="string">"0.11.0.0-cp1"</span></span><br><span class="line">  },</span><br><span class="line">  {</span><br><span class="line">    <span class="attr">"class"</span>: <span class="string">"org.apache.kafka.connect.file.FileStreamSinkConnector"</span>,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"sink"</span>,</span><br><span class="line">    <span class="attr">"version"</span>: <span class="string">"0.11.0.0-cp1"</span></span><br><span class="line">  },</span><br><span class="line">  {</span><br><span class="line">    <span class="attr">"class"</span>: <span class="string">"org.apache.kafka.connect.file.FileStreamSourceConnector"</span>,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"source"</span>,</span><br><span class="line">    <span class="attr">"version"</span>: <span class="string">"0.11.0.0-cp1"</span></span><br><span class="line">  }</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>
<h5 id="Worker-上激活的-Connector-插件"><a href="#Worker-上激活的-Connector-插件" class="headerlink" title="Worker 上激活的 Connector 插件"></a>Worker 上激活的 Connector 插件</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ curl localhost:8083/connectors | jq</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">[</span><br><span class="line">  <span class="string">"file-source"</span>,</span><br><span class="line">  <span class="string">"file-sink"</span></span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>
<h5 id="重启-Connector"><a href="#重启-Connector" class="headerlink" title="重启 Connector"></a>重启 Connector</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ curl -X POST localhost:8083/connectors/file-sink/restart</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>如果成功了，不会返回任何信息</li>
<li>如果失败了，会打印如下类似信息</li>
</ul>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"error_code"</span>: <span class="number">404</span>,</span><br><span class="line">  <span class="attr">"message"</span>: <span class="string">"Unknown connector: local-file-sink"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h5 id="获得某个-Connector上的所有-Tasks"><a href="#获得某个-Connector上的所有-Tasks" class="headerlink" title="获得某个 Connector上的所有 Tasks"></a>获得某个 Connector上的所有 Tasks</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ curl localhost:8083/connectors/file-sink/tasks | jq</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">[</span><br><span class="line">  {</span><br><span class="line">    <span class="attr">"id"</span>: {</span><br><span class="line">      <span class="attr">"connector"</span>: <span class="string">"file-sink"</span>,</span><br><span class="line">      <span class="attr">"task"</span>: <span class="number">0</span></span><br><span class="line">    },</span><br><span class="line">    <span class="attr">"config"</span>: {</span><br><span class="line">      <span class="attr">"topics"</span>: <span class="string">"connect-test"</span>,</span><br><span class="line">      <span class="attr">"file"</span>: <span class="string">"test.sink.txt"</span>,</span><br><span class="line">      <span class="attr">"task.class"</span>: <span class="string">"org.apache.kafka.connect.file.FileStreamSinkTask"</span></span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>
<h5 id="重启-Task"><a href="#重启-Task" class="headerlink" title="重启 Task"></a>重启 Task</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ curl -X POST localhost:8083/connectors/file-sink/tasks/0/restart | jq</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>如果成功了，不会返回任何信息</li>
<li>如果失败了，会打印如下类似信息</li>
</ul>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"error_code"</span>: <span class="number">404</span>,</span><br><span class="line">  <span class="attr">"message"</span>: <span class="string">"Unknown task: file-sink-1"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h5 id="暂停-Connector"><a href="#暂停-Connector" class="headerlink" title="暂停 Connector"></a>暂停 Connector</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ curl -X PUT localhost:8083/connectors/file-sink/pause | jq</span><br></pre></td></tr></tbody></table></figure>
<h5 id="恢复-Connector"><a href="#恢复-Connector" class="headerlink" title="恢复 Connector"></a>恢复 Connector</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ curl -X PUT localhost:8083/connectors/file-sink/resume | jq</span><br></pre></td></tr></tbody></table></figure>
<h5 id="更新-Connector-配置信息"><a href="#更新-Connector-配置信息" class="headerlink" title="更新 Connector 配置信息"></a>更新 Connector 配置信息</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ curl -X PUT -H <span class="string">"Content-Type: application/json"</span> --data <span class="string">'{"connector.class":"FileStreamSinkConnector","file":"test.sink.txt","tasks.max":"2","topics":"connect-test","name":"local-file-sink"}'</span> localhost:8083/connectors/<span class="built_in">local</span>-file-sink/config</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"local-file-sink"</span>,</span><br><span class="line">  <span class="attr">"config"</span>: {</span><br><span class="line">    <span class="attr">"connector.class"</span>: <span class="string">"FileStreamSinkConnector"</span>,</span><br><span class="line">    <span class="attr">"file"</span>: <span class="string">"test.sink.txt"</span>,</span><br><span class="line">    <span class="attr">"tasks.max"</span>: <span class="string">"2"</span>,</span><br><span class="line">    <span class="attr">"topics"</span>: <span class="string">"connect-test"</span>,</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"local-file-sink"</span></span><br><span class="line">  },</span><br><span class="line">  <span class="attr">"tasks"</span>: [</span><br><span class="line">    {</span><br><span class="line">      <span class="attr">"connector"</span>: <span class="string">"local-file-sink"</span>,</span><br><span class="line">      <span class="attr">"task"</span>: <span class="number">0</span></span><br><span class="line">    },</span><br><span class="line">    {</span><br><span class="line">      <span class="attr">"connector"</span>: <span class="string">"local-file-sink"</span>,</span><br><span class="line">      <span class="attr">"task"</span>: <span class="number">1</span></span><br><span class="line">    }</span><br><span class="line">  ]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h5 id="获取-Connector-状态"><a href="#获取-Connector-状态" class="headerlink" title="获取 Connector 状态"></a>获取 Connector 状态</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ curl localhost:8083/connectors/file-sink/status | jq</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"file-sink"</span>,</span><br><span class="line">  <span class="attr">"connector"</span>: {</span><br><span class="line">    <span class="attr">"state"</span>: <span class="string">"RUNNING"</span>,</span><br><span class="line">    <span class="attr">"worker_id"</span>: <span class="string">"192.168.1.101:8083"</span></span><br><span class="line">  },</span><br><span class="line">  <span class="attr">"tasks"</span>: [</span><br><span class="line">    {</span><br><span class="line">      <span class="attr">"state"</span>: <span class="string">"RUNNING"</span>,</span><br><span class="line">      <span class="attr">"id"</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"worker_id"</span>: <span class="string">"192.168.1.101:8083"</span></span><br><span class="line">    }</span><br><span class="line">  ]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h5 id="获取-Connector-配置信息"><a href="#获取-Connector-配置信息" class="headerlink" title="获取 Connector 配置信息"></a>获取 Connector 配置信息</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ curl localhost:8083/connectors/file-sink | jq</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"file-sink"</span>,</span><br><span class="line">  <span class="attr">"config"</span>: {</span><br><span class="line">    <span class="attr">"topics"</span>: <span class="string">"connect-test"</span>,</span><br><span class="line">    <span class="attr">"file"</span>: <span class="string">"test.sink.txt"</span>,</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"file-sink"</span>,</span><br><span class="line">    <span class="attr">"tasks.max"</span>: <span class="string">"1"</span>,</span><br><span class="line">    <span class="attr">"connector.class"</span>: <span class="string">"FileStreamSink"</span></span><br><span class="line">  },</span><br><span class="line">  <span class="attr">"tasks"</span>: [</span><br><span class="line">    {</span><br><span class="line">      <span class="attr">"connector"</span>: <span class="string">"file-sink"</span>,</span><br><span class="line">      <span class="attr">"task"</span>: <span class="number">0</span></span><br><span class="line">    }</span><br><span class="line">  ]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h5 id="删除-Connector"><a href="#删除-Connector" class="headerlink" title="删除 Connector"></a>删除 Connector</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ curl -X DELETE localhost:8083/connectors/file-sink</span><br></pre></td></tr></tbody></table></figure>
<p>Tips: 每个 Connector 进程在启动的时候，都会内置地启动一个 REST 服务端（默认端口 8083）</p>
<h3 id="Schema-Registry"><a href="#Schema-Registry" class="headerlink" title="Schema Registry"></a><a href="https://docs.confluent.io/current/schema-registry/docs/index.html">Schema Registry</a></h3><h4 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 列出所有 Schema</span></span><br><span class="line">$ curl -X GET http://localhost:8081/subjects | jq</span><br><span class="line">  [</span><br><span class="line">    <span class="string">"hdfs_sink_13-value"</span>,</span><br><span class="line">    <span class="string">"kafka-connect-ui-file-sink-value"</span>,</span><br><span class="line">    <span class="string">"hdfs_sink_16-value"</span>,</span><br><span class="line">    <span class="string">"hdfs_sink_17-value"</span>,</span><br><span class="line">    <span class="string">"hdfs_sink_18-value"</span></span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除 hdfs_sink_13-value 的所有版本</span></span><br><span class="line">$ curl -X DELETE http://localhost:8081/subjects/hdfs_sink_13-value</span><br><span class="line">  [1]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除 hdfs_sink_16-value 的第一个版本</span></span><br><span class="line">$ curl -X DELETE http://localhost:8081/subjects/hdfs_sink_16-value/versions/1</span><br><span class="line">  1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除 hdfs_sink_17-value 最后一个版本</span></span><br><span class="line">$ curl -X DELETE http://localhost:8081/subjects/hdfs_sink_17-value/versions/latest</span><br><span class="line">  1</span><br></pre></td></tr></tbody></table></figure>
<h3 id="可视化"><a href="#可视化" class="headerlink" title="可视化"></a>可视化</h3><h4 id="Confluent-UI"><a href="#Confluent-UI" class="headerlink" title="Confluent UI"></a><a href="https://docs.confluent.io/4.0.0/cloud-quickstart.html">Confluent UI</a></h4><p>　未开源</p>
<h4 id="Landoop-UI"><a href="#Landoop-UI" class="headerlink" title="Landoop UI"></a>Landoop UI</h4><h5 id="kafka-connect-ui"><a href="#kafka-connect-ui" class="headerlink" title="kafka-connect-ui"></a><a href="https://github.com/Landoop/kafka-connect-ui">kafka-connect-ui</a></h5><h6 id="启动-3"><a href="#启动-3" class="headerlink" title="启动"></a>启动</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 下载源码</span></span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/Landoop/kafka-connect-ui.git</span><br><span class="line">$ <span class="built_in">cd</span> kafka-connect-ui</span><br><span class="line"><span class="comment"># 安装</span></span><br><span class="line">$ npm install -g bower http-server</span><br><span class="line">$ npm install</span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">$ http-server -p 8080 .</span><br></pre></td></tr></tbody></table></figure>
<h6 id="开启-Confluent-Rest"><a href="#开启-Confluent-Rest" class="headerlink" title="开启 Confluent Rest"></a>开启 Confluent Rest</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 打开 REST 接口</span></span><br><span class="line">$ <span class="built_in">cd</span> software/confluent</span><br><span class="line">$ vim ./etc/kafka/connect-distributed.properties</span><br><span class="line">  <span class="comment"># These are provided to inform the user about the presence of the REST host and port configs</span></span><br><span class="line">  <span class="comment"># Hostname &amp; Port for the REST API to listen on. If this is set, it will bind to the interface used to listen to requests.</span></span><br><span class="line">  rest.host.name=0.0.0.0</span><br><span class="line">  rest.port=8083</span><br><span class="line">  <span class="comment"># 如果不设置这两个配置，Worker 节点之间将无法互相识别</span></span><br><span class="line">  <span class="comment"># The Hostname &amp; Port that will be given out to other workers to connect to i.e. URLs that are routable from other servers.</span></span><br><span class="line">  rest.advertised.host.name=192.168.1.101  <span class="comment"># 当前机器 IP 地址</span></span><br><span class="line">  rest.advertised.port=8083</span><br><span class="line">  <span class="comment"># 如果不设置这两个配置，页面上将会看到 prod http://xxxx:8083 N/A N/A N/A</span></span><br><span class="line">  access.control.allow.methods=GET,POST,PUT,DELETE,OPTIONS</span><br><span class="line">  access.control.allow.origin=*</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新启动 Worker</span></span><br><span class="line">$ nohup ./bin/connect-distributed ./etc/kafka/connect-distributed.properties &gt; connect-distribute.log &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 浏览器访问，验证</span></span><br><span class="line">$ curl http://192.168.1.101:8083/</span><br><span class="line">  {<span class="string">"version"</span>:<span class="string">"0.11.0.1-cp1"</span>,<span class="string">"commit"</span>:<span class="string">"3735a6ca8b6432db"</span>}</span><br></pre></td></tr></tbody></table></figure>
<h6 id="创建-File-Sink"><a href="#创建-File-Sink" class="headerlink" title="创建 File Sink"></a>创建 File Sink</h6><ul>
<li><p>选择 Kafka Connect 集群<br><img data-src="/picture/kafka/kafka_connect_ui_configured_clusters.png" alt="Kafka Connector UI Configured Clusters"></p>
</li>
<li><p>查看 Dashboard<br><img data-src="/picture/kafka/kafka_connect_ui_dashboard.png" alt="Kafka Connector UI Dashboard"></p>
</li>
<li><p>点击 Create 按钮<br><img data-src="/picture/kafka/kafka_connect_ui_new_connector.png" alt="Kafka Connector UI New Connector"></p>
</li>
<li><p>配置 Connector<br><img data-src="/picture/kafka/kafka_connect_ui_new_connector_config.png" alt="Kafka Connector UI New Connector Config"></p>
</li>
<li><p>创建成功<br><img data-src="/picture/kafka/kafka_connect_ui_new_connector_created.png" alt="Kafka Connector UI Created"></p>
</li>
<li><p>查看 Connector 详情<br><img data-src="/picture/kafka/kafka_connect_ui_new_connector_detail.png" alt="Kafka Connector UI New Connector Detail"></p>
</li>
</ul>
<h6 id="发送数据"><a href="#发送数据" class="headerlink" title="发送数据"></a>发送数据</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ ./bin/kafka-avro-console-producer --broker-list localhost:9092 --topic kafka-connect-ui-file-sink --property value.schema=<span class="string">'{"type":"record","name":"myrecord","fields":[{"name":"f1","type":"string"}]}'</span></span><br><span class="line">  <span class="comment"># 发送数据</span></span><br><span class="line">  {<span class="string">"f1"</span>: <span class="string">"value1"</span>}</span><br><span class="line">  {<span class="string">"f1"</span>: <span class="string">"value2"</span>}</span><br><span class="line">  {<span class="string">"f1"</span>: <span class="string">"value3"</span>}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 持续发送</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> {1..3}; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">"{\"f1\": \"value<span class="variable">$i</span>\"}"</span> | ./bin/kafka-avro-console-producer --broker-list localhost:9092 --topic kafka-connect-ui-file-sink --property value.schema=<span class="string">'{"type":"record","name":"myrecord","fields":[{"name":"f1","type":"string"}]}'</span>; <span class="keyword">done</span></span><br></pre></td></tr></tbody></table></figure>
<h6 id="接收成功"><a href="#接收成功" class="headerlink" title="接收成功"></a>接收成功</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ cat ./software/confluent-3.3.1/kafka-connect-ui-file-sink.txt</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">Struct{f1=value1}</span><br><span class="line">Struct{f1=value2}</span><br><span class="line">Struct{f1=value3}</span><br></pre></td></tr></tbody></table></figure>
<h6 id="创建-File-Source"><a href="#创建-File-Source" class="headerlink" title="创建 File Source"></a>创建 File Source</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 具体操作步骤，参考上述 File Sink 创建过程，配置如下</span></span><br><span class="line">name=FileStreamSourceConnector</span><br><span class="line">connector.class=org.apache.kafka.connect.file.FileStreamSourceConnector</span><br><span class="line">file=kafka-connect-ui-file-source.txt</span><br><span class="line">tasks.max=1</span><br><span class="line">topic=kafka-connect-ui-file-sink</span><br></pre></td></tr></tbody></table></figure>
<p>　查看 Dashboard 效果如下：</p>
<p><img data-src="/picture/kafka/kafka_connect_ui_file_source_and_sink.png" alt="Kafka Connector UI File Source and Sink"></p>
<h6 id="写入数据到文件"><a href="#写入数据到文件" class="headerlink" title="写入数据到文件"></a>写入数据到文件</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/connect/software/confluent</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">"{\"f1\": \"400\"}"</span> &gt; kafka-connect-ui-file-source.txt</span><br><span class="line">$ tail -f kafka-connect-ui-file-sink.txt</span><br><span class="line">  {<span class="string">"f1"</span>: <span class="string">"400"</span>}</span><br><span class="line"><span class="comment"># 可以看到数据已经落入到 File Sink 配置的本地文件中了</span></span><br><span class="line"><span class="comment"># 但是，数据格式和直接发送带 Schema 的数据给 Kafka，然后直接传输给 File Sink 的数据（Struct{f1=397}），有所不同</span></span><br></pre></td></tr></tbody></table></figure>
<h6 id="踩过的坑-3"><a href="#踩过的坑-3" class="headerlink" title="踩过的坑"></a>踩过的坑</h6><p>描述</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">org.apache.kafka.connect.errors.ConnectException: org.apache.hadoop.security.AccessControlException: Permission denied: user=connect, access=WRITE, inode=<span class="string">"/"</span>:bigdata:supergroup:drwxr-xr-x</span><br></pre></td></tr></tbody></table></figure>
<p>解决</p>
<p>　创建 Kafka 2 HDFS 任务时，指定 <code>logs.dir=/user/connect/logs</code> 参数</p>
<p>　a) Connector 和 HDFS 集群均未报错，但是数据无法落 HDFS</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 除了基本的配置外，</span></span><br><span class="line">connector.class=io.confluent.connect.hdfs.HdfsSinkConnector</span><br><span class="line">topics.dir=/user/connect/topics</span><br><span class="line">flush.size=1</span><br><span class="line">topics=hdfs_sink_16</span><br><span class="line">tasks.max=1</span><br><span class="line">hdfs.url=hdfs://192.168.1.101:9000</span><br><span class="line">logs.dir=/user/connect/logs</span><br><span class="line">schema.cache.size=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对数据格式相关配置，进行显式指定</span></span><br><span class="line">format.class=io.confluent.connect.hdfs.avro.AvroFormat</span><br><span class="line">key.converter=io.confluent.connect.avro.AvroConverter</span><br><span class="line">key.converter.schema.registry.url=http://localhost:8081</span><br><span class="line">value.converter=io.confluent.connect.avro.AvroConverter</span><br><span class="line">value.converter.schema.registry.url=http://localhost:8081</span><br></pre></td></tr></tbody></table></figure>
<p>　b) Missing required configuration “schema.registry.url” which has no default value</p>
<p>　需要指定 <code>schemas.enable=false</code> 配置项</p>
<p>Tips: Live demo is <a href="https://kafka-connect-ui.landoop.com">here</a>.</p>
<h5 id="kafka-topic-ui"><a href="#kafka-topic-ui" class="headerlink" title="kafka-topic-ui"></a>kafka-topic-ui</h5><h6 id="启动-4"><a href="#启动-4" class="headerlink" title="启动"></a>启动</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 下载源码</span></span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/Landoop/kafka-topics-ui.git</span><br><span class="line">$ <span class="built_in">cd</span> kafka-topics-ui</span><br><span class="line"><span class="comment"># 安装</span></span><br><span class="line">$ npm install -g bower</span><br><span class="line">$ npm install -g http-server</span><br><span class="line">$ npm install</span><br><span class="line">$ bower install</span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">$ http-server -p 8081 .</span><br></pre></td></tr></tbody></table></figure>
<h6 id="启动-Kafka-Rest"><a href="#启动-Kafka-Rest" class="headerlink" title="启动 Kafka Rest"></a>启动 Kafka Rest</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim etc/kafka-rest/kafka-rest.properties</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">id</span>=<span class="string">kafka-rest-test-server</span></span><br><span class="line"><span class="meta">schema.registry.url</span>=<span class="string">http://localhost:8081</span></span><br><span class="line"><span class="meta">zookeeper.connect</span>=<span class="string">192.168.1.101:2015,192.168.1.102:2015,192.168.1.103:2015</span></span><br><span class="line"><span class="comment"># 显式地指定 bootstrap server</span></span><br><span class="line"><span class="meta">bootstrap.servers</span>=<span class="string">192.168.1.101:9092,192.168.1.102:9092,192.168.1.103:9092</span></span><br><span class="line"><span class="comment"># 开启 Web 访问的权限</span></span><br><span class="line"><span class="meta">access.control.allow.methods</span>=<span class="string">GET,POST,PUT,DELETE,OPTIONS</span></span><br><span class="line"><span class="meta">access.control.allow.origin</span>=<span class="string">*</span></span><br></pre></td></tr></tbody></table></figure>
<h6 id="效果图"><a href="#效果图" class="headerlink" title="效果图"></a>效果图</h6><p><img data-src="/picture/kafka/kafka_topics_ui_list.png" alt="Kafka Topics UI"></p>
<h6 id="踩过的坑-4"><a href="#踩过的坑-4" class="headerlink" title="踩过的坑"></a>踩过的坑</h6><p>描述</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">WARN Connection to node -1 could not be established. Broker may not be available.</span><br></pre></td></tr></tbody></table></figure>
<p>解决</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim etc/kafka-rest/kafka-rest.properties</span><br><span class="line">  <span class="comment"># 显式地指定 bootstrap server</span></span><br><span class="line">  bootstrap.servers=192.168.1.101:9092,192.168.1.102:9092,192.168.1.103:9092</span><br></pre></td></tr></tbody></table></figure>
<h5 id="schema-registry-ui"><a href="#schema-registry-ui" class="headerlink" title="schema-registry-ui"></a><a href="https://github.com/landoop/schema-registry-ui">schema-registry-ui</a></h5><h6 id="启动-5"><a href="#启动-5" class="headerlink" title="启动"></a>启动</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 下载源码</span></span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/Landoop/schema-registry-ui.git</span><br><span class="line">$ <span class="built_in">cd</span> schema-registry-ui</span><br><span class="line"><span class="comment"># 安装</span></span><br><span class="line">$ npm install</span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">$ npm start</span><br></pre></td></tr></tbody></table></figure>
<h6 id="启动-Schema-Registry"><a href="#启动-Schema-Registry" class="headerlink" title="启动 Schema Registry"></a>启动 Schema Registry</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim etc/schema-registry/schema-registry.properties</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">listeners</span>=<span class="string">http://0.0.0.0:8081</span></span><br><span class="line"><span class="meta">kafkastore.connection.url</span>=<span class="string">192.168.1.101:2015,192.168.1.102:2015,192.168.1.103:2015</span></span><br><span class="line"><span class="meta">kafkastore.topic</span>=<span class="string">_schemas</span></span><br><span class="line"><span class="attr">debug</span>=<span class="string">false</span></span><br><span class="line"><span class="comment"># 开启 Web 访问的权限</span></span><br><span class="line"><span class="meta">access.control.allow.methods</span>=<span class="string">GET,POST,PUT,DELETE,OPTIONS</span></span><br><span class="line"><span class="meta">access.control.allow.origin</span>=<span class="string">*</span></span><br></pre></td></tr></tbody></table></figure>
<h6 id="效果图-1"><a href="#效果图-1" class="headerlink" title="效果图"></a>效果图</h6><p><img data-src="/picture/kafka/kafka_schema_ui_list.png" alt="Kafka Schema Register UI"></p>
<h6 id="二次开发"><a href="#二次开发" class="headerlink" title="二次开发"></a>二次开发</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># cmd 命令行中启动</span></span><br><span class="line">$ npm start</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拷贝浏览器中的 `http://localhost:8080/#/cluster/prod` 连接</span></span><br><span class="line"><span class="comment"># 并在 WebStorm 里，创建 `JavaScript Debug`，并粘贴 URL 连接，运行即可</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="使用社区-Connector"><a href="#使用社区-Connector" class="headerlink" title="使用社区 Connector"></a>使用社区 Connector</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 下载源码</span></span><br><span class="line">$ git <span class="built_in">clone</span> git@github.com:confluentinc/kafka-connect-hdfs.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换至稳定版本，并打包编译</span></span><br><span class="line">$ <span class="built_in">cd</span> kafka-connect-hdfs; git checkout v3.0.1; mvn package</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 plugins 目录下创建对应的 kafka-connect-hdfs 子目录</span></span><br><span class="line">$ mkdir -p /usr/<span class="built_in">local</span>/share/kafka/plugins/kafka-connect-hdfs</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拷贝编译出来的 jar 包到 plugins 目录</span></span><br><span class="line">$ cp target/kafka-connect-hdfs-3.0.1-package/share/java/kafka-connect-hdfs/* /usr/<span class="built_in">local</span>/share/kafka/plugins/kafka-connect-hdfs/</span><br></pre></td></tr></tbody></table></figure>
<h3 id="实现自己的-Connector"><a href="#实现自己的-Connector" class="headerlink" title="实现自己的 Connector"></a>实现自己的 Connector</h3><p>Tips: <a href="https://docs.confluent.io/current/connect/devguide.html">Connector Developer Guide</a></p>
<h3 id="修复已知-Bug"><a href="#修复已知-Bug" class="headerlink" title="修复已知 Bug"></a>修复已知 Bug</h3><p>　使用 jira 语法<a href="https://issues.apache.org/jira/browse/KAFKA-6253?jql=project%20%3D%20KAFKA%20AND%20issuetype%20%3D%20Bug%20AND%20component%20%3D%20KafkaConnect">查询</a>出 Kafka Connect 组件的已知 bug，具体语法如下</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">project = KAFKA AND issuetype = Bug AND component = KafkaConnect</span><br></pre></td></tr></tbody></table></figure>
<h2 id="实用技巧"><a href="#实用技巧" class="headerlink" title="实用技巧"></a>实用技巧</h2><h3 id="zkCli"><a href="#zkCli" class="headerlink" title="zkCli"></a>zkCli</h3><div class="table-container">
<table>
<thead>
<tr>
<th>Command</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>get /consumers/<code>&lt;topic&gt;</code>/owners</td>
<td>查看 topic 实时消费的 group id</td>
</tr>
<tr>
<td>get /consumers/<code>&lt;topic&gt;</code>/offsets/<code>&lt;group id&gt;</code>/<code>&lt;partitionor&gt;</code></td>
<td>查看 offset 情况（ctime: 创建时间; mtime: 修改时间）</td>
</tr>
</tbody>
</table>
</div>
<h3 id="kafka-run-class"><a href="#kafka-run-class" class="headerlink" title="kafka-run-class"></a>kafka-run-class</h3><h4 id="删除-Topic-1"><a href="#删除-Topic-1" class="headerlink" title="删除 Topic"></a>删除 Topic</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ bin/kafka-run-class.sh kafka.admin.DeleteTopicCommand --zookeeper &lt;zk host&gt;:2181,&lt;zk host&gt;:2181,&lt;zk host&gt;:2181 --topic &lt;topic&gt;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Consumer-指定-offset-进行消费，从而达到补数的效果"><a href="#Consumer-指定-offset-进行消费，从而达到补数的效果" class="headerlink" title="Consumer 指定 offset 进行消费，从而达到补数的效果"></a>Consumer 指定 offset 进行消费，从而达到补数的效果</h3><h4 id="Java-Client"><a href="#Java-Client" class="headerlink" title="Java Client"></a>Java Client</h4><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">Properties props = <span class="keyword">new</span> Properties();</span><br><span class="line">props.put(<span class="string">"bootstrap.servers"</span>, bootstrapServers);</span><br><span class="line">props.put(<span class="string">"group.id"</span>, groupId);</span><br><span class="line">props.put(<span class="string">"enable.auto.commit"</span>, <span class="keyword">false</span>);</span><br><span class="line">props.put(<span class="string">"auto.commit.interval.ms"</span>, <span class="string">"1000"</span>);</span><br><span class="line">props.put(<span class="string">"session.timeout.ms"</span>, <span class="string">"30000"</span>);</span><br><span class="line">props.put(<span class="string">"max.poll.records"</span>, maxPollRecords);</span><br><span class="line">props.put(<span class="string">"key.deserializer"</span>, <span class="string">"org.apache.kafka.common.serialization.StringDeserializer"</span>);</span><br><span class="line">props.put(<span class="string">"value.deserializer"</span>, <span class="string">"org.apache.kafka.common.serialization.StringDeserializer"</span>);</span><br><span class="line">KafkaConsumer&lt;String, String&gt; consumer = <span class="keyword">new</span> KafkaConsumer&lt;&gt;(props);</span><br><span class="line"><span class="comment">// consumer.subscribe(Arrays.asList(topic));</span></span><br><span class="line"></span><br><span class="line">TopicPartition p = <span class="keyword">new</span> TopicPartition(topic, <span class="number">2</span>);</span><br><span class="line">consumer.assign(Arrays.asList(p));</span><br><span class="line">consumer.seek(p, <span class="number">1024</span>);</span><br><span class="line"><span class="comment">// while (true) {</span></span><br><span class="line">  ConsumerRecords&lt;String, String&gt; records = consumer.poll(<span class="number">100</span>);</span><br><span class="line">  <span class="keyword">for</span> (ConsumerRecord&lt;String, String&gt; record : records) {</span><br><span class="line">    String V = record.value();</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  }</span><br><span class="line"><span class="comment">// }</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="Shell-Console"><a href="#Shell-Console" class="headerlink" title="Shell Console"></a>Shell Console</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 指定从哪个 offset 开始消费</span></span><br><span class="line">$ kafka-console-consumer --bootstrap-server localhost:9092 --topic topic-1 --consumer.config  config/consumer.properties --offset 90 --partition 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 offset 重置到某一个 offset</span></span><br><span class="line">$ kafka-consumer-groups --bootstrap-server kafka-host:9092 --group my-group --reset-offsets --to-offset 1024 --all-topics --execute</span><br></pre></td></tr></tbody></table></figure>
<h3 id="哪些配置可以在-Kafka-Connect-中进行指定"><a href="#哪些配置可以在-Kafka-Connect-中进行指定" class="headerlink" title="哪些配置可以在 Kafka Connect 中进行指定"></a>哪些配置可以在 Kafka Connect 中进行指定</h3><p>　<a href="https://kafka.apache.org/documentation/#newconsumerconfigs">New Consumer Configs</a></p>
<h3 id="优雅地停止-Kafka-服务"><a href="#优雅地停止-Kafka-服务" class="headerlink" title="优雅地停止 Kafka 服务"></a>优雅地停止 Kafka 服务</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim config/server.properties</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">controlled.shutdown.enable</span>=<span class="string">true</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ bin/kafka-server-stop.sh</span><br></pre></td></tr></tbody></table></figure>
<h3 id="数据过期策略"><a href="#数据过期策略" class="headerlink" title="数据过期策略"></a>数据过期策略</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim config/server.properties</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">log.cleanup.policy</span>=<span class="string">delete</span></span><br><span class="line"><span class="meta">log.retention.hours</span>=<span class="string">168</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h2><h3 id="架构层面"><a href="#架构层面" class="headerlink" title="架构层面"></a>架构层面</h3><h4 id="RingBuffer-Lock-Free"><a href="#RingBuffer-Lock-Free" class="headerlink" title="RingBuffer + Lock Free"></a>RingBuffer + Lock Free</h4><p>　使用 <code>RingBuffer + Lock Free</code> 实现高效的 <code>Producer-Consumer</code> 设计模式，极大地提升 Kafka Producer 发送 Message 的性能</p>
<h4 id="Avro-压缩"><a href="#Avro-压缩" class="headerlink" title="Avro 压缩"></a>Avro 压缩</h4><p>　使用 Avro 压缩，保证了高效地解压缩数据的同时，可以减少网络传输的数据量</p>
<h4 id="多-Partitioner-连接池"><a href="#多-Partitioner-连接池" class="headerlink" title="多 Partitioner + 连接池"></a>多 Partitioner + 连接池</h4><p>　使用连接池可以动态地增减所需的 Kafka 连接，并自己实现 Kafka Partitioner 充分利用多 Partitioner 提高并发度</p>
<p>Tips: Full code is <a href="https://github.com/asdf2014/yuzhouwan/tree/master/yuzhouwan-bigdata/yuzhouwan-bigdata-kafka/src/main/java/com/yuzhouwan/bigdata/kafka/util">here</a>.</p>
<h3 id="参数层面"><a href="#参数层面" class="headerlink" title="参数层面"></a>参数层面</h3><h4 id="Producer"><a href="#Producer" class="headerlink" title="Producer"></a>Producer</h4><figure class="highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">kafka.key.serializer.class</span>=<span class="string">kafka.serializer.StringEncoder</span></span><br><span class="line"><span class="meta">kafka.serializer.class</span>=<span class="string">kafka.serializer.DefaultEncoder</span></span><br><span class="line"><span class="meta">kafka.request.required.acks</span>=<span class="string">0</span></span><br><span class="line"><span class="meta">kafka.async</span>=<span class="string">async</span></span><br><span class="line"><span class="meta">kafka.queue.buffering.max.ms</span>=<span class="string">5000</span></span><br><span class="line"><span class="meta">kafka.queue.buffering.max.messages</span>=<span class="string">10000</span></span><br><span class="line"><span class="meta">kafka.queue.enqueue.timeout.ms</span>=<span class="string">-1</span></span><br><span class="line"><span class="meta">kafka.batch.num.messages</span>=<span class="string">200</span></span><br><span class="line"><span class="meta">kafka.send.buffer.bytes</span>=<span class="string">102400</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="踩到的坑"><a href="#踩到的坑" class="headerlink" title="踩到的坑"></a>踩到的坑</h3><h4 id="Avro-中-Decimal-字段反序列化之后，全部变成了-pos-0-lim-0-cap-0"><a href="#Avro-中-Decimal-字段反序列化之后，全部变成了-pos-0-lim-0-cap-0" class="headerlink" title="Avro 中 Decimal 字段反序列化之后，全部变成了 [pos=0 lim=0 cap=0]"></a>Avro 中 Decimal 字段反序列化之后，全部变成了 [pos=0 lim=0 cap=0]</h4><h5 id="描述-4"><a href="#描述-4" class="headerlink" title="描述"></a>描述</h5><figure class="highlight scala"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 正常进行 double 转 bytebuffer，并从 bytebuffer 转为 double 都是可以的</span></span><br><span class="line"><span class="keyword">val</span> bb: <span class="type">ByteBuffer</span> = <span class="type">ByteBuffer</span>.allocate(<span class="number">8</span>).putDouble(<span class="string">"666.8"</span>.toDouble)</span><br><span class="line"><span class="keyword">val</span> dd: <span class="type">Double</span> = <span class="type">ByteBuffer</span>.wrap(bb.array()).getDouble()</span><br><span class="line"><span class="comment">// 但是，传入 avro 类中，作为 decimal 类型的字段值，然后进行序列化 和 反序列化，就会出现问题</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="解决-4"><a href="#解决-4" class="headerlink" title="解决"></a>解决</h5><ul>
<li>定义 <a href="https://avro.apache.org/docs/current/spec.html#Decimal">decimal</a> 类型字段</li>
</ul>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"namespace"</span>: <span class="string">"com.yuzhouwan.bean"</span>,</span><br><span class="line">  <span class="attr">"type"</span>: <span class="string">"record"</span>,</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"BeanA"</span>,</span><br><span class="line">  <span class="attr">"fields"</span>: [</span><br><span class="line">    {<span class="attr">"name"</span>: <span class="string">"id"</span>, <span class="attr">"type"</span>: <span class="string">"int"</span>},</span><br><span class="line">    {<span class="attr">"name"</span>: <span class="string">"price"</span>, <span class="attr">"type"</span>: {<span class="attr">"type"</span>: <span class="string">"bytes"</span>, <span class="attr">"logicalType"</span>: <span class="string">"decimal"</span>, <span class="attr">"precision"</span>: <span class="number">8</span>, <span class="attr">"scale"</span>: <span class="number">4</span>}}</span><br><span class="line">  ]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>配置 Maven <a href="https://yuzhouwan.com/posts/2254/#Avro-插件">自动解析</a> Avro 类</p>
</li>
<li><p>初始化 Avro 类</p>
</li>
</ul>
<figure class="highlight scala"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.avro.{<span class="type">Conversions</span>, <span class="type">LogicalTypes</span>, <span class="type">Schema</span>}</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> decimal: java.math.<span class="type">BigDecimal</span> = java.math.<span class="type">BigDecimal</span>.valueOf(<span class="string">"666.8"</span>.toDouble)</span><br><span class="line"><span class="keyword">val</span> logicalType: <span class="type">LogicalTypes</span>.<span class="type">Decimal</span> = <span class="type">LogicalTypes</span>.decimal(<span class="number">8</span>, <span class="number">4</span>)</span><br><span class="line"><span class="keyword">val</span> schema: <span class="type">Schema</span> = <span class="keyword">new</span> <span class="type">Schema</span>.<span class="type">Parser</span>().parse(</span><br><span class="line">  <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">    |{</span></span><br><span class="line"><span class="string">    |  "</span><span class="string">namespace": "</span>com.yuzhouwan.<span class="string">bean",</span></span><br><span class="line"><span class="string">    |  "</span><span class="string">type": "</span><span class="string">record",</span></span><br><span class="line"><span class="string">    |  "</span><span class="string">name": "</span><span class="type">BeanA</span><span class="string">",</span></span><br><span class="line"><span class="string">    |  "</span><span class="string">fields": [</span></span><br><span class="line"><span class="string">    |    {"</span><span class="string">name": "</span><span class="string">id", "</span><span class="string">type": "</span><span class="string">int"},</span></span><br><span class="line"><span class="string">    |    {"</span><span class="string">name": "</span><span class="string">price", "</span><span class="string">type": {"</span><span class="string">type": "</span><span class="string">bytes", "</span>logicalT<span class="string">ype": "</span><span class="string">decimal", "</span><span class="string">precision": 8, "</span><span class="string">scale": 4}}</span></span><br><span class="line"><span class="string">    |  ]</span></span><br><span class="line"><span class="string">    |}</span></span><br><span class="line"><span class="string">  "</span><span class="string">""</span>.stripMargin)</span><br><span class="line"><span class="keyword">val</span> conversion: <span class="type">ByteBuffer</span> = decimalConversion.toBytes(decimal, schema, logicalType)</span><br><span class="line"><span class="keyword">val</span> trans: <span class="type">Transaction</span> = <span class="keyword">new</span> <span class="type">Transaction</span>(<span class="number">1</span>, conversion)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>反序列化 decimal 字段</li>
</ul>
<figure class="highlight scala"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> precision = schema.getJsonProp(<span class="string">"precision"</span>)</span><br><span class="line"><span class="keyword">val</span> scale = schema.getJsonProp(<span class="string">"scale"</span>)</span><br><span class="line"><span class="keyword">val</span> logicalType = <span class="type">LogicalTypes</span>.decimal(precision.toString.toInt, scale.toString.toInt)</span><br><span class="line"><span class="keyword">val</span> d: java.math.<span class="type">BigDecimal</span> = decimalConversion.fromBytes(trans.getSale, schema, logicalType)</span><br></pre></td></tr></tbody></table></figure>
<h5 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h5><p>　看到这里，是不是能感觉出来 decimal 使用起来还是很麻烦的，而且踩到的坑还远不止这一个。那我们不禁要想，为啥非要发明这么一个东西呢，直接用 float（单精度浮点数）、double（双精度浮点数）岂不是很省事？</p>
<p>　其实不然，因为一旦遇到 <a href="https://0.30000000000000004.com/">0.30000000000000004</a> 问题，这些依照 <a href="https://en.wikipedia.org/wiki/IEEE_754">IEEE 754</a> 标准构建的浮点数（<a href="https://yuzhouwan.com/posts/27328/">Java</a> / <a href="https://yuzhouwan.com/posts/18651/">Scala</a> / <a href="https://yuzhouwan.com/posts/43687/">Python</a>…），都将束手无策。我们可以在命令行运行一个简单的例子，进行验证。这里以 Python 为例，运行 <code>.1 + .2</code> 后会发现，得到的结果不是预期的 <code>0.3</code> 而是 <code>0.30000000000000004</code>。如果是第一次看到这个结果，想必一定会三观崩塌，开始怀疑是不是下载了一个假 Python。然而，一旦理解其中原理，也就不足为奇了。而想要摸清门道也很简单，只需通过<strong>基数连除</strong>和<strong>连乘法</strong>，先将浮点数转换为二进制表示，再对其做加法操作即可。转换后，<code>0.1 + 0.2</code> 就变成了 <code>0.00011001100110011001100110011001100110011001100110011001</code> + <code>0.00110011001100110011001100110011001100110011001100110011</code>，运算后可以得到 <code>0.01001100110011001100110011001100110011001100110011001100</code>，再将二进制结果转换为十进制的浮点数，就是我们看到的 <code>0.30000000000000004</code> 了。从本质上来说，还是因为二进制是连续的，十进制是非连续的。为什么这么说呢？举个例子，小数点后四位用二进制表示时，数值范围为 <code>0.0000</code> 到 <code>0.1111</code> 之间。而对应到十进制，却只能表示出 <code>0.0625</code>、<code>0.125</code>、<code>0.25</code> 和 <code>0.5</code> 这四个数值的组合结果。另外，有些十进制的小数，转换为二进制之后，还会变成了循环小数。但是，计算机里面浮点数只能存有限的位数，所以，同样也无法精确地表示</p>
<p>　这时候，我们再来看，如果用 <a href="https://docs.python.org/3/library/decimal.html">decimal</a> 则不会遇到这个问题：</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> decimal <span class="keyword">import</span> *</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d = Decimal(<span class="string">".1"</span>) + Decimal(<span class="string">".2"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d</span><br><span class="line">  Decimal(<span class="string">'0.3'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>float(d)</span><br><span class="line">  <span class="number">0.3</span></span><br></pre></td></tr></tbody></table></figure>
<p>　当然，除了上述精确计算的好处之外，decimal 还有便于控制精度、自动和输入保持精度一致，以及允许除以 0 得到 Infinity 等优点。如此看来，decimal 还真的不是一无是处呢 :D</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>Context(prec=<span class="number">6</span>, Emax=<span class="number">999</span>, clamp=<span class="number">1</span>).create_decimal(<span class="string">'1.23e999'</span>)</span><br><span class="line">  Decimal(<span class="string">'1.23000E+999'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">1.00</span> + <span class="number">0.10</span></span><br><span class="line">  <span class="number">1.1</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>Decimal(<span class="string">"1.00"</span>) + Decimal(<span class="string">"0.10"</span>)</span><br><span class="line">  Decimal(<span class="string">'1.10'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>setcontext(ExtendedContext)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>Decimal(<span class="number">1</span>) / Decimal(<span class="number">0</span>)</span><br><span class="line">  Decimal(<span class="string">'Infinity'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>Decimal(<span class="number">-1</span>) / Decimal(<span class="number">0</span>)</span><br><span class="line">  Decimal(<span class="string">'-Infinity'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>Decimal(<span class="number">1</span>) / Decimal(<span class="number">0</span>) + Decimal(<span class="number">-1</span>) / Decimal(<span class="number">0</span>)</span><br><span class="line">  Decimal(<span class="string">'NaN'</span>)</span><br></pre></td></tr></tbody></table></figure>
<h2 id="源码阅读"><a href="#源码阅读" class="headerlink" title="源码阅读"></a>源码阅读</h2><h3 id="Kafka-阅读环境搭建"><a href="#Kafka-阅读环境搭建" class="headerlink" title="Kafka 阅读环境搭建"></a>Kafka 阅读环境搭建</h3><h4 id="安装-gradle"><a href="#安装-gradle" class="headerlink" title="安装 gradle"></a>安装 gradle</h4><p>　在 gradle <a href="https://gradle.org/releases/">下载页面</a>，下载 gradle-4.3.1-all.zip 文件，解压至 <code>D:\apps\gradle</code>，并添加环境变量 <code>PATH=D:\apps\gradle\gradle-4.3.1\bin</code></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 检查是否安装成功</span></span><br><span class="line">$ gradle -v</span><br><span class="line">  ------------------------------------------------------------</span><br><span class="line">  Gradle 4.3.1</span><br><span class="line">  ------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">  Build time:   2017-11-08 08:59:45 UTC</span><br><span class="line">  Revision:     e4f4804807ef7c2829da51877861ff06e07e006d</span><br><span class="line"></span><br><span class="line">  Groovy:       2.4.12</span><br><span class="line">  Ant:          Apache Ant(TM) version 1.9.6 compiled on June 29 2015</span><br><span class="line">  JVM:          1.8.0_111 (Oracle Corporation 25.111-b14)</span><br><span class="line">  OS:           Windows 7 6.1 amd64</span><br></pre></td></tr></tbody></table></figure>
<div class="note success">建议使用 gradlew 命令，可以避免手动安装</div>



<h4 id="gradle-代理设置"><a href="#gradle-代理设置" class="headerlink" title="gradle 代理设置"></a>gradle 代理设置</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gradle xxx -Dhttp.proxyHost=127.0.0.1 -Dhttp.proxyPort=1080</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者修改 gradle.properties 配置文件</span></span><br><span class="line">$ vim gradle.properties</span><br><span class="line">  systemProp.http.proxyHost=192.168.1.101</span><br><span class="line">  systemProp.http.proxyPort=8080</span><br><span class="line">  systemProp.http.nonProxyHosts=*.nonproxyrepos.com|localhost</span><br><span class="line">  systemProp.https.proxyHost=192.168.1.101</span><br><span class="line">  systemProp.https.proxyPort=8080</span><br><span class="line">  systemProp.https.nonProxyHosts=*.nonproxyrepos.com|localhost</span><br><span class="line">  <span class="comment">#systemProp.http.proxyUser=userid</span></span><br><span class="line">  <span class="comment">#systemProp.http.proxyPassword=password</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 【注意】如果在 Kafka 源码目录下修改的 gradle.properties 无法生效，可以直接拷贝到 $USER_HOME/.gradle 目录下</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="编译源码"><a href="#编译源码" class="headerlink" title="编译源码"></a>编译源码</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 下载依赖</span></span><br><span class="line">$ ./gradlew</span><br><span class="line"></span><br><span class="line"><span class="comment"># 增加 `-x test` 参数，可跳过单元测试</span></span><br><span class="line">$ ./gradlew -x <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 随后，生成可以用 Intellij Idea 打开的工程</span></span><br><span class="line">$ ./gradlew idea</span><br></pre></td></tr></tbody></table></figure>
<div class="note info">如果 gradle 的配置文件里面，没有设置 idea 插件，导致项目模块无法被识别。则需要删除 .idea 文件夹，并以 build.gradle 打开为项目，即可</div>



<h3 id="Kafka-Connect-2"><a href="#Kafka-Connect-2" class="headerlink" title="Kafka Connect"></a>Kafka Connect</h3><h4 id="阅读环境搭建"><a href="#阅读环境搭建" class="headerlink" title="阅读环境搭建"></a>阅读环境搭建</h4><p>　Kafka Connect 项目的 <strong>接口定义</strong> 和 <strong>组件模块化</strong> 做得相当到位，整个工程被拆成很多子项目。同时，搭建源码阅读环境的时候，会发现很多依赖在中央仓库中是找不到的，这时候需要下载源码进行本地编译安装。首先，下载 <a href="https://github.com/confluentinc/common"><strong>kafka-connect-common</strong></a> / <a href="https://github.com/confluentinc/kafka-connect-storage-common"><strong>kafka-connect-storage-common</strong></a> 两个父工程，以及相关的依赖子工程 <a href="https://github.com/confluentinc/rest-utils"><strong>rest-utils</strong></a> / <a href="https://github.com/confluentinc/schema-registry"><strong>schema-registry</strong></a> 的源码。通过 <code>git fetch --tags</code> 命令将 tags 全部下载下来之后，选定一个稳定版本 (这里以 v3.3.1 为例)，并创建新分支 <code>v3.3.1</code>，再在新分支下执行 <code>git reset --hard &lt;commit&gt;</code> 统一所有项目代码到 v3.3.1 版本 (这里还有一个依赖的子项目 <a href="https://github.com/julianhyde/aggdesigner"><strong>aggdesigner</strong></a> 也需要本地编译安装，对应版本为 <code>pentaho-aggdesigner-5.1.5-jhyde</code>)。另外，Kafka 也用了一个非常规的版本 <code>0.11.0.1-cp1</code>，这里只需要选择一个略高的版本 <code>0.11.0.1</code> 保证兼容性即可（当然也可以在 Kafka trunk 分支下执行 <code>gradlew installAll</code> 命令编译出对应版本），最后，依次执行 <code>mvn clean install</code> 命令完成打包编译</p>
<h4 id="主体架构"><a href="#主体架构" class="headerlink" title="主体架构"></a>主体架构</h4><h5 id="ConnectDistributed"><a href="#ConnectDistributed" class="headerlink" title="ConnectDistributed"></a>ConnectDistributed</h5><p>　Command line utility that runs Kafka Connect in distributed mode. In this mode, the process joints a group of other workers and work is distributed among them. This is useful for running Connect as a service, where connectors can be submitted to the cluster to be automatically executed in a scalable, distributed fashion. This also allows you to easily scale out horizontally, elastically adding or removing capacity simply by starting or stopping worker instances.</p>
<h5 id="Connect"><a href="#Connect" class="headerlink" title="Connect"></a>Connect</h5><p>　This class ties together all the components of a Kafka Connect process (herder, worker, storage, command interface), managing their lifecycle.</p>
<h5 id="Connector-1"><a href="#Connector-1" class="headerlink" title="Connector"></a>Connector</h5><p>　Connectors manage integration of Kafka Connect with another system, either as an input that ingests data into Kafka or an output that passes data to an external system. Implementations should not use this class directly; they should inherit from SourceConnector or SinkConnector.</p>
<p>　Connectors have two primary tasks. First, given some configuration, they are responsible for creating configurations for a set of <code>{@link Task}s</code> that split up the data processing. For example, a database Connector might create Tasks by dividing the set of tables evenly among tasks. Second, they are responsible for monitoring inputs for changes that require reconfiguration and notifying the Kafka Connect runtime via the ConnectorContext. Continuing the previous example, the connector might periodically check for new tables and notify Kafka Connect of additions and deletions. Kafka Connect will then request new configurations and update the running Tasks.</p>
<h6 id="SinkConnector"><a href="#SinkConnector" class="headerlink" title="SinkConnector"></a>SinkConnector</h6><p>　SourceConnectors implement the connector interface to pull data from another system and send it to Kafka.</p>
<h6 id="SourceConnector"><a href="#SourceConnector" class="headerlink" title="SourceConnector"></a>SourceConnector</h6><p>　SinkConnectors implement the Connector interface to send Kafka data to another system.</p>
<h5 id="Herder"><a href="#Herder" class="headerlink" title="Herder"></a>Herder</h5><p>　The herder interface tracks and manages workers and connectors. It is the main interface for external components to make changes to the state of the cluster. For example, in distributed mode, an implementation of this class knows how to accept a connector configuration, may need to route it to the current leader worker for the cluster so the config can be written to persistent storage, and then ensures the new connector is correctly instantiated on one of the workers.</p>
<p>　This class must implement all the actions that can be taken on the cluster (add/remove connectors, pause/resume tasks, get state of connectors and tasks, etc). The non-Java interfaces to the cluster (REST API and CLI) are very simple wrappers of the functionality provided by this interface.</p>
<p>　In standalone mode, this implementation of this class will be trivial because no coordination is needed. In that case, the implementation will mainly be delegating tasks directly to other components. For example, when creating a new connector in standalone mode, there is no need to persist the config and the connector and its tasks must run in the same process, so the standalone herder implementation can immediately instantiate and start the connector and its tasks.</p>
<h5 id="Worker-1"><a href="#Worker-1" class="headerlink" title="Worker"></a>Worker</h5><p>　Worker runs a (dynamic) set of tasks in a set of threads, doing the work of actually moving<br>data to/from Kafka.</p>
<p>　Since each task has a dedicated thread, this is mainly just a container for them.</p>
<h5 id="Task-1"><a href="#Task-1" class="headerlink" title="Task"></a>Task</h5><p>　Tasks contain the code that actually copies data to/from another system. They receive a configuration from their parent Connector, assigning them a fraction of a Kafka Connect job´s work. The Kafka Connect framework then pushes/pulls data from the Task. The Task must also be able to respond to reconfiguration requests.</p>
<p>　Task only contains the minimal shared functionality between<br><code>{@link org.apache.kafka.connect.source.SourceTask}</code> and<br><code>{@link org.apache.kafka.connect.sink.SinkTask}</code>.</p>
<h6 id="SourceTask"><a href="#SourceTask" class="headerlink" title="SourceTask"></a>SourceTask</h6><p>　SourceTask is a Task that pulls records from another system for storage in Kafka.</p>
<h6 id="SinkTask"><a href="#SinkTask" class="headerlink" title="SinkTask"></a>SinkTask</h6><p>　SinkTask is a Task that takes records loaded from Kafka and sends them to another system. Each task instance is assigned a set of partitions by the Connect framework and will handle all records received from those partitions. As records are fetched from Kafka, they will be passed to the sink task using the {@link #put(Collection)} API, which should either write them to the downstream system or batch them for later writing. Periodically, Connect will call {@link #flush(Map)} to ensure that batched records are actually pushed to the downstream system..</p>
<p>状态机</p>
<ul>
<li><p>Initialization</p>
<p>SinkTasks are first initialized using <code>{@link #initialize(SinkTaskContext)}</code> to prepare the task´s context and <code>{@link #start(Map)}</code> to accept configuration and start any services needed for processing.</p>
</li>
<li><p>Partition Assignment</p>
<p>After initialization, Connect will assign the task a set of partitions using <code>{@link #open(Collection)}</code>. These partitions are owned exclusively by this task until they have been closed with <code>{@link #close(Collection)}</code>.</p>
</li>
<li><p>Record Processing</p>
<p>Once partitions have been opened for writing, Connect will begin forwarding records from Kafka using the <code>{@link #put(Collection)}</code> API. Periodically, Connect will ask the task to flush records using <code>{@link #flush(Map)}</code> as described above.</p>
</li>
<li><p>Partition Rebalancing</p>
<p>Occasionally, Connect will need to change the assignment of this task. When this happens, the currently assigned partitions will be closed with <code>{@link #close(Collection)}</code> and the new assignment will be opened using <code>{@link #open(Collection)}</code>.</p>
</li>
<li><p>Shutdown</p>
<p>When the task needs to be shutdown, Connect will close active partitions (if there are any) and stop the task using <code>{@link #stop()}</code></p>
</li>
</ul>
<h5 id="Storage"><a href="#Storage" class="headerlink" title="Storage"></a>Storage</h5><h6 id="OffsetBackingStore"><a href="#OffsetBackingStore" class="headerlink" title="OffsetBackingStore"></a>OffsetBackingStore</h6><p>　OffsetBackingStore is an interface for storage backends that store key-value data. The backing store doesn´t need to handle serialization or deserialization. It only needs to support reading/writing bytes. Since it is expected these operations will require network operations, only bulk operations are supported.</p>
<p>　Since OffsetBackingStore is a shared resource that may be used by many OffsetStorage instances that are associated with individual tasks, the caller must be sure keys include information about the connector so that the shared namespace does not result in conflicting keys.</p>
<ul>
<li>KafkaOffsetBackingStore</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">Implementation of OffsetBackingStore that uses a Kafka topic to store offset data.</span><br><span class="line"></span><br><span class="line">Internally, this implementation both produces to and consumes from a Kafka topic <span class="built_in">which</span> stores the offsets. It accepts producer and consumer overrides via its configuration but forces some settings to specific values to ensure correct behavior (e.g. acks, auto.offset.reset).</span><br></pre></td></tr></tbody></table></figure>
<h6 id="StatusBackingStore"><a href="#StatusBackingStore" class="headerlink" title="StatusBackingStore"></a>StatusBackingStore</h6><ul>
<li>KafkaStatusBackingStore</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">StatusBackingStore implementation <span class="built_in">which</span> uses a compacted topic <span class="keyword">for</span> storage of connector and task status information. When a state change is observed, the new state is written to the compacted topic. The new state will not be visible until it has been <span class="built_in">read</span> back from the topic.</span><br><span class="line"></span><br><span class="line">In spite of their names, the putSafe() methods cannot guarantee the safety of the write (since Kafka itself cannot provide such guarantees currently), but it can avoid specific unsafe conditions. In particular, we putSafe() allows writes <span class="keyword">in</span> the following conditions:</span><br><span class="line"></span><br><span class="line">　1) It is (probably) safe to overwrite the state <span class="keyword">if</span> there is no previous value.</span><br><span class="line">　2) It is (probably) safe to overwrite the state <span class="keyword">if</span> the previous value was <span class="built_in">set</span> by a worker with the same workerId.</span><br><span class="line">　3) It is (probably) safe to overwrite the previous state <span class="keyword">if</span> the current generation is higher than the previous .</span><br><span class="line"></span><br><span class="line">Basically all these conditions <span class="keyword">do</span> is reduce the window <span class="keyword">for</span> conflicts. They obviously cannot take into account <span class="keyword">in</span>-flight requests.</span><br></pre></td></tr></tbody></table></figure>
<h6 id="ConfigBackingStore"><a href="#ConfigBackingStore" class="headerlink" title="ConfigBackingStore"></a>ConfigBackingStore</h6><ul>
<li>KafkaConfigBackingStore</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">Provides persistent storage of Kafka Connect connector configurations <span class="keyword">in</span> a Kafka topic.</span><br><span class="line"></span><br><span class="line">This class manages both connector and task configurations. It tracks three types of configuration entries:</span><br><span class="line"></span><br><span class="line">　1. Connector config: map of string -&gt; string configurations passed to the Connector class, with support <span class="keyword">for</span>　expanding this format <span class="keyword">if</span> necessary. (Kafka key: connector-[connector-id]).　These configs are *not* ephemeral. They represent the <span class="built_in">source</span> of truth. If the entire Connect　cluster goes down, this is all that is really needed to recover.</span><br><span class="line"></span><br><span class="line">　2. Task configs: map of string -&gt; string configurations passed to the Task class, with support <span class="keyword">for</span> expanding this format <span class="keyword">if</span> necessary. (Kafka key: task-[connector-id]-[task-id]). These configs are ephemeral; they are stored here to</span><br><span class="line">　　a) disseminate them to all workers <span class="keyword">while</span> ensuring agreement and</span><br><span class="line">　　b) to allow faster cluster/worker recovery since the common <span class="keyword">case</span> of recovery (restoring a connector) will simply result <span class="keyword">in</span> the same configuration as before the failure.</span><br><span class="line"></span><br><span class="line">　3. Task commit <span class="string">"configs"</span>: records indicating that previous task config entries should be committed and all task configs <span class="keyword">for</span> a connector can be applied. (Kafka key: commit-[connector-id]. This config has two effects. First, it records the number of tasks the connector is currently running (and can therefore increase/decrease parallelism). Second, because each task config is stored separately but they need to be applied together to ensure each partition is assigned to a single task, this record also indicates that task configs <span class="keyword">for</span> the specified connector can be <span class="string">"applied"</span> or <span class="string">"committed"</span>.</span><br><span class="line"></span><br><span class="line">This configuration is expected to be stored <span class="keyword">in</span> a *single partition* and *compacted* topic. Using a single partition ensures we can enforce ordering on messages, allowing Kafka to be used as a write ahead <span class="built_in">log</span>. Compaction allows us to clean up outdated configurations over time. However, this combination has some important implications <span class="keyword">for</span> the implementation of this class and the configuration state that it may expose.</span><br><span class="line"></span><br><span class="line">Connector configurations are independent of all other configs, so they are handled easily. Writing a single record is already atomic, so these can be applied as soon as they are <span class="built_in">read</span>. One connectors config does not affect any others, and they <span class="keyword">do</span> not need to coordinate with the connector<span class="string">'s task configuration at all.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">　The most obvious implication for task configs is the need for the commit messages. Because Kafka does not currently have multi-record transactions or support atomic batch record writes, task commit messages are required to ensure that readers do not end up using inconsistent configs. For example, consider if a connector wrote configs for its tasks, then was reconfigured and only managed to write updated configs for half its tasks. If task configs were applied immediately you could be using half the old configs and half the new configs. In that condition, some partitions may be double-assigned because the old config and new config may use completely different assignments. Therefore, when reading the log, we must buffer config updates for a connector'</span>s tasks and only apply atomically them once a commit message has been <span class="built_in">read</span>.</span><br><span class="line"></span><br><span class="line">However, there are also further challenges. This simple buffering approach would work fine as long as the entire <span class="built_in">log</span> was always available, but we would like to be able to <span class="built_in">enable</span> compaction so our configuration topic does not grow indefinitely. Compaction may <span class="built_in">break</span> a normal <span class="built_in">log</span> because old entries will suddenly go missing. A new worker reading from the beginning of the <span class="built_in">log</span> <span class="keyword">in</span> order to build up the full current configuration will see task commits, but some records required <span class="keyword">for</span> those commits will have been removed because the same keys have subsequently been rewritten. For example, <span class="keyword">if</span> you have a sequence of record keys <span class="string">"[connector-foo-config, task-foo-1-config, task-foo-2-config, commit-foo (2 tasks), task-foo-1-config, commit-foo (1 task)]"</span>, we can end up with a compacted <span class="built_in">log</span> containing <span class="string">"[connector-foo-config, task-foo-2-config, commit-foo (2 tasks), task-foo-1-config, commit-foo (1 task)]"</span>. When <span class="built_in">read</span> back, the first commit will see an invalid state because the first task-foo-1-config has been cleaned up.</span><br><span class="line"></span><br><span class="line">Compaction can further complicate things <span class="keyword">if</span> writing new task configs fails mid-write. Consider a similar scenario as the previous one, but <span class="keyword">in</span> this <span class="keyword">case</span> both the first and second update will write 2 task configs. However, the second write fails half of the way through: <span class="string">"[connector-foo-config, task-foo-1-config, task-foo-2-config, commit-foo (2 tasks), task-foo-1-config]"</span>. Now compaction occurs and we are left with <span class="string">"[connector-foo-config, task-foo-2-config, commit-foo (2 tasks), task-foo-1-config]"</span>. At the first commit, we donot have a complete <span class="built_in">set</span> of configs. And because of the failure, there is no second commit. We are left <span class="keyword">in</span> an inconsistent state with no obvious way to resolve the issue -- we can try to keep on reading, but the failed node may never recover and write the updated config. Meanwhile, other workers may have seen the entire <span class="built_in">log</span>; they will see the second task-foo-1-config waiting to be applied, but will otherwise think everything is ok -- they have a valid <span class="built_in">set</span> of task configs <span class="keyword">for</span> connector <span class="string">"foo"</span>.</span><br><span class="line"></span><br><span class="line">Because we can encounter these inconsistencies and addressing them requires support from the rest of the system (resolving the task configuration inconsistencies requires support from the connector instance to regenerate updated configs), this class exposes not only the current <span class="built_in">set</span> of configs, but also <span class="built_in">which</span> connectors have inconsistent data. This allows users of this class (i.e., Herder implementations) to take action to resolve any inconsistencies. These inconsistencies should be rare (as described above, due to compaction combined with leader failures <span class="keyword">in</span> the middle of updating task configurations).</span><br><span class="line"></span><br><span class="line">Note that the expectation is that this config storage system has only a single writer at a time. The <span class="built_in">caller</span> (Herder) must ensure this is the <span class="keyword">case</span>. In distributed mode this will require forwarding config change requests to the leader <span class="keyword">in</span> the cluster (i.e. the worker group coordinated by the Kafka broker).</span><br><span class="line"></span><br><span class="line">Since processing of the config <span class="built_in">log</span> occurs <span class="keyword">in</span> a background thread, callers must take care when using accessors. To simplify handling this correctly, this class only exposes a mechanism to snapshot the current state of the cluster. Updates may <span class="built_in">continue</span> to be applied (and callbacks invoked) <span class="keyword">in</span> the background. Callers must take care that they are using a consistent snapshot and only update when it is safe. In particular, <span class="keyword">if</span> task configs are updated <span class="built_in">which</span> require synchronization across workers to commit offsets and update the configuration, callbacks and updates during the rebalance must be deferred.</span><br></pre></td></tr></tbody></table></figure>
<h5 id="RestServer"><a href="#RestServer" class="headerlink" title="RestServer"></a>RestServer</h5><p>　Embedded server for the REST API that provides the control plane for Kafka Connect workers.</p>
<h5 id="Plugin"><a href="#Plugin" class="headerlink" title="Plugin"></a>Plugin</h5><h6 id="PluginDesc"><a href="#PluginDesc" class="headerlink" title="PluginDesc"></a>PluginDesc</h6><h6 id="DelegatingClassLoader"><a href="#DelegatingClassLoader" class="headerlink" title="DelegatingClassLoader"></a>DelegatingClassLoader</h6><h4 id="Confluent-开源版本"><a href="#Confluent-开源版本" class="headerlink" title="Confluent 开源版本"></a>Confluent 开源版本</h4><h5 id="模块架构图"><a href="#模块架构图" class="headerlink" title="模块架构图"></a>模块架构图</h5><p><img data-src="/picture/kafka/kafka_connect_architecture.png" alt="Kafka Connector Architecture"></p>
<center>（利用 <a href="https://www.axure.com.cn/" target="_blank">Axure</a>™ 绘制而成）</center>


<h5 id="kafka-connect-common"><a href="#kafka-connect-common" class="headerlink" title="kafka-connect-common"></a>kafka-connect-common</h5><p>　该项目是整个 Kafka Connect 工程的<strong>根目录级</strong>父工程，其中主要包含了，common 接口定义、配置读取、Metrics /  JMX 指标设计、公共工具类，以及如何 build 编译、package 打包哪些文件、license 著作权标识 等工程类的部分</p>
<h5 id="kafka-connect-storage-common"><a href="#kafka-connect-storage-common" class="headerlink" title="kafka-connect-storage-common"></a>kafka-connect-storage-common</h5><p>　官方对该项目定位描述为简单的一句话：”Kafka Connect common packages for connectors transferring data between Kafka and distributed filesystems or cloud storage”。实际包含了很多实质性内容，Common 模块、Core 模块、Format 模块、Partitioner 模块、WAL 模块、Hive 模块 等</p>
<h6 id="Common-模块"><a href="#Common-模块" class="headerlink" title="Common 模块"></a>Common 模块</h6><p>　主要定义了 ComposableConfig / SchemaGenerator 接口，分别用于 配置组合 和 Schema 生成</p>
<h6 id="Core-模块"><a href="#Core-模块" class="headerlink" title="Core 模块"></a>Core 模块</h6><p>　主要定义了 Storage 接口，用于分布式存储。基于 Storage 接口的不同实现，一个 Storage 对象可以是分布式文件系统里面的一个文件或者一个文件夹，也可以是对象存储系统中的一个存储对象。类似地，路径就对应于分布式文件系统中的实际路径和对象存储库中的查找键</p>
<h6 id="Format-模块"><a href="#Format-模块" class="headerlink" title="Format 模块"></a>Format 模块</h6><p>　主要定义了 Format / SchemaFileReader / RecordWriter 三个接口，分别用于 存储类型格式化（e.g. Path in HDFS, String in S3）、从 Storage 中读取 Schema 和 如何将记录写入 Storage</p>
<h6 id="Partitioner-模块"><a href="#Partitioner-模块" class="headerlink" title="Partitioner 模块"></a>Partitioner 模块</h6><p>　该模块主要定义了 Partitioner 接口，用来对接收到的消息进行分区，生成对应的目录和文件名。支持 Default / Hourly / Daily / TimeBase / Field 和自定义的 Partitioner，另外 TimeBase 的 Partitioner 还同时支持 ingestion time / event time 两种时间类型</p>
<h6 id="WAL-模块"><a href="#WAL-模块" class="headerlink" title="WAL 模块"></a>WAL 模块</h6><p>　定义了 WAL 接口，用于规范 Kafka offset 信息如何编码到 WAL</p>
<h6 id="Hive-模块"><a href="#Hive-模块" class="headerlink" title="Hive 模块"></a>Hive 模块</h6><p>　主要定义了 HiveUtil 抽象类、HiveFactory 接口（HiveUtil 的工厂类） 和 Schema / Config / Exception / MetaStore 等相关实现类</p>
<h5 id="kafka-connect-hdfs"><a href="#kafka-connect-hdfs" class="headerlink" title="kafka-connect-hdfs"></a>kafka-connect-hdfs</h5><p>　首先可以看出 State 枚举类中给出了 <code>RECOVERY_STARTED</code>,  <code>RECOVERY_PARTITION_PAUSED</code>,  <code>WAL_APPLIED</code>,  <code>WAL_TRUNCATED</code>,  <code>OFFSET_RESET</code>,  <code>WRITE_STARTED</code>,  <code>WRITE_PARTITION_PAUSED</code>,  <code>SHOULD_ROTATE</code>,  <code>TEMP_FILE_CLOSED,  WAL_APPENDED</code>,  <code>FILE_COMMITTED</code> 一共 11 种任务运行状态，写入的逻辑全都在 <code>TopicPartitionWriter</code> 的 <code>write</code> 方法里面了，而异常恢复的逻辑，则在 <code>recover</code> 方法中实现</p>
<p><img data-src="/picture/kafka/kafka_connect_process_flow_kafka_2_hdfs.png" alt="Kafka Connector Process Flow about Kafka to HDFS"></p>
<center>（利用 <a href="https://www.axure.com.cn/" target="_blank">Axure</a>™ 绘制而成）</center>





<h4 id="落脚点"><a href="#落脚点" class="headerlink" title="落脚点"></a>落脚点</h4><h5 id="Kafka-Connect-组件的-ClassLoader-隔离"><a href="#Kafka-Connect-组件的-ClassLoader-隔离" class="headerlink" title="Kafka Connect 组件的 ClassLoader 隔离"></a>Kafka Connect 组件的 ClassLoader 隔离</h5><p>　Worker <a href="https://github.com/apache/kafka/blob/trunk/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/Worker.java#L181">启动</a>一个 Task</p>
<h5 id="分布式情况下，如何做到在一个节点上，更新了-ClassLoader，广播到整个集群"><a href="#分布式情况下，如何做到在一个节点上，更新了-ClassLoader，广播到整个集群" class="headerlink" title="分布式情况下，如何做到在一个节点上，更新了 ClassLoader，广播到整个集群"></a>分布式情况下，如何做到在一个节点上，更新了 ClassLoader，广播到整个集群</h5><p>　不需要广播，滚动升级，灰度发布，即可</p>
<h2 id="社区跟进"><a href="#社区跟进" class="headerlink" title="社区跟进"></a>社区跟进</h2><ul>
<li><a href="https://github.com/apache/kafka/pulls?utf8=%E2%9C%93&amp;q=is%3Apr+author%3Aasdf2014">Kafka Pull Request</a></li>
<li><a href="https://github.com/Landoop/kafka-connect-ui/pulls?utf8=%E2%9C%93&amp;q=is%3Apr+author%3Aasdf2014">Kafka-Connect-UI Pull Request</a></li>
</ul>
<p>　详见：《<a href="https://yuzhouwan.com/posts/19631/">如何成为 Apache 的 PMC</a>》</p>
<h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><h3 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h3><ul>
<li><a href="https://hub.docker.com/r/confluentinc/cp-kafka-connect/">Kafka Connect 镜像</a></li>
<li><a href="https://yeasy.gitbooks.io/docker_practice/content/install/mirror.html">国内镜像源配置</a></li>
</ul>
<h3 id="Book"><a href="#Book" class="headerlink" title="Book"></a>Book</h3><ul>
<li><a href="https://www.amazon.cn/Apache-Kafka-Garg-Nishant/dp/B00FYS7OUW">Apache Kafka</a></li>
<li><a href="https://www.amazon.cn/Apache-Kafka-Cookbook-Minni-Saurabh/dp/B015EHCTES">Apache Kafka Cookbook</a></li>
<li><a href="https://www.amazon.cn/Kafka-The-Definitive-Guide-Narkhede-Neha/dp/1491936169">Kafka: The Definitive Guide</a></li>
<li><a href="https://www.amazon.cn/dp/B077698DBP">Kafka 技术内幕：图文详解 Kafka 源码设计与实现</a></li>
<li><a href="https://www.amazon.cn/dp/B072HQC5KB">Apache Kafka 源码剖析</a></li>
</ul>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt=""></a></td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>大数据</category>
      </categories>
      <tags>
        <tag>Apache Storm</tag>
        <tag>Apache Kafka</tag>
        <tag>Docker</tag>
        <tag>Gradle</tag>
        <tag>HDFS</tag>
        <tag>Apache Druid</tag>
        <tag>ElasticSearch</tag>
        <tag>Python</tag>
        <tag>Message Queue</tag>
      </tags>
  </entry>
  <entry>
    <title>Apache Druid：一款高效的 OLAP 引擎</title>
    <url>/posts/5845/</url>
    <content><![CDATA[<h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>　<strong>Apache Druid</strong>™ 是目前非常流行的高性能的，分布式列存储的 <strong>OLAP</strong> 引擎（准确来说是 <strong>MOLAP</strong>）。它是一款可以快速（实时）访问大量的、很少变化的数据的系统。并被设计为，在面对代码部署、机器故障和生产系统的其他可能性问题时，依旧能 100％ 地正常提供服务</p>
<p><img data-src="/picture/druid/druid_pumpkin_compressed.png" alt="Apache Druid Pumpkin"></p>
<center>（图片来源：Vadim Ogievetsky 在万圣节的个人作品，已获得授权）</center>



<h3 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h3><h4 id="分析事件流"><a href="#分析事件流" class="headerlink" title="分析事件流"></a>分析事件流</h4><p>　Druid 支持对 event-driven 数据进行快速地高并发查询。还可以实时地摄入流式数据，并提供亚秒级查询能力，以支持强大的 UI 交互</p>
<h4 id="创新的架构设计"><a href="#创新的架构设计" class="headerlink" title="创新的架构设计"></a>创新的架构设计</h4><p>　Druid 是一种新型数据库，它结合了 OLAP 分析数据库、时间序列数据库 和 全文检索 的思想，以支持流式体系架构下的大部分应用场景</p>
<h4 id="构建事件驱动的数据栈"><a href="#构建事件驱动的数据栈" class="headerlink" title="构建事件驱动的数据栈"></a>构建事件驱动的数据栈</h4><p>　Druid 天然集成了消息队列（Kafka、AWS Kinesis 等）和数据湖（HDFS、AWS S3 等），使得其非常适用于流式总线和流处理器的查询层</p>
<h4 id="解锁新的工作流"><a href="#解锁新的工作流" class="headerlink" title="解锁新的工作流"></a>解锁新的工作流</h4><p>　Druid 旨在对实时数据和历史数据进行快速地即时分析。使用可快速更替的查询，进行趋势解释，数据探索，以响应各种分析诉求</p>
<h4 id="多环境部署"><a href="#多环境部署" class="headerlink" title="多环境部署"></a>多环境部署</h4><p>　Druid 可以部署在任何的 <code>*NIX</code> 商用硬件上，无论是在云端还是内部部署。Druid 是 cloud-native 的，这意味着集群扩容和缩容，就像添加和删除进程一样简单</p>
<h4 id="多数据源摄入"><a href="#多数据源摄入" class="headerlink" title="多数据源摄入"></a>多数据源摄入</h4><p>　Druid 支持将多种外部数据系统作为数据源，进行数据摄入，包括 <a href="https://yuzhouwan.com/tags/Apache-Hadoop/">Hadoop</a>、<a href="https://yuzhouwan.com/posts/4735/">Spark</a>、<a href="https://yuzhouwan.com/tags/Apache-Storm/">Storm</a> 和 <a href="https://yuzhouwan.com/posts/26002/">Kafka</a> 等</p>
<h4 id="多版本控制"><a href="#多版本控制" class="headerlink" title="多版本控制"></a>多版本控制</h4><p>　多版本控制（<strong>MVCC</strong>，<strong>M</strong>ulti-<strong>V</strong>ersion <strong>C</strong>oncurrent <strong>C</strong>ontrol），主要是为了解决多用户操作同一条记录时的并发问题。MVCC 设计思路是，在并发访问数据库时，不使用粗暴的行锁，而是在事务型操作更新数据时，生成一个新版本的数据。如此，可以保证读写分离，避免了读写操作互相阻塞，以提高并发性能。另外，约束任意时刻只有最新版本的记录是有效的，即也保证了数据的一致性</p>
<p>　而 Druid 中是使用数据更新时间来区分版本，历史节点只加载最新版本的数据。同时，<strong>实时数据索引</strong>与<strong>离线数据批量覆盖</strong>同时进行的 Lambda 架构设计，既满足了实时响应的需求，又确保了数据的准确性</p>
<h4 id="易于运维"><a href="#易于运维" class="headerlink" title="易于运维"></a>易于运维</h4><p>　Druid 集群可以做到 Self-healing 和 Self-balancing。如果 Druid 服务器发生故障，系统将会自动绕过损坏的路由，直到这些机器恢复或被替换掉。在扩缩容集群的时候，只需要增加或下线服务器，集群本身会在后台自动 re-balance。Druid 在设计上保证了可以全天候工作，不会因为任何原因而停机，包括配置更改和集群升级</p>
<a id="more"></a>
<h3 id="基础组件"><a href="#基础组件" class="headerlink" title="基础组件"></a>基础组件</h3><h4 id="Router-进程"><a href="#Router-进程" class="headerlink" title="Router 进程"></a><a href="https://druid.apache.org/docs/latest/design/router.html">Router</a> 进程</h4><p>　Router 进程可以在 Brokers、Overlords 和 Coordinators 进程之上，提供一层统一的 API 网关。Router 进程本身是可选的，不过如果集群的数据规模已经达到了 TB 级别，还是需要考虑启用的（<code>druid.router.managementProxy.enabled=true</code>）。因为一旦集群规模达到一定的数量级，那么发生故障的概率就会变得不容忽视，而 Router 支持将请求只发送给健康的节点，避免请求失败。同时，查询的响应时间和资源消耗，也会随着数据量的增长而变高，而 Router 支持设置查询的优先级和负载均衡策略，避免了大查询造成的队列堆积或查询热点等问题。另外，Router 节点还可用于将查询路由到不同的 Broker 节点，便于实现冷热分层，以更好地应对超大规模数据集。默认情况下，Router 会根据设置的 <a href="https://druid.apache.org/docs/latest/operations/rule-configuration.html">Rule</a> 规则，来路由查询请求。例如，如果将最近 1 个月的数据加载到热集群中，则最近一个月内的查询可以路由到一组专用 Broker，超出该时间范围的查询将被路由到另一组 Broker，如此便实现了查询的冷热隔离</p>
<h4 id="Broker-进程"><a href="#Broker-进程" class="headerlink" title="Broker 进程"></a><a href="https://druid.apache.org/docs/latest/design/broker.html">Broker</a> 进程</h4><p>　Broker 进程从客户端接收查询请求，并将这些查询转发给 Historical 和 MiddleManager 进程（通过存储在 <a href="https://yuzhouwan.com/posts/31915/">ZooKeeper</a> 上的元数据，可以准确地知道 Segment 具体在哪个节点上）。Broker 在接收到这些查询的结果之后，将会合并查询结果并将它们返回给客户端。用户通常会查询 Broker，而不是直接查询 Historical 或 MiddleManager 进程</p>
<h4 id="Overlord-进程"><a href="#Overlord-进程" class="headerlink" title="Overlord 进程"></a><a href="https://druid.apache.org/docs/latest/design/overlord.html">Overlord</a> 进程</h4><p>　Overlord 进程监视 MiddleManager 进程，是数据摄入的控制器。负责将数据摄入的任务分配给 MiddleManagers 并协调 Segment 的发布，包括接受、拆解、分配 Task，以及创建 Task 相关的锁，并返回 Task 的状态。大致流程如下图所示：</p>
<p><img data-src="/picture/druid/druid_overlord_and_middle_managers_with_zk.png" alt="Overlord and MiddleManagers with ZooKeeper in Apache Druid"></p>
<center>（图片来源：<a href="https://druid.apache.org/docs/latest/design/" target="_blank">Apache Druid</a>™ 官网）</center>

<div class="note info">在很久远的 0.5.29 版本中，Overlord 被称之为 IndexCoordinator</div>

<h4 id="MiddleManager-进程"><a href="#MiddleManager-进程" class="headerlink" title="MiddleManager 进程"></a><a href="https://druid.apache.org/docs/latest/design/middlemanager.html">MiddleManager</a> 进程</h4><p>　MiddleManager 进程负责将新数据摄入到集群中，并发布新的 Segment</p>
<p>　MiddleManager 进程是执行提交的任务的工作节点。Middle Managers 将任务转发给在不同 JVM 中运行的 <a href="https://druid.apache.org/docs/latest/design/peons.html">Peon</a> 进程（如此，可以做到资源和日志的隔离）。MiddleManager、Peon、Task 的对应关系是，每个 Peon 进程一次只能运行一个 Task 任务，但一个 MiddleManager 却可以管理多个 Peon 进程</p>
<h4 id="Coordinator-进程"><a href="#Coordinator-进程" class="headerlink" title="Coordinator 进程"></a><a href="https://druid.apache.org/docs/latest/design/coordinator.html">Coordinator</a> 进程</h4><p>　Coordinator 进程监视 Historical 节点。Coordinator 负责将 Segment 分配给指定的 Historical 节点，并确保 Segment 在 Historical 节点之间保持负载均衡。另外，Coordinator 还需要加载新的 Segment，以及基于配置的 <a href="https://druid.apache.org/docs/latest/operations/rule-configuration.html">Rule</a> 来丢弃过时的 Segment</p>
<p>　Coordinator 是周期性运行的（由 <code>druid.coordinator.period</code> 配置指定，默认执行间隔为 <code>60s</code>）。因为需要评估集群的当前状态，才能决定应用哪种策略，所以，Coordinator 需要维护和 <a href="https://yuzhouwan.com/posts/31915/">ZooKeeper</a> 的连接，以获取集群的信息。而关于 Segment 和 Rule 的信息保存在了元数据库中，所以也需要维护与元数据库的连接</p>
<h4 id="Historical-进程"><a href="#Historical-进程" class="headerlink" title="Historical 进程"></a><a href="https://druid.apache.org/docs/latest/design/historical.html">Historical</a> 进程</h4><p>　Historical 进程是处理存储和查询“历史”数据（包括系统中所有已经存在足够长时间、可以被提交的流式数据）的主要工具（可以理解为，是整个 Druid 集群的支柱）。Historical 进程从 Deep Storage 中下载 Segment，并响应有关这些 Segment 的查询请求（这些请求来自 Broker 进程）。另外，Historical 进程不处理写入请求</p>
<p>　Historical 进程采用了 <code>无共享架构设计</code>，它知道如何去加载和删除 Segment，以及如何基于 Segment 来响应查询。因此，即便底层的 Deep Storage 无法正常工作，Historical 进程还是能针对其已同步的 Segments，正常提供查询服务</p>
<h3 id="核心插件"><a href="#核心插件" class="headerlink" title="核心插件"></a>核心插件</h3><h4 id="Kafka-Indexing-Service"><a href="#Kafka-Indexing-Service" class="headerlink" title="Kafka Indexing Service"></a>Kafka Indexing Service</h4><p>　Kafka Indexing Service 可以在 Overlord 上配置 Supervisor（这里的监管者具体是指 <code>KafkaSupervisor</code>，负责监控单个 DataSource 下的 KafkaIndexTask（Apache Druid 中的 <a href="https://druid.apache.org/docs/latest/querying/datasource.html">DataSource</a> 可以理解为关系型数据库中的表）。在其构造的时候，可以接受 <code>KafkaSupervisorSpec</code> 以知晓 Kafka 的 Topic 相关的配置信息，以及摄入的规则，用于生成 <code>KafkaIndexTask</code> 索引任务），并负责管理 Kafka 索引任务的创建和生命周期。这些 KIS 任务使用 Kafka 自身的分区和偏移机制来读取事件，因此能够提供 exactly-once 摄取的保证（旧版本下，Tranquility 采用的是 push 的方式，则完全无法实现不丢不重的特性）。KIS 任务还能够从 Kafka 读取非近期事件，并且不受其他摄取机制强加的窗口期限的影响。另外，Supervisor 会监控索引任务的状态，以便管理故障，并保证了可伸缩性和易复制的特性。更多差异点，详见下面的对比表：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">Before</th>
<th style="text-align:center">After</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">插件</td>
<td style="text-align:center">Druid Kafka Eight</td>
<td style="text-align:center">Kafka Indexing Service</td>
</tr>
<tr>
<td style="text-align:center">处理流式数据的模式</td>
<td style="text-align:center">push</td>
<td style="text-align:center">pull</td>
</tr>
<tr>
<td style="text-align:center">Exactly-Once</td>
<td style="text-align:center">push 模式 + 高级 Kafka API，导致无法实现</td>
<td style="text-align:center">pull 模式 + 低级 Kafka API，已实现</td>
</tr>
<tr>
<td style="text-align:center">乱序数据</td>
<td style="text-align:center">超过设定的时间窗口的数据会被丢弃，需通过离线任务补数据</td>
<td style="text-align:center">不受时间窗口限制，能够读取非近期的数据</td>
</tr>
<tr>
<td style="text-align:center">高可用</td>
<td style="text-align:center"><a href="https://druid.apache.org/docs/latest/ingestion/standalone-realtime.html">Realtime</a> 单进程（一旦发生宕机，节点上未提交到 DeepStorage 的数据将全部丢失）</td>
<td style="text-align:center">Historical 多进程</td>
</tr>
<tr>
<td style="text-align:center">易用性</td>
<td style="text-align:center">每个节点都需要唯一的配置，且 Schema 变更后需滚动重启</td>
<td style="text-align:center">统一配置，且无需重启</td>
</tr>
<tr>
<td style="text-align:center">可见性</td>
<td style="text-align:center">实时</td>
<td style="text-align:center">非实时</td>
</tr>
</tbody>
</table>
</div>
<div class="note info">在 0.16.0 版本中，Apache Druid 彻底删除了 Realtime Node 相关的插件，包括了 druid-kafka-eight、druid-kafka-eight-simpleConsumer、druid-rabbitmq 和 druid-rocketmq</div>
<div class="note warning">虽然新引入的 KIS 有诸多好处，但是世上并不存在“银弹”。因为 KIS 采用了 pull 的方式摄入数据，必然会存在拉取的频率一说。该频率由 offsetFetchPeriod 参数控制，默认 30s 会拉取一次，而最快只能 5s 拉取一次。那为什么不能设置更小的值呢？因为如果过于频繁地向 Kafka 发起请求，可能影响到 Kafka 的稳定性</div>



<h3 id="外部依赖"><a href="#外部依赖" class="headerlink" title="外部依赖"></a>外部依赖</h3><h4 id="Metadata-Storage"><a href="#Metadata-Storage" class="headerlink" title="Metadata Storage"></a><a href="https://druid.apache.org/docs/latest/dependencies/metadata-storage.html">Metadata Storage</a></h4><p>　存储元数据信息，包括 DataSource、Segment 和 Task，以及一些配置信息等。默认使用 Derby，生成环境通常会选择 MySQL 或 PostgreSQL 作为存储媒介</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">表名</th>
<th style="text-align:center">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">druid_datasource</td>
<td style="text-align:center">存储 DataSources，以便 Kafka Index Service 查找</td>
</tr>
<tr>
<td style="text-align:center">druid_pendingsegments</td>
<td style="text-align:center">存储 pending 的 Segments</td>
</tr>
<tr>
<td style="text-align:center">druid_segments</td>
<td style="text-align:center">存储每个 Segment 的 metadata 信息<br>（表字段：segment_id, datasource, start, end, size, version, partition_num, num_replicas, num_rows, is_published, is_available, is_overshadowed, shardSpec, dimensions, metrics）</td>
</tr>
<tr>
<td style="text-align:center">druid_rules</td>
<td style="text-align:center">关于 Segment 的 load / drop 规则</td>
</tr>
<tr>
<td style="text-align:center">druid_config</td>
<td style="text-align:center">存放运行时配置信息</td>
</tr>
<tr>
<td style="text-align:center">druid_tasks</td>
<td style="text-align:center">为 Indexing Service 保存 Task 信息</td>
</tr>
<tr>
<td style="text-align:center">druid_tasklogs</td>
<td style="text-align:center">为 Indexing Service 保存 Task 日志</td>
</tr>
<tr>
<td style="text-align:center">druid_tasklocks</td>
<td style="text-align:center">为 Indexing Service 保存 Task 锁</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">上面三张表，都是 Overlord 用来存放索引 Task 的数据，防止 Overlord 挂掉，而导致 Task 丢失</td>
</tr>
<tr>
<td style="text-align:center">druid_supervisors</td>
<td style="text-align:center">为 Indexing Service 保存  Supervisor 信息</td>
</tr>
<tr>
<td style="text-align:center">druid_audit</td>
<td style="text-align:center">记录配置、Coordinator 规则的变化</td>
</tr>
</tbody>
</table>
</div>
<div class="note info">在 0.16.0 版本中，Apache Druid 从 druid_segments 表中删除了无用的 is_realtime 字段</div>
<div class="note info">在 0.19.0 版本中，Apache Druid 为了解决反序列化 payload 带来的性能问题，将 payload 字段替换为 dimensions、metrics 和 shardSpec</div>

<h4 id="Deep-Storage"><a href="#Deep-Storage" class="headerlink" title="Deep Storage"></a><a href="https://druid.apache.org/docs/latest/dependencies/deep-storage.html">Deep Storage</a></h4><p>　Deep Storage 作为每个 Druid Server 都可以访问的共享文件存储。通常是像 <a href="https://github.com/apache/druid/blob/master/docs/development/extensions-core/hdfs.md">HDFS</a>、<a href="https://github.com/apache/druid/blob/master/docs/development/extensions-contrib/aliyun-oss-extensions.md">AliyunOSS</a> 或 <a href="https://github.com/apache/druid/blob/master/docs/development/extensions-core/s3.md">S3</a> 这样的分布式对象存储，或者是网络文件系统（NFS）。Druid 使用它来存储已被摄入系统的任何数据</p>
<p>　Druid 仅将 Deep Storage 用作数据的备份，并将其作为在 Druid 进程之间在后台传输数据的一种方式。当接受到查询请求，Historical 进程不会从 Deep Storage 读取数据，而是在响应任何查询之前，读取从本地磁盘 pre-fetched 的 Segments。这意味着 Druid 在查询期间永远不需要访问 Deep Storage，从而极大地降低了查询延迟。这也意味着，必须保证 Deep Storage 和 Historical 进程所在节点，能拥有足够的磁盘空间</p>
<h4 id="ZooKeeper"><a href="#ZooKeeper" class="headerlink" title="ZooKeeper"></a><a href="https://druid.apache.org/docs/latest/dependencies/zookeeper.html">ZooKeeper</a></h4><p>　用于管理集群的当前状态，并涵盖了以下的几个主要特性：</p>
<ul>
<li>Coordinator 节点的 Leader 选举</li>
<li>Historical 节点发布 Segment 的协议</li>
<li>Coordinator 和 Historical 之间 load / drop Segment 的协议</li>
<li>Overlord 节点的 Leader 选举</li>
<li>Overlord 和 MiddleManager 之间的 Task 管理</li>
</ul>
<div class="note info">选举通过 Apache Curator 框架中的 LeaderLatch 来完成，具体的实现细节详见 CuratorDruidLeaderSelector</div>



<h3 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h3><p><img data-src="/picture/druid/druid_data_structure.png" alt="Apache Druid Data Structure"></p>
<center>（使用 Keynote™ 绘制而成）</center>

<h4 id="时间序列"><a href="#时间序列" class="headerlink" title="时间序列"></a>时间序列</h4><p>　时间序列（Timestamp），本身 Druid 是时间序列数据库，Druid 中所有查询以及索引过程都和时间维度有关。Druid 底层使用绝对毫秒数保存时间戳，默认使用 ISO-8601 格式展示时间：<code>yyyy-MM-ddThh:mm:sss.SSSZ</code></p>
<h4 id="维度列"><a href="#维度列" class="headerlink" title="维度列"></a>维度列</h4><p>　维度列（Dimensions），Druid 的维度概念和广义的 OLAP 定义一致，一条记录中的字符、数值、多值等类型的数据均可看作是维度列。维度列可用于过滤筛选（filter）、分组（group）数据</p>
<h4 id="度量列"><a href="#度量列" class="headerlink" title="度量列"></a>度量列</h4><p>　度量列（Metrics），Druid 的度量概念也与广义的 OLAP 定义一致，一条记录中的数值（Numeric）类型数据可看作是度量列，度量列被用于聚合（aggregation）和计算（computation）操作</p>
<div class="note success">从这里可以看出来，Apache Druid 是天然支持多值数据模型的</div>




<h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><h3 id="单机版"><a href="#单机版" class="headerlink" title="单机版"></a><a href="https://druid.apache.org/docs/latest/tutorials/index.html">单机版</a></h3><h4 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ wget https://mirrors.tuna.tsinghua.edu.cn/apache/druid/0.20.0/apache-druid-0.20.0-bin.tar.gz</span><br></pre></td></tr></tbody></table></figure>
<h4 id="解压"><a href="#解压" class="headerlink" title="解压"></a>解压</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ tar zxvf apache-druid-0.20.0-bin.tar.gz</span><br></pre></td></tr></tbody></table></figure>
<h4 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> apache-druid-0.20.0</span><br><span class="line">$ bin/start-micro-quickstart</span><br></pre></td></tr></tbody></table></figure>
<div class="note info">通过 examples/conf/druid/single-server/micro-quickstart 下的配置项，可以计算得出 1C2G 的机器规格，便可以启动一个完整的 Apache Druid 服务</div>

<h4 id="可视化"><a href="#可视化" class="headerlink" title="可视化"></a>可视化</h4><p>　浏览器中打开 <code>localhost:8888</code> 地址，控制台的界面如下图所示：</p>
<p><img data-src="/picture/druid/druid_console.png" alt="Apache Druid Web Console"></p>
<center>（对 <a href="https://druid.apache.org/docs/latest/operations/druid-console.html" target="_blank">Web Console</a> 可视化页面的截图）</center>



<h3 id="Docker-容器版"><a href="#Docker-容器版" class="headerlink" title="Docker 容器版"></a><a href="https://github.com/apache/druid/tree/master/distribution/docker">Docker 容器版</a></h3><h4 id="下载-1"><a href="#下载-1" class="headerlink" title="下载"></a>下载</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 搜索 Docker Hub</span></span><br><span class="line">$ docker search druid</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载最新版本的镜像</span></span><br><span class="line">$ docker pull apache/druid:0.20.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查镜像是否下载成功</span></span><br><span class="line">$ docker image list</span><br></pre></td></tr></tbody></table></figure>
<h4 id="配置-Docker-文件共享"><a href="#配置-Docker-文件共享" class="headerlink" title="配置 Docker 文件共享"></a>配置 Docker 文件共享</h4><p>　打开配置面板，进入 <code>File Sharing</code> 配置页面，增加 <code>${the path of your source code}/distribution/docker/storage</code> 路径，随后点击 <code>Apply &amp; Restart</code> 按钮，应用并重启</p>
<h4 id="启动-1"><a href="#启动-1" class="headerlink" title="启动"></a>启动</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/apache/druid.git</span><br><span class="line">$ <span class="built_in">cd</span> druid</span><br><span class="line">$ docker-compose -f distribution/docker/docker-compose.yml up</span><br><span class="line"></span><br><span class="line"><span class="comment"># 同理，也可以使用 start/stop 命令启停容器</span></span><br><span class="line">$ docker-compose -f distribution/docker/docker-compose.yml stop</span><br><span class="line">$ docker-compose -f distribution/docker/docker-compose.yml start</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者使用 down 命令移除容器</span></span><br><span class="line">$ docker-compose -f distribution/docker/docker-compose.yml down</span><br></pre></td></tr></tbody></table></figure>
<!-- docker run --rm -i -p 8888:8888 apache/druid:0.20.0 -->
<h4 id="校验"><a href="#校验" class="headerlink" title="校验"></a>校验</h4><h5 id="Historical-容器"><a href="#Historical-容器" class="headerlink" title="Historical 容器"></a>Historical 容器</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ docker <span class="built_in">exec</span> -it historical sh</span><br><span class="line">$ ls /opt/data/</span><br><span class="line">  indexing-logs  segments</span><br><span class="line">$ ls /opt/data/segments/</span><br><span class="line">  intermediate_pushes  wikipedia</span><br><span class="line">$ ls /opt/data/segments/wikipedia/</span><br><span class="line">  2016-06-27T00:00:00.000Z_2016-06-28T00:00:00.000Z</span><br><span class="line">$ ls /opt/data/segments/wikipedia/2016-06-27T00\:00\:00.000Z_2016-06-28T00\:00\:00.000Z/</span><br><span class="line">  2020-06-04T07:11:42.714Z</span><br><span class="line">$ ls /opt/data/segments/wikipedia/2016-06-27T00\:00\:00.000Z_2016-06-28T00\:00\:00.000Z/2020-06-04T07\:11\:42.714Z/0/</span><br><span class="line">  index.zip</span><br><span class="line">$ ls -lh</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">total 8M</span><br><span class="line">-rw-r--r--    1 druid    druid       5.9M Jun  4 07:49 00000.smoosh</span><br><span class="line">-rw-r--r--    1 druid    druid         29 Jun  4 07:49 factory.json</span><br><span class="line">-rw-r--r--    1 druid    druid       1.7M Jun  4 07:14 index.zip</span><br><span class="line">-rw-r--r--    1 druid    druid        707 Jun  4 07:49 meta.smoosh</span><br><span class="line">-rw-r--r--    1 druid    druid          4 Jun  4 07:49 version.bin</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ cat factory.json</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{<span class="attr">"type"</span>:<span class="string">"mMapSegmentFactory"</span>}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ xxd version.bin</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">00000000: 0000 0009                                ....</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ cat meta.smoosh</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight css"><table><tbody><tr><td class="code"><pre><span class="line"><span class="selector-tag">v1</span>,2147483647,1</span><br><span class="line">__<span class="selector-tag">time</span>,0,0,1106</span><br><span class="line"><span class="selector-tag">channel</span>,0,145739,153122</span><br><span class="line"><span class="selector-tag">cityName</span>,0,153122,195592</span><br><span class="line"><span class="selector-tag">comment</span>,0,195592,1598156</span><br><span class="line"><span class="selector-tag">count</span>,0,1106,2063</span><br><span class="line"><span class="selector-tag">countryIsoCode</span>,0,1598156,1614170</span><br><span class="line"><span class="selector-tag">countryName</span>,0,1614170,1630859</span><br><span class="line"><span class="selector-tag">diffUrl</span>,0,1630859,4224103</span><br><span class="line"><span class="selector-tag">flags</span>,0,4224103,4252873</span><br><span class="line"><span class="selector-tag">index</span><span class="selector-class">.drd</span>,0,6162513,6163275</span><br><span class="line"><span class="selector-tag">isAnonymous</span>,0,4252873,4262876</span><br><span class="line"><span class="selector-tag">isMinor</span>,0,4262876,4282592</span><br><span class="line"><span class="selector-tag">isNew</span>,0,4282592,4290896</span><br><span class="line"><span class="selector-tag">isRobot</span>,0,4290896,4298796</span><br><span class="line"><span class="selector-tag">isUnpatrolled</span>,0,4298796,4307345</span><br><span class="line"><span class="selector-tag">metadata</span><span class="selector-class">.drd</span>,0,6163275,6163925</span><br><span class="line"><span class="selector-tag">namespace</span>,0,4307345,4342089</span><br><span class="line"><span class="selector-tag">page</span>,0,4342089,5710071</span><br><span class="line"><span class="selector-tag">regionIsoCode</span>,0,5710071,5730339</span><br><span class="line"><span class="selector-tag">regionName</span>,0,5730339,5759351</span><br><span class="line"><span class="selector-tag">sum_added</span>,0,2063,37356</span><br><span class="line"><span class="selector-tag">sum_commentLength</span>,0,37356,66244</span><br><span class="line"><span class="selector-tag">sum_deleted</span>,0,66244,81170</span><br><span class="line"><span class="selector-tag">sum_delta</span>,0,81170,126275</span><br><span class="line"><span class="selector-tag">sum_deltaBucket</span>,0,126275,145739</span><br><span class="line"><span class="selector-tag">user</span>,0,5759351,6162513</span><br></pre></td></tr></tbody></table></figure>
<div class="note info">其中，index.drd 包含该 Segment 覆盖的时间范围、指定的 Bitmap 种类（concise / roaring），以及包含的列和维度；而 metadata.drd 包含是否 Rollup、哪些聚合函数、查询的粒度，时间戳字段信息，以及可用于存储任意 Key-Value 数据的 Map 结构（例如 Kafka Firehose 用来存储 offset 信息）。更多细节，详见 org.apache.druid.segment.IndexIO.V9IndexLoader#load</div>



<h5 id="PostgreSQL-容器"><a href="#PostgreSQL-容器" class="headerlink" title="PostgreSQL 容器"></a>PostgreSQL 容器</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ docker <span class="built_in">exec</span> -it postgres bash</span><br><span class="line">$ psql --version</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">psql (PostgreSQL) 11.7</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ psql -U druid -d druid</span><br><span class="line">$ \l</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">                             List of databases</span><br><span class="line">   Name    | Owner | Encoding |  Collate   |   Ctype    | Access privileges</span><br><span class="line">-----------+-------+----------+------------+------------+-------------------</span><br><span class="line"> druid     | druid | UTF8     | en_US.utf8 | en_US.utf8 |</span><br><span class="line"> postgres  | druid | UTF8     | en_US.utf8 | en_US.utf8 |</span><br><span class="line"> template0 | druid | UTF8     | en_US.utf8 | en_US.utf8 | =c/druid         +</span><br><span class="line">           |       |          |            |            | druid=CTc/druid</span><br><span class="line"> template1 | druid | UTF8     | en_US.utf8 | en_US.utf8 | =c/druid         +</span><br><span class="line">           |       |          |            |            | druid=CTc/druid</span><br><span class="line">(4 rows)</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ \c druid</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">You are now connected to database <span class="string">"druid"</span> as user <span class="string">"druid"</span>.</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ \dt</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">               List of relations</span><br><span class="line"> Schema |         Name          | Type  | Owner</span><br><span class="line">--------+-----------------------+-------+-------</span><br><span class="line"> public | druid_audit           | table | druid</span><br><span class="line"> public | druid_config          | table | druid</span><br><span class="line"> public | druid_datasource      | table | druid</span><br><span class="line"> public | druid_pendingsegments | table | druid</span><br><span class="line"> public | druid_rules           | table | druid</span><br><span class="line"> public | druid_segments        | table | druid</span><br><span class="line"> public | druid_supervisors     | table | druid</span><br><span class="line"> public | druid_tasklocks       | table | druid</span><br><span class="line"> public | druid_tasklogs        | table | druid</span><br><span class="line"> public | druid_tasks           | table | druid</span><br><span class="line">(10 rows)</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight"><table><tbody><tr><td class="code"><pre><span class="line">&gt; select id, datasource, created_date, start, "end", partitioned, version, used from public.druid_segments;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">wikipedia_2016-06-27T00:00:00.000Z_2016-06-28T00:00:00.000Z_2020-06-04T07:11:42.714Z | wikipedia  | 2020-06-04T07:14:50.619Z | 2016-06-27T00:00:00.000Z | 2016-06-28T00:00:00.000Z | t           | 2020-06-04T07:11:42.714Z | t</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Kubernetes-集群版"><a href="#Kubernetes-集群版" class="headerlink" title="Kubernetes 集群版"></a>Kubernetes 集群版</h3><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ helm repo add incubator https://kubernetes-charts-incubator.storage.googleapis.com</span><br><span class="line">$ helm install incubator/druid --version 0.2.6 --generate-name</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">NAME: druid-1592218780</span><br><span class="line">LAST DEPLOYED: Mon Jun 15 23:59:42 2020</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br><span class="line">TEST SUITE: None</span><br><span class="line">NOTES:</span><br><span class="line">1. Get the router URL by running these commands:</span><br><span class="line">  <span class="built_in">export</span> POD_NAME=$(kubectl get pods --namespace default -l <span class="string">"app=druid,release=druid-1592218780"</span> -o jsonpath=<span class="string">"{.items[0].metadata.name}"</span>)</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"Visit http://127.0.0.1:8080 to use your application"</span></span><br><span class="line">  kubectl port-forward <span class="variable">$POD_NAME</span> 8080:8888</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">export</span> POD_NAME=$(kubectl get pods --namespace default -l <span class="string">"app=druid,release=`helm list | grep druid- | awk '{print <span class="variable">$1</span>}'`"</span> | grep router | awk <span class="string">'{print $1}'</span>)</span><br><span class="line">$ nohup kubectl port-forward <span class="variable">$POD_NAME</span> 8888:8888 --address 0.0.0.0 2&gt;&amp;1 &amp;</span><br></pre></td></tr></tbody></table></figure>
<h4 id="校验-1"><a href="#校验-1" class="headerlink" title="校验"></a>校验</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ kubectl get all</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">NAME                                                READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/druid-1592364086-broker-76bf68c8bc-96d56        1/1     Running   0          2m36s</span><br><span class="line">pod/druid-1592364086-coordinator-5f645bd5c8-rhhpz   1/1     Running   0          2m36s</span><br><span class="line">pod/druid-1592364086-historical-0                   1/1     Running   0          2m36s</span><br><span class="line">pod/druid-1592364086-middle-manager-0               1/1     Running   0          2m36s</span><br><span class="line">pod/druid-1592364086-postgresql-0                   1/1     Running   0          2m36s</span><br><span class="line">pod/druid-1592364086-router-67f678b6c5-mw6b4        1/1     Running   0          2m36s</span><br><span class="line">pod/druid-1592364086-zookeeper-0                    1/1     Running   0          2m36s</span><br><span class="line">pod/druid-1592364086-zookeeper-1                    1/1     Running   0          2m8s</span><br><span class="line">pod/druid-1592364086-zookeeper-2                    1/1     Running   0          85s</span><br><span class="line">pod/<span class="built_in">local</span>-volume-provisioner-8sjtx                  1/1     Running   0          8m59s</span><br><span class="line">pod/<span class="built_in">local</span>-volume-provisioner-9z7mh                  1/1     Running   0          8m59s</span><br><span class="line">pod/<span class="built_in">local</span>-volume-provisioner-m2xrt                  1/1     Running   0          8m59s</span><br><span class="line">pod/<span class="built_in">local</span>-volume-provisioner-ptbqs                  1/1     Running   0          8m59s</span><br><span class="line">pod/<span class="built_in">local</span>-volume-provisioner-tw2fn                  1/1     Running   0          8m59s</span><br><span class="line"></span><br><span class="line">NAME                                           TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE</span><br><span class="line">service/druid-1592364086-broker                ClusterIP   10.10.10.128     &lt;none&gt;        8082/TCP                     2m36s</span><br><span class="line">service/druid-1592364086-coordinator           ClusterIP   10.10.10.195     &lt;none&gt;        8081/TCP                     2m36s</span><br><span class="line">service/druid-1592364086-historical            ClusterIP   10.10.10.226     &lt;none&gt;        8083/TCP                     2m36s</span><br><span class="line">service/druid-1592364086-middle-manager        ClusterIP   10.10.10.108     &lt;none&gt;        8091/TCP                     2m36s</span><br><span class="line">service/druid-1592364086-postgresql            ClusterIP   10.10.10.155     &lt;none&gt;        5432/TCP                     2m36s</span><br><span class="line">service/druid-1592364086-postgresql-headless   ClusterIP   None             &lt;none&gt;        5432/TCP                     2m36s</span><br><span class="line">service/druid-1592364086-router                ClusterIP   10.10.10.29      &lt;none&gt;        8888/TCP                     2m36s</span><br><span class="line">service/druid-1592364086-zookeeper             ClusterIP   10.10.10.122     &lt;none&gt;        2181/TCP                     2m36s</span><br><span class="line">service/druid-1592364086-zookeeper-headless    ClusterIP   None             &lt;none&gt;        2181/TCP,3888/TCP,2888/TCP   2m36s</span><br><span class="line">service/kubernetes                             ClusterIP   10.10.10.1       &lt;none&gt;        443/TCP                      30m</span><br><span class="line"></span><br><span class="line">NAME                                      DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE</span><br><span class="line">daemonset.apps/<span class="built_in">local</span>-volume-provisioner   5         5         5       5            5           &lt;none&gt;          9m</span><br><span class="line"></span><br><span class="line">NAME                                           READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/druid-1592364086-broker        1/1     1            1           2m36s</span><br><span class="line">deployment.apps/druid-1592364086-coordinator   1/1     1            1           2m36s</span><br><span class="line">deployment.apps/druid-1592364086-router        1/1     1            1           2m36s</span><br><span class="line"></span><br><span class="line">NAME                                                      DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/druid-1592364086-broker-76bf68c8bc        1         1         1       2m36s</span><br><span class="line">replicaset.apps/druid-1592364086-coordinator-5f645bd5c8   1         1         1       2m36s</span><br><span class="line">replicaset.apps/druid-1592364086-router-67f678b6c5        1         1         1       2m36s</span><br><span class="line"></span><br><span class="line">NAME                                               READY   AGE</span><br><span class="line">statefulset.apps/druid-1592364086-historical       1/1     2m36s</span><br><span class="line">statefulset.apps/druid-1592364086-middle-manager   1/1     2m36s</span><br><span class="line">statefulset.apps/druid-1592364086-postgresql       1/1     2m36s</span><br><span class="line">statefulset.apps/druid-1592364086-zookeeper        3/3     2m36s</span><br></pre></td></tr></tbody></table></figure>
<div class="note info">上述 CLUSTER-IP 信息已脱敏</div>

<h4 id="ZooKeeper-元数据"><a href="#ZooKeeper-元数据" class="headerlink" title="ZooKeeper 元数据"></a>ZooKeeper 元数据</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ zkCli.sh</span><br><span class="line">[zk: localhost:2181(CONNECTED) 0] ls -R /druid</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">/druid</span><br><span class="line"></span><br><span class="line">/druid/announcements</span><br><span class="line">/druid/coordinator</span><br><span class="line">/druid/discovery</span><br><span class="line">/druid/indexer</span><br><span class="line">/druid/internal-discovery</span><br><span class="line">/druid/loadQueue</span><br><span class="line">/druid/overlord</span><br><span class="line">/druid/segments</span><br><span class="line">/druid/servedSegments</span><br><span class="line"></span><br><span class="line">/druid/announcements/10.10.10.63:8083</span><br><span class="line"></span><br><span class="line">/druid/coordinator/_COORDINATOR</span><br><span class="line">/druid/coordinator/_COORDINATOR/_c_281fb87b-c40c-4d71-a657-8254cbcf3730-latch-0000000000</span><br><span class="line"></span><br><span class="line">/druid/discovery/druid:broker</span><br><span class="line">/druid/discovery/druid:coordinator</span><br><span class="line">/druid/discovery/druid:overlord</span><br><span class="line">/druid/discovery/druid:router</span><br><span class="line"></span><br><span class="line">/druid/discovery/druid:broker/0e76bfc1-87f8-4799-9c36-0fb0e5617aef</span><br><span class="line">/druid/discovery/druid:coordinator/035b1ada-531e-4a71-865b-7a1a6d6f1734</span><br><span class="line">/druid/discovery/druid:overlord/a74523d6-1708-45b3-9c0b-87f438cda4e3</span><br><span class="line">/druid/discovery/druid:router/c0bb18d3-51b1-4089-932b-a5d6e05ab91c</span><br><span class="line"></span><br><span class="line">/druid/indexer/announcements</span><br><span class="line">/druid/indexer/status</span><br><span class="line">/druid/indexer/tasks</span><br><span class="line"></span><br><span class="line">/druid/indexer/announcements/10.10.10.65:8091</span><br><span class="line">/druid/indexer/status/10.10.10.65:8091</span><br><span class="line">/druid/indexer/tasks/10.10.10.65:8091</span><br><span class="line"></span><br><span class="line">/druid/internal-discovery/BROKER</span><br><span class="line">/druid/internal-discovery/COORDINATOR</span><br><span class="line">/druid/internal-discovery/HISTORICAL</span><br><span class="line">/druid/internal-discovery/INDEXER</span><br><span class="line">/druid/internal-discovery/MIDDLE_MANAGER</span><br><span class="line">/druid/internal-discovery/OVERLORD</span><br><span class="line">/druid/internal-discovery/PEON</span><br><span class="line">/druid/internal-discovery/ROUTER</span><br><span class="line"></span><br><span class="line">/druid/internal-discovery/BROKER/10.10.10.73:8082</span><br><span class="line">/druid/internal-discovery/COORDINATOR/10.10.10.72:8081</span><br><span class="line">/druid/internal-discovery/HISTORICAL/10.10.10.63:8083</span><br><span class="line">/druid/internal-discovery/MIDDLE_MANAGER/10.10.10.65:8091</span><br><span class="line">/druid/internal-discovery/OVERLORD/10.10.10.72:8081</span><br><span class="line">/druid/internal-discovery/ROUTER/10.10.10.55:8888</span><br><span class="line"></span><br><span class="line">/druid/loadQueue/10.10.10.63:8083</span><br><span class="line"></span><br><span class="line">/druid/overlord/_OVERLORD</span><br><span class="line">/druid/overlord/_OVERLORD/_c_ecacbc56-4d36-4ca0-ac1d-0df919c40bff-latch-0000000000</span><br><span class="line"></span><br><span class="line">/druid/segments/10.10.10.63:8083</span><br><span class="line"></span><br><span class="line">/druid/segments/10.10.10.63:8083/10.10.10.63:8083_historical__default_tier_2020-06-20T04:08:23.309Z_1b957acb6850491ca6ea885fca1b3c210</span><br><span class="line">/druid/segments/10.10.10.63:8083/10.10.10.63:8083_historical__default_tier_2020-06-20T04:10:16.643Z_57c1f60104a94c459bf0331eb3c1f0a01</span><br><span class="line"></span><br><span class="line">/druid/servedSegments/10.10.10.63:8083</span><br></pre></td></tr></tbody></table></figure>
<div class="note info">上述 IP 地址相关信息已脱敏</div>

<h4 id="Broker-健康检查"><a href="#Broker-健康检查" class="headerlink" title="Broker 健康检查"></a>Broker 健康检查</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">kill</span> `ps -ef | grep 8082 | grep -v grep | awk <span class="string">'{print $2}'</span>`; <span class="built_in">export</span> POD_NAME=$(kubectl get pods --namespace default -l <span class="string">"app=druid,release=`helm list | grep druid- | awk '{print <span class="variable">$1</span>}'`"</span> | grep broker | awk <span class="string">'{print $1}'</span>) ; nohup kubectl port-forward <span class="variable">$POD_NAME</span> 8082:8082 --address 0.0.0.0 2&gt;&amp;1 &amp;</span><br><span class="line">$ curl localhost:8082/status/health</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">true</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="MiddleManager-任务"><a href="#MiddleManager-任务" class="headerlink" title="MiddleManager 任务"></a>MiddleManager 任务</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> -it druid-1593317208-middle-manager-0 sh</span><br><span class="line">$ <span class="built_in">cd</span> /opt/druid/var/druid/task</span><br><span class="line">$ find</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">.</span><br><span class="line">./workerTaskManagerTmp</span><br><span class="line">./completedTasks</span><br><span class="line">./restore.json</span><br><span class="line">./assignedTasks</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ cat restore.json</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{<span class="attr">"runningTasks"</span>:[]}</span><br></pre></td></tr></tbody></table></figure>
<div class="note info">MiddleManager 会将运行中的任务 ID（TaskRunnerWorkItem#taskId）的列表持久化在本地 restore.json 文件中，以便重启节点的时候恢复正在运行中的任务</div>

<h4 id="Historical-缓存"><a href="#Historical-缓存" class="headerlink" title="Historical 缓存"></a>Historical 缓存</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /opt/druid/var/druid/segment-cache/info_dir</span><br><span class="line">$ cat wikipedia_2016-06-27T00:00:00.000Z_2016-06-27T01:00:00.000Z_2020-06-20T04:10:01.833Z</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"dataSource"</span>: <span class="string">"wikipedia"</span>,</span><br><span class="line">  <span class="attr">"interval"</span>: <span class="string">"2016-06-27T00:00:00.000Z/2016-06-27T01:00:00.000Z"</span>,</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"2020-06-20T04:10:01.833Z"</span>,</span><br><span class="line">  <span class="attr">"loadSpec"</span>: {</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"hdfs"</span>,</span><br><span class="line">    <span class="attr">"path"</span>: <span class="string">"hdfs://10.10.10.44:8020/druid/segments/wikipedia/20160627T000000.000Z_20160627T010000.000Z/2020-06-20T04_10_01.833Z/0_index.zip"</span></span><br><span class="line">  },</span><br><span class="line">  <span class="attr">"dimensions"</span>: <span class="string">"channel,cityName,comment,countryIsoCode,countryName,diffUrl,flags,isAnonymous,isMinor,isNew,isRobot,isUnpatrolled,namespace,page,regionIsoCode,regionName,user"</span>,</span><br><span class="line">  <span class="attr">"metrics"</span>: <span class="string">"count,sum_added,sum_commentLength,sum_deleted,sum_delta,sum_deltaBucket"</span>,</span><br><span class="line">  <span class="attr">"shardSpec"</span>: {</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"numbered"</span>,</span><br><span class="line">    <span class="attr">"partitionNum"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"partitions"</span>: <span class="number">0</span></span><br><span class="line">  },</span><br><span class="line">  <span class="attr">"binaryVersion"</span>: <span class="number">9</span>,</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">241189</span>,</span><br><span class="line">  <span class="attr">"identifier"</span>: <span class="string">"wikipedia_2016-06-27T00:00:00.000Z_2016-06-27T01:00:00.000Z_2020-06-20T04:10:01.833Z"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<div class="note success">上述 JSON 已格式化，以便于阅读</div>

<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /opt/druid/var/druid/segment-cache/wikipedia/2016-06-27T00:00:00.000Z_2016-06-27T01:00:00.000Z/2020-06-20T04:10:01.833Z/0</span><br><span class="line">$ ls</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">00000.smoosh  factory.json  meta.smoosh  version.bin</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Segment-文件"><a href="#Segment-文件" class="headerlink" title="Segment 文件"></a>Segment 文件</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> -it hdfs-1593317115-namenode-0 bash</span><br><span class="line">$ hdfs dfs -get /druid/segments/wikipedia/20160627T000000.000Z_20160627T010000.000Z/2020-06-28T04_10_01.833Z/0_index.zip /tmp/index/</span><br><span class="line">$ <span class="built_in">exit</span></span><br><span class="line">$ kubectl cp hdfs-1593317115-namenode-0:/tmp/index/0_index.zip /tmp/0_index.zip</span><br><span class="line">$ unzip 0_index.zip</span><br><span class="line">$ ls</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">00000.smoosh  0_index.zip  factory.json  meta.smoosh  version.bin</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Coordinator-动态配置"><a href="#Coordinator-动态配置" class="headerlink" title="Coordinator 动态配置"></a>Coordinator 动态配置</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">kill</span> `ps -ef | grep 8081 | grep -v grep | awk <span class="string">'{print $2}'</span>`; <span class="built_in">export</span> POD_NAME=$(kubectl get pods --namespace default -l <span class="string">"app=druid,release=`helm list | grep druid- | awk '{print <span class="variable">$1</span>}'`"</span> | grep coordinator | awk <span class="string">'{print $1}'</span>) ; nohup kubectl port-forward <span class="variable">$POD_NAME</span> 8081:8081 --address 0.0.0.0 2&gt;&amp;1 &amp;</span><br><span class="line">$ curl localhost:8081/druid/coordinator/v1/config | python -m json.tool</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"balancerComputeThreads"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"decommissioningMaxPercentOfMaxSegmentsToMove"</span>: <span class="number">70</span>,</span><br><span class="line">  <span class="attr">"decommissioningNodes"</span>: [],</span><br><span class="line">  <span class="attr">"emitBalancingStats"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"killAllDataSources"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"killDataSourceWhitelist"</span>: [],</span><br><span class="line">  <span class="attr">"killPendingSegmentsSkipList"</span>: [],</span><br><span class="line">  <span class="attr">"maxSegmentsInNodeLoadingQueue"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"maxSegmentsToMove"</span>: <span class="number">5</span>,</span><br><span class="line">  <span class="attr">"mergeBytesLimit"</span>: <span class="number">524288000</span>,</span><br><span class="line">  <span class="attr">"mergeSegmentsLimit"</span>: <span class="number">100</span>,</span><br><span class="line">  <span class="attr">"millisToWaitBeforeDeleting"</span>: <span class="number">900000</span>,</span><br><span class="line">  <span class="attr">"pauseCoordination"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"replicantLifetime"</span>: <span class="number">15</span>,</span><br><span class="line">  <span class="attr">"replicationThrottleLimit"</span>: <span class="number">10</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 将 maxSegmentsToMove 调整为 50</span></span><br><span class="line">$ curl -XPOST -H <span class="string">'Content-Type:application/json'</span> localhost:8081/druid/coordinator/v1/config -d <span class="string">'{"maxSegmentsToMove":50}'</span></span><br><span class="line">$ curl localhost:8081/druid/coordinator/v1/config | python -m json.tool</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"balancerComputeThreads"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"decommissioningMaxPercentOfMaxSegmentsToMove"</span>: <span class="number">70</span>,</span><br><span class="line">  <span class="attr">"decommissioningNodes"</span>: [],</span><br><span class="line">  <span class="attr">"emitBalancingStats"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"killAllDataSources"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"killDataSourceWhitelist"</span>: [],</span><br><span class="line">  <span class="attr">"killPendingSegmentsSkipList"</span>: [],</span><br><span class="line">  <span class="attr">"maxSegmentsInNodeLoadingQueue"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"maxSegmentsToMove"</span>: <span class="number">50</span>,</span><br><span class="line">  <span class="attr">"mergeBytesLimit"</span>: <span class="number">524288000</span>,</span><br><span class="line">  <span class="attr">"mergeSegmentsLimit"</span>: <span class="number">100</span>,</span><br><span class="line">  <span class="attr">"millisToWaitBeforeDeleting"</span>: <span class="number">900000</span>,</span><br><span class="line">  <span class="attr">"pauseCoordination"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"replicantLifetime"</span>: <span class="number">15</span>,</span><br><span class="line">  <span class="attr">"replicationThrottleLimit"</span>: <span class="number">10</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<div class="note info">动态配置项 maxSegmentsToMove 可以用于控制同时被 rebalance 的 Segment 数量</div>
<div class="note info">动态配置项 replicantLifetime 可以用于控制 Historical 上 Segment 存活的时间。当 Historical 下线时，其上的 Segment 会被认为已经失效，然后 Coordinator 会通知其他 Historical 来加载这些 Segment。但是在 Historical 升级做滚动重启的时候，如果立即使这些 Segment 失效，会导致严重的数据漂移。因此，需要给这些 Segment 增加一个 lifetime 机制，以规避此类情况</div>

<h4 id="Druid-SQL-查询"><a href="#Druid-SQL-查询" class="headerlink" title="Druid SQL 查询"></a>Druid SQL 查询</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 映射 Broker 容器的 8082 端口</span></span><br><span class="line">$ <span class="built_in">kill</span> `ps -ef | grep 8082 | grep -v grep | awk <span class="string">'{print $2}'</span>`; <span class="built_in">export</span> POD_NAME=$(kubectl get pods --namespace default -l <span class="string">"app=druid,release=`helm list | grep druid- | awk '{print <span class="variable">$1</span>}'`"</span> | grep broker | awk <span class="string">'{print $1}'</span>) ; nohup kubectl port-forward <span class="variable">$POD_NAME</span> 8082:8082 --address 0.0.0.0 2&gt;&amp;1 &amp;</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">'{"query":"SELECT COUNT(*) as res FROM wikipedia"}'</span> &gt; druid_query.sql</span><br><span class="line">$ curl -XPOST -H<span class="string">'Content-Type: application/json'</span> http://localhost:8082/druid/v2/sql/ -d@druid_query.sql</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">[{<span class="attr">"res"</span>:<span class="number">24433</span>}]</span><br></pre></td></tr></tbody></table></figure>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a><a href="https://druid.apache.org/docs/latest/configuration/index.html">配置</a></h2><h3 id="常用端口"><a href="#常用端口" class="headerlink" title="常用端口"></a><a href="https://druid.apache.org/docs/latest/tutorials/cluster.html">常用端口</a></h3><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">端口描述</th>
<th style="text-align:center">端口号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Router, if used</td>
<td style="text-align:center">8088</td>
</tr>
<tr>
<td style="text-align:center">Broker</td>
<td style="text-align:center">8082</td>
</tr>
<tr>
<td style="text-align:center">Overlord</td>
<td style="text-align:center">8090</td>
</tr>
<tr>
<td style="text-align:center">Middle Manager; you may need higher than port 8199 if you have a very high <code>druid.worker.capacity</code></td>
<td style="text-align:center">8091, 8100 ~ 8199</td>
</tr>
<tr>
<td style="text-align:center">Coordinator</td>
<td style="text-align:center">8081</td>
</tr>
<tr>
<td style="text-align:center">Historical</td>
<td style="text-align:center">8083</td>
</tr>
<tr>
<td style="text-align:center">Derby on your Coordinator; not needed if you are using a separate metadata store like MySQL or PostgreSQL</td>
<td style="text-align:center">1527</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://yuzhouwan.com/posts/31915/">ZooKeeper</a>; not needed if you are using a separate ZooKeeper cluster</td>
<td style="text-align:center">2181</td>
</tr>
</tbody>
</table>
</div>
<div class="note warning">生产中，建议将 ZooKeeper 和 Metadata Stroage 部署在独立的物理机上，而不是混合部署在 Coordinator 节点上</div>



<h3 id="rollup"><a href="#rollup" class="headerlink" title="rollup"></a><a href="https://druid.apache.org/docs/latest/ingestion/index.html#enabling-or-disabling-rollup">rollup</a></h3><p>　在 Apache Druid <a href="https://github.com/apache/druid/releases/tag/druid-0.9.2">0.9.2</a> 版本之后，我们可以通过在 <code>granularitySpec</code> 中配置 <code>"rollup": false</code>，来完全关闭 RollUp 特性，即在数据摄入的过程中，不做任何的预聚合，只保留最原始的数据点。即便是同一时刻的、具有相同维度的、完全相同的多个数据点，都会全部存储下来，不会发生覆盖写</p>
<h3 id="selectStrategy"><a href="#selectStrategy" class="headerlink" title="selectStrategy"></a><a href="https://druid.apache.org/docs/latest/configuration/index.html#overlord">selectStrategy</a></h3><p>　该参数默认为 <code>fillCapacity</code>，意味着分配 Task 的时候，会将某个 MiddleManager 分配满，才会分配新的 Task 到其他 MiddleManager 上。这里可以考虑使用 <code>equalDistribution</code> 策略，将 Task 均匀分配到 MiddleManager 上</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> <span class="variable">$DRUID_HOME</span></span><br><span class="line">$ vim conf/druid/overlord/runtime.properties</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">druid.indexer.selectStrategy</span>=<span class="string">equalDistribution</span></span><br></pre></td></tr></tbody></table></figure>
<div class="note success">在 0.11.0 版本中，默认策略已经改成了 equalDistribution。详见 WorkerBehaviorConfig#DEFAULT_STRATEGY</div>



<h3 id="maxRowsPerSegment"><a href="#maxRowsPerSegment" class="headerlink" title="maxRowsPerSegment"></a><a href="https://druid.apache.org/docs/latest/ingestion/native-batch.html#dynamic-partitioning">maxRowsPerSegment</a></h3><p>　该参数用于控制每个 Segment 中最大能够存储的记录行数（默认值为 <code>500,0000</code>），只有二级分区采用的是 <code>dynamic</code> 才会生效。如果 <code>spec.tuningConfig.type</code> 设置的是 <code>hashed</code>，则需要指定 shard 的数量，以及哪些 Dimension 被用于 hash 计算（默认为所有 Dimension）。另外，在 <code>dynamic</code> 类型的二级分区中，还有一个 <code>maxTotalRows</code> 参数（默认值为 <code>2000,0000</code>），用来控制所有尚未被存储到 Deep Storage 中的 segment 的记录行数，一旦达到 <code>maxTotalRows</code> 则会立即触发 push 操作</p>
<div class="note danger">如果该参数设置得很低，会产生很多小的 Segment 文件。一方面，如果 DeepStorage 为 HDFS 的话，会触发小文件问题，影响到集群性能（访问大量小文件不同于访问少数大文件，需要不断地在 DataNode 之间跳转，大部分时间都会耗费在 task 的启动和释放上，并且 NameNode 要监控的数据块变多后，网络带宽和内存占用也会比高，还会拖慢 NameNode 节点的故障恢复）；另一方面，如果操作系统中 vm.max_map_count 参数为默认的 65530 的话，可能会达到这个阈值，使得 MMap 操作失败，进而导致 Historical 进程 crash 退出，如果 Segment 一直无法完成 handoff 的过程，则会促使 Coordinator 进程 kill 实时任务</div>



<h3 id="druid-server-tier"><a href="#druid-server-tier" class="headerlink" title="druid.server.tier"></a><a href="https://druid.apache.org/docs/latest/configuration/index.html#historical-general-configuration">druid.server.tier</a></h3><p>　该参数相当于给 Historical 节点加了一个标签，可以将相同 Tier 名称的 Historical 进行分组，便于实现冷热分层。在 <code>historical/runtime.properties</code> 配置文件中设置，默认值为 <code>_default_tier</code>。例如，可以创建 <code>hot</code>、<code>cold</code> 两个 Tier，<code>hot</code> Tier 用于存储最近三个月的数据，<code>cold</code> Tier 用于存储最近一年的数据。如此一来，因为 <code>cold</code> 分组下的 Historical 节点存储的数据只需要应对一些低频查询，便可以使用非 SSD 的磁盘，以节约硬件成本</p>
<h3 id="tieredReplicants"><a href="#tieredReplicants" class="headerlink" title="tieredReplicants"></a><a href="https://druid.apache.org/docs/latest/operations/rule-configuration.html#interval-load-rule">tieredReplicants</a></h3><p>　该参数用于在 Rule 中设置 Tier 存储的副本数量。假设将 tieredReplicants 设置为 2 之后，数据便会在不同的 Historical 节点上各自存储一份，以避免某一个 Historical 故障，而影响到查询</p>
<h3 id="Coordinator-Rule-配置"><a href="#Coordinator-Rule-配置" class="headerlink" title="Coordinator Rule 配置"></a>Coordinator Rule 配置</h3><h4 id="保留最近-30-天数据"><a href="#保留最近-30-天数据" class="headerlink" title="保留最近 30 天数据"></a>保留最近 30 天数据</h4><p><img data-src="/picture/druid/druid_save_30_days_rules.png" alt="Apache Druid Coordinator UI"></p>
<center>（对 <a href="https://druid.apache.org/docs/latest/design/coordinator.html" target="_blank">Coordinator</a> 可视化页面的截图）</center>





<h2 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h2><h3 id="Druid-SQL"><a href="#Druid-SQL" class="headerlink" title="Druid SQL"></a><a href="https://druid.apache.org/docs/latest/querying/sql.html">Druid SQL</a></h3><h4 id="语法规则"><a href="#语法规则" class="headerlink" title="语法规则"></a>语法规则</h4><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">[ <span class="keyword">EXPLAIN</span> PLAN <span class="keyword">FOR</span> ]</span><br><span class="line">[ <span class="keyword">WITH</span> tableName [ ( column1, column2, ... ) ] <span class="keyword">AS</span> ( <span class="keyword">query</span> ) ]</span><br><span class="line"><span class="keyword">SELECT</span> [ <span class="keyword">ALL</span> | <span class="keyword">DISTINCT</span> ] { * | exprs }</span><br><span class="line"><span class="keyword">FROM</span> { &lt;<span class="keyword">table</span>&gt; | (&lt;subquery&gt;) | &lt;o1&gt; [ <span class="keyword">INNER</span> | <span class="keyword">LEFT</span> ] <span class="keyword">JOIN</span> &lt;o2&gt; <span class="keyword">ON</span> condition }</span><br><span class="line">[ <span class="keyword">WHERE</span> expr ]</span><br><span class="line">[ <span class="keyword">GROUP</span> <span class="keyword">BY</span> [ exprs | <span class="keyword">GROUPING</span> <span class="keyword">SETS</span> ( (exprs), ... ) | <span class="keyword">ROLLUP</span> (exprs) | <span class="keyword">CUBE</span> (exprs) ] ]</span><br><span class="line">[ <span class="keyword">HAVING</span> expr ]</span><br><span class="line">[ <span class="keyword">ORDER</span> <span class="keyword">BY</span> expr [ <span class="keyword">ASC</span> | <span class="keyword">DESC</span> ], expr [ <span class="keyword">ASC</span> | <span class="keyword">DESC</span> ], ... ]</span><br><span class="line">[ <span class="keyword">LIMIT</span> <span class="keyword">limit</span> ]</span><br><span class="line">[ <span class="keyword">UNION</span> <span class="keyword">ALL</span> &lt;another <span class="keyword">query</span>&gt; ]</span><br></pre></td></tr></tbody></table></figure>
<h4 id="查询示例"><a href="#查询示例" class="headerlink" title="查询示例"></a>查询示例</h4><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="string">"__time"</span>, <span class="string">"channel"</span>, <span class="string">"cityName"</span>, <span class="string">"comment"</span>, <span class="string">"count"</span>, <span class="string">"countryIsoCode"</span>, <span class="string">"countryName"</span>, <span class="string">"diffUrl"</span>, <span class="string">"flags"</span>, <span class="string">"isAnonymous"</span>, <span class="string">"isMinor"</span>, <span class="string">"isNew"</span>, <span class="string">"isRobot"</span>, <span class="string">"isUnpatrolled"</span>, <span class="string">"namespace"</span>, <span class="string">"page"</span>, <span class="string">"regionIsoCode"</span>, <span class="string">"regionName"</span>, <span class="string">"sum_added"</span>, <span class="string">"sum_commentLength"</span>, <span class="string">"sum_deleted"</span>, <span class="string">"sum_delta"</span>, <span class="string">"sum_deltaBucket"</span>, <span class="string">"user"</span></span><br><span class="line"><span class="keyword">FROM</span> <span class="string">"wikipedia"</span></span><br><span class="line"><span class="keyword">WHERE</span> <span class="string">"__time"</span> &gt;= <span class="keyword">CURRENT_TIMESTAMP</span> - <span class="built_in">INTERVAL</span> <span class="string">'1'</span> <span class="keyword">DAY</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="PlyQL"><a href="#PlyQL" class="headerlink" title="PlyQL"></a>PlyQL</h3><h4 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h4><p>　通过 <code>--host</code> 和 <code>-q</code> 分别指定 <code>Broker 地址</code> 和 <code>查询语句</code></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/druid/software/imply-1.3.0</span><br><span class="line">$ bin/plyql --host &lt;broker host&gt;:8082 -q <span class="string">"show tables"</span>        <span class="comment"># --host &lt;broker&gt;:&lt;port&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">┌─────────────────────────┐</span><br><span class="line">│ Tables_in_database      │</span><br><span class="line">├─────────────────────────┤</span><br><span class="line">│ COLUMNS                 │</span><br><span class="line">│ SCHEMATA                │</span><br><span class="line">│ TABLES                  │</span><br><span class="line">│ yuzhouwan_metrics       │</span><br><span class="line">└─────────────────────────┘</span><br></pre></td></tr></tbody></table></figure>
<h4 id="表结构查询"><a href="#表结构查询" class="headerlink" title="表结构查询"></a>表结构查询</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ bin/plyql --host &lt;broker host&gt;:8082 -q <span class="string">"describe yuzhouwan_metrics"</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">┌────────────┬────────┬──────┬─────┬─────────┬───────┐</span><br><span class="line">│ Field      │ Type   │ Null │ Key │ Default │ Extra │</span><br><span class="line">├────────────┼────────┼──────┼─────┼─────────┼───────┤</span><br><span class="line">│ __time     │ TIME   │ YES  │     │         │       │</span><br><span class="line">│ metric01   │ NUMBER │ YES  │     │         │       │</span><br><span class="line">│ metric02   │ NUMBER │ YES  │     │         │       │</span><br><span class="line">│ // ...     │        │      │     │         │       │</span><br><span class="line">└────────────┴────────┴──────┴─────┴─────────┴───────┘</span><br></pre></td></tr></tbody></table></figure>
<h4 id="聚合查询"><a href="#聚合查询" class="headerlink" title="聚合查询"></a>聚合查询</h4><h5 id="简单聚合"><a href="#简单聚合" class="headerlink" title="简单聚合"></a>简单聚合</h5><p>　简单的 <code>max</code> / <code>min</code> / <code>count</code> 查询语句</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ bin/plyql --host &lt;broker host&gt;:8082 -q <span class="string">"select max(gcCount_max) from yuzhouwan_metrics where serverName='druid01'"</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">┌──────────────────┐</span><br><span class="line">│ max(gcCount_max) │</span><br><span class="line">├──────────────────┤</span><br><span class="line">│ 39710            │</span><br><span class="line">└──────────────────┘</span><br></pre></td></tr></tbody></table></figure>
<h5 id="时间维度聚合"><a href="#时间维度聚合" class="headerlink" title="时间维度聚合"></a>时间维度聚合</h5><p>　利用 <code>TIME_PART</code> 进行时间维度的聚合</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ bin/plyql --host &lt;broker host&gt;:8082 -q <span class="string">"select TIME_PART(__time, MINUTE_OF_DAY, 'Asia/Shanghai'), max(gcCount_max) from yuzhouwan_metrics where serverName='druid01' and __time&gt;='2017-04-04' and __time&lt;'2017-04-05' group by 1"</span> -Z Asia/Shanghai</span><br><span class="line"></span><br><span class="line"><span class="comment"># 不参与 group by 的 指标需要进行 sum / min / max 之类的聚合操作</span></span><br><span class="line">$ bin/plyql --host &lt;broker host&gt;:8082 -q <span class="string">"select TIME_PART(__time, MINUTE_OF_DAY, 'Asia/Shanghai'), metric, sum(sum) as sum_value from yuzhouwan_metrics where level='level1' and metric='metric1' and __time&gt;='2017-04-04' and __time&lt;'2017-04-05' group by 1, 2 order by sum_value desc limit 10"</span> -Z Asia/Shanghai -v</span><br></pre></td></tr></tbody></table></figure>
<h4 id="展示查询对应的-JSON-语句"><a href="#展示查询对应的-JSON-语句" class="headerlink" title="展示查询对应的 JSON 语句"></a>展示查询对应的 JSON 语句</h4><p>　增加 <code>-v</code> 参数，可以将查询的 <code>JSON</code> 语句展示出来，用于检查 <code>plyql</code> 语句是否符合预期</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ bin/plyql --host &lt;broker host&gt;:8082 -q <span class="string">"select distinct level from yuzhouwan_metrics where __time&gt;='2017-01-16 03:00'"</span> -Z Asia/Shanghai -v</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">plyql version 0.9.6 (plywood version 0.15.4)</span><br><span class="line">Received query:</span><br><span class="line">select distinct level from yuzhouwan_metrics <span class="built_in">where</span> __time&gt;=<span class="string">'2017-01-16 03:00'</span></span><br><span class="line">---------------------------</span><br><span class="line">Parsed query as the following plywood expression (as JSON):</span><br><span class="line">{</span><br><span class="line">  <span class="string">"op"</span>: <span class="string">"split"</span>,</span><br><span class="line">  <span class="string">"operand"</span>: {</span><br><span class="line">    <span class="string">"op"</span>: <span class="string">"filter"</span>,</span><br><span class="line">    <span class="string">"operand"</span>: {</span><br><span class="line">      <span class="string">"op"</span>: <span class="string">"ref"</span>,</span><br><span class="line">      <span class="string">"name"</span>: <span class="string">"yuzhouwan_metrics"</span></span><br><span class="line">    },</span><br><span class="line">    <span class="string">"expression"</span>: {</span><br><span class="line">      <span class="string">"op"</span>: <span class="string">"greaterThanOrEqual"</span>,</span><br><span class="line">      <span class="string">"operand"</span>: {</span><br><span class="line">        <span class="string">"op"</span>: <span class="string">"ref"</span>,</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"__time"</span>,</span><br><span class="line">        <span class="string">"ignoreCase"</span>: <span class="literal">true</span></span><br><span class="line">      },    // ...</span><br><span class="line">      {</span><br><span class="line">        <span class="string">"version"</span>: <span class="string">"v1"</span>,</span><br><span class="line">        <span class="string">"timestamp"</span>: <span class="string">"2017-01-16T03:00:00.000Z"</span>,</span><br><span class="line">        <span class="string">"event"</span>: {</span><br><span class="line">          <span class="string">"level"</span>: <span class="string">"level1"</span>,</span><br><span class="line">          <span class="string">"!DUMMY"</span>: 1608</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">]</span><br><span class="line">^^^^^^^^^^^^^^^^^^^^^^^^^^</span><br><span class="line">┌────────────────┐</span><br><span class="line">│ level          │</span><br><span class="line">├────────────────┤</span><br><span class="line">│ level1         │</span><br><span class="line">│ level2         │</span><br><span class="line">└────────────────┘</span><br></pre></td></tr></tbody></table></figure>
<h4 id="计算查询耗时情况"><a href="#计算查询耗时情况" class="headerlink" title="计算查询耗时情况"></a>计算查询耗时情况</h4><p>　利用 time 命令，可以计算出查询语句的耗时情况</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ time bin/plyql -h &lt;broker host&gt;:8082 -q <span class="string">"select * from yuzhouwan_metrics where __time&gt;='2017-03-18' and __time&lt;'2017-03-19' and level='level01' limit 100"</span> -Z Asia/Shanghai</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">real    0m0.886s</span><br><span class="line">user    0m0.684s</span><br><span class="line">sys     0m0.062s</span><br></pre></td></tr></tbody></table></figure>
<h3 id="RESTful-API"><a href="#RESTful-API" class="headerlink" title="RESTful API"></a>RESTful API</h3><h4 id="获取所有-DataSource"><a href="#获取所有-DataSource" class="headerlink" title="获取所有 DataSource"></a>获取所有 DataSource</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ curl http://localhost:8082/druid/v2/datasources</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">[<span class="string">"inline_data"</span>,<span class="string">"wikipedia"</span>]</span><br></pre></td></tr></tbody></table></figure>
<h4 id="聚合查询-1"><a href="#聚合查询-1" class="headerlink" title="聚合查询"></a>聚合查询</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim query.body</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"dimensions"</span>: [</span><br><span class="line">    <span class="string">"dimensions1"</span>,</span><br><span class="line">    <span class="string">"dimensions2"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"aggregations"</span>: [</span><br><span class="line">    {</span><br><span class="line">      <span class="attr">"filter"</span>: {</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"selector"</span>,</span><br><span class="line">        <span class="attr">"dimension"</span>: <span class="string">"metric"</span>,</span><br><span class="line">        <span class="attr">"value"</span>: <span class="string">"metrics01"</span></span><br><span class="line">      },</span><br><span class="line">      <span class="attr">"aggregator"</span>: {</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"doubleSum"</span>,</span><br><span class="line">        <span class="attr">"fieldName"</span>: <span class="string">"sum"</span>,</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"metric01"</span></span><br><span class="line">      },</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"filtered"</span></span><br><span class="line">    }</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"filter"</span>: {</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"selector"</span>,</span><br><span class="line">    <span class="attr">"dimension"</span>: <span class="string">"level"</span>,</span><br><span class="line">    <span class="attr">"value"</span>: <span class="string">"day"</span></span><br><span class="line">  },</span><br><span class="line">  <span class="attr">"intervals"</span>: <span class="string">"2017-02-09T15:03:12+08:00/2017-02-09T16:03:12+08:00"</span>,</span><br><span class="line">  <span class="attr">"limitSpec"</span>: {</span><br><span class="line">    <span class="attr">"limit"</span>: <span class="number">10</span>,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"default"</span>,</span><br><span class="line">    <span class="attr">"columns"</span>: [</span><br><span class="line">      {</span><br><span class="line">        <span class="attr">"direction"</span>: <span class="string">"descending"</span>,</span><br><span class="line">        <span class="attr">"dimension"</span>: <span class="string">"metric01"</span></span><br><span class="line">      }</span><br><span class="line">    ]</span><br><span class="line">  },</span><br><span class="line">  <span class="attr">"granularity"</span>: <span class="string">"all"</span>,</span><br><span class="line">  <span class="attr">"postAggregations"</span>: [],</span><br><span class="line">  <span class="attr">"queryType"</span>: <span class="string">"groupBy"</span>,</span><br><span class="line">  <span class="attr">"dataSource"</span>: <span class="string">"yuzhouwan_metrics"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ curl -X POST <span class="string">"http://localhost:8082/druid/v2/?pretty"</span> -H <span class="string">'content-type: application/json'</span> -d @query.body</span><br></pre></td></tr></tbody></table></figure>
<div class="note info">在 postAggregations 中里面是串行执行的，并可以传递计算结果</div>



<h3 id="Apache-Calcite"><a href="#Apache-Calcite" class="headerlink" title="Apache Calcite"></a><a href="https://druid.apache.org/docs/latest/querying/sql.html#jdbc">Apache Calcite</a></h3><h4 id="Maven-依赖"><a href="#Maven-依赖" class="headerlink" title="Maven 依赖"></a>Maven 依赖</h4><figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.calcite<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>calcite-druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.23.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="Java-实现"><a href="#Java-实现" class="headerlink" title="Java 实现"></a>Java 实现</h4><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">String url = <span class="string">"jdbc:avatica:remote:url=http://localhost:8082/druid/v2/sql/avatica/"</span>;</span><br><span class="line">String query = <span class="string">"SELECT COUNT(*) as res FROM wikipedia"</span>;</span><br><span class="line"><span class="keyword">try</span> (Connection connection = DriverManager.getConnection(url)) {</span><br><span class="line">    <span class="keyword">try</span> (Statement statement = connection.createStatement();</span><br><span class="line">         ResultSet resultSet = statement.executeQuery(query)) {</span><br><span class="line">        <span class="keyword">while</span> (resultSet.next()) {</span><br><span class="line">            System.out.println(resultSet.getInt(<span class="number">1</span>));</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="number">24433</span></span><br></pre></td></tr></tbody></table></figure>
<div class="note success">Apache Calcite 的 Druid adapter 持续完善查询算子下推，已支持 count(*) 聚合、filter 过滤和 groupby 分组等</div>



<h3 id="Druid-Client"><a href="#Druid-Client" class="headerlink" title="Druid Client"></a>Druid Client</h3><p>　一旦有了 Client 之后，我们就可以做很多事情，比如流控、权限管理、统一 SQL 层等（社区正在 <a href="https://github.com/apache/druid/issues/5006">!5006</a> 中讨论，欢迎加入）。目前，社区已经有针对 <a href="https://github.com/implydata/druid-client">Java</a>、<a href="https://github.com/druid-io/pydruid">Python</a>、<a href="https://github.com/nisalperi/druid-client">Golang</a>、<a href="https://github.com/daggerrz/druid-scala-client">Scala</a>、<a href="https://github.com/y42/clj-druid">Clojure</a>、<a href="https://github.com/level23/druid-client">PHP</a>、<a href="https://github.com/druid-io/RDruid">R</a> <a href="https://druid.apache.org/libraries">等</a>语言，实现了对应的 Client 工具</p>
<h3 id="Presto"><a href="#Presto" class="headerlink" title="Presto"></a>Presto</h3><p>　PrestoDB 和 PrestoSQL 均支持 Druid Connector。具体的使用方式，详见我的另一篇博客：<a href="https://yuzhouwan.com/posts/200906/#Apache-Druid-Connector">Presto：分布式 SQL 查询引擎</a></p>
<h3 id="InfluxDB-Line-Protocol-Parser"><a href="#InfluxDB-Line-Protocol-Parser" class="headerlink" title="InfluxDB Line Protocol Parser"></a><a href="https://druid.apache.org/docs/latest/development/extensions-contrib/influx.html">InfluxDB Line Protocol Parser</a></h3><p>　Apache Druid 通过 <code>druid-influx-extensions</code> 插件支持解析 InfluxDB 写入协议。更多关于 InfluxDB 的介绍，详见：<a href="https://yuzhouwan.com/posts/200315/">开源时序数据库 InfluxDB</a></p>
<h2 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h2><h3 id="设计总图"><a href="#设计总图" class="headerlink" title="设计总图"></a>设计总图</h3><h4 id="初始版本-0-6-0（2012-2013）"><a href="#初始版本-0-6-0（2012-2013）" class="headerlink" title="初始版本~0.6.0（2012~2013）"></a>初始版本~0.6.0（2012~2013）</h4><p><img data-src="/picture/druid/druid_architecture_old_0.png" alt="Apache Druid 初始构架图"></p>
<center>（图片来源：<a href="https://druid.apache.org/docs/img/druid-dataflow-2x.png" target="_blank">Apache Druid</a>™ 官网）</center>

<h4 id="0-7-0-0-12-0（2013-2018）"><a href="#0-7-0-0-12-0（2013-2018）" class="headerlink" title="0.7.0~0.12.0（2013~2018）"></a>0.7.0~0.12.0（2013~2018）</h4><p><img data-src="/picture/druid/druid_architecture_old_1.png" alt="Apache Druid 旧构架图 - 数据流转"><br><img data-src="/picture/druid/druid_architecture_old_2.png" alt="Apache Druid 旧构架图 - 集群管理"></p>
<center>（图片来源：<a href="http://druid.io/docs/0.12.0/design/design.html" target="_blank">Apache Druid</a>™ 官网）</center>

<h4 id="0-13-0-当前版本（2018-now）"><a href="#0-13-0-当前版本（2018-now）" class="headerlink" title="0.13.0~当前版本（2018~now）"></a>0.13.0~当前版本（2018~now）</h4><p><img data-src="/picture/druid/druid_architecture.png" alt="Apache Druid 构架图"></p>
<center>（图片来源：<a href="https://druid.apache.org/docs/latest/design/" target="_blank">Apache Druid</a>™ 官网）</center>

<div class="note info">从架构图中可以看出来 Apache Druid 集群的通讯是基于 Apache ZooKeeper 的</div>



<h3 id="Lambda-流式架构"><a href="#Lambda-流式架构" class="headerlink" title="Lambda 流式架构"></a>Lambda 流式架构</h3><p><img data-src="/picture/druid/druid_lambda.png" alt="Apache Druid Lambda"></p>
<center>（利用 Axure™ 绘制而成）</center>

<div class="note info">通常流式数据的链路为 Raw data → Kafka → Stream processor（optional, typically for ETL) → Kafka（optional）→ Druid → Application / user，而批处理的链路为 Raw data → Kafka（optional）→ HDFS → ETL process（optional）→ Druid → Application / user</div>



<h3 id="OLTP-vs-OLAP"><a href="#OLTP-vs-OLAP" class="headerlink" title="OLTP vs OLAP"></a>OLTP vs OLAP</h3><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">OLTP</th>
<th style="text-align:center">OLAP</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">全称</td>
<td style="text-align:center"><strong>O</strong>n<strong>l</strong>ine <strong>T</strong>ransaction <strong>P</strong>rocessing</td>
<td style="text-align:center"><strong>O</strong>n<strong>l</strong>ine <strong>A</strong>nalytical <strong>P</strong>rocessing</td>
</tr>
<tr>
<td style="text-align:center">中文</td>
<td style="text-align:center">联机事务处理</td>
<td style="text-align:center">联机分析处理</td>
</tr>
<tr>
<td style="text-align:center">技术类别</td>
<td style="text-align:center">关系型数据库</td>
<td style="text-align:center">数据仓库</td>
</tr>
<tr>
<td style="text-align:center">场景</td>
<td style="text-align:center">基本的、日常的事务处理</td>
<td style="text-align:center">复杂的分析操作，侧重决策支持</td>
</tr>
<tr>
<td style="text-align:center">例子</td>
<td style="text-align:center">银行交易</td>
<td style="text-align:center">广告投放</td>
</tr>
<tr>
<td style="text-align:center">面向对象</td>
<td style="text-align:center">业务处理人员</td>
<td style="text-align:center">分析决策人员</td>
</tr>
<tr>
<td style="text-align:center">面向维度</td>
<td style="text-align:center">应用</td>
<td style="text-align:center">主题</td>
</tr>
<tr>
<td style="text-align:center">实时性</td>
<td style="text-align:center">高要求（如，银行交易希望能秒级完成）</td>
<td style="text-align:center">低要求（如，报表统计希望能天级完成）</td>
</tr>
<tr>
<td style="text-align:center">主要操作</td>
<td style="text-align:center">增删改</td>
<td style="text-align:center">查询</td>
</tr>
<tr>
<td style="text-align:center">数据的目的</td>
<td style="text-align:center">控制和运行基本业务任务</td>
<td style="text-align:center">帮助规划、解决问题和决策支持</td>
</tr>
<tr>
<td style="text-align:center">数据是什么</td>
<td style="text-align:center">业务流程的快照</td>
<td style="text-align:center">商业活动的多维视图</td>
</tr>
<tr>
<td style="text-align:center">插入和更新</td>
<td style="text-align:center">由终端用户发起</td>
<td style="text-align:center">由长时间运行的批处理作业定时触发</td>
</tr>
<tr>
<td style="text-align:center">查询复杂度</td>
<td style="text-align:center">简单事务查询</td>
<td style="text-align:center">复杂聚合查询</td>
</tr>
<tr>
<td style="text-align:center">查询数据量</td>
<td style="text-align:center">涉及的记录条数相对较少</td>
<td style="text-align:center">涉及大数据量的聚合</td>
</tr>
<tr>
<td style="text-align:center">处理速度</td>
<td style="text-align:center">通常非常快</td>
<td style="text-align:center">取决于所涉及的数据量，以及是否建立索引</td>
</tr>
<tr>
<td style="text-align:center">存储要求</td>
<td style="text-align:center">归档历史数据，以节省空间</td>
<td style="text-align:center">由于聚合结构的存在，相对更大</td>
</tr>
<tr>
<td style="text-align:center">数据量级别</td>
<td style="text-align:center">GB</td>
<td style="text-align:center">TB</td>
</tr>
<tr>
<td style="text-align:center">数据库设计</td>
<td style="text-align:center">相对标准化</td>
<td style="text-align:center">通常使用较少的表进行非规范化</td>
</tr>
<tr>
<td style="text-align:center">数据模型</td>
<td style="text-align:center">3NF、BCNF</td>
<td style="text-align:center">星型、雪花</td>
</tr>
</tbody>
</table>
</div>
<h3 id="MOLAP-vs-ROLAP"><a href="#MOLAP-vs-ROLAP" class="headerlink" title="MOLAP vs ROLAP"></a>MOLAP vs ROLAP</h3><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">MOLAP</th>
<th style="text-align:center">ROLAP</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">全称</td>
<td style="text-align:center"><strong>M</strong>ulti-dimensional <strong>OLAP</strong></td>
<td style="text-align:center"><strong>R</strong>elational <strong>OLAP</strong></td>
</tr>
<tr>
<td style="text-align:center">特征</td>
<td style="text-align:center">预聚合原始数据，加速聚合查询</td>
<td style="text-align:center"><a href="https://yuzhouwan.com/posts/200906/#MPP">MPP</a> 并⾏化 / 内存加速查询</td>
</tr>
<tr>
<td style="text-align:center">数据库</td>
<td style="text-align:center"><a href="https://yuzhouwan.com/tags/Apache-Druid/">Apache Druid</a> / Apache Kylin</td>
<td style="text-align:center">Apache Impala / Aapche Drill / <a href="https://yuzhouwan.com/tags/Apache-Spark/">Apache SparkSQL</a> / <a href="https://yuzhouwan.com/posts/200906/">Presto</a></td>
</tr>
</tbody>
</table>
</div>
<div class="note info">MPP（Massively Parallel Processor）大规模并行化处理架构</div>



<h3 id="Task-生命周期"><a href="#Task-生命周期" class="headerlink" title="Task 生命周期"></a>Task 生命周期</h3><pre class="mermaid">sequenceDiagram

participant Overlord
participant ZooKeeper
participant MiddleManager
participant Peon

Overlord -&gt;&gt; ZooKeeper : new_task
ZooKeeper -&gt;&gt; ZooKeeper : create path /tasks/mm1
ZooKeeper -&gt;&gt; MiddleManager : new_task
MiddleManager -&gt;&gt; Peon : new_task
Peon -&gt;&gt; ZooKeeper : new_task_status
ZooKeeper -&gt;&gt; ZooKeeper : create path /status/new_task
ZooKeeper -&gt;&gt; Overlord : new_task_status</pre>



<h3 id="写入链路"><a href="#写入链路" class="headerlink" title="写入链路"></a>写入链路</h3><pre class="mermaid">sequenceDiagram

participant MiddleManager
participant DeepStorage
participant MetadataStorage
participant ZooKeeper
participant Historical
participant Coordinator

MiddleManager -&gt;&gt; MiddleManager : indexing task
MiddleManager -&gt;&gt; MiddleManager : create segment
MiddleManager -&gt;&gt; DeepStorage : push segment
MiddleManager -&gt;&gt; MetadataStorage : record segment meta info
loop regularly
  Coordinator -&gt;&gt;+ MetadataStorage : pull segment info
  MetadataStorage --&gt;&gt;- Coordinator : return segment info
end
Coordinator -&gt;&gt;+ ZooKeeper : create ephemeral znode
ZooKeeper --&gt;&gt;- Historical : trigge watch
DeepStorage -&gt;&gt; Historical : pull segment
Historical -&gt;&gt; ZooKeeper : record segment location info
Historical --&gt;&gt; MiddleManager : handoff done</pre>

<div class="note info">Coordinator 会定期从 MetadataStorage 中获取 Segment 信息，拉取的频率由 druid.manager.segments.pollDuration 参数控制（默认值为 PT1M）。另外，druid.manager.config.pollDuration 参数控制拉取配置信息的频率，druid.manager.rules.pollDuration 参数控制拉取 Rule 规则的频率，这两个参数的默认值也均为 PT1M</div>
<div class="note info">需要注意的是 Coordinator 通知 Historical 从 DeepStorage 中加载 Segment 的操作，是通过 ZooKeeper 来通讯的，并且每一个 Historical 进程都会与 ZooKeeper 之间维护一个长连接，以感知 watch 机制发出的事件</div>



<h3 id="Segment-加载"><a href="#Segment-加载" class="headerlink" title="Segment 加载"></a>Segment 加载</h3><pre class="mermaid">sequenceDiagram

participant Historical
participant Disk
participant ZooKeeper

ZooKeeper --&gt;&gt; Historical : CHILD_ADDED event
Historical -&gt;&gt;+ Disk : get all files under info_dir
Disk -&gt;&gt;- Historical : return cached segments info
alt segment does not exist
Historical -&gt;&gt; Disk : delete the corresponding file under info_dir
end
Historical -&gt;&gt; Historical : load local segment
Historical -&gt;&gt; ZooKeeper : register loaded segment</pre>

<div class="note success">加载 Segment 的过程本质上就是反序列化的过程，如果对 Historical 节点滚动重启的时候，直接对其上的所有 Segment 都进行反序列化操作，会使得节点恢复比较缓慢。针对该问题 Apache Druid 在 0.17.0 版本中，引入了懒加载的机制，将反序列化的过程推迟到 Segment 实际被查询的时候进行。该特性可以通过 druid.segmentCache.lazyLoadOnStart 配置项开启，默认值为 false</div>

<p>　如果某个查询命中的 Segment 都储存在一个 Historical 节点上，则会导致该查询无法被并行化处理，查询的 RT 就会增高。因此，Segment 在各个 Historical 节点中的分布要尽可能保证分散。Segment 负载均衡的策略可以由 <code>druid.coordinator.balancer.strategy</code> 参数指定，默认值为 <code>cost</code>。该策略在 Aapche Druid 的 0.9.1 版本中被引入，其大体思路为：随机选择一个 Segment X 后，依次计算该 Segment X 和 Historical 节点上的所有 Segment Y 的 Cost，选取 Cost 值最小的节点（两个 Segment 对应的时间段相距越远，算出的 Cost 值也就越小，那么同时出现在一个 Historical 节点上的概率也就越大），然后到该节点上重新加载 Segment X。具体的计算公式如下：</p>
<script type="math/tex; mode=display">
Cost(X, Y) = \int_{x_0}^{x_1} \int_{y_0}^{y_1} e^{-\lambda|x-y|}{\rm d}x{\rm d}y</script><p>　其中，$X$ 为需要被重新加载的 Segment，其数据覆盖的时间范围为 $[x_0, x_1)$，$Y$ 为 Historical 上某一个 Segment，其数据覆盖的时间范围为 $[y_0, y_1)$，另外 $\lambda$ 为 $\frac{\log_e^2}{24}$，表示 Cost 函数的半衰期为 24 小时</p>
<p>　使用 Cost 负载均衡策略后，Segment 在 Historical 节点中分布情况如下：</p>
<p><img data-src="/picture/druid/apache_druid_balancer_strategy_cost.gif" alt="Apache Druid Balancer Strategy Cost"></p>
<center>（图片来源：<a href="https://github.com/apache/druid/pull/2972" target="_blank">Apache Druid</a>™ 的 PR）</center>

<p>　图中，一个点就是一个 Segment，而不同的颜色就用来标识来自不同 DataSource 的 Segment，横坐标表示不同的 Historical 节点，纵坐标表示 Segment 中 Interval 的起始时间</p>
<h3 id="查询链路"><a href="#查询链路" class="headerlink" title="查询链路"></a>查询链路</h3><pre class="mermaid">sequenceDiagram

participant Client
participant Broker
participant ZooKeeper
participant Historical
participant MiddleManager

Client -&gt;&gt;+ Broker : http request
Broker -&gt;&gt;+ ZooKeeper : get segment location info
ZooKeeper --&gt;&gt;- Broker : return segment location info
Broker -&gt;&gt; Broker : split subquery
Broker -&gt;&gt;+ MiddleManager : query new data
MiddleManager --&gt;&gt;- Broker : return new data
Broker -&gt;&gt;+ Historical : query old data
Historical --&gt;&gt;- Broker : return old data
Broker -&gt;&gt; Broker : merge results
Broker -&gt;&gt;- Client : http response</pre>

<div class="note info">对于查询来说，Broker 只会将请求分发到 MiddleManager 和 Historical，而 MetadataStorage 和 DeepStorage 都不会参与其中</div>
<div class="note info">到这里我们可以看出来，Apache Druid 属于 AP 类型的分布式系统。首先是 Availability 可用性，主要体现于，Apache Druid 集群中不存在单点问题，即便是外部组件 MetadataStorage 和 DeepStorage 全部都宕机，也是可以正常进行数据查询的。其次是 Partition tolerance 分区容错性，则体现在 Coordinator 可以根据 Rule 设置数据的副本数量，而 DeepStorage 也是可以使用 HDFS 这类支持数据副本的存储媒介。最后是 Consistency 一致性，这一点在 Apache Druid 中相对而言是被弱化的</div>
<div class="note success">在默认 v2 版本的 GroupBy 策略下，只有字符串字典会存储在堆内内存，Segment 数据都存储在堆外内存。同时，支持将数据压缩（LZ4）并溢出到磁盘上（通过环境变量 java.io.tmpdir 控制存储路径，默认 Linux 系统下为 /tmp），以避免内存出现 OOM 问题。不过，如果用于溢出的磁盘空间不足，仍会导致查询失败。具体的溢出逻辑，详见：org.apache.druid.query.groupby.epinephelinae.SpillingGrouper#spill。另外，Broker 采用多路归并排序（K-way Merge Sort）算法，将计算结果进行汇总</div>



<h3 id="SQL"><a href="#SQL" class="headerlink" title="SQL"></a>SQL</h3><pre class="mermaid">sequenceDiagram

participant HTTP Client
participant JDBC Driver
participant SqlResource
participant Avatica Jetty Handler
participant DruidMeta
participant Parser
participant SqlToRelConverter
participant Optimizer
participant Druid Schema
participant Druid RulesSet
participant QueryMaker
participant Query Execution

opt send SQL
HTTP Client -&gt;&gt; SqlResource : /druid/v2/sql
SqlResource -&gt;&gt; Parser : SQL
JDBC Driver -&gt;&gt; Avatica Jetty Handler : /druid/v2/sql/avatica
Avatica Jetty Handler -&gt;&gt; DruidMeta : meta
DruidMeta -&gt;&gt; Parser : SQL
end

opt parse SQL by calcite
Parser -&gt;&gt; SqlToRelConverter : SqlNode
SqlToRelConverter -&gt;&gt; Optimizer : RelNode
Optimizer -&gt;&gt; QueryMaker : DruidRel
end

opt execute SQL
QueryMaker -&gt;&gt; Query Execution : Query
end

Query Execution --&gt;&gt; HTTP Client : Result</pre>



<h3 id="整体知识树"><a href="#整体知识树" class="headerlink" title="整体知识树"></a>整体知识树</h3><p><img data-src="/picture/druid/apache_druid_ecosphere.png" alt="Apache Druid"></p>
<center>（利用 MindNode™ 绘制而成）</center>





<h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><h3 id="Powered-By"><a href="#Powered-By" class="headerlink" title="Powered By"></a><a href="https://druid.apache.org/druid-powered">Powered By</a></h3><p>　从 Apache Druid 官网看到有 100 多家企业都在使用，也包括了很多国内的公司，例如 BAT、字节跳动™、知乎™、优酷™、小米™、Oppo™、有赞™、作业帮™等等，大概占到 10% 左右</p>
<h3 id="主要应用"><a href="#主要应用" class="headerlink" title="主要应用"></a>主要应用</h3><ul>
<li><p>点击流分析（Web 和 移动端分析）</p>
</li>
<li><p>风控</p>
</li>
<li><p>网络遥测分析（网络性能监控）</p>
</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">分类</th>
<th style="text-align:center">协议</th>
<th style="text-align:center">优点</th>
<th style="text-align:center">缺点</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">主动测量</td>
<td style="text-align:center">PING、Traceroute、Iperf、IPMP、OWAMP、TWAMP、MPLS L/DM、Pingmesh</td>
<td style="text-align:center">易用且灵活</td>
<td style="text-align:center">网络增加额外带宽 / 处理开销，会引起海森堡测不准效应</td>
</tr>
<tr>
<td style="text-align:center">被动测量</td>
<td style="text-align:center">Netflow、sFlow、IPFIX、PSAMP</td>
<td style="text-align:center">不会因测量产生额外的负载</td>
<td style="text-align:center">只能监测交换节点本地状态信息，而不能监测网络状态和丢包率等全局状态信息</td>
</tr>
<tr>
<td style="text-align:center">混合测量</td>
<td style="text-align:center">Reactive Measurement、In-band Measurement、AM-PM、Postcard Based Telemetry、In-band Flow Analyzer、Hybrid Two Steps</td>
<td style="text-align:center">能够对网络拓扑、网络性能和网络流量实现更细粒度的测量</td>
<td style="text-align:center">1. 带内网络遥测检测范围有限，预先定义的随路检测特性使得带内网络遥测往往无法及时获得全网全状态的网络视图。因此，带内网络遥测只能监测特定路径上的某些数据包的遥测数据；<br>2. 由于将遥测指令和数据封装到正常数据包中，正常数据包的有效载荷比降低，遥测开销较大；<br>3. 遥测指令和数据的构造、封装、填充和提取等环节增加了交换机处理负担</td>
</tr>
</tbody>
</table>
</div>
<ul>
<li><p>服务器指标存储</p>
</li>
<li><p>供应链分析（制造指标）</p>
</li>
<li><p>应用程序性能指标</p>
</li>
<li><p>商业智能 / OLAP</p>
</li>
</ul>
<h3 id="适合的场景"><a href="#适合的场景" class="headerlink" title="适合的场景"></a>适合的场景</h3><ul>
<li>插入率很高，但更新并不常见</li>
<li>大多数查询都是聚合查询和 groupBy 分组查询，包括搜索和扫描查询</li>
<li>查询响应时间为百毫秒~几秒钟之间</li>
<li>时序数据</li>
<li>可能有多个表，但是每个查询仅命中其中某一个表</li>
<li>具有高基数数据列（例如 URL，用户 ID 等），并且需要对其进行快速计数和排序</li>
<li>要从 Kafka，HDFS，本地文件或 Amazon S3、AliyunOSS 之类的对象存储中加载数据</li>
</ul>
<div class="note success">Apache Druid 支持将 groupBy 查询的中间结果溢出存储至磁盘，以应对大查询导致的内存资源不足。通过 druid.query.groupBy.maxOnDiskStorage 配置项可以控制对应的磁盘空间大小，默认值为 0，表示不开启该特性</div>

<h3 id="不合适的场景"><a href="#不合适的场景" class="headerlink" title="不合适的场景"></a>不合适的场景</h3><ul>
<li>使用主键对现有记录进行低延迟更新。 Druid 支持流式插入，但不支持流式更新（使用后台批处理作业完成更新）</li>
<li>正在构建脱机报告系统，此时查询延迟不是很重要</li>
<li>需要进行大的联接查询（将一个大事实表连接到另一个大事实表），并且可以花很长时间来完成这些查询</li>
</ul>
<div class="note danger">网上关于 Apache Druid 教程有很多，其中也会提及一些缺点，但是 Apache Druid 社区发展是十分迅速的，例如“不支持 Join”、“不能存储明细数据”之类的说法已经过时了，希望大家能够以 Apache Druid 官网提供的最新版本为准</div>





<h2 id="性能测试"><a href="#性能测试" class="headerlink" title="性能测试"></a>性能测试</h2><p>　<strong>TPC</strong>™（<strong>T</strong>ransactionprocessing <strong>P</strong>erformance <strong>C</strong>ouncil，事务处理性能委员会）是一个发布基准程序的标准规范的非盈利组织。基于 TPC 定义的 TPC-H 规范，麻省大学定义了一套基准测试规范，可用于测试数据库产品在星型模式下的性能表现，即 <strong><a href="https://github.com/electrum/ssb-dbgen">SSB</a></strong>（<strong>S</strong>tar <strong>S</strong>chema <strong>B</strong>enchmark）。它将 TPC-H 的雪花模式简化为了星型模式，将基准查询由 TPC-H 的复杂 Ad-Hoc 查询改为了结构更固定的 OLAP 查询</p>
<p><img data-src="/picture/druid/apache_druid_benchmark_partition_hashing_on.png" alt="Apache Druid Benchmark with Partition Hashing On"><br><img data-src="/picture/druid/apache_druid_benchmark_partition_hashing_off.png" alt="Apache Druid Benchmark with Partition Hashing Off"></p>
<center>（图片来源：<a href="https://imply.io/post/performance-benchmark-druid-presto-hive" target="_blank">Imply</a>™ 官网）</center>





<h2 id="源码阅读"><a href="#源码阅读" class="headerlink" title="源码阅读"></a>源码阅读</h2><h3 id="数据结构-1"><a href="#数据结构-1" class="headerlink" title="数据结构"></a>数据结构</h3><h4 id="R-tree"><a href="#R-tree" class="headerlink" title="R-tree"></a>R-tree</h4><p>　一个空间数据库由一系列对应空间对象的 tuple 组成，而每一个 tuple 具有一个唯一标示（tuple identifier，简称 tupleID），数据库可以通过这个唯一标示获取到该 tuple。R-Tree 所做的就是将这些 tupleID 索引起来</p>
<h4 id="HyperLogLog"><a href="#HyperLogLog" class="headerlink" title="HyperLogLog"></a>HyperLogLog</h4><p>　基数计数会得到一个近似精确的计算结果，比如在执行 <code>Count</code> / <code>Distinct Count</code> 等计数查询的时候，会返回一个浮点数作为预估值</p>
<h3 id="依赖框架"><a href="#依赖框架" class="headerlink" title="依赖框架"></a>依赖框架</h3><h4 id="Apache-Calcite-查询引擎"><a href="#Apache-Calcite-查询引擎" class="headerlink" title="Apache Calcite 查询引擎"></a><a href="https://yuzhouwan.com/posts/201018/">Apache Calcite 查询引擎</a></h4><h4 id="Google-Guice-注入"><a href="#Google-Guice-注入" class="headerlink" title="Google Guice 注入"></a>Google Guice 注入</h4><h4 id="Google-Guava-扩展库"><a href="#Google-Guava-扩展库" class="headerlink" title="Google Guava 扩展库"></a>Google Guava 扩展库</h4><h4 id="JMH-压测"><a href="#JMH-压测" class="headerlink" title="JMH 压测"></a><a href="https://yuzhouwan.com/posts/190413/#JMH-%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95">JMH 压测</a></h4><h3 id="Query-查询流程"><a href="#Query-查询流程" class="headerlink" title="Query 查询流程"></a>Query 查询流程</h3><p><img data-src="/picture/druid/druid_query_processing.png" alt="Apache Druid Query Process"></p>
<center>（利用 StarUML™ 绘制而成）</center>







<h2 id="可视化-1"><a href="#可视化-1" class="headerlink" title="可视化"></a>可视化</h2><h3 id="Apache-Superset"><a href="#Apache-Superset" class="headerlink" title="Apache Superset"></a>Apache Superset</h3><p>　出于篇幅考虑，单独写了一篇博客，详见：<a href="https://yuzhouwan.com/posts/743/">Apache Superset 二次开发</a></p>
<h3 id="Grafana"><a href="#Grafana" class="headerlink" title="Grafana"></a>Grafana</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ helm repo add bitnami https://charts.bitnami.com/bitnami</span><br><span class="line">$ helm install my-release bitnami/grafana</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">NAME: my-release</span><br><span class="line">LAST DEPLOYED: Mon Jul 19 08:03:13 2020</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br><span class="line">TEST SUITE: None</span><br><span class="line">NOTES:</span><br><span class="line">** Please be patient <span class="keyword">while</span> the chart is being deployed **</span><br><span class="line"></span><br><span class="line">1. Get the application URL by running these commands:</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"Browse to http://127.0.0.1:8080"</span></span><br><span class="line">    kubectl port-forward svc/my-release-grafana 8080:3000 &amp;</span><br><span class="line"></span><br><span class="line">2. Get the admin credentials:</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"User: admin"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"Password: <span class="subst">$(kubectl get secret my-release-grafana-admin --namespace default -o jsonpath=<span class="string">"{.data.GF_SECURITY_ADMIN_PASSWORD}"</span> | base64 --decode)</span>"</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ grafana-cli --pluginsDir <span class="string">"<span class="variable">${GF_PATHS_PLUGINS}</span>"</span> plugins install abhisant-druid-datasource</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">kill</span> `ps -ef | grep 3000 | grep -v grep | awk <span class="string">'{print $2}'</span>`; <span class="built_in">export</span> POD_NAME=$(kubectl get pods | grep grafana | awk <span class="string">'{print $1}'</span>) ; nohup kubectl port-forward <span class="variable">$POD_NAME</span> 3000:3000 --address 0.0.0.0 2&gt;&amp;1 &amp;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Pivot"><a href="#Pivot" class="headerlink" title="Pivot"></a>Pivot</h3><h4 id="配置启动"><a href="#配置启动" class="headerlink" title="配置启动"></a>配置启动</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ whereis node</span><br><span class="line">  node: /usr/<span class="built_in">local</span>/bin/node</span><br><span class="line"></span><br><span class="line">$ /usr/<span class="built_in">local</span>/bin/node -v</span><br><span class="line">  v4.2.2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将环境变量引入，而不用 sudo su druid</span></span><br><span class="line">$ su - druid</span><br><span class="line"></span><br><span class="line"><span class="comment"># `--with-comments` 指标可以去掉不用，避免 comment 生成出现问题（部分注释，行开头漏 # 号的情况）</span></span><br><span class="line">$ /usr/<span class="built_in">local</span>/bin/node /home/druid/software/druid/dist/pivot/bin/pivot --druid &lt;druid.broker.host&gt;:8082 --<span class="built_in">print</span>-config &gt; /home/druid/software/druid/dist/pivot/bin/yuzhouwan_metrics.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 需要使用相对路径</span></span><br><span class="line">$ <span class="built_in">cd</span> /home/druid/software/imply-2.0.0</span><br><span class="line">$ nohup dist/pivot/bin/pivot -c /home/druid/software/druid/dist/pivot/bin/config_yuzhouwan_metrics.yaml  &gt;&gt; /home/druid/software/druid/dist/pivot/bin/nohup.log 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line">$ vim /home/druid/software/druid/dist/pivot/bin/config_yuzhouwan_metrics.yaml</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 在 pivot 的配置文件中，可以利用简单的表达式，进行计算，如：除以采集的时间窗口，算得 `OPS`</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">metrics02_OPS</span></span><br><span class="line">  <span class="attr">title:</span> <span class="string">metrics02</span> <span class="string">ops</span></span><br><span class="line">  <span class="attr">expression:</span> <span class="string">$main.sum($metrics02_Sum)</span> <span class="string">/</span> <span class="string">$main.sum($period_Sum)</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="效果图"><a href="#效果图" class="headerlink" title="效果图"></a>效果图</h4><p><img data-src="/picture/druid/druid_pivot_hbase_metrics.png" alt="HBase Metrics in Pivot"></p>
<center>（对 <a href="https://docs.imply.io/on-prem/visualize/index" target="_blank">Pivot</a>™ 可视化页面的截图）</center>





<h4 id="踩过的坑"><a href="#踩过的坑" class="headerlink" title="踩过的坑"></a>踩过的坑</h4><h5 id="指标项过多，维护配置困难"><a href="#指标项过多，维护配置困难" class="headerlink" title="指标项过多，维护配置困难"></a>指标项过多，维护配置困难</h5><h6 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h6><p>　可以通过 <code>列转行</code> 的方式，在 <code>dimensions</code> 里面增加一个 <code>metric</code> 维度，来管理指标项。如此，可以有效地避免在 <code>metricsSpec</code> 里面维护大量的指标。同时，也方便了动态新增指标项</p>
<p>　不过，<code>列换行</code> 也会带来数据膨胀的问题。如果在资源受限的情况下，很可能还是得在 <code>metricsSepc</code> 里面维护指标。这样的话，可以使用我写的 <a href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-bigdata/yuzhouwan-bigdata-druid/src/main/java/com/yuzhouwan/bigdata/druid/util/DruidUtils.java">DruidUtils</a> 来快速生成配置文件，避免手动去维护配置</p>
<h3 id="Graphite"><a href="#Graphite" class="headerlink" title="Graphite"></a>Graphite</h3><h4 id="基础环境"><a href="#基础环境" class="headerlink" title="基础环境"></a>基础环境</h4><h5 id="OS"><a href="#OS" class="headerlink" title="OS"></a>OS</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ uname -a</span><br><span class="line">  Linux olap03-sit.yuzhouwan.com 2.6.32-431.el6.x86_64 <span class="comment">#1 SMP Fri Nov 22 03:15:09 UTC 2013 x86_64 x86_64 x86_64 GNU/Linux</span></span><br><span class="line"></span><br><span class="line">$ cat /proc/version</span><br><span class="line">  Linux version 2.6.32-431.el6.x86_64 (mockbuild@c6b8.bsys.dev.centos.org) (gcc version 4.4.7 20120313 (Red Hat 4.4.7-4) (GCC) ) <span class="comment">#1 SMP Fri Nov 22 03:15:09 UTC 2013</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># For Fedora and RHEL-derivatives</span></span><br><span class="line">$ sudo yum upgrade python-setuptools -y</span><br><span class="line">$ sudo yum install openssl openssl-devel install zlib zlib-devel readline readline-devel sqlite-devel libffi-devel -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># Machines</span></span><br><span class="line">druid.yuzhouwan.com        10.10.10.1        Druid</span><br><span class="line">graphite.yuzhouwan.com     192.168.1.101     Graphite</span><br></pre></td></tr></tbody></table></figure>
<h5 id="Python"><a href="#Python" class="headerlink" title="Python"></a><a href="https://yuzhouwan.com/posts/43687/">Python</a></h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ python --version</span><br><span class="line">  Python 2.7.8</span><br><span class="line"></span><br><span class="line">  [Note]: Superset is tested using Python 2.7 and Python 3.4+. Python 3 is the recommended version, Python 2.6 won<span class="string">'t be supported.'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 升级 Python（stable: Python 2.7.12 | 3.4.5, lastest: Python 3.5.2 [2016/12/15]）</span></span><br><span class="line">https://www.python.org/downloads/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 python ftp 服务器中下载到 对应版本的 python</span></span><br><span class="line">$ wget http://python.org/ftp/python/2.7.12/Python-2.7.12.tgz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译</span></span><br><span class="line">$ tar -zxvf Python-2.7.12.tgz</span><br><span class="line">$ <span class="built_in">cd</span> /root/software/Python-2.7.12</span><br><span class="line">$ ./configure --prefix=/usr/<span class="built_in">local</span>/python27</span><br><span class="line">$ make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line">$ ls /usr/<span class="built_in">local</span>/python27/ -al</span><br><span class="line"></span><br><span class="line">  drwxr-xr-x.  6 root root 4096 12月 15 14:22 .</span><br><span class="line">  drwxr-xr-x. 13 root root 4096 12月 15 14:20 ..</span><br><span class="line">  drwxr-xr-x.  2 root root 4096 12月 15 14:22 bin</span><br><span class="line">  drwxr-xr-x.  3 root root 4096 12月 15 14:21 include</span><br><span class="line">  drwxr-xr-x.  4 root root 4096 12月 15 14:22 lib</span><br><span class="line">  drwxr-xr-x.  3 root root 4096 12月 15 14:22 share</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 覆盖原来的 python6</span></span><br><span class="line">$ <span class="built_in">which</span> python</span><br><span class="line">  /usr/<span class="built_in">local</span>/bin/python</span><br><span class="line"></span><br><span class="line">$ mv /usr/<span class="built_in">local</span>/bin/python /usr/<span class="built_in">local</span>/bin/python_old</span><br><span class="line">$ ln -s /usr/<span class="built_in">local</span>/python27/bin/python /usr/<span class="built_in">local</span>/bin/</span><br><span class="line"></span><br><span class="line">$ python -V</span><br><span class="line">  Python 2.7.12</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 yum 引用的 python 版本为旧版 2.6 的 python</span></span><br><span class="line">$ vim /usr/bin/yum</span><br><span class="line">  <span class="comment"># 第一行修改为 python2.6</span></span><br><span class="line">  <span class="comment">#!/usr/bin/python2.6</span></span><br><span class="line"></span><br><span class="line">$ yum --version | sed <span class="string">'2,$d'</span></span><br><span class="line">  3.2.29</span><br></pre></td></tr></tbody></table></figure>
<h5 id="Pip"><a href="#Pip" class="headerlink" title="Pip"></a>Pip</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ pip --version</span><br><span class="line">  pip 9.0.1 from /usr/<span class="built_in">local</span>/lib/python2.7/site-packages (python 2.7)</span><br><span class="line"></span><br><span class="line"><span class="comment"># upgrade setup tools and pip</span></span><br><span class="line">$ pip install --upgrade setuptools pip</span><br><span class="line"></span><br><span class="line"><span class="comment">## Offline 环境下安装 pip</span></span><br><span class="line"><span class="comment"># https://pypi.python.org/pypi/setuptools#code-of-conduct 下载 setuptools-32.0.0.tar.gz</span></span><br><span class="line">$ tar zxvf setuptools-32.0.0.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> setuptools-32.0.0</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> setuptools-32.0.0</span><br><span class="line">$ python setup.py install</span><br><span class="line"></span><br><span class="line"><span class="comment"># https://pypi.python.org/pypi/pip 下载 pip-9.0.1.tar.gz</span></span><br><span class="line">$ wget --no-check-certificate https://pypi.python.org/packages/11/b6/abcb525026a4be042b486df43905d6893fb04f05aac21c32c638e939e447/pip-9.0.1.tar.gz<span class="comment">#md5=35f01da33009719497f01a4ba69d63c9</span></span><br><span class="line">$ tar zxvf pip-9.0.1.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> pip-9.0.1</span><br><span class="line">$ python setup.py install</span><br><span class="line"></span><br><span class="line">  Installed /usr/<span class="built_in">local</span>/python27/lib/python2.7/site-packages/pip-9.0.1-py2.7.egg</span><br><span class="line">  Processing dependencies <span class="keyword">for</span> pip==9.0.1</span><br><span class="line">  Finished processing dependencies <span class="keyword">for</span> pip==9.0.1</span><br><span class="line"></span><br><span class="line">$ pip --version</span><br><span class="line">  pip 9.0.1 from /root/software/pip-9.0.1 (python 2.7)</span><br></pre></td></tr></tbody></table></figure>
<h5 id="VirtualEnv"><a href="#VirtualEnv" class="headerlink" title="VirtualEnv"></a>VirtualEnv</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ pip install virtualenv</span><br><span class="line"></span><br><span class="line"><span class="comment"># virtualenv is shipped in Python 3 as pyvenv</span></span><br><span class="line">$ virtualenv venv</span><br><span class="line">$ . ./venv/bin/activate</span><br><span class="line"></span><br><span class="line"><span class="comment">## Offline 环境下安装 virtualenv</span></span><br><span class="line"><span class="comment"># https://pypi.python.org/pypi/virtualenv#downloads 下载 virtualenv-15.1.0.tar.gz</span></span><br><span class="line">$ tar zxvf virtualenv-15.1.0.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> virtualenv-15.1.0</span><br><span class="line">$ python setup.py install</span><br><span class="line"></span><br><span class="line">$ virtualenv --version</span><br><span class="line">  15.1.0</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Graphite-相关"><a href="#Graphite-相关" class="headerlink" title="Graphite 相关"></a>Graphite 相关</h4><h5 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># root@graphite-sit.yuzhouwan.com (192.168.1.102)</span></span><br><span class="line">$ <span class="built_in">cd</span> /opt</span><br><span class="line">$ virtualenv -p /usr/<span class="built_in">local</span>/bin/python --system-site-packages graphite</span><br><span class="line">$ <span class="built_in">cd</span> graphite</span><br><span class="line">$ <span class="built_in">source</span> bin/activate</span><br><span class="line"></span><br><span class="line">$ pip install https://github.com/graphite-project/ceres/tarball/master  (ceres-0.10.0rc1)</span><br><span class="line">$ pip install whisper                                                   (whisper-0.9.15)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># trouble shooting</span></span><br><span class="line">  $ <span class="built_in">which</span> python</span><br><span class="line">    /root/graphite/bin/python      (<span class="keyword">in</span> virtualenv, otherwise <span class="string">"/usr/local/bin/python"</span>)</span><br><span class="line"></span><br><span class="line">  $ ll /root/graphite/bin/whisper*py</span><br><span class="line">    -rwxr-xr-x 1 root root 2847 Jan  3 17:06 /root/graphite/bin/whisper-create.py</span><br><span class="line">    -rwxr-xr-x 1 root root 2208 Jan  3 17:06 /root/graphite/bin/whisper-diff.py</span><br><span class="line">    -rwxr-xr-x 1 root root 2912 Jan  3 17:06 /root/graphite/bin/whisper-dump.py</span><br><span class="line">    -rwxr-xr-x 1 root root 1790 Jan  3 17:06 /root/graphite/bin/whisper-fetch.py</span><br><span class="line">    -rwxr-xr-x 1 root root 4309 Jan  3 17:06 /root/graphite/bin/whisper-fill.py</span><br><span class="line">    -rwxr-xr-x 1 root root 1081 Jan  3 17:06 /root/graphite/bin/whisper-info.py</span><br><span class="line">    -rwxr-xr-x 1 root root  685 Jan  3 17:06 /root/graphite/bin/whisper-merge.py</span><br><span class="line">    -rwxr-xr-x 1 root root 5994 Jan  3 17:06 /root/graphite/bin/whisper-resize.py</span><br><span class="line">    -rwxr-xr-x 1 root root  929 Jan  3 17:06 /root/graphite/bin/whisper-set-aggregation-method.py</span><br><span class="line">    -rwxr-xr-x 1 root root  980 Jan  3 17:06 /root/graphite/bin/whisper-update.py</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ pip install carbon    (carbon-0.9.15 constantly-15.1.0 incremental-16.10.1 twisted-16.6.0 txamqp-0.6.2 zope.interface-4.3.3)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># trouble shooting</span></span><br><span class="line">  $ ll /root/graphite/bin/carbon*py</span><br><span class="line">    -rwxr-xr-x 1 root root 1095 Jan  3 17:12 /root/graphite/bin/carbon-aggregator.py</span><br><span class="line">    -rwxr-xr-x 1 root root 1095 Jan  3 17:12 /root/graphite/bin/carbon-cache.py</span><br><span class="line">    -rwxr-xr-x 1 root root 4498 Jan  3 17:12 /root/graphite/bin/carbon-client.py</span><br><span class="line">    -rwxr-xr-x 1 root root 1095 Jan  3 17:12 /root/graphite/bin/carbon-relay.py</span><br><span class="line"></span><br><span class="line">$ pip install graphite-web</span><br><span class="line">$ pip install cairocffi</span><br><span class="line"></span><br><span class="line"><span class="comment"># pip freeze | grep graphite-web</span></span><br><span class="line"><span class="comment"># graphite-web==0.9.15</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="graphite-配置"><a href="#graphite-配置" class="headerlink" title="graphite 配置"></a>graphite 配置</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /root/graphite/conf      (otherwise /opt/graphite/conf)</span><br><span class="line"></span><br><span class="line">$ ls -sail</span><br><span class="line">  total 72</span><br><span class="line">  -rw-r--r-- 1 root root  1798 Jan  3 17:54 aggregation-rules.conf.example</span><br><span class="line">  -rw-r--r-- 1 root root   274 Jan  3 17:54 blacklist.conf.example</span><br><span class="line">  -rw-r--r-- 1 root root  2594 Jan  3 17:54 carbon.amqp.conf.example</span><br><span class="line">  -rw-r--r-- 1 root root 17809 Jan  3 17:54 carbon.conf.example</span><br><span class="line">  -rw-r--r-- 1 root root   888 Jan  3 17:54 relay-rules.conf.example</span><br><span class="line">  -rw-r--r-- 1 root root   558 Jan  3 17:54 rewrite-rules.conf.example</span><br><span class="line">  -rw-r--r-- 1 root root   827 Jan  3 17:54 storage-aggregation.conf.example</span><br><span class="line">  -rw-r--r-- 1 root root   489 Jan  3 17:54 storage-schemas.conf.example</span><br><span class="line">  -rw-r--r-- 1 root root   315 Jan  3 17:54 whitelist.conf.example</span><br><span class="line"></span><br><span class="line">$ cp aggregation-rules.conf.example aggregation-rules.conf</span><br><span class="line">$ cp blacklist.conf.example blacklist.conf</span><br><span class="line">$ cp carbon.amqp.conf.example carbon.amqp.conf</span><br><span class="line">$ cp carbon.conf.example carbon.conf</span><br><span class="line"><span class="comment"># following 3 conf files need to install graphite-web firstly</span></span><br><span class="line">$ cp dashboard.conf.example dashboard.conf</span><br><span class="line">$ cp graphite.wsgi.example graphite.wsgi</span><br><span class="line">$ cp graphTemplates.conf.example graphTemplates.conf</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">$ cp relay-rules.conf.example relay-rules.conf</span><br><span class="line">$ cp rewrite-rules.conf.example rewrite-rules.conf</span><br><span class="line">$ cp storage-aggregation.conf.example storage-aggregation.conf</span><br><span class="line">$ cp storage-schemas.conf.example storage-schemas.conf</span><br><span class="line">$ cp whitelist.conf.example whitelist.conf</span><br><span class="line"></span><br><span class="line">$ /root/graphite/bin/carbon-cache.py start</span><br><span class="line"></span><br><span class="line">  Starting carbon-cache (instance a)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># trouble shooting</span></span><br><span class="line">  $ ps -ef | grep carbon</span><br><span class="line">    root     12074     1  0 18:58 ?     00:00:00 /root/graphite/bin/python /root/graphite/bin/carbon-cache.py start</span><br><span class="line"></span><br><span class="line">  $ vim /root/graphite/conf/carbon.conf</span><br><span class="line">    <span class="comment"># carbon.conf 文件中，在 cache 区段下，接收端口这一行包含一个默认值，用于通过平文本协议（plaintext protocol）接受输入指标项</span></span><br><span class="line">    [cache]</span><br><span class="line">    LINE_RECEIVER_INTERFACE = 0.0.0.0</span><br><span class="line">    LINE_RECEIVER_PORT = 2003</span><br><span class="line"></span><br><span class="line">  $ yum install nc -y</span><br><span class="line">  <span class="comment"># echo "&lt;metric path&gt; &lt;metric value&gt; &lt;metric timestamp&gt;" | nc -q0 ${SERVER} ${PORT}</span></span><br><span class="line">  $ <span class="built_in">echo</span> <span class="string">"carbon.agents.graphite-tutorial.metricsReceived 28198 `date +%s`"</span> | nc -c localhost 2003</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Carbon 与 Whisper 交互，将这些时间序列数据存储到文件系统中，可以用 whisper-info 脚本获取为这些指标项创建的 Whisper 文件的元数据信息</span></span><br><span class="line">  $ /root/graphite/bin/whisper-info.py /root/graphite/storage/whisper/carbon/agents/graphite-tutorial/metricsReceived.wsp</span><br></pre></td></tr></tbody></table></figure>
<h5 id="graphite-web-应用"><a href="#graphite-web-应用" class="headerlink" title="graphite web 应用"></a>graphite web 应用</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># dependency</span></span><br><span class="line"><span class="comment"># pip install Django==1.9.12 会导致 'WSGIRequest' object has no attribute 'REQUEST' 异常</span></span><br><span class="line">$ pip install django==1.8.17</span><br><span class="line">$ pip install django-tagging</span><br><span class="line"></span><br><span class="line"><span class="comment"># configure</span></span><br><span class="line">$ <span class="built_in">cd</span> /root/graphite/lib/python2.7/site-packages/opt/graphite/webapp/graphite</span><br><span class="line">$ cp local_settings.py.example local_settings.py</span><br><span class="line"><span class="comment"># 创建 SQLite3 数据库 &amp; 赋读写权限 &amp; 修改 local_settings.py</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> /root/graphite/conf</span><br><span class="line">$ cp dashboard.conf.example dashboard.conf</span><br><span class="line">$ cp graphTemplates.conf.example graphTemplates.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># init database</span></span><br><span class="line">$ <span class="built_in">cd</span> /root/graphite/lib/python2.7/site-packages/opt/graphite/webapp/graphite/</span><br><span class="line">$ python /root/graphite/lib/python2.7/site-packages/opt/graphite/webapp/graphite/manage.py syncdb</span><br><span class="line"></span><br><span class="line"> Would you like to create one now? (yes/no): yes</span><br><span class="line"> Username (leave blank to use <span class="string">'root'</span>): graphite</span><br><span class="line"> Email address: bj@yuzhouwan.com</span><br><span class="line"> Password:</span><br><span class="line"> Password (again):</span><br><span class="line"> Superuser created successfully.</span><br><span class="line"></span><br><span class="line"><span class="comment"># start</span></span><br><span class="line">$ mkdir -p /root/graphite/storage/<span class="built_in">log</span>/webapp/</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">''</span> &gt; /root/graphite/storage/<span class="built_in">log</span>/webapp/process.log</span><br><span class="line">$ <span class="built_in">cd</span> /root/graphite</span><br><span class="line">$ PYTHONPATH=/root/graphite/storage/whisper /root/graphite/bin/run-graphite-devel-server.py --port=8085 --libs=/root/graphite/lib/python2.7/site-packages/opt/graphite/webapp /root/graphite 1&gt;/root/graphite/storage/<span class="built_in">log</span>/webapp/process.log 2&gt;&amp;1 &amp;</span><br><span class="line"><span class="comment"># 或者用，python /root/graphite/lib/python2.7/site-packages/opt/graphite/webapp/graphite/manage.py runserver 0.0.0.0:8085</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># trouble shooting</span></span><br><span class="line">  $ tail -f /root/graphite/storage/<span class="built_in">log</span>/webapp/process.log</span><br><span class="line">  http://192.168.1.102:8085/</span><br></pre></td></tr></tbody></table></figure>
<h5 id="graphite-events"><a href="#graphite-events" class="headerlink" title="graphite events"></a>graphite events</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># PYTHONPATH=$GRAPHITE_ROOT/webapp django-admin.py migrate --settings=graphite.settings --run-syncdb</span></span><br><span class="line">$ PYTHONPATH=/root/graphite/lib/python2.7/site-packages/opt/graphite/webapp django-admin.py migrate --settings=graphite.settings --run-syncdb</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line">Operations to perform:</span><br><span class="line">  Synchronize unmigrated apps: account, cli, render, whitelist, metrics, url_shortener, dashboard, composer, events, browser</span><br><span class="line">  Apply all migrations: admin, contenttypes, tagging, auth, sessions</span><br><span class="line">Synchronizing apps without migrations:</span><br><span class="line">  Creating tables...</span><br><span class="line">  Running deferred SQL...</span><br><span class="line">Running migrations:</span><br><span class="line">  Rendering model states... DONE</span><br><span class="line">  Applying admin<span class="number">.0002</span>_logentry_remove_auto_add... OK</span><br><span class="line">  Applying auth<span class="number">.0007</span>_alter_validators_add_error_messages... OK</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ curl -X POST <span class="string">"http://10.10.10.2:8085/events/"</span> -d <span class="string">'{ "what": "Event - deploy", "tags": ["deploy"], "when": 1467844481, "data": "deploy of master branch happened at Wed Jul  6 22:34:41 UTC 2016" }'</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># trouble shooting</span></span><br><span class="line">http://10.10.10.2:8085/events/  graphite events  when  what  tags</span><br><span class="line">22:34:41 Wed 06 Jul 2016        Event - deploy        [u<span class="string">'deploy'</span>]</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ curl -s <span class="string">"http://10.10.10.2:8085/render/?target=events('exception')&amp;format=json"</span> | json_pp</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">[</span><br><span class="line">  {</span><br><span class="line">    <span class="attr">"target"</span>: <span class="string">"events(exception)"</span>,</span><br><span class="line">    <span class="attr">"datapoints"</span>: [</span><br><span class="line">      [</span><br><span class="line">        <span class="number">1</span>,</span><br><span class="line">        <span class="number">1388966651</span></span><br><span class="line">      ],</span><br><span class="line">      [</span><br><span class="line">        <span class="number">3</span>,</span><br><span class="line">        <span class="number">1388966652</span></span><br><span class="line">      ]</span><br><span class="line">    ]</span><br><span class="line">  }</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>
<h5 id="graphite-index"><a href="#graphite-index" class="headerlink" title="graphite-index"></a>graphite-index</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># douban new UI for graphite</span></span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/douban/graph-index.git</span><br><span class="line">$ <span class="built_in">cd</span> graph-index</span><br><span class="line"></span><br><span class="line">$ vim config.py</span><br><span class="line">  graphite_url = <span class="string">'http://192.168.1.101:9097'</span></span><br><span class="line"></span><br><span class="line">$ crontab -e</span><br><span class="line">  */5 * * * * python /root/software/graphite-index</span><br><span class="line"></span><br><span class="line">$ python /graph-index.py</span><br></pre></td></tr></tbody></table></figure>
<h4 id="整合-Druid"><a href="#整合-Druid" class="headerlink" title="整合 Druid"></a>整合 Druid</h4><h5 id="迁移到内网环境"><a href="#迁移到内网环境" class="headerlink" title="迁移到内网环境"></a>迁移到内网环境</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 192.168.1.102 to 10.10.10.2 (sit)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ps -ef | grep graphite # 关闭所有进程</span></span><br><span class="line"><span class="comment"># rsync 替换 scp 可以确保软链接也能被 cp（补充：用 tar zcvf 打包也是不能解决的）</span></span><br><span class="line">$ rsync -avuz -e ssh /root/graphite root@10.10.10.2:/root</span><br><span class="line"></span><br><span class="line"><span class="comment"># 192.168.1.102 to 192.168.2.101 to 192.168.1.101 (product)</span></span><br><span class="line">$ rsync -avuz -e ssh /root/graphite jinjy@192.168.2.101:/home/jinjy</span><br><span class="line">$ rsync -avuz -e ssh /home/jinjy/graphite root@192.168.1.101:/root</span><br><span class="line"></span><br><span class="line"><span class="comment"># default: --port=8085</span></span><br><span class="line">$ /root/graphite/bin/carbon-cache.py start</span><br><span class="line">$ PYTHONPATH=/root/graphite/storage/whisper /root/graphite/bin/run-graphite-devel-server.py --port=9097 --libs=/root/graphite/lib/python2.7/site-packages/opt/graphite/webapp /root/graphite 1&gt;/root/graphite/storage/<span class="built_in">log</span>/webapp/process.log 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment"># trouble shooting</span></span><br><span class="line">$ ps -ef | grep graphite</span><br><span class="line">  root     30754     1  0 15:42 ?        00:00:00 /root/graphite/bin/python /root/graphite/bin/carbon-cache.py start</span><br><span class="line">  root     30825 28048  3 15:43 pts/1    00:00:00 /root/graphite/bin/python /root/graphite/bin/django-admin runserver --pythonpath /root/graphite/webapp --settings graphite.settings 0.0.0.0:9097</span><br><span class="line">  root     30829 30825  5 15:43 pts/1    00:00:00 /root/graphite/bin/python /root/graphite/bin/django-admin runserver --pythonpath /root/graphite/webapp --settings graphite.settings 0.0.0.0:9097</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> /root/graphite/storage/<span class="built_in">log</span>/carbon-cache/carbon-cache<span class="_">-a</span></span><br><span class="line">  tail -f console.log creates.log listener.log                <span class="comment"># carbon 接收 event 事件相关的日志记录</span></span><br><span class="line">  tail -f /root/graphite/storage/<span class="built_in">log</span>/webapp/process.log</span><br><span class="line"></span><br><span class="line">http://192.168.1.101:9097/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># virtualenv</span></span><br><span class="line">$ rsync -avuz -e ssh /root/software jinjy@192.168.1.101:/home/jinjy</span><br><span class="line">$ rsync -avuz -e ssh /home/jinjy/software/Python-2.7.12.tgz root@192.168.1.101:/root/software</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> /root/software</span><br><span class="line">$ tar zxvf Python-2.7.12.tgz</span><br><span class="line">$ <span class="built_in">cd</span> Python-2.7.12</span><br><span class="line"></span><br><span class="line">$ ./configure --prefix=/usr --<span class="built_in">enable</span>-shared CFLAGS=-fPIC</span><br><span class="line">$ make -j4 &amp;&amp; make -j4 install</span><br><span class="line">$ /sbin/ldconfig -v | grep /</span><br><span class="line">$ python -V</span><br><span class="line">  Python 2.7.12</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 虽然软链接已经 rsync 过来了，但是目标机器相关目录下，没有对应的 python 的动态链接库</span></span><br><span class="line">$ file /root/graphite/lib/python2.7/lib-dynload</span><br><span class="line">  /root/graphite/lib/python2.7/lib-dynload: broken symbolic link to `/usr/<span class="built_in">local</span>/python27/lib/python2.7/lib-dynload<span class="string">'	'</span>`</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 需要和联网环境中，创建 virtualenv 时的 python 全局环境一致</span></span><br><span class="line">$ ./configure --prefix=/usr/<span class="built_in">local</span>/python27 --<span class="built_in">enable</span>-shared CFLAGS=-fPIC</span><br><span class="line">$ make -j4 &amp;&amp; make -j4 install</span><br><span class="line">$ /sbin/ldconfig -v | grep /</span><br><span class="line"></span><br><span class="line">$ ls /usr/<span class="built_in">local</span>/python27/lib/python2.7/lib-dynload -sail</span><br></pre></td></tr></tbody></table></figure>
<h5 id="修改-Druid-配置"><a href="#修改-Druid-配置" class="headerlink" title="修改 Druid 配置"></a>修改 Druid 配置</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ sudo su druid</span><br><span class="line">$ <span class="built_in">cd</span> /home/druid/software/druid</span><br><span class="line"></span><br><span class="line">$ find | grep common.runtime.properties | grep -v quickstart | grep -v dist</span><br><span class="line">  ./conf/druid/_common/common.runtime.properties</span><br><span class="line"></span><br><span class="line">$ cp /home/druid/software/druid/conf/druid/_common/common.runtime.properties /home/druid/software/druid/conf/druid/_common/common.runtime.properties.bak</span><br><span class="line">$ vim /home/druid/software/druid/conf/druid/_common/common.runtime.properties</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># module</span></span><br><span class="line"><span class="meta">druid.extensions.loadList</span>=<span class="string">[..., "graphite-emitter"]</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Monitoring</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="meta">druid.monitoring.monitors</span>=<span class="string">["com.metamx.metrics.JvmMonitor"]</span></span><br><span class="line"><span class="meta">druid.emitter</span>=<span class="string">http</span></span><br><span class="line"><span class="comment">#druid.emitter=logging</span></span><br><span class="line"><span class="meta">druid.emitter.logging.logLevel</span>=<span class="string">info</span></span><br><span class="line"><span class="meta">druid.emitter.http.recipientBaseUrl</span>=<span class="string">http://10.37.2.142:9999/metrics</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># monitor</span></span><br><span class="line"><span class="meta">druid.monitoring.monitors</span>=<span class="string">["com.metamx.metrics.JvmMonitor"]</span></span><br><span class="line"><span class="meta">druid.emitter</span>=<span class="string">composing</span></span><br><span class="line"><span class="meta">druid.emitter.composing.emitters</span>=<span class="string">["graphite", "logging"]</span></span><br><span class="line"><span class="meta">druid.emitter.graphite.hostname</span>=<span class="string">localhost</span></span><br><span class="line"><span class="comment"># 端口需要注意，不是 2003（即，非 /root/graphite/conf/carbon.conf 中的 LINE_RECEIVER_PORT or LINE_RECEIVER_PORT，而是 PICKLE_RECEIVER_PORT）</span></span><br><span class="line"><span class="meta">druid.emitter.graphite.port</span>=<span class="string">2004</span></span><br><span class="line"><span class="comment"># druid.emitter.graphite.eventConverter={"type":"whiteList", "namespacePrefix": "cluster_x", "ignoreHostname":true, "ignoreServiceName":false, "mapFile":"/a/b/c"}</span></span><br><span class="line"><span class="meta">druid.emitter.graphite.eventConverter</span>=<span class="string">{"ingest/events/thrownAway":["dataSource"],"ingest/events/unparseable":["dataSource"],"ingest/events/processed":["dataSource"],"ingest/handoff/failed":["dataSource"],"ingest/persists":[],"ingest/rows/output":[],"jvm/gc":[],"jvm/mem":[],"query/cpu/time":["dataSource","type"],"query/node/time":["dataSource","type"],"query/node/ttfb":["dataSource","type"],"query/partial/time":["dataSource","type"],"query/segment/time":["dataSource","type"],"query/segmentAndCache/time":["dataSource","type"],"query/time":["dataSource","type"],"query/wait/time":["dataSource","type"],"segment/count":[],"segment/dropQueue/count":[],"segment/loadQueue/count":[],"segment/loadQueue/failed":[],"segment/loadQueue/size":[],"segment/scan/pending":[],"segment/size":[],"segment/usedPercent":[]}</span></span><br><span class="line"><span class="meta">druid.emitter.logging.logLevel</span>=<span class="string">info</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">druid.emitter.graphite.eventConverter</span>=<span class="string">{"type":"all", "namespacePrefix": "druid", "ignoreHostname": false, "ignoreServiceName": false}</span></span><br><span class="line"><span class="comment">## pertty format start ##</span></span><br><span class="line"><span class="attr">{</span></span><br><span class="line">  <span class="meta">"ingest/events/thrownAway"</span>: <span class="string">["dataSource"],</span></span><br><span class="line">  <span class="meta">"ingest/events/unparseable"</span>: <span class="string">["dataSource"],</span></span><br><span class="line">  <span class="meta">"ingest/events/processed"</span>: <span class="string">["dataSource"],</span></span><br><span class="line">  <span class="meta">"ingest/handoff/failed"</span>: <span class="string">["dataSource"],</span></span><br><span class="line">  <span class="meta">"ingest/persists"</span>: <span class="string">[],</span></span><br><span class="line">  <span class="meta">"ingest/rows/output"</span>: <span class="string">[],</span></span><br><span class="line">  <span class="meta">"jvm/gc"</span>: <span class="string">[],</span></span><br><span class="line">  <span class="meta">"jvm/mem"</span>: <span class="string">[],</span></span><br><span class="line">  <span class="meta">"query/cpu/time"</span>: <span class="string">[</span></span><br><span class="line">    <span class="attr">"dataSource",</span></span><br><span class="line">    <span class="attr">"type"</span></span><br><span class="line">  <span class="attr">],</span></span><br><span class="line">  <span class="meta">"query/node/time"</span>: <span class="string">[</span></span><br><span class="line">    <span class="attr">"dataSource",</span></span><br><span class="line">    <span class="attr">"type"</span></span><br><span class="line">  <span class="attr">],</span></span><br><span class="line">  <span class="meta">"query/node/ttfb"</span>: <span class="string">[</span></span><br><span class="line">    <span class="attr">"dataSource",</span></span><br><span class="line">    <span class="attr">"type"</span></span><br><span class="line">  <span class="attr">],</span></span><br><span class="line">  <span class="meta">"query/partial/time"</span>: <span class="string">[</span></span><br><span class="line">    <span class="attr">"dataSource",</span></span><br><span class="line">    <span class="attr">"type"</span></span><br><span class="line">  <span class="attr">],</span></span><br><span class="line">  <span class="meta">"query/segment/time"</span>: <span class="string">[</span></span><br><span class="line">    <span class="attr">"dataSource",</span></span><br><span class="line">    <span class="attr">"type"</span></span><br><span class="line">  <span class="attr">],</span></span><br><span class="line">  <span class="meta">"query/segmentAndCache/time"</span>: <span class="string">[</span></span><br><span class="line">    <span class="attr">"dataSource",</span></span><br><span class="line">    <span class="attr">"type"</span></span><br><span class="line">  <span class="attr">],</span></span><br><span class="line">  <span class="meta">"query/time"</span>: <span class="string">[</span></span><br><span class="line">    <span class="attr">"dataSource",</span></span><br><span class="line">    <span class="attr">"type"</span></span><br><span class="line">  <span class="attr">],</span></span><br><span class="line">  <span class="meta">"query/wait/time"</span>: <span class="string">[</span></span><br><span class="line">    <span class="attr">"dataSource",</span></span><br><span class="line">    <span class="attr">"type"</span></span><br><span class="line">  <span class="attr">],</span></span><br><span class="line">  <span class="meta">"segment/count"</span>: <span class="string">[],</span></span><br><span class="line">  <span class="meta">"segment/dropQueue/count"</span>: <span class="string">[],</span></span><br><span class="line">  <span class="meta">"segment/loadQueue/count"</span>: <span class="string">[],</span></span><br><span class="line">  <span class="meta">"segment/loadQueue/failed"</span>: <span class="string">[],</span></span><br><span class="line">  <span class="meta">"segment/loadQueue/size"</span>: <span class="string">[],</span></span><br><span class="line">  <span class="meta">"segment/scan/pending"</span>: <span class="string">[],</span></span><br><span class="line">  <span class="meta">"segment/size"</span>: <span class="string">[],</span></span><br><span class="line">  <span class="meta">"segment/usedPercent"</span>: <span class="string">[]</span></span><br><span class="line"><span class="attr">}</span></span><br><span class="line"><span class="comment">## pertty format end ##</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># kill historical process to make configure activate</span></span><br><span class="line">$ jps -m</span><br><span class="line">  1867 Main server historical</span><br><span class="line">  26339 Main server middleManager</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">kill</span> 1867</span><br></pre></td></tr></tbody></table></figure>
<h5 id="校验-2"><a href="#校验-2" class="headerlink" title="校验"></a>校验</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ tail -f var/sv/supervise.log</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">[Thu Jan  <span class="number">5</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">17</span> <span class="number">2017</span>] Running command[historical], logging to[/home/druid/software/imply-<span class="number">2.0</span>.<span class="number">0</span>/<span class="keyword">var</span>/sv/historical.log]: bin/run-druid historical conf</span><br><span class="line">[Thu Jan  <span class="number">5</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">21</span> <span class="number">2017</span>] Command[historical] exited (pid = <span class="number">1752</span>, exited = <span class="number">1</span>)</span><br><span class="line">[Thu Jan  <span class="number">5</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">21</span> <span class="number">2017</span>] Command[historical] failed, see logfile <span class="keyword">for</span> more details: /home/druid/software/imply-<span class="number">2.0</span>.<span class="number">0</span>/<span class="keyword">var</span>/sv/historical.log</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ tail -f  /home/druid/software/imply-2.0.0/var/sv/historical.log</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="number">2017</span>-<span class="number">01</span>-<span class="number">05</span>T11:<span class="number">34</span>:<span class="number">29</span>,<span class="number">203</span> INFO [GraphiteEmitter-<span class="number">1</span>] io.druid.emitter.graphite.GraphiteEmitter - trying to connect to graphite server</span><br></pre></td></tr></tbody></table></figure>
<div class="note info">如果连接不上，会报错 ERROR [GraphiteEmitter-1] io.druid.emitter.graphite.GraphiteEmitter - 拒绝连接，则需要检查 Graphite 进程是否运行正常</div>



<h4 id="优化配置"><a href="#优化配置" class="headerlink" title="优化配置"></a>优化配置</h4><h5 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h5><h6 id="Django"><a href="#Django" class="headerlink" title="Django"></a>Django</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ pip freeze | grep Django</span><br><span class="line">  Django==1.8</span><br><span class="line"></span><br><span class="line">$ pip install --upgrade Django</span><br><span class="line">  Successfully installed Django-1.10.5</span><br><span class="line"></span><br><span class="line">$ pip uninstall Django</span><br><span class="line">$ pip install Django==1.8.17</span><br></pre></td></tr></tbody></table></figure>
<div class="note warning">高版本 Django 会导致 'WSGIRequest' object has no attribute 'REQUEST' 异常</div>

<h6 id="Graphite-Web-相关"><a href="#Graphite-Web-相关" class="headerlink" title="Graphite-Web 相关"></a>Graphite-Web 相关</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim requirements.txt</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">python-memcached</span>=<span class="string">=1.47</span></span><br><span class="line"><span class="attr">txAMQP</span>=<span class="string">=0.4</span></span><br><span class="line"><span class="attr">simplejson</span>=<span class="string">=2.1.6</span></span><br><span class="line"><span class="meta">django-tagging</span>=<span class="string">=0.4.3</span></span><br><span class="line"><span class="attr">gunicorn</span></span><br><span class="line"><span class="attr">pytz</span></span><br><span class="line"><span class="attr">pyparsing</span>=<span class="string">=1.5.7</span></span><br><span class="line"><span class="attr">cairocffi</span></span><br><span class="line"><span class="attr">whitenoise</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ pip install -r requirements.txt</span><br></pre></td></tr></tbody></table></figure>
<h5 id="采集"><a href="#采集" class="headerlink" title="采集"></a>采集</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim /root/graphite/conf/storage-schemas.conf</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">[carbon]</span></span><br><span class="line"><span class="attr">pattern</span> = <span class="string">^carbon\.</span></span><br><span class="line"><span class="attr">retentions</span> = <span class="string">60:90d</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[default_1min_for_1day]</span></span><br><span class="line"><span class="attr">pattern</span> = <span class="string">.*</span></span><br><span class="line"><span class="comment"># retentions = 60s:1d</span></span><br><span class="line"><span class="comment"># 改为 3 种时间粒度</span></span><br><span class="line"><span class="attr">retentions</span> = <span class="string">10s:6h,1m:7d,10m:1y</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ python /root/graphite/examples/example-client.py</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line">sending message</span><br><span class="line"></span><br><span class="line">-----------------------------------------------------</span><br><span class="line">system.loadavg_1min <span class="number">0.26</span> <span class="number">1483690449</span></span><br><span class="line">system.loadavg_5min <span class="number">0.30</span> <span class="number">1483690449</span></span><br><span class="line">system.loadavg_15min <span class="number">0.35</span> <span class="number">1483690449</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="启动命令汇总"><a href="#启动命令汇总" class="headerlink" title="启动命令汇总"></a>启动命令汇总</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ python /root/graphite/lib/python2.7/site-packages/opt/graphite/webapp/graphite/manage.py syncdb</span><br><span class="line">$ PYTHONPATH=/root/graphite/lib/python2.7/site-packages/opt/graphite/webapp django-admin.py migrate --settings=graphite.settings --run-syncdb</span><br><span class="line"></span><br><span class="line">$ /root/graphite/bin/carbon-cache.py start</span><br><span class="line">$ PYTHONPATH=/root/graphite/storage/whisper /root/graphite/bin/run-graphite-devel-server.py --port=9097 --libs=/root/graphite/webapp /root/graphite 1&gt;/root/graphite/storage/<span class="built_in">log</span>/webapp/process.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></tbody></table></figure>
<h4 id="踩过的坑-1"><a href="#踩过的坑-1" class="headerlink" title="踩过的坑"></a>踩过的坑</h4><h5 id="ImportError-No-module-named-carbon-util"><a href="#ImportError-No-module-named-carbon-util" class="headerlink" title="ImportError: No module named carbon.util"></a>ImportError: No module named carbon.util</h5><h6 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h6><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line">(graphite) [root@graphite-sit.yuzhouwan.com conf]<span class="comment"># /root/graphite/bin/carbon-cache.py start</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"/root/graphite/bin/carbon-cache.py"</span>, line <span class="number">28</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    <span class="keyword">from</span> carbon.util <span class="keyword">import</span> run_twistd_plugin</span><br><span class="line">ImportError: No module named carbon.util</span><br></pre></td></tr></tbody></table></figure>
<h6 id="解决-1"><a href="#解决-1" class="headerlink" title="解决"></a>解决</h6><ul>
<li>检查 carbon 是否已安装</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ pip freeze</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">carbon</span>=<span class="string">=0.9.15</span></span><br><span class="line"><span class="attr">ceres</span>=<span class="string">=0.10.0rc1</span></span><br><span class="line"><span class="attr">constantly</span>=<span class="string">=15.1.0</span></span><br><span class="line"><span class="attr">incremental</span>=<span class="string">=16.10.1</span></span><br><span class="line"><span class="attr">Twisted</span>=<span class="string">=16.6.0</span></span><br><span class="line"><span class="attr">txAMQP</span>=<span class="string">=0.6.2</span></span><br><span class="line"><span class="attr">whisper</span>=<span class="string">=0.9.15</span></span><br><span class="line"><span class="meta">zope.interface</span>=<span class="string">=4.3.3</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>graphiteˊs default prefix (/opt/graphite)</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ mv /root/graphite/lib/python2.7/site-packages/opt/graphite/lib/carbon /root/graphite/lib/python2.7/site-packages/</span><br><span class="line">$ mv /root/graphite/lib/python2.7/site-packages/opt/graphite/lib/twisted/plugins/carbon_* /root/graphite/lib/python2.7/site-packages/twisted/plugins/</span><br></pre></td></tr></tbody></table></figure>
<h5 id="django-db-utils-OperationalError-unable-to-open-database-file"><a href="#django-db-utils-OperationalError-unable-to-open-database-file" class="headerlink" title="django.db.utils.OperationalError: unable to open database file"></a>django.db.utils.OperationalError: unable to open database file</h5><h6 id="描述-1"><a href="#描述-1" class="headerlink" title="描述"></a>描述</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ python manage.py syncdb</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line">/root/graphite/lib/python2<span class="number">.7</span>/site-packages/opt/graphite/webapp/graphite/settings.py:<span class="number">246</span>: UserWarning: SECRET_KEY <span class="keyword">is</span> set to an unsafe default. This should be set <span class="keyword">in</span> local_settings.py <span class="keyword">for</span> better security</span><br><span class="line">warn(<span class="string">'SECRET_KEY is set to an unsafe default. This should be set in local_settings.py for better security'</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">File <span class="string">"manage.py"</span>, line <span class="number">13</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  execute_from_command_line(sys.argv)</span><br><span class="line">File <span class="string">"/root/graphite/lib/python2.7/site-packages/django/core/management/__init__.py"</span>, line <span class="number">338</span>, <span class="keyword">in</span> execute_from_command_line</span><br><span class="line">utility.execute()</span><br><span class="line">// ...</span><br><span class="line">django.db.utils.OperationalError: unable to open database file</span><br></pre></td></tr></tbody></table></figure>
<h6 id="解决-2"><a href="#解决-2" class="headerlink" title="解决"></a>解决</h6><ul>
<li>change default SECRET_KEY in settings.py</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim /root/graphite/lib/python2.7/site-packages/opt/graphite/webapp/graphite/settings.py</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Django 1.5 requires this so we set a default but warn the user</span></span><br><span class="line"><span class="comment"># SECRET_KEY = 'UNSAFE_DEFAULT'</span></span><br><span class="line">SECRET_KEY = <span class="string">'graphite'</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>change DATABASE_NAME in sqlites</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ mkdir /root/graphite/sqlite</span><br><span class="line">$ <span class="built_in">cd</span> /root/graphite/sqlite</span><br><span class="line"></span><br><span class="line"><span class="comment"># create database</span></span><br><span class="line">$ sqlite3 graphite.db</span><br><span class="line">$ sqlite3</span><br><span class="line">sqlite&gt;.<span class="built_in">help</span></span><br><span class="line">sqlite&gt;.databases</span><br><span class="line">  seq  name             file</span><br><span class="line">  ---  ---------------  ------------------------------------------</span><br><span class="line">  0    main             /root/graphite/sqlite/graphite.db</span><br><span class="line"></span><br><span class="line">  Crtl + D (<span class="built_in">exit</span> like python)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># change DATABASE_NAME</span></span><br><span class="line">  DATABASE_NAME=<span class="string">'/root/graphite/sqlite/graphite.db'</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="variable">$DATABASE_NAME</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># run 'python manage.py syncdb' again, then the graphite database disappeared</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>modify settings.py for sqlite database</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /root/graphite/storage</span><br><span class="line">$ mkdir db</span><br><span class="line">$ <span class="built_in">cd</span> db</span><br><span class="line">$ sqlite3 graphite.db</span><br><span class="line">$ vim /root/graphite/lib/python2.7/site-packages/django/conf/project_template/project_name/settings.py</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># GRAPHITE_STORAGE_DIR = '/root/graphite/sqlite/graphite.db'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#DATABASES = {</span></span><br><span class="line"><span class="comment">#    'default': {</span></span><br><span class="line"><span class="comment">#        'ENGINE': 'django.db.backends.sqlite3',</span></span><br><span class="line"><span class="comment">#        'NAME': os.path.join(BASE_DIR, 'db.sqlite3'),</span></span><br><span class="line"><span class="comment">#    }</span></span><br><span class="line"><span class="comment">#}</span></span><br><span class="line">DATABASES = {</span><br><span class="line">  <span class="string">'default'</span>: {</span><br><span class="line">    <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.sqlite3'</span>, <span class="comment"># Add 'postgresql_psycopg2', 'postgresql', 'mysql', 'sqlite3' or 'oracle'.</span></span><br><span class="line">    <span class="string">'NAME'</span>: <span class="string">'/root/graphite/storage/db/graphite.db'</span>, <span class="comment"># Or path to database file if using sqlite3.</span></span><br><span class="line">    <span class="string">'USER'</span>: <span class="string">''</span>, <span class="comment"># Not used with sqlite3.</span></span><br><span class="line">    <span class="string">'PASSWORD'</span>: <span class="string">''</span>, <span class="comment"># Not used with sqlite3.</span></span><br><span class="line">    <span class="string">'HOST'</span>: <span class="string">''</span>, <span class="comment"># Set to empty string for localhost. Not used with sqlite3.</span></span><br><span class="line">    <span class="string">'PORT'</span>: <span class="string">''</span>, <span class="comment"># Set to empty string for default. Not used with sqlite3.</span></span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># trouble shooting</span></span><br><span class="line">$ sqlite3 /root/graphite/storage/db/graphite.db</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">SQLite version 3.6.20</span><br><span class="line">Enter <span class="string">".help"</span> <span class="keyword">for</span> instructions</span><br><span class="line">Enter SQL statements terminated with a <span class="string">";"</span></span><br><span class="line">sqlite&gt; .databases</span><br><span class="line">seq  name             file</span><br><span class="line">---  ---------------  --------------------------------------</span><br><span class="line">0    main             /root/graphite/storage/db/graphite.db</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /root/graphite/</span><br><span class="line">$ find | grep /settings.py | grep -v pyc</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">./lib/python2.7/site-packages/opt/graphite/webapp/graphite/settings.py</span><br><span class="line">./lib/python2.7/site-packages/tagging/tests/settings.py</span><br><span class="line">./lib/python2.7/site-packages/tagging/settings.py</span><br><span class="line">./lib/python2.7/site-packages/django/conf/project_template/project_name/settings.py</span><br></pre></td></tr></tbody></table></figure>
<div class="note success">全部修改完成，即可修复</div>

<ul>
<li>检查 Django 是否版本过低（&lt;= v1.4）</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ django-admin version</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">1.8</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>检查访问权限</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ cut -d: -f1 /etc/passwd | grep graphite</span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$USER</span></span><br><span class="line">  root</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> /root/graphite/storage/db</span><br><span class="line">$ sudo chown root:root graphite.db</span><br><span class="line">$ sudo chmod o+rw graphite.db</span><br><span class="line">$ sudo chmod o+rwx db/</span><br><span class="line">$ sudo chmod o+rwx ../webapp/</span><br></pre></td></tr></tbody></table></figure>
<h5 id="ImportError-No-module-named-graphite-settings"><a href="#ImportError-No-module-named-graphite-settings" class="headerlink" title="ImportError: No module named graphite.settings"></a>ImportError: No module named graphite.settings</h5><h6 id="描述-2"><a href="#描述-2" class="headerlink" title="描述"></a>描述</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ ./bin/run-graphite-devel-server.py --port=8085 --libs=/root/graphite/webapp /root/graphite 1&gt;/root/graphite/storage/<span class="built_in">log</span>/webapp/process.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line">tail: /root/graphite/storage/log/webapp/process.log: file truncated</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"/root/graphite/bin/django-admin"</span>, line <span class="number">11</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  sys.exit(execute_from_command_line())</span><br><span class="line">  File <span class="string">"/root/graphite/lib/python2.7/site-packages/django/core/management/__init__.py"</span>, line <span class="number">338</span>, <span class="keyword">in</span> execute_from_command_line</span><br><span class="line">  utility.execute()</span><br><span class="line">  File <span class="string">"/root/graphite/lib/python2.7/site-packages/django/core/management/__init__.py"</span>, line <span class="number">303</span>, <span class="keyword">in</span> execute</span><br><span class="line">  settings.INSTALLED_APPS</span><br><span class="line">  File <span class="string">"/root/graphite/lib/python2.7/site-packages/django/conf/__init__.py"</span>, line <span class="number">48</span>, <span class="keyword">in</span> __getattr__</span><br><span class="line">  self._setup(name)</span><br><span class="line">  File <span class="string">"/root/graphite/lib/python2.7/site-packages/django/conf/__init__.py"</span>, line <span class="number">44</span>, <span class="keyword">in</span> _setup</span><br><span class="line">  self._wrapped = Settings(settings_module)</span><br><span class="line">  File <span class="string">"/root/graphite/lib/python2.7/site-packages/django/conf/__init__.py"</span>, line <span class="number">92</span>, <span class="keyword">in</span> __init__</span><br><span class="line">  mod = importlib.import_module(self.SETTINGS_MODULE)</span><br><span class="line">  File <span class="string">"/usr/local/python27/lib/python2.7/importlib/__init__.py"</span>, line <span class="number">37</span>, <span class="keyword">in</span> import_module</span><br><span class="line">  __import__(name)</span><br><span class="line">ImportError: No module named graphite.settings</span><br></pre></td></tr></tbody></table></figure>
<h6 id="解决-3"><a href="#解决-3" class="headerlink" title="解决"></a>解决</h6><ul>
<li>修改 local_settings.py</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim /root/graphite/lib/python2.7/site-packages/opt/graphite/webapp/graphite/local_settings.py</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line">DATABASES = {</span><br><span class="line">    <span class="string">'default'</span>: {</span><br><span class="line">        <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.sqlite3'</span>, <span class="comment"># Add 'postgresql_psycopg2', 'postgresql', 'mysql', 'sqlite3' or 'oracle'.</span></span><br><span class="line">        <span class="string">'NAME'</span>: <span class="string">'/root/graphite/storage/db/graphite.db'</span>, <span class="comment"># Or path to database file if using sqlite3.</span></span><br><span class="line">        <span class="string">'USER'</span>: <span class="string">''</span>, <span class="comment"># Not used with sqlite3.</span></span><br><span class="line">        <span class="string">'PASSWORD'</span>: <span class="string">''</span>, <span class="comment"># Not used with sqlite3.</span></span><br><span class="line">        <span class="string">'HOST'</span>: <span class="string">''</span>, <span class="comment"># Set to empty string for localhost. Not used with sqlite3.</span></span><br><span class="line">        <span class="string">'PORT'</span>: <span class="string">''</span>, <span class="comment"># Set to empty string for default. Not used with sqlite3.</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>指定 PYTHONPATH</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ PYTHONPATH=/root/graphite/storage/whisper /root/graphite/bin/run-graphite-devel-server.py --port=8085 --libs=/root/graphite/webapp /root/graphite 1&gt;/root/graphite/storage/<span class="built_in">log</span>/webapp/process.log 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># new problem</span></span><br><span class="line">  ImportError: Cannot import either sping or piddle.</span><br><span class="line"></span><br><span class="line">$ PYTHONPATH=/root/graphite/storage/whisper /root/graphite/bin/run-graphite-devel-server.py --port=8085 --libs=/root/graphite/lib/python2.7/site-packages/opt/graphite/webapp /root/graphite 1&gt;/root/graphite/storage/<span class="built_in">log</span>/webapp/process.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></tbody></table></figure>
<h5 id="OError-Errno-2-No-such-file-or-directory-‘-root-graphite-lib-python2-7-site-packages-opt-graphite-storage-log-webapp-info-log’"><a href="#OError-Errno-2-No-such-file-or-directory-‘-root-graphite-lib-python2-7-site-packages-opt-graphite-storage-log-webapp-info-log’" class="headerlink" title="OError: [Errno 2] No such file or directory: ‘/root/graphite/lib/python2.7/site-packages/opt/graphite/storage/log/webapp/info.log’"></a>OError: [Errno 2] No such file or directory: ‘/root/graphite/lib/python2.7/site-packages/opt/graphite/storage/log/webapp/info.log’</h5><h6 id="描述-3"><a href="#描述-3" class="headerlink" title="描述"></a>描述</h6><p>　访问 <code>http://192.168.1.102:8085/</code> 返回如下信息：</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line">Traceback (most recent call last):</span><br><span class="line">File <span class="string">"/root/graphite/lib/python2.7/site-packages/django/core/handlers/base.py"</span>, line <span class="number">119</span>, <span class="keyword">in</span> get_response</span><br><span class="line">resolver_match = resolver.resolve(request.path_info)</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">File <span class="string">"/usr/local/python27/lib/python2.7/logging/__init__.py"</span>, line <span class="number">943</span>, <span class="keyword">in</span> _open</span><br><span class="line">stream = open(self.baseFilename, self.mode)</span><br><span class="line">IOError: [Errno <span class="number">2</span>] No such file <span class="keyword">or</span> directory: <span class="string">'/root/graphite/lib/python2.7/site-packages/opt/graphite/storage/log/webapp/info.log'</span></span><br></pre></td></tr></tbody></table></figure>
<h6 id="解决-4"><a href="#解决-4" class="headerlink" title="解决"></a>解决</h6><ul>
<li>增加 <code>info.log</code> 文件</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ mkdir -p /root/graphite/lib/python2.7/site-packages/opt/graphite/storage/<span class="built_in">log</span>/webapp/</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">''</span> &gt; /root/graphite/lib/python2.7/site-packages/opt/graphite/storage/<span class="built_in">log</span>/webapp/info.log</span><br></pre></td></tr></tbody></table></figure>
<h5 id="Graphite-Web-页面无-event-数据"><a href="#Graphite-Web-页面无-event-数据" class="headerlink" title="Graphite Web 页面无 event 数据"></a>Graphite Web 页面无 event 数据</h5><h6 id="描述-4"><a href="#描述-4" class="headerlink" title="描述"></a>描述</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 访问 http://192.168.1.101:9097/events/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 Druid 中是能看到 historical 进程的确在产生数据，并且成功连接到了 graphite</span></span><br><span class="line">$ tail -f /home/druid/software/imply-2.0.0/var/sv/historical.log</span><br><span class="line"></span><br><span class="line">  2017-01-05T11:34:29,203 INFO [GraphiteEmitter-1] io.druid.emitter.graphite.GraphiteEmitter - trying to connect to graphite server</span><br><span class="line">  <span class="comment"># 如果连接不上，会报错 ERROR [GraphiteEmitter-1] io.druid.emitter.graphite.GraphiteEmitter - 拒绝连接</span></span><br><span class="line">  <span class="comment"># 则检查 graphite 进程是否正常</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 Graphite 中也能看到数据被收到了</span></span><br><span class="line">$ <span class="built_in">cd</span> /root/graphite/storage/<span class="built_in">log</span>/carbon-cache/carbon-cache<span class="_">-a</span></span><br><span class="line">$ tail -f console.log creates.log listener.log</span><br><span class="line"></span><br><span class="line">  05/01/2017 20:05:18 :: Sorted 75 cache queues <span class="keyword">in</span> 0.000208 seconds</span><br><span class="line">  <span class="comment"># 如果数据有误，会报错 05/01/2017 20:32:32 :: invalid line ((L1483619493L) received from client 10.10.10.1:41752, ignoring</span></span><br><span class="line">  <span class="comment"># 则检查 druid emitter 配置是否正常</span></span><br></pre></td></tr></tbody></table></figure>
<h6 id="解决-5"><a href="#解决-5" class="headerlink" title="解决"></a>解决</h6><ul>
<li>是否是 SQLite 数据库没有成功存储</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># graphite 配置没有问题</span></span><br><span class="line">$ vim /root/graphite/lib/python2.7/site-packages/django/conf/project_template/project_name/settings.py</span><br><span class="line"></span><br><span class="line">  DATABASES = {</span><br><span class="line">    <span class="string">'default'</span>: {</span><br><span class="line">      <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.sqlite3'</span>, <span class="comment"># Add 'postgresql_psycopg2', 'postgresql', 'mysql', 'sqlite3' or 'oracle'.</span></span><br><span class="line">      <span class="string">'NAME'</span>: <span class="string">'/root/graphite/storage/db/graphite.db'</span>, <span class="comment"># Or path to database file if using sqlite3.</span></span><br><span class="line">      <span class="string">'USER'</span>: <span class="string">''</span>, <span class="comment"># Not used with sqlite3.</span></span><br><span class="line">      <span class="string">'PASSWORD'</span>: <span class="string">''</span>, <span class="comment"># Not used with sqlite3.</span></span><br><span class="line">      <span class="string">'HOST'</span>: <span class="string">''</span>, <span class="comment"># Set to empty string for localhost. Not used with sqlite3.</span></span><br><span class="line">      <span class="string">'PORT'</span>: <span class="string">''</span>, <span class="comment"># Set to empty string for default. Not used with sqlite3.</span></span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发现 sqlite 中并没有将 events 记录下来</span></span><br><span class="line">(graphite) [root@kylin03-pre db]<span class="comment"># sqlite3 /root/graphite/storage/db/graphite.db </span></span><br><span class="line">SQLite version 3.6.20</span><br><span class="line">Enter <span class="string">".help"</span> <span class="keyword">for</span> instructions</span><br><span class="line">Enter SQL statements terminated with a <span class="string">";"</span></span><br><span class="line">sqlite&gt; .databases</span><br><span class="line">  seq  name             file</span><br><span class="line">  ---  ---------------  ----------------------------------------</span><br><span class="line">  0    main             /root/graphite/storage/db/graphite.db</span><br><span class="line">  sqlite&gt; .tables</span><br><span class="line">    account_mygraph             dashboard_dashboard</span><br><span class="line">    account_profile             dashboard_dashboard_owners</span><br><span class="line">    account_variable            django_admin_log</span><br><span class="line">    account_view                django_content_type</span><br><span class="line">    account_window              django_migrations</span><br><span class="line">    auth_group                  django_session</span><br><span class="line">    auth_group_permissions      events_event</span><br><span class="line">    auth_permission             tagging_tag</span><br><span class="line">    auth_user                   tagging_taggeditem</span><br><span class="line">    auth_user_groups            url_shortener_link</span><br><span class="line">    auth_user_user_permissions</span><br><span class="line">  sqlite&gt; select * from auth_user;</span><br><span class="line">    1|pbkdf2_sha256<span class="variable">$20000</span><span class="variable">$oEgzveEmcg9B</span><span class="variable">$8xbilUymXlwVBAaB48xpUQwsfIucmeP</span>/4C4YF3U6SlI=|1|graphite|||bj@yuzhouwan.com|1|1|2017-01-04 05:59:10.615950|2017-01-05 08:24:54.957631</span><br><span class="line">    2|pbkdf2_sha256<span class="variable">$20000</span><span class="variable">$gG1lK6FNg0h7</span><span class="variable">$dXH47Wqc</span>+Gj/qTyI6EKOajd+Pj1kKN+U5CtnmDo0K/0=|0|default|||default@localhost.localdomain|0|1|2017-01-04 06:53:34.687401|</span><br><span class="line">    3|pbkdf2_sha256<span class="variable">$20000</span><span class="variable">$fcQ5sYbw0cjk</span><span class="variable">$anjZc4J0eRE51HGJ6D50c0c9</span>+d08iY7lhWseke9RmEY=|0|druid||||0|1|2017-01-05 09:03:48.696161|</span><br><span class="line">  sqlite&gt; select * from events_event;      <span class="comment"># no data!</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 尝试使用 MySQL 替换 SQLite</span></span><br><span class="line"><span class="comment"># 192.168.1.102</span></span><br><span class="line">$ mkdir -p /root/software/mysql</span><br><span class="line">  yum install -y --downloadonly --downloaddir=/root/software/mysql mysql</span><br><span class="line">  yum install -y --downloadonly --downloaddir=/root/software/mysql mysql-server</span><br><span class="line">  yum install -y --downloadonly --downloaddir=/root/software/mysql MySQL-python</span><br><span class="line">  <span class="comment"># 192.168.1.101</span></span><br><span class="line">  yum install -y mysql mysql-server MySQL-python</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> /root/software/mysql</span><br><span class="line">$ wget http://dev.mysql.com/get/mysql57-community-release-el5-7.noarch.rpm</span><br><span class="line">$ yum localinstall mysql57-community-release-el5-7.noarch.rpm</span><br><span class="line">$ yum repolist enabled | grep <span class="string">"mysql.*-community.*"</span></span><br><span class="line">$ yum install mysql-community-server</span><br><span class="line">$ vim /usr/bin/yum-config-manager</span><br><span class="line">  <span class="comment">#!/usr/bin/python2.6 -tt</span></span><br><span class="line"></span><br><span class="line">$ yum-config-manager --<span class="built_in">enable</span> mysql57-community</span><br><span class="line">$ service mysqld start</span><br><span class="line"></span><br><span class="line">$ mysql -uroot -p -S /home/mysql/data/mysql.sock</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 后面规范化部署的时候，可以创建 graphite 用户，并赋权</span></span><br><span class="line">  CREATE DATABASE graphite;</span><br><span class="line">  <span class="comment"># GRANT ALL PRIVILEGES ON graphite.* TO 'graphite'@'localhost' IDENTIFIED BY 'sysadmin';</span></span><br><span class="line">  GRANT ALL PRIVILEGES ON graphite.* TO <span class="string">'root'</span>@<span class="string">'localhost'</span> IDENTIFIED BY <span class="string">'sysadmin'</span>;</span><br><span class="line">  FLUSH PRIVILEGES;</span><br><span class="line"></span><br><span class="line">$ vim /root/graphite/lib/python2.7/site-packages/django/conf/project_template/project_name/settings.py</span><br><span class="line"></span><br><span class="line">  DATABASES = {</span><br><span class="line">    <span class="string">'default'</span>: {</span><br><span class="line">      <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.mysql'</span>,</span><br><span class="line">      <span class="comment"># 'NAME': 'jdbc:mysql://192.168.1.101:3306/graphite',</span></span><br><span class="line">      <span class="string">'NAME'</span>: <span class="string">'graphite'</span>,</span><br><span class="line">      <span class="string">'USER'</span>: <span class="string">'root'</span>,</span><br><span class="line">      <span class="comment"># 'HOST': 'localhost',</span></span><br><span class="line">      <span class="string">'PASSWORD'</span>: <span class="string">'root'</span></span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="comment"># TIME_ZONE = 'UTC'</span></span><br><span class="line">  TIME_ZONE = <span class="string">'Asia/Shanghai'</span></span><br><span class="line">  <span class="comment"># DEBUG = False</span></span><br><span class="line">  DEBUG = True</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> /root/graphite/</span><br><span class="line">$ find | grep /settings.py | grep -v pyc</span><br><span class="line">$ vim /root/graphite/lib/python2.7/site-packages/opt/graphite/webapp/graphite/settings.py</span><br><span class="line">$ vim /root/graphite/lib/python2.7/site-packages/tagging/tests/settings.py</span><br><span class="line">$ vim /root/graphite/lib/python2.7/site-packages/tagging/settings.py</span><br><span class="line"><span class="comment"># ./lib/python2.7/site-packages/django/conf/project_template/project_name/settings.py</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 全部修改完成，即可修复</span></span><br><span class="line"></span><br><span class="line">$ python /root/graphite/lib/python2.7/site-packages/opt/graphite/webapp/graphite/manage.py syncdb</span><br><span class="line"><span class="comment"># 如果需要添加其他的 superuser，可以使用如下命令 admin/admin</span></span><br><span class="line"><span class="comment"># echo "from django.contrib.auth.models import User; User.objects.create_superuser('admin', 'admin@hihuron.com', 'sysadmin')" | python /root/graphite/lib/python2.7/site-packages/opt/graphite/webapp/graphite/manage.py shell</span></span><br><span class="line"></span><br><span class="line">$ /root/graphite/bin/carbon-cache.py start</span><br><span class="line">$ PYTHONPATH=/root/graphite/storage/whisper /root/graphite/bin/run-graphite-devel-server.py --port=9097 --libs=/root/graphite/lib/python2.7/site-packages/opt/graphite/webapp /root/graphite 1&gt;/root/graphite/storage/<span class="built_in">log</span>/webapp/process.log 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> /root/graphite/webapp</span><br><span class="line">$ cp -r content/ /root/graphite/lib/python2.7/site-packages/opt/graphite/webapp</span><br><span class="line">$ <span class="built_in">cd</span> /root/graphite/lib/python2.7/site-packages/opt/graphite/webapp</span><br><span class="line">$ cp -r graphite/ /root/graphite/webapp</span><br><span class="line"></span><br><span class="line">$ PYTHONPATH=/root/graphite/storage/whisper /root/graphite/bin/run-graphite-devel-server.py --port=9097 --libs=/root/graphite/webapp /root/graphite 1&gt;/root/graphite/storage/<span class="built_in">log</span>/webapp/process.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></tbody></table></figure>
<h5 id="ImportError-No-module-named-twisted-python-util"><a href="#ImportError-No-module-named-twisted-python-util" class="headerlink" title="ImportError: No module named twisted.python.util"></a>ImportError: No module named twisted.python.util</h5><h6 id="描述-5"><a href="#描述-5" class="headerlink" title="描述"></a>描述</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ python carbon-cache.py start</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line">Traceback (most recent call last):</span><br><span class="line">File <span class="string">"carbon-cache.py"</span>, line <span class="number">28</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line"><span class="keyword">from</span> carbon.util <span class="keyword">import</span> run_twistd_plugin</span><br><span class="line">File <span class="string">"/opt/graphite/lib/carbon/util.py"</span>, line <span class="number">20</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line"><span class="keyword">from</span> twisted.python.util <span class="keyword">import</span> initgroups</span><br><span class="line">ImportError: No module named twisted.python.util</span><br></pre></td></tr></tbody></table></figure>
<h6 id="解决-6"><a href="#解决-6" class="headerlink" title="解决"></a>解决</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># pip freeze | grep zope.interface # 没有则需要安装</span></span><br><span class="line"><span class="comment"># pip install zope.interface==3.6.0</span></span><br><span class="line">$ wget https://pypi.python.org/packages/<span class="built_in">source</span>/T/Twisted/Twisted-14.0.0.tar.bz2<span class="comment">#md5=9625c094e0a18da77faa4627b98c9815 --no-check-certificate</span></span><br><span class="line">$ tar -jxf Twisted-14.0.0.tar.bz2</span><br><span class="line">$ <span class="built_in">cd</span> Twisted-14.0.0;</span><br><span class="line">$ python setup.py install</span><br></pre></td></tr></tbody></table></figure>
<h5 id="‘WSGIRequest’-object-has-no-attribute-‘REQUEST’"><a href="#‘WSGIRequest’-object-has-no-attribute-‘REQUEST’" class="headerlink" title="‘WSGIRequest’ object has no attribute ‘REQUEST’"></a>‘WSGIRequest’ object has no attribute ‘REQUEST’</h5><h6 id="描述-6"><a href="#描述-6" class="headerlink" title="描述"></a>描述</h6><p>　访问 <code>http://192.168.1.102:9097/</code> 返回如下信息：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">AttributeError at /render/</span><br><span class="line"><span class="string">'WSGIRequest'</span> object has no attribute <span class="string">'REQUEST'</span></span><br><span class="line">Request Method:  GET</span><br><span class="line">Request URL:  http://192.168.1.102:9097/render/?width=586&amp;height=308&amp;_salt=1483685265.903</span><br><span class="line">Django Version:  1.9.12</span><br><span class="line">Exception Type:  AttributeError</span><br><span class="line">Exception Value:</span><br><span class="line"><span class="string">'WSGIRequest'</span> object has no attribute <span class="string">'REQUEST'</span></span><br><span class="line">Exception Location:  /root/graphite/webapp/graphite/render/views.py <span class="keyword">in</span> parseOptions, line 236</span><br><span class="line">Python Executable:  /root/graphite/bin/python</span><br><span class="line">Python Version:  2.7.12</span><br><span class="line">Python Path:</span><br><span class="line">[<span class="string">'/root/graphite/webapp'</span>,</span><br><span class="line"><span class="string">'/root/graphite/webapp'</span>,</span><br><span class="line"><span class="string">'/root/graphite/webapp'</span>,</span><br><span class="line"><span class="string">'/root/graphite/bin'</span>,</span><br><span class="line"><span class="string">'/root/graphite/webapp'</span>,</span><br><span class="line"><span class="string">'/root/graphite/storage/whisper'</span>,</span><br><span class="line"><span class="string">'/root/graphite/lib/python27.zip'</span>,</span><br><span class="line"><span class="string">'/root/graphite/lib/python2.7'</span>,</span><br><span class="line"><span class="string">'/root/graphite/lib/python2.7/plat-linux2'</span>,</span><br><span class="line"><span class="string">'/root/graphite/lib/python2.7/lib-tk'</span>,</span><br><span class="line"><span class="string">'/root/graphite/lib/python2.7/lib-old'</span>,</span><br><span class="line"><span class="string">'/root/graphite/lib/python2.7/lib-dynload'</span>,</span><br><span class="line"><span class="string">'/usr/local/python27/lib/python2.7'</span>,</span><br><span class="line"><span class="string">'/usr/local/python27/lib/python2.7/plat-linux2'</span>,</span><br><span class="line"><span class="string">'/usr/local/python27/lib/python2.7/lib-tk'</span>,</span><br><span class="line"><span class="string">'/root/graphite/lib/python2.7/site-packages'</span>,</span><br><span class="line"><span class="string">'/root/graphite/lib/python2.7/site-packages/graphite-0.71-py2.7.egg'</span>,</span><br><span class="line"><span class="string">'/root/graphite/lib/python2.7/site-packages/spring-5.8.7-py2.7-linux-x86_64.egg'</span>,</span><br><span class="line"><span class="string">'/root/graphite/lib/python2.7/site-packages/Twisted-12.0.0-py2.7-linux-x86_64.egg'</span>,</span><br><span class="line"><span class="string">'/root/graphite/lib/python2.7/site-packages/requests-2.1.0-py2.7.egg'</span>,</span><br><span class="line"><span class="string">'/root/graphite/lib/python2.7/site-packages/numpy-1.12.0rc2-py2.7-linux-x86_64.egg'</span>,</span><br><span class="line"><span class="string">'/root/graphite/lib/python2.7/site-packages/logger-1.4-py2.7.egg'</span>,</span><br><span class="line"><span class="string">'/root/graphite/lib/python2.7/site-packages/decorator-4.0.10-py2.7.egg'</span>,</span><br><span class="line"><span class="string">'/root/graphite/lib/python2.7/site-packages/sping-1.1.15-py2.5.egg'</span>,</span><br><span class="line"><span class="string">'/usr/local/python27/lib/python2.7/site-packages'</span>,</span><br><span class="line"><span class="string">'/root/graphite/webapp/graphite/thirdparty'</span>]</span><br><span class="line">Server time:  Fri, 6 Jan 2017 14:47:46 +0800</span><br></pre></td></tr></tbody></table></figure>
<h6 id="解决-7"><a href="#解决-7" class="headerlink" title="解决"></a>解决</h6><p>　Django 版本不对应导致的，安装 1.8.17 版本即可</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">django==1.8.17</span><br></pre></td></tr></tbody></table></figure>
<h2 id="踩过的坑-2"><a href="#踩过的坑-2" class="headerlink" title="踩过的坑"></a>踩过的坑</h2><h3 id="true-false-存为维度后变成了-NULL"><a href="#true-false-存为维度后变成了-NULL" class="headerlink" title="true / false 存为维度后变成了 NULL"></a>true / false 存为维度后变成了 NULL</h3><h4 id="解决-8"><a href="#解决-8" class="headerlink" title="解决"></a>解决</h4><p>　Druid 本身是无法将 true / false 之类的 boolean 类型作为维度的，可以考虑将 <code>"true"</code> / <code>"false"</code> 字符串作为维度存入。但是，如果自定义的 Bean 对象中，有 <code>String isTimeout = "false"</code> 的属性存在，就不能直接使用 <code>JSON.toJSONString</code> 进行转换。因为 <code>toJSONString</code> 方法中会识别出 <code>"true"</code> / <code>"false"</code> 字符串，并将其自动转化为 boolean 类型。因此，需要通过 <code>Map&lt;String, Object&gt;</code> 将所有字段都存入，然后再调用 <code>JSON.toJSONString</code> 方法即可</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ bin/plyql --host localhost:8082 -q <span class="string">"select * from log"</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">┌─────────────────────────────────────────┬───────┬───────────┬─────┬─────┬──────┬──────────────────────────────────────┐</span><br><span class="line">│ __time                                  │ count │ isTimeout │ max │ min │ sum  │ uuid                                 │</span><br><span class="line">├─────────────────────────────────────────┼───────┼───────────┼─────┼─────┼──────┼──────────────────────────────────────┤</span><br><span class="line">│ Wed Aug 02 2017 17:35:00 GMT+0800 (CST) │ 4     │ NULL      │ 860 │ 860 │ 3440 │ 4621a23d-8270-4bc3-948a-f577b460d72b │</span><br><span class="line">│ Wed Aug 02 2017 17:42:00 GMT+0800 (CST) │ 1     │ NULL      │ 860 │ 860 │ 860  │ 4621a23d-8270-4bc3-948a-f577b460d72b │</span><br><span class="line">│ Wed Aug 02 2017 17:44:00 GMT+0800 (CST) │ 1     │ NULL      │ 860 │ 860 │ 860  │ 4621a23d-8270-4bc3-948a-f577b460d72b │</span><br><span class="line">│ Wed Aug 02 2017 18:03:00 GMT+0800 (CST) │ 3     │ NULL      │ 0   │ 0   │ 0    │ 85f030bd-d737-4863-9af1-e6fd8bd3b15c │</span><br><span class="line">│ Wed Aug 02 2017 19:01:24 GMT+0800 (CST) │ 2     │ NULL      │ 0   │ 0   │ 0    │ 85f030bd-d737-4863-9af1-e6fd8bd3b15c │</span><br><span class="line">│ Wed Aug 02 2017 19:09:49 GMT+0800 (CST) │ 1     │ <span class="literal">false</span>     │ 0   │ 0   │ 0    │ ba11de00-7faf-4eaf-a8ea-1cf3c5033de5 │</span><br><span class="line">└─────────────────────────────────────────┴───────┴───────────┴─────┴─────┴──────┴──────────────────────────────────────┘</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Pool-was-initialized-with-limit-0"><a href="#Pool-was-initialized-with-limit-0" class="headerlink" title="Pool was initialized with limit = 0"></a>Pool was initialized with limit = 0</h3><h4 id="描述-7"><a href="#描述-7" class="headerlink" title="描述"></a>描述</h4><p>　执行 RESTful 查询语句的时候，报错</p>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"error"</span>: <span class="string">"Unknown exception"</span>,</span><br><span class="line">  <span class="attr">"errorClass"</span>: <span class="string">"java.lang.IllegalStateException"</span>,</span><br><span class="line">  <span class="attr">"errorMessage"</span>: <span class="string">"Pool was initialized with limit = 0, there are no objects to take."</span>,</span><br><span class="line">  <span class="attr">"host"</span>: <span class="string">"druid01:8101"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="解决-9"><a href="#解决-9" class="headerlink" title="解决"></a>解决</h4><p>　检查 Broker、Historical、MiddleManger 是否都已经配置了 <code>druid.processing.numMergeBuffers</code> 参数</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/druid/software/druid/conf/druid</span><br><span class="line">$ cat broker/runtime.properties historical/runtime.properties middleManager/runtime.properties | grep numMergeBuffers</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">druid.processing.numMergeBuffers</span>=<span class="string">4</span></span><br><span class="line"><span class="meta">druid.processing.numMergeBuffers</span>=<span class="string">4</span></span><br><span class="line"><span class="meta">druid.processing.numMergeBuffers</span>=<span class="string">4</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="No-buckets-seems-there-is-no-data-to-index"><a href="#No-buckets-seems-there-is-no-data-to-index" class="headerlink" title="No buckets?? seems there is no data to index"></a>No buckets?? seems there is no data to index</h3><h4 id="解决-10"><a href="#解决-10" class="headerlink" title="解决"></a>解决</h4><p>　除去 HDFS 里面的确没有数据的情况，还有可能是因为 Hadoop 任务的 TimeZone 没有设置正确</p>
<figure class="highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">"mapreduce.map.java.opts"</span>:<span class="string">"-Duser.timezone=UTC -Dfile.encoding=UTF-8"</span></span><br><span class="line"><span class="meta">"mapreduce.reduce.java.opts"</span>:<span class="string">"-Duser.timezone=UTC -Dfile.encoding=UTF-8"</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="hyperUniqueCardinality-输出浮点数，导致-having-无法使用-equalTo-进行过滤"><a href="#hyperUniqueCardinality-输出浮点数，导致-having-无法使用-equalTo-进行过滤" class="headerlink" title="hyperUniqueCardinality 输出浮点数，导致 having 无法使用 equalTo 进行过滤"></a>hyperUniqueCardinality 输出浮点数，导致 having 无法使用 equalTo 进行过滤</h3><h4 id="描述-8"><a href="#描述-8" class="headerlink" title="描述"></a>描述</h4><p>　通过下述查询，因为使用了 <code>hyperUniqueCardinality</code> 近似查询，导致 <code>alias-6</code> 输出的值为浮点数（如：10.0000213），如此无法在 <code>having</code> 中使用 <code>equalTo</code> 进行精确过滤（=10）</p>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"jsonClass"</span>: <span class="string">"GroupByQuerySpec"</span>,</span><br><span class="line">  <span class="attr">"queryType"</span>: <span class="string">"groupBy"</span>,</span><br><span class="line">  <span class="attr">"dataSource"</span>: <span class="string">"yuzhouwan"</span>,</span><br><span class="line">  <span class="attr">"dimensions"</span>: [</span><br><span class="line">    {</span><br><span class="line">      <span class="attr">"jsonClass"</span>: <span class="string">"ExtractionDimensionSpec"</span>,</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"extraction"</span>,</span><br><span class="line">      <span class="attr">"dimension"</span>: <span class="string">"__time"</span>,</span><br><span class="line">      <span class="attr">"outputName"</span>: <span class="string">"alias-4"</span>,</span><br><span class="line">      <span class="attr">"extractionFn"</span>: {</span><br><span class="line">        <span class="attr">"jsonClass"</span>: <span class="string">"TimeFormatExtractionFunctionSpec"</span>,</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"timeFormat"</span>,</span><br><span class="line">        <span class="attr">"format"</span>: <span class="string">"yyyy-MM-dd"</span>,</span><br><span class="line">        <span class="attr">"timeZone"</span>: <span class="string">"Asia/Shanghai"</span>,</span><br><span class="line">        <span class="attr">"locale"</span>: <span class="string">"en_US"</span></span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"having"</span>: {</span><br><span class="line">    <span class="attr">"jsonClass"</span>: <span class="string">"ComparisonHavingSpec"</span>,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"greaterThan"</span>,</span><br><span class="line">    <span class="attr">"aggregation"</span>: <span class="string">"alias-6"</span>,</span><br><span class="line">    <span class="attr">"value"</span>: <span class="number">10</span></span><br><span class="line">  },</span><br><span class="line">  <span class="attr">"granularity"</span>: <span class="string">"all"</span>,</span><br><span class="line">  <span class="attr">"aggregations"</span>: [</span><br><span class="line">    {</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"hyperUnique"</span>,</span><br><span class="line">      <span class="attr">"name"</span>: <span class="string">"alias-5"</span>,</span><br><span class="line">      <span class="attr">"fieldName"</span>: <span class="string">"__HLL_booksnumber1"</span></span><br><span class="line">    }</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"postAggregations"</span>: [</span><br><span class="line">    {</span><br><span class="line">      <span class="attr">"jsonClass"</span>: <span class="string">"HyperUniqueCardinalityPostAggregationSpec"</span>,</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"hyperUniqueCardinality"</span>,</span><br><span class="line">      <span class="attr">"fieldName"</span>: <span class="string">"alias-5"</span>,</span><br><span class="line">      <span class="attr">"name"</span>: <span class="string">"alias-6"</span></span><br><span class="line">    }</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"intervals"</span>: [</span><br><span class="line">    <span class="string">"2018-08-08T00:00:00.000+08:00/2018-08-18T00:00:00.000+08:00"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"context"</span>: {</span><br><span class="line">    <span class="attr">"queryId"</span>: <span class="string">"yuzhouwan-127.0.0.1-3395157377882475"</span>,</span><br><span class="line">    <span class="attr">"groupByStrategy"</span>: <span class="string">"v2"</span></span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="解决-11"><a href="#解决-11" class="headerlink" title="解决"></a>解决</h4><p>　通过在 <code>postAggregations</code> 中，增加一个 <a href="https://druid.apache.org/docs/latest/querying/post-aggregations.html#javascript-post-aggregator">JavaScript post-aggregator</a> 计算过程，再利用 <code>Math.round</code> 进行<strong>四舍五入</strong>即可</p>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"jsonClass"</span>: <span class="string">"GroupByQuerySpec"</span>,</span><br><span class="line">  <span class="attr">"queryType"</span>: <span class="string">"groupBy"</span>,</span><br><span class="line">  <span class="attr">"dataSource"</span>: <span class="string">"yuzhouwan"</span>,</span><br><span class="line">  <span class="attr">"dimensions"</span>: [</span><br><span class="line">    {</span><br><span class="line">      <span class="attr">"jsonClass"</span>: <span class="string">"ExtractionDimensionSpec"</span>,</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"extraction"</span>,</span><br><span class="line">      <span class="attr">"dimension"</span>: <span class="string">"__time"</span>,</span><br><span class="line">      <span class="attr">"outputName"</span>: <span class="string">"alias-4"</span>,</span><br><span class="line">      <span class="attr">"extractionFn"</span>: {</span><br><span class="line">        <span class="attr">"jsonClass"</span>: <span class="string">"TimeFormatExtractionFunctionSpec"</span>,</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"timeFormat"</span>,</span><br><span class="line">        <span class="attr">"format"</span>: <span class="string">"yyyy-MM-dd"</span>,</span><br><span class="line">        <span class="attr">"timeZone"</span>: <span class="string">"Asia/Shanghai"</span>,</span><br><span class="line">        <span class="attr">"locale"</span>: <span class="string">"en_US"</span></span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"having"</span>: {</span><br><span class="line">    <span class="attr">"jsonClass"</span>: <span class="string">"ComparisonHavingSpec"</span>,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"equalTo"</span>,</span><br><span class="line">    <span class="attr">"aggregation"</span>: <span class="string">"alias-6"</span>,</span><br><span class="line">    <span class="attr">"value"</span>: <span class="number">10</span></span><br><span class="line">  },</span><br><span class="line">  <span class="attr">"granularity"</span>: <span class="string">"all"</span>,</span><br><span class="line">  <span class="attr">"aggregations"</span>: [</span><br><span class="line">    {</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"hyperUnique"</span>,</span><br><span class="line">      <span class="attr">"name"</span>: <span class="string">"alias-5"</span>,</span><br><span class="line">      <span class="attr">"fieldName"</span>: <span class="string">"__HLL_booksnumber1"</span></span><br><span class="line">    }</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"postAggregations"</span>: [</span><br><span class="line">    {</span><br><span class="line">      <span class="attr">"jsonClass"</span>: <span class="string">"HyperUniqueCardinalityPostAggregationSpec"</span>,</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"hyperUniqueCardinality"</span>,</span><br><span class="line">      <span class="attr">"fieldName"</span>: <span class="string">"alias-5"</span>,</span><br><span class="line">      <span class="attr">"name"</span>: <span class="string">"alias6"</span></span><br><span class="line">    },</span><br><span class="line">    {</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"javascript"</span>,</span><br><span class="line">      <span class="attr">"name"</span>: <span class="string">"alias-6"</span>,</span><br><span class="line">      <span class="attr">"fieldNames"</span>: [</span><br><span class="line">        <span class="string">"alias6"</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"function"</span>: <span class="string">"function(alias6) { return Math.round(alias6); }"</span></span><br><span class="line">    }</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"intervals"</span>: [</span><br><span class="line">    <span class="string">"2018-08-08T00:00:00.000+08:00/2018-08-16T00:00:00.000+08:00"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"context"</span>: {</span><br><span class="line">    <span class="attr">"queryId"</span>: <span class="string">"yuzhouwan-127.0.0.1-3395157377882475"</span>,</span><br><span class="line">    <span class="attr">"groupByStrategy"</span>: <span class="string">"v2"</span></span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="修改-Apache-Druid-的默认时区"><a href="#修改-Apache-Druid-的默认时区" class="headerlink" title="修改 Apache Druid 的默认时区"></a>修改 Apache Druid 的默认时区</h3><h4 id="解决-12"><a href="#解决-12" class="headerlink" title="解决"></a>解决</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /opt/druid/conf/druid/cluster</span><br><span class="line">$ find . -name jvm.config</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">./data/middleManager/jvm.config</span><br><span class="line">./data/historical/jvm.config</span><br><span class="line">./query/router/jvm.config</span><br><span class="line">./query/broker/jvm.config</span><br><span class="line">./master/coordinator-overlord/jvm.config</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ grep <span class="string">'user.timezone'</span> `find . -name jvm.config`</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">./data/middleManager/jvm.config</span>:<span class="string">-Duser.timezone=UTC</span></span><br><span class="line"><span class="meta">./data/historical/jvm.config</span>:<span class="string">-Duser.timezone=UTC</span></span><br><span class="line"><span class="meta">./query/router/jvm.config</span>:<span class="string">-Duser.timezone=UTC</span></span><br><span class="line"><span class="meta">./query/broker/jvm.config</span>:<span class="string">-Duser.timezone=UTC</span></span><br><span class="line"><span class="meta">./master/coordinator-overlord/jvm.config</span>:<span class="string">-Duser.timezone=UTC</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ sed -<span class="keyword">in</span>-place -e <span class="string">'s/-Duser.timezone=UTC/-Duser.timezone=UTC+8/g'</span> `find . -name jvm.config`</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ grep <span class="string">'user.timezone'</span> `find . -name jvm.config`</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight properties"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">./data/middleManager/jvm.config</span>:<span class="string">-Duser.timezone=UTC+8</span></span><br><span class="line"><span class="meta">./data/historical/jvm.config</span>:<span class="string">-Duser.timezone=UTC+8</span></span><br><span class="line"><span class="meta">./query/router/jvm.config</span>:<span class="string">-Duser.timezone=UTC+8</span></span><br><span class="line"><span class="meta">./query/broker/jvm.config</span>:<span class="string">-Duser.timezone=UTC+8</span></span><br><span class="line"><span class="meta">./master/coordinator-overlord/jvm.config</span>:<span class="string">-Duser.timezone=UTC+8</span></span><br></pre></td></tr></tbody></table></figure>
<div class="note info">Apache Druid 的默认时区为 UTC，这里我们以东八区为例，将 user.timezone 属性改为 UTC+8 即可</div>





<h2 id="社区发展"><a href="#社区发展" class="headerlink" title="社区发展"></a>社区发展</h2><h3 id="Star-趋势"><a href="#Star-趋势" class="headerlink" title="Star 趋势"></a>Star 趋势</h3><p><img data-src="/picture/tsdb/tsdb_star_history.png" alt="TSDB Star History"></p>
<center>（图片来源：<a href="https://star-history.t9t.io/#apache/druid&amp;apache/pinot&amp;influxdata/influxdb&amp;timescale/timescaledb&amp;OpenTSDB/opentsdb&amp;crate/crate" target="_blank">star-history.t9t.io</a>™ 官网）</center>

<h3 id="个人贡献"><a href="#个人贡献" class="headerlink" title="个人贡献"></a>个人贡献</h3><ul>
<li><a href="https://github.com/apache/druid/issues?utf8=%E2%9C%93&amp;q=%20is%3Aissue%20author%3Aasdf2014">Issues</a></li>
<li><a href="https://github.com/apache/druid/pulls?utf8=✓&amp;q=%20is%3Apr%20author%3Aasdf2014">Pull Request</a></li>
</ul>
<p>　详见：《<a href="https://yuzhouwan.com/posts/19631/">如何成为 Apache 的 PMC</a>》</p>
<h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><h3 id="Doc"><a href="#Doc" class="headerlink" title="Doc"></a>Doc</h3><ul>
<li><a href="https://imply.io/druid/cheat-sheet">Apache Druid API Cheat Sheet</a></li>
<li><a href="https://druid.apache.org/docs/latest/querying/sql.html#data-types">Data types</a></li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">SQL type</th>
<th style="text-align:center">Druid runtime type</th>
<th style="text-align:center">Default value</th>
<th style="text-align:center">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">CHAR</td>
<td style="text-align:center">STRING</td>
<td style="text-align:center"><code>''</code></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">VARCHAR</td>
<td style="text-align:center">STRING</td>
<td style="text-align:center"><code>''</code></td>
<td style="text-align:center">Druid STRING columns are reported as VARCHAR. Can include <a href="https://druid.apache.org/docs/latest/querying/sql.html#multi-value-strings">multi-value strings</a> as well.</td>
</tr>
<tr>
<td style="text-align:center">DECIMAL</td>
<td style="text-align:center">DOUBLE</td>
<td style="text-align:center"><code>0.0</code></td>
<td style="text-align:center">DECIMAL uses floating point, not fixed point math</td>
</tr>
<tr>
<td style="text-align:center">FLOAT</td>
<td style="text-align:center">FLOAT</td>
<td style="text-align:center"><code>0.0</code></td>
<td style="text-align:center">Druid FLOAT columns are reported as FLOAT</td>
</tr>
<tr>
<td style="text-align:center">REAL</td>
<td style="text-align:center">DOUBLE</td>
<td style="text-align:center"><code>0.0</code></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">DOUBLE</td>
<td style="text-align:center">DOUBLE</td>
<td style="text-align:center"><code>0.0</code></td>
<td style="text-align:center">Druid DOUBLE columns are reported as DOUBLE</td>
</tr>
<tr>
<td style="text-align:center">BOOLEAN</td>
<td style="text-align:center">LONG</td>
<td style="text-align:center"><code>false</code></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">TINYINT</td>
<td style="text-align:center">LONG</td>
<td style="text-align:center"><code>0</code></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">SMALLINT</td>
<td style="text-align:center">LONG</td>
<td style="text-align:center"><code>0</code></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">INTEGER</td>
<td style="text-align:center">LONG</td>
<td style="text-align:center"><code>0</code></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">BIGINT</td>
<td style="text-align:center">LONG</td>
<td style="text-align:center"><code>0</code></td>
<td style="text-align:center">Druid LONG columns (except <code>__time</code>) are reported as BIGINT</td>
</tr>
<tr>
<td style="text-align:center">TIMESTAMP</td>
<td style="text-align:center">LONG</td>
<td style="text-align:center"><code>0</code>, meaning 1970-01-01 00:00:00 UTC</td>
<td style="text-align:center">Druid’s <code>__time</code> column is reported as TIMESTAMP. Casts between string and timestamp types assume standard SQL formatting, e.g. <code>2000-01-02 03:04:05</code>, <em>not</em> ISO8601 formatting. For handling other formats, use one of the <a href="https://druid.apache.org/docs/latest/querying/sql.html#time-functions">time functions</a></td>
</tr>
<tr>
<td style="text-align:center">DATE</td>
<td style="text-align:center">LONG</td>
<td style="text-align:center"><code>0</code>, meaning 1970-01-01</td>
<td style="text-align:center">Casting TIMESTAMP to DATE rounds down the timestamp to the nearest day. Casts between string and date types assume standard SQL formatting, e.g. <code>2000-01-02</code>. For handling other formats, use one of the <a href="https://druid.apache.org/docs/latest/querying/sql.html#time-functions">time functions</a></td>
</tr>
<tr>
<td style="text-align:center">OTHER</td>
<td style="text-align:center">COMPLEX</td>
<td style="text-align:center">none</td>
<td style="text-align:center">May represent various Druid column types such as hyperUnique, approxHistogram, etc</td>
</tr>
</tbody>
</table>
</div>
<div class="note info">可以通过 druid.indexing.doubleStorage 配置项，来控制浮点型数据存储为 float 还是 double，默认值为 double</div>

<ul>
<li><a href="https://druid.apache.org/docs/latest/tutorials/tutorial-update-data.html#append-to-the-data">Append to the data</a></li>
</ul>
<h3 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h3><ul>
<li><a href="https://github.com/apache/druid/issues/6716">引入精确去重</a></li>
<li><a href="https://github.com/apache/druid/issues/6832">全新的 UI 页面</a></li>
<li><a href="https://github.com/apache/druid/issues/7093">查询矢量化</a></li>
<li><a href="https://github.com/apache/druid/issues/8728">支持原生的 Join 查询</a></li>
<li><a href="https://github.com/apache/druid/pull/9898">支持 Aliyun OSS 作为 Deep Storage</a></li>
<li><a href="https://github.com/druid-io/druid-operator">Apache Druid Kubernetes Operator</a></li>
</ul>
<h3 id="Book"><a href="#Book" class="headerlink" title="Book"></a>Book</h3><ul>
<li>Druid 实时大数据分析原理与实践</li>
<li>大数据系统构建：可扩展实时数据系统构建原理</li>
</ul>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">Apache Druid</td>
<td style="text-align:center">钉钉群 23318065</td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt=""></a></td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>大数据</category>
      </categories>
      <tags>
        <tag>Apache Calcite</tag>
        <tag>Kubernetes</tag>
        <tag>Docker</tag>
        <tag>Maven</tag>
        <tag>Java</tag>
        <tag>Helm</tag>
        <tag>Apache Druid</tag>
        <tag>Apache ZooKeeper</tag>
        <tag>InfluxDB</tag>
        <tag>Grafana</tag>
        <tag>TSDB</tag>
        <tag>Apache Superset</tag>
        <tag>Python</tag>
        <tag>Presto</tag>
        <tag>PostgreSQL</tag>
        <tag>Pivot</tag>
        <tag>Graphite</tag>
        <tag>OLAP</tag>
      </tags>
  </entry>
  <entry>
    <title>ZooKeeper 原理与优化</title>
    <url>/posts/31915/</url>
    <content><![CDATA[<h2 id="ZooKeeper-是什么？"><a href="#ZooKeeper-是什么？" class="headerlink" title="ZooKeeper 是什么？"></a>ZooKeeper 是什么？</h2><p>　<strong>ZooKeeper</strong> 是一个基于 <a href="https://static.googleusercontent.com/media/research.google.com/zh-CN//archive/chubby-osdi06.pdf">Google Chubby</a> 论文实现的一款解决分布式数据一致性问题的开源实现，方便了依赖 ZooKeeper 的应用实现 <code>数据发布 / 订阅</code>、<code>负载均衡</code>、<code>服务注册与发现</code>、<code>分布式协调</code>、<code>事件通知</code>、<code>集群管理</code>、<code>Leader 选举</code>、 <code>分布式锁和队列</code> 等功能</p>
<h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><h3 id="集群角色"><a href="#集群角色" class="headerlink" title="集群角色"></a>集群角色</h3><p>　一般的，在分布式系统中，构成集群的每一台机器都有自己的角色，最为典型的集群模式就是 <code>Master / Slave</code> 主备模式。在该模式中，我们把能够处理所有<code>写操作</code>的机器称为 <code>Master</code> 节点，并把所有通过<code>异步复制</code>方式获取最新数据、提供<code>读服务</code>的机器称为 <code>Slave</code> 节点</p>
<p><img data-src="/picture/zk/zk_master_slave.png" alt=""></p>
<center>（利用 <a href="https://www.axure.com.cn/" target="_blank">Axure</a>™ 绘制而成）</center>

<p>　而 ZooKeeper 中，则是引入了 <code>领导者（Leader）</code>、<code>跟随者（Follower）</code>、<code>观察者（Observer）</code> 三种角色 和 <code>领导（Leading）</code>、<code>跟随（Following）</code>、<code>观察（Observing）</code>、<code>寻找（Looking）</code> 等相应的<a href="https://github.com/apache/zookeeper/blob/master/src/java/main/org/apache/zookeeper/server/quorum/QuorumPeer.java#L370">状态</a>。在 ZooKeeper 集群中的通过一种 <code>Leader 选举</code>的过程，来选定某个节点作为 <code>Leader</code> 节点，该节点为客户端提供<code>读</code>和<code>写</code>服务。而 <code>Follower</code> 和 <code>Observer</code> 节点，则都能提供<code>读</code>服务，唯一的区别在于，<code>Observer</code> 机器<code>不参与 Leader 选举</code>过程 和 <code>写操作</code>的<code>"过半写成功"</code>策略，<code>Observer</code> 只会被告知已经 commit 的 proposal。因此 <code>Observer</code> 可以在<code>不影响写性能</code>的情况下提升集群的<code>读性能</code>（详见下文 “性能优化 - 优化策略 - Observer 模式” 部分）</p>
<p><img data-src="/picture/zk/zk_leader_follower_observer.png" alt=""></p>
<center>（利用 <a href="https://www.axure.com.cn/" target="_blank">Axure</a>™ 绘制而成）</center>

<a id="more"></a>
<h3 id="会话"><a href="#会话" class="headerlink" title="会话"></a>会话</h3><p>　<strong>Session</strong> 指客户端会话。在 ZooKeeper 中，一个<code>客户端会话</code>是指 <code>客户端</code>和<code>服务器</code>之间的一个 <code>TCP 长连接</code>。客户端启动的时候，会与服务端建立一个 <code>TCP 连接</code>，客户端会话的生命周期，则是从第一次连接建立开始算起。通过这个连接，客户端能够通过<code>心跳检测</code>与服务器保持有效的会话，并向 ZooKeeper 服务器发送请求并接收响应，以及接收来自服务端的 <code>Watch 事件通知</code></p>
<p>　Session 的 sessionTimeout 参数，用来控制一个客户端会话的超时时间。当<code>服务器压力</code>太大 或者是<code>网络故障</code>等各种原因导致客户端<a href="https://cwiki.apache.org/confluence/display/ZOOKEEPER/FAQ">连接断开</a>时，Client 会自动从 ZooKeeper 地址列表中逐一尝试重连（重试策略可使用 <a href="https://github.com/asdf2014/yuzhouwan/tree/master/yuzhouwan-bigdata/yuzhouwan-bigdata-zookeeper/src/main/java/com/yuzhouwan/bigdata/zookeeper">Curator</a> 来实现）。只要在 sessionTimeout 规定的时间内能够<code>重新连接</code>上集群中<code>任意一台服务器</code>，那么之前创建的会话仍然有效。如果，在 sessionTimeout 时间外重连了，就会因为 Session 已经被清除了，而被告知 <code>SESSION_EXPIRED</code>，此时需要程序去恢复临时数据；还有一种 Session 重建后的在新节点上的数据，被之前节点上因<code>网络延迟</code>晚来的<code>写请求</code>所覆盖的情况，在 <a href="https://issues.apache.org/jira/browse/ZOOKEEPER-417">ZOOKEEPER-417</a> 中被提出，并在该 JIRA 中新加入的 <code>SessionMovedException</code>，使得 用同一个 <code>sessionld/sessionPasswd</code> 重建 Session 的客户端能感知到，但是这个问题到 <a href="https://issues.apache.org/jira/browse/ZOOKEEPER-2219">ZOOKEEPER-2219</a> 仍然没有得到很好的解决</p>
<p><img data-src="/picture/zk/zk_transition.png" alt=""></p>
<center>（利用 <a href="https://www.axure.com.cn/" target="_blank">Axure</a>™ 绘制而成）</center>


<h3 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h3><p>　在 ZooKeeper 中，<code>节点</code>分为两类，第一类是指 构成集群的<code>机器</code>，称之为<code>机器节点</code>；第二类则是指 数据模型中的<code>数据单元</code>，称之为<code>数据节点 ZNode</code>。ZooKeeper 将所有数据存储在内存中，数据模型的结构类似于树（ZNode Tree），由<code>斜杠（/）</code>进行分割的路径，就是一个 <code>ZNode</code>，例如 <code>/foo/path1</code>。每个 ZNode 上都会保存自己的数据内容 和 一系列属性信息</p>
<p>　ZNode 可以分为<code>持久节点（PERSISTENT）</code>和<code>临时节点（EPHEMERAL）</code>两类。所谓<code>持久节点</code>是指一旦这个 ZNode 被创建了，除非主动进行移除操作，否则这个节点将一直保存在 ZooKeeper 上。而<code>临时节点</code>的生命周期，是与客户端会话绑定的，一旦客户端会话<code>失效</code>，那么这个<code>客户端创建的所有临时节点</code>都会被<code>移除</code>。在 <a href="https://yuzhouwan.com/posts/45888/">HBase</a> 中，集群则是通过 <strong>/hbase/rs/*</strong> 和 <strong>/hbase/master</strong> 两个临时节点，来监控 <strong>HRegionServer 进程的加入和宕机</strong> 和 <strong>HMaster 进程的 Active 状态</strong></p>
<p>　另外，ZooKeeper 还有一种 <code>顺序节点（SEQUENTIAL）</code>。该节点被创建的时候，ZooKeeper 会自动在其子节点名上，加一个由父节点维护的、自增整数的后缀（上限：<code>Integer.MAX_VALUE</code>）。该节点的特性，还可以应用到 持久 / 临时节点 上，组合成 <code>持久顺序节点（PERSISTENT_SEQUENTIAL）</code> 和 <code>临时顺序节点（EPHEMERAL_SEQUENTIAL）</code></p>
<p><img data-src="/picture/zk/zk_znode.png" alt=""></p>
<center>（利用 <a href="https://www.axure.com.cn/" target="_blank">Axure</a>™ 绘制而成）</center>


<h3 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h3><p>　ZooKeeper 的每个 <code>ZNode</code> 上都会存储数据，对应于每个 <code>ZNode</code>，ZooKeeper 都会为其维护一个叫做 <code>Stat</code> 的数据结构，<code>Stat</code> 中记录了这个 <code>ZNode</code> 的三个数据版本，分别是 <code>version</code>（当前 ZNode 数据内容的版本），<code>cversion</code>（当前 ZNode 子节点的版本）和 <code>aversion</code>（当前 ZNode 的 ACL 变更版本）。这里的<code>版本</code>起到了控制 ZooKeeper 操作<code>原子性</code>的作用（详见下文 “源码分析 - 落脚点 - ZooKeeper 乐观锁” 部分）</p>
<p>　如果想要让写入数据的操作支持 CAS，则可以借助 <code>Versionable#withVersion</code> 方法，在 <code>setData()</code> 的同时指定当前数据的 <code>verison</code>。如果写入成功，则说明在当前数据写入的过程中，没有其他用户对该 ZNode 节点的内容进行过修改；否则，会抛出一个 <code>KeeperException.BadVersionException</code>，以此可以判断本次 CAS 写入是失败的。而这样做的好处就是，可以避免“并发局部更新 ZNode 节点内容”时，发生相互覆盖的问题</p>
<h3 id="Watcher"><a href="#Watcher" class="headerlink" title="Watcher"></a>Watcher</h3><p>　<strong>Watcher</strong>（事件监听器）是 ZooKeeper 提供的一种 <code>发布/订阅</code>的机制。ZooKeeper 允许用户在指定节点上注册一些 Watcher，并且在一些<code>特定事件触发</code>的时候，ZooKeeper 服务端会将事件通知给<code>订阅</code>的客户端。该机制是 ZooKeeper 实现<code>分布式协调</code>的重要特性</p>
<p><img data-src="/picture/zk/zk_watcher.png" alt=""></p>
<center>（利用 <a href="https://www.axure.com.cn/" target="_blank">Axure</a>™ 绘制而成）</center>

<h3 id="ACL"><a href="#ACL" class="headerlink" title="ACL"></a>ACL</h3><p>　类似于 Unix 文件系统，ZooKeeper 采用 <code>ACL（Access Control Lists）</code>策略来进行权限控制（使用方式，详见下文 “常用命令 - 执行脚本 - zkCli - 节点操作” 部分；代码实现，详见 PrepRequestProcessor#<a href="https://github.com/apache/zookeeper/blob/master/src/java/main/org/apache/zookeeper/server/PrepRequestProcessor.java#L286">checkACL</a>）</p>
<h4 id="常用的权限控制"><a href="#常用的权限控制" class="headerlink" title="常用的权限控制"></a>常用的权限控制</h4><div class="table-container">
<table>
<thead>
<tr>
<th>Command</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>CREATE (<strong>c</strong>)</td>
<td>创建子节点的权限</td>
</tr>
<tr>
<td>READ (<strong>r</strong>)</td>
<td>获取节点数据和子节点列表的权限</td>
</tr>
<tr>
<td>WRITE (<strong>w</strong>)</td>
<td>更新节点数据的权限</td>
</tr>
<tr>
<td>DELETE (<strong>d</strong>)</td>
<td>删除当前节点的权限</td>
</tr>
<tr>
<td>ADMIN (<strong>a</strong>)</td>
<td>管理权限，可以设置当前节点的 permission</td>
</tr>
</tbody>
</table>
</div>
<div class="table-container">
<table>
<thead>
<tr>
<th>Scheme</th>
<th>ID</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>world</td>
<td>anyone</td>
<td>ZooKeeper 中对所有人有权限的结点就是属于 <code>world:anyone</code></td>
</tr>
<tr>
<td>auth</td>
<td>不需要 id</td>
<td>通过 authentication 的 user 都有权限</td>
</tr>
<tr>
<td></td>
<td></td>
<td>（ZooKeeper 支持通过 kerberos 来进行 <code>authencation</code>，也支持 <code>username</code>/<code>password</code>形式的 authentication）</td>
</tr>
<tr>
<td>digest</td>
<td>username:BASE64 (SHA1(password))</td>
<td>需要先通过 username:password 形式的 authentication</td>
</tr>
<tr>
<td>ip</td>
<td>id 为客户机的 IP 地址（或者 IP 地址段）</td>
<td>ip:192.168.1.0/14，表示匹配前 14 个 bit 的 IP 段</td>
</tr>
<tr>
<td>super</td>
<td></td>
<td>对应的 id 拥有超级权限（CRWDA）</td>
</tr>
</tbody>
</table>
</div>
<h4 id="IP"><a href="#IP" class="headerlink" title="IP"></a>IP</h4><h5 id="编码"><a href="#编码" class="headerlink" title="编码"></a>编码</h5><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Before</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">  zoo = <span class="keyword">new</span> ZooKeeper(HOST.concat(<span class="string">":"</span> + CLIENT_PORT), TIME_OUT_MILLISECOND, <span class="keyword">null</span>);</span><br><span class="line">  acls = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  acls.add(<span class="keyword">new</span> ACL(ZooDefs.Perms.ALL, <span class="keyword">new</span> Id(IP, <span class="string">"10.24.40.178"</span>)));</span><br><span class="line">  acls.add(<span class="keyword">new</span> ACL(ZooDefs.Perms.ALL, <span class="keyword">new</span> Id(IP, <span class="string">"127.0.0.1"</span>)));</span><br><span class="line">  aclsNoAuth = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  aclsNoAuth.add(<span class="keyword">new</span> ACL(ZooDefs.Perms.ALL, <span class="keyword">new</span> Id(IP, <span class="string">"127.0.0.1"</span>)));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ipAcl</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">  <span class="keyword">if</span> (zoo.exists(IP_PATH, <span class="keyword">null</span>) != <span class="keyword">null</span>) zoo.delete(IP_PATH, -<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> (zoo.exists(IP_PATH_NO_AUTH, <span class="keyword">null</span>) != <span class="keyword">null</span>) zoo.delete(IP_PATH_NO_AUTH, -<span class="number">1</span>);</span><br><span class="line">  zoo.create(IP_PATH, IP.getBytes(), acls, CreateMode.PERSISTENT);</span><br><span class="line">  assertEquals(IP, <span class="keyword">new</span> String(zoo.getData(IP_PATH, <span class="keyword">false</span>, <span class="keyword">null</span>)));</span><br><span class="line">  zoo.create(IP_PATH_NO_AUTH, IP.getBytes(), aclsNoAuth, CreateMode.PERSISTENT);</span><br><span class="line">  <span class="keyword">try</span> {</span><br><span class="line">    zoo.getData(IP_PATH_NO_AUTH, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">  } <span class="keyword">catch</span> (KeeperException.NoAuthException e) {</span><br><span class="line">    assertEquals(<span class="string">"KeeperErrorCode = NoAuth for "</span>.concat(IP_PATH_NO_AUTH), e.getMessage());</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>Tips: Full code is <a href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-bigdata/yuzhouwan-bigdata-zookeeper/src/test/java/com/yuzhouwan/bigdata/zookeeper/auth/AuthIPExample.java">here</a>.</p>
<h5 id="命令行"><a href="#命令行" class="headerlink" title="命令行"></a>命令行</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ zkCli.sh -server localhost:2181</span><br><span class="line">  [zk: localhost:2181(CONNECTED) 16] ls /</span><br><span class="line">    [leader, election, zookeeper, origin, ip, auth_test, benchmark]</span><br><span class="line"></span><br><span class="line">  [zk: localhost:2181(CONNECTED) 17] ls /ip</span><br><span class="line">    Authentication is not valid : /ip</span><br><span class="line"></span><br><span class="line">  [zk: localhost:2181(CONNECTED) 18] getAcl /ip</span><br><span class="line">    <span class="string">'ip,'</span>10.24.40.178</span><br><span class="line">    : cdrwa</span><br><span class="line">    <span class="string">'ip,'</span>127.0.0.1</span><br><span class="line">    : cdrwa</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ zkCli.sh -server 127.0.0.1:2181</span><br><span class="line">  [zk: 127.0.0.1:2181(CONNECTED) 1] ls /ip</span><br><span class="line">    []</span><br><span class="line"></span><br><span class="line">  [zk: 127.0.0.1:2181(CONNECTED) 2] get /ip</span><br><span class="line">    ip</span><br><span class="line">    cZxid = 0x10000c43b</span><br><span class="line">    ctime = Tue Aug 22 16:50:37 CST 2017</span><br><span class="line">    mZxid = 0x10000c43b</span><br><span class="line">    mtime = Tue Aug 22 16:50:37 CST 2017</span><br><span class="line">    pZxid = 0x10000c43b</span><br><span class="line">    cversion = 0</span><br><span class="line">    dataVersion = 0</span><br><span class="line">    aclVersion = 0</span><br><span class="line">    ephemeralOwner = 0x0</span><br><span class="line">    dataLength = 2</span><br><span class="line">    numChildren = 0</span><br></pre></td></tr></tbody></table></figure>
<h5 id="优缺点"><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h5><p>　简单易用，直接在物理层面，对用户进行权限隔离；但是，如果不将 <code>127.0.0.1</code> 放入到 IP Acl 列表里，会给服务端的运维带来麻烦</p>
<h4 id="Digest"><a href="#Digest" class="headerlink" title="Digest"></a>Digest</h4><h5 id="编码-1"><a href="#编码-1" class="headerlink" title="编码"></a>编码</h5><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Before</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">  zoo = <span class="keyword">new</span> ZooKeeper(HOST.concat(<span class="string">":"</span> + CLIENT_PORT), TIME_OUT_MILLISECOND, <span class="keyword">null</span>);</span><br><span class="line">  zoo.addAuthInfo(<span class="string">"digest"</span>, <span class="string">"yuzhouwan:com"</span>.getBytes());</span><br><span class="line">  zooNoAuth = <span class="keyword">new</span> ZooKeeper(HOST.concat(<span class="string">":"</span> + CLIENT_PORT), TIME_OUT_MILLISECOND, <span class="keyword">null</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">digestAcl</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">  <span class="keyword">if</span> (zoo.exists(AUTH_PATH_CHILD, <span class="keyword">null</span>) != <span class="keyword">null</span>) zoo.delete(AUTH_PATH_CHILD, -<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> (zoo.exists(AUTH_PATH, <span class="keyword">null</span>) != <span class="keyword">null</span>) zoo.delete(AUTH_PATH, -<span class="number">1</span>);</span><br><span class="line">  zoo.create(AUTH_PATH, bytes, ZooDefs.Ids.CREATOR_ALL_ACL, CreateMode.PERSISTENT);</span><br><span class="line">  <span class="keyword">try</span> {</span><br><span class="line">    zooNoAuth.create(AUTH_PATH_CHILD, bytes, ZooDefs.Ids.CREATOR_ALL_ACL, CreateMode.PERSISTENT);</span><br><span class="line">  } <span class="keyword">catch</span> (KeeperException.InvalidACLException e) {</span><br><span class="line">    assertEquals(<span class="string">"KeeperErrorCode = InvalidACL for /auth_test/child"</span>, e.getMessage());</span><br><span class="line">  }</span><br><span class="line">  zoo.create(AUTH_PATH_CHILD, bytes, ZooDefs.Ids.CREATOR_ALL_ACL, CreateMode.PERSISTENT);</span><br><span class="line">  <span class="keyword">try</span> {</span><br><span class="line">    zooNoAuth.delete(AUTH_PATH_CHILD, -<span class="number">1</span>);</span><br><span class="line">  } <span class="keyword">catch</span> (KeeperException.NoAuthException e) {</span><br><span class="line">    assertEquals(<span class="string">"KeeperErrorCode = NoAuth for /auth_test/child"</span>, e.getMessage());</span><br><span class="line">  }</span><br><span class="line">  assertEquals(AUTH_PATH, <span class="keyword">new</span> String(zoo.getData(AUTH_PATH, <span class="keyword">false</span>, <span class="keyword">null</span>)));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>Tips: Full code is <a href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-bigdata/yuzhouwan-bigdata-zookeeper/src/test/java/com/yuzhouwan/bigdata/zookeeper/auth/AuthDigestExample.java">here</a>.</p>
<h5 id="命令行-1"><a href="#命令行-1" class="headerlink" title="命令行"></a>命令行</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ zkCli.sh -server localhost:2181</span><br><span class="line">  [zk: localhost:2181(CONNECTED) 5] ls /</span><br><span class="line">    [leader, auth_test, election, zookeeper, benchmark, origin]</span><br><span class="line"></span><br><span class="line">  [zk: localhost:2181(CONNECTED) 6] ls /auth_test</span><br><span class="line">    Authentication is not valid : /auth_test</span><br><span class="line"></span><br><span class="line">  [zk: localhost:2181(CONNECTED) 7] get /auth_test</span><br><span class="line">    Authentication is not valid : /auth_test</span><br><span class="line"></span><br><span class="line">  [zk: localhost:2181(CONNECTED) 8] getAcl /auth_test</span><br><span class="line">    <span class="string">'digest,'</span>yuzhouwan:h/j+/wDlblTtA48jnbq8snP1glA=</span><br><span class="line">    : cdrwa</span><br><span class="line"></span><br><span class="line">  [zk: localhost:2181(CONNECTED) 9] addauth digest yuzhouwan:<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  [zk: localhost:2181(CONNECTED) 10] get /auth_test</span><br><span class="line">    /auth_test</span><br><span class="line">    cZxid = 0x10000c31e</span><br><span class="line">    ctime = Tue Aug 22 15:26:27 CST 2017</span><br><span class="line">    mZxid = 0x10000c31e</span><br><span class="line">    mtime = Tue Aug 22 15:26:27 CST 2017</span><br><span class="line">    pZxid = 0x10000c31e</span><br><span class="line">    cversion = 0</span><br><span class="line">    dataVersion = 0</span><br><span class="line">    aclVersion = 0</span><br><span class="line">    ephemeralOwner = 0x0</span><br><span class="line">    dataLength = 10</span><br><span class="line">    numChildren = 0</span><br></pre></td></tr></tbody></table></figure>
<h5 id="优缺点-1"><a href="#优缺点-1" class="headerlink" title="优缺点"></a>优缺点</h5><p>　可以建立角色，按照用户名、密码进行权限控制；但是，想要修改某个用户的密码，需要对所有的 ACLs 做更改</p>
<h4 id="SASL-amp-Kerberos"><a href="#SASL-amp-Kerberos" class="headerlink" title="SASL &amp; Kerberos"></a>SASL &amp; Kerberos</h4><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><h3 id="单机版"><a href="#单机版" class="headerlink" title="单机版"></a>单机版</h3><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/install/</span><br><span class="line">$ wget http://archive.apache.org/dist/zookeeper/zookeeper-3.4.10/zookeeper-3.4.10.tar.gz</span><br><span class="line">$ wget http://archive.apache.org/dist/zookeeper/zookeeper-3.4.10/zookeeper-3.4.10.tar.gz.md5</span><br><span class="line"></span><br><span class="line"><span class="comment"># 校验 MD5</span></span><br><span class="line">$ head -n 1 zookeeper-3.4.10.tar.gz.md5</span><br><span class="line">  e4cf1b1593ca870bf1c7a75188f09678  zookeeper-3.4.10.tar.gz</span><br><span class="line">$ md5sum zookeeper-3.4.10.tar.gz</span><br><span class="line">  e4cf1b1593ca870bf1c7a75188f09678 *zookeeper-3.4.10.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对比 MD5 码一致后进行解压安装</span></span><br><span class="line">$ tar zxvf zookeeper-3.4.10.tar.gz -C ~/software/</span><br><span class="line">$ <span class="built_in">cd</span> ~/software</span><br><span class="line">$ ln -s zookeeper-3.4.10 zookeeper</span><br></pre></td></tr></tbody></table></figure>
<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> zookeeper</span><br><span class="line">$ mkdir tmp</span><br><span class="line">$ cp conf/zoo_sample.cfg conf/zoo.cfg</span><br><span class="line">$ mkdir -p /home/zookeeper/data/zookeeper</span><br><span class="line">$ mkdir -p /home/zookeeper/logs/zookeeper</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更多配置，详见下文 “常用配置” 部分</span></span><br><span class="line">$ vim conf/zoo.cfg</span><br><span class="line">  tickTime=2000</span><br><span class="line">  initLimit=10</span><br><span class="line">  syncLimit=5</span><br><span class="line">  dataDir=/home/zookeeper/data/zookeeper</span><br><span class="line">  dataLogDir=/home/zookeeper/logs/zookeeper</span><br><span class="line">  clientPort=2181</span><br></pre></td></tr></tbody></table></figure>
<h4 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ bin/zkServer.sh start</span><br><span class="line">$ bin/zkServer.sh status</span><br><span class="line">  ZooKeeper JMX enabled by default</span><br><span class="line">  Using config: /home/zookeeper/software/zookeeper/bin/../conf/zoo.cfg</span><br><span class="line">  Mode: standalone</span><br><span class="line">$ bin/zkCli.sh</span><br></pre></td></tr></tbody></table></figure>
<h3 id="容器版"><a href="#容器版" class="headerlink" title="容器版"></a>容器版</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ docker run --restart always -p 2181:2181 -p 2888:2888 -p 3888:3888 -p 8080:8080 -d zookeeper</span><br></pre></td></tr></tbody></table></figure>
<h3 id="集群版"><a href="#集群版" class="headerlink" title="集群版"></a>集群版</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 更多配置，详见下文 “常用配置” 部分</span></span><br><span class="line">$ vim conf/zoo.cfg</span><br><span class="line">  tickTime=2000</span><br><span class="line">  initLimit=10</span><br><span class="line">  syncLimit=5</span><br><span class="line">  dataDir=/home/zookeeper/data/zookeeper</span><br><span class="line">  dataLogDir=/home/zookeeper/logs/zookeeper</span><br><span class="line">  clientPort=2181</span><br><span class="line">  server.1=yuzhouwan01:2281:2282</span><br><span class="line">  server.2=yuzhouwan02:2281:2282</span><br><span class="line">  server.3=yuzhouwan03:2281:2282</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在各个节点的 dataDir下创建 myid 文件，并对应 zoo.cfg中配置的 id</span></span><br><span class="line">[zookeeper@yuzhouwan01 ~] <span class="built_in">echo</span> <span class="string">"1"</span> &gt; /home/zookeeper/data/zookeeper/myid</span><br><span class="line">[zookeeper@yuzhouwan02 ~] <span class="built_in">echo</span> <span class="string">"2"</span> &gt; /home/zookeeper/data/zookeeper/myid</span><br><span class="line">[zookeeper@yuzhouwan03 ~] <span class="built_in">echo</span> <span class="string">"3"</span> &gt; /home/zookeeper/data/zookeeper/myid</span><br></pre></td></tr></tbody></table></figure>
<h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><h3 id="四字命令"><a href="#四字命令" class="headerlink" title="四字命令"></a>四字命令</h3><div class="table-container">
<table>
<thead>
<tr>
<th>Command</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>conf</td>
<td>输出相关<strong>服务配置</strong>的详细信息</td>
</tr>
<tr>
<td>cons</td>
<td>列出所有连接到服务器的客户端的完全的<code>连接</code> / <code>会话</code>的详细信息(包括“接受 / 发送”的包数量、会话 id 、操作延迟、最后的操作执行等等信息)</td>
</tr>
<tr>
<td>envi</td>
<td>输出关于<strong>服务环境</strong>的详细信息 (区别于 conf 命令)</td>
</tr>
<tr>
<td>dump</td>
<td>列出未经处理的会话和临时节点</td>
</tr>
<tr>
<td>stat</td>
<td>查看哪个节点被选择作为 Follower 或者 Leader</td>
</tr>
<tr>
<td>ruok</td>
<td>测试是否启动了该 Server，若回复 <code>imok</code> 表示已经启动</td>
</tr>
<tr>
<td>mntr</td>
<td>输出一些运行时信息（latency / packets / alive_connections / outstanding_requests / server_state / znode + watch + ephemerals  count …）</td>
</tr>
<tr>
<td>reqs</td>
<td>列出未经处理的请求</td>
</tr>
<tr>
<td>wchs</td>
<td>列出服务器 watch 的简要信息</td>
</tr>
<tr>
<td><strong>wchc</strong></td>
<td>通过 session 列出服务器 watch 的详细信息（输出是一个与 watch 相关的会话的列表）</td>
</tr>
<tr>
<td><strong>wchp</strong></td>
<td>通过路径列出服务器 watch 的详细信息（输出一个与 session 相关的路径）</td>
</tr>
<tr>
<td>srvr</td>
<td>输出服务的所有信息（可以用来检查当前节点同步完毕集群数据，处于 Follower 状态）</td>
</tr>
<tr>
<td>srst</td>
<td>重置服务器统计信息</td>
</tr>
<tr>
<td>kill</td>
<td>关掉 Server</td>
</tr>
</tbody>
</table>
</div>
<div class="note danger">部分加粗命令对资源消耗比较大，生产环境慎用!</div>



<h4 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h4><h5 id="安装-Netcat"><a href="#安装-Netcat" class="headerlink" title="安装 Netcat"></a>安装 Netcat</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># online</span></span><br><span class="line">$ yum install nc</span><br><span class="line"></span><br><span class="line"><span class="comment"># offline</span></span><br><span class="line">$ uname -a</span><br><span class="line">  Linux yuzhouwan 2.6.32-279.el6_sn.7.x86_64 <span class="comment">#1 SMP Fri May 27 18:04:25 CST 2016 x86_64 x86_64 x86_64 GNU/Linux</span></span><br><span class="line"><span class="comment"># 搜索rpm包 https://rpmfind.net/linux/rpm2html/search.php?query=nc&amp;submit=Search+...&amp;system=&amp;arch=x86_64</span></span><br><span class="line">$ wget ftp://rpmfind.net/linux/centos/6.9/os/x86_64/Packages/nc-1.84-24.el6.x86_64.rpm</span><br><span class="line">$ rpm -ivh nc-1.84-24.el6.x86_64.rpm</span><br></pre></td></tr></tbody></table></figure>
<h5 id="Netcat-执行"><a href="#Netcat-执行" class="headerlink" title="Netcat 执行"></a>Netcat 执行</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> &lt;four-letter <span class="built_in">command</span>&gt; | nc 127.0.0.1 2181</span><br></pre></td></tr></tbody></table></figure>
<h4 id="DOS-攻击"><a href="#DOS-攻击" class="headerlink" title="DOS 攻击"></a><a href="https://en.wikipedia.org/wiki/Denial-of-service_attack">DOS</a> <a href="https://issues.apache.org/jira/browse/ZOOKEEPER-2693">攻击</a></h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 避免 wchp / wchc 四字命令被 DOS 攻击利用</span></span><br><span class="line">$ vim zoo.cfg</span><br><span class="line">  <span class="comment"># 4lw.commands.whitelist=*</span></span><br><span class="line">  4lw.commands.whitelist=<span class="built_in">stat</span>, ruok, conf, isro</span><br></pre></td></tr></tbody></table></figure>
<h4 id="产生的日志"><a href="#产生的日志" class="headerlink" title="产生的日志"></a>产生的日志</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 可以看到 zk.out 文件中出现 0:0:0:0:0:0:0:1（IPv6 的回送地址，相当于 IPv4 的 127.0.0.1）和 Processing xxxx command 相应的日志</span></span><br><span class="line">2017-06-13 23:05:01,998 [myid:5] - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxnFactory@197] - Accepted socket connection from /0:0:0:0:0:0:0:1:40986</span><br><span class="line">2017-06-13 23:05:01,998 [myid:5] - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@827] - Processing srvr <span class="built_in">command</span> from /0:0:0:0:0:0:0:1:40986</span><br><span class="line">2017-06-13 23:05:02,000 [myid:5] - INFO  [Thread-64778:NIOServerCnxn@1007] - Closed socket connection <span class="keyword">for</span> client /0:0:0:0:0:0:0:1:40986 (no session established <span class="keyword">for</span> client)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="执行脚本"><a href="#执行脚本" class="headerlink" title="执行脚本"></a>执行脚本</h3><h4 id="zkServer"><a href="#zkServer" class="headerlink" title="zkServer"></a>zkServer</h4><h5 id="启动-1"><a href="#启动-1" class="headerlink" title="启动"></a>启动</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 启动</span></span><br><span class="line">$ bin/zkServer.sh start</span><br><span class="line"><span class="comment"># 查看状态</span></span><br><span class="line">$ bin/zkServer.sh status</span><br><span class="line"><span class="comment"># 停止服务</span></span><br><span class="line">$ bin/zkServer.sh stop</span><br><span class="line"><span class="comment"># 重启</span></span><br><span class="line">$ bin/zkServer.sh restart</span><br></pre></td></tr></tbody></table></figure>
<h5 id="排查问题"><a href="#排查问题" class="headerlink" title="排查问题"></a>排查问题</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 可以通过增加 `start-foreground` 参数来排查失败原因</span></span><br><span class="line">$ bin/zkServer.sh start-foreground</span><br><span class="line">  ZooKeeper JMX enabled by default</span><br><span class="line">  Using config: /home/eagle/software/zookeeper/bin/../conf/zoo.cfg</span><br><span class="line">  Error: Could not find or load main class org.apache.zookeeper.server.quorum.QuorumPeerMain</span><br><span class="line"><span class="comment"># /home/eagle/software/zookeeper/zookeeper-3.4.10.jar 的问题，重新下载，校验 md5 正确后，再次安装即可</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="zkCli"><a href="#zkCli" class="headerlink" title="zkCli"></a>zkCli</h4><h5 id="启动-2"><a href="#启动-2" class="headerlink" title="启动"></a>启动</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> <span class="variable">$ZOOKEEPER_HOME</span></span><br><span class="line">$ bin/zkCli -server &lt;zk host&gt;:2181,&lt;zk host&gt;:2181,&lt;zk host&gt;:2181</span><br></pre></td></tr></tbody></table></figure>
<h5 id="节点操作"><a href="#节点操作" class="headerlink" title="节点操作"></a>节点操作</h5><div class="table-container">
<table>
<thead>
<tr>
<th>Command</th>
<th>Example</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>create</td>
<td></td>
<td>创建一个节点</td>
</tr>
<tr>
<td>ls</td>
<td></td>
<td>查看当前节点数据</td>
</tr>
<tr>
<td>set</td>
<td></td>
<td>修改节点</td>
</tr>
<tr>
<td>get</td>
<td></td>
<td>得到一个节点，包含<code>数据</code>和<code>更新次数</code>等信息</td>
</tr>
<tr>
<td>delete</td>
<td></td>
<td>删除一个节点</td>
</tr>
<tr>
<td>deleteall</td>
<td></td>
<td>递归删除</td>
</tr>
<tr>
<td>history</td>
<td></td>
<td>列出最近的历史命令</td>
</tr>
<tr>
<td>redo <code>&lt;command number: n&gt;</code></td>
<td>redo 1</td>
<td>重做第 n 步命令</td>
</tr>
<tr>
<td>stat</td>
<td></td>
<td>打印节点状态</td>
</tr>
<tr>
<td>close</td>
<td></td>
<td>关闭当前连接</td>
</tr>
<tr>
<td>connect <code>&lt;host&gt;:&lt;port&gt;</code></td>
<td>connect localhost:2181</td>
<td>当 close 当前连接或者意外退出后，可在 <code>zkCli</code> 命令模式中重连</td>
</tr>
<tr>
<td>quit</td>
<td></td>
<td>退出当前连接</td>
</tr>
<tr>
<td>setAcl <code>&lt;path&gt; &lt;acl: scheme + id + permissions&gt;</code></td>
<td>setAcl /zk world:anyone:cdrw</td>
<td>设置节点权限策略（详见上文 “基本概念 - ACL” 部分）</td>
</tr>
<tr>
<td>getAcl <code>&lt;path&gt;</code></td>
<td></td>
<td>获取节点权限策略</td>
</tr>
<tr>
<td>addauth <code>&lt;scheme&gt; &lt;auth&gt;</code></td>
<td>addauth digest username:password</td>
<td>节点权限认证</td>
</tr>
<tr>
<td>setquota -n</td>
<td>-b val <code>&lt;path&gt;</code></td>
<td></td>
</tr>
<tr>
<td>listquota <code>&lt;path&gt;</code></td>
<td>listquota /zookeeper</td>
<td>查看节点的配额</td>
</tr>
<tr>
<td></td>
<td>count=5, bytes=-1</td>
<td>/zookeeper 节点个数限额为 5，长度无限额</td>
</tr>
<tr>
<td>delquota <code>[-n or -b]</code> <code>&lt;path&gt;</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td>sync <code>&lt;path&gt;</code></td>
<td></td>
<td>强制同步</td>
</tr>
<tr>
<td></td>
<td></td>
<td>（由于“过半原则”，导致某些 ZooKeeper Server 上的数据是旧的，用 <code>sync</code> 命令可强制同步所有的更新操作）</td>
</tr>
<tr>
<td>printwatches on</td>
<td>off</td>
</tr>
</tbody>
</table>
</div>
<div class="note info">在 3.6.0 版本中，Apache ZooKeeper 通过增加批量删除特性改进了 deleteall 命令的性能，并彻底删除了过期的 rmr 命令</div>

<h5 id="常见组合（for-Kafka）"><a href="#常见组合（for-Kafka）" class="headerlink" title="常见组合（for Kafka）"></a>常见组合（for Kafka）</h5><div class="table-container">
<table>
<thead>
<tr>
<th>Command</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>get /consumers/<code>&lt;topic&gt;</code>/owners</td>
<td>查看 Topic 实时消费的 Group ID</td>
</tr>
<tr>
<td>get /consumers/<code>&lt;topic&gt;</code>/offsets/<code>&lt;group id&gt;</code>/<code>&lt;partitionor&gt;</code></td>
<td>查看 Offset 情况（ctime：创建时间；mtime：修改时间）</td>
</tr>
</tbody>
</table>
</div>
<h2 id="常用配置"><a href="#常用配置" class="headerlink" title="常用配置"></a><a href="http://zookeeper.apache.org/doc/current/zookeeperAdmin.html">常用配置</a></h2><h3 id="dataDir"><a href="#dataDir" class="headerlink" title="dataDir"></a>dataDir</h3><p>　ZooKeeper 保存服务器存储快照文件的目录，默认情况，ZooKeeper 将 <code>写数据的日志文件</code>也保存在这个目录里（default：/tmp/zookeeper）</p>
<h3 id="dataLogDir"><a href="#dataLogDir" class="headerlink" title="dataLogDir"></a>dataLogDir</h3><p>　用来存储服务器事务日志</p>
<h3 id="clientPort"><a href="#clientPort" class="headerlink" title="clientPort"></a>clientPort</h3><p>　客户端连接 ZooKeeper 服务器的端口，ZooKeeper 会监听这个端口，接受客户端的访问请求（default：2181）</p>
<h3 id="tickTime（SS-CS）"><a href="#tickTime（SS-CS）" class="headerlink" title="tickTime（SS / CS）"></a>tickTime（SS / CS）</h3><p>　用来指示 <code>服务器</code>之间或<code>客户端</code>与<code>服务器</code>之间维护<code>心跳</code>机制的 最小时间单元，<code>Session</code> 最小过期时间默认为两倍的 tickTime（default：<code>2000</code>ms）</p>
<h3 id="initLimit（LF）"><a href="#initLimit（LF）" class="headerlink" title="initLimit（LF）"></a>initLimit（LF）</h3><p>　集群中的 <code>Leader</code> 节点和 <code>Follower</code> 节点之间<code>初始连接</code>时能容忍的最多心跳数（default：5 tickTime）</p>
<h3 id="syncLimit（LF）"><a href="#syncLimit（LF）" class="headerlink" title="syncLimit（LF）"></a>syncLimit（LF）</h3><p>　集群中的 <code>Leader</code> 节点和 <code>Follower</code> 节点之间<code>请求和应答</code>时能容忍的最多心跳数（default：2 tickTime）</p>
<h3 id="minSessionTimeout-amp-maxSessionTimeout"><a href="#minSessionTimeout-amp-maxSessionTimeout" class="headerlink" title="minSessionTimeout &amp; maxSessionTimeout"></a>minSessionTimeout &amp; maxSessionTimeout</h3><p>　默认分别是 2 * tickTime ~ 20 * tickTime，来用控制 客户端设置的 Session 超时时间。如果超出或者小于，将自动被服务端强制设置为 最大或者最小</p>
<h3 id="maxClientCnxns"><a href="#maxClientCnxns" class="headerlink" title="maxClientCnxns"></a>maxClientCnxns</h3><p>　控制单个客户端（以 IP 地址为唯一标识）创建连接数的上限（default：60），设置为 0 则不作限制</p>
<h3 id="集群节点"><a href="#集群节点" class="headerlink" title="集群节点"></a>集群节点</h3><p>　配置 ZooKeeper 集群中的服务器节点<br>　　格式：<code>server.&lt;myid&gt;</code>=<code>&lt;服务器地址&gt;</code>:<code>&lt;LF通讯端口&gt;</code>:<code>&lt;选举端口&gt;</code><br>　　样例：<code>server.1=yuzhouwan:2888:3888</code></p>
<h3 id="动态配置"><a href="#动态配置" class="headerlink" title="动态配置"></a><a href="http://zookeeper.apache.org/doc/r3.5.4-beta/zookeeperReconfig.html">动态配置</a></h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim zoo_replicated1.cfg</span><br><span class="line">  tickTime=2000</span><br><span class="line">  dataDir=/zookeeper/data/zookeeper1</span><br><span class="line">  initLimit=5</span><br><span class="line">  syncLimit=2</span><br><span class="line">  dynamicConfigFile=/zookeeper/conf/zoo_replicated1.cfg.dynamic</span><br><span class="line"></span><br><span class="line">$ vim zoo_replicated1.cfg.dynamic</span><br><span class="line">  server.1=125.23.63.23:2780:2783:participant;2791</span><br><span class="line">  server.2=125.23.63.24:2781:2784:participant;2792</span><br><span class="line">  server.3=125.23.63.25:2782:2785:participant;2793</span><br></pre></td></tr></tbody></table></figure>
<h2 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h2><h3 id="采集方式"><a href="#采集方式" class="headerlink" title="采集方式"></a>采集方式</h3><h4 id="JMX"><a href="#JMX" class="headerlink" title="JMX"></a>JMX</h4><h5 id="远程连接"><a href="#远程连接" class="headerlink" title="远程连接"></a>远程连接</h5><p>　ZooKeeper 默认支持 JMX 连接，但是只支持本地连接<br></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 开启远程 JMX</span></span><br><span class="line">$ vim bin/zkServer.sh</span><br><span class="line">  <span class="comment"># ZOOMAIN="-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.local.only=$JMXLOCALONLY org.apache.zookeeper.server.quorum.QuorumPeerMain"</span></span><br><span class="line">  ZOOMAIN=<span class="string">"-Dcom.sun.management.jmxremote.port=8888 -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.authenticate=false org.apache.zookeeper.server.quorum.QuorumPeerMain"</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<h4 id="Four-letter-command"><a href="#Four-letter-command" class="headerlink" title="Four-letter command"></a>Four-letter command</h4><h4 id="TCP-Dump"><a href="#TCP-Dump" class="headerlink" title="TCP Dump"></a>TCP Dump</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 使用 tcpdump 命令，需要在 root 权限下执行</span></span><br><span class="line">$ sudo tcpdump tcp port 2181 and host ! 127.0.0.1</span><br><span class="line">  <span class="comment"># 下面抓包到的信息，是 Curator 远程连接，并在 /children 命名空间下，创建临时节点 /yuzhouwan，最终断开 TCP 连接的过程</span></span><br><span class="line">  14:50:16.192736 IP 10.10.10.10.56342 &gt; yuzhouwan01.eforward: Flags [S], seq 818611125, win 8192, options [mss 1460,nop,wscale 8,nop,nop,sackOK], length 0</span><br><span class="line">  14:50:16.192765 IP yuzhouwan01.eforward &gt; 10.10.10.10.56342: Flags [S.], seq 3867146147, ack 818611126, win 14600, options [mss 1460,nop,nop,sackOK,nop,wscale 7], length 0</span><br><span class="line">  14:50:16.193502 IP 10.10.10.10.56342 &gt; yuzhouwan01.eforward: Flags [.], ack 1, win 256, length 0</span><br><span class="line">  14:50:16.196755 IP 10.10.10.10.56342 &gt; yuzhouwan01.eforward: Flags [P.], seq 1:50, ack 1, win 256, length 49</span><br><span class="line">  14:50:16.196768 IP yuzhouwan01.eforward &gt; 10.10.10.10.56342: Flags [.], ack 50, win 115, length 0</span><br><span class="line">  14:50:16.198618 IP yuzhouwan01.eforward &gt; 10.10.10.10.56342: Flags [P.], seq 1:42, ack 50, win 115, length 41</span><br><span class="line">  14:50:16.214597 IP 10.10.10.10.56342 &gt; yuzhouwan01.eforward: Flags [P.], seq 50:76, ack 42, win 256, length 26</span><br><span class="line">  14:50:16.215109 IP yuzhouwan01.eforward &gt; 10.10.10.10.56342: Flags [P.], seq 42:62, ack 76, win 115, length 20</span><br></pre></td></tr></tbody></table></figure>
<p>Tips: 比较关心的一个问题是，<code>tcpdump</code> 是否会对性能造成影响？答案是：会的。当过滤上千的 IP 时，已经会影响到服务器性能。主要瓶颈在 <code>BPF Filter</code>，这是一个 $O(n)$ 线性时间复杂度的算法，可以考虑 <code>HiPAC 多维树匹配</code> 替代</p>
<h3 id="指标"><a href="#指标" class="headerlink" title="指标"></a>指标</h3><h4 id="ZooKeeper-运行状态（mntr）"><a href="#ZooKeeper-运行状态（mntr）" class="headerlink" title="ZooKeeper 运行状态（mntr）"></a>ZooKeeper 运行状态（mntr）</h4><div class="table-container">
<table>
<thead>
<tr>
<th>Metrics</th>
<th>Comment</th>
<th>Threshold</th>
</tr>
</thead>
<tbody>
<tr>
<td>zk_version</td>
<td>版本</td>
<td></td>
</tr>
<tr>
<td>zk_avg_latency</td>
<td>平均 响应延迟</td>
<td>&gt; 50ms，比上次统计增长超过 20ms，且上一次延迟不为 0</td>
</tr>
<tr>
<td>zk_max_latency</td>
<td>最大 响应延迟</td>
<td></td>
</tr>
<tr>
<td>zk_min_latency</td>
<td>最小 响应延迟</td>
<td></td>
</tr>
<tr>
<td>zk_packets_received</td>
<td>收包数</td>
<td></td>
</tr>
<tr>
<td>zk_packets_sent</td>
<td>发包数</td>
<td></td>
</tr>
<tr>
<td>zk_num_alive_connections</td>
<td>活跃连接数</td>
<td>&gt; 3000</td>
</tr>
<tr>
<td>zk_outstanding_requests</td>
<td>堆积请求数</td>
<td>连续两次大于 5（粒度：1min）</td>
</tr>
<tr>
<td>zk_server_state</td>
<td>主从状态</td>
<td>由 Leader 变为 Follower 或 由 Follower 变为 Leader</td>
</tr>
<tr>
<td>zk_znode_count</td>
<td>znode 数</td>
<td>&gt; 40000</td>
</tr>
<tr>
<td>zk_watch_count</td>
<td>watch 数</td>
<td>&gt; 50000</td>
</tr>
<tr>
<td>zk_ephemerals_count</td>
<td>临时节点数</td>
<td></td>
</tr>
<tr>
<td>zk_approximate_data_size</td>
<td>近似数据总和大小</td>
<td></td>
</tr>
<tr>
<td>zk_open_file_descriptor_count</td>
<td>打开 <code>文件描述符</code> 数</td>
<td></td>
</tr>
<tr>
<td>zk_max_file_descriptor_count</td>
<td>最大 <code>文件描述符</code> 数</td>
<td></td>
</tr>
<tr>
<td><strong>zk_followers</strong></td>
<td>Follower 数</td>
<td></td>
</tr>
<tr>
<td><strong>zk_synced_followers</strong></td>
<td>已同步的 Follower 数</td>
<td>连续两次检测到未同步的 Follower 节点 (粒度：1min)</td>
</tr>
<tr>
<td><strong>zk_pending_syncs</strong></td>
<td>阻塞中的 sync 操作</td>
</tr>
</tbody>
</table>
</div>
<div class="note info">加粗指标，只有 Leader 节点才会有</div>






<h3 id="实时预警"><a href="#实时预警" class="headerlink" title="实时预警"></a>实时预警</h3><h4 id="numenta-nupic"><a href="#numenta-nupic" class="headerlink" title="numenta / nupic"></a><a href="https://github.com/numenta">numenta</a> / <strong><a href="https://github.com/numenta/nupic">nupic</a></strong></h4><p>　NuPIC<code>（Numenta Platform for Intelligent Computing，Numenta智能计算平台）</code> 是一个与众不同的开源人工智能平台，它基于一种<code>脑皮质学习算法</code>，即 “层级实时记忆”（<strong>H</strong>ierarchical <strong>T</strong>emporal <strong>M</strong>emory，<a href="https://numenta.com/assets/pdf/whitepapers/hierarchical-temporal-memory-cortical-learning-algorithm-0.2.1-en.pdf">HTM</a>）。该算法旨在模拟新大脑皮层的工作原理，将复杂的问题转化为模式匹配与预测，而传统的 AI 算法大多是针对特定的任务目标而设计的<br>　NuPIC 聚焦于分析实时数据流，可以通过学习数据之间基于时间的状态变化（而非阀值设置），对未知数据进行预测，并揭示其中的非常规特性。详见我的另一篇博客：<a href="https://yuzhouwan.com/posts/42737/#开源项目">人工智能</a></p>
<h2 id="性能调优"><a href="#性能调优" class="headerlink" title="性能调优"></a>性能调优</h2><h3 id="Benchmark"><a href="#Benchmark" class="headerlink" title="Benchmark"></a>Benchmark</h3><p>　<a href="https://github.com/brownsys">brownsys</a> / <a href="https://github.com/brownsys/zookeeper-benchmark">zookeeper-benchmark</a> （很难找到合适的开源项目，需自己编写 Benchmark 工具）</p>
<h3 id="优化策略"><a href="#优化策略" class="headerlink" title="优化策略"></a>优化策略</h3><h4 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h4><h5 id="日志目录"><a href="#日志目录" class="headerlink" title="日志目录"></a>日志目录</h5><ul>
<li>快照目录 dataDir 和 事务日志目录 dataLogDir 分离</li>
<li>写事务日志的目录，需要保证目录空间足够大，并挂载到单独的磁盘上（为了保证<code>数据的一致性</code>，ZooKeeper 在返回客户端事务请求响应之前，必须要将此次请求对应的<code>事务日志</code>刷入到磁盘中 [forceSync 参数控制，default：yes]，所以事务日志的写入速度，直接决定了 ZooKeeper 的吞吐率）</li>
</ul>
<h5 id="自动日志清理"><a href="#自动日志清理" class="headerlink" title="自动日志清理"></a>自动日志清理</h5><h6 id="autopurge-purgeInterval"><a href="#autopurge-purgeInterval" class="headerlink" title="autopurge.purgeInterval"></a>autopurge.purgeInterval</h6><p>　指定清理频率，单位为小时（default：0 表示不开启自动清理）</p>
<h6 id="autopurge-snapRetainCount"><a href="#autopurge-snapRetainCount" class="headerlink" title="autopurge.snapRetainCount"></a>autopurge.snapRetainCount</h6><p>　和上面 <code>purgeInterval</code> 参数配合使用，指定需要保留的文件数目（default：3）</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim conf/zoo.cfg</span><br><span class="line">  autopurge.snapRetainCount=3</span><br><span class="line">  autopurge.purgeInterval=1</span><br><span class="line"><span class="comment"># 注意：ZooKeeper 重启会自动清除 zookeeper.out 日志，如果有排错需要，则应先备份好日志文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果发现单事务日志量过大，导致定时清理无法及时处理，可以使用 zkCleanup.sh 进行手动清除</span></span><br><span class="line">$ <span class="built_in">cd</span> ~/software/zookeeper1</span><br><span class="line">$ zookeeper1/bin/zkCleanup.sh /home/zookeeper/logs/zookeeper1/version-2/ 3</span><br><span class="line">  Removing file: Aug 9, 2017 12:08:49 PM    /home/zookeeper/logs/zookeeper1/version-2/log.1c00000001</span><br><span class="line">  Removing file: Aug 9, 2017 02:03:33 PM    /home/zookeeper/data/zookeeper1/version-2/snapshot.1c0000ab90</span><br></pre></td></tr></tbody></table></figure>
<h5 id="Log4j-滚动日志"><a href="#Log4j-滚动日志" class="headerlink" title="Log4j 滚动日志"></a>Log4j 滚动日志</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> <span class="variable">$ZOOKEEPER_HOME</span></span><br><span class="line">$ vim conf/log4j.properties</span><br><span class="line">  zookeeper.root.logger=INFO, CONSOLE</span><br><span class="line">  zookeeper.console.threshold=INFO</span><br><span class="line">  zookeeper.log.dir=.</span><br><span class="line">  zookeeper.log.file=zookeeper.log</span><br><span class="line">  zookeeper.log.threshold=DEBUG</span><br><span class="line">  zookeeper.tracelog.dir=.</span><br><span class="line">  zookeeper.tracelog.file=zookeeper_trace.log</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 可以调整为 DaliyRollingFileAppender，每天滚动创建新的日志文件</span></span><br><span class="line">  log4j.appender.ROLLINGFILE=org.apache.log4j.RollingFileAppender</span><br><span class="line">  log4j.appender.ROLLINGFILE.Threshold=<span class="variable">${zookeeper.log.threshold}</span></span><br><span class="line">  log4j.appender.ROLLINGFILE.File=<span class="variable">${zookeeper.log.dir}</span>/<span class="variable">${zookeeper.log.file}</span></span><br><span class="line"></span><br><span class="line">$ vim bin/zkServer.sh</span><br><span class="line">  <span class="comment"># 增加 ZOO_LOG_DIR 配置</span></span><br><span class="line">  ZOO_LOG_DIR=<span class="variable">$ZOOBINDIR</span>/../log4j</span><br><span class="line"></span><br><span class="line">$ vim bin/zkEnv.sh</span><br><span class="line">  <span class="comment"># if [ "x${ZOO_LOG4J_PROP}" = "x" ]</span></span><br><span class="line">  <span class="comment"># then</span></span><br><span class="line">  <span class="comment">#     ZOO_LOG4J_PROP="INFO,CONSOLE"</span></span><br><span class="line">  <span class="comment"># fi</span></span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">"x<span class="variable">${ZOO_LOG4J_PROP}</span>"</span> = <span class="string">"x"</span> ]</span><br><span class="line">  <span class="keyword">then</span></span><br><span class="line">      ZOO_LOG4J_PROP=<span class="string">"INFO,ROLLINGFILE"</span></span><br><span class="line">  <span class="keyword">fi</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="Observer-模式"><a href="#Observer-模式" class="headerlink" title="Observer 模式"></a>Observer 模式</h4><h5 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h5><h6 id="对读请求进行扩展"><a href="#对读请求进行扩展" class="headerlink" title="对读请求进行扩展"></a>对读请求进行扩展</h6><p>　通过增加更多的 <code>Observer</code>，可以接收更多的<code>读请求</code>流量，却不会牺牲<code>写操作</code>的吞吐量（写操作的吞吐量取决于 <code>quorum</code> 法定人数的个数）<br>　如果增加更多的 Server 进行投票，Quorum 会变大，这会降低<code>写操作</code>的吞吐量<br>　然而增加 <code>Observer</code> 并不会完全没有损耗，新的 <code>Observer</code> 在提交一个事务后收到一条额外的 <code>INFORM</code> 消息。这个损耗比加入 <code>Follower</code> 进行投票来说会小很多</p>
<p><img data-src="/picture/zk/zk_observer_throughput.png" alt=""></p>
<center>（图片来源：<a href="https://issues.apache.org/jira/browse/ZOOKEEPER-368" target="_blank">Observers: core functionality</a>™）</center>


<h6 id="跨数据中心部署"><a href="#跨数据中心部署" class="headerlink" title="跨数据中心部署"></a>跨数据中心部署</h6><p>　把 <code>participant</code> 分散到多个数据中心，可能会因为数据中心之间的网络延迟，导致系统被拖慢<br>　使用 <code>Observer</code> 的话，更新操作都在单独的数据中心来处理，再发送到其他数据中心，让 <code>Client</code> 消费数据（分布式数据库[中美异地机房]同步系统 <a href="https://github.com/alibaba/otter">Otter</a> 就使用该模式）</p>
<p><img data-src="/picture/zk/zk_ovserver_multi_cyberroom.png" alt=""></p>
<center>（利用 <a href="https://www.axure.com.cn/" target="_blank">Axure</a>™ 绘制而成）</center>

<h5 id="设置"><a href="#设置" class="headerlink" title="设置"></a>设置</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim conf/zoo.cfg</span><br><span class="line">  peerType=observer</span><br><span class="line">  server.1:localhost:2181:3181:observer <span class="comment"># 其他需要扩展成 Observer 的 Server 都需要加上 `:observer` 后缀</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="INFORM-消息"><a href="#INFORM-消息" class="headerlink" title="INFORM 消息"></a>INFORM 消息</h5><p>　因为 Observer 不参与到 ZAB 选举中，所以 Leader 节点不会发送 proposal 给 Observer，只会发送一条包含<code>已经通过选举的 zxid</code> 的 INFORM 消息。这里，参与 ZAB 选举的 Leader、Follower 节点称之为 <code>PARTICIPANT</code> Server，而 Observer 则属于 <code>OBSERVER</code> Server</p>
<h4 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h4><h5 id="JVM-相关"><a href="#JVM-相关" class="headerlink" title="JVM 相关"></a>JVM 相关</h5><h6 id="swappiness"><a href="#swappiness" class="headerlink" title="swappiness"></a>swappiness</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> <span class="variable">$ZOOKEEEPER_HOME</span></span><br><span class="line"><span class="comment"># 常驻进程，需要避免 swapping 损害性能</span></span><br><span class="line"><span class="comment"># 临时生效</span></span><br><span class="line">$ <span class="built_in">echo</span> 0 &gt; /proc/sys/vm/swappiness</span><br><span class="line"><span class="comment"># 永久生效</span></span><br><span class="line">$ vim /etc/sysctl.conf</span><br><span class="line">  vm.swappiness=0 <span class="comment"># memory first</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置 `-XX:+AlwaysPreTouch` 参数，在进程启动的时候，让 jvm 通过 demand-zeroed 方式将内存一次分配到位（ES #16937 / ZK #301）</span></span><br><span class="line"><span class="comment"># 使用 CMS 垃圾回收器（“jdk7 + 内存使用不多” 的缘故，可以暂不考虑 G1GC）</span></span><br><span class="line">$ vim conf/java.env</span><br><span class="line">  <span class="built_in">export</span> JVMFLAGS=<span class="string">"-Xms3G -Xmx3G -Xmn1G -XX:+AlwaysPreTouch -XX:CMSInitiatingOccupancyFraction=70 -XX:+UseParNewGC -XX:+UseConcMarkSweepGC"</span></span><br><span class="line">  <span class="comment"># 如果需要打印 GC 日志，则多增加一些 flag</span></span><br><span class="line">  <span class="built_in">export</span> JVMFLAGS=<span class="string">"-Xms3G -Xmx3G -Xmn1G -XX:+AlwaysPreTouch -XX:CMSInitiatingOccupancyFraction=70 -XX:+UseParNewGC -XX:+UseConcMarkSweepGC -XX:+PrintGCDetails -XX:-PrintGCTimeStamps -Xloggc:/home/zookeeper/logs/zookeeper_`date '+%Y%m%d%H%M%S'`.gc -XX:-UseGCLogFileRotation -XX:NumberOfGCLogFiles=10 -XX:GCLogFileSize=64M"</span></span><br><span class="line">  <span class="comment"># 需要注意的是，如果不希望 zkCli 等命令创建 gc 日志文件，需要把 JVMFLAGS 改成 SERVER_JVMFLAGS</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 更进一步，如果有四字命令在做监控，则建议，直接修改 zkServer.sh，否则因为 zookeeper_`date '+%Y%m%d%H%M%S'`.gc 的存在，导致每次四字命令执行，会有很多小日志被创建（ZK#302 已解决，待分析）</span></span><br><span class="line">$ vim bin/zkServer.sh</span><br><span class="line">  start)</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    START_SERVER_JVMFLAGS=<span class="string">"-Xms3G -Xmx3G -Xmn1G -XX:+AlwaysPreTouch -XX:CMSInitiatingOccupancyFraction=70 -XX:+UseParNewGC -XX:+UseConcMarkSweepGC -XX:+PrintGCDetails -XX:-PrintGCTimeStamps -Xloggc:/home/zookeeper/logs/zookeeper_`date '+%Y%m%d%H%M%S'`.gc -XX:-UseGCLogFileRotation -XX:NumberOfGCLogFiles=10 -XX:GCLogFileSize=64M"</span></span><br><span class="line">    nohup <span class="string">"<span class="variable">$JAVA</span>"</span> <span class="variable">$ZOO_DATADIR_AUTOCREATE</span> <span class="string">"-Dzookeeper.log.dir=<span class="variable">${ZOO_LOG_DIR}</span>"</span> \</span><br><span class="line">    <span class="string">"-Dzookeeper.log.file=<span class="variable">${ZOO_LOG_FILE}</span>"</span> <span class="string">"-Dzookeeper.root.logger=<span class="variable">${ZOO_LOG4J_PROP}</span>"</span> \</span><br><span class="line">    -XX:+HeapDumpOnOutOfMemoryError -XX:OnOutOfMemoryError=<span class="string">'kill -9 %p'</span> \</span><br><span class="line">    -cp <span class="string">"<span class="variable">$CLASSPATH</span>"</span> <span class="variable">$JVMFLAGS</span> <span class="variable">$START_SERVER_JVMFLAGS</span> <span class="variable">$ZOOMAIN</span> <span class="string">"<span class="variable">$ZOOCFG</span>"</span> &gt; <span class="string">"<span class="variable">$_ZOO_DAEMON_OUT</span>"</span> 2&gt;&amp;1 &lt; /dev/null &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 堆大小的最终确定，需要在 benchmark 结果的基础之上，再做调整</span></span><br><span class="line"><span class="comment"># 另外，一旦创建完该文件，ZooKeeper 进程会自动加载，因此，需要确保无误之后，再建立 java.env 文件</span></span><br></pre></td></tr></tbody></table></figure>
<h6 id="升级-JDK8"><a href="#升级-JDK8" class="headerlink" title="升级 JDK8"></a>升级 JDK8</h6><p>　为何建议升级 JDK8 呢？因为 ZooKeeper 里面很多关键的功能点，都用到了 Atomic 类，而该类在 JDK8 中做了一次升级，性能提升了 6x 倍（JDK8 中加入了 <code>Unsafe.getUnsafe().getAnd[Add|Set][Int|Long|Object]</code> 一系列方法对 Atomic 类做了增强，由于无法看到 Oracle JDK 里 Unsafe 的相关实现，有兴趣可以参考 <a href="http://hg.openjdk.java.net/jdk8u/hs-dev/jdk/file/a006fa0a9e8f/src/share/classes/sun/misc/Unsafe.java">OpenJDK 源码</a>。目前，存在一种比较靠谱的猜测是，<a href="https://github.com/aeste/gcc/blob/master/libjava/sun/misc/natUnsafe.cc#L52"><code>compare-and-swap</code></a> 被替换成系统底层的 <a href="https://github.com/aeste/gcc/blob/d2774faa810502779b6e39b1e1578ceafde5f4cd/gcc/sync-builtins.def#L31"><code>fetch-and-add</code></a>，后者用 <strong>lock xadd</strong> 替代了 <strong>lock cmpxchg</strong> 来实现原子操作。其中 指令前缀 <strong>lock</strong> 用来锁定指令涉及的存储区域，<strong>xadd</strong> 指令作用是 交换两个操作数的值，再进行加法操作，<strong>cmpxchg</strong> 比较交换指令，第一操作数先和 <code>AL/AX/EAX</code> 比较，如果相等 <code>ZF</code> 置 1，第二操作数赋给第一操作数，否则 <code>ZF</code> 清 0，第一操作数赋给 <code>AL/AX/EAX</code>。由此可见，<strong>xadd</strong> 指令实现的 FAA 和 <strong>cmpxchg</strong> 指令实现的 CAS 相比，并没有自旋，因此不用担心循环时间过长之后 CPU 资源消耗过大，并且也没有了 CAS 中 ABA 之类的问题 [该问题在 AtomicStampedReference 中，通过增加版本号解决了]）</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">## 源码</span></span><br><span class="line"><span class="comment"># JDK 8 - AtomicInteger</span></span><br><span class="line">public final int <span class="function"><span class="title">getAndIncrement</span></span>() {</span><br><span class="line">  <span class="built_in">return</span> unsafe.getAndAddInt(this, valueOffset, 1);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment"># JDK7 - AtomicInteger</span></span><br><span class="line">public final int <span class="function"><span class="title">getAndIncrement</span></span>() {</span><br><span class="line">    <span class="keyword">for</span> (;;) {</span><br><span class="line">        int current = get();</span><br><span class="line">        int next = current + 1;</span><br><span class="line">        <span class="keyword">if</span> (compareAndSet(current, next)) <span class="built_in">return</span> current;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">## 汇编</span></span><br><span class="line"><span class="comment"># JDK 8</span></span><br><span class="line">0x0000000002cf49c7: mov    %rbp,0x10(%rsp)</span><br><span class="line">  0x0000000002cf49cc: mov    <span class="variable">$0x1</span>,%eax</span><br><span class="line">  0x0000000002cf49d1: lock xadd %eax,0xc(%rdx)  ;*invokevirtual getAndAddInt</span><br><span class="line">                                                ; - java.util.concurrent.atomic.AtomicInteger::incrementAndGet@8 (line 186)</span><br><span class="line"></span><br><span class="line"><span class="comment"># JDK 7</span></span><br><span class="line">0x0000000002c207f5: lock cmpxchg %r8d,0xc(%rdx)</span><br><span class="line">  0x0000000002c207fb: sete   %r11b</span><br><span class="line">  0x0000000002c207ff: movzbl %r11b,%r11d        ;*invokevirtual compareAndSwapInt</span><br><span class="line">                                                ; - java.util.concurrent.atomic.AtomicInteger::compareAndSet@9 (line 135)</span><br><span class="line">                                                ; - java.util.concurrent.atomic.AtomicInteger::incrementAndGet@12 (line 206)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 指令</span></span><br><span class="line"><span class="comment"># JDK 8</span></span><br><span class="line">XADD—Exchange and Add</span><br><span class="line">  Exchanges the first operand (destination operand) with the second operand (<span class="built_in">source</span> operand), <span class="keyword">then</span> loads the sum of the two values into the destination operand. The destination operand can be a register or a memory location; the <span class="built_in">source</span> operand is a register.</span><br><span class="line">  In 64-bit mode, the instruction’s default operation size is 32 bits. Using a REX prefix <span class="keyword">in</span> the form of REX.R permits access to additional registers (R8-R15). Using a REX prefix <span class="keyword">in</span> the form of REX.W promotes operation to 64 bits. See the summary chart at the beginning of this section <span class="keyword">for</span> encoding data and limits.</span><br><span class="line">  This instruction can be used with a LOCK prefix to allow the instruction to be executed atomically.</span><br><span class="line"></span><br><span class="line">TEMP ← SRC + DEST;</span><br><span class="line">SRC ← DEST;</span><br><span class="line">DEST ← TEMP;</span><br><span class="line"></span><br><span class="line"><span class="comment"># JDK 7</span></span><br><span class="line">CMPXCHG—Compare and Exchange</span><br><span class="line">  Compares the value <span class="keyword">in</span> the AL, AX, EAX, or RAX register with the first operand (destination operand). If the two values are equal, the second operand (<span class="built_in">source</span> operand) is loaded into the destination operand. Otherwise, the destination operand is loaded into the AL, AX, EAX or RAX register. RAX register is available only <span class="keyword">in</span> 64-bit mode.</span><br><span class="line">  This instruction can be used with a LOCK prefix to allow the instruction to be executed atomically. To simplify the interface to the processor’s bus, the destination operand receives a write cycle without regard to the result of the comparison. The destination operand is written back <span class="keyword">if</span> the comparison fails; otherwise, the <span class="built_in">source</span> operand is written into the destination. (The processor never produces a locked <span class="built_in">read</span> without also producing a locked write.)</span><br><span class="line">  In 64-bit mode, the instruction’s default operation size is 32 bits. Use of the REX.R prefix permits access to additional registers (R8-R15). Use of the REX.W prefix promotes operation to 64 bits. See the summary chart at the beginning of this section <span class="keyword">for</span> encoding data and limits.</span><br><span class="line"></span><br><span class="line">(* Accumulator = AL, AX, EAX, or RAX depending on whether a byte, word, doubleword, or quadword comparison is being performed *)</span><br><span class="line">TEMP ← DEST</span><br><span class="line">IF accumulator = TEMP</span><br><span class="line">  THEN</span><br><span class="line">    ZF ← 1;</span><br><span class="line">    DEST ← SRC;</span><br><span class="line">  ELSE</span><br><span class="line">    ZF ← 0;</span><br><span class="line">    accumulator ← TEMP;</span><br><span class="line">    DEST ← TEMP;</span><br><span class="line">FI;</span><br></pre></td></tr></tbody></table></figure>
<p>Tips: 这里 CAS 还有一个预测分支的损耗，有兴趣可以进一步研究一个问题：为何有序数组的 <code>for</code> 循环遍历，会比无序数组快，以及如何解决？</p>
<p>　截止本文编写时间 <code>2017-6-20 (master:111ae5a)</code>，一共有 70 个 Atomic 实例在 ZooKeeper 中被初始化并使用</p>
<p><img data-src="/picture/zk/zk_atomic.png" alt=""></p>
<center>（对 <a href="https://www.jetbrains.com/idea/" target="_blank">IntelliJ IDEA</a>™ 的截图）</center>



<h6 id="G1GC"><a href="#G1GC" class="headerlink" title="G1GC"></a>G1GC</h6><p>　在不牺牲吞吐性能的前提下，<code>G1GC</code> 并能更好地控制 GC 的停顿时间，因此非常合适 ZooKeeper 这类需要控制<code>心跳超时时间（tickTime）</code>的服务<br>　在多处理器和大容量内存的环境下，能更快速地整理空闲空间，避免产生过多的内存碎片<br>　这里只罗列一些常用的配置和特定情况下，需要调整的参数，具体调整到多少才算最佳，还是需要依据 <code>ZooKeeper 具体的使用场景</code>、<code>Beachmark 的结果</code>和 <code>GC 日志</code>的分析</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>Params</th>
<th>Meaning</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>-XX:+UseG1GC</td>
<td>使用 G1GC</td>
<td></td>
</tr>
<tr>
<td>-XX:G1HeapRegionSize=4m</td>
<td>设置内存分块的大小（1MB~32MB）</td>
<td>当系统中存在大量大对象的时候，大的 Region 会提升 GC 效率</td>
</tr>
<tr>
<td>-XX:MaxGCPauseMillis=200（ms）</td>
<td>此值为建议 <code>JVM</code> 的最长暂停时间</td>
<td>只是建议值，G1GC 只能尽量保证，而无法完全保证</td>
</tr>
<tr>
<td>-XX:InitiatingHeap OccupancyPercent=45</td>
<td>设置使用了<code>整个堆的 n%</code> 时，系统开始进行并行 GC</td>
<td>注意是<strong>整个堆</strong>的百分比。这与 CMS 收集器的类似参数不同</td>
</tr>
<tr>
<td>-XX:ParallelGCThreads=n</td>
<td>设置 STW 工作线程数的值</td>
<td>默认线程数由 CPU 数量决定，通常小于逻辑处理器的个数 m</td>
</tr>
<tr>
<td></td>
<td></td>
<td><strong>m&lt;=8</strong>: $n=m$;</td>
</tr>
<tr>
<td></td>
<td></td>
<td><strong>m&gt;8 &amp; system!=<a href="https://en.wikipedia.org/wiki/SPARC">SPARC</a></strong>: $n\approx5/8*m$;</td>
</tr>
<tr>
<td></td>
<td></td>
<td><strong>m&gt;8 &amp; system=SPARC</strong>: $n\approx5/16*m$</td>
</tr>
<tr>
<td></td>
<td></td>
<td>当有较大的 Update RSet 时间时，可以尝试调整此值</td>
</tr>
<tr>
<td>-XX:ConcGCThreads=n</td>
<td>设置并行标记的线程数</td>
<td>mixed GC 情况下，较长的 cycle start 时间，可以尝试调整此值</td>
</tr>
<tr>
<td></td>
<td></td>
<td>$n\approx1/4 * ParallelGCThreads$</td>
</tr>
<tr>
<td>-XX:+ParallelRefProcEnabled</td>
<td>当看到有较长的 Ref Proc 建议配置此值</td>
<td>CMS 收集器和 G1 收集器均有这个问题。配置以后暂停明显缩小</td>
</tr>
</tbody>
</table>
</div>
<h6 id="LongAdder"><a href="#LongAdder" class="headerlink" title="LongAdder"></a>LongAdder</h6><p>　考虑使用 LongAdder（author：<a href="http://ifeve.com/doug-lea/">Doug Lea</a>）<a href="https://issues.apache.org/jira/browse/ZOOKEEPER-2790">替代 AtomicLong</a>，以提高效率，下面用 100 个线程去 increment 计算 1kw 次，发现效率大致相差 6 倍（已提交 <a href="https://issues.apache.org/jira/browse/ZOOKEEPER-2790">jira</a> 欢迎讨论）</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// -Xmx512M -Xms512M -Xmn256M -XX:+AlwaysPreTouch -ea</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pressureLongAdder</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">final</span> LongAdder longAdder = <span class="keyword">new</span> LongAdder();</span><br><span class="line">    ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">    <span class="keyword">long</span> startTime = System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) {</span><br><span class="line">        executorService.submit(<span class="keyword">new</span> Thread(() -&gt; {</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">1000_0000</span>; j++) {</span><br><span class="line">                longAdder.increment();</span><br><span class="line">            }</span><br><span class="line">            System.out.print(String.format(<span class="string">"%s %s \t"</span>, Thread.currentThread().getId(), longAdder.longValue()));</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            14 19607585 	12 36445036 	20 38985288 	38 76821270 	70 117094732 	18 127252576</span></span><br><span class="line"><span class="comment">            22 137043349 	26 153411172 	30 164051380 	34 165971155  	102 192241678 	134 201104979</span></span><br><span class="line"><span class="comment">            158 232657818 	46 279030056 	174 288502545 	94 347965290 	198 348060553 	118 348087414</span></span><br><span class="line"><span class="comment">            36 353092712 	28 357762215 	44 365464475 	126 379518198 	54 379623515 	182 380077075</span></span><br><span class="line"><span class="comment">            142 385263911 	78 389013887 	62 389085727 	110 389122678 	86 389920423 	166 393535019</span></span><br><span class="line"><span class="comment">            150 396382512 	190 403100499 	32 403161217 	208 403197689 	206 406065520 	16 410725026</span></span><br><span class="line"><span class="comment">            24 415347205 	40 415379997 	48 415733397 	104 418507295 	192 423244160 	176 455793362</span></span><br><span class="line"><span class="comment">            168 458311865 	160 463028656 	136 496375440 	72 541243645 	186 561877000 	170 575352229</span></span><br><span class="line"><span class="comment">            162 584152392 	154 604552121 	138 614092854 	64 638151890 	114 668705836 	58 669235250</span></span><br><span class="line"><span class="comment">            188 699213410 	156 729222401 	124 754336889 	100 784326386 	76 813479501 	120 827569944</span></span><br><span class="line"><span class="comment">            66 830236567 	98 832153503 	112 841408676 	204 849520891 	210 852391130 	202 864804732</span></span><br><span class="line"><span class="comment">            172 875603834 	194 877222893 	200 881090909 	88 882809513 	80 882846368 	56 887174571</span></span><br><span class="line"><span class="comment">            178 889682247 	140 901357028 	146 902169049 	184 904540678 	152 915608988 	130 917896629</span></span><br><span class="line"><span class="comment">            116 924616135 	144 927674541 	122 930399321 	128 939791111 	106 942656234 	84 950848174</span></span><br><span class="line"><span class="comment">            96 951904067 	90 954910184 	74 964338213 	196 966487766 	82 968307139 	52 975854400</span></span><br><span class="line"><span class="comment">            180 977385398 	164 978882525 	50 980896807 	148 988292352 	132 989090669 	108 996891232</span></span><br><span class="line"><span class="comment">            92 996921398 	42 996938988 	68 996953941 	60 1000000000</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">        }));</span><br><span class="line">    }</span><br><span class="line">    executorService.shutdown();</span><br><span class="line">    <span class="keyword">while</span> (!executorService.isTerminated()) {</span><br><span class="line">        Thread.sleep(<span class="number">1</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">long</span> endTime = System.currentTimeMillis();</span><br><span class="line">    System.out.println(<span class="string">"\n"</span> + (endTime - startTime));    <span class="comment">// 3275 ms</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// -Xmx512M -Xms512M -Xmn128M -XX:+AlwaysPreTouch -ea</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pressureAtomicLong</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">final</span> AtomicLong atomicLong = <span class="keyword">new</span> AtomicLong();</span><br><span class="line">    ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">    <span class="keyword">long</span> startTime = System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) {</span><br><span class="line">        executorService.submit(<span class="keyword">new</span> Thread(() -&gt; {</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">1000_0000</span>; j++) {</span><br><span class="line">                atomicLong.getAndIncrement();</span><br><span class="line">            }</span><br><span class="line">            System.out.print(String.format(<span class="string">"%s %s \t"</span>, Thread.currentThread().getId(), atomicLong.longValue()));</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            12 390000000 	28 390000000 	44 390000000 	20 390000000 	26 390000000 	18 390000000</span></span><br><span class="line"><span class="comment">            80 390000000 	56 390000000 	96 390000000 	24 390000000 	88 390000000 	72 390000000</span></span><br><span class="line"><span class="comment">            22 390000000 	118 390000000 	54 390000000 	142 390000000 	70 390000000 	86 390000000</span></span><br><span class="line"><span class="comment">            182 390000000 	110 390000000 	62 390000000 	78 390000000 	102 390000000 	158 390000000</span></span><br><span class="line"><span class="comment">            150 390000000 	46 390000000 	38 390000000 	126 390000000 	94 390000000 	134 390000000</span></span><br><span class="line"><span class="comment">            14 390000000 	48 390000000 	40 390000000 	32 390000000 	34 390000000 	64 390000000</span></span><br><span class="line"><span class="comment">            42 390000000 	36 390000000 	16 390000000 	180 416396554 	204 419908287 	196 425536497</span></span><br><span class="line"><span class="comment">            92 732203658 	30 733835560 	202 733835559 	210 733873571 	146 733878564 	186 733883527</span></span><br><span class="line"><span class="comment">            170 733888686 	76 733892691 	84 733888815 	148 733901560 	162 733907032 	172 733908079</span></span><br><span class="line"><span class="comment">            52 733913280 	116 733918421 	124 733906868 	164 733920945 	132 733891348 	68 733923672</span></span><br><span class="line"><span class="comment">            108 733924928 	156 733926091 	60 733921998 	140 733927257 	188 733928891 	154 733871822</span></span><br><span class="line"><span class="comment">            194 733830477 	178 733872527 	100 733830322 	106 748251688 	144 1000000000 	98 1000000000</span></span><br><span class="line"><span class="comment">            58 1000000000 	90 1000000000 	130 1000000000 	138 1000000000 	114 1000000000 	104 1000000000</span></span><br><span class="line"><span class="comment">            168 1000000000 	200 1000000000 	184 1000000000 	160 1000000000 	174 1000000000 	112 1000000000</span></span><br><span class="line"><span class="comment">            190 1000000000 	198 1000000000 	82 1000000000 	206 1000000000 	166 1000000000 	176 1000000000</span></span><br><span class="line"><span class="comment">            136 1000000000 	208 1000000000 	74 1000000000 	122 1000000000 	152 1000000000 	192 1000000000</span></span><br><span class="line"><span class="comment">            120 1000000000 	128 1000000000 	66 1000000000 	50 1000000000</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">        }));</span><br><span class="line">    }</span><br><span class="line">    executorService.shutdown();</span><br><span class="line">    <span class="keyword">while</span> (!executorService.isTerminated()) {</span><br><span class="line">        Thread.sleep(<span class="number">1</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">long</span> endTime = System.currentTimeMillis();</span><br><span class="line">    System.out.println(<span class="string">"\n"</span> + (endTime - startTime));    <span class="comment">// 19409 ms</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>　下面从源码的角度来分析，首先 LongAdder 继承于 Striped64 类，实现了类似 AtomicLong 的一些 <code>add / increment / decrement / sum / longValue</code> 等方法</p>
<p><img data-src="/picture/zk/zk_long_adder_striped64_number.png" alt=""></p>
<center>（对 <a href="https://www.jetbrains.com/idea/" target="_blank">IntelliJ IDEA</a>™ 的截图）</center>

<p>　分析 LongAdder 里面最为核心的一个 <code>add</code> 方法<br></p><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Adds the given value.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> x the value to add</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">long</span> x)</span> </span>{</span><br><span class="line">    Cell[] as; <span class="keyword">long</span> b, v; <span class="keyword">int</span> m; Cell a;</span><br><span class="line">    <span class="keyword">if</span> ((as = cells) != <span class="keyword">null</span> || !casBase(b = base, b + x)) {</span><br><span class="line">        <span class="keyword">boolean</span> uncontended = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (as == <span class="keyword">null</span> || (m = as.length - <span class="number">1</span>) &lt; <span class="number">0</span> || (a = as[getProbe() &amp; m]) == <span class="keyword">null</span> ||</span><br><span class="line">            !(uncontended = a.cas(v = a.value, v + x)))</span><br><span class="line">            longAccumulate(x, <span class="keyword">null</span>, uncontended);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>　可以看到里面用到了一个 <code>java.util.concurrent.atomic.Striped64.Cell</code> 类，作为最终存放数据的地方，比较特别是，这里是一个数组，而不是 AtomicLong 里面看到的 <code>volatile long</code> 变量，并且 <code>Cell[]</code> 数组的长度是以 <code>2</code> 的指数级进行增长的，到这里多少可以看出 LongAdder 有点想以<strong>空间换时间</strong>的端倪了。之所以是用 <code>Cell[]</code> 数组，是考虑到可以将更新操作分而治之，不必对单一变量进行竞争，而是将压力均分到整个数组里面，这样如果需要得到 <code>LongAdder</code> 的值，只需要做一次 <code>sum</code> 操作</p>
<p>　并且，看 <code>add</code> 方法的第一个 <code>if</code> 分支，<code>cells</code> 是一个 lazy init 的变量，也就是只要是在<strong>单线程无并发</strong>的场景下，就会直接调用 <code>casBase</code> 方法完成 CAS 赋值并返回。如此一来，可以节省下创建数组带来的资源消耗。那么，如果在多线程并发的场景下，<code>casBase</code> 执行失败，则会进行第二个 <code>if</code> 分支的判断，这样就可以发挥 <code>Cell[]</code> 的作用了（AtomicLong 中则是用 while 循环不断进行尝试）。此时 <code>Cell[] as</code> 尚未初始化，因此会进入到 <code>if</code> 分支内，执行 <code>longAccumulate</code> 方法</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Table of cells. When non-null, size is a power of 2.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">volatile</span> Cell[] cells;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Padded variant of AtomicLong supporting only raw accesses plus CAS.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * JVM intrinsics note: It would be possible to use a release-only</span></span><br><span class="line"><span class="comment"> * form of CAS here, if it were provided.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@sun</span>.misc.Contended <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Cell</span> </span>{</span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">long</span> value;</span><br><span class="line">    Cell(<span class="keyword">long</span> x) { value = x; }</span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">cas</span><span class="params">(<span class="keyword">long</span> cmp, <span class="keyword">long</span> val)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> UNSAFE.compareAndSwapLong(<span class="keyword">this</span>, valueOffset, cmp, val);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// Unsafe mechanics</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> sun.misc.Unsafe UNSAFE;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> valueOffset;</span><br><span class="line">    <span class="keyword">static</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            UNSAFE = sun.misc.Unsafe.getUnsafe();</span><br><span class="line">            Class&lt;?&gt; ak = Cell.class;</span><br><span class="line">            valueOffset = UNSAFE.objectFieldOffset</span><br><span class="line">                (ak.getDeclaredField(<span class="string">"value"</span>));</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>　<code>longAccumulate</code> 会首先调用 <code>getProbe</code> 方法获取一个 <code>Probe</code> 当前线程的探测值（利用 <code>java.util.concurrent.ThreadLocalRandom#getProbe</code> 返回随机整数值），因为 <code>Probe</code> 值是通过反射 <code>Thread</code> 类的 <code>threadLocalRandomProbe</code> 变量获取的，而 <code>threadLocalRandomProbe</code> 也是 lazy init，所以如果为 int 默认值 <code>0</code> 的时候，需要用 <code>ThreadLocalRandom.current()</code> 方法进行强制初始化（此处用的是 mix64 <a href="https://softwareengineering.stackexchange.com/questions/49550/which-hashing-algorithm-is-best-for-uniqueness-and-speed">伪随机数算法</a>，该算法由 Austin Appleby 于  08 年提出的 <a href="https://en.wikipedia.org/wiki/MurmurHash">MurmurHash3</a> 算法的一种变种实现，可以说已经统一了整个伪随机领域，在 <a href="https://github.com/antirez/redis/blob/unstable/src/dict.c#L90"><code>Redis</code></a>、<a href="https://github.com/memcached/memcached/blob/master/murmur3_hash.c"><code>Memcached</code></a>、<a href="https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/utils/MurmurHash.java"><code>Cassandra</code></a>、<a href="https://github.com/apache/hbase/blob/master/hbase-common/src/main/java/org/apache/hadoop/hbase/util/MurmurHash.java"><code>HBase</code></a>、<a href="https://github.com/apache/lucene-solr/blob/master/lucene/codecs/src/java/org/apache/lucene/codecs/bloom/MurmurHash2.java"><code>Lucene</code></a> 和 <a href="https://github.com/elastic/elasticsearch/blob/master/core/src/main/java/org/elasticsearch/common/hash/MurmurHash3.java"><code>ElasticSearch</code></a> 等各大流行框架中看到 MurmurHash 的身影，具体可参考 Doug Lea 的<a href="http://gee.cs.oswego.edu/dl/papers/oopsla14.pdf">这篇论文</a>）</p>
<p>　随后进入 <code>for (;;)</code> 死循环，这时候会先判断 <code>Cell[]</code> 数组是否为空、长度是否大于 <code>0</code>，如果 <code>Cell[]</code> 未完成初始化，则会去判断 <code>cellsBusy</code> 自旋锁是否为 <code>0</code>，来控制 <code>Cell[]</code> 创建和 resize 大小时的原子性。如果自旋锁为 <code>0</code>，则将其通过 <code>casCellsBusy()</code> 方法设置为 <code>1</code>，之后完成初始化工作并将 <code>cellsBusy</code> 重置为 <code>0</code>（默认 <code>Cell[]</code> 的 size 为 2）</p>
<p>　完成 <code>Cell[]</code> 数组初始化之后，会进入 <code>for (;;)</code> 死循环的第一个 <code>if</code> 分支，计算 <code>as[(n - 1) &amp; h] = as[(2 - 1) &amp; -217768167] = as[1]</code> 获取到一个随机 <code>Cell</code> 是否为空；如果 <code>Cell</code> 为空，则新建 <code>Cell(x)</code> 存入到 <code>Cell[]</code> 的空槽位中；如果 <code>Cell</code> 不为空，则进一步判断 <code>wasUncontended</code> 参数是否为 <code>false</code>，如果是，则说明是预料到可能的冲突，则置为 <code>true</code> 继续尝试新的 <code>Cell</code>；下一个分支 <code>a.cas(v = a.value, ((fn == null) ? v + x : fn.applyAsLong(v, x)))</code> 则是进行对应的操作，这里 <code>fn</code> 为空，则执行 <code>+</code> 累加操作；接下来的一个分支 <code>n &gt;= NCPU || cells != as</code> 则是考虑到 <code>Cell[]</code> 的长度对比操作系统的 <strong>可用虚拟 CPU 核数</strong> 和 <strong>并发竞争的激烈程度</strong>，来判断是否碰撞严重，并和下一个分支一起控制 <code>collide</code> 变量来做标示；最后一个 <code>if</code> 分支 <code>cellsBusy == 0 &amp;&amp; casCellsBusy()</code>，如果到了这里，仍然没有完成 <code>add()</code> 方法的执行，说明需要通过扩展一倍的 <code>Cell[]</code> 数组来满足当前的并发量，之后再次重试，然后会不出意外地落入 <code>a.cas(v = a.value, ((fn == null) ? v + x : fn.applyAsLong(v, x)))</code> 第三个 <code>if</code> 分支中，最终完成 <code>add()</code> 方法</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Handles cases of updates involving initialization, resizing,</span></span><br><span class="line"><span class="comment"> * creating new Cells, and/or contention. See above for</span></span><br><span class="line"><span class="comment"> * explanation. This method suffers the usual non-modularity</span></span><br><span class="line"><span class="comment"> * problems of optimistic retry code, relying on rechecked sets of</span></span><br><span class="line"><span class="comment"> * reads.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> x the value</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fn the update function, or null for add (this convention</span></span><br><span class="line"><span class="comment"> * avoids the need for an extra field or function in LongAdder).</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> wasUncontended false if CAS failed before call</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">longAccumulate</span><span class="params">(<span class="keyword">long</span> x, LongBinaryOperator fn,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">boolean</span> wasUncontended)</span> </span>{</span><br><span class="line">    <span class="keyword">int</span> h;</span><br><span class="line">    <span class="keyword">if</span> ((h = getProbe()) == <span class="number">0</span>) {</span><br><span class="line">        ThreadLocalRandom.current(); <span class="comment">// force initialization</span></span><br><span class="line">        h = getProbe();</span><br><span class="line">        wasUncontended = <span class="keyword">true</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">boolean</span> collide = <span class="keyword">false</span>;                <span class="comment">// True if last slot nonempty</span></span><br><span class="line">    <span class="keyword">for</span> (;;) {</span><br><span class="line">        Cell[] as; Cell a; <span class="keyword">int</span> n; <span class="keyword">long</span> v;</span><br><span class="line">        <span class="keyword">if</span> ((as = cells) != <span class="keyword">null</span> &amp;&amp; (n = as.length) &gt; <span class="number">0</span>) {</span><br><span class="line">            <span class="keyword">if</span> ((a = as[(n - <span class="number">1</span>) &amp; h]) == <span class="keyword">null</span>) {</span><br><span class="line">                <span class="keyword">if</span> (cellsBusy == <span class="number">0</span>) {       <span class="comment">// Try to attach new Cell</span></span><br><span class="line">                    Cell r = <span class="keyword">new</span> Cell(x);   <span class="comment">// Optimistically create</span></span><br><span class="line">                    <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; casCellsBusy()) {</span><br><span class="line">                        <span class="keyword">boolean</span> created = <span class="keyword">false</span>;</span><br><span class="line">                        <span class="keyword">try</span> {               <span class="comment">// Recheck under lock</span></span><br><span class="line">                            Cell[] rs; <span class="keyword">int</span> m, j;</span><br><span class="line">                            <span class="keyword">if</span> ((rs = cells) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                                (m = rs.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                                rs[j = (m - <span class="number">1</span>) &amp; h] == <span class="keyword">null</span>) {</span><br><span class="line">                                rs[j] = r;</span><br><span class="line">                                created = <span class="keyword">true</span>;</span><br><span class="line">                            }</span><br><span class="line">                        } <span class="keyword">finally</span> {</span><br><span class="line">                            cellsBusy = <span class="number">0</span>;</span><br><span class="line">                        }</span><br><span class="line">                        <span class="keyword">if</span> (created) <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">continue</span>;           <span class="comment">// Slot is now non-empty</span></span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">                collide = <span class="keyword">false</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (!wasUncontended)       <span class="comment">// CAS already known to fail</span></span><br><span class="line">                wasUncontended = <span class="keyword">true</span>;      <span class="comment">// Continue after rehash</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (a.cas(v = a.value, ((fn == <span class="keyword">null</span>) ? v + x : fn.applyAsLong(v, x))))</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (n &gt;= NCPU || cells != as) collide = <span class="keyword">false</span>;            <span class="comment">// At max size or stale</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (!collide) collide = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; casCellsBusy()) {</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    <span class="keyword">if</span> (cells == as) {      <span class="comment">// Expand table unless stale</span></span><br><span class="line">                        Cell[] rs = <span class="keyword">new</span> Cell[n &lt;&lt; <span class="number">1</span>];</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; ++i) rs[i] = as[i];</span><br><span class="line">                        cells = rs;</span><br><span class="line">                    }</span><br><span class="line">                } <span class="keyword">finally</span> {</span><br><span class="line">                    cellsBusy = <span class="number">0</span>;</span><br><span class="line">                }</span><br><span class="line">                collide = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">continue</span>;                   <span class="comment">// Retry with expanded table</span></span><br><span class="line">            }</span><br><span class="line">            h = advanceProbe(h);</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; cells == as &amp;&amp; casCellsBusy()) {</span><br><span class="line">            <span class="keyword">boolean</span> init = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">try</span> {                           <span class="comment">// Initialize table</span></span><br><span class="line">                <span class="keyword">if</span> (cells == as) {</span><br><span class="line">                    Cell[] rs = <span class="keyword">new</span> Cell[<span class="number">2</span>];</span><br><span class="line">                    rs[h &amp; <span class="number">1</span>] = <span class="keyword">new</span> Cell(x);</span><br><span class="line">                    cells = rs;</span><br><span class="line">                    init = <span class="keyword">true</span>;</span><br><span class="line">                }</span><br><span class="line">            } <span class="keyword">finally</span> {</span><br><span class="line">                cellsBusy = <span class="number">0</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">if</span> (init) <span class="keyword">break</span>;</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (casBase(v = base, ((fn == <span class="keyword">null</span>) ? v + x : fn.applyAsLong(v, x)))) <span class="keyword">break</span>; <span class="comment">// Fall back on using base</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>总结：</p>
<ul>
<li><p><strong>高并发处理能力</strong><br> 从架构的角度来说，<code>AtomicLong</code> 中使用的是单一变量 <code>volatile long</code>，而在 <code>LongAdder</code> 中使用的是 <code>Cell[]</code>，这可以将并发的压力分摊到整个数组上，而非单个变量，可以更加得心应手地处理高并发的场景</p>
</li>
<li><p><strong>低资源消耗</strong><br> <code>Cell[]</code> 数组是延迟初始化的，并且在扩容的操作，是在考虑到 CPU 的核数（即机器的处理能力）和数组操作的碰撞次数（即并发的激烈程度）之后才会发生，尽可能地优化了资源的使用率</p>
</li>
<li><p><strong>更为高效的汇编指令</strong><br> 使用的是 <code>lock xadd</code> 而非 <code>lock cmpxchg</code> 指令来实现原子操作的，避免了 CAS 的 ABA、高并发下不断自旋 导致的 CPU 资源消耗过大、预测分支失败等问题</p>
</li>
</ul>
<h5 id="ZooKeeper-相关"><a href="#ZooKeeper-相关" class="headerlink" title="ZooKeeper 相关"></a>ZooKeeper 相关</h5><h6 id="leaderServes"><a href="#leaderServes" class="headerlink" title="leaderServes"></a>leaderServes</h6><p>　<code>zookeeper.leaderServes</code> 参数用于控制，Leader 节点是否可以被 Client 端连接，默认值为 <code>yes</code><br>　理论上 Leader 可以处理所有 Client 的读写请求，但是在 ZooKeeper 的架构设计中，Leader 的主要作用来对<code>事务更新请求</code>以及集群本身的<code>运行时协调</code><br>　所以，设置成 <code>no</code>，可使得 Leader 节点不接受 Client 端的连接请求，以提高分布式协调能力</p>
<h6 id="jute-maxbuffer"><a href="#jute-maxbuffer" class="headerlink" title="jute.maxbuffer"></a>jute.maxbuffer</h6><p>　<code>jute.maxbuffer</code> 参数用于控制，单个 ZNode 上最大可以存储的数据量，默认值为 1048575（1M - 1, 由<code>BinaryInputArchive.maxBuffer</code> 变量控制）<br>　因为 ZooKeeper 旨在存储大小为<a href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-bigdata/yuzhouwan-bigdata-zookeeper/src/test/java/com/yuzhouwan/bigdata/zookeeper/benchmark/ZKBenchmark.java#L98">千字节（1KB）</a> 的数据，因此通常情况下，需要下调这个阀值<br>　需要注意的是，该参数并不是在 Server 和 Client 端同时设置才会生效。实际情况是，在客户端设置后，ZooKeeper 将控制从 Server 端读取数据的大小（<strong>outgoingBuffer</strong>）；而在服务端设置后，则是控制从 Client 端写入数据的大小（<strong>incomingBuffer</strong>）<br>　换句话说，如果 Server 端不设置 maxbuffer，单 <code>ZNode</code> 结点最大可能的写入数据量为 $1024 \cdot 1024 - 42$ $= 1048534$。因为，在数据量达到 1M 的默认限制之前，会因为 <code>org.apache.zookeeper.server.NIOServerCnxn#readLength</code> 中的查看 buffer size 时，<code>lenBuffer.getInt()</code> 的调用就已经抛出了 <code>BufferUnderflowException</code> 了。而如果 Client 端不设置 maxbuffer，将不会对从 Server 端读取到的数据包大小做限制。但是，如果设置了，例如 maxbuffer=1024，但是其实 Client 最大能拿到的数据包大约只有 $1024 - 88 = 936$，因为除了数据本身，还包含了 <code>ReplyHeader（xid/zxid/err, 例如 1,3274,0\n，一般占 9 字节）</code>、<code>Record（Stat，例如 s{2,2,1495790235732,1495790235732,0,2874,0,0,0,0,3273}\n），一般占 55 字节</code>、<code>Tag，例如 response，一般占 8 字节</code> 等其他序列化信息</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 设置 Client 端</span></span><br><span class="line">$ vim <span class="variable">$ZOOKEEPER_HOME</span>/bin/zkCli.sh</span><br><span class="line">  <span class="comment"># 增加 -Djute.maxbuffer=&lt;buffer_size&gt; 参数</span></span><br><span class="line">  <span class="string">"<span class="variable">$JAVA</span>"</span> <span class="string">"-Dzookeeper.log.dir=<span class="variable">${ZOO_LOG_DIR}</span>"</span> <span class="string">"-Dzookeeper.root.logger=<span class="variable">${ZOO_LOG4J_PROP}</span>"</span>  <span class="string">"-Djute.maxbuffer=1073741824"</span>  \</span><br><span class="line">       -cp <span class="string">"<span class="variable">$CLASSPATH</span>"</span> <span class="variable">$CLIENT_JVMFLAGS</span> <span class="variable">$JVMFLAGS</span> \</span><br><span class="line">       org.apache.zookeeper.ZooKeeperMain <span class="string">"<span class="variable">$@</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置 Server 端</span></span><br><span class="line">$ vim <span class="variable">$ZOOKEEPER_HOME</span>/conf/zoo.cfg</span><br><span class="line">  <span class="comment"># 增加 jute.maxbuffer=&lt;buffer_size&gt; 参数</span></span><br><span class="line">  jute.maxbuffer=1073741824</span><br></pre></td></tr></tbody></table></figure>
<h6 id="globalOutstandingLimit"><a href="#globalOutstandingLimit" class="headerlink" title="globalOutstandingLimit"></a>globalOutstandingLimit</h6><p>　<code>zookeeper.globalOutstandingLimit</code> 参数用于控制，服务器最大请求堆积量，默认值为 1000<br>　为防止服务端资源（内存、CPU、网络）被耗尽，根据服务器最大处理能力，可做适当调整</p>
<h6 id="snapCount-amp-preAllocSize"><a href="#snapCount-amp-preAllocSize" class="headerlink" title="snapCount &amp; preAllocSize"></a>snapCount &amp; preAllocSize</h6><p>　<code>zookeeper.snapCount</code> 参数用于控制，两次快照之间事务操作的次数，默认值为 100,000<br>　<code>zookeeper.preAllocSize</code> 参数用于控制，事务日志文件预分配磁盘的大小，默认值为 65536KB（64MB）<br>　两个参数配合设置，可以依据特定业务场景下的事务操作数据量 <code>transactionDataSize</code>，按照 $snapCount * transactionDataSize \ge preAllocSize$ 公式进行适当调整</p>
<h6 id="zookeeper-serverCnxnFactory-amp-zookeeper-clientCnxnSocket"><a href="#zookeeper-serverCnxnFactory-amp-zookeeper-clientCnxnSocket" class="headerlink" title="zookeeper.serverCnxnFactory &amp; zookeeper.clientCnxnSocket"></a>zookeeper.serverCnxnFactory &amp; zookeeper.clientCnxnSocket</h6><p>　在 3.5 版本之后，默认<a href="https://issues.apache.org/jira/browse/ZOOKEEPER-733">使用</a> Netty，在此之前的版本，ZooKeeper 支持将默认使用的 NIO，替代为 Netty。通过在服务端和客户端分配配置以下两个配置项<br>　<code>zookeeper.serverCnxnFactory</code> 设置为 <code>org.apache.zookeeper.server.NettyServerCnxnFactory</code><br>　<code>zookeeper.clientCnxnSocket</code> 设置为 <code>org.apache.zookeeper.ClientCnxnSocketNetty</code></p>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><h3 id="源码环境搭建"><a href="#源码环境搭建" class="headerlink" title="源码环境搭建"></a>源码环境搭建</h3><h4 id="下载源码"><a href="#下载源码" class="headerlink" title="下载源码"></a>下载源码</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 基于 branch-3.4 进行分析</span></span><br><span class="line">$ git fetch https://github.com/apache/zookeeper.git branch-3.4:branch-3.4</span><br></pre></td></tr></tbody></table></figure>
<h4 id="下载安装-Ant"><a href="#下载安装-Ant" class="headerlink" title="下载安装 Ant"></a>下载安装 Ant</h4><ul>
<li>Download: <a href="http://archive.apache.org/dist/ant/binaries/apache-ant-1.9.9-bin.tar.gz">apache-ant-1.9.9-bin.tar.gz</a></li>
<li>安装并设置环境变量</li>
</ul>
<h4 id="执行-Ant-命令"><a href="#执行-Ant-命令" class="headerlink" title="执行 Ant 命令"></a>执行 Ant 命令</h4><h5 id="编译出-IDE-可识别的环境"><a href="#编译出-IDE-可识别的环境" class="headerlink" title="编译出 IDE 可识别的环境"></a>编译出 IDE 可识别的环境</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> %ZOOKEEPER_SOURCE_PATH%</span><br><span class="line">$ ls | grep build.xml</span><br><span class="line">  build.xml</span><br><span class="line">$ ant clean</span><br><span class="line">$ ant eclipse</span><br><span class="line"><span class="comment"># 随后使用 Intellij Idea 导入</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="二次开发后，进行本地测试"><a href="#二次开发后，进行本地测试" class="headerlink" title="二次开发后，进行本地测试"></a>二次开发后，进行本地测试</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 优先编写 JUnit TestCase 进行测试，随后再利用 `ant test-core` 进行一次整体的测试</span></span><br><span class="line">$ ant -Dtest.junit.output.format=xml -Dtest.output=yes -Dtest.junit.threads=2 -Dcompile.c++=yes <span class="built_in">test</span>-core</span><br></pre></td></tr></tbody></table></figure>
<h5 id="打包编译"><a href="#打包编译" class="headerlink" title="打包编译"></a>打包编译</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ ant clean tar -Dbuild.compiler=javac1.7</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果报错 warning: macro 'AM_PATH_CPPUNIT' not found in library，则需要先安装 cppunit</span></span><br><span class="line"><span class="comment"># 并且，需要保证在 root 用户下执行 ant 编译</span></span><br><span class="line">$ yum install cppunit</span><br></pre></td></tr></tbody></table></figure>
<h4 id="运行-ZooKeeperServerMain"><a href="#运行-ZooKeeperServerMain" class="headerlink" title="运行 ZooKeeperServerMain"></a>运行 ZooKeeperServerMain</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 配置 Program arguments</span></span><br><span class="line"><span class="comment"># Usage: ZooKeeperServerMain configfile | port datadir [ticktime] [maxcnxns]</span></span><br><span class="line"><span class="comment"># 传参</span></span><br><span class="line">  2181 E:\data\zk</span><br><span class="line"><span class="comment"># 或者指定配置文件</span></span><br><span class="line">$ cp zoo_sample.cfg zoo.cfg</span><br><span class="line">$ vim zoo.cfg</span><br><span class="line">  <span class="comment"># dataDir=/tmp/zookeeper</span></span><br><span class="line">  dataDir=E:/data/zk</span><br></pre></td></tr></tbody></table></figure>
<h4 id="遇到的坑"><a href="#遇到的坑" class="headerlink" title="遇到的坑"></a>遇到的坑</h4><h5 id="下载依赖超时"><a href="#下载依赖超时" class="headerlink" title="下载依赖超时"></a>下载依赖超时</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim build.xml</span><br><span class="line">  <span class="comment"># 替换 ant-eclipse 下载地址</span></span><br><span class="line">  <span class="comment"># get src="http://downloads.sourceforge.net/project/ant-eclipse/ant-eclipse/1.0/ant-eclipse-1.0.bin.tar.bz2"</span></span><br><span class="line">  get src=<span class="string">"http://ufpr.dl.sourceforge.net/project/ant-eclipse/ant-eclipse/1.0/ant-eclipse-1.0.bin.tar.bz2"</span></span><br><span class="line"></span><br><span class="line">$ vim ivy.xml</span><br><span class="line">  <span class="comment"># 增加 commons-coolections 依赖</span></span><br><span class="line">  &lt;dependency org=<span class="string">"commons-collections"</span> name=<span class="string">"commons-collections"</span> rev=<span class="string">"3.0"</span>/&gt;</span><br></pre></td></tr></tbody></table></figure>
<h5 id="PowerMock-测试-TestingServer-报错-ClassCastException"><a href="#PowerMock-测试-TestingServer-报错-ClassCastException" class="headerlink" title="PowerMock 测试 TestingServer 报错 ClassCastException"></a>PowerMock 测试 TestingServer 报错 ClassCastException</h5><h6 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">17:32:55.821 [Thread-1] ERROR o.a.c.test.TestingZooKeeperServer - From testing server (random state: <span class="literal">false</span>) <span class="keyword">for</span> instance: InstanceSpec{dataDirectory=/var/folders/4z/h5ftkmm90vg5s7j0kv65j0gw0000gp/T/1542274365502-0, port=2181, electionPort=64470, quorumPort=64471, deleteDataDirectoryOnClose=<span class="literal">true</span>, serverId=1, tickTime=-1, maxClientCnxns=-1, customProperties={}, hostname=127.0.0.1} org.apache.curator.test.InstanceSpec@59c3be02</span><br><span class="line">java.lang.ClassCastException: class sun.security.provider.ConfigFile</span><br><span class="line">	at java.lang.Class.asSubclass(Class.java:3404) ~[na:1.8.0_171]</span><br><span class="line">	at javax.security.auth.login.Configuration<span class="variable">$2</span>.run(Configuration.java:254) ~[na:1.8.0_171]</span><br><span class="line">	at javax.security.auth.login.Configuration<span class="variable">$2</span>.run(Configuration.java:247) ~[na:1.8.0_171]</span><br><span class="line">	at java.security.AccessController.doPrivileged(Native Method) ~[na:1.8.0_171]</span><br><span class="line">	at javax.security.auth.login.Configuration.getConfiguration(Configuration.java:246) ~[na:1.8.0_171]</span><br><span class="line">	at org.apache.zookeeper.server.ServerCnxnFactory.configureSaslLogin(ServerCnxnFactory.java:189) ~[na:3.4.11-37e277162d567b55a07d1755f0b31c32e93c01a0]</span><br><span class="line">	at org.apache.zookeeper.server.NIOServerCnxnFactory.configure(NIOServerCnxnFactory.java:82) ~[na:3.4.11-37e277162d567b55a07d1755f0b31c32e93c01a0]</span><br><span class="line">	at org.apache.zookeeper.server.ZooKeeperServerMain.runFromConfig(ZooKeeperServerMain.java:119) ~[na:3.4.11-37e277162d567b55a07d1755f0b31c32e93c01a0]</span><br><span class="line">	at org.apache.curator.test.TestingZooKeeperMain.runFromConfig(TestingZooKeeperMain.java:93) ~[na:2.12.0]</span><br><span class="line">	at org.apache.curator.test.TestingZooKeeperServer<span class="variable">$1</span>.run(TestingZooKeeperServer.java:148) ~[na:2.12.0]</span><br><span class="line">	at java.lang.Thread.run(Thread.java:748) [na:1.8.0_171]</span><br></pre></td></tr></tbody></table></figure>
<h6 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h6><p>因为 Mock 使用自定义 <code>ClassLoader</code> 来完成字节码修改，而对于一些需要使用系统原生 <code>ClassLoader</code>的类，则需要通过 <code>@PowerMockIgnore</code> 注解来显式地告知 Mock 框架跳过它们</p>
<h6 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">@RunWith(PowerMockRunner.class)</span><br><span class="line">@PrepareForTest({Test.class})</span><br><span class="line">@PowerMockIgnore({<span class="string">"javax.net.ssl.*"</span>, <span class="string">"javax.management.*"</span>, <span class="string">"javax.security.*"</span>, <span class="string">"javax.crypto.*"</span>})</span><br></pre></td></tr></tbody></table></figure>
<h3 id="选主机制"><a href="#选主机制" class="headerlink" title="选主机制"></a>选主机制</h3><h4 id="ZAB-选主流程"><a href="#ZAB-选主流程" class="headerlink" title="ZAB 选主流程"></a>ZAB 选主流程</h4><h5 id="ZooKeeper-提供的选主算法"><a href="#ZooKeeper-提供的选主算法" class="headerlink" title="ZooKeeper 提供的选主算法"></a>ZooKeeper 提供的选主算法</h5><p>　ZooKeeper 提供了 LeaderElection / FastLeaderElection（UDP） / AuthFastLeaderElection（UDP） / <strong>FastLeaderElection（TCP）</strong> 这四种选主算法（初始化 QuorumPeer 时需指定到 electionAlg 参数），前三种策略因为 <code>UDP 的不可靠性</code>和 <a href="https://issues.apache.org/jira/browse/ZOOKEEPER-569"><code>LE 中被选举的 Leader 故障会导致无休止的选举</code></a>等问题，在 v3.4.0 开始被<a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1153">废弃</a></p>
<h5 id="Vote-数据结构"><a href="#Vote-数据结构" class="headerlink" title="Vote 数据结构"></a>Vote 数据结构</h5><p><img data-src="/picture/zk/zk_vote_server_state.png" alt=""></p>
<center>（利用 <a href="https://www.axure.com.cn/" target="_blank">Axure</a>™ 绘制而成）</center>

<h5 id="QuorumCnxManager-网络通讯"><a href="#QuorumCnxManager-网络通讯" class="headerlink" title="QuorumCnxManager 网络通讯"></a>QuorumCnxManager 网络通讯</h5><p>　<code>QuorumCnxManager</code> 起到管理 Election 过程中<code>网络连接</code>、<code>投票接受和发送</code>的作用。通过在 <a href="https://github.com/apache/zookeeper/blob/master/src/java/main/org/apache/zookeeper/server/quorum/QuorumCnxManager.java#L605">QuorumCnxManager.Listener</a> 中创建 <code>ServerSocket</code> 对象监听 Leader 选举的通信端口（default：3888），接收到 创建连接的请求后，由 <code>receiveConnection</code> 方法来处理，并在 <code>handleConnection</code> 方法中对连接的合法性进行处理，包括 接受的数据是否合法（大小不可小于 <code>0</code>，大于 <code>maxBuffer 2048 [硬编码]</code>）、权限控制。之后，会对 SID 进行判断，如果 <code>mySID</code> 大于接受到的 SID 要大，则会执行 <code>closeSocket</code> 方法断开连接，并执行 <code>SendWorker#finish</code> 关闭对应 SID 的 SendWorker。反之，则会创建 SendWorker 和 RecvWorker 并启动。此举可用来确保，只有 SID 更高的节点才会主动创建连接，避免重复的 TCP 连接</p>
<p><img data-src="/picture/zk/zk_quorum_cnx_manager.png" alt=""></p>
<center>（利用 <a href="https://www.axure.com.cn/" target="_blank">Axure</a>™ 绘制而成）</center>


<h5 id="LE-实现细节"><a href="#LE-实现细节" class="headerlink" title="LE 实现细节"></a>LE 实现细节</h5><p>　最终进行选举的逻辑实现，都在 FastLeaderElection 中<br><img data-src="/picture/zk/zk_fastLeader_election.png" alt=""></p>
<center>（利用 <a href="https://www.axure.com.cn/" target="_blank">Axure</a>™ 绘制而成）</center>


<p>　首先会发送投给自身的一条选票，并进入 <code>LOOKING</code> 状态，不断接受外部的选票。再接收到选票之后，会对<code>选票的轮次（logicalclock）</code>、<code>事务 ID（ZXID）</code>、<code>服务器 ID（SID）</code>依次进行比较，如果有一项比自身的值更大，则会更新自身的选票，并重新发送给其他 Quorum；否则，将忽略外部接受的选票，并统计是否<code>已过半</code>。最终，如果选票已经被过半数的 Quorum 节点所接受（Accept），则更新服务器状态，完成选举；否则，继续进入 <code>LOOKING</code> 状态，重复之前的步骤</p>
<p><img data-src="/picture/zk/zk_leader_election_flow.png" alt=""></p>
<center>（利用 <a href="https://www.axure.com.cn/" target="_blank">Axure</a>™ 绘制而成）</center>

<p>　相关实现代码如下<br></p><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Starts a new round of leader election. Whenever our QuorumPeer</span></span><br><span class="line"><span class="comment"> * changes its state to LOOKING, this method is invoked, and it</span></span><br><span class="line"><span class="comment"> * sends notifications to all other peers.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Vote <span class="title">lookForLeader</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>{</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Loop in which we exchange notifications until we find a leader</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">while</span> ((self.getPeerState() == ServerState.LOOKING) &amp;&amp; (!stop)){</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Sends more notifications if have not received enough.</span></span><br><span class="line"><span class="comment">         * Otherwise processes new notification.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span>(n == <span class="keyword">null</span>) { <span class="comment">// ... }</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (self.getCurrentAndNextConfigVoters().contains(n.sid)) {</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * Only proceed if the vote comes from a replica in the current or next voting view.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">switch</span> (n.state) {</span><br><span class="line">            <span class="keyword">case</span> LOOKING:</span><br><span class="line">                <span class="keyword">if</span> (getInitLastLoggedZxid() == -<span class="number">1</span>) {</span><br><span class="line">                    LOG.debug(<span class="string">"Ignoring notification as our zxid is -1"</span>); <span class="keyword">break</span>;</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">if</span> (n.zxid == -<span class="number">1</span>) {</span><br><span class="line">                    LOG.debug(<span class="string">"Ignoring notification from member with -1 zxid"</span> + n.sid); <span class="keyword">break</span>;</span><br><span class="line">                }</span><br><span class="line">                <span class="comment">// If notification &gt; current, replace and send messages out</span></span><br><span class="line">                <span class="keyword">if</span> (n.electionEpoch &gt; logicalclock.get()) {</span><br><span class="line">                    logicalclock.set(n.electionEpoch);</span><br><span class="line">                    recvset.clear();</span><br><span class="line">                    <span class="keyword">if</span> (totalOrderPredicate(n.leader, n.zxid, n.peerEpoch, getInitId(), getInitLastLoggedZxid(), getPeerEpoch())) {</span><br><span class="line">                        updateProposal(n.leader, n.zxid, n.peerEpoch);</span><br><span class="line">                    } <span class="keyword">else</span> {</span><br><span class="line">                        updateProposal(getInitId(), getInitLastLoggedZxid(), getPeerEpoch());</span><br><span class="line">                    }</span><br><span class="line">                    sendNotifications();</span><br><span class="line">                } <span class="keyword">else</span> <span class="keyword">if</span> (n.electionEpoch &lt; logicalclock.get()) {</span><br><span class="line">                    <span class="keyword">if</span>(LOG.isDebugEnabled()){</span><br><span class="line">                        LOG.debug(<span class="string">"Notification election epoch is smaller than logicalclock. n.electionEpoch = 0x"</span></span><br><span class="line">                                + Long.toHexString(n.electionEpoch)</span><br><span class="line">                                + <span class="string">", logicalclock=0x"</span> + Long.toHexString(logicalclock.get()));</span><br><span class="line">                    }</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                } <span class="keyword">else</span> <span class="keyword">if</span> (totalOrderPredicate(n.leader, n.zxid, n.peerEpoch, proposedLeader, proposedZxid, proposedEpoch)) {</span><br><span class="line">                    updateProposal(n.leader, n.zxid, n.peerEpoch);</span><br><span class="line">                    sendNotifications();</span><br><span class="line">                }</span><br><span class="line">                recvset.put(n.sid, <span class="keyword">new</span> Vote(n.leader, n.zxid, n.electionEpoch, n.peerEpoch)); <span class="comment">// ...</span></span><br><span class="line">            <span class="keyword">case</span> OBSERVING: <span class="comment">// ...</span></span><br><span class="line">            <span class="keyword">case</span> FOLLOWING: <span class="comment">// ...</span></span><br><span class="line">            <span class="keyword">case</span> LEADING: <span class="comment">// ...</span></span><br><span class="line">            <span class="keyword">default</span>: <span class="comment">// ...</span></span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Check if a pair (server id, zxid) succeeds our current vote.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id    Server identifier</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> zxid  Last zxid observed by the issuer of this vote</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">totalOrderPredicate</span><span class="params">(<span class="keyword">long</span> newId, <span class="keyword">long</span> newZxid, <span class="keyword">long</span> newEpoch, <span class="keyword">long</span> curId, <span class="keyword">long</span> curZxid, <span class="keyword">long</span> curEpoch)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (self.getQuorumVerifier().getWeight(newId) == <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * We return true if one of the following three cases hold:</span></span><br><span class="line"><span class="comment">     * 1- New epoch is higher</span></span><br><span class="line"><span class="comment">     * 2- New epoch is the same as current epoch, but new zxid is higher</span></span><br><span class="line"><span class="comment">     * 3- New epoch is the same as current epoch, new zxid is the same as current zxid, but server id is higher.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">return</span> ((newEpoch &gt; curEpoch) ||</span><br><span class="line">            ((newEpoch == curEpoch) &amp;&amp;</span><br><span class="line">            ((newZxid &gt; curZxid) || ((newZxid == curZxid) &amp;&amp; (newId &gt; curId)))));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<h4 id="ZAB-和-Paxos-的区别"><a href="#ZAB-和-Paxos-的区别" class="headerlink" title="ZAB 和 Paxos 的区别"></a>ZAB 和 Paxos 的区别</h4><p>　<strong>ZAB</strong>，Atomic Broadcast 协议，保证了发给各副本的消息顺序相同（因为 ZooKeeper 是一个树形结构，很多操作都要先检查才能确定能不能执行，如 <code>/a/b</code> 需要在 先创建好 <code>/a</code> 的前提下，才能创建 <code>/a/b</code>）<br>　<strong>Paxos</strong> 保证不了<code>全序顺序</code>，Paxos 算法的确是不关心请求之间的<code>逻辑顺序</code>，而只考虑<code>数据之间的全序</code></p>
<p>　ZAB 的核心思想，形象的说就是保证任意时刻只有一个节点是 <code>Leader</code>，所有更新事务由 <code>Leader</code>发起去更新所有副本（称为 <code>Follower</code>），更新时用的就是 <code>Two-phase</code> 两阶段提交协议，只要多数节点 prepare 成功，就通知他们 commit<br>　各 <code>Follower</code> 要按当初 <code>Leader</code> 让他们 prepare 的顺序来 apply 事务<br>　另外，因为 ZAB 处理的事务永远不会回滚，ZAB 对 2PC 阶段做了点优化，多个事务只要通知 ZXID 最大的那个 commit，之前的各 <code>Follower</code> 会统统 commit</p>
<p>　本质上，二者的设计目标是不一样的，<code>ZAB 协议</code>主要用于构建一个<strong>髙可用的分布式数据主备</strong>系统，而 <code>Paxos 算法</code>则是为了构建一个<strong>分布式的一致性状态机</strong>系统</p>
<h3 id="数据相关"><a href="#数据相关" class="headerlink" title="数据相关"></a>数据相关</h3><h4 id="ZooKeeper-内存结构"><a href="#ZooKeeper-内存结构" class="headerlink" title="ZooKeeper 内存结构"></a>ZooKeeper 内存结构</h4><p>　<code>ZKDatabase</code> 作为 ZooKeeper 内存数据库的主体，包含了 <strong>Session 会话</strong>、<strong>DataTree</strong>、<strong>Snapshot</strong>（记录 ZooKeeper 服务器上某一个时刻全量的内存数据内容）、<strong>事务日志</strong>（事务操作时间 、客户端会话 ID、 CXID [客户端的操作序列号]、ZXID、操作类型、会话超时时间、节点路径、节点数据内容、节点的 ACL 信息、 是否为临时节点 和 父节点的子节点版本号）等信息。<code>ZKDatabase</code> 会定时地向磁盘 dump 快照数据，并会在 ZooKeeper 服务端节点<code>启动/重启</code>的时候，read 磁盘上的<code>事务日志</code>和 <code>Snapshot 文件</code>，load 相关数据到内存中，重新恢复出整个 <code>ZKDatabase</code></p>
<p><img data-src="/picture/zk/zk_database_data_tree_data_node.png" alt=""></p>
<center>（利用 <a href="https://www.axure.com.cn/" target="_blank">Axure</a>™ 绘制而成）</center>


<h4 id="ZooKeeperServer-初始化流程"><a href="#ZooKeeperServer-初始化流程" class="headerlink" title="ZooKeeperServer 初始化流程"></a>ZooKeeperServer 初始化流程</h4><p>　启动 ZooKeeper 服务器节点的流程，从 <code>ServerMain#main</code> 方法开始。主要的调用链如下：</p>
<figure class="highlight"><table><tbody><tr><td class="code"><pre><span class="line">org.apache.zookeeper.server.ZooKeeperServerMain#runFromConfig</span><br><span class="line">org.apache.zookeeper.server.ServerCnxnFactory#startup(org.apache.zookeeper.server.ZooKeeperServer)</span><br><span class="line">org.apache.zookeeper.server.NettyServerCnxnFactory#startup      // 这里暂时不考虑 NIO 的实现，只看 Netty 实现的 `ServerCnxnFactory`</span><br><span class="line">org.apache.zookeeper.server.ZooKeeperServer#startdata</span><br><span class="line">org.apache.zookeeper.server.ZooKeeperServer#loadData</span><br></pre></td></tr></tbody></table></figure>
<p>　最终 Session 和 数据的恢复，都将在 <code>loadData</code> 方法中完成。<code>ZKServer</code> 首先利用 <code>ZKDatabase#loadDataBase</code> 调用 <code>FileTxnSnapLog#restore</code> 方法，从磁盘中反序列化 <strong>100</strong>（硬编码了在 <code>findNValidSnapshots(100)</code> 代码里）个有效的 Snapshot 文件，恢复出 <code>DataTree</code> 和 <code>sessionsWithTimeouts</code> 两个数据结构，以便获取到最新有效的 <code>ZXID</code>，并使用 <code>FileTxnSnapLog#processTransaction</code> 方法增量地处理 <code>DataTree</code> 中的事务。随后根据 Session 超时时间，将超时的 Session 从 <code>DataTree#ephemerals</code> 变量（<code>Map&lt;Long: sessionId, HashSet&lt;String&gt;: pathList&gt;</code>）中移除。同时，利用 <code>ZooKeeperServer#takeSnapshot</code> 方法，将 <code>DataTree</code> 实例持久化到磁盘，创建一个全新的 <code>Snapshot</code> 文件</p>
<h4 id="Snapshot-策略"><a href="#Snapshot-策略" class="headerlink" title="Snapshot 策略"></a>Snapshot 策略</h4><p>　首先，我们可以看到 <code>SyncRequestProcessor</code> 类的 <code>run()</code> 方法中，<code>ZooKeeperServer#takeSnapshot</code> 方法的调用是在一个新起的线程中发起的，因此 Snapshot 流程是异步发起的</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// org.apache.zookeeper.server.SyncRequestProcessor#run</span></span><br><span class="line">snapInProcess = <span class="keyword">new</span> ZooKeeperThread(<span class="string">"Snapshot Thread"</span>) {</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">      zks.takeSnapshot();</span><br><span class="line">    } <span class="keyword">catch</span>(Exception e) {</span><br><span class="line">      LOG.warn(<span class="string">"Unexpected exception"</span>, e);</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">};</span><br><span class="line">snapInProcess.start();</span><br></pre></td></tr></tbody></table></figure>
<p>　另外，在启动 <code>Snapshot</code> 线程之前，通过 $logCount \gt (snapCount / 2 + randRoll)$ 公式进行计算，是否应该发起 <code>Snapshot</code>（同时会保证前一个 Snapshot 已经结束才会开始）。由此可见 ZooKeeper 的设计巧妙之处，这里加入了 <code>randRoll</code> 随机数，可以降低所有 <code>Server</code> 节点同时发生 <code>Snapshot</code> 的概率，从而避免因 <code>Snapshot</code> 导致服务受影响。因为，<code>Snapshot</code> 的过程会消耗大量的 <code>磁盘 IO</code>、<code>CPU</code> 等资源，所以全部节点同时 <code>Snapshot</code> 会严重影响集群的对外服务能力</p>
<h3 id="请求流程"><a href="#请求流程" class="headerlink" title="请求流程"></a>请求流程</h3><p>　按照 <code>ZooKeeperServer</code> 的文档中所示，事务处理的大体流程链应该为 <code>PrepRequestProcessor</code> - <code>SyncRequestProcessor</code> - <code>FinalRequestProcessor</code>。因此，这也将是我们研究源码的阅读顺序</p>
<h4 id="ZooKeeper-乐观锁"><a href="#ZooKeeper-乐观锁" class="headerlink" title="ZooKeeper 乐观锁"></a>ZooKeeper 乐观锁</h4><p>　分布式中锁分类为，悲观锁（又称悲观并发控制 <strong>P</strong>essimistic <strong>C</strong>oncurrency <strong>C</strong>ontrol，PCC）和 乐观锁（又称乐观并发控制 <strong>O</strong>ptimistic <strong>C</strong>oncurrency <strong>C</strong>ontrol，OCC）。乐观锁事务控制流程，分为 <code>数据读取</code>、<code>写入校验</code>和<code>数据写入</code>三个阶段，常见实现为 JDK 中的 <a href="http://ifeve.com/atomic-operation/">CAS</a>（synchronized / Atomic 类）。如果是<code>并发竞争少</code>或<code>事务冲突频率低</code>的场景，可使用<code>乐观锁</code>，<code>写入校验</code>成功就执行，不成功就失败回滚；如果<code>冲突频率高</code>或者<code>重试代价大</code>的场景，则建议使用<code>悲观锁</code></p>
<p>　而 ZooKeeper 中，是在执行 <code>OpCode.setData</code> 操作的时候，对 <code>version</code> 版本进行校验，从而实现了 <code>乐观锁</code>的 <code>写入校验</code>流程。如果，发现 <code>version</code> 和 <code>currentVersion</code> 是不一致的，则抛出 <code>BadVersionException</code> 异常进而回滚。不过，如果 <code>version</code> 的值为 <code>-1</code>，意味着 Client 的此次操作请求，不需要进行 <code>乐观锁</code>来控制并发，则无需校验。此处，只是对 <code>version</code> 进行了一次数据写入前的校验，如果并发导致失败了，将直接返回 <code>KeeperErrorCode = BadVersion</code> 错误信息</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// org.apache.zookeeper.server.PrepRequestProcessor#pRequest2Txn</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">pRequest2Txn</span><span class="params">(<span class="keyword">int</span> type, <span class="keyword">long</span> zxid, Request request, Record record, <span class="keyword">boolean</span> deserialize)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> KeeperException, IOException, RequestProcessorException</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    request.hdr = <span class="keyword">new</span> TxnHeader(request.sessionId, request.cxid, zxid, zks.getTime(), type);</span><br><span class="line">    <span class="keyword">switch</span> (type) {</span><br><span class="line">        <span class="keyword">case</span> OpCode.create: <span class="comment">//...</span></span><br><span class="line">        <span class="keyword">case</span> OpCode.delete: <span class="comment">//...</span></span><br><span class="line">        <span class="keyword">case</span> OpCode.setData: <span class="comment">//...</span></span><br><span class="line">            zks.sessionTracker.checkSession(request.sessionId, request.getOwner());</span><br><span class="line">            SetDataRequest setDataRequest = (SetDataRequest)record;</span><br><span class="line">            <span class="keyword">if</span>(deserialize)</span><br><span class="line">                ByteBufferInputStream.byteBuffer2Record(request.request, setDataRequest);</span><br><span class="line">            path = setDataRequest.getPath();</span><br><span class="line">            validatePath(path, request.sessionId);</span><br><span class="line">            nodeRecord = getRecordForPath(path);</span><br><span class="line">            checkACL(zks, nodeRecord.acl, ZooDefs.Perms.WRITE,</span><br><span class="line">                    request.authInfo);</span><br><span class="line">            version = setDataRequest.getVersion();</span><br><span class="line">            <span class="keyword">int</span> currentVersion = nodeRecord.stat.getVersion();</span><br><span class="line">            <span class="keyword">if</span> (version != -<span class="number">1</span> &amp;&amp; version != currentVersion) {  <span class="comment">// CAS</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.BadVersionException(path);</span><br><span class="line">            }</span><br><span class="line">            version = currentVersion + <span class="number">1</span>;</span><br><span class="line">            request.txn = <span class="keyword">new</span> SetDataTxn(path, setDataRequest.getData(), version);</span><br><span class="line">            nodeRecord = nodeRecord.duplicate(request.hdr.getZxid());</span><br><span class="line">            nodeRecord.stat.setVersion(version);</span><br><span class="line">            addChangeRecord(nodeRecord);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> OpCode.setACL: <span class="comment">//...</span></span><br><span class="line">        <span class="keyword">case</span> OpCode.createSession: <span class="comment">//...</span></span><br><span class="line">        <span class="keyword">case</span> OpCode.closeSession: <span class="comment">//...</span></span><br><span class="line">        <span class="keyword">case</span> OpCode.check: <span class="comment">//...</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="ZooKeeper-连接地址列表的连接策略"><a href="#ZooKeeper-连接地址列表的连接策略" class="headerlink" title="ZooKeeper 连接地址列表的连接策略"></a>ZooKeeper 连接地址列表的连接策略</h4><p>　ZooKeeper 考虑到第一次连接的时候，使用 <code>StaticHostProvider#resolveAndShuffle</code> 方法进行一次 shuffle，避免第一台节点处于热点状态；而 ZooKeeper 的 Session 连接断开之后，会使用 <code>StaticHostProvider#next</code> 方法，从第一个连接地址开始逐个尝试；另外，在集群<code>扩容/缩容</code>的时候，使用 <code>StaticHostProvider#updateServerList</code> 方法，更新服务器列表，并计算集群扩容的概率，对连接做重新分配，使得集群的负载更加均衡</p>
<h4 id="Follower-和-Observer-请求转发"><a href="#Follower-和-Observer-请求转发" class="headerlink" title="Follower 和 Observer 请求转发"></a>Follower 和 Observer 请求转发</h4><p>　为了事务的一致性，所有 Follower、Observer 接收到的事务请求，都会通过 <code>Learner#request</code> 方法，将请求发送给 Leader 节点来处理</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// org.apache.zookeeper.server.quorum.FollowerRequestProcessor | ObserverRequestProcessor</span></span><br><span class="line"><span class="keyword">switch</span> (request.type) {</span><br><span class="line">    <span class="keyword">case</span> OpCode.sync:</span><br><span class="line">        zks.pendingSyncs.add(request);</span><br><span class="line">        zks.getFollower().request(request);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> OpCode.create:</span><br><span class="line">    <span class="keyword">case</span> OpCode.create2:</span><br><span class="line">    <span class="keyword">case</span> OpCode.createTTL:</span><br><span class="line">    <span class="keyword">case</span> OpCode.createContainer:</span><br><span class="line">    <span class="keyword">case</span> OpCode.delete:</span><br><span class="line">    <span class="keyword">case</span> OpCode.deleteContainer:</span><br><span class="line">    <span class="keyword">case</span> OpCode.setData:</span><br><span class="line">    <span class="keyword">case</span> OpCode.reconfig:</span><br><span class="line">    <span class="keyword">case</span> OpCode.setACL:</span><br><span class="line">    <span class="keyword">case</span> OpCode.multi:</span><br><span class="line">    <span class="keyword">case</span> OpCode.check:</span><br><span class="line">        zks.getFollower().request(request);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> OpCode.createSession:</span><br><span class="line">    <span class="keyword">case</span> OpCode.closeSession:</span><br><span class="line">        <span class="comment">// Do not forward local sessions to the leader.</span></span><br><span class="line">        <span class="keyword">if</span> (!request.isLocalSession()) {</span><br><span class="line">            zks.getFollower().request(request);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Watch-事件触发流程"><a href="#Watch-事件触发流程" class="headerlink" title="Watch 事件触发流程"></a>Watch 事件触发流程</h4><p>　所有的 Watch 事件都通过 <code>WatchManager#triggerWatch</code> 进行触发。该方法会从 <code>HashMap&lt;String, HashSet&lt;Watcher&gt;&gt;</code> <code>watchTable</code> 中，通过 <code>ServerCnxn#process</code> 方法，将 <code>Watch</code> 对象取出（<code>HashMap#remove</code> 意味着 Watch 只会在 ZooKeeper 触发一次，不过 Curator 框架中已封装，只需注册一次，可多次触发 Watch 事件），并随后通过 <code>ServerCnxn#sendResponse</code> 封装并发送网络包</p>
<p>　由此可见，如果 Socket 通讯出现<strong>网络故障</strong>等问题，可能会丢失 Watch 事件。同时，因为注册一次之后，<code>Watcher</code> 就会从 <code>watchTable</code> 中被移除，<strong>再次注册完成之前</strong>，发生的 Watch 事件，将无法被监控到。并且，如果 Client 端和 Server 端断开连接之后，因为服务端并没有对 Watch 事件做任何留存，所以重连之后也是无法接受到任何 Watch 事件的（因此，程序中需要在接收到 disconnect 事件之后，进入某种<strong>安全模式</strong>，使得程序更为谨慎地处理 “依赖于 ZooKeeper Watch 的操作”）。另外，还要一个需要注意的地方是，同一个 ZNode 节点被 Watch 了多种事件，针对该 ZNode 节点 Client 端<strong>只会获取到一个 Watch 事件</strong>（例如，监控 ZNode A 的 <code>exists</code> / <code>getData</code> 事件，在删除了 A 之后，Client 端只会接受到一个 Delete 事件）</p>
<p>　总而言之，强依赖于 ZooKeeper Watch 事件的程序逻辑，都是不可靠的</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// [NIO 相关的流程]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.zookeeper.server.NIOServerCnxn#sendResponse</span></span><br><span class="line"><span class="comment">// org.apache.zookeeper.server.NIOServerCnxn#sendBuffer</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Queue&lt;ByteBuffer&gt; outgoingBuffers = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;();</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendBuffer</span><span class="params">(ByteBuffer bb)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (LOG.isTraceEnabled()) {</span><br><span class="line">        LOG.trace(<span class="string">"Add a buffer to outgoingBuffers, sk "</span> + sk + <span class="string">" is valid: "</span> + sk.isValid());</span><br><span class="line">    }</span><br><span class="line">    outgoingBuffers.add(bb);</span><br><span class="line">    requestInterestOpsUpdate();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// Queue&lt;ByteBuffer&gt; 队列被异步发送，整个调用流程如下：</span></span><br><span class="line"><span class="comment">// org.apache.zookeeper.server.quorum.QuorumPeerMain#main</span></span><br><span class="line"><span class="comment">// org.apache.zookeeper.server.quorum.QuorumPeerMain#initializeAndRun</span></span><br><span class="line"><span class="comment">// org.apache.zookeeper.server.quorum.QuorumPeerMain#runFromConfig</span></span><br><span class="line"><span class="comment">// org.apache.zookeeper.server.NIOServerCnxnFactory#configure</span></span><br><span class="line"><span class="comment">// org.apache.zookeeper.server.NIOServerCnxnFactory#ZOOKEEPER_NIO_NUM_SELECTOR_THREADS</span></span><br><span class="line">如果没有配置该选项，则默认使用 Math.max((<span class="keyword">int</span>) Math.sqrt((<span class="keyword">float</span>) numCores/<span class="number">2</span>), <span class="number">1</span>) 公式进行计算 SelectorThread 的线程数量</span><br><span class="line"><span class="comment">// org.apache.zookeeper.server.NIOServerCnxnFactory.SelectorThread#run</span></span><br><span class="line"><span class="comment">// org.apache.zookeeper.server.NIOServerCnxnFactory.SelectorThread#select</span></span><br><span class="line"><span class="comment">// org.apache.zookeeper.server.NIOServerCnxnFactory.SelectorThread#handleIO</span></span><br><span class="line"><span class="comment">// org.apache.zookeeper.server.WorkerService#schedule(org.apache.zookeeper.server.WorkerService.WorkRequest)</span></span><br><span class="line"><span class="comment">// org.apache.zookeeper.server.WorkerService#schedule(org.apache.zookeeper.server.WorkerService.WorkRequest, long)</span></span><br><span class="line">worker.execute(scheduledWorkRequest);  <span class="comment">// 启动 ExecutorService</span></span><br><span class="line"><span class="comment">// org.apache.zookeeper.server.WorkerService.ScheduledWorkRequest#run</span></span><br><span class="line"><span class="comment">// org.apache.zookeeper.server.NIOServerCnxnFactory.IOWorkRequest#doWork</span></span><br><span class="line"><span class="comment">// org.apache.zookeeper.server.NIOServerCnxn#doIO</span></span><br><span class="line"><span class="comment">// org.apache.zookeeper.server.NIOServerCnxn#handleWrite</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// [Netty 相关的流程]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.zookeeper.server.NettyServerCnxn#sendResponse</span></span><br><span class="line"><span class="comment">// org.apache.zookeeper.server.NettyServerCnxn#sendBuffer</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendBuffer</span><span class="params">(ByteBuffer sendBuffer)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (sendBuffer == ServerCnxnFactory.closeConn) {</span><br><span class="line">        close();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    channel.write(wrappedBuffer(sendBuffer));</span><br><span class="line">    packetSent();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="mntr-四字命令使用-JVMFLAGS-和-SERVER-JVMFLAGS-中配置的-JVM-参数"><a href="#mntr-四字命令使用-JVMFLAGS-和-SERVER-JVMFLAGS-中配置的-JVM-参数" class="headerlink" title="mntr 四字命令使用 JVMFLAGS 和 SERVER_JVMFLAGS 中配置的 JVM 参数"></a>mntr 四字命令使用 JVMFLAGS 和 SERVER_JVMFLAGS 中配置的 JVM 参数</h4><p>　通过增加 <code>START_SERVER_JVMFLAGS</code> 参数，来避免这个问题（已提交 PR<a href="https://github.com/apache/zookeeper/pull/302">#302</a>）</p>
<h3 id="架构设计"><a href="#架构设计" class="headerlink" title="架构设计"></a>架构设计</h3><h4 id="ZooKeeper-的-Server-ID-如果重复会有什么风险？"><a href="#ZooKeeper-的-Server-ID-如果重复会有什么风险？" class="headerlink" title="ZooKeeper 的 Server ID 如果重复会有什么风险？"></a>ZooKeeper 的 Server ID 如果重复会有什么风险？</h4><p>　截止 v3.5.3 并没有对这个问题进行代码层级的限制，已提交 <a href="https://issues.apache.org/jira/browse/ZOOKEEPER-2784">ZOOKEEPER-2784</a> issues 和 对应的 <a href="https://github.com/apache/zookeeper/pull/257">#257</a> PR，进行反馈和修复</p>
<h4 id="ZooKeeper-的事务-ID-超过-32-位，ZooKeeper-的-Leader-节点抛出-XidRolloverException-强制进行-re-election"><a href="#ZooKeeper-的事务-ID-超过-32-位，ZooKeeper-的-Leader-节点抛出-XidRolloverException-强制进行-re-election" class="headerlink" title="ZooKeeper 的事务 ID 超过 32 位，ZooKeeper 的 Leader 节点抛出 XidRolloverException 强制进行 re-election"></a>ZooKeeper 的事务 ID 超过 32 位，ZooKeeper 的 Leader 节点抛出 XidRolloverException <a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1277">强制进行 re-election</a></h4><p>　<a href="http://zookeeper.apache.org/doc/current/zookeeperInternals.html">ZXID</a> 的高 32 位用于 <code>epoch（LE 选举轮次）</code>、低 32 位是一个记录 <code>Leader</code> 节点每一次改动的 <code>counter</code><br>　如果是 1k/s ops，那么只要 $2^{32} / (86400 * 1000)$ $\approx 49.7$ days 就会将 ZXID 耗尽</p>
<h5 id="重度依赖-ZooKeeper-的应用，可能一周内发生-ZooKeeper-自重启一两次，每次需-30-秒，有无更好的解决方法"><a href="#重度依赖-ZooKeeper-的应用，可能一周内发生-ZooKeeper-自重启一两次，每次需-30-秒，有无更好的解决方法" class="headerlink" title="重度依赖 ZooKeeper 的应用，可能一周内发生 ZooKeeper 自重启一两次，每次需 30 秒，有无更好的解决方法"></a>重度依赖 ZooKeeper 的应用，可能一周内发生 ZooKeeper 自重启一两次，每次需 30 秒，有无更好的解决方法</h5><p>　在 <code>ZXID</code> 快要溢出的时候，一次性进行自重启的所有操作，必然会比较慢。可以考虑把非依赖的关键步骤拆开，提前做好自重启的准备，以减少延迟<br></p><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * create a proposal and send it out to all the members</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the proposal that is queued to send to all the members</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Proposal <span class="title">propose</span><span class="params">(Request request)</span> <span class="keyword">throws</span> XidRolloverException </span>{</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Address the rollover issue. All lower 32bits set indicate a new leader</span></span><br><span class="line"><span class="comment">     * election. Force a re-election instead. See ZOOKEEPER-1277</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> ((request.zxid &amp; <span class="number">0xffffffffL</span>) == <span class="number">0xffffffffL</span>) {</span><br><span class="line">        String msg = <span class="string">"zxid lower 32 bits have rolled over, forcing re-election, and therefore new epoch start"</span>;</span><br><span class="line">        shutdown(msg);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> XidRolloverException(msg);</span><br><span class="line">    } <span class="comment">// ...</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><br>　或者，重新设计 ZXID，高 24 位用于 epoch，低 40 位用于 counter，那么意味着 Math.min($2^{24}$ / 365 / 24, $2^{40}$ / 365 / 86400 / 1000) $\approx$ Math.min(1915.2, 34.9) = 34.9 years 之后才会进行一次强制选举。不过考虑到 <code>ZXID</code> 是 <code>long</code> 类型，32 bit 的 JVM 在对 <code>long</code> 读写时（和 <code>double</code> 类型一样），是分为高 32 位和 低 32 位两部分进行操作的，由于 <code>ZXID</code> 变量没有用 <code>volatile</code> 修饰，且也没有装箱为对应的引用类型（<code>Long</code> / <code>Double</code>），属于<a href="https://docs.oracle.com/javase/specs/jls/se8/html/jls-17.html#jls-17.7">非原子操作</a>。因此，如果将高 32 位的低 8 位划分给整个 <code>long</code> 的低 32 位，就可能存在并发的问题了（已提交 <a href="https://issues.apache.org/jira/browse/ZOOKEEPER-2789">Jira</a> / <a href="https://github.com/apache/zookeeper/pull/262">PR</a>，欢迎加入讨论）<p></p>
<h2 id="常见误区"><a href="#常见误区" class="headerlink" title="常见误区"></a>常见误区</h2><h3 id="Paxos-的强一致性"><a href="#Paxos-的强一致性" class="headerlink" title="Paxos 的强一致性"></a>Paxos 的强一致性</h3><p>　Paxos 本身只是用来选主的算法，用来在分布式节点之间达成<code>共识</code>（Consensus）。只有到了上层应用（ZooKeeper / <a href="https://yuzhouwan.com/posts/2129/">Redis</a>），出现 数据“副本”的概念，在维持其<code>一致性</code>（Consistency）的时候 才会有强弱之分（一致性模型 vs 一致性协议）<br>　而且，整个副本系统的一致性级别，并不只取决于<code>共识算法</code>，客户端的实现规范也会起到关键作用。如果，Client 客户端允许访问 <code>非 Leader 节点</code> 获取数据，而<code>过半写成功</code>导致有部分 <code>Follower 节点</code>数据副本并没有完成更新（也可以调用 <code>sync()</code> 方法完成强制同步），仍然会表现出弱一致性</p>
<div class="note info">因为 ZooKeeper 存在可能长时间选举而服务不可用的情况，所以它是 CP 型系统</div>


<h3 id="有了逻辑时钟后，物理时钟就不再需要了"><a href="#有了逻辑时钟后，物理时钟就不再需要了" class="headerlink" title="有了逻辑时钟后，物理时钟就不再需要了"></a>有了逻辑时钟后，物理时钟就不再需要了</h3><p><img data-src="/picture/zk/zk_lamport_logic_clock.png" alt=""></p>
<center>（图片来源：<a href="https://commons.wikimedia.org/wiki/File:Lamport-Clock-en.svg" target="_blank">wikimedia.org</a>，已确认版权为 CC BY-SA 3.0 协议）</center>


<p>　上图就是一个经典的 <code>Lamport</code> 逻辑时钟图，大致的算法描述如下（详见该篇<a href="http://amturing.acm.org/p558-lamport.pdf">论文</a>）：</p>
<ul>
<li>每个事件对应一个 <code>Lamport</code> 时间戳（初始值为 <code>0</code>）</li>
<li>如果，事件在自己本节点内发生，时间戳加 <code>1</code> 即可</li>
<li>如果，事件属于<strong>发送事件</strong>，时间戳加 <code>1</code> 并在消息中带上该时间戳</li>
<li>如果，事件属于<strong>接收事件</strong>，时间戳 = Max(本地时间戳，消息中的时间戳) + 1</li>
</ul>
<p>　并且规定，Lamport 逻辑时钟内做<code>全序</code>，是按事件的时间戳大小为时间排序的，任何两个事件不可能在同一时间发生（并发发生的 <code>B4</code> 和 <code>C3</code> 被认为是有先后顺序的，这里直接按照<code>进程 ID</code> 的大小认定事件发生顺序），并且任何消息收到的时间都应该比发送的时间晚</p>
<p>　同时，如果 <code>B4</code> 和 <code>C3</code> 两个事件之间，在逻辑时钟系统之外，有额外的操作，使其有了依赖关系 <code>B4 -&gt; C3</code>，如果 C 进程的 ID 又大于 B 进程的 ID，则无法完成<code>全序</code>操作。因此，需要通过 FTP 时钟同步 或者 Berkeley 算法去调整误差 的方式加入<strong>物理时钟</strong>。物理时钟的引入，是为了能够区分，系统是处于事件间隔中，还是出错中断了（有兴趣，还可深入研究下 Lamport Logic Lock 的演化版 Vector clock）</p>
<h2 id="依赖组件梳理"><a href="#依赖组件梳理" class="headerlink" title="依赖组件梳理"></a>依赖组件梳理</h2><h3 id="梳理点"><a href="#梳理点" class="headerlink" title="梳理点"></a>梳理点</h3><ul>
<li>依赖框架中哪部分组件在使用 ZooKeeper，以及使用方式</li>
<li>存储的数据（路径、大小、读写的频率 等）</li>
<li>对 ZooKeeper 可能产生的压力（并发度、Watcher 数 等）</li>
<li>是否对 ZooKeeper 强依赖</li>
</ul>
<h3 id="依赖-ZooKeeper-的框架"><a href="#依赖-ZooKeeper-的框架" class="headerlink" title="依赖 ZooKeeper 的框架"></a>依赖 ZooKeeper 的框架</h3><h4 id="Yarn"><a href="#Yarn" class="headerlink" title="Yarn"></a>Yarn</h4><h5 id="遇到的坑-1"><a href="#遇到的坑-1" class="headerlink" title="遇到的坑"></a>遇到的坑</h5><h6 id="滚动重启升级-ZooKeeper-之后，Yarn-一直重试"><a href="#滚动重启升级-ZooKeeper-之后，Yarn-一直重试" class="headerlink" title="滚动重启升级 ZooKeeper 之后，Yarn 一直重试"></a>滚动重启升级 ZooKeeper 之后，Yarn 一直重试</h6><ul>
<li><p>描述</p>
<p>一直重连的原因是，Yarn 发送的数据包超过了 1MB <code>（我们遇到的情况是 1.3MB）</code>，服务端默认会设置 1MB 的阀值，避免影响 ZooKeeper 自身的服务</p>
</li>
<li><p>解决</p>
<p>重启 ResourceManager 即可</p>
</li>
</ul>
<h4 id="HBase"><a href="#HBase" class="headerlink" title="HBase"></a><a href="https://yuzhouwan.com/posts/45888/">HBase</a></h4><h5 id="遇到的坑-2"><a href="#遇到的坑-2" class="headerlink" title="遇到的坑"></a>遇到的坑</h5><h6 id="KeeperErrorCode-Session-expired-for-hbase-meta-region-server"><a href="#KeeperErrorCode-Session-expired-for-hbase-meta-region-server" class="headerlink" title="KeeperErrorCode = Session expired for /hbase/meta-region-server"></a>KeeperErrorCode = Session expired for /hbase/meta-region-server</h6><ul>
<li><p>描述<br> 连接 HBase 的 Client 突然一段时间 间歇性地报错 <code>KeeperErrorCode = Session expired for /hbase/meta-region-server</code></p>
</li>
<li><p>解决</p>
<ul>
<li>查看 HBase、ZooKeeper 的日志和监控告警，并没有发现异常（也就是说，集群没有故障，也没有出现负载过大的情况）</li>
<li>发现 <code>/hbase/meta-region-server</code> ZNode 结点保存的信息（meta 表存在于哪一个 RegionServer），并没有和 HBase 集群真实的情况不一致。并且，meta 表的迁移，除非机房断电之类的异常情况，一般是很少发生的</li>
<li>尝试在 HBase Client 端的程序，加上 <code>-verbose:gc -XX:+PrintGCDetails -XX:+PrintGCDateStamps -Xloggc:gc.log</code> 的 JVM 参数，来观察是否是客户端程序发生 Long GC 导致的</li>
</ul>
</li>
</ul>
<h6 id="fsync-ing-the-write-ahead-log-in-SyncThread-1-took-5051ms-which-will-adversely-effect-operation-latency"><a href="#fsync-ing-the-write-ahead-log-in-SyncThread-1-took-5051ms-which-will-adversely-effect-operation-latency" class="headerlink" title="fsync-ing the write ahead log in SyncThread:1 took 5051ms which will adversely effect operation latency"></a>fsync-ing the write ahead log in SyncThread:1 took 5051ms which will adversely effect operation latency</h6><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">2017-06-28 15:28:01,149 [myid:1] - WARN  [QuorumPeer[myid=1]/0:0:0:0:0:0:0:0:2181:Follower@89] - Exception when following the leader</span><br><span class="line">java.io.EOFException</span><br><span class="line">        at java.io.DataInputStream.readInt(DataInputStream.java:392)</span><br><span class="line">        at org.apache.jute.BinaryInputArchive.readInt(BinaryInputArchive.java:63)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.QuorumPacket.deserialize(QuorumPacket.java:83)</span><br><span class="line">        at org.apache.jute.BinaryInputArchive.readRecord(BinaryInputArchive.java:103)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.Learner.readPacket(Learner.java:153)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.Follower.followLeader(Follower.java:85)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:786)</span><br><span class="line">2017-06-28 15:28:02,198 [myid:1] - INFO  [QuorumPeer[myid=1]/0:0:0:0:0:0:0:0:2181:Follower@166] - shutdown called</span><br><span class="line">java.lang.Exception: shutdown Follower</span><br><span class="line">        at org.apache.zookeeper.server.quorum.Follower.shutdown(Follower.java:166)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:790)</span><br><span class="line">2017-06-28 15:28:02,198 [myid:1] - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxnFactory@197] - Accepted socket connection from /0:0:0:0:0:0:0:1:39781</span><br><span class="line">2017-06-28 15:28:02,198 [myid:1] - ERROR [FollowerRequestProcessor:1:FollowerRequestProcessor@93] - Unexpected exception causing <span class="built_in">exit</span></span><br><span class="line">java.net.SocketException: Socket closed</span><br><span class="line">        at java.net.SocketOutputStream.socketWrite(SocketOutputStream.java:121)</span><br><span class="line">        at java.net.SocketOutputStream.write(SocketOutputStream.java:159)</span><br><span class="line">        at java.io.BufferedOutputStream.flushBuffer(BufferedOutputStream.java:82)</span><br><span class="line">        at java.io.BufferedOutputStream.flush(BufferedOutputStream.java:140)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.Learner.writePacket(Learner.java:139)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.Learner.request(Learner.java:188)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.FollowerRequestProcessor.run(FollowerRequestProcessor.java:88)</span><br><span class="line">2017-06-28 15:28:02,198 [myid:1] - WARN  [SyncThread:1:FileTxnLog@334] - fsync-ing the write ahead <span class="built_in">log</span> <span class="keyword">in</span> SyncThread:1 took 5051ms <span class="built_in">which</span> will adversely effect operation latency. See the ZooKeeper troubleshooting guide</span><br><span class="line">2017-06-28 15:28:02,198 [myid:1] - INFO  [QuorumPeer[myid=1]/0:0:0:0:0:0:0:0:2181:NIOServerCnxn@1007] - Closed socket connection <span class="keyword">for</span> client /10.37.2.145:47384 <span class="built_in">which</span> had sessionid 0x15cc330c7d99117</span><br><span class="line">2017-06-28 15:28:02,199 [myid:1] - WARN  [SyncThread:1:SendAckRequestProcessor@64] - Closing connection to leader, exception during packet send</span><br><span class="line">java.net.SocketException: Socket closed</span><br><span class="line">        at java.net.SocketOutputStream.socketWrite(SocketOutputStream.java:121)</span><br><span class="line">        at java.net.SocketOutputStream.write(SocketOutputStream.java:159)</span><br><span class="line">        at java.io.BufferedOutputStream.flushBuffer(BufferedOutputStream.java:82)</span><br><span class="line">        at java.io.BufferedOutputStream.flush(BufferedOutputStream.java:140)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.Learner.writePacket(Learner.java:139)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.SendAckRequestProcessor.flush(SendAckRequestProcessor.java:62)</span><br><span class="line">        at org.apache.zookeeper.server.SyncRequestProcessor.flush(SyncRequestProcessor.java:204)</span><br><span class="line">        at org.apache.zookeeper.server.SyncRequestProcessor.run(SyncRequestProcessor.java:131)</span><br><span class="line">2017-06-28 15:28:02,198 [myid:1] - INFO  [FollowerRequestProcessor:1:FollowerRequestProcessor@95] - FollowerRequestProcessor exited loop!</span><br></pre></td></tr></tbody></table></figure>
<p>　<code>FollowerRequestProcessor.java:88</code> 这行代码是 <code>OpCode.closeSession</code> 操作转发给 Leader，需要发送一个请求包，但是网络问题导致 Socket 连接断开了；另外，<code>fsync-ing the write ahead log in SyncThread:1 took 5051ms which will adversely effect operation latency</code> 告警，意味着 <code>FileTxnLog#commit</code> 进行写事务日志到磁盘的过程过慢</p>
<p>　这里可能会导致一个疑问，到底是因为需要写入的事务日志过大导致的告警，还是因为机器磁盘当前的 I/O 负载比较高，所以这里最好再打印出 <code>FileChannel#size()</code> 的信息（已提交 PR<a href="https://github.com/apache/zookeeper/pull/296">#296</a>）</p>
<h4 id="Druid"><a href="#Druid" class="headerlink" title="Druid"></a><a href="https://yuzhouwan.com/posts/5845/">Druid</a></h4><h5 id="遇到的坑-3"><a href="#遇到的坑-3" class="headerlink" title="遇到的坑"></a>遇到的坑</h5><h6 id="DruidTaskResolver-Poll-failed-trying-again"><a href="#DruidTaskResolver-Poll-failed-trying-again" class="headerlink" title="DruidTaskResolver: Poll failed, trying again"></a>DruidTaskResolver: Poll failed, trying again</h6><ul>
<li><p>描述</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">28 Feb 2018 10:41:45,065 WARN  [DruidTaskResolver[com.metamx.tranquility.druid.IndexService@214fd977]] (?.?:?)  - Poll failed, trying again at[2018-02-28T10:42:03.867+08:00].</span><br><span class="line">java.lang.IllegalStateException: Service is closed</span><br><span class="line">	at com.metamx.tranquility.druid.IndexService.com<span class="variable">$metamx</span><span class="variable">$tranquility</span><span class="variable">$druid</span><span class="variable">$IndexService</span>$<span class="variable">$client</span>(IndexService.scala:57)</span><br><span class="line">	at com.metamx.tranquility.druid.IndexService$<span class="variable">$anonfun</span><span class="variable">$call</span><span class="variable">$1</span>.apply(IndexService.scala:131)</span><br><span class="line">	at com.metamx.tranquility.druid.IndexService$<span class="variable">$anonfun</span><span class="variable">$call</span><span class="variable">$1</span>.apply(IndexService.scala:131)</span><br><span class="line">	at com.metamx.tranquility.finagle.FutureRetry$.onErrors(FutureRetry.scala:47)</span><br><span class="line">	at com.metamx.tranquility.druid.IndexService.call(IndexService.scala:130)</span><br><span class="line">	at com.metamx.tranquility.druid.IndexService.runningTasks(IndexService.scala:101)</span><br><span class="line">	at com.metamx.tranquility.finagle.DruidTaskResolver$<span class="variable">$anon</span><span class="variable">$1</span>.run(DruidTaskResolver.scala:83)</span><br><span class="line">	at java.util.concurrent.Executors<span class="variable">$RunnableAdapter</span>.call(Executors.java:511)</span><br><span class="line">	at java.util.concurrent.FutureTask.run(FutureTask.java:266)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor<span class="variable">$Worker</span>.run(ThreadPoolExecutor.java:617)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:745)</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>解决</p>
<p>定位原因是 Apache Curator 2.11.1 的 bug（详见 <a href="https://issues.apache.org/jira/browse/CURATOR-394">CURATOR-394</a> 和 <a href="https://github.com/apache/curator/pull/208">PR#208</a>），将 patch 代码合进 Curator 的 curator-x-discovery 模块后，重新打包 curator-x-discovery-2.11.1.jar，并替换原生的，即可</p>
</li>
</ul>
<h4 id="Storm"><a href="#Storm" class="headerlink" title="Storm"></a><a href="https://yuzhouwan.com/posts/13977/">Storm</a></h4><h5 id="遇到的坑-4"><a href="#遇到的坑-4" class="headerlink" title="遇到的坑"></a>遇到的坑</h5><h6 id="Unable-to-load-database-on-disk"><a href="#Unable-to-load-database-on-disk" class="headerlink" title="Unable to load database on disk"></a>Unable to load database on disk</h6><ul>
<li><p>描述</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">2017-12-08 22:01:01,943 [myid:4] - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxnFactory@197] - Accepted socket connection from /0:0:0:0:0:0:0:1:24756</span><br><span class="line">2017-12-08 22:01:01,943 [myid:4] - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@838] - Processing srst <span class="built_in">command</span> from /0:0:0:0:0:0:0:1:24756</span><br><span class="line">2017-12-08 22:01:01,944 [myid:4] - INFO  [Thread-342422:NIOServerCnxn@1018] - Closed socket connection <span class="keyword">for</span> client /0:0:0:0:0:0:0:1:24756 (no session established <span class="keyword">for</span> client)</span><br><span class="line">2017-12-08 22:02:01,111 [myid:4] - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxnFactory@197] - Accepted socket connection from /0:0:0:0:0:0:0:1:25076</span><br><span class="line">2017-12-08 22:02:01,111 [myid:4] - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@838] - Processing ruok <span class="built_in">command</span> from /0:0:0:0:0:0:0:1:25076</span><br><span class="line">2017-12-08 22:02:01,112 [myid:4] - INFO  [Thread-342423:NIOServerCnxn@1018] - Closed socket connection <span class="keyword">for</span> client /0:0:0:0:0:0:0:1:25076 (no session established <span class="keyword">for</span> client)</span><br><span class="line">22017-12-08 22:46:17,702 [myid:] - INFO  [main:QuorumPeerConfig@103] - Reading configuration from: /home/zookeeper/software/zookeeper/bin/../conf/zoo.cfg</span><br><span class="line">2017-12-08 22:46:17,730 [myid:] - INFO  [main:QuorumPeerConfig@340] - Defaulting to majority quorums</span><br><span class="line">2017-12-08 22:46:17,793 [myid:4] - INFO  [main:DatadirCleanupManager@78] - autopurge.snapRetainCount <span class="built_in">set</span> to 3</span><br><span class="line">2017-12-08 22:46:17,794 [myid:4] - INFO  [main:DatadirCleanupManager@79] - autopurge.purgeInterval <span class="built_in">set</span> to 1</span><br><span class="line">2017-12-08 22:46:17,796 [myid:4] - INFO  [PurgeTask:DatadirCleanupManager<span class="variable">$PurgeTask</span>@138] - Purge task started.</span><br><span class="line">2017-12-08 22:46:17,855 [myid:4] - INFO  [main:QuorumPeerMain@127] - Starting quorum peer</span><br><span class="line">2017-12-08 22:46:18,193 [myid:4] - INFO  [main:NIOServerCnxnFactory@94] - binding to port 0.0.0.0/0.0.0.0:2181</span><br><span class="line">2017-12-08 22:46:18,266 [myid:4] - INFO  [main:QuorumPeer@959] - tickTime <span class="built_in">set</span> to 2000</span><br><span class="line">2017-12-08 22:46:18,266 [myid:4] - INFO  [main:QuorumPeer@979] - minSessionTimeout <span class="built_in">set</span> to -1</span><br><span class="line">2017-12-08 22:46:18,266 [myid:4] - INFO  [main:QuorumPeer@990] - maxSessionTimeout <span class="built_in">set</span> to -1</span><br><span class="line">2017-12-08 22:46:18,266 [myid:4] - INFO  [main:QuorumPeer@1005] - initLimit <span class="built_in">set</span> to 10</span><br><span class="line">2017-12-08 22:46:18,650 [myid:4] - INFO  [main:FileSnap@83] - Reading snapshot /data/zookeeper/datadir/version-2/snapshot.e72200034</span><br><span class="line">2017-12-08 22:46:18,831 [myid:4] - INFO  [PurgeTask:DatadirCleanupManager<span class="variable">$PurgeTask</span>@144] - Purge task completed.</span><br><span class="line">2017-12-08 22:46:31,861 [myid:4] - ERROR [main:QuorumPeer@497] - Unable to load database on disk</span><br><span class="line">java.io.EOFException</span><br><span class="line">        at java.io.DataInputStream.readInt(DataInputStream.java:392)</span><br><span class="line">        at org.apache.jute.BinaryInputArchive.readInt(BinaryInputArchive.java:63)</span><br><span class="line">        at org.apache.zookeeper.server.persistence.FileHeader.deserialize(FileHeader.java:64)</span><br><span class="line">        at org.apache.zookeeper.server.persistence.FileTxnLog<span class="variable">$FileTxnIterator</span>.inStreamCreated(FileTxnLog.java:580)</span><br><span class="line">        at org.apache.zookeeper.server.persistence.FileTxnLog<span class="variable">$FileTxnIterator</span>.createInputArchive(FileTxnLog.java:599)</span><br><span class="line">        at org.apache.zookeeper.server.persistence.FileTxnLog<span class="variable">$FileTxnIterator</span>.goToNextLog(FileTxnLog.java:565)</span><br><span class="line">        at org.apache.zookeeper.server.persistence.FileTxnLog<span class="variable">$FileTxnIterator</span>.next(FileTxnLog.java:647)</span><br><span class="line">        at org.apache.zookeeper.server.persistence.FileTxnSnapLog.restore(FileTxnSnapLog.java:158)</span><br><span class="line">        at org.apache.zookeeper.server.ZKDatabase.loadDataBase(ZKDatabase.java:223)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.QuorumPeer.loadDataBase(QuorumPeer.java:450)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.QuorumPeer.start(QuorumPeer.java:440)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.QuorumPeerMain.runFromConfig(QuorumPeerMain.java:153)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.QuorumPeerMain.initializeAndRun(QuorumPeerMain.java:111)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.QuorumPeerMain.main(QuorumPeerMain.java:78)</span><br><span class="line">2017-12-08 22:46:31,868 [myid:4] - ERROR [main:QuorumPeerMain@89] - Unexpected exception, exiting abnormally</span><br><span class="line">java.lang.RuntimeException: Unable to run quorum server</span><br><span class="line">        at org.apache.zookeeper.server.quorum.QuorumPeer.loadDataBase(QuorumPeer.java:498)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.QuorumPeer.start(QuorumPeer.java:440)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.QuorumPeerMain.runFromConfig(QuorumPeerMain.java:153)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.QuorumPeerMain.initializeAndRun(QuorumPeerMain.java:111)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.QuorumPeerMain.main(QuorumPeerMain.java:78)</span><br><span class="line">Caused by: java.io.EOFException</span><br><span class="line">        at java.io.DataInputStream.readInt(DataInputStream.java:392)</span><br><span class="line">        at org.apache.jute.BinaryInputArchive.readInt(BinaryInputArchive.java:63)</span><br><span class="line">        at org.apache.zookeeper.server.persistence.FileHeader.deserialize(FileHeader.java:64)</span><br><span class="line">        at org.apache.zookeeper.server.persistence.FileTxnLog<span class="variable">$FileTxnIterator</span>.inStreamCreated(FileTxnLog.java:580)</span><br><span class="line">        at org.apache.zookeeper.server.persistence.FileTxnLog<span class="variable">$FileTxnIterator</span>.createInputArchive(FileTxnLog.java:599)</span><br><span class="line">        at org.apache.zookeeper.server.persistence.FileTxnLog<span class="variable">$FileTxnIterator</span>.goToNextLog(FileTxnLog.java:565)</span><br><span class="line">        at org.apache.zookeeper.server.persistence.FileTxnLog<span class="variable">$FileTxnIterator</span>.next(FileTxnLog.java:647)</span><br><span class="line">        at org.apache.zookeeper.server.persistence.FileTxnSnapLog.restore(FileTxnSnapLog.java:158)</span><br><span class="line">        at org.apache.zookeeper.server.ZKDatabase.loadDataBase(ZKDatabase.java:223)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.QuorumPeer.loadDataBase(QuorumPeer.java:450)</span><br><span class="line">        ... 4 more</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<ul>
<li><p>分析</p>
<p>可以看到 <code>2017-12-08 22:02:01,112</code> 到 <code>22017-12-08 22:46:17,702</code> 日志有一个断层，可以看出之前的日志写入被中断了（后续在 <code>/var/log/message</code> 系统日志里面也验证了）。基本可以确定是，单独挂的盘发生了故障，导致了 Snapshot 文件损坏。而自启动脚本尝试重启 ZooKeeper 进程的时候，ZooKeeper 会依据事务日志里面的最新的 ZXID，一直去尝试读取最后一个已损坏的 Snapshot 文件，导致一直无法恢复</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ vim /var/<span class="built_in">log</span>/messages</span><br><span class="line">  kernel: EXT4-fs (vdb): warning: mounting fs with errors, running e2fsck is recommended</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<ul>
<li><p>解决</p>
<p>因为 <code>EOFException</code> 导致当前 ZooKeeper 进程退出后，集群已经选主出新的 Leader 节点，所以，可以直接删除事务日志和 Snapshot 文件，分别对应于 <code>dataDir</code> 和 <code>dataLogDir</code> 两个目录（理论上只需要保存 <code>myid</code> 文件，其他数据会从 Leader 节点重新拉取）。删除数据完成之后，直接启动 ZooKeeper 进程，当前节点即可重新加入 ZooKeeper 集群</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 读取配置</span></span><br><span class="line">2017-12-08 23:20:07,161 [myid:] - INFO  [main:QuorumPeerConfig@103] - Reading configuration from: /home/zookeeper/software/zookeeper/bin/../conf/zoo.cfg</span><br><span class="line">2017-12-08 23:20:07,165 [myid:] - INFO  [main:QuorumPeerConfig@340] - Defaulting to majority quorums</span><br><span class="line">2017-12-08 23:20:07,168 [myid:4] - INFO  [main:DatadirCleanupManager@78] - autopurge.snapRetainCount <span class="built_in">set</span> to 3</span><br><span class="line">2017-12-08 23:20:07,169 [myid:4] - INFO  [main:DatadirCleanupManager@79] - autopurge.purgeInterval <span class="built_in">set</span> to 1</span><br><span class="line">2017-12-08 23:20:07,170 [myid:4] - INFO  [PurgeTask:DatadirCleanupManager<span class="variable">$PurgeTask</span>@138] - Purge task started.</span><br><span class="line">2017-12-08 23:20:07,179 [myid:4] - INFO  [PurgeTask:DatadirCleanupManager<span class="variable">$PurgeTask</span>@144] - Purge task completed.</span><br><span class="line">2017-12-08 23:20:07,181 [myid:4] - INFO  [main:QuorumPeerMain@127] - Starting quorum peer</span><br><span class="line">2017-12-08 23:20:07,191 [myid:4] - INFO  [main:NIOServerCnxnFactory@94] - binding to port 0.0.0.0/0.0.0.0:2181</span><br><span class="line">2017-12-08 23:20:07,201 [myid:4] - INFO  [main:QuorumPeer@959] - tickTime <span class="built_in">set</span> to 2000</span><br><span class="line">2017-12-08 23:20:07,202 [myid:4] - INFO  [main:QuorumPeer@979] - minSessionTimeout <span class="built_in">set</span> to -1</span><br><span class="line">2017-12-08 23:20:07,202 [myid:4] - INFO  [main:QuorumPeer@990] - maxSessionTimeout <span class="built_in">set</span> to -1</span><br><span class="line">2017-12-08 23:20:07,202 [myid:4] - INFO  [main:QuorumPeer@1005] - initLimit <span class="built_in">set</span> to 10</span><br><span class="line"><span class="comment"># 开始进行选举</span></span><br><span class="line">2017-12-08 23:20:07,214 [myid:4] - INFO  [main:QuorumPeer@473] - currentEpoch not found! Creating with a reasonable default of 0. This should only happen when you are upgrading your installation</span><br><span class="line">2017-12-08 23:20:07,223 [myid:4] - INFO  [main:QuorumPeer@488] - acceptedEpoch not found! Creating with a reasonable default of 0. This should only happen when you are upgrading your installation</span><br><span class="line">2017-12-08 23:20:07,228 [myid:4] - INFO  [Thread-2:QuorumCnxManager<span class="variable">$Listener</span>@505] - My election <span class="built_in">bind</span> port: /192.168.1.104:3888</span><br><span class="line"><span class="comment"># 进入 LOOKING 状态，并创建自己的选票</span></span><br><span class="line">2017-12-08 23:20:07,238 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:QuorumPeer@714] - LOOKING</span><br><span class="line">2017-12-08 23:20:07,243 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:FastLeaderElection@815] - New election. My id =  4, proposed zxid=0x0</span><br><span class="line">2017-12-08 23:20:07,250 [myid:4] - INFO  [WorkerReceiver[myid=4]:FastLeaderElection@597] - Notification: 1 (message format version), 5 (n.leader), 0xe72217dad (n.zxid), 0x6 (n.round), LOOKING (n.state), 1 (n.sid), 0xe (n.peerEpoch) LOOKING (my state)</span><br><span class="line">2017-12-08 23:20:07,250 [myid:4] - INFO  [WorkerReceiver[myid=4]:FastLeaderElection@597] - Notification: 1 (message format version), 5 (n.leader), 0xe72217dad (n.zxid), 0x6 (n.round), FOLLOWING (n.state), 1 (n.sid), 0xf (n.peerEpoch) LOOKING (my state)</span><br><span class="line">2017-12-08 23:20:07,252 [myid:4] - INFO  [WorkerReceiver[myid=4]:FastLeaderElection@597] - Notification: 1 (message format version), 4 (n.leader), 0x0 (n.zxid), 0x1 (n.round), LOOKING (n.state), 4 (n.sid), 0x0 (n.peerEpoch) LOOKING (my state)</span><br><span class="line">2017-12-08 23:20:07,253 [myid:4] - INFO  [WorkerReceiver[myid=4]:FastLeaderElection@597] - Notification: 1 (message format version), 5 (n.leader), 0xe72217dad (n.zxid), 0x6 (n.round), LOOKING (n.state), 3 (n.sid), 0xe (n.peerEpoch) LOOKING (my state)</span><br><span class="line">2017-12-08 23:20:07,253 [myid:4] - INFO  [WorkerReceiver[myid=4]:FastLeaderElection@597] - Notification: 1 (message format version), 5 (n.leader), 0xe72217dad (n.zxid), 0x6 (n.round), FOLLOWING (n.state), 3 (n.sid), 0xf (n.peerEpoch) LOOKING (my state)</span><br><span class="line">2017-12-08 23:20:07,253 [myid:4] - INFO  [WorkerSender[myid=4]:QuorumCnxManager@195] - Have smaller server identifier, so dropping the connection: (5, 4)</span><br><span class="line">2017-12-08 23:20:07,254 [myid:4] - INFO  [WorkerReceiver[myid=4]:FastLeaderElection@597] - Notification: 1 (message format version), 5 (n.leader), 0xe72217dad (n.zxid), 0x6 (n.round), LOOKING (n.state), 4 (n.sid), 0xe (n.peerEpoch) LOOKING (my state)</span><br><span class="line">2017-12-08 23:20:07,254 [myid:4] - INFO  [WorkerReceiver[myid=4]:FastLeaderElection@597] - Notification: 1 (message format version), 5 (n.leader), 0xe72217dad (n.zxid), 0x6 (n.round), FOLLOWING (n.state), 3 (n.sid), 0xf (n.peerEpoch) LOOKING (my state)</span><br><span class="line">2017-12-08 23:20:07,254 [myid:4] - INFO  [WorkerSender[myid=4]:QuorumCnxManager@195] - Have smaller server identifier, so dropping the connection: (5, 4)</span><br><span class="line">2017-12-08 23:20:07,254 [myid:4] - INFO  [WorkerReceiver[myid=4]:FastLeaderElection@597] - Notification: 1 (message format version), 5 (n.leader), 0xe72217dad (n.zxid), 0x6 (n.round), FOLLOWING (n.state), 1 (n.sid), 0xf (n.peerEpoch) LOOKING (my state)</span><br><span class="line">2017-12-08 23:20:07,255 [myid:4] - INFO  [WorkerReceiver[myid=4]:FastLeaderElection@597] - Notification: 1 (message format version), 5 (n.leader), 0xe72217dad (n.zxid), 0x6 (n.round), LOOKING (n.state), 4 (n.sid), 0xe (n.peerEpoch) LOOKING (my state)</span><br><span class="line">2017-12-08 23:20:07,272 [myid:4] - INFO  [/192.168.1.104:3888:QuorumCnxManager<span class="variable">$Listener</span>@512] - Received connection request /192.168.1.105:18290</span><br><span class="line">2017-12-08 23:20:07,273 [myid:4] - INFO  [/192.168.1.104:3888:QuorumCnxManager<span class="variable">$Listener</span>@512] - Received connection request /192.168.1.105:18291</span><br><span class="line">2017-12-08 23:20:07,274 [myid:4] - WARN  [RecvWorker:5:QuorumCnxManager<span class="variable">$RecvWorker</span>@781] - Connection broken <span class="keyword">for</span> id 5, my id = 4, error =</span><br><span class="line">java.io.EOFException</span><br><span class="line">        at java.io.DataInputStream.readInt(DataInputStream.java:392)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.QuorumCnxManager<span class="variable">$RecvWorker</span>.run(QuorumCnxManager.java:766)</span><br><span class="line">2017-12-08 23:20:07,296 [myid:4] - WARN  [RecvWorker:5:QuorumCnxManager<span class="variable">$RecvWorker</span>@784] - Interrupting SendWorker</span><br><span class="line">2017-12-08 23:20:07,295 [myid:4] - WARN  [SendWorker:5:QuorumCnxManager<span class="variable">$SendWorker</span>@698] - Interrupted <span class="keyword">while</span> waiting <span class="keyword">for</span> message on queue</span><br><span class="line">java.lang.InterruptedException</span><br><span class="line">        at java.util.concurrent.locks.AbstractQueuedSynchronizer<span class="variable">$ConditionObject</span>.reportInterruptAfterWait(AbstractQueuedSynchronizer.java:2017)</span><br><span class="line">        at java.util.concurrent.locks.AbstractQueuedSynchronizer<span class="variable">$ConditionObject</span>.awaitNanos(AbstractQueuedSynchronizer.java:2095)</span><br><span class="line">        at java.util.concurrent.ArrayBlockingQueue.poll(ArrayBlockingQueue.java:389)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.QuorumCnxManager.pollSendQueue(QuorumCnxManager.java:850)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.QuorumCnxManager.access<span class="variable">$500</span>(QuorumCnxManager.java:61)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.QuorumCnxManager<span class="variable">$SendWorker</span>.run(QuorumCnxManager.java:686)</span><br><span class="line">2017-12-08 23:20:07,280 [myid:4] - INFO  [WorkerReceiver[myid=4]:FastLeaderElection@597] - Notification: 1 (message format version), 5 (n.leader), 0xe72217dad (n.zxid), 0x6 (n.round), LOOKING (n.state), 2 (n.sid), 0xe (n.peerEpoch) LOOKING (my state)</span><br><span class="line">2017-12-08 23:20:07,297 [myid:4] - WARN  [SendWorker:5:QuorumCnxManager<span class="variable">$SendWorker</span>@707] - Send worker leaving thread</span><br><span class="line">2017-12-08 23:20:07,297 [myid:4] - INFO  [WorkerReceiver[myid=4]:FastLeaderElection@597] - Notification: 1 (message format version), 5 (n.leader), 0xe72217dad (n.zxid), 0x6 (n.round), FOLLOWING (n.state), 2 (n.sid), 0xf (n.peerEpoch) LOOKING (my state)</span><br><span class="line">2017-12-08 23:20:07,297 [myid:4] - INFO  [WorkerReceiver[myid=4]:FastLeaderElection@597] - Notification: 1 (message format version), 5 (n.leader), 0xe72217dad (n.zxid), 0x6 (n.round), LOOKING (n.state), 5 (n.sid), 0xe (n.peerEpoch) LOOKING (my state)</span><br><span class="line">2017-12-08 23:20:07,297 [myid:4] - INFO  [WorkerReceiver[myid=4]:FastLeaderElection@597] - Notification: 1 (message format version), 5 (n.leader), 0xe72217dad (n.zxid), 0x6 (n.round), LEADING (n.state), 5 (n.sid), 0xf (n.peerEpoch) LOOKING (my state)</span><br><span class="line"><span class="comment"># 经过 84ms，进入 FOLLOWING 状态，完成选举过程</span></span><br><span class="line">2017-12-08 23:20:07,298 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:QuorumPeer@784] - FOLLOWING</span><br><span class="line">2017-12-08 23:20:07,303 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:Learner@86] - TCP NoDelay <span class="built_in">set</span> to: <span class="literal">true</span></span><br><span class="line">2017-12-08 23:20:07,317 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:Environment@100] - Server environment:zookeeper.version=3.4.6--1, built on 08/30/2017 09:55 GMT</span><br><span class="line">2017-12-08 23:20:07,317 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:Environment@100] - Server environment:host.name=yuzhouwan-storm-4</span><br><span class="line">2017-12-08 23:20:07,317 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:Environment@100] - Server environment:java.version=1.7.0_60-ea</span><br><span class="line">2017-12-08 23:20:07,317 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:Environment@100] - Server environment:java.vendor=Oracle Corporation</span><br><span class="line">2017-12-08 23:20:07,317 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:Environment@100] - Server environment:java.home=/home/zookeeper/software/jdk1.7.0_60/jre</span><br><span class="line">2017-12-08 23:20:07,318 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:Environment@100] - Server environment:java.class.path=/home/zookeeper/software/zookeeper/bin/../build/classes:/home/zookeeper/software/zookeeper/bin/../build/lib/*.jar:/home/zookeeper/software/zookeeper/bin/../lib/slf4j-log4j12-1.6.1.jar:/home/zookeeper/software/zookeeper/bin/../lib/slf4j-api-1.6.1.jar:/home/zookeeper/software/zookeeper/bin/../lib/netty-3.7.0.Final.jar:/home/zookeeper/software/zookeeper/bin/../lib/log4j-1.2.16.jar:/home/zookeeper/software/zookeeper/bin/../lib/jline-0.9.94.jar:/home/zookeeper/software/zookeeper/bin/../zookeeper-3.4.6.4.jar:/home/zookeeper/software/zookeeper/bin/../src/java/lib/*.jar:/home/zookeeper/software/zookeeper/bin/../conf:/home/zookeeper/software/java/lib/dt.jar:/home/zookeeper/software/java/lib/tools.jar:.</span><br><span class="line">2017-12-08 23:20:07,318 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:Environment@100] - Server environment:java.library.path=/usr/java/packages/lib/amd64:/usr/lib64:/lib64:/lib:/usr/lib</span><br><span class="line">2017-12-08 23:20:07,318 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:Environment@100] - Server environment:java.io.tmpdir=/tmp</span><br><span class="line">2017-12-08 23:20:07,318 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:Environment@100] - Server environment:java.compiler=&lt;NA&gt;</span><br><span class="line">2017-12-08 23:20:07,318 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:Environment@100] - Server environment:os.name=Linux</span><br><span class="line">2017-12-08 23:20:07,318 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:Environment@100] - Server environment:os.arch=amd64</span><br><span class="line">2017-12-08 23:20:07,318 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:Environment@100] - Server environment:os.version=2.6.32-279.19.1.el6_sn.11.x86_64</span><br><span class="line">2017-12-08 23:20:07,318 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:Environment@100] - Server environment:user.name=zookeeper</span><br><span class="line">2017-12-08 23:20:07,318 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:Environment@100] - Server environment:user.home=/home/zookeeper</span><br><span class="line">2017-12-08 23:20:07,318 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:Environment@100] - Server environment:user.dir=/data/zookeeper</span><br><span class="line">2017-12-08 23:20:07,320 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:ZooKeeperServer@162] - Created server with tickTime 2000 minSessionTimeout 4000 maxSessionTimeout 40000 datadir /data/zookeeper/dataLogDir/version-2 snapdir /data/zookeeper/datadir/version-2</span><br><span class="line">2017-12-08 23:20:07,320 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:Follower@63] - FOLLOWING - LEADER ELECTION TOOK - 77</span><br><span class="line"><span class="comment"># 从 Leader 节点获取最新的 Snapshot 文件</span></span><br><span class="line">2017-12-08 23:20:07,335 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:Learner@326] - Getting a snapshot from leader</span><br><span class="line">2017-12-08 23:20:07,545 [myid:4] - WARN  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:Learner@374] - Got zxid 0xf001761dc expected 0x1</span><br><span class="line"><span class="comment"># 创建 Snapshot 文件（实际内容是 zxid - 1，而不是直接用最新的 zxid）</span></span><br><span class="line">2017-12-08 23:20:07,545 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:FileTxnSnapLog@240] - Snapshotting: 0xf001761db to /data/zookeeper/datadir/version-2/snapshot.f001761db</span><br><span class="line"><span class="comment"># 创建事务日志文件</span></span><br><span class="line">2017-12-08 23:20:07,655 [myid:4] - INFO  [SyncThread:4:FileTxnLog@203] - Creating new <span class="built_in">log</span> file: log.f001761dc</span><br><span class="line">2017-12-08 23:20:07,657 [myid:4] - WARN  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:Follower@118] - Got zxid 0xf00176261 expected 0x1</span><br><span class="line"><span class="comment"># 至此，完成最终恢复，历时 496ms</span></span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<h4 id="Flink"><a href="#Flink" class="headerlink" title="Flink"></a><a href="https://yuzhouwan.com/posts/20644/">Flink</a></h4><h5 id="遇到的坑-5"><a href="#遇到的坑-5" class="headerlink" title="遇到的坑"></a>遇到的坑</h5><h6 id="Node-not-empty-flink-sportsa-StarterALLJSPlaying-jobgraphs-6f96a21ae1aaf087b7423f504e554694"><a href="#Node-not-empty-flink-sportsa-StarterALLJSPlaying-jobgraphs-6f96a21ae1aaf087b7423f504e554694" class="headerlink" title="Node not empty: /flink/sportsa/StarterALLJSPlaying/jobgraphs/6f96a21ae1aaf087b7423f504e554694"></a>Node not empty: /flink/sportsa/StarterALLJSPlaying/jobgraphs/6f96a21ae1aaf087b7423f504e554694</h6><ul>
<li><p>描述</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 没有子目录也无法删除</span></span><br><span class="line">[zk: localhost:2181(CONNECTED) 1] ls /flink/sportsa/StarterALLJSPlaying/jobgraphs/6f96a21ae1aaf087b7423f504e554694</span><br><span class="line">  []</span><br><span class="line">[zk: localhost:2181(CONNECTED) 2] delete /flink/sportsa/StarterALLJSPlaying/jobgraphs/6f96a21ae1aaf087b7423f504e554694</span><br><span class="line">  Node not empty: /flink/sportsa/StarterALLJSPlaying/jobgraphs/6f96a21ae1aaf087b7423f504e554694</span><br><span class="line">[zk: localhost:2181(CONNECTED) 3] rmr /flink/sportsa/StarterALLJSPlaying/jobgraphs/6f96a21ae1aaf087b7423f504e554694</span><br><span class="line">  Node not empty: /flink/sportsa/StarterALLJSPlaying/jobgraphs/6f96a21ae1aaf087b7423f504e554694</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>解决</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 通过 get 命令发现，6f96a21ae1aaf087b7423f504e554694 本身就是有数据的</span></span><br><span class="line"><span class="comment"># 设置对应 version 为 '' 空字符串，再执行 delete 操作即可</span></span><br><span class="line">[zk: localhost:2181(CONNECTED) 12] <span class="built_in">set</span> /flink/sportsa/StarterALLJSPlaying/jobgraphs/6f96a21ae1aaf087b7423f504e554694 <span class="string">''</span> 1</span><br><span class="line">  cZxid = 0x1b01e697c7</span><br><span class="line">  ctime = Mon Jun 11 14:29:58 CST 2018</span><br><span class="line">  mZxid = 0x1b01ebc650</span><br><span class="line">  mtime = Mon Jun 11 17:04:50 CST 2018</span><br><span class="line">  pZxid = 0x1b01e6adb8</span><br><span class="line">  cversion = 2</span><br><span class="line">  dataVersion = 2</span><br><span class="line">  aclVersion = 0</span><br><span class="line">  ephemeralOwner = 0x0</span><br><span class="line">  dataLength = 0</span><br><span class="line">  numChildren = 0</span><br><span class="line">[zk: localhost:2181(CONNECTED) 13] delete /flink/sportsa/StarterALLJSPlaying/jobgraphs/6f96a21ae1aaf087b7423f504e554694</span><br><span class="line">[zk: localhost:2181(CONNECTED) 14] ls /flink/sportsa/StarterALLJSPlaying/jobgraphs/6f96a21ae1aaf087b7423f504e554694</span><br><span class="line">  Node does not exist: /flink/sportsa/StarterALLJSPlaying/jobgraphs/6f96a21ae1aaf087b7423f504e554694</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<h4 id="Hadoop"><a href="#Hadoop" class="headerlink" title="Hadoop"></a><a href="https://yuzhouwan.com/posts/60504/">Hadoop</a></h4><h4 id="Kafka"><a href="#Kafka" class="headerlink" title="Kafka"></a><a href="https://yuzhouwan.com/posts/26002/">Kafka</a></h4><h2 id="其他技术比对"><a href="#其他技术比对" class="headerlink" title="其他技术比对"></a>其他技术比对</h2><h3 id="思维导图"><a href="#思维导图" class="headerlink" title="思维导图"></a>思维导图</h3><p><img data-src="/picture/zk/zk_ecosystem.png" alt="ZooKeeper Ecosystem"></p>
<center>（利用 <a href="https://www.xmind.net/" target="_blank">XMind</a>™ 绘制而成）</center>



<h3 id="分布式框架"><a href="#分布式框架" class="headerlink" title="分布式框架"></a>分布式框架</h3><h4 id="Chubby"><a href="#Chubby" class="headerlink" title="Chubby"></a>Chubby</h4><p>　Google Chubby 是一种分布式锁服务，解决了分布式协作、元数据存储和 Leader 选举等一系列与分布式锁服务相关的问题，有着以下的优势：</p>
<ul>
<li>提供了一个完整的、独立的分布式锁服务</li>
<li>提供粗粒度的锁服务</li>
<li>在提供锁服务的同时提供对小文件的读写功能</li>
<li>高可用</li>
<li>提供事件通知机制</li>
</ul>
<p>　和 ZooKeeper 的区别主要有三点：</p>
<ul>
<li><p>一致性算法不同</p>
<p>ZooKeeper 用的是 ZAB 原子广播协议；Chubby 是带租约的 Paxos</p>
</li>
<li><p>API 设计不同</p>
<p>ZooKeeper 用 <code>ZNode</code> 节点来实现锁；Chubby 提供了直接的加锁 API</p>
</li>
<li><p>集群设计不同</p>
<p>ZooKeeper 每个机器都可以读，提供 sync 方法同步刷新，保证了吞吐量；Chubby 读写都在 Master 单节点上</p>
</li>
</ul>
<h4 id="HyperTable"><a href="#HyperTable" class="headerlink" title="HyperTable"></a><a href="https://github.com/hypertable/hypertable">HyperTable</a></h4><p>　Hypertable 和 HBase 是最知名的两款基于 BigTable 为蓝本设计的数据库，他们的不同之处在于 Hypertable 基于 Boost C++ 实现，而 HBase 则基于 Java。虽然前者架构足够精细、代码足够高质，但是流行度远不及 HBase</p>
<h3 id="一致性算法"><a href="#一致性算法" class="headerlink" title="一致性算法"></a>一致性算法</h3><h4 id="Raft"><a href="#Raft" class="headerlink" title="Raft"></a><a href="https://raft.github.io/">Raft</a></h4><p>　相比 Paxos，<a href="http://thesecretlivesofdata.com/raft/">Raft</a> 算法则更加易于理解和实现（目前 <a href="https://yuzhouwan.com/posts/2129/">Redis</a> 的集群设计用的是 Raft 算法）</p>
<p><img data-src="/picture/zk/zk_raft_1.png" alt=""><br><img data-src="/picture/zk/zk_raft_2.png" alt=""><br><img data-src="/picture/zk/zk_raft_3.png" alt=""><br><img data-src="/picture/zk/zk_raft_4.png" alt=""><br><img data-src="/picture/zk/zk_raft_5.png" alt=""><br><img data-src="/picture/zk/zk_raft_6.png" alt=""></p>
<center>（对 <a href="https://raft.github.io/" target="_blank">Raft.io</a>™ 的截图，已确定版权为 CC BY 3.0 协议）</center>



<h3 id="分布式协同"><a href="#分布式协同" class="headerlink" title="分布式协同"></a>分布式协同</h3><h4 id="Fourinone"><a href="#Fourinone" class="headerlink" title="Fourinone"></a>Fourinone</h4><p>　<strong>Fourinone</strong> 是阿里自主研发的一个分布式并行计算框架，它集成了 Hadoop、ZooKeeper、MQ、分布式缓存 四大主要的分布式计算功能。同时，还提供完整的分布式缓存支持，包括中小型缓存以及大型集群缓存，不过已经很长时间没有维护了</p>
<h3 id="分布式服务注册与发现"><a href="#分布式服务注册与发现" class="headerlink" title="分布式服务注册与发现"></a>分布式服务注册与发现</h3><h4 id="Consul"><a href="#Consul" class="headerlink" title="Consul"></a><a href="https://github.com/hashicorp/consul">Consul</a></h4><p>　<strong>Consul</strong> 是强一致性的数据存储，使用 Gossip 形成动态集群。它提供分级<code>键/值</code>存储方式，不仅可以存储数据，而且可以用于注册各种事件，从发送数据改变通知到运行健康检查和自定义命令<br>　相比于 ZooKeeper 只能提供 KV 存储，Consul 内嵌了 服务发现系统，并且原生支持多数据中心部署。同时，还可以执行健康检查，并提供一个可视化的 Dashboard 用于管理</p>
<h4 id="Etcd"><a href="#Etcd" class="headerlink" title="Etcd"></a><a href="https://github.com/coreos/etcd">Etcd</a></h4><p>　<strong>Etcd</strong> 是一个采用 HTTP 协议的<code>键/值</code>对存储系统，它是一个分布式和功能层次配置系统，可用于构建服务发现系统。其很容易部署、安装和使用，提供了可靠的数据持久化特性</p>
<h4 id="Registrator"><a href="#Registrator" class="headerlink" title="Registrator"></a><a href="https://github.com/gliderlabs/registrator">Registrator</a></h4><p>　<strong>Registrator</strong> 通过检查容器在线或者停止运行状态<code>自动注册</code>和<code>卸载注册服务</code>，它目前支持 etcd、Consul 和 SkyDNS2<br>　Registrator 与 etcd 是一个简单但是功能强大的组合，可以运行很多先进的技术。每当打开一个容器，所有数据将被存储在 etcd 并同步复制到集群中的所有节点上</p>
<h4 id="Confd"><a href="#Confd" class="headerlink" title="Confd"></a><a href="https://github.com/kelseyhightower/confd">Confd</a></h4><p>　<strong>Confd</strong> 是一个轻量级的配置管理工具，常见的用法是通过使用存储在 etcd、consul 和 其他一些数据登记处的数据保持配置文件的最新状态，它也可以用来在配置文件改变时重新加载应用程序。换句话说，我们可以用存储在 etcd（或者其他注册中心）的信息来重新配置所有服务</p>
<h2 id="实用工具"><a href="#实用工具" class="headerlink" title="实用工具"></a>实用工具</h2><h3 id="日志可视化工具"><a href="#日志可视化工具" class="headerlink" title="日志可视化工具"></a><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-773">日志可视化</a>工具</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/software/zookeeper</span><br><span class="line">$ java -cp zookeeper-3.4.6.jar:lib/log4j-1.2.16.jar:lib/slf4j-log4j12-1.6.1.jar:lib/slf4j-api-1.6.1.jar org.apache.zookeeper.server.LogFormatter ~/data/version-2/log.xxx</span><br><span class="line"></span><br><span class="line">  ZooKeeper Transactional Log File with dbid 0 txnlog format version 2</span><br><span class="line">  8/16/17 1:28:36 AM CST session 0x25d0d0e60d373ed cxid 0xcdd3 zxid 0xf0345fbfb setData <span class="string">'/hbase/replication/rs/slave08-yuzhouwan%2C60020%2C1502718266335/1/slave08-yuzhouwan%252C60020%252C1502718266335.1502817956398,#ffffffff0001a726567696f6e7365727665723a36303032306cffffffe8ffffffa1ffffffd0ffffff9824ffffffb616504255468ffffff8effffff92fffffff61d,34</span></span><br><span class="line"><span class="string">  8/16/17 1:28:36 AM CST session 0x35d0d0e72d4c5af cxid 0x0 zxid 0xf0345fbfd createSession 40000</span></span><br><span class="line"><span class="string">  8/16/17 1:28:37 AM CST session 0x15d0d0e5fc25bb2 cxid 0x0 zxid 0xf0345fc08 createSession 40000</span></span><br><span class="line"><span class="string">  8/16/17 1:28:37 AM CST session 0x35d0d0e72d4c5b2 cxid 0x4 zxid 0xf0345fc09 closeSession null</span></span><br><span class="line"><span class="string">  8/16/17 1:28:37 AM CST session 0x15d0d0e5fc25bb2 cxid 0x3 zxid 0xf0345fc0a closeSession null</span></span><br><span class="line"><span class="string">  8/16/17 1:28:37 AM CST session 0x25d0d0e60a7e937 cxid 0x26eeeb zxid 0xf0345fc0b setData '</span>/hbase/replication/rs/slave06-yuzhouwan%2C60020%2C1499390463838/1/slave06-yuzhouwan%252C60020%252C1499390463838.1502817657055,<span class="comment">#ffffffff0001a726567696f6e7365727665723a3630303230ffffff882fffffff8f7ffffff8b6ffffff89ffffffa7504255468ffffffeaffffff8effffffc52e,183</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="Snapshot-可视化工具"><a href="#Snapshot-可视化工具" class="headerlink" title="Snapshot 可视化工具"></a><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1377">Snapshot 可视化</a>工具</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/software/zookeeper</span><br><span class="line">$ java -cp zookeeper-3.4.6.jar:lib/log4j-1.2.16.jar:lib/slf4j-log4j12-1.6.1.jar:lib/slf4j-api-1.6.1.jar org.apache.zookeeper.server.SnapshotFormatter ~/data/version-2/snapshot.xxx</span><br><span class="line"></span><br><span class="line">  ZNode Details (count=4):</span><br><span class="line">  ----</span><br><span class="line">  /</span><br><span class="line">    cZxid = 0x00000000000000</span><br><span class="line">    ctime = Thu Jan 01 08:00:00 CST 1970</span><br><span class="line">    mZxid = 0x00000000000000</span><br><span class="line">    mtime = Thu Jan 01 08:00:00 CST 1970</span><br><span class="line">    pZxid = 0x00000000000000</span><br><span class="line">    cversion = 0</span><br><span class="line">    dataVersion = 0</span><br><span class="line">    aclVersion = 0</span><br><span class="line">    ephemeralOwner = 0x00000000000000</span><br><span class="line">    dataLength = 0</span><br><span class="line">  ----</span><br><span class="line">  /zookeeper</span><br><span class="line">    cZxid = 0x00000000000000</span><br><span class="line">    ctime = Thu Jan 01 08:00:00 CST 1970</span><br><span class="line">    mZxid = 0x00000000000000</span><br><span class="line">    mtime = Thu Jan 01 08:00:00 CST 1970</span><br><span class="line">    pZxid = 0x00000000000000</span><br><span class="line">    cversion = 0</span><br><span class="line">    dataVersion = 0</span><br><span class="line">    aclVersion = 0</span><br><span class="line">    ephemeralOwner = 0x00000000000000</span><br><span class="line">    dataLength = 0</span><br><span class="line">  ----</span><br><span class="line">  /zookeeper/quota</span><br><span class="line">    cZxid = 0x00000000000000</span><br><span class="line">    ctime = Thu Jan 01 08:00:00 CST 1970</span><br><span class="line">    mZxid = 0x00000000000000</span><br><span class="line">    mtime = Thu Jan 01 08:00:00 CST 1970</span><br><span class="line">    pZxid = 0x00000000000000</span><br><span class="line">    cversion = 0</span><br><span class="line">    dataVersion = 0</span><br><span class="line">    aclVersion = 0</span><br><span class="line">    ephemeralOwner = 0x00000000000000</span><br><span class="line">    dataLength = 0</span><br><span class="line">  ----</span><br><span class="line">  Session Details (sid, timeout, ephemeralCount):</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Hue-Browser-集群页面监控工具"><a href="#Hue-Browser-集群页面监控工具" class="headerlink" title="Hue Browser 集群页面监控工具"></a>Hue Browser 集群页面<a href="https://issues.apache.org/jira/browse/ZOOKEEPER-808">监控</a>工具</h3><h4 id="Rest-服务"><a href="#Rest-服务" class="headerlink" title="Rest 服务"></a>Rest 服务</h4><h5 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ tar zxvf zookeeper-3.4.10.tar.gz -C ~/software/</span><br><span class="line">$ <span class="built_in">cd</span> ~/software/zookeeper-3.4.10/</span><br><span class="line">$ ant clean</span><br><span class="line">$ ant</span><br></pre></td></tr></tbody></table></figure>
<h5 id="拷贝-Jar-包"><a href="#拷贝-Jar-包" class="headerlink" title="拷贝 Jar 包"></a>拷贝 Jar 包</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ cp build/contrib/rest/zookeeper-dev-rest.jar src/contrib/rest/lib/</span><br><span class="line">$ cp build/contrib/rest/lib/*.jar src/contrib/rest/lib/</span><br><span class="line">$ wget https://repository.cloudera.com/content/repositories/releases/org/apache/zookeeper/zookeeper/3.4.5-cdh5.11.1/zookeeper-3.4.5-cdh5.11.1.jar</span><br><span class="line">$ cp zookeeper-3.4.5-cdh5.2.0.jar src/contrib/rest/lib/</span><br><span class="line">$ cp src/java/lib/*.jar src/contrib/rest/lib/</span><br></pre></td></tr></tbody></table></figure>
<h5 id="启动-Rest-Service"><a href="#启动-Rest-Service" class="headerlink" title="启动 Rest Service"></a>启动 Rest Service</h5><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/zookeeper/software/zookeeper1/src/contrib/rest</span><br><span class="line">$ ./rest.sh start</span><br><span class="line">  Starting ZooKeeper REST Gateway ... </span><br><span class="line">  STARTED</span><br><span class="line"><span class="comment"># 关闭</span></span><br><span class="line">$ ./rest.sh stop</span><br><span class="line"><span class="comment"># 查看日志</span></span><br><span class="line">$ tail -f zkrest.log</span><br></pre></td></tr></tbody></table></figure>
<h4 id="安装-Hue"><a href="#安装-Hue" class="headerlink" title="安装 Hue"></a>安装 Hue</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 增加 ZooKeeper 用户</span></span><br><span class="line"><span class="comment"># 安装 jdk7 / python2.7.12 / virtualenv</span></span><br><span class="line">$ su - zookeeper</span><br><span class="line">$ mkdir software &amp;&amp; <span class="built_in">cd</span> software</span><br><span class="line">$ virtualenv -p /usr/<span class="built_in">local</span>/bin/python --system-site-packages hue</span><br><span class="line">$ <span class="built_in">cd</span> hue &amp;&amp; <span class="built_in">source</span> bin/activate</span><br><span class="line"><span class="comment"># 检查 virtualEnv 里的 python 版本和路径，是否正确</span></span><br><span class="line">(hue) [zookeeper@zoo hue]$ python -V</span><br><span class="line">  Python 2.7.12</span><br><span class="line">(hue) [zookeeper@edeppreapp01 software]$ <span class="built_in">which</span> python</span><br><span class="line">~/software/hue/bin/python</span><br><span class="line">$ <span class="built_in">cd</span> /home/zookeeper/install</span><br><span class="line">$ wget https://codeload.github.com/cloudera/hue/tar.gz/cdh5.8.5-release</span><br><span class="line">$ wget https://issues.apache.org/jira/secure/attachment/12452258/huebrowser.tar.gz</span><br><span class="line">$ ll</span><br><span class="line">  -rw-r--r-- 1 root root 50421006 Jun 22 16:57 hue-1.0.tgz</span><br><span class="line">  -rw-r--r-- 1 root root    23412 Jun 22 16:57 huebrowser.tar.gz</span><br><span class="line">$ mv cdh5.8.5-release cdh5.8.5-release.tar.gz</span><br><span class="line">$ tar zxvf cdh5.8.5-release.tar.gz -C ~/software/</span><br><span class="line">$ tar zxvf hue-1.0.tgz -C ~/software/ &amp;&amp; tar zxvf huebrowser.tar.gz -C ~/software/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 hue</span></span><br><span class="line">$ <span class="built_in">cd</span> ~/software/hue-1.0</span><br><span class="line">$ make apps</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可能需要安装一些第三方包，无需则跳过</span></span><br><span class="line">$ pip install simplejson</span><br><span class="line"></span><br><span class="line">$ mkdir apps/zkui</span><br><span class="line">$ python tools/app_reg/app_reg.py --install apps/zkui</span><br><span class="line">$ python tools/app_reg/app_reg.py --list 2&gt;&amp;1 | grep zkui</span><br><span class="line">  zkui           0.1     /Users/philip/src/hue/apps/zkui</span><br></pre></td></tr></tbody></table></figure>
<div class="note warning">Hue Browser 因为常年未维护更新（只兼容到 ZooKeeper v3.4.5 版本），导致安装时容易出现很多问题。另外，Rest Service 必须所有的节点都开启才行，一旦某一台故障，则整个 Hue 不可用。所以，最好还是自己实现一套监控系统</div>




<h3 id="移除-Watch-工具"><a href="#移除-Watch-工具" class="headerlink" title="移除 Watch 工具"></a><a href="https://github.com/phunt/zookeeper-removewatch-ex">移除 Watch</a> 工具</h3><h3 id="Docker-开发环境部署工具"><a href="#Docker-开发环境部署工具" class="headerlink" title="Docker 开发环境部署工具"></a><a href="https://github.com/phunt/zk-docker-devenv">Docker 开发环境部署</a>工具</h3><h3 id="生成配置工具"><a href="#生成配置工具" class="headerlink" title="生成配置工具"></a><a href="https://github.com/phunt/zkconf">生成配置</a>工具</h3><h3 id="冒烟测试工具"><a href="#冒烟测试工具" class="headerlink" title="冒烟测试工具"></a><a href="https://github.com/phunt/zk-smoketest">冒烟测试</a>工具</h3><h3 id="Curator-框架"><a href="#Curator-框架" class="headerlink" title="Curator 框架"></a><a href="https://github.com/apache/curator">Curator</a> 框架</h3><h2 id="社区跟进"><a href="#社区跟进" class="headerlink" title="社区跟进"></a>社区跟进</h2><h3 id="PR-amp-Issues"><a href="#PR-amp-Issues" class="headerlink" title="PR &amp; Issues"></a>PR &amp; Issues</h3><ul>
<li><p><a href="https://github.com/apache/zookeeper/pulls?utf8=%E2%9C%93&amp;q=is%3Apr%20author%3Aasdf2014%20">Pull Request</a></p>
</li>
<li><p><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-2784?jql=project%20%3D%20ZOOKEEPER%20AND%20reporter%20in%20(%22benedict%20jin%22)">Issues</a></p>
</li>
</ul>
<p>　详见，《<a href="https://yuzhouwan.com/posts/19631/">如何成为 Apache 的 PMC</a>》</p>
<h3 id="ZooKeeper-社区的一些“规则”"><a href="#ZooKeeper-社区的一些“规则”" class="headerlink" title="ZooKeeper 社区的一些“规则”"></a>ZooKeeper 社区的一些<a href="https://cwiki.apache.org/confluence/display/ZOOKEEPER/HowToContribute">“规则”</a></h3><p>　同时也是共享其他开源项目时，需要注意和养成的好习惯，只是 ZooKeeper 中控制更加严格</p>
<h4 id="保持-Diff-信息最简"><a href="#保持-Diff-信息最简" class="headerlink" title="保持 Diff 信息最简"></a>保持 Diff 信息最简</h4><p>　PR 中不应该做无关的 Code Format（import / 代码缩进 等）</p>
<h4 id="保持-PR-的相关性"><a href="#保持-PR-的相关性" class="headerlink" title="保持 PR 的相关性"></a>保持 PR 的相关性</h4><p>　不做无关的 代码优化，尤其是对其他不相关的类（可以另起 PR 进行优化）</p>
<h4 id="保持-代码风格一致"><a href="#保持-代码风格一致" class="headerlink" title="保持 代码风格一致"></a>保持 代码风格一致</h4><p>　关闭 IDE 自动优化 import 合并为通配符 <code>*</code> 的功能（如，<code>import java.io.*</code> 等）</p>
<p>　类似的，还有 Apache <a href="https://yuzhouwan.com/posts/5845/">Druid</a> 里的参数列表，需要分行写；Apache <a href="https://yuzhouwan.com/posts/743/">Superset</a> 之类的 Python 项目，需要注意 <a href="https://www.python.org/dev/peps/pep-0537/">PEP</a> 规范；Apache <a href="https://yuzhouwan.com/posts/39683/">Eagle</a> 需要 squash PR 中的 commits 等等。更多相关内容，参见我的另一篇文章：《<a href="https://yuzhouwan.com/posts/19631/#代码提交的几个注意点">如何成为 Apache 的 PMC</a>》</p>
<h3 id="规避已知-issues"><a href="#规避已知-issues" class="headerlink" title="规避已知 issues"></a><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-2186?jql=project%20%3D%20ZOOKEEPER%20AND%20issuetype%20%3D%20Bug%20AND%20resolution%20%3D%20Fixed%20AND%20affectedVersion%20%3D%203.4.6%20AND%20priority%20%3D%20Major%20AND%20component%20%3D%20server%20ORDER%20BY%20priority%20DESC%2C%20updated%20DESC">规避已知 issues</a></h3><p>　在 jira 中，根据自己的版本（affectedVersion），找到 Major 级别的 Bug，按照各个组件，对组件（component）进行筛选，并合并 patch 到自己的本地代码库里，从而规避一些已知的 issues，提高集群稳定性</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">project = ZOOKEEPER AND issuetype = Bug AND resolution = Fixed AND affectedVersion = 3.4.6 AND priority = Major AND component = server ORDER BY priority DESC, updated DESC</span><br></pre></td></tr></tbody></table></figure>
<h4 id="以-v3-4-6-为例"><a href="#以-v3-4-6-为例" class="headerlink" title="以 v3.4.6 为例"></a>以 v3.4.6 为例</h4><h5 id="server"><a href="#server" class="headerlink" title="server"></a>server</h5><ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-2026">ZOOKEEPER-2026</a>: Startup order in ServerCnxnFactory-ies is wrong</li>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-2044">ZOOKEEPER-2044</a>: CancelledKeyException in zookeeper branch-3.4</li>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-2052">ZOOKEEPER-2052</a>: Unable to delete a node when the node has no children</li>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-2060">ZOOKEEPER-2060</a>: Trace bug in NettyServerCnxnFactory</li>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-2186">ZOOKEEPER-2186</a>: QuorumCnxManager#receiveConnection may crash with random input</li>
</ul>
<h5 id="quorum"><a href="#quorum" class="headerlink" title="quorum"></a>quorum</h5><ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1774">ZOOKEEPER-1774</a>: QuorumPeerMainTest fails consistently with “complains about host” assertion failure</li>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-2029">ZOOKEEPER-2029</a>: Leader.LearnerCnxAcceptor should handle exceptions in run()</li>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-2033">ZOOKEEPER-2033</a>: zookeeper follower fails to start after a restart immediately following a new epoch</li>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-2195">ZOOKEEPER-2195</a>: fsync.warningthresholdms in zoo.cfg not working</li>
</ul>
<h5 id="java-client"><a href="#java-client" class="headerlink" title="java client"></a>java client</h5><ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1853">ZOOKEEPER-1853</a>: zkCli.sh cannot issue a CREATE command containing spaces in the data</li>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1897">ZOOKEEPER-1897</a>: ZK Shell/Cli not processing commands</li>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-2375">ZOOKEEPER-2375</a>: Prevent multiple initialization of login object in each ZooKeeperSaslClient instance</li>
<li><a href="https://github.com/apache/zookeeper/pull/430">ZOOKEEPER-2893</a>: very poor choice of logging if client fails to connect to server</li>
</ul>
<h5 id="other"><a href="#other" class="headerlink" title="other"></a>other</h5><ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1913">ZOOKEEPER-1913</a>: Invalid manifest files due to bogus revision property value</li>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1991">ZOOKEEPER-1991</a>: zkServer.sh returns with a zero exit status when a ZooKeeper process is already running</li>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-2039">ZOOKEEPER-2039</a>: Jute compareBytes incorrect comparison index</li>
</ul>
<h5 id="improvement"><a href="#improvement" class="headerlink" title="improvement"></a>improvement</h5><ul>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1506">ZOOKEEPER-1506</a>: Re-try DNS hostname -&gt; IP resolution if node connection fails</li>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-2270">ZOOKEEPER-2270</a>: Allow MBeanRegistry to be overridden for better unit tests</li>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1948">ZOOKEEPER-1948</a>: Enable JMX remote monitoring</li>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-2205">ZOOKEEPER-2205</a>: Log type of unexpected quorum packet in learner handler loop</li>
<li><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-2194">ZOOKEEPER-2194</a>: Let DataNode.getChildren() return an unmodifiable view of its children set</li>
</ul>
<h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><h3 id="Book"><a href="#Book" class="headerlink" title="Book"></a>Book</h3><ul>
<li><a href="https://book.douban.com/subject/25765743/">ZooKeeper</a></li>
<li><a href="https://book.douban.com/subject/26292004/">Paxos 到 ZooKeeper：分布式一致性原理与实践</a></li>
</ul>
<h3 id="Paper"><a href="#Paper" class="headerlink" title="Paper"></a>Paper</h3><ul>
<li><a href="https://www.microsoft.com/en-us/research/publication/paxos-made-simple/">Paxos Made Simple</a></li>
<li><a href="https://numenta.com/assets/pdf/whitepapers/hierarchical-temporal-memory-cortical-learning-algorithm-0.2.1-en.pdf">HIERARCHICAL TEMPORAL MEMORY including HTM Cortical Learning Algorithms</a></li>
</ul>
<h3 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h3><ul>
<li><a href="https://software.intel.com/sites/default/files/managed/39/c5/325462-sdm-vol-1-2abcd-3abcd.pdf">Intel® 64 and IA-32 architectures software developer’s manual combined volumes: 1, 2A, 2B, 2C, 2D, 3A, 3B, 3C, 3D, and 4</a></li>
</ul>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt=""></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt=""></a></td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>大数据</category>
      </categories>
      <tags>
        <tag>Apache Storm</tag>
        <tag>Apache Kafka</tag>
        <tag>Docker</tag>
        <tag>Apache Hadoop</tag>
        <tag>Apache Druid</tag>
        <tag>JVM</tag>
        <tag>Apache ZooKeeper</tag>
        <tag>Paxos</tag>
        <tag>Raft</tag>
        <tag>Apache Flink</tag>
        <tag>Apache HBase</tag>
        <tag>Apache Yarn</tag>
        <tag>ZAB</tag>
        <tag>Chubby</tag>
        <tag>HyperTable</tag>
        <tag>Fourinone</tag>
        <tag>Consul</tag>
        <tag>Etcd</tag>
        <tag>Registrator</tag>
        <tag>Confd</tag>
      </tags>
  </entry>
</search>
