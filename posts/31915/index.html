<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/yuzhouwan_logo_with_copyright.jpg">
  <link rel="icon" type="image/png" sizes="32x32" href="/yuzhouwan_logo_32x32.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/yuzhouwan_logo_16x16.ico">
  <link rel="mask-icon" href="/yuzhouwan_logo_with_copyright.jpg" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yuzhouwan.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":5,"onmobile":true},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":true,"nav":{"valine":{"text":"Valine：匿名","order":-1},"disqus":{"text":"Disqus：海外","order":-2},"gitalk":{"text":"Gitalk：可用 Github 账号登录","order":-3}}},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="ZooKeeper 是什么？　ZooKeeper 是一个基于 Google Chubby 论文实现的一款解决分布式数据一致性问题的开源实现，方便了依赖 ZooKeeper 的应用实现 数据发布 &#x2F; 订阅、负载均衡、服务注册与发现、分布式协调、事件通知、集群管理、Leader 选举、 分布式锁和队列 等功能 基本概念集群角色　一般的，在分布式系统中，构成集群的每一台机器都有自己的角色，最为典型的集群">
<meta property="og:type" content="article">
<meta property="og:title" content="ZooKeeper 原理与优化">
<meta property="og:url" content="https://yuzhouwan.com/posts/31915/">
<meta property="og:site_name" content="宇宙湾">
<meta property="og:description" content="ZooKeeper 是什么？　ZooKeeper 是一个基于 Google Chubby 论文实现的一款解决分布式数据一致性问题的开源实现，方便了依赖 ZooKeeper 的应用实现 数据发布 &#x2F; 订阅、负载均衡、服务注册与发现、分布式协调、事件通知、集群管理、Leader 选举、 分布式锁和队列 等功能 基本概念集群角色　一般的，在分布式系统中，构成集群的每一台机器都有自己的角色，最为典型的集群">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://yuzhouwan.com/picture/zk/zk_master_slave.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/zk/zk_leader_follower_observer.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/zk/zk_transition.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/zk/zk_znode.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/zk/zk_watcher.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/zk/zk_observer_throughput.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/zk/zk_ovserver_multi_cyberroom.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/zk/zk_atomic.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/zk/zk_long_adder_striped64_number.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/zk/zk_vote_server_state.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/zk/zk_quorum_cnx_manager.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/zk/zk_fastLeader_election.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/zk/zk_leader_election_flow.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/zk/zk_database_data_tree_data_node.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/zk/zk_lamport_logic_clock.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/zk/zk_ecosystem.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/zk/zk_raft_1.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/zk/zk_raft_2.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/zk/zk_raft_3.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/zk/zk_raft_4.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/zk/zk_raft_5.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/zk/zk_raft_6.png">
<meta property="og:image" content="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg">
<meta property="og:image" content="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg">
<meta property="og:image" content="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg">
<meta property="og:image" content="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg">
<meta property="article:published_time" content="2017-04-22T00:38:04.000Z">
<meta property="article:modified_time" content="2020-10-29T13:44:24.892Z">
<meta property="article:author" content="Benedict Jin">
<meta property="article:tag" content="Apache Storm">
<meta property="article:tag" content="Apache Kafka">
<meta property="article:tag" content="Docker">
<meta property="article:tag" content="Apache Hadoop">
<meta property="article:tag" content="Apache Druid">
<meta property="article:tag" content="JVM">
<meta property="article:tag" content="Apache ZooKeeper">
<meta property="article:tag" content="Paxos">
<meta property="article:tag" content="Raft">
<meta property="article:tag" content="Apache Flink">
<meta property="article:tag" content="Apache HBase">
<meta property="article:tag" content="Apache Yarn">
<meta property="article:tag" content="ZAB">
<meta property="article:tag" content="Chubby">
<meta property="article:tag" content="HyperTable">
<meta property="article:tag" content="Fourinone">
<meta property="article:tag" content="Consul">
<meta property="article:tag" content="Etcd">
<meta property="article:tag" content="Registrator">
<meta property="article:tag" content="Confd">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://yuzhouwan.com/picture/zk/zk_master_slave.png">

<link rel="canonical" href="https://yuzhouwan.com/posts/31915/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>ZooKeeper 原理与优化 | 宇宙湾</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-97020848-1"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-97020848-1');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>


<style>.null { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .null > span { position: relative; z-index: 10; }  .null img, .null .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .null img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .null-fallback { color: inherit; } .null-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="宇宙湾" type="application/atom+xml"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">宇宙湾</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">厚积薄发</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">147</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">15</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">54</span></a>

  </li>
        <li class="menu-item menu-item-书单">

    <a href="/books/" rel="section"><i class="fa fa-book fa-fw"></i>书单</a>

  </li>
        <li class="menu-item menu-item-影视">

    <a href="/movies/" rel="section"><i class="fa fa-film fa-fw"></i>影视</a>

  </li>
        <li class="menu-item menu-item-友链">

    <a href="/links/" rel="section"><i class="fa fa-link fa-fw"></i>友链</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yuzhouwan.com/posts/31915/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/yuzhouwan_logo_128x128.ico">
      <meta itemprop="name" content="Benedict Jin">
      <meta itemprop="description" content="Benedict Jin's Blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宇宙湾">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          ZooKeeper 原理与优化
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-04-22 08:38:04" itemprop="dateCreated datePublished" datetime="2017-04-22T08:38:04+08:00">2017-04-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-10-29 21:44:24" itemprop="dateModified" datetime="2020-10-29T21:44:24+08:00">2020-10-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/" itemprop="url" rel="index"><span itemprop="name">大数据</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>82k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1:15</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="ZooKeeper-是什么？"><a href="#ZooKeeper-是什么？" class="headerlink" title="ZooKeeper 是什么？"></a>ZooKeeper 是什么？</h2><p>　<strong>ZooKeeper</strong> 是一个基于 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://static.googleusercontent.com/media/research.google.com/zh-CN//archive/chubby-osdi06.pdf">Google Chubby</a> 论文实现的一款解决分布式数据一致性问题的开源实现，方便了依赖 ZooKeeper 的应用实现 <code>数据发布 / 订阅</code>、<code>负载均衡</code>、<code>服务注册与发现</code>、<code>分布式协调</code>、<code>事件通知</code>、<code>集群管理</code>、<code>Leader 选举</code>、 <code>分布式锁和队列</code> 等功能</p>
<h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><h3 id="集群角色"><a href="#集群角色" class="headerlink" title="集群角色"></a>集群角色</h3><p>　一般的，在分布式系统中，构成集群的每一台机器都有自己的角色，最为典型的集群模式就是 <code>Master / Slave</code> 主备模式。在该模式中，我们把能够处理所有<code>写操作</code>的机器称为 <code>Master</code> 节点，并把所有通过<code>异步复制</code>方式获取最新数据、提供<code>读服务</code>的机器称为 <code>Slave</code> 节点</p>
<p><img data-src="/picture/zk/zk_master_slave.png" alt></p>
<center>（利用 <a href="https://www.axure.com.cn/" target="_blank" rel="external nofollow noopener noreferrer">Axure</a>™ 绘制而成）</center>

<p>　而 ZooKeeper 中，则是引入了 <code>领导者（Leader）</code>、<code>跟随者（Follower）</code>、<code>观察者（Observer）</code> 三种角色 和 <code>领导（Leading）</code>、<code>跟随（Following）</code>、<code>观察（Observing）</code>、<code>寻找（Looking）</code> 等相应的<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/apache/zookeeper/blob/master/src/java/main/org/apache/zookeeper/server/quorum/QuorumPeer.java#L370">状态</a>。在 ZooKeeper 集群中的通过一种 <code>Leader 选举</code>的过程，来选定某个节点作为 <code>Leader</code> 节点，该节点为客户端提供<code>读</code>和<code>写</code>服务。而 <code>Follower</code> 和 <code>Observer</code> 节点，则都能提供<code>读</code>服务，唯一的区别在于，<code>Observer</code> 机器<code>不参与 Leader 选举</code>过程 和 <code>写操作</code>的<code>"过半写成功"</code>策略，<code>Observer</code> 只会被告知已经 commit 的 proposal。因此 <code>Observer</code> 可以在<code>不影响写性能</code>的情况下提升集群的<code>读性能</code>（详见下文 “性能优化 - 优化策略 - Observer 模式” 部分）</p>
<p><img data-src="/picture/zk/zk_leader_follower_observer.png" alt></p>
<center>（利用 <a href="https://www.axure.com.cn/" target="_blank" rel="external nofollow noopener noreferrer">Axure</a>™ 绘制而成）</center>

<a id="more"></a>
<h3 id="会话"><a href="#会话" class="headerlink" title="会话"></a>会话</h3><p>　<strong>Session</strong> 指客户端会话。在 ZooKeeper 中，一个<code>客户端会话</code>是指 <code>客户端</code>和<code>服务器</code>之间的一个 <code>TCP 长连接</code>。客户端启动的时候，会与服务端建立一个 <code>TCP 连接</code>，客户端会话的生命周期，则是从第一次连接建立开始算起。通过这个连接，客户端能够通过<code>心跳检测</code>与服务器保持有效的会话，并向 ZooKeeper 服务器发送请求并接收响应，以及接收来自服务端的 <code>Watch 事件通知</code></p>
<p>　Session 的 sessionTimeout 参数，用来控制一个客户端会话的超时时间。当<code>服务器压力</code>太大 或者是<code>网络故障</code>等各种原因导致客户端<a target="_blank" rel="external nofollow noopener noreferrer" href="https://cwiki.apache.org/confluence/display/ZOOKEEPER/FAQ">连接断开</a>时，Client 会自动从 ZooKeeper 地址列表中逐一尝试重连（重试策略可使用 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/asdf2014/yuzhouwan/tree/master/yuzhouwan-bigdata/yuzhouwan-bigdata-zookeeper/src/main/java/com/yuzhouwan/bigdata/zookeeper">Curator</a> 来实现）。只要在 sessionTimeout 规定的时间内能够<code>重新连接</code>上集群中<code>任意一台服务器</code>，那么之前创建的会话仍然有效。如果，在 sessionTimeout 时间外重连了，就会因为 Session 已经被清除了，而被告知 <code>SESSION_EXPIRED</code>，此时需要程序去恢复临时数据；还有一种 Session 重建后的在新节点上的数据，被之前节点上因<code>网络延迟</code>晚来的<code>写请求</code>所覆盖的情况，在 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://issues.apache.org/jira/browse/ZOOKEEPER-417">ZOOKEEPER-417</a> 中被提出，并在该 JIRA 中新加入的 <code>SessionMovedException</code>，使得 用同一个 <code>sessionld/sessionPasswd</code> 重建 Session 的客户端能感知到，但是这个问题到 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://issues.apache.org/jira/browse/ZOOKEEPER-2219">ZOOKEEPER-2219</a> 仍然没有得到很好的解决</p>
<p><img data-src="/picture/zk/zk_transition.png" alt></p>
<center>（利用 <a href="https://www.axure.com.cn/" target="_blank" rel="external nofollow noopener noreferrer">Axure</a>™ 绘制而成）</center>


<h3 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h3><p>　在 ZooKeeper 中，<code>节点</code>分为两类，第一类是指 构成集群的<code>机器</code>，称之为<code>机器节点</code>；第二类则是指 数据模型中的<code>数据单元</code>，称之为<code>数据节点 ZNode</code>。ZooKeeper 将所有数据存储在内存中，数据模型的结构类似于树（ZNode Tree），由<code>斜杠（/）</code>进行分割的路径，就是一个 <code>ZNode</code>，例如 <code>/foo/path1</code>。每个 ZNode 上都会保存自己的数据内容 和 一系列属性信息</p>
<p>　ZNode 可以分为<code>持久节点（PERSISTENT）</code>和<code>临时节点（EPHEMERAL）</code>两类。所谓<code>持久节点</code>是指一旦这个 ZNode 被创建了，除非主动进行移除操作，否则这个节点将一直保存在 ZooKeeper 上。而<code>临时节点</code>的生命周期，是与客户端会话绑定的，一旦客户端会话<code>失效</code>，那么这个<code>客户端创建的所有临时节点</code>都会被<code>移除</code>。在 <a href="https://yuzhouwan.com/posts/45888/">HBase</a> 中，集群则是通过 <strong>/hbase/rs/*</strong> 和 <strong>/hbase/master</strong> 两个临时节点，来监控 <strong>HRegionServer 进程的加入和宕机</strong> 和 <strong>HMaster 进程的 Active 状态</strong></p>
<p>　另外，ZooKeeper 还有一种 <code>顺序节点（SEQUENTIAL）</code>。该节点被创建的时候，ZooKeeper 会自动在其子节点名上，加一个由父节点维护的、自增整数的后缀（上限：<code>Integer.MAX_VALUE</code>）。该节点的特性，还可以应用到 持久 / 临时节点 上，组合成 <code>持久顺序节点（PERSISTENT_SEQUENTIAL）</code> 和 <code>临时顺序节点（EPHEMERAL_SEQUENTIAL）</code></p>
<p><img data-src="/picture/zk/zk_znode.png" alt></p>
<center>（利用 <a href="https://www.axure.com.cn/" target="_blank" rel="external nofollow noopener noreferrer">Axure</a>™ 绘制而成）</center>


<h3 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h3><p>　ZooKeeper 的每个 <code>ZNode</code> 上都会存储数据，对应于每个 <code>ZNode</code>，ZooKeeper 都会为其维护一个叫做 <code>Stat</code> 的数据结构，<code>Stat</code> 中记录了这个 <code>ZNode</code> 的三个数据版本，分别是 <code>version</code>（当前 ZNode 数据内容的版本），<code>cversion</code>（当前 ZNode 子节点的版本）和 <code>aversion</code>（当前 ZNode 的 ACL 变更版本）。这里的<code>版本</code>起到了控制 ZooKeeper 操作<code>原子性</code>的作用（详见下文 “源码分析 - 落脚点 - ZooKeeper 乐观锁” 部分）</p>
<p>　如果想要让写入数据的操作支持 CAS，则可以借助 <code>Versionable#withVersion</code> 方法，在 <code>setData()</code> 的同时指定当前数据的 <code>verison</code>。如果写入成功，则说明在当前数据写入的过程中，没有其他用户对该 ZNode 节点的内容进行过修改；否则，会抛出一个 <code>KeeperException.BadVersionException</code>，以此可以判断本次 CAS 写入是失败的。而这样做的好处就是，可以避免“并发局部更新 ZNode 节点内容”时，发生相互覆盖的问题</p>
<h3 id="Watcher"><a href="#Watcher" class="headerlink" title="Watcher"></a>Watcher</h3><p>　<strong>Watcher</strong>（事件监听器）是 ZooKeeper 提供的一种 <code>发布/订阅</code>的机制。ZooKeeper 允许用户在指定节点上注册一些 Watcher，并且在一些<code>特定事件触发</code>的时候，ZooKeeper 服务端会将事件通知给<code>订阅</code>的客户端。该机制是 ZooKeeper 实现<code>分布式协调</code>的重要特性</p>
<p><img data-src="/picture/zk/zk_watcher.png" alt></p>
<center>（利用 <a href="https://www.axure.com.cn/" target="_blank" rel="external nofollow noopener noreferrer">Axure</a>™ 绘制而成）</center>

<h3 id="ACL"><a href="#ACL" class="headerlink" title="ACL"></a>ACL</h3><p>　类似于 Unix 文件系统，ZooKeeper 采用 <code>ACL（Access Control Lists）</code>策略来进行权限控制（使用方式，详见下文 “常用命令 - 执行脚本 - zkCli - 节点操作” 部分；代码实现，详见 PrepRequestProcessor#<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/apache/zookeeper/blob/master/src/java/main/org/apache/zookeeper/server/PrepRequestProcessor.java#L286">checkACL</a>）</p>
<h4 id="常用的权限控制"><a href="#常用的权限控制" class="headerlink" title="常用的权限控制"></a>常用的权限控制</h4><div class="table-container">
<table>
<thead>
<tr>
<th>Command</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>CREATE (<strong>c</strong>)</td>
<td>创建子节点的权限</td>
</tr>
<tr>
<td>READ (<strong>r</strong>)</td>
<td>获取节点数据和子节点列表的权限</td>
</tr>
<tr>
<td>WRITE (<strong>w</strong>)</td>
<td>更新节点数据的权限</td>
</tr>
<tr>
<td>DELETE (<strong>d</strong>)</td>
<td>删除当前节点的权限</td>
</tr>
<tr>
<td>ADMIN (<strong>a</strong>)</td>
<td>管理权限，可以设置当前节点的 permission</td>
</tr>
</tbody>
</table>
</div>
<div class="table-container">
<table>
<thead>
<tr>
<th>Scheme</th>
<th>ID</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>world</td>
<td>anyone</td>
<td>ZooKeeper 中对所有人有权限的结点就是属于 <code>world:anyone</code></td>
</tr>
<tr>
<td>auth</td>
<td>不需要 id</td>
<td>通过 authentication 的 user 都有权限</td>
</tr>
<tr>
<td></td>
<td></td>
<td>（ZooKeeper 支持通过 kerberos 来进行 <code>authencation</code>，也支持 <code>username</code>/<code>password</code>形式的 authentication）</td>
</tr>
<tr>
<td>digest</td>
<td>username:BASE64 (SHA1(password))</td>
<td>需要先通过 username:password 形式的 authentication</td>
</tr>
<tr>
<td>ip</td>
<td>id 为客户机的 IP 地址（或者 IP 地址段）</td>
<td>ip:192.168.1.0/14，表示匹配前 14 个 bit 的 IP 段</td>
</tr>
<tr>
<td>super</td>
<td></td>
<td>对应的 id 拥有超级权限（CRWDA）</td>
</tr>
</tbody>
</table>
</div>
<h4 id="IP"><a href="#IP" class="headerlink" title="IP"></a>IP</h4><h5 id="编码"><a href="#编码" class="headerlink" title="编码"></a>编码</h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Before</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">  zoo = <span class="keyword">new</span> ZooKeeper(HOST.concat(<span class="string">":"</span> + CLIENT_PORT), TIME_OUT_MILLISECOND, <span class="keyword">null</span>);</span><br><span class="line">  acls = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  acls.add(<span class="keyword">new</span> ACL(ZooDefs.Perms.ALL, <span class="keyword">new</span> Id(IP, <span class="string">"10.24.40.178"</span>)));</span><br><span class="line">  acls.add(<span class="keyword">new</span> ACL(ZooDefs.Perms.ALL, <span class="keyword">new</span> Id(IP, <span class="string">"127.0.0.1"</span>)));</span><br><span class="line">  aclsNoAuth = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  aclsNoAuth.add(<span class="keyword">new</span> ACL(ZooDefs.Perms.ALL, <span class="keyword">new</span> Id(IP, <span class="string">"127.0.0.1"</span>)));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ipAcl</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">  <span class="keyword">if</span> (zoo.exists(IP_PATH, <span class="keyword">null</span>) != <span class="keyword">null</span>) zoo.delete(IP_PATH, -<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> (zoo.exists(IP_PATH_NO_AUTH, <span class="keyword">null</span>) != <span class="keyword">null</span>) zoo.delete(IP_PATH_NO_AUTH, -<span class="number">1</span>);</span><br><span class="line">  zoo.create(IP_PATH, IP.getBytes(), acls, CreateMode.PERSISTENT);</span><br><span class="line">  assertEquals(IP, <span class="keyword">new</span> String(zoo.getData(IP_PATH, <span class="keyword">false</span>, <span class="keyword">null</span>)));</span><br><span class="line">  zoo.create(IP_PATH_NO_AUTH, IP.getBytes(), aclsNoAuth, CreateMode.PERSISTENT);</span><br><span class="line">  <span class="keyword">try</span> {</span><br><span class="line">    zoo.getData(IP_PATH_NO_AUTH, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">  } <span class="keyword">catch</span> (KeeperException.NoAuthException e) {</span><br><span class="line">    assertEquals(<span class="string">"KeeperErrorCode = NoAuth for "</span>.concat(IP_PATH_NO_AUTH), e.getMessage());</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>Tips: Full code is <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-bigdata/yuzhouwan-bigdata-zookeeper/src/test/java/com/yuzhouwan/bigdata/zookeeper/auth/AuthIPExample.java">here</a>.</p>
<h5 id="命令行"><a href="#命令行" class="headerlink" title="命令行"></a>命令行</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ zkCli.sh -server localhost:2181</span><br><span class="line">  [zk: localhost:2181(CONNECTED) 16] ls /</span><br><span class="line">    [leader, election, zookeeper, origin, ip, auth_test, benchmark]</span><br><span class="line"></span><br><span class="line">  [zk: localhost:2181(CONNECTED) 17] ls /ip</span><br><span class="line">    Authentication is not valid : /ip</span><br><span class="line"></span><br><span class="line">  [zk: localhost:2181(CONNECTED) 18] getAcl /ip</span><br><span class="line">    <span class="string">'ip,'</span>10.24.40.178</span><br><span class="line">    : cdrwa</span><br><span class="line">    <span class="string">'ip,'</span>127.0.0.1</span><br><span class="line">    : cdrwa</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ zkCli.sh -server 127.0.0.1:2181</span><br><span class="line">  [zk: 127.0.0.1:2181(CONNECTED) 1] ls /ip</span><br><span class="line">    []</span><br><span class="line"></span><br><span class="line">  [zk: 127.0.0.1:2181(CONNECTED) 2] get /ip</span><br><span class="line">    ip</span><br><span class="line">    cZxid = 0x10000c43b</span><br><span class="line">    ctime = Tue Aug 22 16:50:37 CST 2017</span><br><span class="line">    mZxid = 0x10000c43b</span><br><span class="line">    mtime = Tue Aug 22 16:50:37 CST 2017</span><br><span class="line">    pZxid = 0x10000c43b</span><br><span class="line">    cversion = 0</span><br><span class="line">    dataVersion = 0</span><br><span class="line">    aclVersion = 0</span><br><span class="line">    ephemeralOwner = 0x0</span><br><span class="line">    dataLength = 2</span><br><span class="line">    numChildren = 0</span><br></pre></td></tr></tbody></table></figure>
<h5 id="优缺点"><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h5><p>　简单易用，直接在物理层面，对用户进行权限隔离；但是，如果不将 <code>127.0.0.1</code> 放入到 IP Acl 列表里，会给服务端的运维带来麻烦</p>
<h4 id="Digest"><a href="#Digest" class="headerlink" title="Digest"></a>Digest</h4><h5 id="编码-1"><a href="#编码-1" class="headerlink" title="编码"></a>编码</h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Before</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">  zoo = <span class="keyword">new</span> ZooKeeper(HOST.concat(<span class="string">":"</span> + CLIENT_PORT), TIME_OUT_MILLISECOND, <span class="keyword">null</span>);</span><br><span class="line">  zoo.addAuthInfo(<span class="string">"digest"</span>, <span class="string">"yuzhouwan:com"</span>.getBytes());</span><br><span class="line">  zooNoAuth = <span class="keyword">new</span> ZooKeeper(HOST.concat(<span class="string">":"</span> + CLIENT_PORT), TIME_OUT_MILLISECOND, <span class="keyword">null</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">digestAcl</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">  <span class="keyword">if</span> (zoo.exists(AUTH_PATH_CHILD, <span class="keyword">null</span>) != <span class="keyword">null</span>) zoo.delete(AUTH_PATH_CHILD, -<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> (zoo.exists(AUTH_PATH, <span class="keyword">null</span>) != <span class="keyword">null</span>) zoo.delete(AUTH_PATH, -<span class="number">1</span>);</span><br><span class="line">  zoo.create(AUTH_PATH, bytes, ZooDefs.Ids.CREATOR_ALL_ACL, CreateMode.PERSISTENT);</span><br><span class="line">  <span class="keyword">try</span> {</span><br><span class="line">    zooNoAuth.create(AUTH_PATH_CHILD, bytes, ZooDefs.Ids.CREATOR_ALL_ACL, CreateMode.PERSISTENT);</span><br><span class="line">  } <span class="keyword">catch</span> (KeeperException.InvalidACLException e) {</span><br><span class="line">    assertEquals(<span class="string">"KeeperErrorCode = InvalidACL for /auth_test/child"</span>, e.getMessage());</span><br><span class="line">  }</span><br><span class="line">  zoo.create(AUTH_PATH_CHILD, bytes, ZooDefs.Ids.CREATOR_ALL_ACL, CreateMode.PERSISTENT);</span><br><span class="line">  <span class="keyword">try</span> {</span><br><span class="line">    zooNoAuth.delete(AUTH_PATH_CHILD, -<span class="number">1</span>);</span><br><span class="line">  } <span class="keyword">catch</span> (KeeperException.NoAuthException e) {</span><br><span class="line">    assertEquals(<span class="string">"KeeperErrorCode = NoAuth for /auth_test/child"</span>, e.getMessage());</span><br><span class="line">  }</span><br><span class="line">  assertEquals(AUTH_PATH, <span class="keyword">new</span> String(zoo.getData(AUTH_PATH, <span class="keyword">false</span>, <span class="keyword">null</span>)));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>Tips: Full code is <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-bigdata/yuzhouwan-bigdata-zookeeper/src/test/java/com/yuzhouwan/bigdata/zookeeper/auth/AuthDigestExample.java">here</a>.</p>
<h5 id="命令行-1"><a href="#命令行-1" class="headerlink" title="命令行"></a>命令行</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ zkCli.sh -server localhost:2181</span><br><span class="line">  [zk: localhost:2181(CONNECTED) 5] ls /</span><br><span class="line">    [leader, auth_test, election, zookeeper, benchmark, origin]</span><br><span class="line"></span><br><span class="line">  [zk: localhost:2181(CONNECTED) 6] ls /auth_test</span><br><span class="line">    Authentication is not valid : /auth_test</span><br><span class="line"></span><br><span class="line">  [zk: localhost:2181(CONNECTED) 7] get /auth_test</span><br><span class="line">    Authentication is not valid : /auth_test</span><br><span class="line"></span><br><span class="line">  [zk: localhost:2181(CONNECTED) 8] getAcl /auth_test</span><br><span class="line">    <span class="string">'digest,'</span>yuzhouwan:h/j+/wDlblTtA48jnbq8snP1glA=</span><br><span class="line">    : cdrwa</span><br><span class="line"></span><br><span class="line">  [zk: localhost:2181(CONNECTED) 9] addauth digest yuzhouwan:<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  [zk: localhost:2181(CONNECTED) 10] get /auth_test</span><br><span class="line">    /auth_test</span><br><span class="line">    cZxid = 0x10000c31e</span><br><span class="line">    ctime = Tue Aug 22 15:26:27 CST 2017</span><br><span class="line">    mZxid = 0x10000c31e</span><br><span class="line">    mtime = Tue Aug 22 15:26:27 CST 2017</span><br><span class="line">    pZxid = 0x10000c31e</span><br><span class="line">    cversion = 0</span><br><span class="line">    dataVersion = 0</span><br><span class="line">    aclVersion = 0</span><br><span class="line">    ephemeralOwner = 0x0</span><br><span class="line">    dataLength = 10</span><br><span class="line">    numChildren = 0</span><br></pre></td></tr></tbody></table></figure>
<h5 id="优缺点-1"><a href="#优缺点-1" class="headerlink" title="优缺点"></a>优缺点</h5><p>　可以建立角色，按照用户名、密码进行权限控制；但是，想要修改某个用户的密码，需要对所有的 ACLs 做更改</p>
<h4 id="SASL-amp-Kerberos"><a href="#SASL-amp-Kerberos" class="headerlink" title="SASL &amp; Kerberos"></a>SASL &amp; Kerberos</h4><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><h3 id="单机版"><a href="#单机版" class="headerlink" title="单机版"></a>单机版</h3><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/install/</span><br><span class="line">$ wget http://archive.apache.org/dist/zookeeper/zookeeper-3.4.10/zookeeper-3.4.10.tar.gz</span><br><span class="line">$ wget http://archive.apache.org/dist/zookeeper/zookeeper-3.4.10/zookeeper-3.4.10.tar.gz.md5</span><br><span class="line"></span><br><span class="line"><span class="comment"># 校验 MD5</span></span><br><span class="line">$ head -n 1 zookeeper-3.4.10.tar.gz.md5</span><br><span class="line">  e4cf1b1593ca870bf1c7a75188f09678  zookeeper-3.4.10.tar.gz</span><br><span class="line">$ md5sum zookeeper-3.4.10.tar.gz</span><br><span class="line">  e4cf1b1593ca870bf1c7a75188f09678 *zookeeper-3.4.10.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对比 MD5 码一致后进行解压安装</span></span><br><span class="line">$ tar zxvf zookeeper-3.4.10.tar.gz -C ~/software/</span><br><span class="line">$ <span class="built_in">cd</span> ~/software</span><br><span class="line">$ ln -s zookeeper-3.4.10 zookeeper</span><br></pre></td></tr></tbody></table></figure>
<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> zookeeper</span><br><span class="line">$ mkdir tmp</span><br><span class="line">$ cp conf/zoo_sample.cfg conf/zoo.cfg</span><br><span class="line">$ mkdir -p /home/zookeeper/data/zookeeper</span><br><span class="line">$ mkdir -p /home/zookeeper/logs/zookeeper</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更多配置，详见下文 “常用配置” 部分</span></span><br><span class="line">$ vim conf/zoo.cfg</span><br><span class="line">  tickTime=2000</span><br><span class="line">  initLimit=10</span><br><span class="line">  syncLimit=5</span><br><span class="line">  dataDir=/home/zookeeper/data/zookeeper</span><br><span class="line">  dataLogDir=/home/zookeeper/logs/zookeeper</span><br><span class="line">  clientPort=2181</span><br></pre></td></tr></tbody></table></figure>
<h4 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ bin/zkServer.sh start</span><br><span class="line">$ bin/zkServer.sh status</span><br><span class="line">  ZooKeeper JMX enabled by default</span><br><span class="line">  Using config: /home/zookeeper/software/zookeeper/bin/../conf/zoo.cfg</span><br><span class="line">  Mode: standalone</span><br><span class="line">$ bin/zkCli.sh</span><br></pre></td></tr></tbody></table></figure>
<h3 id="容器版"><a href="#容器版" class="headerlink" title="容器版"></a>容器版</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run --restart always -p 2181:2181 -p 2888:2888 -p 3888:3888 -p 8080:8080 -d zookeeper</span><br></pre></td></tr></tbody></table></figure>
<h3 id="集群版"><a href="#集群版" class="headerlink" title="集群版"></a>集群版</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 更多配置，详见下文 “常用配置” 部分</span></span><br><span class="line">$ vim conf/zoo.cfg</span><br><span class="line">  tickTime=2000</span><br><span class="line">  initLimit=10</span><br><span class="line">  syncLimit=5</span><br><span class="line">  dataDir=/home/zookeeper/data/zookeeper</span><br><span class="line">  dataLogDir=/home/zookeeper/logs/zookeeper</span><br><span class="line">  clientPort=2181</span><br><span class="line">  server.1=yuzhouwan01:2281:2282</span><br><span class="line">  server.2=yuzhouwan02:2281:2282</span><br><span class="line">  server.3=yuzhouwan03:2281:2282</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在各个节点的 dataDir下创建 myid 文件，并对应 zoo.cfg中配置的 id</span></span><br><span class="line">[zookeeper@yuzhouwan01 ~] <span class="built_in">echo</span> <span class="string">"1"</span> &gt; /home/zookeeper/data/zookeeper/myid</span><br><span class="line">[zookeeper@yuzhouwan02 ~] <span class="built_in">echo</span> <span class="string">"2"</span> &gt; /home/zookeeper/data/zookeeper/myid</span><br><span class="line">[zookeeper@yuzhouwan03 ~] <span class="built_in">echo</span> <span class="string">"3"</span> &gt; /home/zookeeper/data/zookeeper/myid</span><br></pre></td></tr></tbody></table></figure>
<h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><h3 id="四字命令"><a href="#四字命令" class="headerlink" title="四字命令"></a>四字命令</h3><div class="table-container">
<table>
<thead>
<tr>
<th>Command</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>conf</td>
<td>输出相关<strong>服务配置</strong>的详细信息</td>
</tr>
<tr>
<td>cons</td>
<td>列出所有连接到服务器的客户端的完全的<code>连接</code> / <code>会话</code>的详细信息(包括“接受 / 发送”的包数量、会话 id 、操作延迟、最后的操作执行等等信息)</td>
</tr>
<tr>
<td>envi</td>
<td>输出关于<strong>服务环境</strong>的详细信息 (区别于 conf 命令)</td>
</tr>
<tr>
<td>dump</td>
<td>列出未经处理的会话和临时节点</td>
</tr>
<tr>
<td>stat</td>
<td>查看哪个节点被选择作为 Follower 或者 Leader</td>
</tr>
<tr>
<td>ruok</td>
<td>测试是否启动了该 Server，若回复 <code>imok</code> 表示已经启动</td>
</tr>
<tr>
<td>mntr</td>
<td>输出一些运行时信息（latency / packets / alive_connections / outstanding_requests / server_state / znode + watch + ephemerals  count …）</td>
</tr>
<tr>
<td>reqs</td>
<td>列出未经处理的请求</td>
</tr>
<tr>
<td>wchs</td>
<td>列出服务器 watch 的简要信息</td>
</tr>
<tr>
<td><strong>wchc</strong></td>
<td>通过 session 列出服务器 watch 的详细信息（输出是一个与 watch 相关的会话的列表）</td>
</tr>
<tr>
<td><strong>wchp</strong></td>
<td>通过路径列出服务器 watch 的详细信息（输出一个与 session 相关的路径）</td>
</tr>
<tr>
<td>srvr</td>
<td>输出服务的所有信息（可以用来检查当前节点同步完毕集群数据，处于 Follower 状态）</td>
</tr>
<tr>
<td>srst</td>
<td>重置服务器统计信息</td>
</tr>
<tr>
<td>kill</td>
<td>关掉 Server</td>
</tr>
</tbody>
</table>
</div>
<div class="note danger">部分加粗命令对资源消耗比较大，生产环境慎用!</div>



<h4 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h4><h5 id="安装-Netcat"><a href="#安装-Netcat" class="headerlink" title="安装 Netcat"></a>安装 Netcat</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># online</span></span><br><span class="line">$ yum install nc</span><br><span class="line"></span><br><span class="line"><span class="comment"># offline</span></span><br><span class="line">$ uname -a</span><br><span class="line">  Linux yuzhouwan 2.6.32-279.el6_sn.7.x86_64 <span class="comment">#1 SMP Fri May 27 18:04:25 CST 2016 x86_64 x86_64 x86_64 GNU/Linux</span></span><br><span class="line"><span class="comment"># 搜索rpm包 https://rpmfind.net/linux/rpm2html/search.php?query=nc&amp;submit=Search+...&amp;system=&amp;arch=x86_64</span></span><br><span class="line">$ wget ftp://rpmfind.net/linux/centos/6.9/os/x86_64/Packages/nc-1.84-24.el6.x86_64.rpm</span><br><span class="line">$ rpm -ivh nc-1.84-24.el6.x86_64.rpm</span><br></pre></td></tr></tbody></table></figure>
<h5 id="Netcat-执行"><a href="#Netcat-执行" class="headerlink" title="Netcat 执行"></a>Netcat 执行</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> &lt;four-letter <span class="built_in">command</span>&gt; | nc 127.0.0.1 2181</span><br></pre></td></tr></tbody></table></figure>
<h4 id="DOS-攻击"><a href="#DOS-攻击" class="headerlink" title="DOS 攻击"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://en.wikipedia.org/wiki/Denial-of-service_attack">DOS</a> <a target="_blank" rel="external nofollow noopener noreferrer" href="https://issues.apache.org/jira/browse/ZOOKEEPER-2693">攻击</a></h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 避免 wchp / wchc 四字命令被 DOS 攻击利用</span></span><br><span class="line">$ vim zoo.cfg</span><br><span class="line">  <span class="comment"># 4lw.commands.whitelist=*</span></span><br><span class="line">  4lw.commands.whitelist=<span class="built_in">stat</span>, ruok, conf, isro</span><br></pre></td></tr></tbody></table></figure>
<h4 id="产生的日志"><a href="#产生的日志" class="headerlink" title="产生的日志"></a>产生的日志</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 可以看到 zk.out 文件中出现 0:0:0:0:0:0:0:1（IPv6 的回送地址，相当于 IPv4 的 127.0.0.1）和 Processing xxxx command 相应的日志</span></span><br><span class="line">2017-06-13 23:05:01,998 [myid:5] - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxnFactory@197] - Accepted socket connection from /0:0:0:0:0:0:0:1:40986</span><br><span class="line">2017-06-13 23:05:01,998 [myid:5] - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@827] - Processing srvr <span class="built_in">command</span> from /0:0:0:0:0:0:0:1:40986</span><br><span class="line">2017-06-13 23:05:02,000 [myid:5] - INFO  [Thread-64778:NIOServerCnxn@1007] - Closed socket connection <span class="keyword">for</span> client /0:0:0:0:0:0:0:1:40986 (no session established <span class="keyword">for</span> client)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="执行脚本"><a href="#执行脚本" class="headerlink" title="执行脚本"></a>执行脚本</h3><h4 id="zkServer"><a href="#zkServer" class="headerlink" title="zkServer"></a>zkServer</h4><h5 id="启动-1"><a href="#启动-1" class="headerlink" title="启动"></a>启动</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动</span></span><br><span class="line">$ bin/zkServer.sh start</span><br><span class="line"><span class="comment"># 查看状态</span></span><br><span class="line">$ bin/zkServer.sh status</span><br><span class="line"><span class="comment"># 停止服务</span></span><br><span class="line">$ bin/zkServer.sh stop</span><br><span class="line"><span class="comment"># 重启</span></span><br><span class="line">$ bin/zkServer.sh restart</span><br></pre></td></tr></tbody></table></figure>
<h5 id="排查问题"><a href="#排查问题" class="headerlink" title="排查问题"></a>排查问题</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 可以通过增加 `start-foreground` 参数来排查失败原因</span></span><br><span class="line">$ bin/zkServer.sh start-foreground</span><br><span class="line">  ZooKeeper JMX enabled by default</span><br><span class="line">  Using config: /home/eagle/software/zookeeper/bin/../conf/zoo.cfg</span><br><span class="line">  Error: Could not find or load main class org.apache.zookeeper.server.quorum.QuorumPeerMain</span><br><span class="line"><span class="comment"># /home/eagle/software/zookeeper/zookeeper-3.4.10.jar 的问题，重新下载，校验 md5 正确后，再次安装即可</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="zkCli"><a href="#zkCli" class="headerlink" title="zkCli"></a>zkCli</h4><h5 id="启动-2"><a href="#启动-2" class="headerlink" title="启动"></a>启动</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> <span class="variable">$ZOOKEEPER_HOME</span></span><br><span class="line">$ bin/zkCli -server &lt;zk host&gt;:2181,&lt;zk host&gt;:2181,&lt;zk host&gt;:2181</span><br></pre></td></tr></tbody></table></figure>
<h5 id="节点操作"><a href="#节点操作" class="headerlink" title="节点操作"></a>节点操作</h5><div class="table-container">
<table>
<thead>
<tr>
<th>Command</th>
<th>Example</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>create</td>
<td></td>
<td>创建一个节点</td>
</tr>
<tr>
<td>ls</td>
<td></td>
<td>查看当前节点数据</td>
</tr>
<tr>
<td>set</td>
<td></td>
<td>修改节点</td>
</tr>
<tr>
<td>get</td>
<td></td>
<td>得到一个节点，包含<code>数据</code>和<code>更新次数</code>等信息</td>
</tr>
<tr>
<td>delete</td>
<td></td>
<td>删除一个节点</td>
</tr>
<tr>
<td>deleteall</td>
<td></td>
<td>递归删除</td>
</tr>
<tr>
<td>history</td>
<td></td>
<td>列出最近的历史命令</td>
</tr>
<tr>
<td>redo <code>&lt;command number: n&gt;</code></td>
<td>redo 1</td>
<td>重做第 n 步命令</td>
</tr>
<tr>
<td>stat</td>
<td></td>
<td>打印节点状态</td>
</tr>
<tr>
<td>close</td>
<td></td>
<td>关闭当前连接</td>
</tr>
<tr>
<td>connect <code>&lt;host&gt;:&lt;port&gt;</code></td>
<td>connect localhost:2181</td>
<td>当 close 当前连接或者意外退出后，可在 <code>zkCli</code> 命令模式中重连</td>
</tr>
<tr>
<td>quit</td>
<td></td>
<td>退出当前连接</td>
</tr>
<tr>
<td>setAcl <code>&lt;path&gt; &lt;acl: scheme + id + permissions&gt;</code></td>
<td>setAcl /zk world:anyone:cdrw</td>
<td>设置节点权限策略（详见上文 “基本概念 - ACL” 部分）</td>
</tr>
<tr>
<td>getAcl <code>&lt;path&gt;</code></td>
<td></td>
<td>获取节点权限策略</td>
</tr>
<tr>
<td>addauth <code>&lt;scheme&gt; &lt;auth&gt;</code></td>
<td>addauth digest username:password</td>
<td>节点权限认证</td>
</tr>
<tr>
<td>setquota -n</td>
<td>-b val <code>&lt;path&gt;</code></td>
<td></td>
</tr>
<tr>
<td>listquota <code>&lt;path&gt;</code></td>
<td>listquota /zookeeper</td>
<td>查看节点的配额</td>
</tr>
<tr>
<td></td>
<td>count=5, bytes=-1</td>
<td>/zookeeper 节点个数限额为 5，长度无限额</td>
</tr>
<tr>
<td>delquota <code>[-n or -b]</code> <code>&lt;path&gt;</code></td>
<td></td>
<td></td>
</tr>
<tr>
<td>sync <code>&lt;path&gt;</code></td>
<td></td>
<td>强制同步</td>
</tr>
<tr>
<td></td>
<td></td>
<td>（由于“过半原则”，导致某些 ZooKeeper Server 上的数据是旧的，用 <code>sync</code> 命令可强制同步所有的更新操作）</td>
</tr>
<tr>
<td>printwatches on</td>
<td>off</td>
</tr>
</tbody>
</table>
</div>
<div class="note info">在 3.6.0 版本中，Apache ZooKeeper 通过增加批量删除特性改进了 deleteall 命令的性能，并彻底删除了过期的 rmr 命令</div>

<h5 id="常见组合（for-Kafka）"><a href="#常见组合（for-Kafka）" class="headerlink" title="常见组合（for Kafka）"></a>常见组合（for Kafka）</h5><div class="table-container">
<table>
<thead>
<tr>
<th>Command</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>get /consumers/<code>&lt;topic&gt;</code>/owners</td>
<td>查看 Topic 实时消费的 Group ID</td>
</tr>
<tr>
<td>get /consumers/<code>&lt;topic&gt;</code>/offsets/<code>&lt;group id&gt;</code>/<code>&lt;partitionor&gt;</code></td>
<td>查看 Offset 情况（ctime：创建时间；mtime：修改时间）</td>
</tr>
</tbody>
</table>
</div>
<h2 id="常用配置"><a href="#常用配置" class="headerlink" title="常用配置"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="http://zookeeper.apache.org/doc/current/zookeeperAdmin.html">常用配置</a></h2><h3 id="dataDir"><a href="#dataDir" class="headerlink" title="dataDir"></a>dataDir</h3><p>　ZooKeeper 保存服务器存储快照文件的目录，默认情况，ZooKeeper 将 <code>写数据的日志文件</code>也保存在这个目录里（default：/tmp/zookeeper）</p>
<h3 id="dataLogDir"><a href="#dataLogDir" class="headerlink" title="dataLogDir"></a>dataLogDir</h3><p>　用来存储服务器事务日志</p>
<h3 id="clientPort"><a href="#clientPort" class="headerlink" title="clientPort"></a>clientPort</h3><p>　客户端连接 ZooKeeper 服务器的端口，ZooKeeper 会监听这个端口，接受客户端的访问请求（default：2181）</p>
<h3 id="tickTime（SS-CS）"><a href="#tickTime（SS-CS）" class="headerlink" title="tickTime（SS / CS）"></a>tickTime（SS / CS）</h3><p>　用来指示 <code>服务器</code>之间或<code>客户端</code>与<code>服务器</code>之间维护<code>心跳</code>机制的 最小时间单元，<code>Session</code> 最小过期时间默认为两倍的 tickTime（default：<code>2000</code>ms）</p>
<h3 id="initLimit（LF）"><a href="#initLimit（LF）" class="headerlink" title="initLimit（LF）"></a>initLimit（LF）</h3><p>　集群中的 <code>Leader</code> 节点和 <code>Follower</code> 节点之间<code>初始连接</code>时能容忍的最多心跳数（default：5 tickTime）</p>
<h3 id="syncLimit（LF）"><a href="#syncLimit（LF）" class="headerlink" title="syncLimit（LF）"></a>syncLimit（LF）</h3><p>　集群中的 <code>Leader</code> 节点和 <code>Follower</code> 节点之间<code>请求和应答</code>时能容忍的最多心跳数（default：2 tickTime）</p>
<h3 id="minSessionTimeout-amp-maxSessionTimeout"><a href="#minSessionTimeout-amp-maxSessionTimeout" class="headerlink" title="minSessionTimeout &amp; maxSessionTimeout"></a>minSessionTimeout &amp; maxSessionTimeout</h3><p>　默认分别是 2 * tickTime ~ 20 * tickTime，来用控制 客户端设置的 Session 超时时间。如果超出或者小于，将自动被服务端强制设置为 最大或者最小</p>
<h3 id="maxClientCnxns"><a href="#maxClientCnxns" class="headerlink" title="maxClientCnxns"></a>maxClientCnxns</h3><p>　控制单个客户端（以 IP 地址为唯一标识）创建连接数的上限（default：60），设置为 0 则不作限制</p>
<h3 id="集群节点"><a href="#集群节点" class="headerlink" title="集群节点"></a>集群节点</h3><p>　配置 ZooKeeper 集群中的服务器节点<br>　　格式：<code>server.&lt;myid&gt;</code>=<code>&lt;服务器地址&gt;</code>:<code>&lt;LF通讯端口&gt;</code>:<code>&lt;选举端口&gt;</code><br>　　样例：<code>server.1=yuzhouwan:2888:3888</code></p>
<h3 id="动态配置"><a href="#动态配置" class="headerlink" title="动态配置"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="http://zookeeper.apache.org/doc/r3.5.4-beta/zookeeperReconfig.html">动态配置</a></h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ vim zoo_replicated1.cfg</span><br><span class="line">  tickTime=2000</span><br><span class="line">  dataDir=/zookeeper/data/zookeeper1</span><br><span class="line">  initLimit=5</span><br><span class="line">  syncLimit=2</span><br><span class="line">  dynamicConfigFile=/zookeeper/conf/zoo_replicated1.cfg.dynamic</span><br><span class="line"></span><br><span class="line">$ vim zoo_replicated1.cfg.dynamic</span><br><span class="line">  server.1=125.23.63.23:2780:2783:participant;2791</span><br><span class="line">  server.2=125.23.63.24:2781:2784:participant;2792</span><br><span class="line">  server.3=125.23.63.25:2782:2785:participant;2793</span><br></pre></td></tr></tbody></table></figure>
<h2 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h2><h3 id="采集方式"><a href="#采集方式" class="headerlink" title="采集方式"></a>采集方式</h3><h4 id="JMX"><a href="#JMX" class="headerlink" title="JMX"></a>JMX</h4><h5 id="远程连接"><a href="#远程连接" class="headerlink" title="远程连接"></a>远程连接</h5><p>　ZooKeeper 默认支持 JMX 连接，但是只支持本地连接<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开启远程 JMX</span></span><br><span class="line">$ vim bin/zkServer.sh</span><br><span class="line">  <span class="comment"># ZOOMAIN="-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.local.only=$JMXLOCALONLY org.apache.zookeeper.server.quorum.QuorumPeerMain"</span></span><br><span class="line">  ZOOMAIN=<span class="string">"-Dcom.sun.management.jmxremote.port=8888 -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.authenticate=false org.apache.zookeeper.server.quorum.QuorumPeerMain"</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<h4 id="Four-letter-command"><a href="#Four-letter-command" class="headerlink" title="Four-letter command"></a>Four-letter command</h4><h4 id="TCP-Dump"><a href="#TCP-Dump" class="headerlink" title="TCP Dump"></a>TCP Dump</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 tcpdump 命令，需要在 root 权限下执行</span></span><br><span class="line">$ sudo tcpdump tcp port 2181 and host ! 127.0.0.1</span><br><span class="line">  <span class="comment"># 下面抓包到的信息，是 Curator 远程连接，并在 /children 命名空间下，创建临时节点 /yuzhouwan，最终断开 TCP 连接的过程</span></span><br><span class="line">  14:50:16.192736 IP 10.10.10.10.56342 &gt; yuzhouwan01.eforward: Flags [S], seq 818611125, win 8192, options [mss 1460,nop,wscale 8,nop,nop,sackOK], length 0</span><br><span class="line">  14:50:16.192765 IP yuzhouwan01.eforward &gt; 10.10.10.10.56342: Flags [S.], seq 3867146147, ack 818611126, win 14600, options [mss 1460,nop,nop,sackOK,nop,wscale 7], length 0</span><br><span class="line">  14:50:16.193502 IP 10.10.10.10.56342 &gt; yuzhouwan01.eforward: Flags [.], ack 1, win 256, length 0</span><br><span class="line">  14:50:16.196755 IP 10.10.10.10.56342 &gt; yuzhouwan01.eforward: Flags [P.], seq 1:50, ack 1, win 256, length 49</span><br><span class="line">  14:50:16.196768 IP yuzhouwan01.eforward &gt; 10.10.10.10.56342: Flags [.], ack 50, win 115, length 0</span><br><span class="line">  14:50:16.198618 IP yuzhouwan01.eforward &gt; 10.10.10.10.56342: Flags [P.], seq 1:42, ack 50, win 115, length 41</span><br><span class="line">  14:50:16.214597 IP 10.10.10.10.56342 &gt; yuzhouwan01.eforward: Flags [P.], seq 50:76, ack 42, win 256, length 26</span><br><span class="line">  14:50:16.215109 IP yuzhouwan01.eforward &gt; 10.10.10.10.56342: Flags [P.], seq 42:62, ack 76, win 115, length 20</span><br></pre></td></tr></tbody></table></figure>
<p>Tips: 比较关心的一个问题是，<code>tcpdump</code> 是否会对性能造成影响？答案是：会的。当过滤上千的 IP 时，已经会影响到服务器性能。主要瓶颈在 <code>BPF Filter</code>，这是一个 $O(n)$ 线性时间复杂度的算法，可以考虑 <code>HiPAC 多维树匹配</code> 替代</p>
<h3 id="指标"><a href="#指标" class="headerlink" title="指标"></a>指标</h3><h4 id="ZooKeeper-运行状态（mntr）"><a href="#ZooKeeper-运行状态（mntr）" class="headerlink" title="ZooKeeper 运行状态（mntr）"></a>ZooKeeper 运行状态（mntr）</h4><div class="table-container">
<table>
<thead>
<tr>
<th>Metrics</th>
<th>Comment</th>
<th>Threshold</th>
</tr>
</thead>
<tbody>
<tr>
<td>zk_version</td>
<td>版本</td>
<td></td>
</tr>
<tr>
<td>zk_avg_latency</td>
<td>平均 响应延迟</td>
<td>&gt; 50ms，比上次统计增长超过 20ms，且上一次延迟不为 0</td>
</tr>
<tr>
<td>zk_max_latency</td>
<td>最大 响应延迟</td>
<td></td>
</tr>
<tr>
<td>zk_min_latency</td>
<td>最小 响应延迟</td>
<td></td>
</tr>
<tr>
<td>zk_packets_received</td>
<td>收包数</td>
<td></td>
</tr>
<tr>
<td>zk_packets_sent</td>
<td>发包数</td>
<td></td>
</tr>
<tr>
<td>zk_num_alive_connections</td>
<td>活跃连接数</td>
<td>&gt; 3000</td>
</tr>
<tr>
<td>zk_outstanding_requests</td>
<td>堆积请求数</td>
<td>连续两次大于 5（粒度：1min）</td>
</tr>
<tr>
<td>zk_server_state</td>
<td>主从状态</td>
<td>由 Leader 变为 Follower 或 由 Follower 变为 Leader</td>
</tr>
<tr>
<td>zk_znode_count</td>
<td>znode 数</td>
<td>&gt; 40000</td>
</tr>
<tr>
<td>zk_watch_count</td>
<td>watch 数</td>
<td>&gt; 50000</td>
</tr>
<tr>
<td>zk_ephemerals_count</td>
<td>临时节点数</td>
<td></td>
</tr>
<tr>
<td>zk_approximate_data_size</td>
<td>近似数据总和大小</td>
<td></td>
</tr>
<tr>
<td>zk_open_file_descriptor_count</td>
<td>打开 <code>文件描述符</code> 数</td>
<td></td>
</tr>
<tr>
<td>zk_max_file_descriptor_count</td>
<td>最大 <code>文件描述符</code> 数</td>
<td></td>
</tr>
<tr>
<td><strong>zk_followers</strong></td>
<td>Follower 数</td>
<td></td>
</tr>
<tr>
<td><strong>zk_synced_followers</strong></td>
<td>已同步的 Follower 数</td>
<td>连续两次检测到未同步的 Follower 节点 (粒度：1min)</td>
</tr>
<tr>
<td><strong>zk_pending_syncs</strong></td>
<td>阻塞中的 sync 操作</td>
</tr>
</tbody>
</table>
</div>
<div class="note info">加粗指标，只有 Leader 节点才会有</div>






<h3 id="实时预警"><a href="#实时预警" class="headerlink" title="实时预警"></a>实时预警</h3><h4 id="numenta-nupic"><a href="#numenta-nupic" class="headerlink" title="numenta / nupic"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/numenta">numenta</a> / <strong><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/numenta/nupic">nupic</a></strong></h4><p>　NuPIC<code>（Numenta Platform for Intelligent Computing，Numenta智能计算平台）</code> 是一个与众不同的开源人工智能平台，它基于一种<code>脑皮质学习算法</code>，即 “层级实时记忆”（<strong>H</strong>ierarchical <strong>T</strong>emporal <strong>M</strong>emory，<a target="_blank" rel="external nofollow noopener noreferrer" href="https://numenta.com/assets/pdf/whitepapers/hierarchical-temporal-memory-cortical-learning-algorithm-0.2.1-en.pdf">HTM</a>）。该算法旨在模拟新大脑皮层的工作原理，将复杂的问题转化为模式匹配与预测，而传统的 AI 算法大多是针对特定的任务目标而设计的<br>　NuPIC 聚焦于分析实时数据流，可以通过学习数据之间基于时间的状态变化（而非阀值设置），对未知数据进行预测，并揭示其中的非常规特性。详见我的另一篇博客：<a href="https://yuzhouwan.com/posts/42737/#开源项目">人工智能</a></p>
<h2 id="性能调优"><a href="#性能调优" class="headerlink" title="性能调优"></a>性能调优</h2><h3 id="Benchmark"><a href="#Benchmark" class="headerlink" title="Benchmark"></a>Benchmark</h3><p>　<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/brownsys">brownsys</a> / <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/brownsys/zookeeper-benchmark">zookeeper-benchmark</a> （很难找到合适的开源项目，需自己编写 Benchmark 工具）</p>
<h3 id="优化策略"><a href="#优化策略" class="headerlink" title="优化策略"></a>优化策略</h3><h4 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h4><h5 id="日志目录"><a href="#日志目录" class="headerlink" title="日志目录"></a>日志目录</h5><ul>
<li>快照目录 dataDir 和 事务日志目录 dataLogDir 分离</li>
<li>写事务日志的目录，需要保证目录空间足够大，并挂载到单独的磁盘上（为了保证<code>数据的一致性</code>，ZooKeeper 在返回客户端事务请求响应之前，必须要将此次请求对应的<code>事务日志</code>刷入到磁盘中 [forceSync 参数控制，default：yes]，所以事务日志的写入速度，直接决定了 ZooKeeper 的吞吐率）</li>
</ul>
<h5 id="自动日志清理"><a href="#自动日志清理" class="headerlink" title="自动日志清理"></a>自动日志清理</h5><h6 id="autopurge-purgeInterval"><a href="#autopurge-purgeInterval" class="headerlink" title="autopurge.purgeInterval"></a>autopurge.purgeInterval</h6><p>　指定清理频率，单位为小时（default：0 表示不开启自动清理）</p>
<h6 id="autopurge-snapRetainCount"><a href="#autopurge-snapRetainCount" class="headerlink" title="autopurge.snapRetainCount"></a>autopurge.snapRetainCount</h6><p>　和上面 <code>purgeInterval</code> 参数配合使用，指定需要保留的文件数目（default：3）</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ vim conf/zoo.cfg</span><br><span class="line">  autopurge.snapRetainCount=3</span><br><span class="line">  autopurge.purgeInterval=1</span><br><span class="line"><span class="comment"># 注意：ZooKeeper 重启会自动清除 zookeeper.out 日志，如果有排错需要，则应先备份好日志文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果发现单事务日志量过大，导致定时清理无法及时处理，可以使用 zkCleanup.sh 进行手动清除</span></span><br><span class="line">$ <span class="built_in">cd</span> ~/software/zookeeper1</span><br><span class="line">$ zookeeper1/bin/zkCleanup.sh /home/zookeeper/logs/zookeeper1/version-2/ 3</span><br><span class="line">  Removing file: Aug 9, 2017 12:08:49 PM    /home/zookeeper/logs/zookeeper1/version-2/log.1c00000001</span><br><span class="line">  Removing file: Aug 9, 2017 02:03:33 PM    /home/zookeeper/data/zookeeper1/version-2/snapshot.1c0000ab90</span><br></pre></td></tr></tbody></table></figure>
<h5 id="Log4j-滚动日志"><a href="#Log4j-滚动日志" class="headerlink" title="Log4j 滚动日志"></a>Log4j 滚动日志</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> <span class="variable">$ZOOKEEPER_HOME</span></span><br><span class="line">$ vim conf/log4j.properties</span><br><span class="line">  zookeeper.root.logger=INFO, CONSOLE</span><br><span class="line">  zookeeper.console.threshold=INFO</span><br><span class="line">  zookeeper.log.dir=.</span><br><span class="line">  zookeeper.log.file=zookeeper.log</span><br><span class="line">  zookeeper.log.threshold=DEBUG</span><br><span class="line">  zookeeper.tracelog.dir=.</span><br><span class="line">  zookeeper.tracelog.file=zookeeper_trace.log</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 可以调整为 DaliyRollingFileAppender，每天滚动创建新的日志文件</span></span><br><span class="line">  log4j.appender.ROLLINGFILE=org.apache.log4j.RollingFileAppender</span><br><span class="line">  log4j.appender.ROLLINGFILE.Threshold=<span class="variable">${zookeeper.log.threshold}</span></span><br><span class="line">  log4j.appender.ROLLINGFILE.File=<span class="variable">${zookeeper.log.dir}</span>/<span class="variable">${zookeeper.log.file}</span></span><br><span class="line"></span><br><span class="line">$ vim bin/zkServer.sh</span><br><span class="line">  <span class="comment"># 增加 ZOO_LOG_DIR 配置</span></span><br><span class="line">  ZOO_LOG_DIR=<span class="variable">$ZOOBINDIR</span>/../log4j</span><br><span class="line"></span><br><span class="line">$ vim bin/zkEnv.sh</span><br><span class="line">  <span class="comment"># if [ "x${ZOO_LOG4J_PROP}" = "x" ]</span></span><br><span class="line">  <span class="comment"># then</span></span><br><span class="line">  <span class="comment">#     ZOO_LOG4J_PROP="INFO,CONSOLE"</span></span><br><span class="line">  <span class="comment"># fi</span></span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">"x<span class="variable">${ZOO_LOG4J_PROP}</span>"</span> = <span class="string">"x"</span> ]</span><br><span class="line">  <span class="keyword">then</span></span><br><span class="line">      ZOO_LOG4J_PROP=<span class="string">"INFO,ROLLINGFILE"</span></span><br><span class="line">  <span class="keyword">fi</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="Observer-模式"><a href="#Observer-模式" class="headerlink" title="Observer 模式"></a>Observer 模式</h4><h5 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h5><h6 id="对读请求进行扩展"><a href="#对读请求进行扩展" class="headerlink" title="对读请求进行扩展"></a>对读请求进行扩展</h6><p>　通过增加更多的 <code>Observer</code>，可以接收更多的<code>读请求</code>流量，却不会牺牲<code>写操作</code>的吞吐量（写操作的吞吐量取决于 <code>quorum</code> 法定人数的个数）<br>　如果增加更多的 Server 进行投票，Quorum 会变大，这会降低<code>写操作</code>的吞吐量<br>　然而增加 <code>Observer</code> 并不会完全没有损耗，新的 <code>Observer</code> 在提交一个事务后收到一条额外的 <code>INFORM</code> 消息。这个损耗比加入 <code>Follower</code> 进行投票来说会小很多</p>
<p><img data-src="/picture/zk/zk_observer_throughput.png" alt></p>
<center>（图片来源：<a href="https://issues.apache.org/jira/browse/ZOOKEEPER-368" target="_blank" rel="external nofollow noopener noreferrer">Observers: core functionality</a>™）</center>


<h6 id="跨数据中心部署"><a href="#跨数据中心部署" class="headerlink" title="跨数据中心部署"></a>跨数据中心部署</h6><p>　把 <code>participant</code> 分散到多个数据中心，可能会因为数据中心之间的网络延迟，导致系统被拖慢<br>　使用 <code>Observer</code> 的话，更新操作都在单独的数据中心来处理，再发送到其他数据中心，让 <code>Client</code> 消费数据（分布式数据库[中美异地机房]同步系统 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/alibaba/otter">Otter</a> 就使用该模式）</p>
<p><img data-src="/picture/zk/zk_ovserver_multi_cyberroom.png" alt></p>
<center>（利用 <a href="https://www.axure.com.cn/" target="_blank" rel="external nofollow noopener noreferrer">Axure</a>™ 绘制而成）</center>

<h5 id="设置"><a href="#设置" class="headerlink" title="设置"></a>设置</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ vim conf/zoo.cfg</span><br><span class="line">  peerType=observer</span><br><span class="line">  server.1:localhost:2181:3181:observer <span class="comment"># 其他需要扩展成 Observer 的 Server 都需要加上 `:observer` 后缀</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="INFORM-消息"><a href="#INFORM-消息" class="headerlink" title="INFORM 消息"></a>INFORM 消息</h5><p>　因为 Observer 不参与到 ZAB 选举中，所以 Leader 节点不会发送 proposal 给 Observer，只会发送一条包含<code>已经通过选举的 zxid</code> 的 INFORM 消息。这里，参与 ZAB 选举的 Leader、Follower 节点称之为 <code>PARTICIPANT</code> Server，而 Observer 则属于 <code>OBSERVER</code> Server</p>
<h4 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h4><h5 id="JVM-相关"><a href="#JVM-相关" class="headerlink" title="JVM 相关"></a>JVM 相关</h5><h6 id="swappiness"><a href="#swappiness" class="headerlink" title="swappiness"></a>swappiness</h6><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> <span class="variable">$ZOOKEEEPER_HOME</span></span><br><span class="line"><span class="comment"># 常驻进程，需要避免 swapping 损害性能</span></span><br><span class="line"><span class="comment"># 临时生效</span></span><br><span class="line">$ <span class="built_in">echo</span> 0 &gt; /proc/sys/vm/swappiness</span><br><span class="line"><span class="comment"># 永久生效</span></span><br><span class="line">$ vim /etc/sysctl.conf</span><br><span class="line">  vm.swappiness=0 <span class="comment"># memory first</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置 `-XX:+AlwaysPreTouch` 参数，在进程启动的时候，让 jvm 通过 demand-zeroed 方式将内存一次分配到位（ES #16937 / ZK #301）</span></span><br><span class="line"><span class="comment"># 使用 CMS 垃圾回收器（“jdk7 + 内存使用不多” 的缘故，可以暂不考虑 G1GC）</span></span><br><span class="line">$ vim conf/java.env</span><br><span class="line">  <span class="built_in">export</span> JVMFLAGS=<span class="string">"-Xms3G -Xmx3G -Xmn1G -XX:+AlwaysPreTouch -XX:CMSInitiatingOccupancyFraction=70 -XX:+UseParNewGC -XX:+UseConcMarkSweepGC"</span></span><br><span class="line">  <span class="comment"># 如果需要打印 GC 日志，则多增加一些 flag</span></span><br><span class="line">  <span class="built_in">export</span> JVMFLAGS=<span class="string">"-Xms3G -Xmx3G -Xmn1G -XX:+AlwaysPreTouch -XX:CMSInitiatingOccupancyFraction=70 -XX:+UseParNewGC -XX:+UseConcMarkSweepGC -XX:+PrintGCDetails -XX:-PrintGCTimeStamps -Xloggc:/home/zookeeper/logs/zookeeper_`date '+%Y%m%d%H%M%S'`.gc -XX:-UseGCLogFileRotation -XX:NumberOfGCLogFiles=10 -XX:GCLogFileSize=64M"</span></span><br><span class="line">  <span class="comment"># 需要注意的是，如果不希望 zkCli 等命令创建 gc 日志文件，需要把 JVMFLAGS 改成 SERVER_JVMFLAGS</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 更进一步，如果有四字命令在做监控，则建议，直接修改 zkServer.sh，否则因为 zookeeper_`date '+%Y%m%d%H%M%S'`.gc 的存在，导致每次四字命令执行，会有很多小日志被创建（ZK#302 已解决，待分析）</span></span><br><span class="line">$ vim bin/zkServer.sh</span><br><span class="line">  start)</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    START_SERVER_JVMFLAGS=<span class="string">"-Xms3G -Xmx3G -Xmn1G -XX:+AlwaysPreTouch -XX:CMSInitiatingOccupancyFraction=70 -XX:+UseParNewGC -XX:+UseConcMarkSweepGC -XX:+PrintGCDetails -XX:-PrintGCTimeStamps -Xloggc:/home/zookeeper/logs/zookeeper_`date '+%Y%m%d%H%M%S'`.gc -XX:-UseGCLogFileRotation -XX:NumberOfGCLogFiles=10 -XX:GCLogFileSize=64M"</span></span><br><span class="line">    nohup <span class="string">"<span class="variable">$JAVA</span>"</span> <span class="variable">$ZOO_DATADIR_AUTOCREATE</span> <span class="string">"-Dzookeeper.log.dir=<span class="variable">${ZOO_LOG_DIR}</span>"</span> \</span><br><span class="line">    <span class="string">"-Dzookeeper.log.file=<span class="variable">${ZOO_LOG_FILE}</span>"</span> <span class="string">"-Dzookeeper.root.logger=<span class="variable">${ZOO_LOG4J_PROP}</span>"</span> \</span><br><span class="line">    -XX:+HeapDumpOnOutOfMemoryError -XX:OnOutOfMemoryError=<span class="string">'kill -9 %p'</span> \</span><br><span class="line">    -cp <span class="string">"<span class="variable">$CLASSPATH</span>"</span> <span class="variable">$JVMFLAGS</span> <span class="variable">$START_SERVER_JVMFLAGS</span> <span class="variable">$ZOOMAIN</span> <span class="string">"<span class="variable">$ZOOCFG</span>"</span> &gt; <span class="string">"<span class="variable">$_ZOO_DAEMON_OUT</span>"</span> 2&gt;&amp;1 &lt; /dev/null &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 堆大小的最终确定，需要在 benchmark 结果的基础之上，再做调整</span></span><br><span class="line"><span class="comment"># 另外，一旦创建完该文件，ZooKeeper 进程会自动加载，因此，需要确保无误之后，再建立 java.env 文件</span></span><br></pre></td></tr></tbody></table></figure>
<h6 id="升级-JDK8"><a href="#升级-JDK8" class="headerlink" title="升级 JDK8"></a>升级 JDK8</h6><p>　为何建议升级 JDK8 呢？因为 ZooKeeper 里面很多关键的功能点，都用到了 Atomic 类，而该类在 JDK8 中做了一次升级，性能提升了 6x 倍（JDK8 中加入了 <code>Unsafe.getUnsafe().getAnd[Add|Set][Int|Long|Object]</code> 一系列方法对 Atomic 类做了增强，由于无法看到 Oracle JDK 里 Unsafe 的相关实现，有兴趣可以参考 <a target="_blank" rel="external nofollow noopener noreferrer" href="http://hg.openjdk.java.net/jdk8u/hs-dev/jdk/file/a006fa0a9e8f/src/share/classes/sun/misc/Unsafe.java">OpenJDK 源码</a>。目前，存在一种比较靠谱的猜测是，<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/aeste/gcc/blob/master/libjava/sun/misc/natUnsafe.cc#L52"><code>compare-and-swap</code></a> 被替换成系统底层的 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/aeste/gcc/blob/d2774faa810502779b6e39b1e1578ceafde5f4cd/gcc/sync-builtins.def#L31"><code>fetch-and-add</code></a>，后者用 <strong>lock xadd</strong> 替代了 <strong>lock cmpxchg</strong> 来实现原子操作。其中 指令前缀 <strong>lock</strong> 用来锁定指令涉及的存储区域，<strong>xadd</strong> 指令作用是 交换两个操作数的值，再进行加法操作，<strong>cmpxchg</strong> 比较交换指令，第一操作数先和 <code>AL/AX/EAX</code> 比较，如果相等 <code>ZF</code> 置 1，第二操作数赋给第一操作数，否则 <code>ZF</code> 清 0，第一操作数赋给 <code>AL/AX/EAX</code>。由此可见，<strong>xadd</strong> 指令实现的 FAA 和 <strong>cmpxchg</strong> 指令实现的 CAS 相比，并没有自旋，因此不用担心循环时间过长之后 CPU 资源消耗过大，并且也没有了 CAS 中 ABA 之类的问题 [该问题在 AtomicStampedReference 中，通过增加版本号解决了]）</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 源码</span></span><br><span class="line"><span class="comment"># JDK 8 - AtomicInteger</span></span><br><span class="line">public final int <span class="function"><span class="title">getAndIncrement</span></span>() {</span><br><span class="line">  <span class="built_in">return</span> unsafe.getAndAddInt(this, valueOffset, 1);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment"># JDK7 - AtomicInteger</span></span><br><span class="line">public final int <span class="function"><span class="title">getAndIncrement</span></span>() {</span><br><span class="line">    <span class="keyword">for</span> (;;) {</span><br><span class="line">        int current = get();</span><br><span class="line">        int next = current + 1;</span><br><span class="line">        <span class="keyword">if</span> (compareAndSet(current, next)) <span class="built_in">return</span> current;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">## 汇编</span></span><br><span class="line"><span class="comment"># JDK 8</span></span><br><span class="line">0x0000000002cf49c7: mov    %rbp,0x10(%rsp)</span><br><span class="line">  0x0000000002cf49cc: mov    <span class="variable">$0x1</span>,%eax</span><br><span class="line">  0x0000000002cf49d1: lock xadd %eax,0xc(%rdx)  ;*invokevirtual getAndAddInt</span><br><span class="line">                                                ; - java.util.concurrent.atomic.AtomicInteger::incrementAndGet@8 (line 186)</span><br><span class="line"></span><br><span class="line"><span class="comment"># JDK 7</span></span><br><span class="line">0x0000000002c207f5: lock cmpxchg %r8d,0xc(%rdx)</span><br><span class="line">  0x0000000002c207fb: sete   %r11b</span><br><span class="line">  0x0000000002c207ff: movzbl %r11b,%r11d        ;*invokevirtual compareAndSwapInt</span><br><span class="line">                                                ; - java.util.concurrent.atomic.AtomicInteger::compareAndSet@9 (line 135)</span><br><span class="line">                                                ; - java.util.concurrent.atomic.AtomicInteger::incrementAndGet@12 (line 206)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 指令</span></span><br><span class="line"><span class="comment"># JDK 8</span></span><br><span class="line">XADD—Exchange and Add</span><br><span class="line">  Exchanges the first operand (destination operand) with the second operand (<span class="built_in">source</span> operand), <span class="keyword">then</span> loads the sum of the two values into the destination operand. The destination operand can be a register or a memory location; the <span class="built_in">source</span> operand is a register.</span><br><span class="line">  In 64-bit mode, the instruction’s default operation size is 32 bits. Using a REX prefix <span class="keyword">in</span> the form of REX.R permits access to additional registers (R8-R15). Using a REX prefix <span class="keyword">in</span> the form of REX.W promotes operation to 64 bits. See the summary chart at the beginning of this section <span class="keyword">for</span> encoding data and limits.</span><br><span class="line">  This instruction can be used with a LOCK prefix to allow the instruction to be executed atomically.</span><br><span class="line"></span><br><span class="line">TEMP ← SRC + DEST;</span><br><span class="line">SRC ← DEST;</span><br><span class="line">DEST ← TEMP;</span><br><span class="line"></span><br><span class="line"><span class="comment"># JDK 7</span></span><br><span class="line">CMPXCHG—Compare and Exchange</span><br><span class="line">  Compares the value <span class="keyword">in</span> the AL, AX, EAX, or RAX register with the first operand (destination operand). If the two values are equal, the second operand (<span class="built_in">source</span> operand) is loaded into the destination operand. Otherwise, the destination operand is loaded into the AL, AX, EAX or RAX register. RAX register is available only <span class="keyword">in</span> 64-bit mode.</span><br><span class="line">  This instruction can be used with a LOCK prefix to allow the instruction to be executed atomically. To simplify the interface to the processor’s bus, the destination operand receives a write cycle without regard to the result of the comparison. The destination operand is written back <span class="keyword">if</span> the comparison fails; otherwise, the <span class="built_in">source</span> operand is written into the destination. (The processor never produces a locked <span class="built_in">read</span> without also producing a locked write.)</span><br><span class="line">  In 64-bit mode, the instruction’s default operation size is 32 bits. Use of the REX.R prefix permits access to additional registers (R8-R15). Use of the REX.W prefix promotes operation to 64 bits. See the summary chart at the beginning of this section <span class="keyword">for</span> encoding data and limits.</span><br><span class="line"></span><br><span class="line">(* Accumulator = AL, AX, EAX, or RAX depending on whether a byte, word, doubleword, or quadword comparison is being performed *)</span><br><span class="line">TEMP ← DEST</span><br><span class="line">IF accumulator = TEMP</span><br><span class="line">  THEN</span><br><span class="line">    ZF ← 1;</span><br><span class="line">    DEST ← SRC;</span><br><span class="line">  ELSE</span><br><span class="line">    ZF ← 0;</span><br><span class="line">    accumulator ← TEMP;</span><br><span class="line">    DEST ← TEMP;</span><br><span class="line">FI;</span><br></pre></td></tr></tbody></table></figure>
<p>Tips: 这里 CAS 还有一个预测分支的损耗，有兴趣可以进一步研究一个问题：为何有序数组的 <code>for</code> 循环遍历，会比无序数组快，以及如何解决？</p>
<p>　截止本文编写时间 <code>2017-6-20 (master:111ae5a)</code>，一共有 70 个 Atomic 实例在 ZooKeeper 中被初始化并使用</p>
<p><img data-src="/picture/zk/zk_atomic.png" alt></p>
<center>（对 <a href="https://www.jetbrains.com/idea/" target="_blank" rel="external nofollow noopener noreferrer">IntelliJ IDEA</a>™ 的截图）</center>



<h6 id="G1GC"><a href="#G1GC" class="headerlink" title="G1GC"></a>G1GC</h6><p>　在不牺牲吞吐性能的前提下，<code>G1GC</code> 并能更好地控制 GC 的停顿时间，因此非常合适 ZooKeeper 这类需要控制<code>心跳超时时间（tickTime）</code>的服务<br>　在多处理器和大容量内存的环境下，能更快速地整理空闲空间，避免产生过多的内存碎片<br>　这里只罗列一些常用的配置和特定情况下，需要调整的参数，具体调整到多少才算最佳，还是需要依据 <code>ZooKeeper 具体的使用场景</code>、<code>Beachmark 的结果</code>和 <code>GC 日志</code>的分析</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>Params</th>
<th>Meaning</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>-XX:+UseG1GC</td>
<td>使用 G1GC</td>
<td></td>
</tr>
<tr>
<td>-XX:G1HeapRegionSize=4m</td>
<td>设置内存分块的大小（1MB~32MB）</td>
<td>当系统中存在大量大对象的时候，大的 Region 会提升 GC 效率</td>
</tr>
<tr>
<td>-XX:MaxGCPauseMillis=200（ms）</td>
<td>此值为建议 <code>JVM</code> 的最长暂停时间</td>
<td>只是建议值，G1GC 只能尽量保证，而无法完全保证</td>
</tr>
<tr>
<td>-XX:InitiatingHeap OccupancyPercent=45</td>
<td>设置使用了<code>整个堆的 n%</code> 时，系统开始进行并行 GC</td>
<td>注意是<strong>整个堆</strong>的百分比。这与 CMS 收集器的类似参数不同</td>
</tr>
<tr>
<td>-XX:ParallelGCThreads=n</td>
<td>设置 STW 工作线程数的值</td>
<td>默认线程数由 CPU 数量决定，通常小于逻辑处理器的个数 m</td>
</tr>
<tr>
<td></td>
<td></td>
<td><strong>m&lt;=8</strong>: $n=m$;</td>
</tr>
<tr>
<td></td>
<td></td>
<td><strong>m&gt;8 &amp; system!=<a target="_blank" rel="external nofollow noopener noreferrer" href="https://en.wikipedia.org/wiki/SPARC">SPARC</a></strong>: $n\approx5/8*m$;</td>
</tr>
<tr>
<td></td>
<td></td>
<td><strong>m&gt;8 &amp; system=SPARC</strong>: $n\approx5/16*m$</td>
</tr>
<tr>
<td></td>
<td></td>
<td>当有较大的 Update RSet 时间时，可以尝试调整此值</td>
</tr>
<tr>
<td>-XX:ConcGCThreads=n</td>
<td>设置并行标记的线程数</td>
<td>mixed GC 情况下，较长的 cycle start 时间，可以尝试调整此值</td>
</tr>
<tr>
<td></td>
<td></td>
<td>$n\approx1/4 * ParallelGCThreads$</td>
</tr>
<tr>
<td>-XX:+ParallelRefProcEnabled</td>
<td>当看到有较长的 Ref Proc 建议配置此值</td>
<td>CMS 收集器和 G1 收集器均有这个问题。配置以后暂停明显缩小</td>
</tr>
</tbody>
</table>
</div>
<h6 id="LongAdder"><a href="#LongAdder" class="headerlink" title="LongAdder"></a>LongAdder</h6><p>　考虑使用 LongAdder（author：<a target="_blank" rel="external nofollow noopener noreferrer" href="http://ifeve.com/doug-lea/">Doug Lea</a>）<a target="_blank" rel="external nofollow noopener noreferrer" href="https://issues.apache.org/jira/browse/ZOOKEEPER-2790">替代 AtomicLong</a>，以提高效率，下面用 100 个线程去 increment 计算 1kw 次，发现效率大致相差 6 倍（已提交 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://issues.apache.org/jira/browse/ZOOKEEPER-2790">jira</a> 欢迎讨论）</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -Xmx512M -Xms512M -Xmn256M -XX:+AlwaysPreTouch -ea</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pressureLongAdder</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">final</span> LongAdder longAdder = <span class="keyword">new</span> LongAdder();</span><br><span class="line">    ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">    <span class="keyword">long</span> startTime = System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) {</span><br><span class="line">        executorService.submit(<span class="keyword">new</span> Thread(() -&gt; {</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">1000_0000</span>; j++) {</span><br><span class="line">                longAdder.increment();</span><br><span class="line">            }</span><br><span class="line">            System.out.print(String.format(<span class="string">"%s %s \t"</span>, Thread.currentThread().getId(), longAdder.longValue()));</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            14 19607585 	12 36445036 	20 38985288 	38 76821270 	70 117094732 	18 127252576</span></span><br><span class="line"><span class="comment">            22 137043349 	26 153411172 	30 164051380 	34 165971155  	102 192241678 	134 201104979</span></span><br><span class="line"><span class="comment">            158 232657818 	46 279030056 	174 288502545 	94 347965290 	198 348060553 	118 348087414</span></span><br><span class="line"><span class="comment">            36 353092712 	28 357762215 	44 365464475 	126 379518198 	54 379623515 	182 380077075</span></span><br><span class="line"><span class="comment">            142 385263911 	78 389013887 	62 389085727 	110 389122678 	86 389920423 	166 393535019</span></span><br><span class="line"><span class="comment">            150 396382512 	190 403100499 	32 403161217 	208 403197689 	206 406065520 	16 410725026</span></span><br><span class="line"><span class="comment">            24 415347205 	40 415379997 	48 415733397 	104 418507295 	192 423244160 	176 455793362</span></span><br><span class="line"><span class="comment">            168 458311865 	160 463028656 	136 496375440 	72 541243645 	186 561877000 	170 575352229</span></span><br><span class="line"><span class="comment">            162 584152392 	154 604552121 	138 614092854 	64 638151890 	114 668705836 	58 669235250</span></span><br><span class="line"><span class="comment">            188 699213410 	156 729222401 	124 754336889 	100 784326386 	76 813479501 	120 827569944</span></span><br><span class="line"><span class="comment">            66 830236567 	98 832153503 	112 841408676 	204 849520891 	210 852391130 	202 864804732</span></span><br><span class="line"><span class="comment">            172 875603834 	194 877222893 	200 881090909 	88 882809513 	80 882846368 	56 887174571</span></span><br><span class="line"><span class="comment">            178 889682247 	140 901357028 	146 902169049 	184 904540678 	152 915608988 	130 917896629</span></span><br><span class="line"><span class="comment">            116 924616135 	144 927674541 	122 930399321 	128 939791111 	106 942656234 	84 950848174</span></span><br><span class="line"><span class="comment">            96 951904067 	90 954910184 	74 964338213 	196 966487766 	82 968307139 	52 975854400</span></span><br><span class="line"><span class="comment">            180 977385398 	164 978882525 	50 980896807 	148 988292352 	132 989090669 	108 996891232</span></span><br><span class="line"><span class="comment">            92 996921398 	42 996938988 	68 996953941 	60 1000000000</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">        }));</span><br><span class="line">    }</span><br><span class="line">    executorService.shutdown();</span><br><span class="line">    <span class="keyword">while</span> (!executorService.isTerminated()) {</span><br><span class="line">        Thread.sleep(<span class="number">1</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">long</span> endTime = System.currentTimeMillis();</span><br><span class="line">    System.out.println(<span class="string">"\n"</span> + (endTime - startTime));    <span class="comment">// 3275 ms</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// -Xmx512M -Xms512M -Xmn128M -XX:+AlwaysPreTouch -ea</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pressureAtomicLong</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">final</span> AtomicLong atomicLong = <span class="keyword">new</span> AtomicLong();</span><br><span class="line">    ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">    <span class="keyword">long</span> startTime = System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) {</span><br><span class="line">        executorService.submit(<span class="keyword">new</span> Thread(() -&gt; {</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">1000_0000</span>; j++) {</span><br><span class="line">                atomicLong.getAndIncrement();</span><br><span class="line">            }</span><br><span class="line">            System.out.print(String.format(<span class="string">"%s %s \t"</span>, Thread.currentThread().getId(), atomicLong.longValue()));</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            12 390000000 	28 390000000 	44 390000000 	20 390000000 	26 390000000 	18 390000000</span></span><br><span class="line"><span class="comment">            80 390000000 	56 390000000 	96 390000000 	24 390000000 	88 390000000 	72 390000000</span></span><br><span class="line"><span class="comment">            22 390000000 	118 390000000 	54 390000000 	142 390000000 	70 390000000 	86 390000000</span></span><br><span class="line"><span class="comment">            182 390000000 	110 390000000 	62 390000000 	78 390000000 	102 390000000 	158 390000000</span></span><br><span class="line"><span class="comment">            150 390000000 	46 390000000 	38 390000000 	126 390000000 	94 390000000 	134 390000000</span></span><br><span class="line"><span class="comment">            14 390000000 	48 390000000 	40 390000000 	32 390000000 	34 390000000 	64 390000000</span></span><br><span class="line"><span class="comment">            42 390000000 	36 390000000 	16 390000000 	180 416396554 	204 419908287 	196 425536497</span></span><br><span class="line"><span class="comment">            92 732203658 	30 733835560 	202 733835559 	210 733873571 	146 733878564 	186 733883527</span></span><br><span class="line"><span class="comment">            170 733888686 	76 733892691 	84 733888815 	148 733901560 	162 733907032 	172 733908079</span></span><br><span class="line"><span class="comment">            52 733913280 	116 733918421 	124 733906868 	164 733920945 	132 733891348 	68 733923672</span></span><br><span class="line"><span class="comment">            108 733924928 	156 733926091 	60 733921998 	140 733927257 	188 733928891 	154 733871822</span></span><br><span class="line"><span class="comment">            194 733830477 	178 733872527 	100 733830322 	106 748251688 	144 1000000000 	98 1000000000</span></span><br><span class="line"><span class="comment">            58 1000000000 	90 1000000000 	130 1000000000 	138 1000000000 	114 1000000000 	104 1000000000</span></span><br><span class="line"><span class="comment">            168 1000000000 	200 1000000000 	184 1000000000 	160 1000000000 	174 1000000000 	112 1000000000</span></span><br><span class="line"><span class="comment">            190 1000000000 	198 1000000000 	82 1000000000 	206 1000000000 	166 1000000000 	176 1000000000</span></span><br><span class="line"><span class="comment">            136 1000000000 	208 1000000000 	74 1000000000 	122 1000000000 	152 1000000000 	192 1000000000</span></span><br><span class="line"><span class="comment">            120 1000000000 	128 1000000000 	66 1000000000 	50 1000000000</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">        }));</span><br><span class="line">    }</span><br><span class="line">    executorService.shutdown();</span><br><span class="line">    <span class="keyword">while</span> (!executorService.isTerminated()) {</span><br><span class="line">        Thread.sleep(<span class="number">1</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">long</span> endTime = System.currentTimeMillis();</span><br><span class="line">    System.out.println(<span class="string">"\n"</span> + (endTime - startTime));    <span class="comment">// 19409 ms</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>　下面从源码的角度来分析，首先 LongAdder 继承于 Striped64 类，实现了类似 AtomicLong 的一些 <code>add / increment / decrement / sum / longValue</code> 等方法</p>
<p><img data-src="/picture/zk/zk_long_adder_striped64_number.png" alt></p>
<center>（对 <a href="https://www.jetbrains.com/idea/" target="_blank" rel="external nofollow noopener noreferrer">IntelliJ IDEA</a>™ 的截图）</center>

<p>　分析 LongAdder 里面最为核心的一个 <code>add</code> 方法<br></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Adds the given value.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> x the value to add</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">long</span> x)</span> </span>{</span><br><span class="line">    Cell[] as; <span class="keyword">long</span> b, v; <span class="keyword">int</span> m; Cell a;</span><br><span class="line">    <span class="keyword">if</span> ((as = cells) != <span class="keyword">null</span> || !casBase(b = base, b + x)) {</span><br><span class="line">        <span class="keyword">boolean</span> uncontended = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (as == <span class="keyword">null</span> || (m = as.length - <span class="number">1</span>) &lt; <span class="number">0</span> || (a = as[getProbe() &amp; m]) == <span class="keyword">null</span> ||</span><br><span class="line">            !(uncontended = a.cas(v = a.value, v + x)))</span><br><span class="line">            longAccumulate(x, <span class="keyword">null</span>, uncontended);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><br>　可以看到里面用到了一个 <code>java.util.concurrent.atomic.Striped64.Cell</code> 类，作为最终存放数据的地方，比较特别是，这里是一个数组，而不是 AtomicLong 里面看到的 <code>volatile long</code> 变量，并且 <code>Cell[]</code> 数组的长度是以 <code>2</code> 的指数级进行增长的，到这里多少可以看出 LongAdder 有点想以<strong>空间换时间</strong>的端倪了。之所以是用 <code>Cell[]</code> 数组，是考虑到可以将更新操作分而治之，不必对单一变量进行竞争，而是将压力均分到整个数组里面，这样如果需要得到 <code>LongAdder</code> 的值，只需要做一次 <code>sum</code> 操作<p></p>
<p>　并且，看 <code>add</code> 方法的第一个 <code>if</code> 分支，<code>cells</code> 是一个 lazy init 的变量，也就是只要是在<strong>单线程无并发</strong>的场景下，就会直接调用 <code>casBase</code> 方法完成 CAS 赋值并返回。如此一来，可以节省下创建数组带来的资源消耗。那么，如果在多线程并发的场景下，<code>casBase</code> 执行失败，则会进行第二个 <code>if</code> 分支的判断，这样就可以发挥 <code>Cell[]</code> 的作用了（AtomicLong 中则是用 while 循环不断进行尝试）。此时 <code>Cell[] as</code> 尚未初始化，因此会进入到 <code>if</code> 分支内，执行 <code>longAccumulate</code> 方法</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Table of cells. When non-null, size is a power of 2.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">volatile</span> Cell[] cells;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Padded variant of AtomicLong supporting only raw accesses plus CAS.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * JVM intrinsics note: It would be possible to use a release-only</span></span><br><span class="line"><span class="comment"> * form of CAS here, if it were provided.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@sun</span>.misc.Contended <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Cell</span> </span>{</span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">long</span> value;</span><br><span class="line">    Cell(<span class="keyword">long</span> x) { value = x; }</span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">cas</span><span class="params">(<span class="keyword">long</span> cmp, <span class="keyword">long</span> val)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> UNSAFE.compareAndSwapLong(<span class="keyword">this</span>, valueOffset, cmp, val);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// Unsafe mechanics</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> sun.misc.Unsafe UNSAFE;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> valueOffset;</span><br><span class="line">    <span class="keyword">static</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            UNSAFE = sun.misc.Unsafe.getUnsafe();</span><br><span class="line">            Class&lt;?&gt; ak = Cell.class;</span><br><span class="line">            valueOffset = UNSAFE.objectFieldOffset</span><br><span class="line">                (ak.getDeclaredField(<span class="string">"value"</span>));</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>　<code>longAccumulate</code> 会首先调用 <code>getProbe</code> 方法获取一个 <code>Probe</code> 当前线程的探测值（利用 <code>java.util.concurrent.ThreadLocalRandom#getProbe</code> 返回随机整数值），因为 <code>Probe</code> 值是通过反射 <code>Thread</code> 类的 <code>threadLocalRandomProbe</code> 变量获取的，而 <code>threadLocalRandomProbe</code> 也是 lazy init，所以如果为 int 默认值 <code>0</code> 的时候，需要用 <code>ThreadLocalRandom.current()</code> 方法进行强制初始化（此处用的是 mix64 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://softwareengineering.stackexchange.com/questions/49550/which-hashing-algorithm-is-best-for-uniqueness-and-speed">伪随机数算法</a>，该算法由 Austin Appleby 于  08 年提出的 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://en.wikipedia.org/wiki/MurmurHash">MurmurHash3</a> 算法的一种变种实现，可以说已经统一了整个伪随机领域，在 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/antirez/redis/blob/unstable/src/dict.c#L90"><code>Redis</code></a>、<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/memcached/memcached/blob/master/murmur3_hash.c"><code>Memcached</code></a>、<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/utils/MurmurHash.java"><code>Cassandra</code></a>、<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/apache/hbase/blob/master/hbase-common/src/main/java/org/apache/hadoop/hbase/util/MurmurHash.java"><code>HBase</code></a>、<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/apache/lucene-solr/blob/master/lucene/codecs/src/java/org/apache/lucene/codecs/bloom/MurmurHash2.java"><code>Lucene</code></a> 和 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/elastic/elasticsearch/blob/master/core/src/main/java/org/elasticsearch/common/hash/MurmurHash3.java"><code>ElasticSearch</code></a> 等各大流行框架中看到 MurmurHash 的身影，具体可参考 Doug Lea 的<a target="_blank" rel="external nofollow noopener noreferrer" href="http://gee.cs.oswego.edu/dl/papers/oopsla14.pdf">这篇论文</a>）</p>
<p>　随后进入 <code>for (;;)</code> 死循环，这时候会先判断 <code>Cell[]</code> 数组是否为空、长度是否大于 <code>0</code>，如果 <code>Cell[]</code> 未完成初始化，则会去判断 <code>cellsBusy</code> 自旋锁是否为 <code>0</code>，来控制 <code>Cell[]</code> 创建和 resize 大小时的原子性。如果自旋锁为 <code>0</code>，则将其通过 <code>casCellsBusy()</code> 方法设置为 <code>1</code>，之后完成初始化工作并将 <code>cellsBusy</code> 重置为 <code>0</code>（默认 <code>Cell[]</code> 的 size 为 2）</p>
<p>　完成 <code>Cell[]</code> 数组初始化之后，会进入 <code>for (;;)</code> 死循环的第一个 <code>if</code> 分支，计算 <code>as[(n - 1) &amp; h] = as[(2 - 1) &amp; -217768167] = as[1]</code> 获取到一个随机 <code>Cell</code> 是否为空；如果 <code>Cell</code> 为空，则新建 <code>Cell(x)</code> 存入到 <code>Cell[]</code> 的空槽位中；如果 <code>Cell</code> 不为空，则进一步判断 <code>wasUncontended</code> 参数是否为 <code>false</code>，如果是，则说明是预料到可能的冲突，则置为 <code>true</code> 继续尝试新的 <code>Cell</code>；下一个分支 <code>a.cas(v = a.value, ((fn == null) ? v + x : fn.applyAsLong(v, x)))</code> 则是进行对应的操作，这里 <code>fn</code> 为空，则执行 <code>+</code> 累加操作；接下来的一个分支 <code>n &gt;= NCPU || cells != as</code> 则是考虑到 <code>Cell[]</code> 的长度对比操作系统的 <strong>可用虚拟 CPU 核数</strong> 和 <strong>并发竞争的激烈程度</strong>，来判断是否碰撞严重，并和下一个分支一起控制 <code>collide</code> 变量来做标示；最后一个 <code>if</code> 分支 <code>cellsBusy == 0 &amp;&amp; casCellsBusy()</code>，如果到了这里，仍然没有完成 <code>add()</code> 方法的执行，说明需要通过扩展一倍的 <code>Cell[]</code> 数组来满足当前的并发量，之后再次重试，然后会不出意外地落入 <code>a.cas(v = a.value, ((fn == null) ? v + x : fn.applyAsLong(v, x)))</code> 第三个 <code>if</code> 分支中，最终完成 <code>add()</code> 方法</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Handles cases of updates involving initialization, resizing,</span></span><br><span class="line"><span class="comment"> * creating new Cells, and/or contention. See above for</span></span><br><span class="line"><span class="comment"> * explanation. This method suffers the usual non-modularity</span></span><br><span class="line"><span class="comment"> * problems of optimistic retry code, relying on rechecked sets of</span></span><br><span class="line"><span class="comment"> * reads.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> x the value</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fn the update function, or null for add (this convention</span></span><br><span class="line"><span class="comment"> * avoids the need for an extra field or function in LongAdder).</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> wasUncontended false if CAS failed before call</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">longAccumulate</span><span class="params">(<span class="keyword">long</span> x, LongBinaryOperator fn,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">boolean</span> wasUncontended)</span> </span>{</span><br><span class="line">    <span class="keyword">int</span> h;</span><br><span class="line">    <span class="keyword">if</span> ((h = getProbe()) == <span class="number">0</span>) {</span><br><span class="line">        ThreadLocalRandom.current(); <span class="comment">// force initialization</span></span><br><span class="line">        h = getProbe();</span><br><span class="line">        wasUncontended = <span class="keyword">true</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">boolean</span> collide = <span class="keyword">false</span>;                <span class="comment">// True if last slot nonempty</span></span><br><span class="line">    <span class="keyword">for</span> (;;) {</span><br><span class="line">        Cell[] as; Cell a; <span class="keyword">int</span> n; <span class="keyword">long</span> v;</span><br><span class="line">        <span class="keyword">if</span> ((as = cells) != <span class="keyword">null</span> &amp;&amp; (n = as.length) &gt; <span class="number">0</span>) {</span><br><span class="line">            <span class="keyword">if</span> ((a = as[(n - <span class="number">1</span>) &amp; h]) == <span class="keyword">null</span>) {</span><br><span class="line">                <span class="keyword">if</span> (cellsBusy == <span class="number">0</span>) {       <span class="comment">// Try to attach new Cell</span></span><br><span class="line">                    Cell r = <span class="keyword">new</span> Cell(x);   <span class="comment">// Optimistically create</span></span><br><span class="line">                    <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; casCellsBusy()) {</span><br><span class="line">                        <span class="keyword">boolean</span> created = <span class="keyword">false</span>;</span><br><span class="line">                        <span class="keyword">try</span> {               <span class="comment">// Recheck under lock</span></span><br><span class="line">                            Cell[] rs; <span class="keyword">int</span> m, j;</span><br><span class="line">                            <span class="keyword">if</span> ((rs = cells) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                                (m = rs.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                                rs[j = (m - <span class="number">1</span>) &amp; h] == <span class="keyword">null</span>) {</span><br><span class="line">                                rs[j] = r;</span><br><span class="line">                                created = <span class="keyword">true</span>;</span><br><span class="line">                            }</span><br><span class="line">                        } <span class="keyword">finally</span> {</span><br><span class="line">                            cellsBusy = <span class="number">0</span>;</span><br><span class="line">                        }</span><br><span class="line">                        <span class="keyword">if</span> (created) <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">continue</span>;           <span class="comment">// Slot is now non-empty</span></span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">                collide = <span class="keyword">false</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (!wasUncontended)       <span class="comment">// CAS already known to fail</span></span><br><span class="line">                wasUncontended = <span class="keyword">true</span>;      <span class="comment">// Continue after rehash</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (a.cas(v = a.value, ((fn == <span class="keyword">null</span>) ? v + x : fn.applyAsLong(v, x))))</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (n &gt;= NCPU || cells != as) collide = <span class="keyword">false</span>;            <span class="comment">// At max size or stale</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (!collide) collide = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; casCellsBusy()) {</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    <span class="keyword">if</span> (cells == as) {      <span class="comment">// Expand table unless stale</span></span><br><span class="line">                        Cell[] rs = <span class="keyword">new</span> Cell[n &lt;&lt; <span class="number">1</span>];</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; ++i) rs[i] = as[i];</span><br><span class="line">                        cells = rs;</span><br><span class="line">                    }</span><br><span class="line">                } <span class="keyword">finally</span> {</span><br><span class="line">                    cellsBusy = <span class="number">0</span>;</span><br><span class="line">                }</span><br><span class="line">                collide = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">continue</span>;                   <span class="comment">// Retry with expanded table</span></span><br><span class="line">            }</span><br><span class="line">            h = advanceProbe(h);</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; cells == as &amp;&amp; casCellsBusy()) {</span><br><span class="line">            <span class="keyword">boolean</span> init = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">try</span> {                           <span class="comment">// Initialize table</span></span><br><span class="line">                <span class="keyword">if</span> (cells == as) {</span><br><span class="line">                    Cell[] rs = <span class="keyword">new</span> Cell[<span class="number">2</span>];</span><br><span class="line">                    rs[h &amp; <span class="number">1</span>] = <span class="keyword">new</span> Cell(x);</span><br><span class="line">                    cells = rs;</span><br><span class="line">                    init = <span class="keyword">true</span>;</span><br><span class="line">                }</span><br><span class="line">            } <span class="keyword">finally</span> {</span><br><span class="line">                cellsBusy = <span class="number">0</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">if</span> (init) <span class="keyword">break</span>;</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (casBase(v = base, ((fn == <span class="keyword">null</span>) ? v + x : fn.applyAsLong(v, x)))) <span class="keyword">break</span>; <span class="comment">// Fall back on using base</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>总结：</p>
<ul>
<li><p><strong>高并发处理能力</strong><br> 从架构的角度来说，<code>AtomicLong</code> 中使用的是单一变量 <code>volatile long</code>，而在 <code>LongAdder</code> 中使用的是 <code>Cell[]</code>，这可以将并发的压力分摊到整个数组上，而非单个变量，可以更加得心应手地处理高并发的场景</p>
</li>
<li><p><strong>低资源消耗</strong><br> <code>Cell[]</code> 数组是延迟初始化的，并且在扩容的操作，是在考虑到 CPU 的核数（即机器的处理能力）和数组操作的碰撞次数（即并发的激烈程度）之后才会发生，尽可能地优化了资源的使用率</p>
</li>
<li><p><strong>更为高效的汇编指令</strong><br> 使用的是 <code>lock xadd</code> 而非 <code>lock cmpxchg</code> 指令来实现原子操作的，避免了 CAS 的 ABA、高并发下不断自旋 导致的 CPU 资源消耗过大、预测分支失败等问题</p>
</li>
</ul>
<h5 id="ZooKeeper-相关"><a href="#ZooKeeper-相关" class="headerlink" title="ZooKeeper 相关"></a>ZooKeeper 相关</h5><h6 id="leaderServes"><a href="#leaderServes" class="headerlink" title="leaderServes"></a>leaderServes</h6><p>　<code>zookeeper.leaderServes</code> 参数用于控制，Leader 节点是否可以被 Client 端连接，默认值为 <code>yes</code><br>　理论上 Leader 可以处理所有 Client 的读写请求，但是在 ZooKeeper 的架构设计中，Leader 的主要作用来对<code>事务更新请求</code>以及集群本身的<code>运行时协调</code><br>　所以，设置成 <code>no</code>，可使得 Leader 节点不接受 Client 端的连接请求，以提高分布式协调能力</p>
<h6 id="jute-maxbuffer"><a href="#jute-maxbuffer" class="headerlink" title="jute.maxbuffer"></a>jute.maxbuffer</h6><p>　<code>jute.maxbuffer</code> 参数用于控制，单个 ZNode 上最大可以存储的数据量，默认值为 1048575（1M - 1, 由<code>BinaryInputArchive.maxBuffer</code> 变量控制）<br>　因为 ZooKeeper 旨在存储大小为<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-bigdata/yuzhouwan-bigdata-zookeeper/src/test/java/com/yuzhouwan/bigdata/zookeeper/benchmark/ZKBenchmark.java#L98">千字节（1KB）</a> 的数据，因此通常情况下，需要下调这个阀值<br>　需要注意的是，该参数并不是在 Server 和 Client 端同时设置才会生效。实际情况是，在客户端设置后，ZooKeeper 将控制从 Server 端读取数据的大小（<strong>outgoingBuffer</strong>）；而在服务端设置后，则是控制从 Client 端写入数据的大小（<strong>incomingBuffer</strong>）<br>　换句话说，如果 Server 端不设置 maxbuffer，单 <code>ZNode</code> 结点最大可能的写入数据量为 $1024 \cdot 1024 - 42$ $= 1048534$。因为，在数据量达到 1M 的默认限制之前，会因为 <code>org.apache.zookeeper.server.NIOServerCnxn#readLength</code> 中的查看 buffer size 时，<code>lenBuffer.getInt()</code> 的调用就已经抛出了 <code>BufferUnderflowException</code> 了。而如果 Client 端不设置 maxbuffer，将不会对从 Server 端读取到的数据包大小做限制。但是，如果设置了，例如 maxbuffer=1024，但是其实 Client 最大能拿到的数据包大约只有 $1024 - 88 = 936$，因为除了数据本身，还包含了 <code>ReplyHeader（xid/zxid/err, 例如 1,3274,0\n，一般占 9 字节）</code>、<code>Record（Stat，例如 s{2,2,1495790235732,1495790235732,0,2874,0,0,0,0,3273}\n），一般占 55 字节</code>、<code>Tag，例如 response，一般占 8 字节</code> 等其他序列化信息</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置 Client 端</span></span><br><span class="line">$ vim <span class="variable">$ZOOKEEPER_HOME</span>/bin/zkCli.sh</span><br><span class="line">  <span class="comment"># 增加 -Djute.maxbuffer=&lt;buffer_size&gt; 参数</span></span><br><span class="line">  <span class="string">"<span class="variable">$JAVA</span>"</span> <span class="string">"-Dzookeeper.log.dir=<span class="variable">${ZOO_LOG_DIR}</span>"</span> <span class="string">"-Dzookeeper.root.logger=<span class="variable">${ZOO_LOG4J_PROP}</span>"</span>  <span class="string">"-Djute.maxbuffer=1073741824"</span>  \</span><br><span class="line">       -cp <span class="string">"<span class="variable">$CLASSPATH</span>"</span> <span class="variable">$CLIENT_JVMFLAGS</span> <span class="variable">$JVMFLAGS</span> \</span><br><span class="line">       org.apache.zookeeper.ZooKeeperMain <span class="string">"<span class="variable">$@</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置 Server 端</span></span><br><span class="line">$ vim <span class="variable">$ZOOKEEPER_HOME</span>/conf/zoo.cfg</span><br><span class="line">  <span class="comment"># 增加 jute.maxbuffer=&lt;buffer_size&gt; 参数</span></span><br><span class="line">  jute.maxbuffer=1073741824</span><br></pre></td></tr></tbody></table></figure>
<h6 id="globalOutstandingLimit"><a href="#globalOutstandingLimit" class="headerlink" title="globalOutstandingLimit"></a>globalOutstandingLimit</h6><p>　<code>zookeeper.globalOutstandingLimit</code> 参数用于控制，服务器最大请求堆积量，默认值为 1000<br>　为防止服务端资源（内存、CPU、网络）被耗尽，根据服务器最大处理能力，可做适当调整</p>
<h6 id="snapCount-amp-preAllocSize"><a href="#snapCount-amp-preAllocSize" class="headerlink" title="snapCount &amp; preAllocSize"></a>snapCount &amp; preAllocSize</h6><p>　<code>zookeeper.snapCount</code> 参数用于控制，两次快照之间事务操作的次数，默认值为 100,000<br>　<code>zookeeper.preAllocSize</code> 参数用于控制，事务日志文件预分配磁盘的大小，默认值为 65536KB（64MB）<br>　两个参数配合设置，可以依据特定业务场景下的事务操作数据量 <code>transactionDataSize</code>，按照 $snapCount * transactionDataSize \ge preAllocSize$ 公式进行适当调整</p>
<h6 id="zookeeper-serverCnxnFactory-amp-zookeeper-clientCnxnSocket"><a href="#zookeeper-serverCnxnFactory-amp-zookeeper-clientCnxnSocket" class="headerlink" title="zookeeper.serverCnxnFactory &amp; zookeeper.clientCnxnSocket"></a>zookeeper.serverCnxnFactory &amp; zookeeper.clientCnxnSocket</h6><p>　在 3.5 版本之后，默认<a target="_blank" rel="external nofollow noopener noreferrer" href="https://issues.apache.org/jira/browse/ZOOKEEPER-733">使用</a> Netty，在此之前的版本，ZooKeeper 支持将默认使用的 NIO，替代为 Netty。通过在服务端和客户端分配配置以下两个配置项<br>　<code>zookeeper.serverCnxnFactory</code> 设置为 <code>org.apache.zookeeper.server.NettyServerCnxnFactory</code><br>　<code>zookeeper.clientCnxnSocket</code> 设置为 <code>org.apache.zookeeper.ClientCnxnSocketNetty</code></p>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><h3 id="源码环境搭建"><a href="#源码环境搭建" class="headerlink" title="源码环境搭建"></a>源码环境搭建</h3><h4 id="下载源码"><a href="#下载源码" class="headerlink" title="下载源码"></a>下载源码</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基于 branch-3.4 进行分析</span></span><br><span class="line">$ git fetch https://github.com/apache/zookeeper.git branch-3.4:branch-3.4</span><br></pre></td></tr></tbody></table></figure>
<h4 id="下载安装-Ant"><a href="#下载安装-Ant" class="headerlink" title="下载安装 Ant"></a>下载安装 Ant</h4><ul>
<li>Download: <a target="_blank" rel="external nofollow noopener noreferrer" href="http://archive.apache.org/dist/ant/binaries/apache-ant-1.9.9-bin.tar.gz">apache-ant-1.9.9-bin.tar.gz</a></li>
<li>安装并设置环境变量</li>
</ul>
<h4 id="执行-Ant-命令"><a href="#执行-Ant-命令" class="headerlink" title="执行 Ant 命令"></a>执行 Ant 命令</h4><h5 id="编译出-IDE-可识别的环境"><a href="#编译出-IDE-可识别的环境" class="headerlink" title="编译出 IDE 可识别的环境"></a>编译出 IDE 可识别的环境</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> %ZOOKEEPER_SOURCE_PATH%</span><br><span class="line">$ ls | grep build.xml</span><br><span class="line">  build.xml</span><br><span class="line">$ ant clean</span><br><span class="line">$ ant eclipse</span><br><span class="line"><span class="comment"># 随后使用 Intellij Idea 导入</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="二次开发后，进行本地测试"><a href="#二次开发后，进行本地测试" class="headerlink" title="二次开发后，进行本地测试"></a>二次开发后，进行本地测试</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 优先编写 JUnit TestCase 进行测试，随后再利用 `ant test-core` 进行一次整体的测试</span></span><br><span class="line">$ ant -Dtest.junit.output.format=xml -Dtest.output=yes -Dtest.junit.threads=2 -Dcompile.c++=yes <span class="built_in">test</span>-core</span><br></pre></td></tr></tbody></table></figure>
<h5 id="打包编译"><a href="#打包编译" class="headerlink" title="打包编译"></a>打包编译</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ant clean tar -Dbuild.compiler=javac1.7</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果报错 warning: macro 'AM_PATH_CPPUNIT' not found in library，则需要先安装 cppunit</span></span><br><span class="line"><span class="comment"># 并且，需要保证在 root 用户下执行 ant 编译</span></span><br><span class="line">$ yum install cppunit</span><br></pre></td></tr></tbody></table></figure>
<h4 id="运行-ZooKeeperServerMain"><a href="#运行-ZooKeeperServerMain" class="headerlink" title="运行 ZooKeeperServerMain"></a>运行 ZooKeeperServerMain</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置 Program arguments</span></span><br><span class="line"><span class="comment"># Usage: ZooKeeperServerMain configfile | port datadir [ticktime] [maxcnxns]</span></span><br><span class="line"><span class="comment"># 传参</span></span><br><span class="line">  2181 E:\data\zk</span><br><span class="line"><span class="comment"># 或者指定配置文件</span></span><br><span class="line">$ cp zoo_sample.cfg zoo.cfg</span><br><span class="line">$ vim zoo.cfg</span><br><span class="line">  <span class="comment"># dataDir=/tmp/zookeeper</span></span><br><span class="line">  dataDir=E:/data/zk</span><br></pre></td></tr></tbody></table></figure>
<h4 id="遇到的坑"><a href="#遇到的坑" class="headerlink" title="遇到的坑"></a>遇到的坑</h4><h5 id="下载依赖超时"><a href="#下载依赖超时" class="headerlink" title="下载依赖超时"></a>下载依赖超时</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ vim build.xml</span><br><span class="line">  <span class="comment"># 替换 ant-eclipse 下载地址</span></span><br><span class="line">  <span class="comment"># get src="http://downloads.sourceforge.net/project/ant-eclipse/ant-eclipse/1.0/ant-eclipse-1.0.bin.tar.bz2"</span></span><br><span class="line">  get src=<span class="string">"http://ufpr.dl.sourceforge.net/project/ant-eclipse/ant-eclipse/1.0/ant-eclipse-1.0.bin.tar.bz2"</span></span><br><span class="line"></span><br><span class="line">$ vim ivy.xml</span><br><span class="line">  <span class="comment"># 增加 commons-coolections 依赖</span></span><br><span class="line">  &lt;dependency org=<span class="string">"commons-collections"</span> name=<span class="string">"commons-collections"</span> rev=<span class="string">"3.0"</span>/&gt;</span><br></pre></td></tr></tbody></table></figure>
<h5 id="PowerMock-测试-TestingServer-报错-ClassCastException"><a href="#PowerMock-测试-TestingServer-报错-ClassCastException" class="headerlink" title="PowerMock 测试 TestingServer 报错 ClassCastException"></a>PowerMock 测试 TestingServer 报错 ClassCastException</h5><h6 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h6><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">17:32:55.821 [Thread-1] ERROR o.a.c.test.TestingZooKeeperServer - From testing server (random state: <span class="literal">false</span>) <span class="keyword">for</span> instance: InstanceSpec{dataDirectory=/var/folders/4z/h5ftkmm90vg5s7j0kv65j0gw0000gp/T/1542274365502-0, port=2181, electionPort=64470, quorumPort=64471, deleteDataDirectoryOnClose=<span class="literal">true</span>, serverId=1, tickTime=-1, maxClientCnxns=-1, customProperties={}, hostname=127.0.0.1} org.apache.curator.test.InstanceSpec@59c3be02</span><br><span class="line">java.lang.ClassCastException: class sun.security.provider.ConfigFile</span><br><span class="line">	at java.lang.Class.asSubclass(Class.java:3404) ~[na:1.8.0_171]</span><br><span class="line">	at javax.security.auth.login.Configuration<span class="variable">$2</span>.run(Configuration.java:254) ~[na:1.8.0_171]</span><br><span class="line">	at javax.security.auth.login.Configuration<span class="variable">$2</span>.run(Configuration.java:247) ~[na:1.8.0_171]</span><br><span class="line">	at java.security.AccessController.doPrivileged(Native Method) ~[na:1.8.0_171]</span><br><span class="line">	at javax.security.auth.login.Configuration.getConfiguration(Configuration.java:246) ~[na:1.8.0_171]</span><br><span class="line">	at org.apache.zookeeper.server.ServerCnxnFactory.configureSaslLogin(ServerCnxnFactory.java:189) ~[na:3.4.11-37e277162d567b55a07d1755f0b31c32e93c01a0]</span><br><span class="line">	at org.apache.zookeeper.server.NIOServerCnxnFactory.configure(NIOServerCnxnFactory.java:82) ~[na:3.4.11-37e277162d567b55a07d1755f0b31c32e93c01a0]</span><br><span class="line">	at org.apache.zookeeper.server.ZooKeeperServerMain.runFromConfig(ZooKeeperServerMain.java:119) ~[na:3.4.11-37e277162d567b55a07d1755f0b31c32e93c01a0]</span><br><span class="line">	at org.apache.curator.test.TestingZooKeeperMain.runFromConfig(TestingZooKeeperMain.java:93) ~[na:2.12.0]</span><br><span class="line">	at org.apache.curator.test.TestingZooKeeperServer<span class="variable">$1</span>.run(TestingZooKeeperServer.java:148) ~[na:2.12.0]</span><br><span class="line">	at java.lang.Thread.run(Thread.java:748) [na:1.8.0_171]</span><br></pre></td></tr></tbody></table></figure>
<h6 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h6><p>因为 Mock 使用自定义 <code>ClassLoader</code> 来完成字节码修改，而对于一些需要使用系统原生 <code>ClassLoader</code>的类，则需要通过 <code>@PowerMockIgnore</code> 注解来显式地告知 Mock 框架跳过它们</p>
<h6 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h6><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@RunWith(PowerMockRunner.class)</span><br><span class="line">@PrepareForTest({Test.class})</span><br><span class="line">@PowerMockIgnore({<span class="string">"javax.net.ssl.*"</span>, <span class="string">"javax.management.*"</span>, <span class="string">"javax.security.*"</span>, <span class="string">"javax.crypto.*"</span>})</span><br></pre></td></tr></tbody></table></figure>
<h3 id="选主机制"><a href="#选主机制" class="headerlink" title="选主机制"></a>选主机制</h3><h4 id="ZAB-选主流程"><a href="#ZAB-选主流程" class="headerlink" title="ZAB 选主流程"></a>ZAB 选主流程</h4><h5 id="ZooKeeper-提供的选主算法"><a href="#ZooKeeper-提供的选主算法" class="headerlink" title="ZooKeeper 提供的选主算法"></a>ZooKeeper 提供的选主算法</h5><p>　ZooKeeper 提供了 LeaderElection / FastLeaderElection（UDP） / AuthFastLeaderElection（UDP） / <strong>FastLeaderElection（TCP）</strong> 这四种选主算法（初始化 QuorumPeer 时需指定到 electionAlg 参数），前三种策略因为 <code>UDP 的不可靠性</code>和 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://issues.apache.org/jira/browse/ZOOKEEPER-569"><code>LE 中被选举的 Leader 故障会导致无休止的选举</code></a>等问题，在 v3.4.0 开始被<a target="_blank" rel="external nofollow noopener noreferrer" href="https://issues.apache.org/jira/browse/ZOOKEEPER-1153">废弃</a></p>
<h5 id="Vote-数据结构"><a href="#Vote-数据结构" class="headerlink" title="Vote 数据结构"></a>Vote 数据结构</h5><p><img data-src="/picture/zk/zk_vote_server_state.png" alt></p>
<center>（利用 <a href="https://www.axure.com.cn/" target="_blank" rel="external nofollow noopener noreferrer">Axure</a>™ 绘制而成）</center>

<h5 id="QuorumCnxManager-网络通讯"><a href="#QuorumCnxManager-网络通讯" class="headerlink" title="QuorumCnxManager 网络通讯"></a>QuorumCnxManager 网络通讯</h5><p>　<code>QuorumCnxManager</code> 起到管理 Election 过程中<code>网络连接</code>、<code>投票接受和发送</code>的作用。通过在 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/apache/zookeeper/blob/master/src/java/main/org/apache/zookeeper/server/quorum/QuorumCnxManager.java#L605">QuorumCnxManager.Listener</a> 中创建 <code>ServerSocket</code> 对象监听 Leader 选举的通信端口（default：3888），接收到 创建连接的请求后，由 <code>receiveConnection</code> 方法来处理，并在 <code>handleConnection</code> 方法中对连接的合法性进行处理，包括 接受的数据是否合法（大小不可小于 <code>0</code>，大于 <code>maxBuffer 2048 [硬编码]</code>）、权限控制。之后，会对 SID 进行判断，如果 <code>mySID</code> 大于接受到的 SID 要大，则会执行 <code>closeSocket</code> 方法断开连接，并执行 <code>SendWorker#finish</code> 关闭对应 SID 的 SendWorker。反之，则会创建 SendWorker 和 RecvWorker 并启动。此举可用来确保，只有 SID 更高的节点才会主动创建连接，避免重复的 TCP 连接</p>
<p><img data-src="/picture/zk/zk_quorum_cnx_manager.png" alt></p>
<center>（利用 <a href="https://www.axure.com.cn/" target="_blank" rel="external nofollow noopener noreferrer">Axure</a>™ 绘制而成）</center>


<h5 id="LE-实现细节"><a href="#LE-实现细节" class="headerlink" title="LE 实现细节"></a>LE 实现细节</h5><p>　最终进行选举的逻辑实现，都在 FastLeaderElection 中<br><img data-src="/picture/zk/zk_fastLeader_election.png" alt></p>
<center>（利用 <a href="https://www.axure.com.cn/" target="_blank" rel="external nofollow noopener noreferrer">Axure</a>™ 绘制而成）</center>


<p>　首先会发送投给自身的一条选票，并进入 <code>LOOKING</code> 状态，不断接受外部的选票。再接收到选票之后，会对<code>选票的轮次（logicalclock）</code>、<code>事务 ID（ZXID）</code>、<code>服务器 ID（SID）</code>依次进行比较，如果有一项比自身的值更大，则会更新自身的选票，并重新发送给其他 Quorum；否则，将忽略外部接受的选票，并统计是否<code>已过半</code>。最终，如果选票已经被过半数的 Quorum 节点所接受（Accept），则更新服务器状态，完成选举；否则，继续进入 <code>LOOKING</code> 状态，重复之前的步骤</p>
<p><img data-src="/picture/zk/zk_leader_election_flow.png" alt></p>
<center>（利用 <a href="https://www.axure.com.cn/" target="_blank" rel="external nofollow noopener noreferrer">Axure</a>™ 绘制而成）</center>

<p>　相关实现代码如下<br></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Starts a new round of leader election. Whenever our QuorumPeer</span></span><br><span class="line"><span class="comment"> * changes its state to LOOKING, this method is invoked, and it</span></span><br><span class="line"><span class="comment"> * sends notifications to all other peers.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Vote <span class="title">lookForLeader</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>{</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Loop in which we exchange notifications until we find a leader</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">while</span> ((self.getPeerState() == ServerState.LOOKING) &amp;&amp; (!stop)){</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Sends more notifications if have not received enough.</span></span><br><span class="line"><span class="comment">         * Otherwise processes new notification.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span>(n == <span class="keyword">null</span>) { <span class="comment">// ... }</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (self.getCurrentAndNextConfigVoters().contains(n.sid)) {</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * Only proceed if the vote comes from a replica in the current or next voting view.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">switch</span> (n.state) {</span><br><span class="line">            <span class="keyword">case</span> LOOKING:</span><br><span class="line">                <span class="keyword">if</span> (getInitLastLoggedZxid() == -<span class="number">1</span>) {</span><br><span class="line">                    LOG.debug(<span class="string">"Ignoring notification as our zxid is -1"</span>); <span class="keyword">break</span>;</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">if</span> (n.zxid == -<span class="number">1</span>) {</span><br><span class="line">                    LOG.debug(<span class="string">"Ignoring notification from member with -1 zxid"</span> + n.sid); <span class="keyword">break</span>;</span><br><span class="line">                }</span><br><span class="line">                <span class="comment">// If notification &gt; current, replace and send messages out</span></span><br><span class="line">                <span class="keyword">if</span> (n.electionEpoch &gt; logicalclock.get()) {</span><br><span class="line">                    logicalclock.set(n.electionEpoch);</span><br><span class="line">                    recvset.clear();</span><br><span class="line">                    <span class="keyword">if</span> (totalOrderPredicate(n.leader, n.zxid, n.peerEpoch, getInitId(), getInitLastLoggedZxid(), getPeerEpoch())) {</span><br><span class="line">                        updateProposal(n.leader, n.zxid, n.peerEpoch);</span><br><span class="line">                    } <span class="keyword">else</span> {</span><br><span class="line">                        updateProposal(getInitId(), getInitLastLoggedZxid(), getPeerEpoch());</span><br><span class="line">                    }</span><br><span class="line">                    sendNotifications();</span><br><span class="line">                } <span class="keyword">else</span> <span class="keyword">if</span> (n.electionEpoch &lt; logicalclock.get()) {</span><br><span class="line">                    <span class="keyword">if</span>(LOG.isDebugEnabled()){</span><br><span class="line">                        LOG.debug(<span class="string">"Notification election epoch is smaller than logicalclock. n.electionEpoch = 0x"</span></span><br><span class="line">                                + Long.toHexString(n.electionEpoch)</span><br><span class="line">                                + <span class="string">", logicalclock=0x"</span> + Long.toHexString(logicalclock.get()));</span><br><span class="line">                    }</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                } <span class="keyword">else</span> <span class="keyword">if</span> (totalOrderPredicate(n.leader, n.zxid, n.peerEpoch, proposedLeader, proposedZxid, proposedEpoch)) {</span><br><span class="line">                    updateProposal(n.leader, n.zxid, n.peerEpoch);</span><br><span class="line">                    sendNotifications();</span><br><span class="line">                }</span><br><span class="line">                recvset.put(n.sid, <span class="keyword">new</span> Vote(n.leader, n.zxid, n.electionEpoch, n.peerEpoch)); <span class="comment">// ...</span></span><br><span class="line">            <span class="keyword">case</span> OBSERVING: <span class="comment">// ...</span></span><br><span class="line">            <span class="keyword">case</span> FOLLOWING: <span class="comment">// ...</span></span><br><span class="line">            <span class="keyword">case</span> LEADING: <span class="comment">// ...</span></span><br><span class="line">            <span class="keyword">default</span>: <span class="comment">// ...</span></span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Check if a pair (server id, zxid) succeeds our current vote.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id    Server identifier</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> zxid  Last zxid observed by the issuer of this vote</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">totalOrderPredicate</span><span class="params">(<span class="keyword">long</span> newId, <span class="keyword">long</span> newZxid, <span class="keyword">long</span> newEpoch, <span class="keyword">long</span> curId, <span class="keyword">long</span> curZxid, <span class="keyword">long</span> curEpoch)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (self.getQuorumVerifier().getWeight(newId) == <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * We return true if one of the following three cases hold:</span></span><br><span class="line"><span class="comment">     * 1- New epoch is higher</span></span><br><span class="line"><span class="comment">     * 2- New epoch is the same as current epoch, but new zxid is higher</span></span><br><span class="line"><span class="comment">     * 3- New epoch is the same as current epoch, new zxid is the same as current zxid, but server id is higher.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">return</span> ((newEpoch &gt; curEpoch) ||</span><br><span class="line">            ((newEpoch == curEpoch) &amp;&amp;</span><br><span class="line">            ((newZxid &gt; curZxid) || ((newZxid == curZxid) &amp;&amp; (newId &gt; curId)))));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<h4 id="ZAB-和-Paxos-的区别"><a href="#ZAB-和-Paxos-的区别" class="headerlink" title="ZAB 和 Paxos 的区别"></a>ZAB 和 Paxos 的区别</h4><p>　<strong>ZAB</strong>，Atomic Broadcast 协议，保证了发给各副本的消息顺序相同（因为 ZooKeeper 是一个树形结构，很多操作都要先检查才能确定能不能执行，如 <code>/a/b</code> 需要在 先创建好 <code>/a</code> 的前提下，才能创建 <code>/a/b</code>）<br>　<strong>Paxos</strong> 保证不了<code>全序顺序</code>，Paxos 算法的确是不关心请求之间的<code>逻辑顺序</code>，而只考虑<code>数据之间的全序</code></p>
<p>　ZAB 的核心思想，形象的说就是保证任意时刻只有一个节点是 <code>Leader</code>，所有更新事务由 <code>Leader</code>发起去更新所有副本（称为 <code>Follower</code>），更新时用的就是 <code>Two-phase</code> 两阶段提交协议，只要多数节点 prepare 成功，就通知他们 commit<br>　各 <code>Follower</code> 要按当初 <code>Leader</code> 让他们 prepare 的顺序来 apply 事务<br>　另外，因为 ZAB 处理的事务永远不会回滚，ZAB 对 2PC 阶段做了点优化，多个事务只要通知 ZXID 最大的那个 commit，之前的各 <code>Follower</code> 会统统 commit</p>
<p>　本质上，二者的设计目标是不一样的，<code>ZAB 协议</code>主要用于构建一个<strong>髙可用的分布式数据主备</strong>系统，而 <code>Paxos 算法</code>则是为了构建一个<strong>分布式的一致性状态机</strong>系统</p>
<h3 id="数据相关"><a href="#数据相关" class="headerlink" title="数据相关"></a>数据相关</h3><h4 id="ZooKeeper-内存结构"><a href="#ZooKeeper-内存结构" class="headerlink" title="ZooKeeper 内存结构"></a>ZooKeeper 内存结构</h4><p>　<code>ZKDatabase</code> 作为 ZooKeeper 内存数据库的主体，包含了 <strong>Session 会话</strong>、<strong>DataTree</strong>、<strong>Snapshot</strong>（记录 ZooKeeper 服务器上某一个时刻全量的内存数据内容）、<strong>事务日志</strong>（事务操作时间 、客户端会话 ID、 CXID [客户端的操作序列号]、ZXID、操作类型、会话超时时间、节点路径、节点数据内容、节点的 ACL 信息、 是否为临时节点 和 父节点的子节点版本号）等信息。<code>ZKDatabase</code> 会定时地向磁盘 dump 快照数据，并会在 ZooKeeper 服务端节点<code>启动/重启</code>的时候，read 磁盘上的<code>事务日志</code>和 <code>Snapshot 文件</code>，load 相关数据到内存中，重新恢复出整个 <code>ZKDatabase</code></p>
<p><img data-src="/picture/zk/zk_database_data_tree_data_node.png" alt></p>
<center>（利用 <a href="https://www.axure.com.cn/" target="_blank" rel="external nofollow noopener noreferrer">Axure</a>™ 绘制而成）</center>


<h4 id="ZooKeeperServer-初始化流程"><a href="#ZooKeeperServer-初始化流程" class="headerlink" title="ZooKeeperServer 初始化流程"></a>ZooKeeperServer 初始化流程</h4><p>　启动 ZooKeeper 服务器节点的流程，从 <code>ServerMain#main</code> 方法开始。主要的调用链如下：</p>
<figure class="highlight"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">org.apache.zookeeper.server.ZooKeeperServerMain#runFromConfig</span><br><span class="line">org.apache.zookeeper.server.ServerCnxnFactory#startup(org.apache.zookeeper.server.ZooKeeperServer)</span><br><span class="line">org.apache.zookeeper.server.NettyServerCnxnFactory#startup      // 这里暂时不考虑 NIO 的实现，只看 Netty 实现的 `ServerCnxnFactory`</span><br><span class="line">org.apache.zookeeper.server.ZooKeeperServer#startdata</span><br><span class="line">org.apache.zookeeper.server.ZooKeeperServer#loadData</span><br></pre></td></tr></tbody></table></figure>
<p>　最终 Session 和 数据的恢复，都将在 <code>loadData</code> 方法中完成。<code>ZKServer</code> 首先利用 <code>ZKDatabase#loadDataBase</code> 调用 <code>FileTxnSnapLog#restore</code> 方法，从磁盘中反序列化 <strong>100</strong>（硬编码了在 <code>findNValidSnapshots(100)</code> 代码里）个有效的 Snapshot 文件，恢复出 <code>DataTree</code> 和 <code>sessionsWithTimeouts</code> 两个数据结构，以便获取到最新有效的 <code>ZXID</code>，并使用 <code>FileTxnSnapLog#processTransaction</code> 方法增量地处理 <code>DataTree</code> 中的事务。随后根据 Session 超时时间，将超时的 Session 从 <code>DataTree#ephemerals</code> 变量（<code>Map&lt;Long: sessionId, HashSet&lt;String&gt;: pathList&gt;</code>）中移除。同时，利用 <code>ZooKeeperServer#takeSnapshot</code> 方法，将 <code>DataTree</code> 实例持久化到磁盘，创建一个全新的 <code>Snapshot</code> 文件</p>
<h4 id="Snapshot-策略"><a href="#Snapshot-策略" class="headerlink" title="Snapshot 策略"></a>Snapshot 策略</h4><p>　首先，我们可以看到 <code>SyncRequestProcessor</code> 类的 <code>run()</code> 方法中，<code>ZooKeeperServer#takeSnapshot</code> 方法的调用是在一个新起的线程中发起的，因此 Snapshot 流程是异步发起的</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.zookeeper.server.SyncRequestProcessor#run</span></span><br><span class="line">snapInProcess = <span class="keyword">new</span> ZooKeeperThread(<span class="string">"Snapshot Thread"</span>) {</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">      zks.takeSnapshot();</span><br><span class="line">    } <span class="keyword">catch</span>(Exception e) {</span><br><span class="line">      LOG.warn(<span class="string">"Unexpected exception"</span>, e);</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">};</span><br><span class="line">snapInProcess.start();</span><br></pre></td></tr></tbody></table></figure>
<p>　另外，在启动 <code>Snapshot</code> 线程之前，通过 $logCount \gt (snapCount / 2 + randRoll)$ 公式进行计算，是否应该发起 <code>Snapshot</code>（同时会保证前一个 Snapshot 已经结束才会开始）。由此可见 ZooKeeper 的设计巧妙之处，这里加入了 <code>randRoll</code> 随机数，可以降低所有 <code>Server</code> 节点同时发生 <code>Snapshot</code> 的概率，从而避免因 <code>Snapshot</code> 导致服务受影响。因为，<code>Snapshot</code> 的过程会消耗大量的 <code>磁盘 IO</code>、<code>CPU</code> 等资源，所以全部节点同时 <code>Snapshot</code> 会严重影响集群的对外服务能力</p>
<h3 id="请求流程"><a href="#请求流程" class="headerlink" title="请求流程"></a>请求流程</h3><p>　按照 <code>ZooKeeperServer</code> 的文档中所示，事务处理的大体流程链应该为 <code>PrepRequestProcessor</code> - <code>SyncRequestProcessor</code> - <code>FinalRequestProcessor</code>。因此，这也将是我们研究源码的阅读顺序</p>
<h4 id="ZooKeeper-乐观锁"><a href="#ZooKeeper-乐观锁" class="headerlink" title="ZooKeeper 乐观锁"></a>ZooKeeper 乐观锁</h4><p>　分布式中锁分类为，悲观锁（又称悲观并发控制 <strong>P</strong>essimistic <strong>C</strong>oncurrency <strong>C</strong>ontrol，PCC）和 乐观锁（又称乐观并发控制 <strong>O</strong>ptimistic <strong>C</strong>oncurrency <strong>C</strong>ontrol，OCC）。乐观锁事务控制流程，分为 <code>数据读取</code>、<code>写入校验</code>和<code>数据写入</code>三个阶段，常见实现为 JDK 中的 <a target="_blank" rel="external nofollow noopener noreferrer" href="http://ifeve.com/atomic-operation/">CAS</a>（synchronized / Atomic 类）。如果是<code>并发竞争少</code>或<code>事务冲突频率低</code>的场景，可使用<code>乐观锁</code>，<code>写入校验</code>成功就执行，不成功就失败回滚；如果<code>冲突频率高</code>或者<code>重试代价大</code>的场景，则建议使用<code>悲观锁</code></p>
<p>　而 ZooKeeper 中，是在执行 <code>OpCode.setData</code> 操作的时候，对 <code>version</code> 版本进行校验，从而实现了 <code>乐观锁</code>的 <code>写入校验</code>流程。如果，发现 <code>version</code> 和 <code>currentVersion</code> 是不一致的，则抛出 <code>BadVersionException</code> 异常进而回滚。不过，如果 <code>version</code> 的值为 <code>-1</code>，意味着 Client 的此次操作请求，不需要进行 <code>乐观锁</code>来控制并发，则无需校验。此处，只是对 <code>version</code> 进行了一次数据写入前的校验，如果并发导致失败了，将直接返回 <code>KeeperErrorCode = BadVersion</code> 错误信息</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.zookeeper.server.PrepRequestProcessor#pRequest2Txn</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">pRequest2Txn</span><span class="params">(<span class="keyword">int</span> type, <span class="keyword">long</span> zxid, Request request, Record record, <span class="keyword">boolean</span> deserialize)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> KeeperException, IOException, RequestProcessorException</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    request.hdr = <span class="keyword">new</span> TxnHeader(request.sessionId, request.cxid, zxid, zks.getTime(), type);</span><br><span class="line">    <span class="keyword">switch</span> (type) {</span><br><span class="line">        <span class="keyword">case</span> OpCode.create: <span class="comment">//...</span></span><br><span class="line">        <span class="keyword">case</span> OpCode.delete: <span class="comment">//...</span></span><br><span class="line">        <span class="keyword">case</span> OpCode.setData: <span class="comment">//...</span></span><br><span class="line">            zks.sessionTracker.checkSession(request.sessionId, request.getOwner());</span><br><span class="line">            SetDataRequest setDataRequest = (SetDataRequest)record;</span><br><span class="line">            <span class="keyword">if</span>(deserialize)</span><br><span class="line">                ByteBufferInputStream.byteBuffer2Record(request.request, setDataRequest);</span><br><span class="line">            path = setDataRequest.getPath();</span><br><span class="line">            validatePath(path, request.sessionId);</span><br><span class="line">            nodeRecord = getRecordForPath(path);</span><br><span class="line">            checkACL(zks, nodeRecord.acl, ZooDefs.Perms.WRITE,</span><br><span class="line">                    request.authInfo);</span><br><span class="line">            version = setDataRequest.getVersion();</span><br><span class="line">            <span class="keyword">int</span> currentVersion = nodeRecord.stat.getVersion();</span><br><span class="line">            <span class="keyword">if</span> (version != -<span class="number">1</span> &amp;&amp; version != currentVersion) {  <span class="comment">// CAS</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.BadVersionException(path);</span><br><span class="line">            }</span><br><span class="line">            version = currentVersion + <span class="number">1</span>;</span><br><span class="line">            request.txn = <span class="keyword">new</span> SetDataTxn(path, setDataRequest.getData(), version);</span><br><span class="line">            nodeRecord = nodeRecord.duplicate(request.hdr.getZxid());</span><br><span class="line">            nodeRecord.stat.setVersion(version);</span><br><span class="line">            addChangeRecord(nodeRecord);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> OpCode.setACL: <span class="comment">//...</span></span><br><span class="line">        <span class="keyword">case</span> OpCode.createSession: <span class="comment">//...</span></span><br><span class="line">        <span class="keyword">case</span> OpCode.closeSession: <span class="comment">//...</span></span><br><span class="line">        <span class="keyword">case</span> OpCode.check: <span class="comment">//...</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="ZooKeeper-连接地址列表的连接策略"><a href="#ZooKeeper-连接地址列表的连接策略" class="headerlink" title="ZooKeeper 连接地址列表的连接策略"></a>ZooKeeper 连接地址列表的连接策略</h4><p>　ZooKeeper 考虑到第一次连接的时候，使用 <code>StaticHostProvider#resolveAndShuffle</code> 方法进行一次 shuffle，避免第一台节点处于热点状态；而 ZooKeeper 的 Session 连接断开之后，会使用 <code>StaticHostProvider#next</code> 方法，从第一个连接地址开始逐个尝试；另外，在集群<code>扩容/缩容</code>的时候，使用 <code>StaticHostProvider#updateServerList</code> 方法，更新服务器列表，并计算集群扩容的概率，对连接做重新分配，使得集群的负载更加均衡</p>
<h4 id="Follower-和-Observer-请求转发"><a href="#Follower-和-Observer-请求转发" class="headerlink" title="Follower 和 Observer 请求转发"></a>Follower 和 Observer 请求转发</h4><p>　为了事务的一致性，所有 Follower、Observer 接收到的事务请求，都会通过 <code>Learner#request</code> 方法，将请求发送给 Leader 节点来处理</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.zookeeper.server.quorum.FollowerRequestProcessor | ObserverRequestProcessor</span></span><br><span class="line"><span class="keyword">switch</span> (request.type) {</span><br><span class="line">    <span class="keyword">case</span> OpCode.sync:</span><br><span class="line">        zks.pendingSyncs.add(request);</span><br><span class="line">        zks.getFollower().request(request);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> OpCode.create:</span><br><span class="line">    <span class="keyword">case</span> OpCode.create2:</span><br><span class="line">    <span class="keyword">case</span> OpCode.createTTL:</span><br><span class="line">    <span class="keyword">case</span> OpCode.createContainer:</span><br><span class="line">    <span class="keyword">case</span> OpCode.delete:</span><br><span class="line">    <span class="keyword">case</span> OpCode.deleteContainer:</span><br><span class="line">    <span class="keyword">case</span> OpCode.setData:</span><br><span class="line">    <span class="keyword">case</span> OpCode.reconfig:</span><br><span class="line">    <span class="keyword">case</span> OpCode.setACL:</span><br><span class="line">    <span class="keyword">case</span> OpCode.multi:</span><br><span class="line">    <span class="keyword">case</span> OpCode.check:</span><br><span class="line">        zks.getFollower().request(request);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> OpCode.createSession:</span><br><span class="line">    <span class="keyword">case</span> OpCode.closeSession:</span><br><span class="line">        <span class="comment">// Do not forward local sessions to the leader.</span></span><br><span class="line">        <span class="keyword">if</span> (!request.isLocalSession()) {</span><br><span class="line">            zks.getFollower().request(request);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Watch-事件触发流程"><a href="#Watch-事件触发流程" class="headerlink" title="Watch 事件触发流程"></a>Watch 事件触发流程</h4><p>　所有的 Watch 事件都通过 <code>WatchManager#triggerWatch</code> 进行触发。该方法会从 <code>HashMap&lt;String, HashSet&lt;Watcher&gt;&gt;</code> <code>watchTable</code> 中，通过 <code>ServerCnxn#process</code> 方法，将 <code>Watch</code> 对象取出（<code>HashMap#remove</code> 意味着 Watch 只会在 ZooKeeper 触发一次，不过 Curator 框架中已封装，只需注册一次，可多次触发 Watch 事件），并随后通过 <code>ServerCnxn#sendResponse</code> 封装并发送网络包</p>
<p>　由此可见，如果 Socket 通讯出现<strong>网络故障</strong>等问题，可能会丢失 Watch 事件。同时，因为注册一次之后，<code>Watcher</code> 就会从 <code>watchTable</code> 中被移除，<strong>再次注册完成之前</strong>，发生的 Watch 事件，将无法被监控到。并且，如果 Client 端和 Server 端断开连接之后，因为服务端并没有对 Watch 事件做任何留存，所以重连之后也是无法接受到任何 Watch 事件的（因此，程序中需要在接收到 disconnect 事件之后，进入某种<strong>安全模式</strong>，使得程序更为谨慎地处理 “依赖于 ZooKeeper Watch 的操作”）。另外，还要一个需要注意的地方是，同一个 ZNode 节点被 Watch 了多种事件，针对该 ZNode 节点 Client 端<strong>只会获取到一个 Watch 事件</strong>（例如，监控 ZNode A 的 <code>exists</code> / <code>getData</code> 事件，在删除了 A 之后，Client 端只会接受到一个 Delete 事件）</p>
<p>　总而言之，强依赖于 ZooKeeper Watch 事件的程序逻辑，都是不可靠的</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// [NIO 相关的流程]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.zookeeper.server.NIOServerCnxn#sendResponse</span></span><br><span class="line"><span class="comment">// org.apache.zookeeper.server.NIOServerCnxn#sendBuffer</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Queue&lt;ByteBuffer&gt; outgoingBuffers = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;();</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendBuffer</span><span class="params">(ByteBuffer bb)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (LOG.isTraceEnabled()) {</span><br><span class="line">        LOG.trace(<span class="string">"Add a buffer to outgoingBuffers, sk "</span> + sk + <span class="string">" is valid: "</span> + sk.isValid());</span><br><span class="line">    }</span><br><span class="line">    outgoingBuffers.add(bb);</span><br><span class="line">    requestInterestOpsUpdate();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// Queue&lt;ByteBuffer&gt; 队列被异步发送，整个调用流程如下：</span></span><br><span class="line"><span class="comment">// org.apache.zookeeper.server.quorum.QuorumPeerMain#main</span></span><br><span class="line"><span class="comment">// org.apache.zookeeper.server.quorum.QuorumPeerMain#initializeAndRun</span></span><br><span class="line"><span class="comment">// org.apache.zookeeper.server.quorum.QuorumPeerMain#runFromConfig</span></span><br><span class="line"><span class="comment">// org.apache.zookeeper.server.NIOServerCnxnFactory#configure</span></span><br><span class="line"><span class="comment">// org.apache.zookeeper.server.NIOServerCnxnFactory#ZOOKEEPER_NIO_NUM_SELECTOR_THREADS</span></span><br><span class="line">如果没有配置该选项，则默认使用 Math.max((<span class="keyword">int</span>) Math.sqrt((<span class="keyword">float</span>) numCores/<span class="number">2</span>), <span class="number">1</span>) 公式进行计算 SelectorThread 的线程数量</span><br><span class="line"><span class="comment">// org.apache.zookeeper.server.NIOServerCnxnFactory.SelectorThread#run</span></span><br><span class="line"><span class="comment">// org.apache.zookeeper.server.NIOServerCnxnFactory.SelectorThread#select</span></span><br><span class="line"><span class="comment">// org.apache.zookeeper.server.NIOServerCnxnFactory.SelectorThread#handleIO</span></span><br><span class="line"><span class="comment">// org.apache.zookeeper.server.WorkerService#schedule(org.apache.zookeeper.server.WorkerService.WorkRequest)</span></span><br><span class="line"><span class="comment">// org.apache.zookeeper.server.WorkerService#schedule(org.apache.zookeeper.server.WorkerService.WorkRequest, long)</span></span><br><span class="line">worker.execute(scheduledWorkRequest);  <span class="comment">// 启动 ExecutorService</span></span><br><span class="line"><span class="comment">// org.apache.zookeeper.server.WorkerService.ScheduledWorkRequest#run</span></span><br><span class="line"><span class="comment">// org.apache.zookeeper.server.NIOServerCnxnFactory.IOWorkRequest#doWork</span></span><br><span class="line"><span class="comment">// org.apache.zookeeper.server.NIOServerCnxn#doIO</span></span><br><span class="line"><span class="comment">// org.apache.zookeeper.server.NIOServerCnxn#handleWrite</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// [Netty 相关的流程]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.zookeeper.server.NettyServerCnxn#sendResponse</span></span><br><span class="line"><span class="comment">// org.apache.zookeeper.server.NettyServerCnxn#sendBuffer</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendBuffer</span><span class="params">(ByteBuffer sendBuffer)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (sendBuffer == ServerCnxnFactory.closeConn) {</span><br><span class="line">        close();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    channel.write(wrappedBuffer(sendBuffer));</span><br><span class="line">    packetSent();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="mntr-四字命令使用-JVMFLAGS-和-SERVER-JVMFLAGS-中配置的-JVM-参数"><a href="#mntr-四字命令使用-JVMFLAGS-和-SERVER-JVMFLAGS-中配置的-JVM-参数" class="headerlink" title="mntr 四字命令使用 JVMFLAGS 和 SERVER_JVMFLAGS 中配置的 JVM 参数"></a>mntr 四字命令使用 JVMFLAGS 和 SERVER_JVMFLAGS 中配置的 JVM 参数</h4><p>　通过增加 <code>START_SERVER_JVMFLAGS</code> 参数，来避免这个问题（已提交 PR<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/apache/zookeeper/pull/302">#302</a>）</p>
<h3 id="架构设计"><a href="#架构设计" class="headerlink" title="架构设计"></a>架构设计</h3><h4 id="ZooKeeper-的-Server-ID-如果重复会有什么风险？"><a href="#ZooKeeper-的-Server-ID-如果重复会有什么风险？" class="headerlink" title="ZooKeeper 的 Server ID 如果重复会有什么风险？"></a>ZooKeeper 的 Server ID 如果重复会有什么风险？</h4><p>　截止 v3.5.3 并没有对这个问题进行代码层级的限制，已提交 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://issues.apache.org/jira/browse/ZOOKEEPER-2784">ZOOKEEPER-2784</a> issues 和 对应的 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/apache/zookeeper/pull/257">#257</a> PR，进行反馈和修复</p>
<h4 id="ZooKeeper-的事务-ID-超过-32-位，ZooKeeper-的-Leader-节点抛出-XidRolloverException-强制进行-re-election"><a href="#ZooKeeper-的事务-ID-超过-32-位，ZooKeeper-的-Leader-节点抛出-XidRolloverException-强制进行-re-election" class="headerlink" title="ZooKeeper 的事务 ID 超过 32 位，ZooKeeper 的 Leader 节点抛出 XidRolloverException 强制进行 re-election"></a>ZooKeeper 的事务 ID 超过 32 位，ZooKeeper 的 Leader 节点抛出 XidRolloverException <a target="_blank" rel="external nofollow noopener noreferrer" href="https://issues.apache.org/jira/browse/ZOOKEEPER-1277">强制进行 re-election</a></h4><p>　<a target="_blank" rel="external nofollow noopener noreferrer" href="http://zookeeper.apache.org/doc/current/zookeeperInternals.html">ZXID</a> 的高 32 位用于 <code>epoch（LE 选举轮次）</code>、低 32 位是一个记录 <code>Leader</code> 节点每一次改动的 <code>counter</code><br>　如果是 1k/s ops，那么只要 $2^{32} / (86400 * 1000)$ $\approx 49.7$ days 就会将 ZXID 耗尽</p>
<h5 id="重度依赖-ZooKeeper-的应用，可能一周内发生-ZooKeeper-自重启一两次，每次需-30-秒，有无更好的解决方法"><a href="#重度依赖-ZooKeeper-的应用，可能一周内发生-ZooKeeper-自重启一两次，每次需-30-秒，有无更好的解决方法" class="headerlink" title="重度依赖 ZooKeeper 的应用，可能一周内发生 ZooKeeper 自重启一两次，每次需 30 秒，有无更好的解决方法"></a>重度依赖 ZooKeeper 的应用，可能一周内发生 ZooKeeper 自重启一两次，每次需 30 秒，有无更好的解决方法</h5><p>　在 <code>ZXID</code> 快要溢出的时候，一次性进行自重启的所有操作，必然会比较慢。可以考虑把非依赖的关键步骤拆开，提前做好自重启的准备，以减少延迟<br></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * create a proposal and send it out to all the members</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the proposal that is queued to send to all the members</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Proposal <span class="title">propose</span><span class="params">(Request request)</span> <span class="keyword">throws</span> XidRolloverException </span>{</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Address the rollover issue. All lower 32bits set indicate a new leader</span></span><br><span class="line"><span class="comment">     * election. Force a re-election instead. See ZOOKEEPER-1277</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> ((request.zxid &amp; <span class="number">0xffffffffL</span>) == <span class="number">0xffffffffL</span>) {</span><br><span class="line">        String msg = <span class="string">"zxid lower 32 bits have rolled over, forcing re-election, and therefore new epoch start"</span>;</span><br><span class="line">        shutdown(msg);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> XidRolloverException(msg);</span><br><span class="line">    } <span class="comment">// ...</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><br>　或者，重新设计 ZXID，高 24 位用于 epoch，低 40 位用于 counter，那么意味着 Math.min($2^{24}$ / 365 / 24, $2^{40}$ / 365 / 86400 / 1000) $\approx$ Math.min(1915.2, 34.9) = 34.9 years 之后才会进行一次强制选举。不过考虑到 <code>ZXID</code> 是 <code>long</code> 类型，32 bit 的 JVM 在对 <code>long</code> 读写时（和 <code>double</code> 类型一样），是分为高 32 位和 低 32 位两部分进行操作的，由于 <code>ZXID</code> 变量没有用 <code>volatile</code> 修饰，且也没有装箱为对应的引用类型（<code>Long</code> / <code>Double</code>），属于<a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.oracle.com/javase/specs/jls/se8/html/jls-17.html#jls-17.7">非原子操作</a>。因此，如果将高 32 位的低 8 位划分给整个 <code>long</code> 的低 32 位，就可能存在并发的问题了（已提交 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://issues.apache.org/jira/browse/ZOOKEEPER-2789">Jira</a> / <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/apache/zookeeper/pull/262">PR</a>，欢迎加入讨论）<p></p>
<h2 id="常见误区"><a href="#常见误区" class="headerlink" title="常见误区"></a>常见误区</h2><h3 id="Paxos-的强一致性"><a href="#Paxos-的强一致性" class="headerlink" title="Paxos 的强一致性"></a>Paxos 的强一致性</h3><p>　Paxos 本身只是用来选主的算法，用来在分布式节点之间达成<code>共识</code>（Consensus）。只有到了上层应用（ZooKeeper / <a href="https://yuzhouwan.com/posts/2129/">Redis</a>），出现 数据“副本”的概念，在维持其<code>一致性</code>（Consistency）的时候 才会有强弱之分（一致性模型 vs 一致性协议）<br>　而且，整个副本系统的一致性级别，并不只取决于<code>共识算法</code>，客户端的实现规范也会起到关键作用。如果，Client 客户端允许访问 <code>非 Leader 节点</code> 获取数据，而<code>过半写成功</code>导致有部分 <code>Follower 节点</code>数据副本并没有完成更新（也可以调用 <code>sync()</code> 方法完成强制同步），仍然会表现出弱一致性</p>
<div class="note info">因为 ZooKeeper 存在可能长时间选举而服务不可用的情况，所以它是 CP 型系统</div>


<h3 id="有了逻辑时钟后，物理时钟就不再需要了"><a href="#有了逻辑时钟后，物理时钟就不再需要了" class="headerlink" title="有了逻辑时钟后，物理时钟就不再需要了"></a>有了逻辑时钟后，物理时钟就不再需要了</h3><p><img data-src="/picture/zk/zk_lamport_logic_clock.png" alt></p>
<center>（图片来源：<a href="https://commons.wikimedia.org/wiki/File:Lamport-Clock-en.svg" target="_blank" rel="external nofollow noopener noreferrer">wikimedia.org</a>，已确认版权为 CC BY-SA 3.0 协议）</center>


<p>　上图就是一个经典的 <code>Lamport</code> 逻辑时钟图，大致的算法描述如下（详见该篇<a target="_blank" rel="external nofollow noopener noreferrer" href="http://amturing.acm.org/p558-lamport.pdf">论文</a>）：</p>
<ul>
<li>每个事件对应一个 <code>Lamport</code> 时间戳（初始值为 <code>0</code>）</li>
<li>如果，事件在自己本节点内发生，时间戳加 <code>1</code> 即可</li>
<li>如果，事件属于<strong>发送事件</strong>，时间戳加 <code>1</code> 并在消息中带上该时间戳</li>
<li>如果，事件属于<strong>接收事件</strong>，时间戳 = Max(本地时间戳，消息中的时间戳) + 1</li>
</ul>
<p>　并且规定，Lamport 逻辑时钟内做<code>全序</code>，是按事件的时间戳大小为时间排序的，任何两个事件不可能在同一时间发生（并发发生的 <code>B4</code> 和 <code>C3</code> 被认为是有先后顺序的，这里直接按照<code>进程 ID</code> 的大小认定事件发生顺序），并且任何消息收到的时间都应该比发送的时间晚</p>
<p>　同时，如果 <code>B4</code> 和 <code>C3</code> 两个事件之间，在逻辑时钟系统之外，有额外的操作，使其有了依赖关系 <code>B4 -&gt; C3</code>，如果 C 进程的 ID 又大于 B 进程的 ID，则无法完成<code>全序</code>操作。因此，需要通过 FTP 时钟同步 或者 Berkeley 算法去调整误差 的方式加入<strong>物理时钟</strong>。物理时钟的引入，是为了能够区分，系统是处于事件间隔中，还是出错中断了（有兴趣，还可深入研究下 Lamport Logic Lock 的演化版 Vector clock）</p>
<h2 id="依赖组件梳理"><a href="#依赖组件梳理" class="headerlink" title="依赖组件梳理"></a>依赖组件梳理</h2><h3 id="梳理点"><a href="#梳理点" class="headerlink" title="梳理点"></a>梳理点</h3><ul>
<li>依赖框架中哪部分组件在使用 ZooKeeper，以及使用方式</li>
<li>存储的数据（路径、大小、读写的频率 等）</li>
<li>对 ZooKeeper 可能产生的压力（并发度、Watcher 数 等）</li>
<li>是否对 ZooKeeper 强依赖</li>
</ul>
<h3 id="依赖-ZooKeeper-的框架"><a href="#依赖-ZooKeeper-的框架" class="headerlink" title="依赖 ZooKeeper 的框架"></a>依赖 ZooKeeper 的框架</h3><h4 id="Yarn"><a href="#Yarn" class="headerlink" title="Yarn"></a>Yarn</h4><h5 id="遇到的坑-1"><a href="#遇到的坑-1" class="headerlink" title="遇到的坑"></a>遇到的坑</h5><h6 id="滚动重启升级-ZooKeeper-之后，Yarn-一直重试"><a href="#滚动重启升级-ZooKeeper-之后，Yarn-一直重试" class="headerlink" title="滚动重启升级 ZooKeeper 之后，Yarn 一直重试"></a>滚动重启升级 ZooKeeper 之后，Yarn 一直重试</h6><ul>
<li><p>描述</p>
<p>一直重连的原因是，Yarn 发送的数据包超过了 1MB <code>（我们遇到的情况是 1.3MB）</code>，服务端默认会设置 1MB 的阀值，避免影响 ZooKeeper 自身的服务</p>
</li>
<li><p>解决</p>
<p>重启 ResourceManager 即可</p>
</li>
</ul>
<h4 id="HBase"><a href="#HBase" class="headerlink" title="HBase"></a><a href="https://yuzhouwan.com/posts/45888/">HBase</a></h4><h5 id="遇到的坑-2"><a href="#遇到的坑-2" class="headerlink" title="遇到的坑"></a>遇到的坑</h5><h6 id="KeeperErrorCode-Session-expired-for-hbase-meta-region-server"><a href="#KeeperErrorCode-Session-expired-for-hbase-meta-region-server" class="headerlink" title="KeeperErrorCode = Session expired for /hbase/meta-region-server"></a>KeeperErrorCode = Session expired for /hbase/meta-region-server</h6><ul>
<li><p>描述<br> 连接 HBase 的 Client 突然一段时间 间歇性地报错 <code>KeeperErrorCode = Session expired for /hbase/meta-region-server</code></p>
</li>
<li><p>解决</p>
<ul>
<li>查看 HBase、ZooKeeper 的日志和监控告警，并没有发现异常（也就是说，集群没有故障，也没有出现负载过大的情况）</li>
<li>发现 <code>/hbase/meta-region-server</code> ZNode 结点保存的信息（meta 表存在于哪一个 RegionServer），并没有和 HBase 集群真实的情况不一致。并且，meta 表的迁移，除非机房断电之类的异常情况，一般是很少发生的</li>
<li>尝试在 HBase Client 端的程序，加上 <code>-verbose:gc -XX:+PrintGCDetails -XX:+PrintGCDateStamps -Xloggc:gc.log</code> 的 JVM 参数，来观察是否是客户端程序发生 Long GC 导致的</li>
</ul>
</li>
</ul>
<h6 id="fsync-ing-the-write-ahead-log-in-SyncThread-1-took-5051ms-which-will-adversely-effect-operation-latency"><a href="#fsync-ing-the-write-ahead-log-in-SyncThread-1-took-5051ms-which-will-adversely-effect-operation-latency" class="headerlink" title="fsync-ing the write ahead log in SyncThread:1 took 5051ms which will adversely effect operation latency"></a>fsync-ing the write ahead log in SyncThread:1 took 5051ms which will adversely effect operation latency</h6><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">2017-06-28 15:28:01,149 [myid:1] - WARN  [QuorumPeer[myid=1]/0:0:0:0:0:0:0:0:2181:Follower@89] - Exception when following the leader</span><br><span class="line">java.io.EOFException</span><br><span class="line">        at java.io.DataInputStream.readInt(DataInputStream.java:392)</span><br><span class="line">        at org.apache.jute.BinaryInputArchive.readInt(BinaryInputArchive.java:63)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.QuorumPacket.deserialize(QuorumPacket.java:83)</span><br><span class="line">        at org.apache.jute.BinaryInputArchive.readRecord(BinaryInputArchive.java:103)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.Learner.readPacket(Learner.java:153)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.Follower.followLeader(Follower.java:85)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:786)</span><br><span class="line">2017-06-28 15:28:02,198 [myid:1] - INFO  [QuorumPeer[myid=1]/0:0:0:0:0:0:0:0:2181:Follower@166] - shutdown called</span><br><span class="line">java.lang.Exception: shutdown Follower</span><br><span class="line">        at org.apache.zookeeper.server.quorum.Follower.shutdown(Follower.java:166)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:790)</span><br><span class="line">2017-06-28 15:28:02,198 [myid:1] - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxnFactory@197] - Accepted socket connection from /0:0:0:0:0:0:0:1:39781</span><br><span class="line">2017-06-28 15:28:02,198 [myid:1] - ERROR [FollowerRequestProcessor:1:FollowerRequestProcessor@93] - Unexpected exception causing <span class="built_in">exit</span></span><br><span class="line">java.net.SocketException: Socket closed</span><br><span class="line">        at java.net.SocketOutputStream.socketWrite(SocketOutputStream.java:121)</span><br><span class="line">        at java.net.SocketOutputStream.write(SocketOutputStream.java:159)</span><br><span class="line">        at java.io.BufferedOutputStream.flushBuffer(BufferedOutputStream.java:82)</span><br><span class="line">        at java.io.BufferedOutputStream.flush(BufferedOutputStream.java:140)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.Learner.writePacket(Learner.java:139)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.Learner.request(Learner.java:188)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.FollowerRequestProcessor.run(FollowerRequestProcessor.java:88)</span><br><span class="line">2017-06-28 15:28:02,198 [myid:1] - WARN  [SyncThread:1:FileTxnLog@334] - fsync-ing the write ahead <span class="built_in">log</span> <span class="keyword">in</span> SyncThread:1 took 5051ms <span class="built_in">which</span> will adversely effect operation latency. See the ZooKeeper troubleshooting guide</span><br><span class="line">2017-06-28 15:28:02,198 [myid:1] - INFO  [QuorumPeer[myid=1]/0:0:0:0:0:0:0:0:2181:NIOServerCnxn@1007] - Closed socket connection <span class="keyword">for</span> client /10.37.2.145:47384 <span class="built_in">which</span> had sessionid 0x15cc330c7d99117</span><br><span class="line">2017-06-28 15:28:02,199 [myid:1] - WARN  [SyncThread:1:SendAckRequestProcessor@64] - Closing connection to leader, exception during packet send</span><br><span class="line">java.net.SocketException: Socket closed</span><br><span class="line">        at java.net.SocketOutputStream.socketWrite(SocketOutputStream.java:121)</span><br><span class="line">        at java.net.SocketOutputStream.write(SocketOutputStream.java:159)</span><br><span class="line">        at java.io.BufferedOutputStream.flushBuffer(BufferedOutputStream.java:82)</span><br><span class="line">        at java.io.BufferedOutputStream.flush(BufferedOutputStream.java:140)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.Learner.writePacket(Learner.java:139)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.SendAckRequestProcessor.flush(SendAckRequestProcessor.java:62)</span><br><span class="line">        at org.apache.zookeeper.server.SyncRequestProcessor.flush(SyncRequestProcessor.java:204)</span><br><span class="line">        at org.apache.zookeeper.server.SyncRequestProcessor.run(SyncRequestProcessor.java:131)</span><br><span class="line">2017-06-28 15:28:02,198 [myid:1] - INFO  [FollowerRequestProcessor:1:FollowerRequestProcessor@95] - FollowerRequestProcessor exited loop!</span><br></pre></td></tr></tbody></table></figure>
<p>　<code>FollowerRequestProcessor.java:88</code> 这行代码是 <code>OpCode.closeSession</code> 操作转发给 Leader，需要发送一个请求包，但是网络问题导致 Socket 连接断开了；另外，<code>fsync-ing the write ahead log in SyncThread:1 took 5051ms which will adversely effect operation latency</code> 告警，意味着 <code>FileTxnLog#commit</code> 进行写事务日志到磁盘的过程过慢</p>
<p>　这里可能会导致一个疑问，到底是因为需要写入的事务日志过大导致的告警，还是因为机器磁盘当前的 I/O 负载比较高，所以这里最好再打印出 <code>FileChannel#size()</code> 的信息（已提交 PR<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/apache/zookeeper/pull/296">#296</a>）</p>
<h4 id="Druid"><a href="#Druid" class="headerlink" title="Druid"></a><a href="https://yuzhouwan.com/posts/5845/">Druid</a></h4><h5 id="遇到的坑-3"><a href="#遇到的坑-3" class="headerlink" title="遇到的坑"></a>遇到的坑</h5><h6 id="DruidTaskResolver-Poll-failed-trying-again"><a href="#DruidTaskResolver-Poll-failed-trying-again" class="headerlink" title="DruidTaskResolver: Poll failed, trying again"></a>DruidTaskResolver: Poll failed, trying again</h6><ul>
<li><p>描述</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">28 Feb 2018 10:41:45,065 WARN  [DruidTaskResolver[com.metamx.tranquility.druid.IndexService@214fd977]] (?.?:?)  - Poll failed, trying again at[2018-02-28T10:42:03.867+08:00].</span><br><span class="line">java.lang.IllegalStateException: Service is closed</span><br><span class="line">	at com.metamx.tranquility.druid.IndexService.com<span class="variable">$metamx</span><span class="variable">$tranquility</span><span class="variable">$druid</span><span class="variable">$IndexService</span>$<span class="variable">$client</span>(IndexService.scala:57)</span><br><span class="line">	at com.metamx.tranquility.druid.IndexService$<span class="variable">$anonfun</span><span class="variable">$call</span><span class="variable">$1</span>.apply(IndexService.scala:131)</span><br><span class="line">	at com.metamx.tranquility.druid.IndexService$<span class="variable">$anonfun</span><span class="variable">$call</span><span class="variable">$1</span>.apply(IndexService.scala:131)</span><br><span class="line">	at com.metamx.tranquility.finagle.FutureRetry$.onErrors(FutureRetry.scala:47)</span><br><span class="line">	at com.metamx.tranquility.druid.IndexService.call(IndexService.scala:130)</span><br><span class="line">	at com.metamx.tranquility.druid.IndexService.runningTasks(IndexService.scala:101)</span><br><span class="line">	at com.metamx.tranquility.finagle.DruidTaskResolver$<span class="variable">$anon</span><span class="variable">$1</span>.run(DruidTaskResolver.scala:83)</span><br><span class="line">	at java.util.concurrent.Executors<span class="variable">$RunnableAdapter</span>.call(Executors.java:511)</span><br><span class="line">	at java.util.concurrent.FutureTask.run(FutureTask.java:266)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor<span class="variable">$Worker</span>.run(ThreadPoolExecutor.java:617)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:745)</span><br></pre></td></tr></tbody></table></figure></li>
<li><p>解决</p>
<p>定位原因是 Apache Curator 2.11.1 的 bug（详见 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://issues.apache.org/jira/browse/CURATOR-394">CURATOR-394</a> 和 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/apache/curator/pull/208">PR#208</a>），将 patch 代码合进 Curator 的 curator-x-discovery 模块后，重新打包 curator-x-discovery-2.11.1.jar，并替换原生的，即可</p>
</li>
</ul>
<h4 id="Storm"><a href="#Storm" class="headerlink" title="Storm"></a><a href="https://yuzhouwan.com/posts/13977/">Storm</a></h4><h5 id="遇到的坑-4"><a href="#遇到的坑-4" class="headerlink" title="遇到的坑"></a>遇到的坑</h5><h6 id="Unable-to-load-database-on-disk"><a href="#Unable-to-load-database-on-disk" class="headerlink" title="Unable to load database on disk"></a>Unable to load database on disk</h6><ul>
<li><p>描述</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">2017-12-08 22:01:01,943 [myid:4] - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxnFactory@197] - Accepted socket connection from /0:0:0:0:0:0:0:1:24756</span><br><span class="line">2017-12-08 22:01:01,943 [myid:4] - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@838] - Processing srst <span class="built_in">command</span> from /0:0:0:0:0:0:0:1:24756</span><br><span class="line">2017-12-08 22:01:01,944 [myid:4] - INFO  [Thread-342422:NIOServerCnxn@1018] - Closed socket connection <span class="keyword">for</span> client /0:0:0:0:0:0:0:1:24756 (no session established <span class="keyword">for</span> client)</span><br><span class="line">2017-12-08 22:02:01,111 [myid:4] - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxnFactory@197] - Accepted socket connection from /0:0:0:0:0:0:0:1:25076</span><br><span class="line">2017-12-08 22:02:01,111 [myid:4] - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@838] - Processing ruok <span class="built_in">command</span> from /0:0:0:0:0:0:0:1:25076</span><br><span class="line">2017-12-08 22:02:01,112 [myid:4] - INFO  [Thread-342423:NIOServerCnxn@1018] - Closed socket connection <span class="keyword">for</span> client /0:0:0:0:0:0:0:1:25076 (no session established <span class="keyword">for</span> client)</span><br><span class="line">22017-12-08 22:46:17,702 [myid:] - INFO  [main:QuorumPeerConfig@103] - Reading configuration from: /home/zookeeper/software/zookeeper/bin/../conf/zoo.cfg</span><br><span class="line">2017-12-08 22:46:17,730 [myid:] - INFO  [main:QuorumPeerConfig@340] - Defaulting to majority quorums</span><br><span class="line">2017-12-08 22:46:17,793 [myid:4] - INFO  [main:DatadirCleanupManager@78] - autopurge.snapRetainCount <span class="built_in">set</span> to 3</span><br><span class="line">2017-12-08 22:46:17,794 [myid:4] - INFO  [main:DatadirCleanupManager@79] - autopurge.purgeInterval <span class="built_in">set</span> to 1</span><br><span class="line">2017-12-08 22:46:17,796 [myid:4] - INFO  [PurgeTask:DatadirCleanupManager<span class="variable">$PurgeTask</span>@138] - Purge task started.</span><br><span class="line">2017-12-08 22:46:17,855 [myid:4] - INFO  [main:QuorumPeerMain@127] - Starting quorum peer</span><br><span class="line">2017-12-08 22:46:18,193 [myid:4] - INFO  [main:NIOServerCnxnFactory@94] - binding to port 0.0.0.0/0.0.0.0:2181</span><br><span class="line">2017-12-08 22:46:18,266 [myid:4] - INFO  [main:QuorumPeer@959] - tickTime <span class="built_in">set</span> to 2000</span><br><span class="line">2017-12-08 22:46:18,266 [myid:4] - INFO  [main:QuorumPeer@979] - minSessionTimeout <span class="built_in">set</span> to -1</span><br><span class="line">2017-12-08 22:46:18,266 [myid:4] - INFO  [main:QuorumPeer@990] - maxSessionTimeout <span class="built_in">set</span> to -1</span><br><span class="line">2017-12-08 22:46:18,266 [myid:4] - INFO  [main:QuorumPeer@1005] - initLimit <span class="built_in">set</span> to 10</span><br><span class="line">2017-12-08 22:46:18,650 [myid:4] - INFO  [main:FileSnap@83] - Reading snapshot /data/zookeeper/datadir/version-2/snapshot.e72200034</span><br><span class="line">2017-12-08 22:46:18,831 [myid:4] - INFO  [PurgeTask:DatadirCleanupManager<span class="variable">$PurgeTask</span>@144] - Purge task completed.</span><br><span class="line">2017-12-08 22:46:31,861 [myid:4] - ERROR [main:QuorumPeer@497] - Unable to load database on disk</span><br><span class="line">java.io.EOFException</span><br><span class="line">        at java.io.DataInputStream.readInt(DataInputStream.java:392)</span><br><span class="line">        at org.apache.jute.BinaryInputArchive.readInt(BinaryInputArchive.java:63)</span><br><span class="line">        at org.apache.zookeeper.server.persistence.FileHeader.deserialize(FileHeader.java:64)</span><br><span class="line">        at org.apache.zookeeper.server.persistence.FileTxnLog<span class="variable">$FileTxnIterator</span>.inStreamCreated(FileTxnLog.java:580)</span><br><span class="line">        at org.apache.zookeeper.server.persistence.FileTxnLog<span class="variable">$FileTxnIterator</span>.createInputArchive(FileTxnLog.java:599)</span><br><span class="line">        at org.apache.zookeeper.server.persistence.FileTxnLog<span class="variable">$FileTxnIterator</span>.goToNextLog(FileTxnLog.java:565)</span><br><span class="line">        at org.apache.zookeeper.server.persistence.FileTxnLog<span class="variable">$FileTxnIterator</span>.next(FileTxnLog.java:647)</span><br><span class="line">        at org.apache.zookeeper.server.persistence.FileTxnSnapLog.restore(FileTxnSnapLog.java:158)</span><br><span class="line">        at org.apache.zookeeper.server.ZKDatabase.loadDataBase(ZKDatabase.java:223)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.QuorumPeer.loadDataBase(QuorumPeer.java:450)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.QuorumPeer.start(QuorumPeer.java:440)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.QuorumPeerMain.runFromConfig(QuorumPeerMain.java:153)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.QuorumPeerMain.initializeAndRun(QuorumPeerMain.java:111)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.QuorumPeerMain.main(QuorumPeerMain.java:78)</span><br><span class="line">2017-12-08 22:46:31,868 [myid:4] - ERROR [main:QuorumPeerMain@89] - Unexpected exception, exiting abnormally</span><br><span class="line">java.lang.RuntimeException: Unable to run quorum server</span><br><span class="line">        at org.apache.zookeeper.server.quorum.QuorumPeer.loadDataBase(QuorumPeer.java:498)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.QuorumPeer.start(QuorumPeer.java:440)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.QuorumPeerMain.runFromConfig(QuorumPeerMain.java:153)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.QuorumPeerMain.initializeAndRun(QuorumPeerMain.java:111)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.QuorumPeerMain.main(QuorumPeerMain.java:78)</span><br><span class="line">Caused by: java.io.EOFException</span><br><span class="line">        at java.io.DataInputStream.readInt(DataInputStream.java:392)</span><br><span class="line">        at org.apache.jute.BinaryInputArchive.readInt(BinaryInputArchive.java:63)</span><br><span class="line">        at org.apache.zookeeper.server.persistence.FileHeader.deserialize(FileHeader.java:64)</span><br><span class="line">        at org.apache.zookeeper.server.persistence.FileTxnLog<span class="variable">$FileTxnIterator</span>.inStreamCreated(FileTxnLog.java:580)</span><br><span class="line">        at org.apache.zookeeper.server.persistence.FileTxnLog<span class="variable">$FileTxnIterator</span>.createInputArchive(FileTxnLog.java:599)</span><br><span class="line">        at org.apache.zookeeper.server.persistence.FileTxnLog<span class="variable">$FileTxnIterator</span>.goToNextLog(FileTxnLog.java:565)</span><br><span class="line">        at org.apache.zookeeper.server.persistence.FileTxnLog<span class="variable">$FileTxnIterator</span>.next(FileTxnLog.java:647)</span><br><span class="line">        at org.apache.zookeeper.server.persistence.FileTxnSnapLog.restore(FileTxnSnapLog.java:158)</span><br><span class="line">        at org.apache.zookeeper.server.ZKDatabase.loadDataBase(ZKDatabase.java:223)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.QuorumPeer.loadDataBase(QuorumPeer.java:450)</span><br><span class="line">        ... 4 more</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>分析</p>
<p>可以看到 <code>2017-12-08 22:02:01,112</code> 到 <code>22017-12-08 22:46:17,702</code> 日志有一个断层，可以看出之前的日志写入被中断了（后续在 <code>/var/log/message</code> 系统日志里面也验证了）。基本可以确定是，单独挂的盘发生了故障，导致了 Snapshot 文件损坏。而自启动脚本尝试重启 ZooKeeper 进程的时候，ZooKeeper 会依据事务日志里面的最新的 ZXID，一直去尝试读取最后一个已损坏的 Snapshot 文件，导致一直无法恢复</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ vim /var/<span class="built_in">log</span>/messages</span><br><span class="line">  kernel: EXT4-fs (vdb): warning: mounting fs with errors, running e2fsck is recommended</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<ul>
<li><p>解决</p>
<p>因为 <code>EOFException</code> 导致当前 ZooKeeper 进程退出后，集群已经选主出新的 Leader 节点，所以，可以直接删除事务日志和 Snapshot 文件，分别对应于 <code>dataDir</code> 和 <code>dataLogDir</code> 两个目录（理论上只需要保存 <code>myid</code> 文件，其他数据会从 Leader 节点重新拉取）。删除数据完成之后，直接启动 ZooKeeper 进程，当前节点即可重新加入 ZooKeeper 集群</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 读取配置</span></span><br><span class="line">2017-12-08 23:20:07,161 [myid:] - INFO  [main:QuorumPeerConfig@103] - Reading configuration from: /home/zookeeper/software/zookeeper/bin/../conf/zoo.cfg</span><br><span class="line">2017-12-08 23:20:07,165 [myid:] - INFO  [main:QuorumPeerConfig@340] - Defaulting to majority quorums</span><br><span class="line">2017-12-08 23:20:07,168 [myid:4] - INFO  [main:DatadirCleanupManager@78] - autopurge.snapRetainCount <span class="built_in">set</span> to 3</span><br><span class="line">2017-12-08 23:20:07,169 [myid:4] - INFO  [main:DatadirCleanupManager@79] - autopurge.purgeInterval <span class="built_in">set</span> to 1</span><br><span class="line">2017-12-08 23:20:07,170 [myid:4] - INFO  [PurgeTask:DatadirCleanupManager<span class="variable">$PurgeTask</span>@138] - Purge task started.</span><br><span class="line">2017-12-08 23:20:07,179 [myid:4] - INFO  [PurgeTask:DatadirCleanupManager<span class="variable">$PurgeTask</span>@144] - Purge task completed.</span><br><span class="line">2017-12-08 23:20:07,181 [myid:4] - INFO  [main:QuorumPeerMain@127] - Starting quorum peer</span><br><span class="line">2017-12-08 23:20:07,191 [myid:4] - INFO  [main:NIOServerCnxnFactory@94] - binding to port 0.0.0.0/0.0.0.0:2181</span><br><span class="line">2017-12-08 23:20:07,201 [myid:4] - INFO  [main:QuorumPeer@959] - tickTime <span class="built_in">set</span> to 2000</span><br><span class="line">2017-12-08 23:20:07,202 [myid:4] - INFO  [main:QuorumPeer@979] - minSessionTimeout <span class="built_in">set</span> to -1</span><br><span class="line">2017-12-08 23:20:07,202 [myid:4] - INFO  [main:QuorumPeer@990] - maxSessionTimeout <span class="built_in">set</span> to -1</span><br><span class="line">2017-12-08 23:20:07,202 [myid:4] - INFO  [main:QuorumPeer@1005] - initLimit <span class="built_in">set</span> to 10</span><br><span class="line"><span class="comment"># 开始进行选举</span></span><br><span class="line">2017-12-08 23:20:07,214 [myid:4] - INFO  [main:QuorumPeer@473] - currentEpoch not found! Creating with a reasonable default of 0. This should only happen when you are upgrading your installation</span><br><span class="line">2017-12-08 23:20:07,223 [myid:4] - INFO  [main:QuorumPeer@488] - acceptedEpoch not found! Creating with a reasonable default of 0. This should only happen when you are upgrading your installation</span><br><span class="line">2017-12-08 23:20:07,228 [myid:4] - INFO  [Thread-2:QuorumCnxManager<span class="variable">$Listener</span>@505] - My election <span class="built_in">bind</span> port: /192.168.1.104:3888</span><br><span class="line"><span class="comment"># 进入 LOOKING 状态，并创建自己的选票</span></span><br><span class="line">2017-12-08 23:20:07,238 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:QuorumPeer@714] - LOOKING</span><br><span class="line">2017-12-08 23:20:07,243 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:FastLeaderElection@815] - New election. My id =  4, proposed zxid=0x0</span><br><span class="line">2017-12-08 23:20:07,250 [myid:4] - INFO  [WorkerReceiver[myid=4]:FastLeaderElection@597] - Notification: 1 (message format version), 5 (n.leader), 0xe72217dad (n.zxid), 0x6 (n.round), LOOKING (n.state), 1 (n.sid), 0xe (n.peerEpoch) LOOKING (my state)</span><br><span class="line">2017-12-08 23:20:07,250 [myid:4] - INFO  [WorkerReceiver[myid=4]:FastLeaderElection@597] - Notification: 1 (message format version), 5 (n.leader), 0xe72217dad (n.zxid), 0x6 (n.round), FOLLOWING (n.state), 1 (n.sid), 0xf (n.peerEpoch) LOOKING (my state)</span><br><span class="line">2017-12-08 23:20:07,252 [myid:4] - INFO  [WorkerReceiver[myid=4]:FastLeaderElection@597] - Notification: 1 (message format version), 4 (n.leader), 0x0 (n.zxid), 0x1 (n.round), LOOKING (n.state), 4 (n.sid), 0x0 (n.peerEpoch) LOOKING (my state)</span><br><span class="line">2017-12-08 23:20:07,253 [myid:4] - INFO  [WorkerReceiver[myid=4]:FastLeaderElection@597] - Notification: 1 (message format version), 5 (n.leader), 0xe72217dad (n.zxid), 0x6 (n.round), LOOKING (n.state), 3 (n.sid), 0xe (n.peerEpoch) LOOKING (my state)</span><br><span class="line">2017-12-08 23:20:07,253 [myid:4] - INFO  [WorkerReceiver[myid=4]:FastLeaderElection@597] - Notification: 1 (message format version), 5 (n.leader), 0xe72217dad (n.zxid), 0x6 (n.round), FOLLOWING (n.state), 3 (n.sid), 0xf (n.peerEpoch) LOOKING (my state)</span><br><span class="line">2017-12-08 23:20:07,253 [myid:4] - INFO  [WorkerSender[myid=4]:QuorumCnxManager@195] - Have smaller server identifier, so dropping the connection: (5, 4)</span><br><span class="line">2017-12-08 23:20:07,254 [myid:4] - INFO  [WorkerReceiver[myid=4]:FastLeaderElection@597] - Notification: 1 (message format version), 5 (n.leader), 0xe72217dad (n.zxid), 0x6 (n.round), LOOKING (n.state), 4 (n.sid), 0xe (n.peerEpoch) LOOKING (my state)</span><br><span class="line">2017-12-08 23:20:07,254 [myid:4] - INFO  [WorkerReceiver[myid=4]:FastLeaderElection@597] - Notification: 1 (message format version), 5 (n.leader), 0xe72217dad (n.zxid), 0x6 (n.round), FOLLOWING (n.state), 3 (n.sid), 0xf (n.peerEpoch) LOOKING (my state)</span><br><span class="line">2017-12-08 23:20:07,254 [myid:4] - INFO  [WorkerSender[myid=4]:QuorumCnxManager@195] - Have smaller server identifier, so dropping the connection: (5, 4)</span><br><span class="line">2017-12-08 23:20:07,254 [myid:4] - INFO  [WorkerReceiver[myid=4]:FastLeaderElection@597] - Notification: 1 (message format version), 5 (n.leader), 0xe72217dad (n.zxid), 0x6 (n.round), FOLLOWING (n.state), 1 (n.sid), 0xf (n.peerEpoch) LOOKING (my state)</span><br><span class="line">2017-12-08 23:20:07,255 [myid:4] - INFO  [WorkerReceiver[myid=4]:FastLeaderElection@597] - Notification: 1 (message format version), 5 (n.leader), 0xe72217dad (n.zxid), 0x6 (n.round), LOOKING (n.state), 4 (n.sid), 0xe (n.peerEpoch) LOOKING (my state)</span><br><span class="line">2017-12-08 23:20:07,272 [myid:4] - INFO  [/192.168.1.104:3888:QuorumCnxManager<span class="variable">$Listener</span>@512] - Received connection request /192.168.1.105:18290</span><br><span class="line">2017-12-08 23:20:07,273 [myid:4] - INFO  [/192.168.1.104:3888:QuorumCnxManager<span class="variable">$Listener</span>@512] - Received connection request /192.168.1.105:18291</span><br><span class="line">2017-12-08 23:20:07,274 [myid:4] - WARN  [RecvWorker:5:QuorumCnxManager<span class="variable">$RecvWorker</span>@781] - Connection broken <span class="keyword">for</span> id 5, my id = 4, error =</span><br><span class="line">java.io.EOFException</span><br><span class="line">        at java.io.DataInputStream.readInt(DataInputStream.java:392)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.QuorumCnxManager<span class="variable">$RecvWorker</span>.run(QuorumCnxManager.java:766)</span><br><span class="line">2017-12-08 23:20:07,296 [myid:4] - WARN  [RecvWorker:5:QuorumCnxManager<span class="variable">$RecvWorker</span>@784] - Interrupting SendWorker</span><br><span class="line">2017-12-08 23:20:07,295 [myid:4] - WARN  [SendWorker:5:QuorumCnxManager<span class="variable">$SendWorker</span>@698] - Interrupted <span class="keyword">while</span> waiting <span class="keyword">for</span> message on queue</span><br><span class="line">java.lang.InterruptedException</span><br><span class="line">        at java.util.concurrent.locks.AbstractQueuedSynchronizer<span class="variable">$ConditionObject</span>.reportInterruptAfterWait(AbstractQueuedSynchronizer.java:2017)</span><br><span class="line">        at java.util.concurrent.locks.AbstractQueuedSynchronizer<span class="variable">$ConditionObject</span>.awaitNanos(AbstractQueuedSynchronizer.java:2095)</span><br><span class="line">        at java.util.concurrent.ArrayBlockingQueue.poll(ArrayBlockingQueue.java:389)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.QuorumCnxManager.pollSendQueue(QuorumCnxManager.java:850)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.QuorumCnxManager.access<span class="variable">$500</span>(QuorumCnxManager.java:61)</span><br><span class="line">        at org.apache.zookeeper.server.quorum.QuorumCnxManager<span class="variable">$SendWorker</span>.run(QuorumCnxManager.java:686)</span><br><span class="line">2017-12-08 23:20:07,280 [myid:4] - INFO  [WorkerReceiver[myid=4]:FastLeaderElection@597] - Notification: 1 (message format version), 5 (n.leader), 0xe72217dad (n.zxid), 0x6 (n.round), LOOKING (n.state), 2 (n.sid), 0xe (n.peerEpoch) LOOKING (my state)</span><br><span class="line">2017-12-08 23:20:07,297 [myid:4] - WARN  [SendWorker:5:QuorumCnxManager<span class="variable">$SendWorker</span>@707] - Send worker leaving thread</span><br><span class="line">2017-12-08 23:20:07,297 [myid:4] - INFO  [WorkerReceiver[myid=4]:FastLeaderElection@597] - Notification: 1 (message format version), 5 (n.leader), 0xe72217dad (n.zxid), 0x6 (n.round), FOLLOWING (n.state), 2 (n.sid), 0xf (n.peerEpoch) LOOKING (my state)</span><br><span class="line">2017-12-08 23:20:07,297 [myid:4] - INFO  [WorkerReceiver[myid=4]:FastLeaderElection@597] - Notification: 1 (message format version), 5 (n.leader), 0xe72217dad (n.zxid), 0x6 (n.round), LOOKING (n.state), 5 (n.sid), 0xe (n.peerEpoch) LOOKING (my state)</span><br><span class="line">2017-12-08 23:20:07,297 [myid:4] - INFO  [WorkerReceiver[myid=4]:FastLeaderElection@597] - Notification: 1 (message format version), 5 (n.leader), 0xe72217dad (n.zxid), 0x6 (n.round), LEADING (n.state), 5 (n.sid), 0xf (n.peerEpoch) LOOKING (my state)</span><br><span class="line"><span class="comment"># 经过 84ms，进入 FOLLOWING 状态，完成选举过程</span></span><br><span class="line">2017-12-08 23:20:07,298 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:QuorumPeer@784] - FOLLOWING</span><br><span class="line">2017-12-08 23:20:07,303 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:Learner@86] - TCP NoDelay <span class="built_in">set</span> to: <span class="literal">true</span></span><br><span class="line">2017-12-08 23:20:07,317 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:Environment@100] - Server environment:zookeeper.version=3.4.6--1, built on 08/30/2017 09:55 GMT</span><br><span class="line">2017-12-08 23:20:07,317 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:Environment@100] - Server environment:host.name=yuzhouwan-storm-4</span><br><span class="line">2017-12-08 23:20:07,317 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:Environment@100] - Server environment:java.version=1.7.0_60-ea</span><br><span class="line">2017-12-08 23:20:07,317 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:Environment@100] - Server environment:java.vendor=Oracle Corporation</span><br><span class="line">2017-12-08 23:20:07,317 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:Environment@100] - Server environment:java.home=/home/zookeeper/software/jdk1.7.0_60/jre</span><br><span class="line">2017-12-08 23:20:07,318 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:Environment@100] - Server environment:java.class.path=/home/zookeeper/software/zookeeper/bin/../build/classes:/home/zookeeper/software/zookeeper/bin/../build/lib/*.jar:/home/zookeeper/software/zookeeper/bin/../lib/slf4j-log4j12-1.6.1.jar:/home/zookeeper/software/zookeeper/bin/../lib/slf4j-api-1.6.1.jar:/home/zookeeper/software/zookeeper/bin/../lib/netty-3.7.0.Final.jar:/home/zookeeper/software/zookeeper/bin/../lib/log4j-1.2.16.jar:/home/zookeeper/software/zookeeper/bin/../lib/jline-0.9.94.jar:/home/zookeeper/software/zookeeper/bin/../zookeeper-3.4.6.4.jar:/home/zookeeper/software/zookeeper/bin/../src/java/lib/*.jar:/home/zookeeper/software/zookeeper/bin/../conf:/home/zookeeper/software/java/lib/dt.jar:/home/zookeeper/software/java/lib/tools.jar:.</span><br><span class="line">2017-12-08 23:20:07,318 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:Environment@100] - Server environment:java.library.path=/usr/java/packages/lib/amd64:/usr/lib64:/lib64:/lib:/usr/lib</span><br><span class="line">2017-12-08 23:20:07,318 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:Environment@100] - Server environment:java.io.tmpdir=/tmp</span><br><span class="line">2017-12-08 23:20:07,318 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:Environment@100] - Server environment:java.compiler=&lt;NA&gt;</span><br><span class="line">2017-12-08 23:20:07,318 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:Environment@100] - Server environment:os.name=Linux</span><br><span class="line">2017-12-08 23:20:07,318 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:Environment@100] - Server environment:os.arch=amd64</span><br><span class="line">2017-12-08 23:20:07,318 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:Environment@100] - Server environment:os.version=2.6.32-279.19.1.el6_sn.11.x86_64</span><br><span class="line">2017-12-08 23:20:07,318 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:Environment@100] - Server environment:user.name=zookeeper</span><br><span class="line">2017-12-08 23:20:07,318 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:Environment@100] - Server environment:user.home=/home/zookeeper</span><br><span class="line">2017-12-08 23:20:07,318 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:Environment@100] - Server environment:user.dir=/data/zookeeper</span><br><span class="line">2017-12-08 23:20:07,320 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:ZooKeeperServer@162] - Created server with tickTime 2000 minSessionTimeout 4000 maxSessionTimeout 40000 datadir /data/zookeeper/dataLogDir/version-2 snapdir /data/zookeeper/datadir/version-2</span><br><span class="line">2017-12-08 23:20:07,320 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:Follower@63] - FOLLOWING - LEADER ELECTION TOOK - 77</span><br><span class="line"><span class="comment"># 从 Leader 节点获取最新的 Snapshot 文件</span></span><br><span class="line">2017-12-08 23:20:07,335 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:Learner@326] - Getting a snapshot from leader</span><br><span class="line">2017-12-08 23:20:07,545 [myid:4] - WARN  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:Learner@374] - Got zxid 0xf001761dc expected 0x1</span><br><span class="line"><span class="comment"># 创建 Snapshot 文件（实际内容是 zxid - 1，而不是直接用最新的 zxid）</span></span><br><span class="line">2017-12-08 23:20:07,545 [myid:4] - INFO  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:FileTxnSnapLog@240] - Snapshotting: 0xf001761db to /data/zookeeper/datadir/version-2/snapshot.f001761db</span><br><span class="line"><span class="comment"># 创建事务日志文件</span></span><br><span class="line">2017-12-08 23:20:07,655 [myid:4] - INFO  [SyncThread:4:FileTxnLog@203] - Creating new <span class="built_in">log</span> file: log.f001761dc</span><br><span class="line">2017-12-08 23:20:07,657 [myid:4] - WARN  [QuorumPeer[myid=4]/0:0:0:0:0:0:0:0:2181:Follower@118] - Got zxid 0xf00176261 expected 0x1</span><br><span class="line"><span class="comment"># 至此，完成最终恢复，历时 496ms</span></span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<h4 id="Flink"><a href="#Flink" class="headerlink" title="Flink"></a><a href="https://yuzhouwan.com/posts/20644/">Flink</a></h4><h5 id="遇到的坑-5"><a href="#遇到的坑-5" class="headerlink" title="遇到的坑"></a>遇到的坑</h5><h6 id="Node-not-empty-flink-sportsa-StarterALLJSPlaying-jobgraphs-6f96a21ae1aaf087b7423f504e554694"><a href="#Node-not-empty-flink-sportsa-StarterALLJSPlaying-jobgraphs-6f96a21ae1aaf087b7423f504e554694" class="headerlink" title="Node not empty: /flink/sportsa/StarterALLJSPlaying/jobgraphs/6f96a21ae1aaf087b7423f504e554694"></a>Node not empty: /flink/sportsa/StarterALLJSPlaying/jobgraphs/6f96a21ae1aaf087b7423f504e554694</h6><ul>
<li><p>描述</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 没有子目录也无法删除</span></span><br><span class="line">[zk: localhost:2181(CONNECTED) 1] ls /flink/sportsa/StarterALLJSPlaying/jobgraphs/6f96a21ae1aaf087b7423f504e554694</span><br><span class="line">  []</span><br><span class="line">[zk: localhost:2181(CONNECTED) 2] delete /flink/sportsa/StarterALLJSPlaying/jobgraphs/6f96a21ae1aaf087b7423f504e554694</span><br><span class="line">  Node not empty: /flink/sportsa/StarterALLJSPlaying/jobgraphs/6f96a21ae1aaf087b7423f504e554694</span><br><span class="line">[zk: localhost:2181(CONNECTED) 3] rmr /flink/sportsa/StarterALLJSPlaying/jobgraphs/6f96a21ae1aaf087b7423f504e554694</span><br><span class="line">  Node not empty: /flink/sportsa/StarterALLJSPlaying/jobgraphs/6f96a21ae1aaf087b7423f504e554694</span><br></pre></td></tr></tbody></table></figure></li>
<li><p>解决</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过 get 命令发现，6f96a21ae1aaf087b7423f504e554694 本身就是有数据的</span></span><br><span class="line"><span class="comment"># 设置对应 version 为 '' 空字符串，再执行 delete 操作即可</span></span><br><span class="line">[zk: localhost:2181(CONNECTED) 12] <span class="built_in">set</span> /flink/sportsa/StarterALLJSPlaying/jobgraphs/6f96a21ae1aaf087b7423f504e554694 <span class="string">''</span> 1</span><br><span class="line">  cZxid = 0x1b01e697c7</span><br><span class="line">  ctime = Mon Jun 11 14:29:58 CST 2018</span><br><span class="line">  mZxid = 0x1b01ebc650</span><br><span class="line">  mtime = Mon Jun 11 17:04:50 CST 2018</span><br><span class="line">  pZxid = 0x1b01e6adb8</span><br><span class="line">  cversion = 2</span><br><span class="line">  dataVersion = 2</span><br><span class="line">  aclVersion = 0</span><br><span class="line">  ephemeralOwner = 0x0</span><br><span class="line">  dataLength = 0</span><br><span class="line">  numChildren = 0</span><br><span class="line">[zk: localhost:2181(CONNECTED) 13] delete /flink/sportsa/StarterALLJSPlaying/jobgraphs/6f96a21ae1aaf087b7423f504e554694</span><br><span class="line">[zk: localhost:2181(CONNECTED) 14] ls /flink/sportsa/StarterALLJSPlaying/jobgraphs/6f96a21ae1aaf087b7423f504e554694</span><br><span class="line">  Node does not exist: /flink/sportsa/StarterALLJSPlaying/jobgraphs/6f96a21ae1aaf087b7423f504e554694</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<h4 id="Hadoop"><a href="#Hadoop" class="headerlink" title="Hadoop"></a><a href="https://yuzhouwan.com/posts/60504/">Hadoop</a></h4><h4 id="Kafka"><a href="#Kafka" class="headerlink" title="Kafka"></a><a href="https://yuzhouwan.com/posts/26002/">Kafka</a></h4><h2 id="其他技术比对"><a href="#其他技术比对" class="headerlink" title="其他技术比对"></a>其他技术比对</h2><h3 id="思维导图"><a href="#思维导图" class="headerlink" title="思维导图"></a>思维导图</h3><p><img data-src="/picture/zk/zk_ecosystem.png" alt="ZooKeeper Ecosystem"></p>
<center>（利用 <a href="https://www.xmind.net/" target="_blank" rel="external nofollow noopener noreferrer">XMind</a>™ 绘制而成）</center>



<h3 id="分布式框架"><a href="#分布式框架" class="headerlink" title="分布式框架"></a>分布式框架</h3><h4 id="Chubby"><a href="#Chubby" class="headerlink" title="Chubby"></a>Chubby</h4><p>　Google Chubby 是一种分布式锁服务，解决了分布式协作、元数据存储和 Leader 选举等一系列与分布式锁服务相关的问题，有着以下的优势：</p>
<ul>
<li>提供了一个完整的、独立的分布式锁服务</li>
<li>提供粗粒度的锁服务</li>
<li>在提供锁服务的同时提供对小文件的读写功能</li>
<li>高可用</li>
<li>提供事件通知机制</li>
</ul>
<p>　和 ZooKeeper 的区别主要有三点：</p>
<ul>
<li><p>一致性算法不同</p>
<p>ZooKeeper 用的是 ZAB 原子广播协议；Chubby 是带租约的 Paxos</p>
</li>
<li><p>API 设计不同</p>
<p>ZooKeeper 用 <code>ZNode</code> 节点来实现锁；Chubby 提供了直接的加锁 API</p>
</li>
<li><p>集群设计不同</p>
<p>ZooKeeper 每个机器都可以读，提供 sync 方法同步刷新，保证了吞吐量；Chubby 读写都在 Master 单节点上</p>
</li>
</ul>
<h4 id="HyperTable"><a href="#HyperTable" class="headerlink" title="HyperTable"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/hypertable/hypertable">HyperTable</a></h4><p>　Hypertable 和 HBase 是最知名的两款基于 BigTable 为蓝本设计的数据库，他们的不同之处在于 Hypertable 基于 Boost C++ 实现，而 HBase 则基于 Java。虽然前者架构足够精细、代码足够高质，但是流行度远不及 HBase</p>
<h3 id="一致性算法"><a href="#一致性算法" class="headerlink" title="一致性算法"></a>一致性算法</h3><h4 id="Raft"><a href="#Raft" class="headerlink" title="Raft"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://raft.github.io/">Raft</a></h4><p>　相比 Paxos，<a target="_blank" rel="external nofollow noopener noreferrer" href="http://thesecretlivesofdata.com/raft/">Raft</a> 算法则更加易于理解和实现（目前 <a href="https://yuzhouwan.com/posts/2129/">Redis</a> 的集群设计用的是 Raft 算法）</p>
<p><img data-src="/picture/zk/zk_raft_1.png" alt><br><img data-src="/picture/zk/zk_raft_2.png" alt><br><img data-src="/picture/zk/zk_raft_3.png" alt><br><img data-src="/picture/zk/zk_raft_4.png" alt><br><img data-src="/picture/zk/zk_raft_5.png" alt><br><img data-src="/picture/zk/zk_raft_6.png" alt></p>
<center>（对 <a href="https://raft.github.io/" target="_blank" rel="external nofollow noopener noreferrer">Raft.io</a>™ 的截图，已确定版权为 CC BY 3.0 协议）</center>



<h3 id="分布式协同"><a href="#分布式协同" class="headerlink" title="分布式协同"></a>分布式协同</h3><h4 id="Fourinone"><a href="#Fourinone" class="headerlink" title="Fourinone"></a>Fourinone</h4><p>　<strong>Fourinone</strong> 是阿里自主研发的一个分布式并行计算框架，它集成了 Hadoop、ZooKeeper、MQ、分布式缓存 四大主要的分布式计算功能。同时，还提供完整的分布式缓存支持，包括中小型缓存以及大型集群缓存，不过已经很长时间没有维护了</p>
<h3 id="分布式服务注册与发现"><a href="#分布式服务注册与发现" class="headerlink" title="分布式服务注册与发现"></a>分布式服务注册与发现</h3><h4 id="Consul"><a href="#Consul" class="headerlink" title="Consul"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/hashicorp/consul">Consul</a></h4><p>　<strong>Consul</strong> 是强一致性的数据存储，使用 Gossip 形成动态集群。它提供分级<code>键/值</code>存储方式，不仅可以存储数据，而且可以用于注册各种事件，从发送数据改变通知到运行健康检查和自定义命令<br>　相比于 ZooKeeper 只能提供 KV 存储，Consul 内嵌了 服务发现系统，并且原生支持多数据中心部署。同时，还可以执行健康检查，并提供一个可视化的 Dashboard 用于管理</p>
<h4 id="Etcd"><a href="#Etcd" class="headerlink" title="Etcd"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/coreos/etcd">Etcd</a></h4><p>　<strong>Etcd</strong> 是一个采用 HTTP 协议的<code>键/值</code>对存储系统，它是一个分布式和功能层次配置系统，可用于构建服务发现系统。其很容易部署、安装和使用，提供了可靠的数据持久化特性</p>
<h4 id="Registrator"><a href="#Registrator" class="headerlink" title="Registrator"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/gliderlabs/registrator">Registrator</a></h4><p>　<strong>Registrator</strong> 通过检查容器在线或者停止运行状态<code>自动注册</code>和<code>卸载注册服务</code>，它目前支持 etcd、Consul 和 SkyDNS2<br>　Registrator 与 etcd 是一个简单但是功能强大的组合，可以运行很多先进的技术。每当打开一个容器，所有数据将被存储在 etcd 并同步复制到集群中的所有节点上</p>
<h4 id="Confd"><a href="#Confd" class="headerlink" title="Confd"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/kelseyhightower/confd">Confd</a></h4><p>　<strong>Confd</strong> 是一个轻量级的配置管理工具，常见的用法是通过使用存储在 etcd、consul 和 其他一些数据登记处的数据保持配置文件的最新状态，它也可以用来在配置文件改变时重新加载应用程序。换句话说，我们可以用存储在 etcd（或者其他注册中心）的信息来重新配置所有服务</p>
<h2 id="实用工具"><a href="#实用工具" class="headerlink" title="实用工具"></a>实用工具</h2><h3 id="日志可视化工具"><a href="#日志可视化工具" class="headerlink" title="日志可视化工具"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://issues.apache.org/jira/browse/ZOOKEEPER-773">日志可视化</a>工具</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/software/zookeeper</span><br><span class="line">$ java -cp zookeeper-3.4.6.jar:lib/log4j-1.2.16.jar:lib/slf4j-log4j12-1.6.1.jar:lib/slf4j-api-1.6.1.jar org.apache.zookeeper.server.LogFormatter ~/data/version-2/log.xxx</span><br><span class="line"></span><br><span class="line">  ZooKeeper Transactional Log File with dbid 0 txnlog format version 2</span><br><span class="line">  8/16/17 1:28:36 AM CST session 0x25d0d0e60d373ed cxid 0xcdd3 zxid 0xf0345fbfb setData <span class="string">'/hbase/replication/rs/slave08-yuzhouwan%2C60020%2C1502718266335/1/slave08-yuzhouwan%252C60020%252C1502718266335.1502817956398,#ffffffff0001a726567696f6e7365727665723a36303032306cffffffe8ffffffa1ffffffd0ffffff9824ffffffb616504255468ffffff8effffff92fffffff61d,34</span></span><br><span class="line"><span class="string">  8/16/17 1:28:36 AM CST session 0x35d0d0e72d4c5af cxid 0x0 zxid 0xf0345fbfd createSession 40000</span></span><br><span class="line"><span class="string">  8/16/17 1:28:37 AM CST session 0x15d0d0e5fc25bb2 cxid 0x0 zxid 0xf0345fc08 createSession 40000</span></span><br><span class="line"><span class="string">  8/16/17 1:28:37 AM CST session 0x35d0d0e72d4c5b2 cxid 0x4 zxid 0xf0345fc09 closeSession null</span></span><br><span class="line"><span class="string">  8/16/17 1:28:37 AM CST session 0x15d0d0e5fc25bb2 cxid 0x3 zxid 0xf0345fc0a closeSession null</span></span><br><span class="line"><span class="string">  8/16/17 1:28:37 AM CST session 0x25d0d0e60a7e937 cxid 0x26eeeb zxid 0xf0345fc0b setData '</span>/hbase/replication/rs/slave06-yuzhouwan%2C60020%2C1499390463838/1/slave06-yuzhouwan%252C60020%252C1499390463838.1502817657055,<span class="comment">#ffffffff0001a726567696f6e7365727665723a3630303230ffffff882fffffff8f7ffffff8b6ffffff89ffffffa7504255468ffffffeaffffff8effffffc52e,183</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="Snapshot-可视化工具"><a href="#Snapshot-可视化工具" class="headerlink" title="Snapshot 可视化工具"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://issues.apache.org/jira/browse/ZOOKEEPER-1377">Snapshot 可视化</a>工具</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/software/zookeeper</span><br><span class="line">$ java -cp zookeeper-3.4.6.jar:lib/log4j-1.2.16.jar:lib/slf4j-log4j12-1.6.1.jar:lib/slf4j-api-1.6.1.jar org.apache.zookeeper.server.SnapshotFormatter ~/data/version-2/snapshot.xxx</span><br><span class="line"></span><br><span class="line">  ZNode Details (count=4):</span><br><span class="line">  ----</span><br><span class="line">  /</span><br><span class="line">    cZxid = 0x00000000000000</span><br><span class="line">    ctime = Thu Jan 01 08:00:00 CST 1970</span><br><span class="line">    mZxid = 0x00000000000000</span><br><span class="line">    mtime = Thu Jan 01 08:00:00 CST 1970</span><br><span class="line">    pZxid = 0x00000000000000</span><br><span class="line">    cversion = 0</span><br><span class="line">    dataVersion = 0</span><br><span class="line">    aclVersion = 0</span><br><span class="line">    ephemeralOwner = 0x00000000000000</span><br><span class="line">    dataLength = 0</span><br><span class="line">  ----</span><br><span class="line">  /zookeeper</span><br><span class="line">    cZxid = 0x00000000000000</span><br><span class="line">    ctime = Thu Jan 01 08:00:00 CST 1970</span><br><span class="line">    mZxid = 0x00000000000000</span><br><span class="line">    mtime = Thu Jan 01 08:00:00 CST 1970</span><br><span class="line">    pZxid = 0x00000000000000</span><br><span class="line">    cversion = 0</span><br><span class="line">    dataVersion = 0</span><br><span class="line">    aclVersion = 0</span><br><span class="line">    ephemeralOwner = 0x00000000000000</span><br><span class="line">    dataLength = 0</span><br><span class="line">  ----</span><br><span class="line">  /zookeeper/quota</span><br><span class="line">    cZxid = 0x00000000000000</span><br><span class="line">    ctime = Thu Jan 01 08:00:00 CST 1970</span><br><span class="line">    mZxid = 0x00000000000000</span><br><span class="line">    mtime = Thu Jan 01 08:00:00 CST 1970</span><br><span class="line">    pZxid = 0x00000000000000</span><br><span class="line">    cversion = 0</span><br><span class="line">    dataVersion = 0</span><br><span class="line">    aclVersion = 0</span><br><span class="line">    ephemeralOwner = 0x00000000000000</span><br><span class="line">    dataLength = 0</span><br><span class="line">  ----</span><br><span class="line">  Session Details (sid, timeout, ephemeralCount):</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Hue-Browser-集群页面监控工具"><a href="#Hue-Browser-集群页面监控工具" class="headerlink" title="Hue Browser 集群页面监控工具"></a>Hue Browser 集群页面<a target="_blank" rel="external nofollow noopener noreferrer" href="https://issues.apache.org/jira/browse/ZOOKEEPER-808">监控</a>工具</h3><h4 id="Rest-服务"><a href="#Rest-服务" class="headerlink" title="Rest 服务"></a>Rest 服务</h4><h5 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ tar zxvf zookeeper-3.4.10.tar.gz -C ~/software/</span><br><span class="line">$ <span class="built_in">cd</span> ~/software/zookeeper-3.4.10/</span><br><span class="line">$ ant clean</span><br><span class="line">$ ant</span><br></pre></td></tr></tbody></table></figure>
<h5 id="拷贝-Jar-包"><a href="#拷贝-Jar-包" class="headerlink" title="拷贝 Jar 包"></a>拷贝 Jar 包</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ cp build/contrib/rest/zookeeper-dev-rest.jar src/contrib/rest/lib/</span><br><span class="line">$ cp build/contrib/rest/lib/*.jar src/contrib/rest/lib/</span><br><span class="line">$ wget https://repository.cloudera.com/content/repositories/releases/org/apache/zookeeper/zookeeper/3.4.5-cdh5.11.1/zookeeper-3.4.5-cdh5.11.1.jar</span><br><span class="line">$ cp zookeeper-3.4.5-cdh5.2.0.jar src/contrib/rest/lib/</span><br><span class="line">$ cp src/java/lib/*.jar src/contrib/rest/lib/</span><br></pre></td></tr></tbody></table></figure>
<h5 id="启动-Rest-Service"><a href="#启动-Rest-Service" class="headerlink" title="启动 Rest Service"></a>启动 Rest Service</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/zookeeper/software/zookeeper1/src/contrib/rest</span><br><span class="line">$ ./rest.sh start</span><br><span class="line">  Starting ZooKeeper REST Gateway ... </span><br><span class="line">  STARTED</span><br><span class="line"><span class="comment"># 关闭</span></span><br><span class="line">$ ./rest.sh stop</span><br><span class="line"><span class="comment"># 查看日志</span></span><br><span class="line">$ tail -f zkrest.log</span><br></pre></td></tr></tbody></table></figure>
<h4 id="安装-Hue"><a href="#安装-Hue" class="headerlink" title="安装 Hue"></a>安装 Hue</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 增加 ZooKeeper 用户</span></span><br><span class="line"><span class="comment"># 安装 jdk7 / python2.7.12 / virtualenv</span></span><br><span class="line">$ su - zookeeper</span><br><span class="line">$ mkdir software &amp;&amp; <span class="built_in">cd</span> software</span><br><span class="line">$ virtualenv -p /usr/<span class="built_in">local</span>/bin/python --system-site-packages hue</span><br><span class="line">$ <span class="built_in">cd</span> hue &amp;&amp; <span class="built_in">source</span> bin/activate</span><br><span class="line"><span class="comment"># 检查 virtualEnv 里的 python 版本和路径，是否正确</span></span><br><span class="line">(hue) [zookeeper@zoo hue]$ python -V</span><br><span class="line">  Python 2.7.12</span><br><span class="line">(hue) [zookeeper@edeppreapp01 software]$ <span class="built_in">which</span> python</span><br><span class="line">~/software/hue/bin/python</span><br><span class="line">$ <span class="built_in">cd</span> /home/zookeeper/install</span><br><span class="line">$ wget https://codeload.github.com/cloudera/hue/tar.gz/cdh5.8.5-release</span><br><span class="line">$ wget https://issues.apache.org/jira/secure/attachment/12452258/huebrowser.tar.gz</span><br><span class="line">$ ll</span><br><span class="line">  -rw-r--r-- 1 root root 50421006 Jun 22 16:57 hue-1.0.tgz</span><br><span class="line">  -rw-r--r-- 1 root root    23412 Jun 22 16:57 huebrowser.tar.gz</span><br><span class="line">$ mv cdh5.8.5-release cdh5.8.5-release.tar.gz</span><br><span class="line">$ tar zxvf cdh5.8.5-release.tar.gz -C ~/software/</span><br><span class="line">$ tar zxvf hue-1.0.tgz -C ~/software/ &amp;&amp; tar zxvf huebrowser.tar.gz -C ~/software/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 hue</span></span><br><span class="line">$ <span class="built_in">cd</span> ~/software/hue-1.0</span><br><span class="line">$ make apps</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可能需要安装一些第三方包，无需则跳过</span></span><br><span class="line">$ pip install simplejson</span><br><span class="line"></span><br><span class="line">$ mkdir apps/zkui</span><br><span class="line">$ python tools/app_reg/app_reg.py --install apps/zkui</span><br><span class="line">$ python tools/app_reg/app_reg.py --list 2&gt;&amp;1 | grep zkui</span><br><span class="line">  zkui           0.1     /Users/philip/src/hue/apps/zkui</span><br></pre></td></tr></tbody></table></figure>
<div class="note warning">Hue Browser 因为常年未维护更新（只兼容到 ZooKeeper v3.4.5 版本），导致安装时容易出现很多问题。另外，Rest Service 必须所有的节点都开启才行，一旦某一台故障，则整个 Hue 不可用。所以，最好还是自己实现一套监控系统</div>




<h3 id="移除-Watch-工具"><a href="#移除-Watch-工具" class="headerlink" title="移除 Watch 工具"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/phunt/zookeeper-removewatch-ex">移除 Watch</a> 工具</h3><h3 id="Docker-开发环境部署工具"><a href="#Docker-开发环境部署工具" class="headerlink" title="Docker 开发环境部署工具"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/phunt/zk-docker-devenv">Docker 开发环境部署</a>工具</h3><h3 id="生成配置工具"><a href="#生成配置工具" class="headerlink" title="生成配置工具"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/phunt/zkconf">生成配置</a>工具</h3><h3 id="冒烟测试工具"><a href="#冒烟测试工具" class="headerlink" title="冒烟测试工具"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/phunt/zk-smoketest">冒烟测试</a>工具</h3><h3 id="Curator-框架"><a href="#Curator-框架" class="headerlink" title="Curator 框架"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/apache/curator">Curator</a> 框架</h3><h2 id="社区跟进"><a href="#社区跟进" class="headerlink" title="社区跟进"></a>社区跟进</h2><h3 id="PR-amp-Issues"><a href="#PR-amp-Issues" class="headerlink" title="PR &amp; Issues"></a>PR &amp; Issues</h3><ul>
<li><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/apache/zookeeper/pulls?utf8=%E2%9C%93&amp;q=is%3Apr%20author%3Aasdf2014%20">Pull Request</a></p>
</li>
<li><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://issues.apache.org/jira/browse/ZOOKEEPER-2784?jql=project%20%3D%20ZOOKEEPER%20AND%20reporter%20in%20(%22benedict%20jin%22)">Issues</a></p>
</li>
</ul>
<p>　详见，《<a href="https://yuzhouwan.com/posts/19631/">如何成为 Apache 的 PMC</a>》</p>
<h3 id="ZooKeeper-社区的一些“规则”"><a href="#ZooKeeper-社区的一些“规则”" class="headerlink" title="ZooKeeper 社区的一些“规则”"></a>ZooKeeper 社区的一些<a target="_blank" rel="external nofollow noopener noreferrer" href="https://cwiki.apache.org/confluence/display/ZOOKEEPER/HowToContribute">“规则”</a></h3><p>　同时也是共享其他开源项目时，需要注意和养成的好习惯，只是 ZooKeeper 中控制更加严格</p>
<h4 id="保持-Diff-信息最简"><a href="#保持-Diff-信息最简" class="headerlink" title="保持 Diff 信息最简"></a>保持 Diff 信息最简</h4><p>　PR 中不应该做无关的 Code Format（import / 代码缩进 等）</p>
<h4 id="保持-PR-的相关性"><a href="#保持-PR-的相关性" class="headerlink" title="保持 PR 的相关性"></a>保持 PR 的相关性</h4><p>　不做无关的 代码优化，尤其是对其他不相关的类（可以另起 PR 进行优化）</p>
<h4 id="保持-代码风格一致"><a href="#保持-代码风格一致" class="headerlink" title="保持 代码风格一致"></a>保持 代码风格一致</h4><p>　关闭 IDE 自动优化 import 合并为通配符 <code>*</code> 的功能（如，<code>import java.io.*</code> 等）</p>
<p>　类似的，还有 Apache <a href="https://yuzhouwan.com/posts/5845/">Druid</a> 里的参数列表，需要分行写；Apache <a href="https://yuzhouwan.com/posts/743/">Superset</a> 之类的 Python 项目，需要注意 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.python.org/dev/peps/pep-0537/">PEP</a> 规范；Apache <a href="https://yuzhouwan.com/posts/39683/">Eagle</a> 需要 squash PR 中的 commits 等等。更多相关内容，参见我的另一篇文章：《<a href="https://yuzhouwan.com/posts/19631/#代码提交的几个注意点">如何成为 Apache 的 PMC</a>》</p>
<h3 id="规避已知-issues"><a href="#规避已知-issues" class="headerlink" title="规避已知 issues"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://issues.apache.org/jira/browse/ZOOKEEPER-2186?jql=project%20%3D%20ZOOKEEPER%20AND%20issuetype%20%3D%20Bug%20AND%20resolution%20%3D%20Fixed%20AND%20affectedVersion%20%3D%203.4.6%20AND%20priority%20%3D%20Major%20AND%20component%20%3D%20server%20ORDER%20BY%20priority%20DESC%2C%20updated%20DESC">规避已知 issues</a></h3><p>　在 jira 中，根据自己的版本（affectedVersion），找到 Major 级别的 Bug，按照各个组件，对组件（component）进行筛选，并合并 patch 到自己的本地代码库里，从而规避一些已知的 issues，提高集群稳定性</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">project = ZOOKEEPER AND issuetype = Bug AND resolution = Fixed AND affectedVersion = 3.4.6 AND priority = Major AND component = server ORDER BY priority DESC, updated DESC</span><br></pre></td></tr></tbody></table></figure>
<h4 id="以-v3-4-6-为例"><a href="#以-v3-4-6-为例" class="headerlink" title="以 v3.4.6 为例"></a>以 v3.4.6 为例</h4><h5 id="server"><a href="#server" class="headerlink" title="server"></a>server</h5><ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://issues.apache.org/jira/browse/ZOOKEEPER-2026">ZOOKEEPER-2026</a>: Startup order in ServerCnxnFactory-ies is wrong</li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://issues.apache.org/jira/browse/ZOOKEEPER-2044">ZOOKEEPER-2044</a>: CancelledKeyException in zookeeper branch-3.4</li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://issues.apache.org/jira/browse/ZOOKEEPER-2052">ZOOKEEPER-2052</a>: Unable to delete a node when the node has no children</li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://issues.apache.org/jira/browse/ZOOKEEPER-2060">ZOOKEEPER-2060</a>: Trace bug in NettyServerCnxnFactory</li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://issues.apache.org/jira/browse/ZOOKEEPER-2186">ZOOKEEPER-2186</a>: QuorumCnxManager#receiveConnection may crash with random input</li>
</ul>
<h5 id="quorum"><a href="#quorum" class="headerlink" title="quorum"></a>quorum</h5><ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://issues.apache.org/jira/browse/ZOOKEEPER-1774">ZOOKEEPER-1774</a>: QuorumPeerMainTest fails consistently with “complains about host” assertion failure</li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://issues.apache.org/jira/browse/ZOOKEEPER-2029">ZOOKEEPER-2029</a>: Leader.LearnerCnxAcceptor should handle exceptions in run()</li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://issues.apache.org/jira/browse/ZOOKEEPER-2033">ZOOKEEPER-2033</a>: zookeeper follower fails to start after a restart immediately following a new epoch</li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://issues.apache.org/jira/browse/ZOOKEEPER-2195">ZOOKEEPER-2195</a>: fsync.warningthresholdms in zoo.cfg not working</li>
</ul>
<h5 id="java-client"><a href="#java-client" class="headerlink" title="java client"></a>java client</h5><ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://issues.apache.org/jira/browse/ZOOKEEPER-1853">ZOOKEEPER-1853</a>: zkCli.sh cannot issue a CREATE command containing spaces in the data</li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://issues.apache.org/jira/browse/ZOOKEEPER-1897">ZOOKEEPER-1897</a>: ZK Shell/Cli not processing commands</li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://issues.apache.org/jira/browse/ZOOKEEPER-2375">ZOOKEEPER-2375</a>: Prevent multiple initialization of login object in each ZooKeeperSaslClient instance</li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/apache/zookeeper/pull/430">ZOOKEEPER-2893</a>: very poor choice of logging if client fails to connect to server</li>
</ul>
<h5 id="other"><a href="#other" class="headerlink" title="other"></a>other</h5><ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://issues.apache.org/jira/browse/ZOOKEEPER-1913">ZOOKEEPER-1913</a>: Invalid manifest files due to bogus revision property value</li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://issues.apache.org/jira/browse/ZOOKEEPER-1991">ZOOKEEPER-1991</a>: zkServer.sh returns with a zero exit status when a ZooKeeper process is already running</li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://issues.apache.org/jira/browse/ZOOKEEPER-2039">ZOOKEEPER-2039</a>: Jute compareBytes incorrect comparison index</li>
</ul>
<h5 id="improvement"><a href="#improvement" class="headerlink" title="improvement"></a>improvement</h5><ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://issues.apache.org/jira/browse/ZOOKEEPER-1506">ZOOKEEPER-1506</a>: Re-try DNS hostname -&gt; IP resolution if node connection fails</li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://issues.apache.org/jira/browse/ZOOKEEPER-2270">ZOOKEEPER-2270</a>: Allow MBeanRegistry to be overridden for better unit tests</li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://issues.apache.org/jira/browse/ZOOKEEPER-1948">ZOOKEEPER-1948</a>: Enable JMX remote monitoring</li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://issues.apache.org/jira/browse/ZOOKEEPER-2205">ZOOKEEPER-2205</a>: Log type of unexpected quorum packet in learner handler loop</li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://issues.apache.org/jira/browse/ZOOKEEPER-2194">ZOOKEEPER-2194</a>: Let DataNode.getChildren() return an unmodifiable view of its children set</li>
</ul>
<h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><h3 id="Book"><a href="#Book" class="headerlink" title="Book"></a>Book</h3><ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://book.douban.com/subject/25765743/">ZooKeeper</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://book.douban.com/subject/26292004/">Paxos 到 ZooKeeper：分布式一致性原理与实践</a></li>
</ul>
<h3 id="Paper"><a href="#Paper" class="headerlink" title="Paper"></a>Paper</h3><ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.microsoft.com/en-us/research/publication/paxos-made-simple/">Paxos Made Simple</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://numenta.com/assets/pdf/whitepapers/hierarchical-temporal-memory-cortical-learning-algorithm-0.2.1-en.pdf">HIERARCHICAL TEMPORAL MEMORY including HTM Cortical Learning Algorithms</a></li>
</ul>
<h3 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h3><ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://software.intel.com/sites/default/files/managed/39/c5/325462-sdm-vol-1-2abcd-3abcd.pdf">Intel® 64 and IA-32 architectures software developer’s manual combined volumes: 1, 2A, 2B, 2C, 2D, 3A, 3B, 3C, 3D, and 4</a></li>
</ul>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt></a></td>
</tr>
</tbody>
</table>
</div>

    </div>

    
    
    
      
  <div class="popular-posts-header">相关文章</div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/39683/" rel="bookmark">Apache Eagle 深度调研</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/19631/" rel="bookmark">如何成为 Apache 的 PMC</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/26002/" rel="bookmark">Apache Kafka 分布式消息队列框架</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/54206/" rel="bookmark">大数据生态圈里的一致性算法</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/5845/" rel="bookmark">Apache Druid：一款高效的 OLAP 引擎</a></div>
    </li>
  </ul>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Benedict Jin
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://yuzhouwan.com/posts/31915/" title="ZooKeeper 原理与优化">https://yuzhouwan.com/posts/31915/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-ND</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

        

  <div class="followme">
    <p>欢迎关注我的其它发布渠道</p>

    <div class="social-list">

        <div class="social-item">
          <a target="_blank" class="social-link" href="/wechat_channel.jpg">
            <span class="icon">
              <i class="fab fa-weixin"></i>
            </span>

            <span class="label">WeChat</span>
          </a>
        </div>

        <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
        </div>
    </div>
  </div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Apache-Storm/" rel="tag"># Apache Storm</a>
              <a href="/tags/Apache-Kafka/" rel="tag"># Apache Kafka</a>
              <a href="/tags/Docker/" rel="tag"># Docker</a>
              <a href="/tags/Apache-Hadoop/" rel="tag"># Apache Hadoop</a>
              <a href="/tags/Apache-Druid/" rel="tag"># Apache Druid</a>
              <a href="/tags/JVM/" rel="tag"># JVM</a>
              <a href="/tags/Apache-ZooKeeper/" rel="tag"># Apache ZooKeeper</a>
              <a href="/tags/Paxos/" rel="tag"># Paxos</a>
              <a href="/tags/Raft/" rel="tag"># Raft</a>
              <a href="/tags/Apache-Flink/" rel="tag"># Apache Flink</a>
              <a href="/tags/Apache-HBase/" rel="tag"># Apache HBase</a>
              <a href="/tags/Apache-Yarn/" rel="tag"># Apache Yarn</a>
              <a href="/tags/ZAB/" rel="tag"># ZAB</a>
              <a href="/tags/Chubby/" rel="tag"># Chubby</a>
              <a href="/tags/HyperTable/" rel="tag"># HyperTable</a>
              <a href="/tags/Fourinone/" rel="tag"># Fourinone</a>
              <a href="/tags/Consul/" rel="tag"># Consul</a>
              <a href="/tags/Etcd/" rel="tag"># Etcd</a>
              <a href="/tags/Registrator/" rel="tag"># Registrator</a>
              <a href="/tags/Confd/" rel="tag"># Confd</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/posts/30041/" rel="prev" title="Git 高级玩法">
      <i class="fa fa-chevron-left"></i> Git 高级玩法
    </a></div>
      <div class="post-nav-item">
    <a href="/posts/42737/" rel="next" title="人工智能">
      人工智能 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
      <div class="tabs tabs-comment">
        <ul class="nav-tabs">
            <li class="tab"><a href="#comment-gitalk">Gitalk：可用 Github 账号登录</a></li>
            <li class="tab"><a href="#comment-disqus">Disqus：海外</a></li>
            <li class="tab"><a href="#comment-valine">Valine：匿名</a></li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane gitalk" id="comment-gitalk">
              <div class="comments" id="gitalk-container"></div>
            </div>
            <div class="tab-pane disqus" id="comment-disqus">
              
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  
            </div>
            <div class="tab-pane valine" id="comment-valine">
              <div class="comments" id="valine-comments"></div>
            </div>
        </div>
      </div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#ZooKeeper-%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="nav-number">1.</span> <span class="nav-text">ZooKeeper 是什么？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="nav-number">2.</span> <span class="nav-text">基本概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E8%A7%92%E8%89%B2"><span class="nav-number">2.1.</span> <span class="nav-text">集群角色</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%9A%E8%AF%9D"><span class="nav-number">2.2.</span> <span class="nav-text">会话</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="nav-number">2.3.</span> <span class="nav-text">数据模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%88%E6%9C%AC"><span class="nav-number">2.4.</span> <span class="nav-text">版本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Watcher"><span class="nav-number">2.5.</span> <span class="nav-text">Watcher</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ACL"><span class="nav-number">2.6.</span> <span class="nav-text">ACL</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E7%9A%84%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6"><span class="nav-number">2.6.1.</span> <span class="nav-text">常用的权限控制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#IP"><span class="nav-number">2.6.2.</span> <span class="nav-text">IP</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%BC%96%E7%A0%81"><span class="nav-number">2.6.2.1.</span> <span class="nav-text">编码</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C"><span class="nav-number">2.6.2.2.</span> <span class="nav-text">命令行</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="nav-number">2.6.2.3.</span> <span class="nav-text">优缺点</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Digest"><span class="nav-number">2.6.3.</span> <span class="nav-text">Digest</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%BC%96%E7%A0%81-1"><span class="nav-number">2.6.3.1.</span> <span class="nav-text">编码</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C-1"><span class="nav-number">2.6.3.2.</span> <span class="nav-text">命令行</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BC%98%E7%BC%BA%E7%82%B9-1"><span class="nav-number">2.6.3.3.</span> <span class="nav-text">优缺点</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SASL-amp-Kerberos"><span class="nav-number">2.6.4.</span> <span class="nav-text">SASL &amp; Kerberos</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="nav-number">3.</span> <span class="nav-text">环境搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%95%E6%9C%BA%E7%89%88"><span class="nav-number">3.1.</span> <span class="nav-text">单机版</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E8%A3%85"><span class="nav-number">3.1.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE"><span class="nav-number">3.1.2.</span> <span class="nav-text">配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8"><span class="nav-number">3.1.3.</span> <span class="nav-text">启动</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%B9%E5%99%A8%E7%89%88"><span class="nav-number">3.2.</span> <span class="nav-text">容器版</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E7%89%88"><span class="nav-number">3.3.</span> <span class="nav-text">集群版</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="nav-number">4.</span> <span class="nav-text">常用命令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9B%9B%E5%AD%97%E5%91%BD%E4%BB%A4"><span class="nav-number">4.1.</span> <span class="nav-text">四字命令</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="nav-number">4.1.1.</span> <span class="nav-text">使用方式</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-Netcat"><span class="nav-number">4.1.1.1.</span> <span class="nav-text">安装 Netcat</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Netcat-%E6%89%A7%E8%A1%8C"><span class="nav-number">4.1.1.2.</span> <span class="nav-text">Netcat 执行</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#DOS-%E6%94%BB%E5%87%BB"><span class="nav-number">4.1.2.</span> <span class="nav-text">DOS 攻击</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%A7%E7%94%9F%E7%9A%84%E6%97%A5%E5%BF%97"><span class="nav-number">4.1.3.</span> <span class="nav-text">产生的日志</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C%E8%84%9A%E6%9C%AC"><span class="nav-number">4.2.</span> <span class="nav-text">执行脚本</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#zkServer"><span class="nav-number">4.2.1.</span> <span class="nav-text">zkServer</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8-1"><span class="nav-number">4.2.1.1.</span> <span class="nav-text">启动</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%8E%92%E6%9F%A5%E9%97%AE%E9%A2%98"><span class="nav-number">4.2.1.2.</span> <span class="nav-text">排查问题</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#zkCli"><span class="nav-number">4.2.2.</span> <span class="nav-text">zkCli</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8-2"><span class="nav-number">4.2.2.1.</span> <span class="nav-text">启动</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%8A%82%E7%82%B9%E6%93%8D%E4%BD%9C"><span class="nav-number">4.2.2.2.</span> <span class="nav-text">节点操作</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E7%BB%84%E5%90%88%EF%BC%88for-Kafka%EF%BC%89"><span class="nav-number">4.2.2.3.</span> <span class="nav-text">常见组合（for Kafka）</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE"><span class="nav-number">5.</span> <span class="nav-text">常用配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#dataDir"><span class="nav-number">5.1.</span> <span class="nav-text">dataDir</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dataLogDir"><span class="nav-number">5.2.</span> <span class="nav-text">dataLogDir</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#clientPort"><span class="nav-number">5.3.</span> <span class="nav-text">clientPort</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tickTime%EF%BC%88SS-CS%EF%BC%89"><span class="nav-number">5.4.</span> <span class="nav-text">tickTime（SS &#x2F; CS）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#initLimit%EF%BC%88LF%EF%BC%89"><span class="nav-number">5.5.</span> <span class="nav-text">initLimit（LF）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#syncLimit%EF%BC%88LF%EF%BC%89"><span class="nav-number">5.6.</span> <span class="nav-text">syncLimit（LF）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#minSessionTimeout-amp-maxSessionTimeout"><span class="nav-number">5.7.</span> <span class="nav-text">minSessionTimeout &amp; maxSessionTimeout</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#maxClientCnxns"><span class="nav-number">5.8.</span> <span class="nav-text">maxClientCnxns</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E8%8A%82%E7%82%B9"><span class="nav-number">5.9.</span> <span class="nav-text">集群节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AE"><span class="nav-number">5.10.</span> <span class="nav-text">动态配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%91%E6%8E%A7"><span class="nav-number">6.</span> <span class="nav-text">监控</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%87%87%E9%9B%86%E6%96%B9%E5%BC%8F"><span class="nav-number">6.1.</span> <span class="nav-text">采集方式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#JMX"><span class="nav-number">6.1.1.</span> <span class="nav-text">JMX</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%BF%9C%E7%A8%8B%E8%BF%9E%E6%8E%A5"><span class="nav-number">6.1.1.1.</span> <span class="nav-text">远程连接</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Four-letter-command"><span class="nav-number">6.1.2.</span> <span class="nav-text">Four-letter command</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TCP-Dump"><span class="nav-number">6.1.3.</span> <span class="nav-text">TCP Dump</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%87%E6%A0%87"><span class="nav-number">6.2.</span> <span class="nav-text">指标</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ZooKeeper-%E8%BF%90%E8%A1%8C%E7%8A%B6%E6%80%81%EF%BC%88mntr%EF%BC%89"><span class="nav-number">6.2.1.</span> <span class="nav-text">ZooKeeper 运行状态（mntr）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E6%97%B6%E9%A2%84%E8%AD%A6"><span class="nav-number">6.3.</span> <span class="nav-text">实时预警</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#numenta-nupic"><span class="nav-number">6.3.1.</span> <span class="nav-text">numenta &#x2F; nupic</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98"><span class="nav-number">7.</span> <span class="nav-text">性能调优</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Benchmark"><span class="nav-number">7.1.</span> <span class="nav-text">Benchmark</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5"><span class="nav-number">7.2.</span> <span class="nav-text">优化策略</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2"><span class="nav-number">7.2.1.</span> <span class="nav-text">部署</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%97%A5%E5%BF%97%E7%9B%AE%E5%BD%95"><span class="nav-number">7.2.1.1.</span> <span class="nav-text">日志目录</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%87%AA%E5%8A%A8%E6%97%A5%E5%BF%97%E6%B8%85%E7%90%86"><span class="nav-number">7.2.1.2.</span> <span class="nav-text">自动日志清理</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#autopurge-purgeInterval"><span class="nav-number">7.2.1.2.1.</span> <span class="nav-text">autopurge.purgeInterval</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#autopurge-snapRetainCount"><span class="nav-number">7.2.1.2.2.</span> <span class="nav-text">autopurge.snapRetainCount</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Log4j-%E6%BB%9A%E5%8A%A8%E6%97%A5%E5%BF%97"><span class="nav-number">7.2.1.3.</span> <span class="nav-text">Log4j 滚动日志</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Observer-%E6%A8%A1%E5%BC%8F"><span class="nav-number">7.2.2.</span> <span class="nav-text">Observer 模式</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BD%9C%E7%94%A8"><span class="nav-number">7.2.2.1.</span> <span class="nav-text">作用</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%AF%B9%E8%AF%BB%E8%AF%B7%E6%B1%82%E8%BF%9B%E8%A1%8C%E6%89%A9%E5%B1%95"><span class="nav-number">7.2.2.1.1.</span> <span class="nav-text">对读请求进行扩展</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%B7%A8%E6%95%B0%E6%8D%AE%E4%B8%AD%E5%BF%83%E9%83%A8%E7%BD%B2"><span class="nav-number">7.2.2.1.2.</span> <span class="nav-text">跨数据中心部署</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE"><span class="nav-number">7.2.2.2.</span> <span class="nav-text">设置</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#INFORM-%E6%B6%88%E6%81%AF"><span class="nav-number">7.2.2.3.</span> <span class="nav-text">INFORM 消息</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE-1"><span class="nav-number">7.2.3.</span> <span class="nav-text">配置</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#JVM-%E7%9B%B8%E5%85%B3"><span class="nav-number">7.2.3.1.</span> <span class="nav-text">JVM 相关</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#swappiness"><span class="nav-number">7.2.3.1.1.</span> <span class="nav-text">swappiness</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%8D%87%E7%BA%A7-JDK8"><span class="nav-number">7.2.3.1.2.</span> <span class="nav-text">升级 JDK8</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#G1GC"><span class="nav-number">7.2.3.1.3.</span> <span class="nav-text">G1GC</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#LongAdder"><span class="nav-number">7.2.3.1.4.</span> <span class="nav-text">LongAdder</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ZooKeeper-%E7%9B%B8%E5%85%B3"><span class="nav-number">7.2.3.2.</span> <span class="nav-text">ZooKeeper 相关</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#leaderServes"><span class="nav-number">7.2.3.2.1.</span> <span class="nav-text">leaderServes</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#jute-maxbuffer"><span class="nav-number">7.2.3.2.2.</span> <span class="nav-text">jute.maxbuffer</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#globalOutstandingLimit"><span class="nav-number">7.2.3.2.3.</span> <span class="nav-text">globalOutstandingLimit</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#snapCount-amp-preAllocSize"><span class="nav-number">7.2.3.2.4.</span> <span class="nav-text">snapCount &amp; preAllocSize</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#zookeeper-serverCnxnFactory-amp-zookeeper-clientCnxnSocket"><span class="nav-number">7.2.3.2.5.</span> <span class="nav-text">zookeeper.serverCnxnFactory &amp; zookeeper.clientCnxnSocket</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number">8.</span> <span class="nav-text">源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="nav-number">8.1.</span> <span class="nav-text">源码环境搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD%E6%BA%90%E7%A0%81"><span class="nav-number">8.1.1.</span> <span class="nav-text">下载源码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85-Ant"><span class="nav-number">8.1.2.</span> <span class="nav-text">下载安装 Ant</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C-Ant-%E5%91%BD%E4%BB%A4"><span class="nav-number">8.1.3.</span> <span class="nav-text">执行 Ant 命令</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E5%87%BA-IDE-%E5%8F%AF%E8%AF%86%E5%88%AB%E7%9A%84%E7%8E%AF%E5%A2%83"><span class="nav-number">8.1.3.1.</span> <span class="nav-text">编译出 IDE 可识别的环境</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BA%8C%E6%AC%A1%E5%BC%80%E5%8F%91%E5%90%8E%EF%BC%8C%E8%BF%9B%E8%A1%8C%E6%9C%AC%E5%9C%B0%E6%B5%8B%E8%AF%95"><span class="nav-number">8.1.3.2.</span> <span class="nav-text">二次开发后，进行本地测试</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%89%93%E5%8C%85%E7%BC%96%E8%AF%91"><span class="nav-number">8.1.3.3.</span> <span class="nav-text">打包编译</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C-ZooKeeperServerMain"><span class="nav-number">8.1.4.</span> <span class="nav-text">运行 ZooKeeperServerMain</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91"><span class="nav-number">8.1.5.</span> <span class="nav-text">遇到的坑</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD%E4%BE%9D%E8%B5%96%E8%B6%85%E6%97%B6"><span class="nav-number">8.1.5.1.</span> <span class="nav-text">下载依赖超时</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#PowerMock-%E6%B5%8B%E8%AF%95-TestingServer-%E6%8A%A5%E9%94%99-ClassCastException"><span class="nav-number">8.1.5.2.</span> <span class="nav-text">PowerMock 测试 TestingServer 报错 ClassCastException</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%8F%8F%E8%BF%B0"><span class="nav-number">8.1.5.2.1.</span> <span class="nav-text">描述</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%88%86%E6%9E%90"><span class="nav-number">8.1.5.2.2.</span> <span class="nav-text">分析</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3"><span class="nav-number">8.1.5.2.3.</span> <span class="nav-text">解决</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%89%E4%B8%BB%E6%9C%BA%E5%88%B6"><span class="nav-number">8.2.</span> <span class="nav-text">选主机制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ZAB-%E9%80%89%E4%B8%BB%E6%B5%81%E7%A8%8B"><span class="nav-number">8.2.1.</span> <span class="nav-text">ZAB 选主流程</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ZooKeeper-%E6%8F%90%E4%BE%9B%E7%9A%84%E9%80%89%E4%B8%BB%E7%AE%97%E6%B3%95"><span class="nav-number">8.2.1.1.</span> <span class="nav-text">ZooKeeper 提供的选主算法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Vote-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">8.2.1.2.</span> <span class="nav-text">Vote 数据结构</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#QuorumCnxManager-%E7%BD%91%E7%BB%9C%E9%80%9A%E8%AE%AF"><span class="nav-number">8.2.1.3.</span> <span class="nav-text">QuorumCnxManager 网络通讯</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#LE-%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82"><span class="nav-number">8.2.1.4.</span> <span class="nav-text">LE 实现细节</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ZAB-%E5%92%8C-Paxos-%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">8.2.2.</span> <span class="nav-text">ZAB 和 Paxos 的区别</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%9B%B8%E5%85%B3"><span class="nav-number">8.3.</span> <span class="nav-text">数据相关</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ZooKeeper-%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84"><span class="nav-number">8.3.1.</span> <span class="nav-text">ZooKeeper 内存结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ZooKeeperServer-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B"><span class="nav-number">8.3.2.</span> <span class="nav-text">ZooKeeperServer 初始化流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Snapshot-%E7%AD%96%E7%95%A5"><span class="nav-number">8.3.3.</span> <span class="nav-text">Snapshot 策略</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B"><span class="nav-number">8.4.</span> <span class="nav-text">请求流程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ZooKeeper-%E4%B9%90%E8%A7%82%E9%94%81"><span class="nav-number">8.4.1.</span> <span class="nav-text">ZooKeeper 乐观锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ZooKeeper-%E8%BF%9E%E6%8E%A5%E5%9C%B0%E5%9D%80%E5%88%97%E8%A1%A8%E7%9A%84%E8%BF%9E%E6%8E%A5%E7%AD%96%E7%95%A5"><span class="nav-number">8.4.2.</span> <span class="nav-text">ZooKeeper 连接地址列表的连接策略</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Follower-%E5%92%8C-Observer-%E8%AF%B7%E6%B1%82%E8%BD%AC%E5%8F%91"><span class="nav-number">8.4.3.</span> <span class="nav-text">Follower 和 Observer 请求转发</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Watch-%E4%BA%8B%E4%BB%B6%E8%A7%A6%E5%8F%91%E6%B5%81%E7%A8%8B"><span class="nav-number">8.4.4.</span> <span class="nav-text">Watch 事件触发流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mntr-%E5%9B%9B%E5%AD%97%E5%91%BD%E4%BB%A4%E4%BD%BF%E7%94%A8-JVMFLAGS-%E5%92%8C-SERVER-JVMFLAGS-%E4%B8%AD%E9%85%8D%E7%BD%AE%E7%9A%84-JVM-%E5%8F%82%E6%95%B0"><span class="nav-number">8.4.5.</span> <span class="nav-text">mntr 四字命令使用 JVMFLAGS 和 SERVER_JVMFLAGS 中配置的 JVM 参数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="nav-number">8.5.</span> <span class="nav-text">架构设计</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ZooKeeper-%E7%9A%84-Server-ID-%E5%A6%82%E6%9E%9C%E9%87%8D%E5%A4%8D%E4%BC%9A%E6%9C%89%E4%BB%80%E4%B9%88%E9%A3%8E%E9%99%A9%EF%BC%9F"><span class="nav-number">8.5.1.</span> <span class="nav-text">ZooKeeper 的 Server ID 如果重复会有什么风险？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ZooKeeper-%E7%9A%84%E4%BA%8B%E5%8A%A1-ID-%E8%B6%85%E8%BF%87-32-%E4%BD%8D%EF%BC%8CZooKeeper-%E7%9A%84-Leader-%E8%8A%82%E7%82%B9%E6%8A%9B%E5%87%BA-XidRolloverException-%E5%BC%BA%E5%88%B6%E8%BF%9B%E8%A1%8C-re-election"><span class="nav-number">8.5.2.</span> <span class="nav-text">ZooKeeper 的事务 ID 超过 32 位，ZooKeeper 的 Leader 节点抛出 XidRolloverException 强制进行 re-election</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%87%8D%E5%BA%A6%E4%BE%9D%E8%B5%96-ZooKeeper-%E7%9A%84%E5%BA%94%E7%94%A8%EF%BC%8C%E5%8F%AF%E8%83%BD%E4%B8%80%E5%91%A8%E5%86%85%E5%8F%91%E7%94%9F-ZooKeeper-%E8%87%AA%E9%87%8D%E5%90%AF%E4%B8%80%E4%B8%A4%E6%AC%A1%EF%BC%8C%E6%AF%8F%E6%AC%A1%E9%9C%80-30-%E7%A7%92%EF%BC%8C%E6%9C%89%E6%97%A0%E6%9B%B4%E5%A5%BD%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95"><span class="nav-number">8.5.2.1.</span> <span class="nav-text">重度依赖 ZooKeeper 的应用，可能一周内发生 ZooKeeper 自重启一两次，每次需 30 秒，有无更好的解决方法</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E8%AF%AF%E5%8C%BA"><span class="nav-number">9.</span> <span class="nav-text">常见误区</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Paxos-%E7%9A%84%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7"><span class="nav-number">9.1.</span> <span class="nav-text">Paxos 的强一致性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%89%E4%BA%86%E9%80%BB%E8%BE%91%E6%97%B6%E9%92%9F%E5%90%8E%EF%BC%8C%E7%89%A9%E7%90%86%E6%97%B6%E9%92%9F%E5%B0%B1%E4%B8%8D%E5%86%8D%E9%9C%80%E8%A6%81%E4%BA%86"><span class="nav-number">9.2.</span> <span class="nav-text">有了逻辑时钟后，物理时钟就不再需要了</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BE%9D%E8%B5%96%E7%BB%84%E4%BB%B6%E6%A2%B3%E7%90%86"><span class="nav-number">10.</span> <span class="nav-text">依赖组件梳理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A2%B3%E7%90%86%E7%82%B9"><span class="nav-number">10.1.</span> <span class="nav-text">梳理点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BE%9D%E8%B5%96-ZooKeeper-%E7%9A%84%E6%A1%86%E6%9E%B6"><span class="nav-number">10.2.</span> <span class="nav-text">依赖 ZooKeeper 的框架</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Yarn"><span class="nav-number">10.2.1.</span> <span class="nav-text">Yarn</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91-1"><span class="nav-number">10.2.1.1.</span> <span class="nav-text">遇到的坑</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%BB%9A%E5%8A%A8%E9%87%8D%E5%90%AF%E5%8D%87%E7%BA%A7-ZooKeeper-%E4%B9%8B%E5%90%8E%EF%BC%8CYarn-%E4%B8%80%E7%9B%B4%E9%87%8D%E8%AF%95"><span class="nav-number">10.2.1.1.1.</span> <span class="nav-text">滚动重启升级 ZooKeeper 之后，Yarn 一直重试</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#HBase"><span class="nav-number">10.2.2.</span> <span class="nav-text">HBase</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91-2"><span class="nav-number">10.2.2.1.</span> <span class="nav-text">遇到的坑</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#KeeperErrorCode-Session-expired-for-hbase-meta-region-server"><span class="nav-number">10.2.2.1.1.</span> <span class="nav-text">KeeperErrorCode &#x3D; Session expired for &#x2F;hbase&#x2F;meta-region-server</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#fsync-ing-the-write-ahead-log-in-SyncThread-1-took-5051ms-which-will-adversely-effect-operation-latency"><span class="nav-number">10.2.2.1.2.</span> <span class="nav-text">fsync-ing the write ahead log in SyncThread:1 took 5051ms which will adversely effect operation latency</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Druid"><span class="nav-number">10.2.3.</span> <span class="nav-text">Druid</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91-3"><span class="nav-number">10.2.3.1.</span> <span class="nav-text">遇到的坑</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#DruidTaskResolver-Poll-failed-trying-again"><span class="nav-number">10.2.3.1.1.</span> <span class="nav-text">DruidTaskResolver: Poll failed, trying again</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Storm"><span class="nav-number">10.2.4.</span> <span class="nav-text">Storm</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91-4"><span class="nav-number">10.2.4.1.</span> <span class="nav-text">遇到的坑</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Unable-to-load-database-on-disk"><span class="nav-number">10.2.4.1.1.</span> <span class="nav-text">Unable to load database on disk</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Flink"><span class="nav-number">10.2.5.</span> <span class="nav-text">Flink</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91-5"><span class="nav-number">10.2.5.1.</span> <span class="nav-text">遇到的坑</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Node-not-empty-flink-sportsa-StarterALLJSPlaying-jobgraphs-6f96a21ae1aaf087b7423f504e554694"><span class="nav-number">10.2.5.1.1.</span> <span class="nav-text">Node not empty: &#x2F;flink&#x2F;sportsa&#x2F;StarterALLJSPlaying&#x2F;jobgraphs&#x2F;6f96a21ae1aaf087b7423f504e554694</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Hadoop"><span class="nav-number">10.2.6.</span> <span class="nav-text">Hadoop</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Kafka"><span class="nav-number">10.2.7.</span> <span class="nav-text">Kafka</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E6%8A%80%E6%9C%AF%E6%AF%94%E5%AF%B9"><span class="nav-number">11.</span> <span class="nav-text">其他技术比对</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%9D%E7%BB%B4%E5%AF%BC%E5%9B%BE"><span class="nav-number">11.1.</span> <span class="nav-text">思维导图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E6%A1%86%E6%9E%B6"><span class="nav-number">11.2.</span> <span class="nav-text">分布式框架</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Chubby"><span class="nav-number">11.2.1.</span> <span class="nav-text">Chubby</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#HyperTable"><span class="nav-number">11.2.2.</span> <span class="nav-text">HyperTable</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E8%87%B4%E6%80%A7%E7%AE%97%E6%B3%95"><span class="nav-number">11.3.</span> <span class="nav-text">一致性算法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Raft"><span class="nav-number">11.3.1.</span> <span class="nav-text">Raft</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E5%8D%8F%E5%90%8C"><span class="nav-number">11.4.</span> <span class="nav-text">分布式协同</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Fourinone"><span class="nav-number">11.4.1.</span> <span class="nav-text">Fourinone</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%8E%E5%8F%91%E7%8E%B0"><span class="nav-number">11.5.</span> <span class="nav-text">分布式服务注册与发现</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Consul"><span class="nav-number">11.5.1.</span> <span class="nav-text">Consul</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Etcd"><span class="nav-number">11.5.2.</span> <span class="nav-text">Etcd</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Registrator"><span class="nav-number">11.5.3.</span> <span class="nav-text">Registrator</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Confd"><span class="nav-number">11.5.4.</span> <span class="nav-text">Confd</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7"><span class="nav-number">12.</span> <span class="nav-text">实用工具</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%A5%E5%BF%97%E5%8F%AF%E8%A7%86%E5%8C%96%E5%B7%A5%E5%85%B7"><span class="nav-number">12.1.</span> <span class="nav-text">日志可视化工具</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Snapshot-%E5%8F%AF%E8%A7%86%E5%8C%96%E5%B7%A5%E5%85%B7"><span class="nav-number">12.2.</span> <span class="nav-text">Snapshot 可视化工具</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hue-Browser-%E9%9B%86%E7%BE%A4%E9%A1%B5%E9%9D%A2%E7%9B%91%E6%8E%A7%E5%B7%A5%E5%85%B7"><span class="nav-number">12.3.</span> <span class="nav-text">Hue Browser 集群页面监控工具</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Rest-%E6%9C%8D%E5%8A%A1"><span class="nav-number">12.3.1.</span> <span class="nav-text">Rest 服务</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%BC%96%E8%AF%91"><span class="nav-number">12.3.1.1.</span> <span class="nav-text">编译</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%8B%B7%E8%B4%9D-Jar-%E5%8C%85"><span class="nav-number">12.3.1.2.</span> <span class="nav-text">拷贝 Jar 包</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8-Rest-Service"><span class="nav-number">12.3.1.3.</span> <span class="nav-text">启动 Rest Service</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-Hue"><span class="nav-number">12.3.2.</span> <span class="nav-text">安装 Hue</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A7%BB%E9%99%A4-Watch-%E5%B7%A5%E5%85%B7"><span class="nav-number">12.4.</span> <span class="nav-text">移除 Watch 工具</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Docker-%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%E5%B7%A5%E5%85%B7"><span class="nav-number">12.5.</span> <span class="nav-text">Docker 开发环境部署工具</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%9F%E6%88%90%E9%85%8D%E7%BD%AE%E5%B7%A5%E5%85%B7"><span class="nav-number">12.6.</span> <span class="nav-text">生成配置工具</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%92%E7%83%9F%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7"><span class="nav-number">12.7.</span> <span class="nav-text">冒烟测试工具</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Curator-%E6%A1%86%E6%9E%B6"><span class="nav-number">12.8.</span> <span class="nav-text">Curator 框架</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A4%BE%E5%8C%BA%E8%B7%9F%E8%BF%9B"><span class="nav-number">13.</span> <span class="nav-text">社区跟进</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#PR-amp-Issues"><span class="nav-number">13.1.</span> <span class="nav-text">PR &amp; Issues</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ZooKeeper-%E7%A4%BE%E5%8C%BA%E7%9A%84%E4%B8%80%E4%BA%9B%E2%80%9C%E8%A7%84%E5%88%99%E2%80%9D"><span class="nav-number">13.2.</span> <span class="nav-text">ZooKeeper 社区的一些“规则”</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BF%9D%E6%8C%81-Diff-%E4%BF%A1%E6%81%AF%E6%9C%80%E7%AE%80"><span class="nav-number">13.2.1.</span> <span class="nav-text">保持 Diff 信息最简</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BF%9D%E6%8C%81-PR-%E7%9A%84%E7%9B%B8%E5%85%B3%E6%80%A7"><span class="nav-number">13.2.2.</span> <span class="nav-text">保持 PR 的相关性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BF%9D%E6%8C%81-%E4%BB%A3%E7%A0%81%E9%A3%8E%E6%A0%BC%E4%B8%80%E8%87%B4"><span class="nav-number">13.2.3.</span> <span class="nav-text">保持 代码风格一致</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%84%E9%81%BF%E5%B7%B2%E7%9F%A5-issues"><span class="nav-number">13.3.</span> <span class="nav-text">规避已知 issues</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%A5-v3-4-6-%E4%B8%BA%E4%BE%8B"><span class="nav-number">13.3.1.</span> <span class="nav-text">以 v3.4.6 为例</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#server"><span class="nav-number">13.3.1.1.</span> <span class="nav-text">server</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#quorum"><span class="nav-number">13.3.1.2.</span> <span class="nav-text">quorum</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#java-client"><span class="nav-number">13.3.1.3.</span> <span class="nav-text">java client</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#other"><span class="nav-number">13.3.1.4.</span> <span class="nav-text">other</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#improvement"><span class="nav-number">13.3.1.5.</span> <span class="nav-text">improvement</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B5%84%E6%96%99"><span class="nav-number">14.</span> <span class="nav-text">资料</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Book"><span class="nav-number">14.1.</span> <span class="nav-text">Book</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Paper"><span class="nav-number">14.2.</span> <span class="nav-text">Paper</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CPU"><span class="nav-number">14.3.</span> <span class="nav-text">CPU</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%AC%A2%E8%BF%8E%E5%8A%A0%E5%85%A5%E6%88%91%E4%BB%AC%E7%9A%84%E6%8A%80%E6%9C%AF%E7%BE%A4%EF%BC%8C%E4%B8%80%E8%B5%B7%E4%BA%A4%E6%B5%81%E5%AD%A6%E4%B9%A0"><span class="nav-number">15.</span> <span class="nav-text">欢迎加入我们的技术群，一起交流学习</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Benedict Jin" src="/yuzhouwan_logo_128x128.ico">
  <p class="site-author-name" itemprop="name">Benedict Jin</p>
  <div class="site-description" itemprop="description">Benedict Jin's Blog</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">54</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">147</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/asdf2014" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;asdf2014" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:asdf2014@apache.org" title="E-Mail → mailto:asdf2014@apache.org" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh" class="cc-opacity" rel="external nofollow noopener noreferrer" target="_blank"><img src="/images/cc-by-nc-nd.svg" alt="Creative Commons"></a>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        
  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="external nofollow noopener noreferrer" target="_blank">苏 ICP 备 17032505号 </a>
  </div>

<div class="copyright">
  
  &copy; 2014 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yuzhouwan.com</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">1.3m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">20:04</span>
</div>

        
<meta name="referrer" content="always">
<div class="busuanzi-count">
  <script async src="/lib/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




<script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.5/lib/darkmode-js.min.js"></script>
<script>
var options = {
  bottom: '32px', // default: '32px'
  right: '32px', // default: '32px'
  left: 'unset', // default: 'unset'
  time: '0.5s', // default: '0.3s'
  mixColor: '#fff', // default: '#fff'
  backgroundColor: '#fff',  // default: '#fff'
  buttonColorDark: '#100f2c',  // default: '#100f2c'
  buttonColorLight: '#fff', // default: '#fff'
  saveInCookies: true, // default: true,
  label: '🌓', // default: ''
  autoMatchOsTheme: false // default: true
}
const darkmode = new Darkmode(options);
darkmode.showWidget();
</script>
<style>
button.darkmode-toggle {
  z-index: 9999;
}
img, .darkmode-ignore {
  isolation: isolate;
  display: block;
}
</style>

  




  
<script src="/js/local-search.js"></script>











<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
          load: ['[tex]/mhchem'],
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
          packages: {'[+]': ['mhchem']},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

<script>
  var disqus_config = function() {
    this.page.url = "https://yuzhouwan.com/posts/31915/";
    this.page.identifier = "posts/31915/";
    this.page.title = "ZooKeeper 原理与优化";
    };
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://yuzhouwan.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : 'e5da61069b94deb8ef3a',
      clientSecret: 'c60ad4e430be258b705027a036eeee3d71cb934b',
      repo        : 'gitment',
      owner       : 'asdf2014',
      admin       : ['asdf2014'],
      id          : '37b30c7b01cffa7eef623d5ebba349cc',
        language: '',
      distractionFreeMode: false
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : true,
      appId      : 'BU4bnWsdAliFfk3fz7iMcFUU-gzGzoHsz',
      appKey     : '1xVLNFSy1qGCda3wt4GiGzHG',
      placeholder: "上述信息都不是必填的，可以直接提交评论",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</body>
</html>
