<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/yuzhouwan_logo_with_copyright.jpg">
  <link rel="icon" type="image/png" sizes="32x32" href="/yuzhouwan_logo_32x32.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/yuzhouwan_logo_16x16.ico">
  <link rel="mask-icon" href="/yuzhouwan_logo_with_copyright.jpg" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yuzhouwan.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":5,"onmobile":true},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":true,"nav":{"valine":{"text":"Valine：匿名","order":-1},"disqus":{"text":"Disqus：海外","order":-2},"gitalk":{"text":"Gitalk：可用 Github 账号登录","order":-3}}},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="本文主要介绍了 Redis 的环境搭建、实战技巧、技术内幕 和 Jedis 客户端相关内容。">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis 实战">
<meta property="og:url" content="https://yuzhouwan.com/posts/2129/">
<meta property="og:site_name" content="宇宙湾">
<meta property="og:description" content="本文主要介绍了 Redis 的环境搭建、实战技巧、技术内幕 和 Jedis 客户端相关内容。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://yuzhouwan.com/picture/redis/redis_hystrix_hystrix_dashboard.png">
<meta property="og:image" content="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg">
<meta property="og:image" content="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg">
<meta property="og:image" content="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg">
<meta property="og:image" content="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg">
<meta property="article:published_time" content="2017-07-19T13:16:08.000Z">
<meta property="article:modified_time" content="2020-09-16T16:13:47.840Z">
<meta property="article:author" content="Benedict Jin">
<meta property="article:tag" content="Redis">
<meta property="article:tag" content="Paxos">
<meta property="article:tag" content="Raft">
<meta property="article:tag" content="Jedis">
<meta property="article:tag" content="Guava">
<meta property="article:tag" content="Memcached">
<meta property="article:tag" content="MongoDB">
<meta property="article:tag" content="缓存">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://yuzhouwan.com/picture/redis/redis_hystrix_hystrix_dashboard.png">

<link rel="canonical" href="https://yuzhouwan.com/posts/2129/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Redis 实战 | 宇宙湾</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-97020848-1"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-97020848-1');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="宇宙湾" type="application/atom+xml"><!-- hexo-inject:begin --><!-- hexo-inject:end -->

<style>.null { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .null > span { position: relative; z-index: 10; }  .null img, .null .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .null img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .null-fallback { color: inherit; } .null-fallback img { opacity: 0 !important; }</style>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">宇宙湾</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">厚积薄发</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">147</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">15</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">54</span></a>

  </li>
        <li class="menu-item menu-item-书单">

    <a href="/books/" rel="section"><i class="fa fa-book fa-fw"></i>书单</a>

  </li>
        <li class="menu-item menu-item-影视">

    <a href="/movies/" rel="section"><i class="fa fa-film fa-fw"></i>影视</a>

  </li>
        <li class="menu-item menu-item-友链">

    <a href="/links/" rel="section"><i class="fa fa-link fa-fw"></i>友链</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yuzhouwan.com/posts/2129/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/yuzhouwan_logo_128x128.ico">
      <meta itemprop="name" content="Benedict Jin">
      <meta itemprop="description" content="Benedict Jin's Blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宇宙湾">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Redis 实战
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-07-19 21:16:08" itemprop="dateCreated datePublished" datetime="2017-07-19T21:16:08+08:00">2017-07-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-17 00:13:47" itemprop="dateModified" datetime="2020-09-17T00:13:47+08:00">2020-09-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/" itemprop="url" rel="index"><span itemprop="name">大数据</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>16k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>15 分钟</span>
            </span>
            <div class="post-description">本文主要介绍了 Redis 的环境搭建、实战技巧、技术内幕 和 Jedis 客户端相关内容。</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><h3 id="基础环境"><a href="#基础环境" class="headerlink" title="基础环境"></a>基础环境</h3><h4 id="用户"><a href="#用户" class="headerlink" title="用户"></a>用户</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 增加用户，并赋予其密码</span></span><br><span class="line">$ adduser redis</span><br><span class="line">$ passwd redis            <span class="comment"># ur password for redis user</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 赋予用户可以 sudo 的权限</span></span><br><span class="line">$ chmod u+w /etc/sudoers</span><br><span class="line">$ vim /etc/sudoers</span><br><span class="line">  <span class="comment"># 找到 `root ALL=(ALL) ALL` 这行，并在下面添加 redis 用户</span></span><br><span class="line">  redis    ALL=(ALL)    ALL</span><br><span class="line">$ chmod u-w /etc/sudoers</span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换到 redis 用户</span></span><br><span class="line">$ su - redis</span><br></pre></td></tr></tbody></table></figure>
<h4 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/redis</span><br><span class="line"></span><br><span class="line"><span class="comment"># 存放软件目录 &amp; 安装目录 &amp; 日志目录 &amp; 持久化数据存放目录</span></span><br><span class="line">$ mkdir install &amp;&amp; mkdir software &amp;&amp; mkdir logs &amp;&amp; mkdir data</span><br></pre></td></tr></tbody></table></figure>
<a id="more"></a>
<h3 id="分布式集群"><a href="#分布式集群" class="headerlink" title="分布式集群"></a>分布式集群</h3><h4 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/install</span><br><span class="line">$ wget http://download.redis.io/releases/redis-3.2.9.tar.gz</span><br></pre></td></tr></tbody></table></figure>
<h4 id="解压分发"><a href="#解压分发" class="headerlink" title="解压分发"></a>解压分发</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ tar zxvf redis-3.2.9.tar.gz -C ~/software</span><br><span class="line">$ <span class="built_in">cd</span> ~/software/</span><br><span class="line">$ scp -r redis-3.2.9/ redis@yuzhouwan02:/home/redis/software/</span><br><span class="line">$ scp -r redis-3.2.9/ redis@yuzhouwan03:/home/redis/software/</span><br><span class="line">$ ln -s redis-3.2.9/ redis</span><br></pre></td></tr></tbody></table></figure>
<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/software/redis</span><br><span class="line">$ make -j8</span><br><span class="line">  <span class="comment"># 输出如下信息，表示 make 成功</span></span><br><span class="line">  Hint: It<span class="string">'s a good idea to run '</span>make <span class="built_in">test</span><span class="string">' ;)</span></span><br><span class="line"><span class="string">  make[1]: Leaving directory `/home/redis/software/redis-3.2.9/src'</span></span><br><span class="line"></span><br><span class="line">$ vim ~/.bash_profile</span><br><span class="line">  REDIS_HOME=~/software/redis</span><br><span class="line">  PATH=<span class="variable">$PATH</span>:<span class="variable">$HOME</span>/bin:<span class="variable">$REDIS_HOME</span>/src</span><br><span class="line">$ <span class="built_in">source</span> ~/.bash_profile</span><br></pre></td></tr></tbody></table></figure>
<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ mv redis.conf redis.conf.bak</span><br><span class="line">$ vim redis.conf</span><br><span class="line">  <span class="built_in">bind</span> 0.0.0.0</span><br><span class="line">  port 6379</span><br><span class="line">  <span class="comment"># 启动 Redis 服务时，存储进程 pid 的位置</span></span><br><span class="line">  pidfile /home/redis/software/redis/redis.pid</span><br><span class="line">  logfile <span class="string">"/home/redis/logs/redis.log"</span></span><br><span class="line">  <span class="comment"># 持久化文件存储目录</span></span><br><span class="line">  dir /home/redis/data</span><br><span class="line">  <span class="comment"># 开启集群模式</span></span><br><span class="line">  cluster-enabled yes</span><br><span class="line">  <span class="comment"># 集群模式下的节点配置信息</span></span><br><span class="line">  cluster-config-file nodes.conf</span><br><span class="line">  <span class="comment"># 集群中各节点间连接超时时间</span></span><br><span class="line">  cluster-node-timeout 5000</span><br><span class="line">  <span class="comment"># 允许数据持久化追加</span></span><br><span class="line">  appendonly yes</span><br><span class="line"></span><br><span class="line">$ scp -r ~/software/redis/redis.conf redis@yuzhouwan02:/home/redis/software/redis/</span><br><span class="line">$ scp -r ~/software/redis/redis.conf redis@yuzhouwan03:/home/redis/software/redis/</span><br></pre></td></tr></tbody></table></figure>
<h4 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">$ nohup redis-server redis.conf 1&gt;/dev/null 2&gt;&amp;1 &amp;</span><br><span class="line">$ ps -ef | grep redis</span><br><span class="line">  redis    12781  9204  0 10:15 pts/0    00:00:00 redis-server 127.0.0.1:6379 [cluster]</span><br><span class="line"></span><br><span class="line">$ redis-cli -c -p 6379</span><br><span class="line">  127.0.0.1:6379&gt; cluster info</span><br><span class="line">  cluster_state:fail</span><br><span class="line">  cluster_slots_assigned:0</span><br><span class="line">  cluster_slots_ok:0</span><br><span class="line">  cluster_slots_pfail:0</span><br><span class="line">  cluster_slots_fail:0</span><br><span class="line">  cluster_known_nodes:1</span><br><span class="line">  cluster_size:0</span><br><span class="line">  cluster_current_epoch:0</span><br><span class="line">  cluster_my_epoch:0</span><br><span class="line">  cluster_stats_messages_sent:0</span><br><span class="line">  cluster_stats_messages_received:0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 因为 redis 集群至少需要 6 个节点，所以如果只想部署在 3 台机器上的话，可以考虑在每一台上，启动两个 redis 进程，对应端口、日志路径、存储目录，则需要依次更改</span></span><br><span class="line">$ <span class="built_in">cd</span> ~/software &amp;&amp; mkdir redis2 &amp;&amp; cp redis/redis.conf redis2/</span><br><span class="line">$ mkdir /home/redis/data2</span><br><span class="line">$ vim redis2/redis.conf</span><br><span class="line">  <span class="built_in">bind</span> 0.0.0.0</span><br><span class="line">  port 6380</span><br><span class="line">  <span class="comment"># 启动 Redis 服务时，存储进程 pid 的位置</span></span><br><span class="line">  pidfile /home/redis/software/redis2/redis.pid</span><br><span class="line">  logfile <span class="string">"/home/redis/logs/redis2.log"</span></span><br><span class="line">  <span class="comment"># 持久化文件存储目录</span></span><br><span class="line">  dir /home/redis/data2</span><br><span class="line">  <span class="comment"># 开启集群模式</span></span><br><span class="line">  cluster-enabled yes</span><br><span class="line">  <span class="comment"># 集群模式下的节点配置信息</span></span><br><span class="line">  cluster-config-file nodes2.conf</span><br><span class="line">  <span class="comment"># 集群中各节点间连接超时时间</span></span><br><span class="line">  cluster-node-timeout 5000</span><br><span class="line">  <span class="comment"># 允许数据持久化追加</span></span><br><span class="line">  appendonly yes</span><br><span class="line"></span><br><span class="line">$ scp -r ~/software/redis2/redis.conf redis@yuzhouwan02:/home/redis/software/redis2/</span><br><span class="line">$ scp -r ~/software/redis2/redis.conf redis@yuzhouwan03:/home/redis/software/redis2/</span><br><span class="line"></span><br><span class="line">$ nohup redis-server redis2/redis.conf 1&gt;/dev/null 2&gt;&amp;1 &amp;</span><br><span class="line"><span class="comment"># 如果启动不了，但是没有任何日志，需检查 redis2/redis.conf 是否和 redis/redis.conf 有路径、端口的冲突</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="集群配置"><a href="#集群配置" class="headerlink" title="集群配置"></a>集群配置</h4><h5 id="安装-Ruby"><a href="#安装-Ruby" class="headerlink" title="安装 Ruby"></a>安装 Ruby</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Debian / Ubuntu</span></span><br><span class="line">$ apt-get install ruby</span><br><span class="line"></span><br><span class="line"><span class="comment"># CentOS / Fedora / RHEL</span></span><br><span class="line">$ sudo yum install ruby</span><br><span class="line"></span><br><span class="line"><span class="comment"># Offline</span></span><br><span class="line"><span class="comment"># 下载 https://www.ruby-lang.org/en/downloads/</span></span><br><span class="line">$ <span class="built_in">cd</span> ~/install</span><br><span class="line">$ wget https://cache.ruby-lang.org/pub/ruby/2.4/ruby-2.4.1.tar.gz</span><br><span class="line">$ tar zxvf ruby-2.4.1.tar.gz -C ~/software</span><br><span class="line">$ <span class="built_in">cd</span> ~/software/ruby-2.4.1 &amp;&amp; mkdir ../ruby</span><br><span class="line">$ ./configure prefix=/home/redis/software/ruby</span><br><span class="line">$ make -j8 &amp;&amp; make -j8 install</span><br><span class="line"></span><br><span class="line">$ vim ~/.bash_profile</span><br><span class="line">  REDIS_HOME=~/software/redis</span><br><span class="line">  RUBY_HOME=~/software/ruby</span><br><span class="line">  PATH=<span class="variable">$PATH</span>:<span class="variable">$HOME</span>/bin:<span class="variable">$REDIS_HOME</span>/src:<span class="variable">$RUBY_HOME</span>/bin</span><br><span class="line">$ <span class="built_in">source</span> ~/.bash_profile</span><br><span class="line"></span><br><span class="line">$ ruby -v</span><br><span class="line">  ruby 2.4.1p111 (2017-03-22 revision 58053) [x86_64-linux]</span><br></pre></td></tr></tbody></table></figure>
<h5 id="安装-Redis-插件"><a href="#安装-Redis-插件" class="headerlink" title="安装 Redis 插件"></a>安装 Redis 插件</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Online</span></span><br><span class="line">$ gem update --system</span><br><span class="line">$ gem install redis</span><br><span class="line"><span class="comment"># 如果下载速度过慢，可考虑使用国内的 ruby 源</span></span><br><span class="line">$ gem sources remove http://rubygems.org/</span><br><span class="line">$ gem sources -a https://ruby.taobao.org/</span><br><span class="line"></span><br><span class="line"><span class="comment"># Offline</span></span><br><span class="line">$ <span class="built_in">cd</span> ~/install</span><br><span class="line">$ wget https://rubygems.org/downloads/redis-3.2.2.gem</span><br></pre></td></tr></tbody></table></figure>
<h5 id="redis-trib-创建分布式集群"><a href="#redis-trib-创建分布式集群" class="headerlink" title="redis-trib 创建分布式集群"></a>redis-trib 创建分布式集群</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">$ redis-trib.rb create --replicas 1 192.168.1.101:6379 192.168.1.102:6379 192.168.1.103:6379 192.168.1.101:6380 192.168.1.102:6380 192.168.1.103:6380</span><br><span class="line">  &gt;&gt;&gt; Creating cluster</span><br><span class="line">  &gt;&gt;&gt; Performing <span class="built_in">hash</span> slots allocation on 6 nodes...</span><br><span class="line">  Using 3 masters:</span><br><span class="line">  192.168.1.101:6379</span><br><span class="line">  192.168.1.102:6379</span><br><span class="line">  192.168.1.103:6379</span><br><span class="line">  Adding replica 192.168.1.102:6380 to 192.168.1.101:6379</span><br><span class="line">  Adding replica 192.168.1.101:6380 to 192.168.1.102:6379</span><br><span class="line">  Adding replica 192.168.1.103:6380 to 192.168.1.103:6379</span><br><span class="line">  M: 4c0fb081525a5f1893479225576b75f03cca065d 192.168.1.101:6379</span><br><span class="line">     slots:0-5460 (5461 slots) master</span><br><span class="line">  M: 4f9fc4536f6e4e30666264738d632b1bb54799f0 192.168.1.102:6379</span><br><span class="line">     slots:5461-10922 (5462 slots) master</span><br><span class="line">  M: 4dde95537b69d2b23f2f9a4cd2a357a1e4af756e 192.168.1.103:6379</span><br><span class="line">     slots:10923-16383 (5461 slots) master</span><br><span class="line">  S: 6ffea478b1e5d1187b85adc5b0bd11b6601dd556 192.168.1.101:6380</span><br><span class="line">     replicates 4f9fc4536f6e4e30666264738d632b1bb54799f0</span><br><span class="line">  S: 1213855d2c0d1b35020895af45dcd734da50ef2c 192.168.1.102:6380</span><br><span class="line">     replicates 4c0fb081525a5f1893479225576b75f03cca065d</span><br><span class="line">  S: 94478f8642d5a0cef1a989a620f132221e35fc8a 192.168.1.103:6380</span><br><span class="line">     replicates 4dde95537b69d2b23f2f9a4cd2a357a1e4af756e</span><br><span class="line">  Can I <span class="built_in">set</span> the above configuration? (<span class="built_in">type</span> <span class="string">'yes'</span> to accept): yes</span><br><span class="line">  &gt;&gt;&gt; Nodes configuration updated</span><br><span class="line">  &gt;&gt;&gt; Assign a different config epoch to each node</span><br><span class="line">  &gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster</span><br><span class="line">  Waiting <span class="keyword">for</span> the cluster to join...</span><br><span class="line">  &gt;&gt;&gt; Performing Cluster Check (using node 192.168.1.101:6379)</span><br><span class="line">  M: 4c0fb081525a5f1893479225576b75f03cca065d 192.168.1.101:6379</span><br><span class="line">     slots:0-5460 (5461 slots) master</span><br><span class="line">     1 additional replica(s)</span><br><span class="line">  S: 6ffea478b1e5d1187b85adc5b0bd11b6601dd556 192.168.1.101:6380</span><br><span class="line">     slots: (0 slots) slave</span><br><span class="line">     replicates 4f9fc4536f6e4e30666264738d632b1bb54799f0</span><br><span class="line">  M: 4dde95537b69d2b23f2f9a4cd2a357a1e4af756e 192.168.1.103:6379</span><br><span class="line">     slots:10923-16383 (5461 slots) master</span><br><span class="line">     1 additional replica(s)</span><br><span class="line">  S: 1213855d2c0d1b35020895af45dcd734da50ef2c 192.168.1.102:6380</span><br><span class="line">     slots: (0 slots) slave</span><br><span class="line">     replicates 4c0fb081525a5f1893479225576b75f03cca065d</span><br><span class="line">  S: 94478f8642d5a0cef1a989a620f132221e35fc8a 192.168.1.103:6380</span><br><span class="line">     slots: (0 slots) slave</span><br><span class="line">     replicates 4dde95537b69d2b23f2f9a4cd2a357a1e4af756e</span><br><span class="line">  M: 4f9fc4536f6e4e30666264738d632b1bb54799f0 192.168.1.102:6379</span><br><span class="line">     slots:5461-10922 (5462 slots) master</span><br><span class="line">     1 additional replica(s)</span><br><span class="line">  [OK] All nodes agree about slots configuration.</span><br><span class="line">  &gt;&gt;&gt; Check <span class="keyword">for</span> open slots...</span><br><span class="line">  &gt;&gt;&gt; Check slots coverage...</span><br><span class="line">  [OK] All 16384 slots covered.</span><br></pre></td></tr></tbody></table></figure>
<h5 id="redis-cli-集群状态检查"><a href="#redis-cli-集群状态检查" class="headerlink" title="redis-cli 集群状态检查"></a>redis-cli 集群状态检查</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 至此，大功告成~</span></span><br><span class="line">$ redis-cli -c -p 6379</span><br><span class="line">  127.0.0.1:6379&gt; cluster info</span><br><span class="line">  cluster_state:ok</span><br><span class="line">  cluster_slots_assigned:16384</span><br><span class="line">  cluster_slots_ok:16384</span><br><span class="line">  cluster_slots_pfail:0</span><br><span class="line">  cluster_slots_fail:0</span><br><span class="line">  cluster_known_nodes:6</span><br><span class="line">  cluster_size:3</span><br><span class="line">  cluster_current_epoch:6</span><br><span class="line">  cluster_my_epoch:1</span><br><span class="line">  cluster_stats_messages_sent:376</span><br><span class="line">  cluster_stats_messages_received:376</span><br></pre></td></tr></tbody></table></figure>
<h4 id="关闭"><a href="#关闭" class="headerlink" title="关闭"></a>关闭</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pkill redis</span><br></pre></td></tr></tbody></table></figure>
<h3 id="遇到的坑"><a href="#遇到的坑" class="headerlink" title="遇到的坑"></a>遇到的坑</h3><h4 id="cannot-load-such-file-—-zlib"><a href="#cannot-load-such-file-—-zlib" class="headerlink" title="cannot load such file — zlib"></a>cannot load such file — zlib</h4><h5 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ gem install -l redis-3.2.2.gem</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果出现如下报错，则应该先安装 zlib-devel</span></span><br><span class="line">  ERROR:  Loading <span class="built_in">command</span>: install (LoadError)</span><br><span class="line">      cannot load such file -- zlib</span><br><span class="line">  ERROR:  While executing gem ... (NoMethodError)</span><br><span class="line">      undefined method `invoke_with_build_args<span class="string">' for nil:NilClass</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ yum install zlib-devel</span><br><span class="line"><span class="comment"># 离线环境下，推荐先在有网环境中，使用 --downloadonly 的方式，把依赖包直接下载下来（也可在 https://www.rpmfind.net 里面找，但比较低效）</span></span><br><span class="line">$ yum reinstall --downloadonly --downloaddir=/opt/software/zlib zlib-devel zlib libc.so.6 glibc-common glibc libfreebl3.so zlib-1.2.3-27.el6 -y</span><br><span class="line">$ ll /opt/software/zlib</span><br><span class="line">  -rw-r--r-- 1 root root  4558520 Feb 18  2016 glibc-2.12-1.166.el6_7.7.i686.rpm</span><br><span class="line">  -rw-r--r-- 1 root root 14887196 Feb 18  2016 glibc-common-2.12-1.166.el6_7.7.x86_64.rpm</span><br><span class="line">  -rw-r--r-- 1 root root   118976 Nov  9  2011 nss-softokn-freebl-3.12.9-11.el6.i686.rpm</span><br><span class="line">  -rw-r--r-- 1 root root    73604 Sep 26  2011 zlib-1.2.3-27.el6.i686.rpm</span><br><span class="line">  -rw-r--r-- 1 root root    73864 Sep 26  2011 zlib-1.2.3-27.el6.x86_64.rpm</span><br><span class="line">  -rw-r--r-- 1 root root    44728 Sep 26  2011 zlib-devel-1.2.3-27.el6.x86_64.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可能存在 "循环依赖" 和 "依赖冲突"</span></span><br><span class="line"><span class="comment"># 前者，可以通过 force 强制安装好，其中一个</span></span><br><span class="line">$ rpm -ivh glibc-2.12-1.166.el6_7.7.i686 --nodeps --force</span><br><span class="line"><span class="comment"># 后者，可以通过 nodeps 不删除被依赖包，进行卸载</span></span><br><span class="line"><span class="comment"># 【注意】/lib64/libz* 需要提前备份好，否则卸载掉 zlib 之后，会因为缺少 libz.so.1，导致 yum/rpm/ssh 等命令均失效！</span></span><br><span class="line">$ rpm -e --nodeps zlib-1.2.3-29.el6.x86_64</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装完成之后，将 Ruby 重新编译安装一遍，即可</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="ERR-Slot-0-is-already-busy"><a href="#ERR-Slot-0-is-already-busy" class="headerlink" title="ERR Slot 0 is already busy"></a>ERR Slot 0 is already busy</h4><h5 id="描述-1"><a href="#描述-1" class="headerlink" title="描述"></a>描述</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 执行 redis-trib.rb 遇到</span></span><br><span class="line">ERR Slot 0 is already busy (Redis::CommandError)</span><br></pre></td></tr></tbody></table></figure>
<h5 id="解决-1"><a href="#解决-1" class="headerlink" title="解决"></a>解决</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过 cluster reset soft 命令解决</span></span><br><span class="line">$ redis-cli -h 127.0.0.1 -p 6379 cluster reset soft &amp;&amp; redis-cli -h 127.0.0.1 -p 6380 cluster reset soft</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">OK</span><br><span class="line">OK</span><br></pre></td></tr></tbody></table></figure>
<h4 id="ERR-Invalid-node-address-specified"><a href="#ERR-Invalid-node-address-specified" class="headerlink" title="ERR Invalid node address specified"></a>ERR Invalid node address specified</h4><h5 id="描述-2"><a href="#描述-2" class="headerlink" title="描述"></a>描述</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 执行创建 Redis 集群</span></span><br><span class="line">$ redis-trib.rb create --replicas 1 yuzhouwan01:6379 yuzhouwan02:6379 yuzhouwan03:6379 yuzhouwan01:6380 yuzhouwan02:6380 yuzhouwan03:6380</span><br><span class="line"><span class="comment"># 报错 ERR Invalid node address specified</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="解决-2"><a href="#解决-2" class="headerlink" title="解决"></a>解决</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 目前为止，只支持 IP，不支持 Hostname，因此将主机名替换为 IP 即可（PR#2323 中准备解决该问题）</span></span><br><span class="line">$ redis-trib.rb create --replicas 1 192.168.1.101:6379 192.168.1.102:6379 192.168.1.103:6379 192.168.1.101:6380 192.168.1.102:6380 192.168.1.103:6380</span><br></pre></td></tr></tbody></table></figure>
<h2 id="Jedis-客户端"><a href="#Jedis-客户端" class="headerlink" title="Jedis 客户端"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-bigdata/yuzhouwan-bigdata-redis/src/main/java/com/yuzhouwan/bigdata/redis/conn/RedisClusterConnPool.java">Jedis 客户端</a></h2><h3 id="连接集群"><a href="#连接集群" class="headerlink" title="连接集群"></a>连接集群</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(DynamicPropUtils DP)</span> </span>{</span><br><span class="line">    Object clusterListObj = DP.get(PROJECT_NAME, <span class="string">"redis.cluster.list"</span>);</span><br><span class="line">    String clusterList;</span><br><span class="line">    <span class="keyword">if</span> (clusterListObj == <span class="keyword">null</span> || StrUtils.isEmpty(clusterList = clusterListObj.toString())) {</span><br><span class="line">        String error = String.format(<span class="string">"Cannot get [%s-redis.cluster.list] from Dynamic PropUtils!"</span>, PROJECT_NAME);</span><br><span class="line">        _log.error(error);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(error);</span><br><span class="line">    }</span><br><span class="line">    String[] hostAndPort;</span><br><span class="line">    Set&lt;HostAndPort&gt; jedisClusterNodes = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (String clusters : clusterList.split(<span class="string">","</span>)) {</span><br><span class="line">        hostAndPort = clusters.split(<span class="string">":"</span>);</span><br><span class="line">        jedisClusterNodes.add(<span class="keyword">new</span> HostAndPort(hostAndPort[<span class="number">0</span>], Integer.valueOf(hostAndPort[<span class="number">1</span>])));</span><br><span class="line">    }</span><br><span class="line">    JedisPoolConfig conf = <span class="keyword">new</span> JedisPoolConfig();</span><br><span class="line">    conf.setMaxTotal(<span class="number">1000</span>);</span><br><span class="line">    conf.setMinIdle(<span class="number">50</span>);</span><br><span class="line">    conf.setMaxIdle(<span class="number">100</span>);</span><br><span class="line">    conf.setMaxWaitMillis(<span class="number">6</span> * <span class="number">1000</span>);</span><br><span class="line">    conf.setTestOnBorrow(<span class="keyword">true</span>);</span><br><span class="line">    pool = <span class="keyword">new</span> JedisCluster(jedisClusterNodes, conf);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="集群操作"><a href="#集群操作" class="headerlink" title="集群操作"></a>集群操作</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Long <span class="title">putSet</span><span class="params">(String key, String... values)</span> </span>{</span><br><span class="line">  <span class="keyword">return</span> pool.sadd(key, values);</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getSet</span><span class="params">(String key)</span> </span>{</span><br><span class="line">  <span class="keyword">return</span> pool.smembers(key);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="资源释放"><a href="#资源释放" class="headerlink" title="资源释放"></a>资源释放</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> throw IOException </span>{</span><br><span class="line">  <span class="keyword">if</span> (pool != <span class="keyword">null</span>) pool.close();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="过期事件回调"><a href="#过期事件回调" class="headerlink" title="过期事件回调"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://redis.io/topics/notifications">过期事件</a>回调</h3><h4 id="配置集群"><a href="#配置集群" class="headerlink" title="配置集群"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://raw.githubusercontent.com/antirez/redis/2.8/redis.conf">配置</a>集群</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过 redis-cli 进行动态配置</span></span><br><span class="line">$ redis-cli -h localhost -p 6380</span><br><span class="line">  CONFIG SET notify-keyspace-events AKE     <span class="comment"># AKE: 意味着通知所有事件</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 redis.conf，并重启集群使其生效</span></span><br><span class="line">$ vim redis.conf</span><br><span class="line">  notify-keyspace-events AKE</span><br></pre></td></tr></tbody></table></figure>
<h4 id="服务端验证"><a href="#服务端验证" class="headerlink" title="服务端验证"></a>服务端验证</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ redis-cli</span><br><span class="line">  127.0.0.1:6379&gt; <span class="built_in">set</span> yuzhouwan01 blog</span><br><span class="line">    OK</span><br><span class="line">  127.0.0.1:6379&gt; expire yuzhouwan01 3</span><br><span class="line">    (<span class="built_in">integer</span>) 1</span><br><span class="line">  127.0.0.1:6379&gt; ttl yuzhouwan01</span><br><span class="line">    (<span class="built_in">integer</span>) 0</span><br><span class="line">  127.0.0.1:6379&gt; ttl yuzhouwan01</span><br><span class="line">    (<span class="built_in">integer</span>) -2</span><br><span class="line"></span><br><span class="line">$ redis-cli -h localhost -p 6379 --csv psubscribe <span class="string">'*'</span></span><br><span class="line">  <span class="string">"pmessage"</span>,<span class="string">"*"</span>,<span class="string">"__keyspace@0__:yuzhouwan01"</span>,<span class="string">"set"</span></span><br><span class="line">  <span class="string">"pmessage"</span>,<span class="string">"*"</span>,<span class="string">"__keyevent@0__:set"</span>,<span class="string">"yuzhouwan01"</span></span><br><span class="line">  <span class="string">"pmessage"</span>,<span class="string">"*"</span>,<span class="string">"__keyspace@0__:yuzhouwan01"</span>,<span class="string">"expire"</span></span><br><span class="line">  <span class="string">"pmessage"</span>,<span class="string">"*"</span>,<span class="string">"__keyevent@0__:expire"</span>,<span class="string">"yuzhouwan01"</span></span><br><span class="line">  <span class="string">"pmessage"</span>,<span class="string">"*"</span>,<span class="string">"__keyspace@0__:yuzhouwan01"</span>,<span class="string">"expired"</span></span><br><span class="line">  <span class="string">"pmessage"</span>,<span class="string">"*"</span>,<span class="string">"__keyevent@0__:expired"</span>,<span class="string">"yuzhouwan01"</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="连接集群-1"><a href="#连接集群-1" class="headerlink" title="连接集群"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-bigdata/yuzhouwan-bigdata-redis/src/main/java/com/yuzhouwan/bigdata/redis/conn/RedisClusterConnPool.java">连接</a>集群</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getClusterList</span><span class="params">(DynamicPropUtils DP)</span> </span>{</span><br><span class="line">    Object clusterListObj = DP.get(PROJECT_NAME, <span class="string">"redis.cluster.list"</span>);</span><br><span class="line">    String clusterList;</span><br><span class="line">    <span class="keyword">if</span> (clusterListObj == <span class="keyword">null</span> || StrUtils.isEmpty(clusterList = clusterListObj.toString())) {</span><br><span class="line">        String error = String.format(<span class="string">"Cannot get [%s-redis.cluster.list] from Dynamic PropUtils!"</span>, PROJECT_NAME);</span><br><span class="line">        _log.error(error);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(error);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> clusterList;</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">private</span> JedisPoolConfig <span class="title">buildConf</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// org.apache.commons.pool2.impl.BaseObjectPoolConfig</span></span><br><span class="line">    JedisPoolConfig conf = <span class="keyword">new</span> JedisPoolConfig();</span><br><span class="line">    conf.setMaxTotal(<span class="number">1000</span>);</span><br><span class="line">    conf.setMinIdle(<span class="number">50</span>);</span><br><span class="line">    conf.setMaxIdle(<span class="number">100</span>);</span><br><span class="line">    <span class="comment">// conf.setMaxWaitMillis(6 * 1000);</span></span><br><span class="line">    conf.setTestOnCreate(<span class="keyword">true</span>);</span><br><span class="line">    conf.setTestOnBorrow(<span class="keyword">true</span>);</span><br><span class="line">    conf.setTestOnReturn(<span class="keyword">true</span>);</span><br><span class="line">    conf.setTestWhileIdle(<span class="keyword">true</span>);</span><br><span class="line">    <span class="comment">// conf.setTimeBetweenEvictionRunsMillis(1);</span></span><br><span class="line">    conf.setNumTestsPerEvictionRun(<span class="number">30</span>);</span><br><span class="line">    <span class="keyword">return</span> conf;</span><br><span class="line">}</span><br><span class="line"><span class="comment">// 这里不要使用 JedisCluster，因为 cluster 模式下，jedis 只会连接一个节点，会导致监听不到其他节点上的事件</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initPools</span><span class="params">(DynamicPropUtils DP)</span> </span>{</span><br><span class="line">    String clusterList = getClusterList(DP);</span><br><span class="line">    pools = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">    String[] hostAndPort;</span><br><span class="line">    <span class="keyword">for</span> (String clusters : clusterList.split(<span class="string">","</span>)) {</span><br><span class="line">        hostAndPort = clusters.split(<span class="string">":"</span>);</span><br><span class="line">        pools.add(<span class="keyword">new</span> JedisPool(buildConf(), hostAndPort[<span class="number">0</span>], Integer.valueOf(hostAndPort[<span class="number">1</span>])));</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="回调监听器"><a href="#回调监听器" class="headerlink" title="回调监听器"></a>回调<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-bigdata/yuzhouwan-bigdata-redis/src/main/java/com/yuzhouwan/bigdata/redis/notification/RedisNotification.java">监听器</a></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> (RedisClusterConnPool pool = <span class="keyword">new</span> RedisClusterConnPool(dp, <span class="keyword">true</span>)) {</span><br><span class="line">    List&lt;JedisPool&gt; jedis = pool.getPools();</span><br><span class="line">    JedisPubSub jedisPubSub = <span class="keyword">new</span> JedisPubSub() {</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPSubscribe</span><span class="params">(String pattern, <span class="keyword">int</span> subscribedChannels)</span> </span>{</span><br><span class="line">            _log.info(<span class="string">"onPSubscribe {} {}"</span>, pattern, subscribedChannels);</span><br><span class="line">        }</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPMessage</span><span class="params">(String pattern, String channel, String message)</span> </span>{</span><br><span class="line">            _log.info(<span class="string">"onPMessage: {}, Channel: {}, Message: {}"</span>, pattern, channel, message);</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line">    <span class="keyword">for</span> (JedisPool j : jedis)</span><br><span class="line">        j.getResource().psubscribe(jedisPubSub, <span class="string">"__keyevent@*__:expired"</span> <span class="comment">/*"__key*__:*"*/</span> <span class="comment">/*"*"*/</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-bigdata/yuzhouwan-bigdata-redis/src/test/java/com/yuzhouwan/bigdata/redis/notification/RedisNotificationTest.java#L22">测试</a></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pool.put(<span class="string">"yuzhouwan01"</span>, <span class="string">"blog01"</span>);</span><br><span class="line">pool.expire(<span class="string">"yuzhouwan01"</span>, <span class="number">2</span>);</span><br><span class="line">Thread.sleep(<span class="number">2100</span>);</span><br><span class="line">assertEquals(<span class="keyword">null</span>, pool.get(<span class="string">"yuzhouwan01"</span>));</span><br><span class="line"></span><br><span class="line"><span class="number">2017</span>-<span class="number">07</span>-<span class="number">26</span> <span class="number">16</span>:<span class="number">18</span>:<span class="number">56.045</span> | INFO | onPMessage Pattern: *, Channel: __keyevent@<span class="number">0</span>__:set, Message: yuzhouwan01 | com.yuzhouwan.bigdata.redis.notification.RedisNotification.onPMessage | RedisNotification.java:<span class="number">61</span> </span><br><span class="line"><span class="number">2017</span>-<span class="number">07</span>-<span class="number">26</span> <span class="number">16</span>:<span class="number">18</span>:<span class="number">56.045</span> | INFO | onPMessage Pattern: *, Channel: __keyevent@<span class="number">0</span>__:expire, Message: yuzhouwan01 | com.yuzhouwan.bigdata.redis.notification.RedisNotification.onPMessage | RedisNotification.java:<span class="number">61</span> </span><br><span class="line"><span class="number">2017</span>-<span class="number">07</span>-<span class="number">26</span> <span class="number">16</span>:<span class="number">18</span>:<span class="number">57.064</span> | INFO | onPMessage Pattern: *, Channel: __keyevent@<span class="number">0</span>__:expired, Message: yuzhouwan01 | com.yuzhouwan.bigdata.redis.notification.RedisNotification.onPMessage | RedisNotification.java:<span class="number">61</span> </span><br></pre></td></tr></tbody></table></figure>
<h2 id="实战技巧"><a href="#实战技巧" class="headerlink" title="实战技巧"></a>实战技巧</h2><h3 id="匹配删除"><a href="#匹配删除" class="headerlink" title="匹配删除"></a>匹配删除</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ redis-cli flushdb</span><br><span class="line">$ redis-cli --raw -n 1 keys <span class="string">"yuzhouwan*"</span> | xargs -L1 -I{} redis-cli move {} 0</span><br><span class="line">$ redis-cli</span><br><span class="line">  127.0.0.1:6379&gt; keys yuzhouwan*</span><br><span class="line">  (empty list or <span class="built_in">set</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以安装使用 redis-utils-cli（https://www.npmjs.com/package/redis-utils-cli）</span></span><br><span class="line">$ redis-utils del 127.0.0.1 yuzhouwan*</span><br></pre></td></tr></tbody></table></figure>
<h3 id="数据容灾"><a href="#数据容灾" class="headerlink" title="数据容灾"></a>数据容灾</h3><p>　主从热备 + 二级缓存 + 从库 AOF（主从切换）</p>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://segmentfault.com/a/1190000002906345">Redis 持久化</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="http://www.cnblogs.com/chenmh/p/5578376.html">Redis 哨兵模式实现主从故障互切换</a></li>
<li>《Redis in Action》 第 4 章</li>
</ul>
<h3 id="全局流控"><a href="#全局流控" class="headerlink" title="全局流控"></a>全局流控</h3><h4 id="流控方案"><a href="#流控方案" class="headerlink" title="流控方案"></a>流控方案</h4><h5 id="Leaky-bucket-漏桶算法"><a href="#Leaky-bucket-漏桶算法" class="headerlink" title="Leaky bucket 漏桶算法"></a>Leaky bucket 漏桶算法</h5><p>　桶内水溢出时，可以把消息放到队列中等待</p>
<h5 id="Token-bucket-令牌桶算法"><a href="#Token-bucket-令牌桶算法" class="headerlink" title="Token bucket 令牌桶算法"></a>Token bucket 令牌桶算法</h5><p>　桶内令牌不足时，可以把消息放到队列中等待</p>
<h4 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式"></a>实现方式</h4><h5 id="Guava-RateLimiter"><a href="#Guava-RateLimiter" class="headerlink" title="Guava RateLimiter"></a>Guava RateLimiter</h5><p>　Guava 无法做到全局流控</p>
<h5 id="Redis-Expire-机制"><a href="#Redis-Expire-机制" class="headerlink" title="Redis Expire 机制"></a>Redis Expire 机制</h5><p>　如果设置的超时时间过长，可能对内存有一定的损耗</p>
<h5 id="Hystrix-限流"><a href="#Hystrix-限流" class="headerlink" title="Hystrix 限流"></a>Hystrix 限流</h5><p>　支持 自动降级、熔断与恢复、依赖隔离、异常记录、流量控制、实时监控，不过会存在一定的 代码侵入 和 性能损耗 的问题（1%~5%）</p>
<p><img data-src="/picture/redis/redis_hystrix_hystrix_dashboard.png" alt="Hystrix"></p>
<center>（图片来源：<a href="https://github.com/Netflix/Hystrix/wiki" target="_blank" rel="external nofollow noopener noreferrer">Hystrix</a>™ 官网）</center>

<h4 id="参考-1"><a href="#参考-1" class="headerlink" title="参考"></a>参考</h4><ul>
<li>单机版<ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.cnblogs.com/moonandstar08/p/5440555.html">高并发场景下的流控管理</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="http://ifeve.com/guava-ratelimiter/">Guava 官方文档 - RateLimiter 类</a></li>
</ul>
</li>
<li>分布式<ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.zybuluo.com/kay2/note/949160">基于 Redis 的限流系统的设计</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://redis.io/commands/INCR#pattern-rate-limiter">Redis Doc: Pattern: Rate limiter</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/nereuschen/blog/issues/37">限流技术 #37</a></li>
</ul>
</li>
<li>Hystrix<ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/Netflix/Hystrix">Hystrix: Latency and Fault Tolerance for Distributed Systems</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="http://www.jianshu.com/p/d72b96a7ca31">Hystrix 入门研究</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="http://www.iocoder.cn/categories/Hystrix/">Hystrix 源码解析</a></li>
</ul>
</li>
<li>理论基础<ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://en.wikipedia.org/wiki/Little's_law">排队理论</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://en.wikipedia.org/wiki/Leaky_bucket">Leaky bucket 漏桶算法</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://en.wikipedia.org/wiki/Token_bucket">Token bucket 令牌桶算法</a></li>
</ul>
</li>
</ul>
<p>Tips: Full code is <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-bigdata/yuzhouwan-bigdata-redis/src/test/java/com/yuzhouwan/bigdata/redis/rate/limit/GuavaRateLimiterTest.java">here</a>.</p>
<h2 id="技术内幕"><a href="#技术内幕" class="headerlink" title="技术内幕"></a>技术内幕</h2><h3 id="缓存穿透-vs-缓存雪崩-vs-缓存失效"><a href="#缓存穿透-vs-缓存雪崩-vs-缓存失效" class="headerlink" title="缓存穿透 vs 缓存雪崩 vs 缓存失效"></a>缓存穿透 vs 缓存雪崩 vs 缓存失效</h3><h4 id="缓存穿透"><a href="#缓存穿透" class="headerlink" title="缓存穿透"></a>缓存穿透</h4><h5 id="场景描述"><a href="#场景描述" class="headerlink" title="场景描述"></a>场景描述</h5><p>　一般的缓存系统，都是按照 key 去缓存查询，如果不存在对应的 value，就应该去后端系统查找（比如 DB）。如果 key 对应的 value 是一定不存在的，并且对该 key 并发请求量很大，就会对后端系统造成很大的压力，我们称之为<strong>缓存穿透</strong></p>
<h5 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h5><ul>
<li>对查询结果为空的情况也进行缓存，缓存过期时间设置短一点（避免消耗太多的缓存空间），或者该 key 对应的数据 insert 了之后清理缓存</li>
<li>对一定不存在的 key 进行过滤。可以把所有的可能存在的 key 放到一个大的 Bitmap 中，查询时通过该 Bitmap 过滤</li>
<li>排查是否是自身程序或者数据的问题，亦或是外部恶意攻击或者爬虫，导致大量访问不存在的 key 值</li>
</ul>
<h4 id="缓存雪崩"><a href="#缓存雪崩" class="headerlink" title="缓存雪崩"></a>缓存雪崩</h4><h5 id="场景描述-1"><a href="#场景描述-1" class="headerlink" title="场景描述"></a>场景描述</h5><p>　<strong>缓存雪崩</strong>，是指当缓存服务器重启或者大量缓存集中在某一个时间段失效，这样在失效的时候，也会给后端系统（比如 DB）带来很大压力</p>
<h5 id="解决方案-1"><a href="#解决方案-1" class="headerlink" title="解决方案"></a>解决方案</h5><ul>
<li>在缓存失效后，通过加锁或者队列来控制读数据库写缓存的线程数量。比如对某个 key 只允许一个线程查询数据和写缓存，其他线程等待</li>
<li>不同的 key，设置不同的过期时间，让缓存失效的时间点尽量均匀</li>
<li>做二级缓存，A1 为原始缓存，A2 为拷贝缓存。A1 失效时，可以访问 A2。A1 缓存失效时间设置为短期，A2 设置为长期</li>
<li>保证缓存层服务的高可用，后端组件做好限流措施，并提前预演缓存层失效的场景</li>
</ul>
<h4 id="缓存失效"><a href="#缓存失效" class="headerlink" title="缓存失效"></a>缓存失效</h4><h5 id="场景描述-2"><a href="#场景描述-2" class="headerlink" title="场景描述"></a>场景描述</h5><p>　<strong>缓存失效</strong>，是指缓存集中在一段时间内失效，DB 的压力凸显</p>
<h5 id="解决方案-2"><a href="#解决方案-2" class="headerlink" title="解决方案"></a>解决方案</h5><p>　这个没有完美解决办法，但可以分析用户行为，尽量让失效时间点均匀分布。大多数系统设计者考虑用加锁或者队列的方式保证缓存的单线程（进程）写，从而避免失效时大量的并发请求落到底层存储系统上</p>
<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><p>　当发生大量的<strong>缓存穿透</strong>，例如对某个失效的缓存的大并发访问就造成了<strong>缓存雪崩</strong></p>
<p>　<strong>缓存失效</strong>的同时发生<strong>雪崩效应</strong>，对底层系统的冲击将会非常大。这时候，可以使用双缓存机制，在工作缓存之外另外维护一层灾备缓存</p>
<h3 id="双缓存-vs-二级缓存"><a href="#双缓存-vs-二级缓存" class="headerlink" title="双缓存 vs 二级缓存"></a>双缓存 vs 二级缓存</h3><p>　一般的，用 Keepalived 做双机热备，而用 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://my.oschina.net/tinyframework/blog/538363">J2Cache</a> 来做二级缓存</p>
<p>Tips: Full code is <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/asdf2014/yuzhouwan/tree/master/yuzhouwan-bigdata/yuzhouwan-bigdata-redis/src/main/java/com/yuzhouwan/bigdata/redis/multi/cache">here</a>.</p>
<h3 id="为什么-Redis-一致性算法使用-Raft，而不是-Paxos？"><a href="#为什么-Redis-一致性算法使用-Raft，而不是-Paxos？" class="headerlink" title="为什么 Redis 一致性算法使用 Raft，而不是 Paxos？"></a>为什么 Redis 一致性算法使用 <a href="https://yuzhouwan.com/posts/31915/#Raft">Raft</a>，而不是 <a href="https://yuzhouwan.com/posts/31915/#选主机制">Paxos</a>？</h3><p>　没有应用场景上的区别，主要是因为 Raft 算法更为<strong>简单</strong>、<strong>好懂</strong> 和 <strong>易实现</strong></p>
<h4 id="协议上的简化"><a href="#协议上的简化" class="headerlink" title="协议上的简化"></a>协议上的简化</h4><p>　最后主要 RPC 只有两个，其他协议的二阶段、三阶段也都变成 看起来像是一阶段</p>
<h4 id="Term-概念的强化"><a href="#Term-概念的强化" class="headerlink" title="Term 概念的强化"></a>Term 概念的强化</h4><p>　看起来似乎 Paxos 也有重选 Leader 的机制，但是强化概念，并增加一个 Term，包含有一个 Leader、Entry 与 Term 相关的属性等都大大简化了流程</p>
<h4 id="Log-只会从-Leader-到-Follower-单向同步"><a href="#Log-只会从-Leader-到-Follower-单向同步" class="headerlink" title="Log 只会从 Leader 到 Follower 单向同步"></a>Log 只会从 Leader 到 Follower 单向同步</h4><p>　实现一下，会发现减少了很多问题，代码实现的复杂度也下降了很多</p>
<h3 id="Redis-vs-Memcached-vs-MongoDB"><a href="#Redis-vs-Memcached-vs-MongoDB" class="headerlink" title="Redis vs Memcached vs MongoDB"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://db-engines.com/en/system/Redis;Memcached;MongoDB">Redis vs Memcached vs MongoDB</a></h3><h4 id="性能"><a href="#性能" class="headerlink" title="性能"></a>性能</h4><ul>
<li>都比较高，性能对我们来说应该都不是瓶颈</li>
<li>从 TPS 的角度来看，Redis 和 Memcached 差不多，要略优于 MongoDB</li>
</ul>
<h4 id="操作的便利性"><a href="#操作的便利性" class="headerlink" title="操作的便利性"></a>操作的便利性</h4><ul>
<li>Redis<br>丰富一些，数据操作方面，Redis 更好一些，较少的网络 I/O 次数</li>
<li>Memcached<br>数据结构单一</li>
<li>MongoDB<br>支持丰富的数据表达，索引，最类似关系型数据库，支持的查询语言非常丰富</li>
</ul>
<h4 id="内存空间的大小和数据量的大小"><a href="#内存空间的大小和数据量的大小" class="headerlink" title="内存空间的大小和数据量的大小"></a>内存空间的大小和数据量的大小</h4><ul>
<li>Redis<br>在 2.0 版本后增加了自己的 VM 特性，突破物理内存的限制；可以对 <code>K-V</code> 设置过期时间（类似 Memcached）</li>
<li>Memcached<br>可以修改最大可用内存，采用 LRU 算法</li>
<li>MongoDB<br>适合大数据量的存储，依赖操作系统 VM 做内存管理，吃内存也比较厉害，服务不要和其他的放在一起</li>
</ul>
<h4 id="可用性（单点问题）"><a href="#可用性（单点问题）" class="headerlink" title="可用性（单点问题）"></a>可用性（单点问题）</h4><ul>
<li>Redis<br>依赖客户端来实现分布式读写；主从复制时，每次从节点重新连接主节点都要依赖整个快照,无增量复制，因性能和效率问题，所以单点问题比较复杂<br>不支持自动 sharding，需要依赖程序设定一致 hash 机制<br>一种替代方案是，不用Redis本身的复制机制，采用自己做主动复制（多份存储），或者改成增量复制的方式（需要自己实现），一致性问题和性能的权衡</li>
<li>Memcached<br>本身没有数据冗余机制，也没必要；对于故障预防，采用依赖成熟的 hash 或者环状的算法，解决单点故障引起的抖动问题。</li>
<li>MongoDB<br>支持 master-slave、replicaset（内部采用 Paxos 选举算法，自动故障恢复）、auto sharding 机制，对客户端屏蔽了故障转移和切分机制。</li>
</ul>
<h4 id="可靠性（持久化）"><a href="#可靠性（持久化）" class="headerlink" title="可靠性（持久化）"></a>可靠性（持久化）</h4><ul>
<li>Redis<br>对于数据持久化和数据恢复，Redis 支持（快照、AOF）：依赖快照进行持久化，AOF 增强了可靠性的同时，对性能有所影响</li>
<li>Memcached<br>不支持，通常用在做缓存，提升性能</li>
<li>MongoDB<br>从 1.8 版本开始采用 binlog 方式支持持久化的可靠性</li>
</ul>
<h4 id="数据一致性（事务支持）"><a href="#数据一致性（事务支持）" class="headerlink" title="数据一致性（事务支持）"></a>数据一致性（事务支持）</h4><ul>
<li>Redis<br>事务支持比较弱，只能保证事务中的每个操作连续执行</li>
<li>Memcached<br>在并发场景下，用 CAS 保证一致性</li>
<li>MongoDB<br>不支持事务</li>
</ul>
<h4 id="数据分析"><a href="#数据分析" class="headerlink" title="数据分析"></a>数据分析</h4><ul>
<li>MongoDB<br>内置了数据分析的功能（MapReduce），其他不支持</li>
</ul>
<h4 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h4><ul>
<li>Redis<br>数据量较小的更性能操作和运算上</li>
<li>Memcached<br>用于在动态系统中减少数据库负载，提升性能；做缓存，提高性能（适合读多写少，对于数据量比较大，可以采用 sharding）</li>
<li>MongoDB<br>主要解决海量数据的访问效率问题</li>
</ul>
<h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><h3 id="Doc"><a href="#Doc" class="headerlink" title="Doc"></a>Doc</h3><ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="http://redis.io/commands">Redis 命令集</a></li>
</ul>
<h3 id="Blog"><a href="#Blog" class="headerlink" title="Blog"></a>Blog</h3><ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="http://www.cnblogs.com/qunshu/p/3196972.html">Redis 数据类型详解，以及 Redis 适用场景场合</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="http://www.cnblogs.com/alephsoul-alephsoul/archive/2013/04/26/3044630.html">Cassandra、Mongodb、CouchDB、Redis、Riak、Membase、Neo4j、HBase 最佳应用场景</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/huangqian/note/blob/master/Redis/redis-quantitative-analysis.md">适用场景和量化分析</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/huangqian/note/blob/master/Redis/redis-datastruct-select.md">数据结构的选择</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/huangqian/note/blob/master/Redis/redis-ops-optimization.md">调优与运维</a></li>
</ul>
<h3 id="Tool"><a href="#Tool" class="headerlink" title="Tool"></a>Tool</h3><ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://redisdesktop.com/download">Redis Desktop Manager</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/sohutv/cachecloud">Redis 私有云平台</a></li>
</ul>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt></a></td>
</tr>
</tbody>
</table>
</div>

    </div>

    
    
    
      
  <div class="popular-posts-header">相关文章</div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/54206/" rel="bookmark">大数据生态圈里的一致性算法</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/31915/" rel="bookmark">ZooKeeper 原理与优化</a></div>
    </li>
  </ul>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Benedict Jin
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://yuzhouwan.com/posts/2129/" title="Redis 实战">https://yuzhouwan.com/posts/2129/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-ND</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

        

  <div class="followme">
    <p>欢迎关注我的其它发布渠道</p>

    <div class="social-list">

        <div class="social-item">
          <a target="_blank" class="social-link" href="/wechat_channel.jpg">
            <span class="icon">
              <i class="fab fa-weixin"></i>
            </span>

            <span class="label">WeChat</span>
          </a>
        </div>

        <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
        </div>
    </div>
  </div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Redis/" rel="tag"># Redis</a>
              <a href="/tags/Paxos/" rel="tag"># Paxos</a>
              <a href="/tags/Raft/" rel="tag"># Raft</a>
              <a href="/tags/Jedis/" rel="tag"># Jedis</a>
              <a href="/tags/Guava/" rel="tag"># Guava</a>
              <a href="/tags/Memcached/" rel="tag"># Memcached</a>
              <a href="/tags/MongoDB/" rel="tag"># MongoDB</a>
              <a href="/tags/%E7%BC%93%E5%AD%98/" rel="tag"># 缓存</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/posts/20644/" rel="prev" title="Apache Flink">
      <i class="fa fa-chevron-left"></i> Apache Flink
    </a></div>
      <div class="post-nav-item">
    <a href="/posts/4534/" rel="next" title="有趣的数学">
      有趣的数学 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
      <div class="tabs tabs-comment">
        <ul class="nav-tabs">
            <li class="tab"><a href="#comment-gitalk">Gitalk：可用 Github 账号登录</a></li>
            <li class="tab"><a href="#comment-disqus">Disqus：海外</a></li>
            <li class="tab"><a href="#comment-valine">Valine：匿名</a></li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane gitalk" id="comment-gitalk">
              <div class="comments" id="gitalk-container"></div>
            </div>
            <div class="tab-pane disqus" id="comment-disqus">
              
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  
            </div>
            <div class="tab-pane valine" id="comment-valine">
              <div class="comments" id="valine-comments"></div>
            </div>
        </div>
      </div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="nav-number">1.</span> <span class="nav-text">环境搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E7%8E%AF%E5%A2%83"><span class="nav-number">1.1.</span> <span class="nav-text">基础环境</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%94%A8%E6%88%B7"><span class="nav-number">1.1.1.</span> <span class="nav-text">用户</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95"><span class="nav-number">1.1.2.</span> <span class="nav-text">目录</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%9B%86%E7%BE%A4"><span class="nav-number">1.2.</span> <span class="nav-text">分布式集群</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD"><span class="nav-number">1.2.1.</span> <span class="nav-text">下载</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E5%8E%8B%E5%88%86%E5%8F%91"><span class="nav-number">1.2.2.</span> <span class="nav-text">解压分发</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E8%A3%85"><span class="nav-number">1.2.3.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE"><span class="nav-number">1.2.4.</span> <span class="nav-text">配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8"><span class="nav-number">1.2.5.</span> <span class="nav-text">启动</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE"><span class="nav-number">1.2.6.</span> <span class="nav-text">集群配置</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-Ruby"><span class="nav-number">1.2.6.1.</span> <span class="nav-text">安装 Ruby</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-Redis-%E6%8F%92%E4%BB%B6"><span class="nav-number">1.2.6.2.</span> <span class="nav-text">安装 Redis 插件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#redis-trib-%E5%88%9B%E5%BB%BA%E5%88%86%E5%B8%83%E5%BC%8F%E9%9B%86%E7%BE%A4"><span class="nav-number">1.2.6.3.</span> <span class="nav-text">redis-trib 创建分布式集群</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#redis-cli-%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81%E6%A3%80%E6%9F%A5"><span class="nav-number">1.2.6.4.</span> <span class="nav-text">redis-cli 集群状态检查</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B3%E9%97%AD"><span class="nav-number">1.2.7.</span> <span class="nav-text">关闭</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91"><span class="nav-number">1.3.</span> <span class="nav-text">遇到的坑</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#cannot-load-such-file-%E2%80%94-zlib"><span class="nav-number">1.3.1.</span> <span class="nav-text">cannot load such file — zlib</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%8F%8F%E8%BF%B0"><span class="nav-number">1.3.1.1.</span> <span class="nav-text">描述</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3"><span class="nav-number">1.3.1.2.</span> <span class="nav-text">解决</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ERR-Slot-0-is-already-busy"><span class="nav-number">1.3.2.</span> <span class="nav-text">ERR Slot 0 is already busy</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%8F%8F%E8%BF%B0-1"><span class="nav-number">1.3.2.1.</span> <span class="nav-text">描述</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3-1"><span class="nav-number">1.3.2.2.</span> <span class="nav-text">解决</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ERR-Invalid-node-address-specified"><span class="nav-number">1.3.3.</span> <span class="nav-text">ERR Invalid node address specified</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%8F%8F%E8%BF%B0-2"><span class="nav-number">1.3.3.1.</span> <span class="nav-text">描述</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3-2"><span class="nav-number">1.3.3.2.</span> <span class="nav-text">解决</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Jedis-%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-number">2.</span> <span class="nav-text">Jedis 客户端</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9E%E6%8E%A5%E9%9B%86%E7%BE%A4"><span class="nav-number">2.1.</span> <span class="nav-text">连接集群</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E6%93%8D%E4%BD%9C"><span class="nav-number">2.2.</span> <span class="nav-text">集群操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B5%84%E6%BA%90%E9%87%8A%E6%94%BE"><span class="nav-number">2.3.</span> <span class="nav-text">资源释放</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%87%E6%9C%9F%E4%BA%8B%E4%BB%B6%E5%9B%9E%E8%B0%83"><span class="nav-number">2.4.</span> <span class="nav-text">过期事件回调</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E9%9B%86%E7%BE%A4"><span class="nav-number">2.4.1.</span> <span class="nav-text">配置集群</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E9%AA%8C%E8%AF%81"><span class="nav-number">2.4.2.</span> <span class="nav-text">服务端验证</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%9E%E6%8E%A5%E9%9B%86%E7%BE%A4-1"><span class="nav-number">2.4.3.</span> <span class="nav-text">连接集群</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9B%9E%E8%B0%83%E7%9B%91%E5%90%AC%E5%99%A8"><span class="nav-number">2.4.4.</span> <span class="nav-text">回调监听器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95"><span class="nav-number">2.4.5.</span> <span class="nav-text">测试</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E6%88%98%E6%8A%80%E5%B7%A7"><span class="nav-number">3.</span> <span class="nav-text">实战技巧</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8C%B9%E9%85%8D%E5%88%A0%E9%99%A4"><span class="nav-number">3.1.</span> <span class="nav-text">匹配删除</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%AE%B9%E7%81%BE"><span class="nav-number">3.2.</span> <span class="nav-text">数据容灾</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">3.2.1.</span> <span class="nav-text">参考</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%A8%E5%B1%80%E6%B5%81%E6%8E%A7"><span class="nav-number">3.3.</span> <span class="nav-text">全局流控</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%81%E6%8E%A7%E6%96%B9%E6%A1%88"><span class="nav-number">3.3.1.</span> <span class="nav-text">流控方案</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Leaky-bucket-%E6%BC%8F%E6%A1%B6%E7%AE%97%E6%B3%95"><span class="nav-number">3.3.1.1.</span> <span class="nav-text">Leaky bucket 漏桶算法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Token-bucket-%E4%BB%A4%E7%89%8C%E6%A1%B6%E7%AE%97%E6%B3%95"><span class="nav-number">3.3.1.2.</span> <span class="nav-text">Token bucket 令牌桶算法</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F"><span class="nav-number">3.3.2.</span> <span class="nav-text">实现方式</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Guava-RateLimiter"><span class="nav-number">3.3.2.1.</span> <span class="nav-text">Guava RateLimiter</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Redis-Expire-%E6%9C%BA%E5%88%B6"><span class="nav-number">3.3.2.2.</span> <span class="nav-text">Redis Expire 机制</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Hystrix-%E9%99%90%E6%B5%81"><span class="nav-number">3.3.2.3.</span> <span class="nav-text">Hystrix 限流</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%82%E8%80%83-1"><span class="nav-number">3.3.3.</span> <span class="nav-text">参考</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95"><span class="nav-number">4.</span> <span class="nav-text">技术内幕</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F-vs-%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9-vs-%E7%BC%93%E5%AD%98%E5%A4%B1%E6%95%88"><span class="nav-number">4.1.</span> <span class="nav-text">缓存穿透 vs 缓存雪崩 vs 缓存失效</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F"><span class="nav-number">4.1.1.</span> <span class="nav-text">缓存穿透</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9C%BA%E6%99%AF%E6%8F%8F%E8%BF%B0"><span class="nav-number">4.1.1.1.</span> <span class="nav-text">场景描述</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">4.1.1.2.</span> <span class="nav-text">解决方案</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9"><span class="nav-number">4.1.2.</span> <span class="nav-text">缓存雪崩</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9C%BA%E6%99%AF%E6%8F%8F%E8%BF%B0-1"><span class="nav-number">4.1.2.1.</span> <span class="nav-text">场景描述</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-1"><span class="nav-number">4.1.2.2.</span> <span class="nav-text">解决方案</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E5%A4%B1%E6%95%88"><span class="nav-number">4.1.3.</span> <span class="nav-text">缓存失效</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9C%BA%E6%99%AF%E6%8F%8F%E8%BF%B0-2"><span class="nav-number">4.1.3.1.</span> <span class="nav-text">场景描述</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-2"><span class="nav-number">4.1.3.2.</span> <span class="nav-text">解决方案</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B6%E4%BB%96"><span class="nav-number">4.1.4.</span> <span class="nav-text">其他</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%8C%E7%BC%93%E5%AD%98-vs-%E4%BA%8C%E7%BA%A7%E7%BC%93%E5%AD%98"><span class="nav-number">4.2.</span> <span class="nav-text">双缓存 vs 二级缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88-Redis-%E4%B8%80%E8%87%B4%E6%80%A7%E7%AE%97%E6%B3%95%E4%BD%BF%E7%94%A8-Raft%EF%BC%8C%E8%80%8C%E4%B8%8D%E6%98%AF-Paxos%EF%BC%9F"><span class="nav-number">4.3.</span> <span class="nav-text">为什么 Redis 一致性算法使用 Raft，而不是 Paxos？</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8D%8F%E8%AE%AE%E4%B8%8A%E7%9A%84%E7%AE%80%E5%8C%96"><span class="nav-number">4.3.1.</span> <span class="nav-text">协议上的简化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Term-%E6%A6%82%E5%BF%B5%E7%9A%84%E5%BC%BA%E5%8C%96"><span class="nav-number">4.3.2.</span> <span class="nav-text">Term 概念的强化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Log-%E5%8F%AA%E4%BC%9A%E4%BB%8E-Leader-%E5%88%B0-Follower-%E5%8D%95%E5%90%91%E5%90%8C%E6%AD%A5"><span class="nav-number">4.3.3.</span> <span class="nav-text">Log 只会从 Leader 到 Follower 单向同步</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-vs-Memcached-vs-MongoDB"><span class="nav-number">4.4.</span> <span class="nav-text">Redis vs Memcached vs MongoDB</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%A7%E8%83%BD"><span class="nav-number">4.4.1.</span> <span class="nav-text">性能</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%93%8D%E4%BD%9C%E7%9A%84%E4%BE%BF%E5%88%A9%E6%80%A7"><span class="nav-number">4.4.2.</span> <span class="nav-text">操作的便利性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E7%A9%BA%E9%97%B4%E7%9A%84%E5%A4%A7%E5%B0%8F%E5%92%8C%E6%95%B0%E6%8D%AE%E9%87%8F%E7%9A%84%E5%A4%A7%E5%B0%8F"><span class="nav-number">4.4.3.</span> <span class="nav-text">内存空间的大小和数据量的大小</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%AF%E7%94%A8%E6%80%A7%EF%BC%88%E5%8D%95%E7%82%B9%E9%97%AE%E9%A2%98%EF%BC%89"><span class="nav-number">4.4.4.</span> <span class="nav-text">可用性（单点问题）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%AF%E9%9D%A0%E6%80%A7%EF%BC%88%E6%8C%81%E4%B9%85%E5%8C%96%EF%BC%89"><span class="nav-number">4.4.5.</span> <span class="nav-text">可靠性（持久化）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7%EF%BC%88%E4%BA%8B%E5%8A%A1%E6%94%AF%E6%8C%81%EF%BC%89"><span class="nav-number">4.4.6.</span> <span class="nav-text">数据一致性（事务支持）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90"><span class="nav-number">4.4.7.</span> <span class="nav-text">数据分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">4.4.8.</span> <span class="nav-text">应用场景</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B5%84%E6%96%99"><span class="nav-number">5.</span> <span class="nav-text">资料</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Doc"><span class="nav-number">5.1.</span> <span class="nav-text">Doc</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Blog"><span class="nav-number">5.2.</span> <span class="nav-text">Blog</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Tool"><span class="nav-number">5.3.</span> <span class="nav-text">Tool</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%AC%A2%E8%BF%8E%E5%8A%A0%E5%85%A5%E6%88%91%E4%BB%AC%E7%9A%84%E6%8A%80%E6%9C%AF%E7%BE%A4%EF%BC%8C%E4%B8%80%E8%B5%B7%E4%BA%A4%E6%B5%81%E5%AD%A6%E4%B9%A0"><span class="nav-number">6.</span> <span class="nav-text">欢迎加入我们的技术群，一起交流学习</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Benedict Jin" src="/yuzhouwan_logo_128x128.ico">
  <p class="site-author-name" itemprop="name">Benedict Jin</p>
  <div class="site-description" itemprop="description">Benedict Jin's Blog</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">54</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">147</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/asdf2014" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;asdf2014" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:asdf2014@apache.org" title="E-Mail → mailto:asdf2014@apache.org" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh" class="cc-opacity" rel="external nofollow noopener noreferrer" target="_blank"><img src="/images/cc-by-nc-nd.svg" alt="Creative Commons"></a>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        
  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="external nofollow noopener noreferrer" target="_blank">苏 ICP 备 17032505号 </a>
  </div>

<div class="copyright">
  
  &copy; 2014 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yuzhouwan.com</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">940k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">14:15</span>
</div>

        
<meta name="referrer" content="always">
<div class="busuanzi-count">
  <script async src="/lib/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




<script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.5/lib/darkmode-js.min.js"></script>
<script>
var options = {
  bottom: '32px', // default: '32px'
  right: '32px', // default: '32px'
  left: 'unset', // default: 'unset'
  time: '0.5s', // default: '0.3s'
  mixColor: '#fff', // default: '#fff'
  backgroundColor: '#fff',  // default: '#fff'
  buttonColorDark: '#100f2c',  // default: '#100f2c'
  buttonColorLight: '#fff', // default: '#fff'
  saveInCookies: true, // default: true,
  label: '🌓', // default: ''
  autoMatchOsTheme: false // default: true
}
const darkmode = new Darkmode(options);
darkmode.showWidget();
</script>
<style>
button.darkmode-toggle {
  z-index: 9999;
}
img, .darkmode-ignore {
  isolation: isolate;
  display: block;
}
</style>

  




  
<script src="/js/local-search.js"></script>











<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  

  

<script>
  var disqus_config = function() {
    this.page.url = "https://yuzhouwan.com/posts/2129/";
    this.page.identifier = "posts/2129/";
    this.page.title = "Redis 实战";
    };
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://yuzhouwan.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : 'e5da61069b94deb8ef3a',
      clientSecret: 'c60ad4e430be258b705027a036eeee3d71cb934b',
      repo        : 'gitment',
      owner       : 'asdf2014',
      admin       : ['asdf2014'],
      id          : '5549d9141dfb91ad7b1d73a90455464f',
        language: '',
      distractionFreeMode: false
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : true,
      appId      : 'BU4bnWsdAliFfk3fz7iMcFUU-gzGzoHsz',
      appKey     : '1xVLNFSy1qGCda3wt4GiGzHG',
      placeholder: "上述信息都不是必填的，可以直接提交评论",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</body>
</html>
