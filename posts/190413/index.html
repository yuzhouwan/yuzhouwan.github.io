<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/yuzhouwan_logo_with_copyright.jpg">
  <link rel="icon" type="image/png" sizes="32x32" href="/yuzhouwan_logo_32x32.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/yuzhouwan_logo_16x16.ico">
  <link rel="mask-icon" href="/yuzhouwan_logo_with_copyright.jpg" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yuzhouwan.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":5,"onmobile":true},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":true,"nav":{"valine":{"text":"Valine：匿名","order":-1},"disqus":{"text":"Disqus：海外","order":-2},"gitalk":{"text":"Gitalk：可用 Github 账号登录","order":-3}}},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="关于本文　虽然接触 Java 已经 8 年之久，可惜学习之初的笔记文档没能很好地保存下来。本文是近几年工作学习中遇到的一些零散的知识点，包括了 基础概念、实用的编程技巧、代码可读性、设计模式、性能优化（工具 &amp; 编码）、测试相关、JVM 相关、常用的工具和常见问题。本着好记性不如烂笔头的初衷，在不断地踩坑和爬坑的过程中，慢慢地记录成文。期待着本文能起到抛砖引玉的作用，以看到大家的真知灼见。">
<meta property="og:type" content="article">
<meta property="og:title" content="那些绕不过去的 Java 知识点">
<meta property="og:url" content="https://yuzhouwan.com/posts/190413/">
<meta property="og:site_name" content="宇宙湾">
<meta property="og:description" content="关于本文　虽然接触 Java 已经 8 年之久，可惜学习之初的笔记文档没能很好地保存下来。本文是近几年工作学习中遇到的一些零散的知识点，包括了 基础概念、实用的编程技巧、代码可读性、设计模式、性能优化（工具 &amp; 编码）、测试相关、JVM 相关、常用的工具和常见问题。本着好记性不如烂笔头的初衷，在不断地踩坑和爬坑的过程中，慢慢地记录成文。期待着本文能起到抛砖引玉的作用，以看到大家的真知灼见。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://yuzhouwan.com/picture/java/java_random_sequential_throughput.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/java/java_random_parallel_stream_throughput.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/java/java_limit_tps_with_string.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/java/java_http_runner_suit.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/java/java_http_runner_report.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/java/java_http_runner_super_user.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/java/java_jvm_jmc_java_mission_control.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/java/java_jvm_gcviewer_throughput_100_percent.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/java/java_intellij_2018_3_coming_in.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/java/java_idea_profiler_enabled.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/java/java_run_with_async_profiler.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/java/java_jvm_profiler.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/java/java_arthas_logo.png">
<meta property="og:image" content="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg">
<meta property="og:image" content="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg">
<meta property="og:image" content="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg">
<meta property="og:image" content="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg">
<meta property="article:published_time" content="2019-04-13T07:54:52.000Z">
<meta property="article:modified_time" content="2020-12-30T15:38:26.984Z">
<meta property="article:author" content="Benedict Jin">
<meta property="article:tag" content="Maven">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="JVM">
<meta property="article:tag" content="SPI">
<meta property="article:tag" content="HttpRunner">
<meta property="article:tag" content="JMC">
<meta property="article:tag" content="MAT">
<meta property="article:tag" content="Arthas">
<meta property="article:tag" content="Jersey">
<meta property="article:tag" content="LogBack">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://yuzhouwan.com/picture/java/java_random_sequential_throughput.png">

<link rel="canonical" href="https://yuzhouwan.com/posts/190413/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>那些绕不过去的 Java 知识点 | 宇宙湾</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-97020848-1"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-97020848-1');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>


<style>.null { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .null > span { position: relative; z-index: 10; }  .null img, .null .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .null img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .null-fallback { color: inherit; } .null-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="宇宙湾" type="application/atom+xml"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">宇宙湾</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">厚积薄发</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">147</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">15</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">54</span></a>

  </li>
        <li class="menu-item menu-item-书单">

    <a href="/books/" rel="section"><i class="fa fa-book fa-fw"></i>书单</a>

  </li>
        <li class="menu-item menu-item-影视">

    <a href="/movies/" rel="section"><i class="fa fa-film fa-fw"></i>影视</a>

  </li>
        <li class="menu-item menu-item-友链">

    <a href="/links/" rel="section"><i class="fa fa-link fa-fw"></i>友链</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yuzhouwan.com/posts/190413/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/yuzhouwan_logo_128x128.ico">
      <meta itemprop="name" content="Benedict Jin">
      <meta itemprop="description" content="Benedict Jin's Blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宇宙湾">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          那些绕不过去的 Java 知识点
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-04-13 15:54:52" itemprop="dateCreated datePublished" datetime="2019-04-13T15:54:52+08:00">2019-04-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-12-30 23:38:26" itemprop="dateModified" datetime="2020-12-30T23:38:26+08:00">2020-12-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AF%AD%E8%A8%80/" itemprop="url" rel="index"><span itemprop="name">语言</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>54k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>50 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="关于本文"><a href="#关于本文" class="headerlink" title="关于本文"></a>关于本文</h2><p>　虽然接触 Java 已经 8 年之久，可惜学习之初的笔记文档没能很好地保存下来。本文是近几年工作学习中遇到的一些零散的知识点，包括了 基础概念、实用的编程技巧、代码可读性、设计模式、性能优化（工具 &amp; 编码）、测试相关、JVM 相关、常用的工具和常见问题。本着好记性不如烂笔头的初衷，在不断地踩坑和爬坑的过程中，慢慢地记录成文。期待着本文能起到抛砖引玉的作用，以看到大家的真知灼见。</p>
<h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><h3 id="注解"><a href="#注解" class="headerlink" title="注解"></a>注解</h3><h4 id="GuardedBy"><a href="#GuardedBy" class="headerlink" title="GuardedBy"></a>GuardedBy</h4><p>　<code>@GuardedBy</code> 注解可以作用于某一个属性或者方法，约定在访问这些被注解标记的资源时，能被同步代码块保护着。简单的使用案例如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GuardedBy("obj")</span></span><br><span class="line"><span class="keyword">private</span> ConcurrentMap&lt;String, String&gt; map = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Object obj = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(String k, String v)</span> </span>{</span><br><span class="line">    <span class="keyword">synchronized</span> (obj) {</span><br><span class="line">        map.put(k, v);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * If you use `error prone` tool to check this, this annotation should be `<span class="doctag">@SuppressWarnings</span>("GuardedBy")`</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@see</span> https://errorprone.info/bugpattern/GuardedBy}</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@see</span> https://github.com/apache/druid/pull/6868#discussion_r249639199}</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressWarnings("FieldAccessNotGuarded")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(String k)</span> </span>{</span><br><span class="line">    map.remove(k);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">synchronized</span> (obj) {</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"GuardedByExample{"</span> +</span><br><span class="line">                <span class="string">"map="</span> + map +</span><br><span class="line">                <span class="string">'}'</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>Tips: <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/apache/druid/pull/6903">Code Example</a> from <a href="https://yuzhouwan.com/posts/5845/">Apache Druid</a>；另外，<strong>error-prone</strong> 工具支持对<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/google/error-prone/blob/master/docs/bugpattern/GuardedBy.md#guardedby">多种版本</a>的 <code>@GuardedBy</code> 进行检查</p>
<span id="more"></span>
<h4 id="InterfaceStability"><a href="#InterfaceStability" class="headerlink" title="InterfaceStability"></a>InterfaceStability</h4><ul>
<li><p>@InterfaceStability.Stable<br>主版本是稳定的，不同主版本间，可能不兼容</p>
</li>
<li><p>@InterfaceStability.Evolving<br>不断变化中，不同的次版本间，可能不兼容</p>
</li>
<li><p>@InterfaceStability.Unstable<br>不对可靠性和健壮性做任何保证</p>
</li>
</ul>
<h4 id="InterfaceAudience"><a href="#InterfaceAudience" class="headerlink" title="InterfaceAudience"></a>InterfaceAudience</h4><ul>
<li><p>@InterfaceAudience.Public<br>对所有工程可用</p>
</li>
<li><p>@InterfaceAudience.LimitedPrivate<br>仅限特定的工程，如 <a href="https://yuzhouwan.com/posts/45888/">HBase</a>、<a href="https://yuzhouwan.com/posts/31915/">ZooKeeper</a>、<a href="https://yuzhouwan.com/posts/60504/">HDFS</a> 等（以 Hadoop 为例）</p>
</li>
<li><p>@InterfaceAudience.Private<br>仅限于工程内部使用</p>
</li>
</ul>
<h4 id="JsonIgnoreProperties"><a href="#JsonIgnoreProperties" class="headerlink" title="JsonIgnoreProperties"></a>JsonIgnoreProperties</h4><p>　通过增加 Class 级别的 <code>@JsonIgnoreProperties(ignoreUnknown = true)</code> 注解，可以避免在解析不支持的字段时抛出 UnrecognizedPropertyException 异常</p>
<h3 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h3><h4 id="transient"><a href="#transient" class="headerlink" title="transient"></a>transient</h4><p>　给实现了 <code>Serializable</code> 接口的类中的字段，增加 <code>transient</code> 修饰符，则可以让该字段跳过序列化的过程</p>
<p>Tips: Full code is <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-hacker/src/test/java/com/yuzhouwan/hacker/javaProhibited/serializable/bean/Country.java">here</a> and <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-hacker/src/test/java/com/yuzhouwan/hacker/javaProhibited/serializable/SerializableTest.java#L45">here</a>.</p>
<h4 id="类中包含没有实现-Serializable-接口的字段"><a href="#类中包含没有实现-Serializable-接口的字段" class="headerlink" title="类中包含没有实现 Serializable 接口的字段"></a>类中包含没有实现 Serializable 接口的字段</h4><p>　需要自己实现 <code>serialize</code> 和 <code>deserialize</code> 方法</p>
<p>Tips: Full code is <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-hacker/src/test/java/com/yuzhouwan/hacker/javaProhibited/serializable/converter/SerializationConverter.java">here</a> and <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-hacker/src/test/java/com/yuzhouwan/hacker/javaProhibited/serializable/SerializableTest.java#L27">here</a>.</p>
<h2 id="实用技巧"><a href="#实用技巧" class="headerlink" title="实用技巧"></a>实用技巧</h2><h3 id="Collection-内元素类型转换"><a href="#Collection-内元素类型转换" class="headerlink" title="Collection 内元素类型转换"></a>Collection 内元素类型转换</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 对集合里面的元素类型进行转换（A -&gt; B）</span></span><br><span class="line">List&lt;B&gt; variable = (List&lt;B&gt;)(List&lt;?&gt;) collectionOfListA;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="集合的差集、交集、并集"><a href="#集合的差集、交集、并集" class="headerlink" title="集合的差集、交集、并集"></a>集合的差集、交集、并集</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用 Guava 中封装的 Sets 类</span></span><br><span class="line"><span class="keyword">import</span> com.google.common.collect.Sets;</span><br><span class="line"></span><br><span class="line">Sets.difference(set1, set2)</span><br><span class="line">Sets.intersection(set1, set2)</span><br><span class="line">Sets.union(set1, set2)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="数组转为-Set"><a href="#数组转为-Set" class="headerlink" title="数组转为 Set"></a>数组转为 Set</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JDK8</span></span><br><span class="line"><span class="keyword">new</span> HashSet&lt;&gt;(Arrays.asList(str.trim().split(<span class="string">","</span>)))</span><br><span class="line"><span class="comment">// JDK9+</span></span><br><span class="line">Set.of(str.trim().split(<span class="string">","</span>));</span><br></pre></td></tr></tbody></table></figure>
<h3 id="TransmittableThreadLocal-解决跨父子线程和线程池缓存问题"><a href="#TransmittableThreadLocal-解决跨父子线程和线程池缓存问题" class="headerlink" title="TransmittableThreadLocal 解决跨父子线程和线程池缓存问题"></a>TransmittableThreadLocal 解决跨父子线程和线程池缓存问题</h3><h4 id="编码"><a href="#编码" class="headerlink" title="编码"></a>编码</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">String tlMsg = <span class="string">"tl"</span>;</span><br><span class="line">String ttlMsg = <span class="string">"ttl"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> ThreadLocal&lt;String&gt; tl = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</span><br><span class="line">tl.set(tlMsg);</span><br><span class="line"><span class="keyword">final</span> TransmittableThreadLocal&lt;String&gt; ttl = <span class="keyword">new</span> TransmittableThreadLocal&lt;&gt;();</span><br><span class="line">ttl.set(ttlMsg);</span><br><span class="line"></span><br><span class="line">assertEquals(tl.get(), tlMsg);</span><br><span class="line">assertEquals(ttl.get(), ttlMsg);</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Thread(() -&gt; {</span><br><span class="line">    assertNull(tl.get());</span><br><span class="line">    assertEquals(ttl.get(), ttlMsg);</span><br><span class="line">}).start();</span><br></pre></td></tr></tbody></table></figure>
<p>Tips: Full code is <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-hacker/src/test/java/com/yuzhouwan/hacker/algorithms/thread/ttl/TransmittableThreadLocalTest.java">here</a>.</p>
<h3 id="计算中位数"><a href="#计算中位数" class="headerlink" title="计算中位数"></a>计算中位数</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> COUNT;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> PriorityQueue&lt;Double&gt; MAX = <span class="keyword">new</span> PriorityQueue&lt;&gt;(Collections.reverseOrder());</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> PriorityQueue&lt;Double&gt; MIN = <span class="keyword">new</span> PriorityQueue&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">    add(<span class="number">1D</span>);</span><br><span class="line">    add(<span class="number">2D</span>);</span><br><span class="line">    add(<span class="number">3D</span>);</span><br><span class="line">    add(<span class="number">4D</span>);</span><br><span class="line">    add(<span class="number">4D</span>);</span><br><span class="line">    <span class="comment">// 3.0</span></span><br><span class="line">    System.out.println(median());</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">double</span> v)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (!Double.isNaN(v)) {</span><br><span class="line">        <span class="keyword">if</span> (COUNT % <span class="number">2</span> == <span class="number">0</span>) {</span><br><span class="line">            MIN.add(v);</span><br><span class="line">            MAX.add(MIN.peek());</span><br><span class="line">            MIN.poll();</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            MAX.add(v);</span><br><span class="line">            MIN.add(MAX.peek());</span><br><span class="line">            MAX.poll();</span><br><span class="line">        }</span><br><span class="line">        COUNT++;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings("ConstantConditions")</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">double</span> <span class="title">median</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (COUNT == <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">return</span> Double.NaN;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (COUNT % <span class="number">2</span> == <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">return</span> (MAX.peek() + MIN.peek()) / <span class="number">2.0</span>;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">return</span> MAX.peek();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Shutdown-Hook"><a href="#Shutdown-Hook" class="headerlink" title="Shutdown Hook"></a>Shutdown Hook</h3><h4 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h4><p>　进程异常退出时，可能 <code>try-finally</code> 也无法保证可以及时释放类似数据库连接资源或清理临时文件，使用 Shutdown Hook 则可以避免该问题。不过也有可能存在无法触发 Shutdown Hook 的情况，例如执行 <code>kill -9</code> 退出进程等，但绝大部分的情况下，都能成功触发，具体如下：</p>
<ul>
<li>程序正常退出</li>
<li>使用 <code>System.exit()</code></li>
<li><code>OutOfMemory</code> 宕机</li>
<li>终端 <code>Ctrl+C</code> 触发的中断</li>
<li>使用 <code>kill pid</code> 命令退出进程</li>
</ul>
<h4 id="编码-1"><a href="#编码-1" class="headerlink" title="编码"></a>编码</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(<span class="string">"registering"</span>);</span><br><span class="line">Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> Thread(() -&gt; System.out.println(<span class="string">"shutdown1..."</span>)));</span><br><span class="line">Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> Thread(() -&gt; System.out.println(<span class="string">"shutdown2..."</span>)));</span><br><span class="line">Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> Thread(() -&gt; System.out.println(<span class="string">"shutdown3..."</span>)));</span><br><span class="line">System.out.println(<span class="string">"registered"</span>);</span><br><span class="line">System.out.println(<span class="string">"exit"</span>);</span><br><span class="line">System.exit(<span class="number">0</span>);</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">registering</span><br><span class="line">registered</span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">shutdown2...</span><br><span class="line">shutdown3...</span><br><span class="line">shutdown1...</span><br></pre></td></tr></tbody></table></figure>
<div class="note info">这里需要注意的是，注册的多个 Shutdown Hook 由各自不同的线程执行完成，是无法保证执行的先后顺序的</div>

<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://stefanbirkner.github.io/system-rules/">测试</a></h4><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.stefanbirkner<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>system-rules<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.Rule;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.contrib.java.lang.system.ExpectedSystemExit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShutdownHookTest</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Rule</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> ExpectedSystemExit exit = ExpectedSystemExit.none();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test_shutdown_hook</span><span class="params">()</span> </span>{</span><br><span class="line">        Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> Thread(() -&gt; System.out.println(<span class="string">"shutdown..."</span>)));</span><br><span class="line"></span><br><span class="line">        exit.expectSystemExit();</span><br><span class="line">        System.exit(<span class="number">0</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<div class="note success">使用 ExpectedSystemExit 可以避免执行 System.exit 后所有测试用例都被终止的问题</div>



<h3 id="SPI-解耦"><a href="#SPI-解耦" class="headerlink" title="SPI 解耦"></a>SPI 解耦</h3><h4 id="定义"><a href="#定义" class="headerlink" title="定义"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.oracle.com/en/java/javase/13/docs/api/java.base/java/util/ServiceLoader.html">定义</a></h4><blockquote>
<p>A service is a well-known interface or class for which zero, one, or many service providers exist. A service provider (or just provider) is a class that implements or subclasses the well-known interface or class. A ServiceLoader is an object that locates and loads service providers deployed in the run time environment at a time of an application´s choosing. Application code refers only to the service, not to service providers, and is assumed to be capable of choosing between multiple service providers (based on the functionality they expose through the service), and handling the possibility that no service providers are located.</p>
</blockquote>
<h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/asdf2014/yuzhouwan/tree/master/yuzhouwan-hacker/src/main/java/com/yuzhouwan/hacker/spi">示例</a></h4><ul>
<li>定义 SPI 接口</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IStore</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">record</span><span class="params">(String data)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>实现 SPI 接口</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ESStore</span> <span class="keyword">implements</span> <span class="title">IStore</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">record</span><span class="params">(String data)</span> </span>{</span><br><span class="line">        System.err.println(<span class="string">"Recording "</span> + data + <span class="string">" to ES ..."</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HBaseStore</span> <span class="keyword">implements</span> <span class="title">IStore</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">record</span><span class="params">(String data)</span> </span>{</span><br><span class="line">        System.err.println(<span class="string">"Recording "</span> + data + <span class="string">" to HBase ..."</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>配置子类的全限定名</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim src/main/resources/META-INF/services/com.yuzhouwan.hacker.spi.IStore</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">com.yuzhouwan.hacker.spi.ESStore</span><br><span class="line">com.yuzhouwan.hacker.spi.HBaseStore</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>通过 ServiceLoader.load 加载 SPI 接口的实现</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (IStore store : ServiceLoader.load(IStore.class)) {</span><br><span class="line">    System.err.println(<span class="string">"Loaded "</span> + store.getClass().getSimpleName());</span><br><span class="line">    store.record(<span class="string">"yuzhouwan.com"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Loaded ESStore</span><br><span class="line">Recording yuzhouwan.com to ES ...</span><br><span class="line">Loaded HBaseStore</span><br><span class="line">Recording yuzhouwan.com to HBase ...</span><br></pre></td></tr></tbody></table></figure>
<h4 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h4><ul>
<li>解耦</li>
<li>插件化</li>
<li>通过 <code>stream()</code> 遍历可以实现懒加载，避免一次性加载所有的实现（JDK9+）</li>
</ul>
<h3 id="避免使用-Properties-的-put-和-putAll-方法"><a href="#避免使用-Properties-的-put-和-putAll-方法" class="headerlink" title="避免使用 Properties 的 put 和 putAll 方法"></a>避免使用 Properties 的 put 和 putAll 方法</h3><p>　因为 <code>Properties</code> 继承于 <code>Hashtable</code>，所以可以调用父类 <code>Hashtable</code> 的 <code>put</code> 和 <code>putAll</code> 方法。但是并不建议这样用，而是希望使用 <code>setProperty</code> 方法。因为 <code>setProperty</code> 方法限制了 Key 和 Value 的数据类型为 <code>String</code>，而 <code>put</code> 和 <code>putAll</code> 方法却不会。虽然，<code>put</code> 写入和 <code>get</code> 读取非 <code>String</code> 的数据是没问题的，但是在 <code>store</code> 和 <code>save</code> 调用的时候却会出错，抛出 <code>ClassCastException</code> 异常。例如：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Properties p = <span class="keyword">new</span> Properties();</span><br><span class="line">p.put(<span class="number">1</span>, <span class="string">"yuzhouwan"</span>);</span><br><span class="line">p.store(System.out, <span class="string">""</span>);</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread <span class="string">"main"</span> java.lang.ClassCastException: java.lang.Integer cannot be cast to java.lang.String</span><br><span class="line">  at java.util.Properties.store0(Properties.java:<span class="number">833</span>)</span><br><span class="line">  at java.util.Properties.store(Properties.java:<span class="number">818</span>)</span><br></pre></td></tr></tbody></table></figure>
<h2 id="可读性"><a href="#可读性" class="headerlink" title="可读性"></a>可读性</h2><h3 id="魔法数字"><a href="#魔法数字" class="headerlink" title="魔法数字"></a>魔法数字</h3><p>　编码过程中，应该避免出现没有声明含义的纯数字</p>
<h4 id="反面示例"><a href="#反面示例" class="headerlink" title="反面示例"></a>反面示例</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.kafka.connect.runtime.distributed.DistributedHerder#stop</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>{</span><br><span class="line">  <span class="keyword">if</span> (!forwardRequestExecutor.awaitTermination(<span class="number">10000L</span>, TimeUnit.MILLISECONDS))</span><br><span class="line">    forwardRequestExecutor.shutdownNow();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="正面示例"><a href="#正面示例" class="headerlink" title="正面示例"></a>正面示例</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里除了需要将 10000L 抽象成 FORWARD_REQUEST_SHUTDOWN_TIMEOUT_MS 静态变量</span></span><br><span class="line"><span class="comment">// 还可以进一步使用 10_000L 方便阅读</span></span><br><span class="line"><span class="comment">// 因为这里和时间有关，更进一步，可以使用 TimeUnit.SECONDS.toMillis(10) 来代替纯数字</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> FORWARD_REQUEST_SHUTDOWN_TIMEOUT_MS = TimeUnit.SECONDS.toMillis(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>{</span><br><span class="line">  <span class="keyword">if</span> (!forwardRequestExecutor.awaitTermination(FORWARD_REQUEST_SHUTDOWN_TIMEOUT_MS, TimeUnit.MILLISECONDS))</span><br><span class="line">    forwardRequestExecutor.shutdownNow();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>Tips: Full code is <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/apache/kafka/pull/4799/files">here</a> and <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/apache/druid/pull/6158/files">here</a>.</p>
<h3 id="字符串判空"><a href="#字符串判空" class="headerlink" title="字符串判空"></a>字符串判空</h3><h4 id="反面示例-1"><a href="#反面示例-1" class="headerlink" title="反面示例"></a>反面示例</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.kafka.connect.runtime.distributed.DistributedHerder#reconfigureConnector</span></span><br><span class="line">leaderUrl.equals(<span class="string">""</span>)</span><br></pre></td></tr></tbody></table></figure>
<h4 id="正面示例-1"><a href="#正面示例-1" class="headerlink" title="正面示例"></a>正面示例</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 一方面，需要考虑不能将对象放在 equals 方法之前，避免空指针异常</span></span><br><span class="line"><span class="comment">// 另一方面，使用 `str.length() == 0` 的方式，效率会高一些</span></span><br><span class="line"><span class="comment">// 进一步，使用 isEmpty() 方法，则可以使得代码更加可读</span></span><br><span class="line">leaderUrl == <span class="keyword">null</span> || leaderUrl.trim().isEmpty()</span><br></pre></td></tr></tbody></table></figure>
<p>Tips: Full code is <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/apache/kafka/pull/4798/files">here</a>.</p>
<h3 id="箭头型代码"><a href="#箭头型代码" class="headerlink" title="箭头型代码"></a>箭头型代码</h3><h4 id="反面示例-2"><a href="#反面示例-2" class="headerlink" title="反面示例"></a>反面示例</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public void m(String s) {</span><br><span class="line">    <span class="keyword">if</span> (s != null) {</span><br><span class="line">        <span class="keyword">if</span> (s.trim().length() &gt; 0) {</span><br><span class="line">            <span class="keyword">if</span> (s.contains(<span class="string">"yuzhouwan"</span>)) {</span><br><span class="line">                System.out.println(<span class="string">"https://yuzhouwan.com"</span>);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="正面示例-2"><a href="#正面示例-2" class="headerlink" title="正面示例"></a>正面示例</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">m</span><span class="params">(String s)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (s == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (s.trim().length() == <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (!s.contains(<span class="string">"yuzhouwan"</span>)) {</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    System.out.println(<span class="string">"https://yuzhouwan.com"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="函数式编程"><a href="#函数式编程" class="headerlink" title="函数式编程"></a>函数式编程</h3><h4 id="Optional"><a href="#Optional" class="headerlink" title="Optional"></a>Optional</h4><h5 id="反面示例-3"><a href="#反面示例-3" class="headerlink" title="反面示例"></a>反面示例</h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Long <span class="title">deserialize</span><span class="params">(ByteArrayDataInput in)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> isNullByteSet(in) ? <span class="keyword">null</span> : in.readLong();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h5 id="正面示例-3"><a href="#正面示例-3" class="headerlink" title="正面示例"></a>正面示例</h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> Optional.ofNullable(in)</span><br><span class="line">               .filter(InputRowSerde::isNotNullByteSet)</span><br><span class="line">               .map(ByteArrayDataInput::readLong)</span><br><span class="line">               .get();</span><br></pre></td></tr></tbody></table></figure>
<h4 id="anyMatch"><a href="#anyMatch" class="headerlink" title="anyMatch"></a>anyMatch</h4><h5 id="反面示例-4"><a href="#反面示例-4" class="headerlink" title="反面示例"></a>反面示例</h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isTaskPending</span><span class="params">(Task task)</span> </span>{</span><br><span class="line">    <span class="keyword">for</span> (TaskRunnerWorkItem workItem : taskRunner.getPendingTasks()) {</span><br><span class="line">        <span class="keyword">if</span> (workItem.getTaskId().equals(task.getId())) {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h5 id="正面示例-4"><a href="#正面示例-4" class="headerlink" title="正面示例"></a>正面示例</h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> String taskId = task.getId();</span><br><span class="line"><span class="keyword">return</span> taskRunner.getPendingTasks()</span><br><span class="line">                 .stream()</span><br><span class="line">                 .anyMatch(t -&gt; taskId.equals(t.getTaskId()));</span><br></pre></td></tr></tbody></table></figure>
<h4 id="list-去重统计"><a href="#list-去重统计" class="headerlink" title="list 去重统计"></a>list 去重统计</h4><h5 id="反面示例-5"><a href="#反面示例-5" class="headerlink" title="反面示例"></a>反面示例</h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">5</span>);</span><br><span class="line">list.add(<span class="string">"a"</span>);</span><br><span class="line">list.add(<span class="string">"a"</span>);</span><br><span class="line">list.add(<span class="string">"a"</span>);</span><br><span class="line">list.add(<span class="string">"b"</span>);</span><br><span class="line">list.add(<span class="string">"c"</span>);</span><br><span class="line"><span class="keyword">final</span> Map&lt;String, Integer&gt; res = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span> (String s : list) {</span><br><span class="line">    <span class="keyword">if</span> (res.containsKey(s)) {</span><br><span class="line">        res.put(s, res.get(s) + <span class="number">1</span>);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        res.put(s, <span class="number">1</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="comment">// {"a":3,"b":1,"c":1}</span></span><br><span class="line">System.out.println(JSON.toJSONString(res));</span><br></pre></td></tr></tbody></table></figure>
<h5 id="正面示例-5"><a href="#正面示例-5" class="headerlink" title="正面示例"></a>正面示例</h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">5</span>);</span><br><span class="line">list.add(<span class="string">"a"</span>);</span><br><span class="line">list.add(<span class="string">"a"</span>);</span><br><span class="line">list.add(<span class="string">"a"</span>);</span><br><span class="line">list.add(<span class="string">"b"</span>);</span><br><span class="line">list.add(<span class="string">"c"</span>);</span><br><span class="line"><span class="keyword">final</span> Map&lt;String, Integer&gt; res = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">list.forEach(s -&gt; res.compute(s, (k, v) -&gt; (v == <span class="keyword">null</span>) ? <span class="number">1</span> : ++v));</span><br><span class="line"><span class="comment">// {"a":3,"b":1,"c":1}</span></span><br><span class="line">System.out.println(JSON.toJSONString(res));</span><br></pre></td></tr></tbody></table></figure>
<h4 id="嵌套-list-遍历求和"><a href="#嵌套-list-遍历求和" class="headerlink" title="嵌套 list 遍历求和"></a>嵌套 list 遍历求和</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">List&lt;List&lt;Integer&gt;&gt; l = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">List&lt;Integer&gt; l0 = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">l0.add(<span class="number">1</span>);</span><br><span class="line">l0.add(<span class="number">2</span>);</span><br><span class="line">l.add(l0);</span><br><span class="line">l.add(Collections.singletonList(<span class="number">3</span>));</span><br><span class="line"><span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (List&lt;Integer&gt; ints : l) {</span><br><span class="line">    <span class="keyword">for</span> (Integer i : ints) {</span><br><span class="line">        sum += i;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">Assert.assertEquals(<span class="number">6</span>, sum);</span><br></pre></td></tr></tbody></table></figure>
<h5 id="正面示例-6"><a href="#正面示例-6" class="headerlink" title="正面示例"></a>正面示例</h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">List&lt;List&lt;Integer&gt;&gt; l = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">List&lt;Integer&gt; l0 = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">l0.add(<span class="number">1</span>);</span><br><span class="line">l0.add(<span class="number">2</span>);</span><br><span class="line">l.add(l0);</span><br><span class="line">l.add(Collections.singletonList(<span class="number">3</span>));</span><br><span class="line"><span class="keyword">int</span> sum = l.stream()</span><br><span class="line">        .flatMap(Collection::stream)</span><br><span class="line">        .mapToInt(Integer::intValue)</span><br><span class="line">        .sum();</span><br><span class="line">Assert.assertEquals(<span class="number">6</span>, sum);</span><br></pre></td></tr></tbody></table></figure>
<h2 id="设计模式"><a href="#设计模式" class="headerlink" title="设计模式"></a>设计模式</h2><h3 id="单一功能原则"><a href="#单一功能原则" class="headerlink" title="单一功能原则"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://zh.wikipedia.org/wiki/%E5%8D%95%E4%B8%80%E5%8A%9F%E8%83%BD%E5%8E%9F%E5%88%99">单一功能原则</a></h3><p>　在面向对象编程领域中，<strong>单一功能原则</strong>（<strong>S</strong>ingle <strong>r</strong>esponsibility <strong>p</strong>rinciple，<strong>SRP</strong>）规定每个类都应该有一个单一的功能，并且该功能应该由这个类完全封装起来。所有它的（这个类的）服务都应该严密的和该功能平行（功能平行，意味着没有依赖）</p>
<h3 id="开闭原则"><a href="#开闭原则" class="headerlink" title="开闭原则"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://zh.wikipedia.org/wiki/%E5%BC%80%E9%97%AD%E5%8E%9F%E5%88%99">开闭原则</a></h3><p>　在面向对象编程领域中，<strong>开闭原则</strong>（<strong>O</strong>pen-<strong>c</strong>losed <strong>p</strong>rinciple，<strong>OCP</strong>）规定“软件中的对象（类，模块，函数等等）应该对于扩展是开放的，但是对于修改是封闭的”，这意味着一个实体是允许在不改变它的源代码的前提下变更它的行为</p>
<h3 id="里氏替换原则"><a href="#里氏替换原则" class="headerlink" title="里氏替换原则"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://zh.wikipedia.org/wiki/%E9%87%8C%E6%B0%8F%E6%9B%BF%E6%8D%A2%E5%8E%9F%E5%88%99">里氏替换原则</a></h3><p>　<strong>里氏替换原则</strong>（<strong>L</strong>iskov <strong>s</strong>ubstitution <strong>p</strong>rinciple，<strong>LSP</strong>）强调的是 面向对象程序设计中的 <strong>可替代性</strong>，说明在计算机程序中，如果 S 是 T 的子类型，那么类型 T 的对象可以用类型 S 的对象替换（即 T 类型的对象可以被任何子类型 S 的对象替换），而不改变程序的任何期望属性（正确地执行的任务等）</p>
<h3 id="接口隔离原则"><a href="#接口隔离原则" class="headerlink" title="接口隔离原则"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://zh.wikipedia.org/wiki/%E6%8E%A5%E5%8F%A3%E9%9A%94%E7%A6%BB%E5%8E%9F%E5%88%99">接口隔离原则</a></h3><p>　<strong>接口隔离原则</strong>（<strong>I</strong>nterface-<strong>s</strong>egregation <strong>p</strong>rinciples，<strong>ISP</strong>）指明客户（client）应该不依赖于它不使用的方法。接口隔离原则拆分非常庞大臃肿的接口，成为更小的和更具体的接口，这样客户将只需要知道他们感兴趣的方法。这种缩小的接口也被称为角色接口（Role interfaces）。接口隔离原则的目的是系统解开耦合，从而容易重构，更改和重新部署</p>
<h3 id="依赖反转原则"><a href="#依赖反转原则" class="headerlink" title="依赖反转原则"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://zh.wikipedia.org/wiki/%E4%BE%9D%E8%B5%96%E5%8F%8D%E8%BD%AC%E5%8E%9F%E5%88%99">依赖反转原则</a></h3><p>　在面向对象编程领域中，<strong>依赖反转原则</strong>（<strong>D</strong>ependency <strong>i</strong>nversion <strong>p</strong>rinciple，<strong>DIP</strong>）是指一种特定的解耦（传统的依赖关系创建在高层次上，而具体的策略设置则应用在低层次的模块上）形式，使得高层次的模块不依赖于低层次的模块的实现细节，依赖关系被颠倒（反转），从而使得低层次模块依赖于高层次模块的需求抽象。 该原则规定：</p>
<ul>
<li>高层次的模块不应该依赖于低层次的模块，两者都应该依赖于抽象接口</li>
<li>抽象接口不应该依赖于具体实现。而具体实现则应该依赖于抽象接口</li>
</ul>
<div class="note success">五大原则的速记：SOLID</div>





<h2 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h2><h3 id="工具层面"><a href="#工具层面" class="headerlink" title="工具层面"></a>工具层面</h3><h4 id="性能指标监控"><a href="#性能指标监控" class="headerlink" title="性能指标监控"></a>性能指标监控</h4><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">metrics.version</span>&gt;</span>3.2.0<span class="tag">&lt;/<span class="name">metrics.version</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.dropwizard.metrics<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>metrics-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>${metrics.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="JMH-基准测试"><a href="#JMH-基准测试" class="headerlink" title="JMH 基准测试"></a>JMH 基准测试</h4><h5 id="增加-Maven-依赖"><a href="#增加-Maven-依赖" class="headerlink" title="增加 Maven 依赖"></a>增加 <a href="https://yuzhouwan.com/posts/2254/">Maven</a> 依赖</h5><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">jmh.version</span>&gt;</span>1.19<span class="tag">&lt;/<span class="name">jmh.version</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- JMH --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.openjdk.jmh<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jmh-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>${jmh.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.openjdk.jmh<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jmh-generator-annprocess<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>${jmh.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="编写-JMH-测试案例"><a href="#编写-JMH-测试案例" class="headerlink" title="编写 JMH 测试案例"></a>编写 JMH 测试案例</h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.openjdk.jmh.annotations.*;</span><br><span class="line"><span class="keyword">import</span> org.openjdk.jmh.runner.Runner;</span><br><span class="line"><span class="keyword">import</span> org.openjdk.jmh.runner.RunnerException;</span><br><span class="line"><span class="keyword">import</span> org.openjdk.jmh.runner.options.Options;</span><br><span class="line"><span class="keyword">import</span> org.openjdk.jmh.runner.options.OptionsBuilder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="meta">@BenchmarkMode(Mode.Throughput)</span></span><br><span class="line"><span class="meta">@OutputTimeUnit(TimeUnit.MILLISECONDS)</span></span><br><span class="line"><span class="meta">@State(Scope.Thread)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BenchmarkSimple</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Benchmark</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bench</span><span class="params">()</span> </span>{</span><br><span class="line">        add(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> a + b;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Benchmark               Mode    Cnt     Score        Error     Units</span></span><br><span class="line"><span class="comment">    BenchmarkSimple.bench   thrpt    5  13352311.603 ± 767137.272  ops/ms</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> RunnerException </span>{</span><br><span class="line">        Options opt = <span class="keyword">new</span> OptionsBuilder()</span><br><span class="line">                .include(BenchmarkSimple.class.getSimpleName())</span><br><span class="line">                .forks(<span class="number">1</span>)</span><br><span class="line">                .warmupIterations(<span class="number">5</span>)</span><br><span class="line">                .measurementIterations(<span class="number">5</span>)</span><br><span class="line">                .threads(<span class="number">10</span>)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="keyword">new</span> Runner(opt).run();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>Tips: Full code is <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/asdf2014/yuzhouwan/tree/master/yuzhouwan-bigdata/yuzhouwan-bigdata-zookeeper/src/test/java/com/yuzhouwan/bigdata/zookeeper/benchmark">here</a>.</p>
<h5 id="优势"><a href="#优势" class="headerlink" title="优势"></a>优势</h5><ul>
<li>不和会 JUnit 冲突，不用担心 Jenkins 会自动跑 Benchmark 测试而影响效率（否则需要添加 <code>@Ignore</code> 让 CI 系统忽略掉性能相关的 JUnit 测试用例）</li>
<li>支持 <code>warm up</code>，可以解决 JIT 预热问题</li>
</ul>
<h4 id="BTrace"><a href="#BTrace" class="headerlink" title="BTrace"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/btraceio/btrace">BTrace</a></h4><p>　BTrace is a safe, dynamic tracing tool for the Java platform. BTrace can be used to dynamically trace a running Java program (similar to DTrace for OpenSolaris applications and OS). BTrace dynamically instruments the classes of the target application to inject tracing code (“bytecode tracing”).</p>
<h4 id="LooseJar"><a href="#LooseJar" class="headerlink" title="LooseJar"></a>LooseJar</h4><h5 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h5><p>　分析没有被加载任何 class 的 jar 包，帮助删除工程中不必要的 jar 包。不过，需要注意的是，有些类是动态加载的（比如数据类型转换类的，只有加载数据时才会用到），需要尽可能地多测试，才能保证 LooseJar 分析准确</p>
<h5 id="使用步骤"><a href="#使用步骤" class="headerlink" title="使用步骤"></a>使用步骤</h5><ul>
<li><p>下载<br>在 LooseJar 的 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/kyrill007/loosejar/releases">release 页面</a>，下载 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/kyrill007/loosejar/releases/download/1.1.0/loosejar-1.1.0.jar">loosejar-1.1.0.jar</a></p>
</li>
<li><p>拷贝<br>将 loosejar.jar 放到应用的 WEB-INF 下的 lib 目录中，比如说路径是 <code>/yuzhouwan/yuzhouwan-site/yuzhouwan-site-web/src/main/webapp/WEB-INF/lib/loosejar.jar</code></p>
</li>
<li><p>配置<br>在 IDE 中的 installed JRES 里面的 JDK 处配置 <code>-Dfile.encoding=uft8 -javaagent:/yuzhouwan/yuzhouwan-site/yuzhouwan-site-web/src/main/webapp/WEB-INF/lib/loosejar.jar</code></p>
</li>
<li><p>启动<br>启动应用，尽可能做到路径全覆盖地测试应用，让每段代码都被执行到</p>
</li>
<li><p>查看结果<br>运行 JDK 自带的 Jconsole 工具，选择 BootStrap 的那个端口，然后选择 MBean 下的 <code>com.googlecode.loosejar</code>，并点击 summary，即可看到分析结果</p>
</li>
</ul>
<h3 id="编码层面"><a href="#编码层面" class="headerlink" title="编码层面"></a>编码层面</h3><h4 id="并发相关"><a href="#并发相关" class="headerlink" title="并发相关"></a>并发相关</h4><h5 id="synchronized"><a href="#synchronized" class="headerlink" title="synchronized"></a>synchronized</h5><p>　详见，《如何运用 JVM 知识提高编程水平 - <a href="https://yuzhouwan.com/posts/27328/#synchronized-的性能之争">synchronized 的性能之争</a>》</p>
<h5 id="StampedLock"><a href="#StampedLock" class="headerlink" title="StampedLock"></a>StampedLock</h5><p>　StampedLock 是 JDK8 新引入的一个针对读写锁进行改进的类。其主要思想是，如果在读的同时又发生了写，则应当重读，而不是在读的时候阻塞写。如此可以做到，不仅读操作之间不会相互阻塞，还可以保证读操作不会阻塞写操作</p>
<h4 id="集合优化"><a href="#集合优化" class="headerlink" title="集合优化"></a>集合优化</h4><h5 id="HashMap"><a href="#HashMap" class="headerlink" title="HashMap"></a>HashMap</h5><h6 id="为什么-Java-8-版本中引入红黑树"><a href="#为什么-Java-8-版本中引入红黑树" class="headerlink" title="为什么 Java 8 版本中引入红黑树"></a>为什么 Java 8 版本中引入红黑树</h6><ul>
<li><p>原因</p>
<p>JDK8 以前 HashMap 的实现是 <strong>数组+链表</strong>，即使哈希函数取得再好，也很难达到元素百分百均匀分布</p>
<p>当 HashMap 中有大量的元素都存放到同一个桶中时，这个桶下有一条长长的链表，这个时候 HashMap 就相当于一个单链表，假如单链表有 n 个元素，遍历的时间复杂度就是 $O(n)$，完全失去了它的优势</p>
<p>针对这种情况，JDK8 中引入了 <strong>红黑树</strong>（查找时间复杂度为 $O(\log n)$）来优化这个问题</p>
</li>
</ul>
<ul>
<li><p>流程</p>
<p>添加时，当桶中链表个数超过 8 时会转换成红黑树</p>
<p>删除、扩容时，如果桶中结构为红黑树，并且树中元素个数太少的话，会进行修剪或者直接还原成链表结构</p>
<p>查找时即使哈希函数设计不合理，大量元素集中在一个桶中，由于有红黑树结构，性能也不会差</p>
</li>
</ul>
<h5 id="Collections-类"><a href="#Collections-类" class="headerlink" title="Collections 类"></a>Collections 类</h5><h6 id="空集合"><a href="#空集合" class="headerlink" title="空集合"></a>空集合</h6><p>　<code>Collections.emptyList()</code> 重用一个对象而不是创建一个新对象，就像 <code>Arrays.asList()</code> 一样</p>
<h6 id="单元素"><a href="#单元素" class="headerlink" title="单元素"></a>单元素</h6><p>　<code>Collections.singletonList(element)</code> 是不可变的，且内部不用创建数组。而 <code>Arrays.asList(element)</code> 则是一个固定大小的 List，仍然需要创建数组</p>
<h5 id="LinkedList-vs-ArrayList-vs-ArrayDeque"><a href="#LinkedList-vs-ArrayList-vs-ArrayDeque" class="headerlink" title="LinkedList vs ArrayList vs ArrayDeque"></a>LinkedList vs ArrayList vs ArrayDeque</h5><p>　绝对大部分的场景，都能用 ArrayList 和 ArrayDeque 满足需求。而 LinkedList 唯一最擅长的场景是，遍历元素的时候，删除当前元素。ArrayList 使用下标访问元素时，因为不需要遍历链表，所以比 LinkedList 快很多。而 ArrayDeque 对开头和结尾进行增加或者删除时，因为不涉及分配链表节点和 GC 成本，所以也比 LinkedList 更快。不过，<code>ArrayDeque</code> 不支持 <code>null</code> 是硬伤</p>
<h5 id="java-util-Random-vs-java-util-concurrent-ThreadLocalRandom-vs-java-util-SplittableRandom"><a href="#java-util-Random-vs-java-util-concurrent-ThreadLocalRandom-vs-java-util-SplittableRandom" class="headerlink" title="java.util.Random vs java.util.concurrent.ThreadLocalRandom vs java.util.SplittableRandom"></a>java.util.Random vs java.util.concurrent.ThreadLocalRandom vs java.util.SplittableRandom</h5><p>　目前，JDK 中存在三种常用的方法来产生随机数，分别是 JDK1.0 的 <code>java.util.Random</code>、JDK1.7 的 <code>java.util.concurrent.ThreadLocalRandom</code> 和 JDK1.8 的 <code>java.util.SplittableRandom</code>（另外，<code>java.lang.Math.random()</code> 本质上还是 <code>java.util.Random</code>；而 <code>java.security.SecureRandom</code> 主要适用于加密场景，这里不做展开）。其中，<code>java.util.Random</code> 使用的是最普遍使用的线性同余法，该方法主要思路是通过对前一个数进行线性运算并取模从而得到下一个随机数。如此会带来一个问题，如果想保证线程安全，就需要在多线程之间共享 seed 值，同步的过程就会导致性能的损失。而 <code>ThreadLocalRandom</code> 和 <code>SplittableRandom</code> 为了避免该问题，则使用新发明的 SPLITMIX 算法，通过构建图谱和混合函数的方式，避免了加锁或 CAS 的过程。后两者都是基于同一个算法实现，不过也有稍微的区别，比如混合函数中引起<a target="_blank" rel="external nofollow noopener noreferrer" href="https://en.wikipedia.org/wiki/Avalanche_effect">雪崩效应</a>的常数值不一致等。从工程实现角度来看，相比于 <code>Random</code>，后两者基于 Fork-Join 思想，使得其在并发场景下，性能更佳。并且，<code>ThreadLocalRandom</code> 继承于 <code>Random</code>，而 <code>SplittableRandom</code> 则是完全独立的类。<br>　从 Doug Lea 的论文可以看出，后两者无论是单线程还是多线程的场景下，都是优于 <code>java.util.Random</code> 的。而针对 32-bits 和 64-bits 两种场景下，<code>ThreadLocalRandom</code> 和 <code>SplittableRandom</code> 则各有千秋。</p>
<p><img data-src="/picture/java/java_random_sequential_throughput.png" alt="Sequential Throughput for Random"></p>
<p><img data-src="/picture/java/java_random_parallel_stream_throughput.png" alt="Parallel Stream Throughput for Random"></p>
<center>（图片来源：《Fast Splittable Pseudorandom Number Generators》）</center>




<h5 id="contains-方法"><a href="#contains-方法" class="headerlink" title="contains 方法"></a>contains 方法</h5><h6 id="HashSet"><a href="#HashSet" class="headerlink" title="HashSet"></a>HashSet</h6><p>　时间复杂度 和 内存使用率 角度看，<code>HashSet</code> 为最佳之选</p>
<h5 id="toArray-方法"><a href="#toArray-方法" class="headerlink" title="toArray 方法"></a>toArray 方法</h5><h6 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h6><p>　使用 <code>Collection.toArray</code> 将集合转数组的时候，应该传入长度为 <code>0</code> 的数组（例如，<code>new String[0])</code>），而非预分配大小的。如此不仅代码可读性更佳，性能也会更好。</p>
<p>　JDK6 之前推荐传入预分配大小的数组，是因为 <code>toArray</code> 会调用 <code>Array.newArray</code>，而该方法使用了反射的方式初始化数组，因而性能低下。而在 JDK6 之后，JVM 将 <code>newArray</code> 调用标记为 <code>@HotSpotIntrinsicCandidate</code> 方法，使得其直接调用 JVM 内部实现而不走正常 JNI 逻辑，从而规避了昂贵的反射操作。另外，数组在初始化的时候，需要通过 zeroing 的过程，将已经分配给数组的内存空间覆盖为初始值。而长度为 <code>0</code> 的数组，则可以节省下这部分的性能开销。</p>
<h6 id="压测"><a href="#压测" class="headerlink" title="压测"></a>压测</h6><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@State(Scope.Thread)</span></span><br><span class="line"><span class="meta">@OutputTimeUnit(TimeUnit.NANOSECONDS)</span></span><br><span class="line"><span class="meta">@BenchmarkMode(Mode.AverageTime)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ToArrayBenchmark</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Param({"1", "100", "1000", "5000", "10000", "100000"})</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> n;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Object&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Setup</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">populateList</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) {</span><br><span class="line">            list.add(<span class="number">0</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Benchmark</span></span><br><span class="line">    <span class="keyword">public</span> Object[] preSize() {</span><br><span class="line">        <span class="keyword">return</span> list.toArray(<span class="keyword">new</span> Object[n]);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Benchmark</span></span><br><span class="line">    <span class="keyword">public</span> Object[] resize() {</span><br><span class="line">        <span class="keyword">return</span> list.toArray(<span class="keyword">new</span> Object[<span class="number">0</span>]);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Integer List:</span></span><br><span class="line"><span class="comment">    Benchmark                    (n)  Mode  Cnt       Score        Error  Units</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.preSize       1  avgt    3      41.552 ±    108.030  ns/op</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.preSize     100  avgt    3     216.449 ±    799.501  ns/op</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.preSize    1000  avgt    3    2087.965 ±   6027.778  ns/op</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.preSize    5000  avgt    3    9098.358 ±  14603.493  ns/op</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.preSize   10000  avgt    3   24204.199 ± 121468.232  ns/op</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.preSize  100000  avgt    3  188183.618 ± 369455.090  ns/op</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.resize        1  avgt    3      18.987 ±     36.449  ns/op</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.resize      100  avgt    3     265.549 ±   1125.008  ns/op</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.resize     1000  avgt    3    1560.713 ±   2922.186  ns/op</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.resize     5000  avgt    3    7804.810 ±   8333.390  ns/op</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.resize    10000  avgt    3   24791.026 ±  78459.936  ns/op</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.resize   100000  avgt    3  158891.642 ±  56055.895  ns/op</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    Object List:</span></span><br><span class="line"><span class="comment">    Benchmark                    (n)  Mode  Cnt      Score       Error  Units</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.preSize       1  avgt    3     36.306 ±    96.612  ns/op</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.preSize     100  avgt    3     52.372 ±    84.159  ns/op</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.preSize    1000  avgt    3    449.807 ±   215.692  ns/op</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.preSize    5000  avgt    3   2080.172 ±  2003.726  ns/op</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.preSize   10000  avgt    3   4657.937 ±  8432.624  ns/op</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.preSize  100000  avgt    3  51980.829 ± 46920.314  ns/op</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.resize        1  avgt    3     16.747 ±    85.131  ns/op</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.resize      100  avgt    3     43.803 ±    28.704  ns/op</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.resize     1000  avgt    3    404.681 ±   132.986  ns/op</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.resize     5000  avgt    3   1972.649 ±   174.691  ns/op</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.resize    10000  avgt    3   4021.440 ±  1114.212  ns/op</span></span><br><span class="line"><span class="comment">    ToArrayBenchmark.resize   100000  avgt    3  44204.167 ± 76714.850  ns/op</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        Options opt = <span class="keyword">new</span> OptionsBuilder()</span><br><span class="line">                .include(ToArrayBenchmark.class.getSimpleName())</span><br><span class="line">                .forks(<span class="number">1</span>)</span><br><span class="line">                .warmupIterations(<span class="number">1</span>)</span><br><span class="line">                .measurementIterations(<span class="number">3</span>)</span><br><span class="line">                .threads(<span class="number">1</span>)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="keyword">new</span> Runner(opt).run();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>Tips: Full code is <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-hacker/src/test/java/com/yuzhouwan/hacker/algorithms/collection/ToArrayBenchmark.java">here</a>.</p>
<h5 id="instanceof"><a href="#instanceof" class="headerlink" title="instanceof"></a>instanceof</h5><div class="table-container">
<table>
<thead>
<tr>
<th>Operation</th>
<th>Runtime in nanoseconds per operation</th>
<th>Relative to instanceof</th>
</tr>
</thead>
<tbody>
<tr>
<td>INSTANCEOF</td>
<td>39,598 ± 0,022 ns/op</td>
<td>100,00 %</td>
</tr>
<tr>
<td>GETCLASS</td>
<td>39,687 ± 0,021 ns/op</td>
<td>100,22 %</td>
</tr>
<tr>
<td>TYPE</td>
<td>46,295 ± 0,026 ns/op</td>
<td>116,91 %</td>
</tr>
<tr>
<td>OO</td>
<td>48,078 ± 0,026 ns/op</td>
<td>121,42 %</td>
</tr>
</tbody>
</table>
</div>
<h4 id="字符串相关"><a href="#字符串相关" class="headerlink" title="字符串相关"></a>字符串相关</h4><h5 id="repeat"><a href="#repeat" class="headerlink" title="repeat"></a>repeat</h5><p>　借鉴 JDK11 中新增的 <code>String#repeat</code> 特性，实现高效的 repeat 工具方法</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns a string whose value is the concatenation of the</span></span><br><span class="line"><span class="comment"> * string {<span class="doctag">@code</span> s} repeated {<span class="doctag">@code</span> count} times.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * If count or length is zero then the empty string is returned.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * This method may be used to create space padding for</span></span><br><span class="line"><span class="comment"> * formatting text or zero padding for formatting numbers.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> count number of times to repeat</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> A string composed of this string repeated</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@code</span> count} times or the empty string if count</span></span><br><span class="line"><span class="comment"> * or length is zero.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IllegalArgumentException if the {<span class="doctag">@code</span> count} is negative.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@link</span> https://bugs.openjdk.java.net/browse/JDK-8197594</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">repeat</span><span class="params">(String s, <span class="keyword">int</span> count)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (count &lt; <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"count is negative, "</span> + count);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (count == <span class="number">1</span>) {</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">byte</span>[] value = s.getBytes(StandardCharsets.UTF_8);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> len = value.length;</span><br><span class="line">    <span class="keyword">if</span> (len == <span class="number">0</span> || count == <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (len == <span class="number">1</span>) {</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">byte</span>[] single = <span class="keyword">new</span> <span class="keyword">byte</span>[count];</span><br><span class="line">        Arrays.fill(single, value[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String(single, StandardCharsets.UTF_8);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (Integer.MAX_VALUE / count &lt; len) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> OutOfMemoryError();</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> limit = len * count;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">byte</span>[] multiple = <span class="keyword">new</span> <span class="keyword">byte</span>[limit];</span><br><span class="line">    System.arraycopy(value, <span class="number">0</span>, multiple, <span class="number">0</span>, len);</span><br><span class="line">    <span class="keyword">int</span> copied = len;</span><br><span class="line">    <span class="keyword">for</span> (; copied &lt; limit - copied; copied &lt;&lt;= <span class="number">1</span>) {</span><br><span class="line">        System.arraycopy(multiple, <span class="number">0</span>, multiple, copied, copied);</span><br><span class="line">    }</span><br><span class="line">    System.arraycopy(multiple, <span class="number">0</span>, multiple, copied, limit - copied);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> String(multiple, StandardCharsets.UTF_8);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Fork-Join-思想"><a href="#Fork-Join-思想" class="headerlink" title="Fork / Join 思想"></a>Fork / Join 思想</h4><p>　这里以查找最小数为例，具体实现如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ForkJoinPool;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.RecursiveTask;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Copyright @ 2019 yuzhouwan.com</span></span><br><span class="line"><span class="comment"> * All right reserved.</span></span><br><span class="line"><span class="comment"> * Function：Minimum Finder</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Benedict Jin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2019/4/13</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MinimumFinder</span> <span class="keyword">extends</span> <span class="title">RecursiveTask</span>&lt;<span class="title">Integer</span>&gt; </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> JOIN_THRESHOLD = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span>[] data;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> start;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> end;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">MinimumFinder</span><span class="params">(<span class="keyword">int</span>[] data, <span class="keyword">int</span> start, <span class="keyword">int</span> end)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">        <span class="keyword">this</span>.start = start;</span><br><span class="line">        <span class="keyword">this</span>.end = end;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">MinimumFinder</span><span class="params">(<span class="keyword">int</span>[] data)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>(data, <span class="number">0</span>, data.length);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Integer <span class="title">compute</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> len = end - start;</span><br><span class="line">        <span class="keyword">if</span> (len &lt; JOIN_THRESHOLD) {</span><br><span class="line">            <span class="keyword">return</span> internal();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> split = len / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">final</span> MinimumFinder left = <span class="keyword">new</span> MinimumFinder(data, start, start + split);</span><br><span class="line">        left.fork();</span><br><span class="line">        <span class="keyword">final</span> MinimumFinder right = <span class="keyword">new</span> MinimumFinder(data, start + split, end);</span><br><span class="line">        <span class="keyword">return</span> Math.min(right.compute(), left.join());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Integer <span class="title">internal</span><span class="params">()</span> </span>{</span><br><span class="line">        System.out.println(Thread.currentThread() + <span class="string">" computing: "</span> + start + <span class="string">" to "</span> + end);</span><br><span class="line">        <span class="keyword">int</span> min = Integer.MAX_VALUE;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = start; i &lt; end; i++) {</span><br><span class="line">            <span class="keyword">if</span> (data[i] &lt; min) {</span><br><span class="line">                min = data[i];</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> min;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span>[] data = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1000</span>];</span><br><span class="line">        <span class="keyword">final</span> Random random = <span class="keyword">new</span> Random(System.nanoTime());</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; data.length; i++) {</span><br><span class="line">            data[i] = random.nextInt(<span class="number">100</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">final</span> ForkJoinPool pool = <span class="keyword">new</span> ForkJoinPool(Runtime.getRuntime().availableProcessors());</span><br><span class="line">        <span class="keyword">final</span> MinimumFinder finder = <span class="keyword">new</span> MinimumFinder(data);</span><br><span class="line">        System.out.println(pool.invoke(finder));</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>　另外，JDK8+ 中使用 <code>parallelStream()</code> 方法将集合转为并行的 Stream 进行处理，内部使用的便是 Fork/Join 思想。需要注意的是，parallelStream 内部创建的线程池大小可以通过 <code>java.util.concurrent.ForkJoinPool.common.parallelism</code> 参数来控制，最大不能超过 <code>ForkJoinPool#MAX_CAP</code>，即 <code>32767</code>。默认情况下，直接使用 CPU 的虚拟核数作为线程池大小。</p>
<h4 id="Memoization"><a href="#Memoization" class="headerlink" title="Memoization"></a>Memoization</h4><p>　摘自一段来自 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://en.wikipedia.org/wiki/Memoization">wikipedia.org</a> 的定义，如下</p>
<blockquote>
<p>In computing, memoization or memoisation is an optimization technique used primarily to speed up computer programs by storing the results of expensive function calls and returning the cached result when the same inputs occur again.</p>
</blockquote>
<p>　由此可见，Memoization 也就是我们常用的单例设计模式的由来。如果项目中使用到了 Guava，则可以很方便地通过调用 <code>Suppliers.memoize(() -&gt; {...})</code> 来实现。其<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/google/guava/blob/master/guava/src/com/google/common/base/Suppliers.java#L85">内部</a>实现了一个 <code>2-field</code> 变种的 Double-check 锁，具体如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns a supplier which caches the instance retrieved during the first</span></span><br><span class="line"><span class="comment"> * call to {<span class="doctag">@code</span> get()} and returns that value on subsequent calls to</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@code</span> get()}. See:</span></span><br><span class="line"><span class="comment"> * &lt;a href="http://en.wikipedia.org/wiki/Memoization"&gt;memoization&lt;/a&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;The returned supplier is thread-safe. The supplier's serialized form</span></span><br><span class="line"><span class="comment"> * does not contain the cached value, which will be recalculated when {<span class="doctag">@code</span></span></span><br><span class="line"><span class="comment"> * get()} is called on the reserialized instance.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;If {<span class="doctag">@code</span> delegate} is an instance created by an earlier call to {<span class="doctag">@code</span></span></span><br><span class="line"><span class="comment"> * memoize}, it is returned directly.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Supplier&lt;T&gt; <span class="title">memoize</span><span class="params">(Supplier&lt;T&gt; delegate)</span> </span>{</span><br><span class="line">  <span class="keyword">return</span> (delegate <span class="keyword">instanceof</span> MemoizingSupplier)</span><br><span class="line">         ? delegate</span><br><span class="line">         : <span class="keyword">new</span> MemoizingSupplier&lt;T&gt;(Preconditions.checkNotNull(delegate));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@VisibleForTesting</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MemoizingSupplier</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Supplier</span>&lt;<span class="title">T</span>&gt;, <span class="title">Serializable</span> </span>{</span><br><span class="line">  <span class="keyword">final</span> Supplier&lt;T&gt; delegate;</span><br><span class="line">  <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> initialized;</span><br><span class="line">  <span class="comment">// "value" does not need to be volatile; visibility piggy-backs</span></span><br><span class="line">  <span class="comment">// on volatile read of "initialized".</span></span><br><span class="line">  <span class="keyword">transient</span> T value;</span><br><span class="line"></span><br><span class="line">  MemoizingSupplier(Supplier&lt;T&gt; delegate) {</span><br><span class="line">    <span class="keyword">this</span>.delegate = delegate;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> T <span class="title">get</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// A 2-field variant of Double Checked Locking.</span></span><br><span class="line">    <span class="keyword">if</span> (!initialized) {</span><br><span class="line">      <span class="keyword">synchronized</span> (<span class="keyword">this</span>) {</span><br><span class="line">        <span class="keyword">if</span> (!initialized) {</span><br><span class="line">          T t = delegate.get();</span><br><span class="line">          value = t;</span><br><span class="line">          initialized = <span class="keyword">true</span>;</span><br><span class="line">          <span class="keyword">return</span> t;</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Suppliers.memoize("</span> + delegate + <span class="string">")"</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="堆栈优化"><a href="#堆栈优化" class="headerlink" title="堆栈优化"></a>堆栈优化</h4><h5 id="ByteBuffer"><a href="#ByteBuffer" class="headerlink" title="ByteBuffer"></a>ByteBuffer</h5><p>　通过 <code>allocateDirect(int capacity)</code> 方法可以避开堆栈，直接通过操作系统创建内存块作为缓冲区。该方式与操作系统能更好地耦合，因而能进一步提高 I/O 操作的速度。缺点是，分配直接缓冲区的系统开销很大。因此，只有在缓冲区较大并会长期存在，或者需要经常重用时，才使用这种缓冲区</p>
<h4 id="位运算"><a href="#位运算" class="headerlink" title="位运算"></a>位运算</h4><h5 id="奇偶数"><a href="#奇偶数" class="headerlink" title="奇偶数"></a>奇偶数</h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isEven</span><span class="params">(<span class="keyword">int</span> i)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> (i &amp; <span class="number">1</span>) == <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h5 id="毫秒"><a href="#毫秒" class="headerlink" title="毫秒"></a>毫秒</h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> SECOND_MASK = <span class="number">0xFFFFFFFF00000000L</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isMillis</span><span class="params">(<span class="keyword">long</span> timestamp)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> (timestamp &amp; SECOND_MASK) != <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="时间戳"><a href="#时间戳" class="headerlink" title="时间戳"></a>时间戳</h4><p>　<code>System.currentTimeMillis()</code> 通过 <code>GetSystemTimeAsFileTime</code> API 可以快速地获取系统的全局变量值，以得到毫秒值。但是，这个接口取决于操作系统底层的实现，所以有可能该全局变量值的更新频率不高，导致无法满足毫秒级别的精度。如果，是在高精度监控或者游戏等，对时间精度要求很高的领域，则需要使用 <code>System.nanoTime()</code>。后者，使用了 PIT（programmable-interval-timer）、PMT（power management timer）或 TSC（CPU-level timestamp-counter）几种高精度的时间计数器，以保证准确性。但 <code>System.nanoTime()</code> 的执行过程会存在微秒级别的耗时，所以也很难真正达到纳秒级的精度</p>
<h4 id="强引用-vs-软引用-vs-弱引用-vs-虚引用"><a href="#强引用-vs-软引用-vs-弱引用-vs-虚引用" class="headerlink" title="强引用 vs 软引用 vs 弱引用 vs 虚引用"></a>强引用 vs 软引用 vs 弱引用 vs 虚引用</h4><p>　合理地利用软引用和弱引用，可以有效解决 OOM 问题，下表是关于四种引用类型的比对：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th></th>
<th>例子</th>
<th>用途</th>
<th>生命周期</th>
<th>触发回收的时刻</th>
</tr>
</thead>
<tbody>
<tr>
<td>强引用</td>
<td><code>Object o = new Object()</code></td>
<td>对象的一般状态</td>
<td>JVM 停止运行时终止</td>
<td>从来不会</td>
</tr>
<tr>
<td>软引用</td>
<td><code>new SoftReference&lt;&gt;("yuzhouwan")</code></td>
<td>对象缓存</td>
<td>内存不足时终止</td>
<td>内存不足时</td>
</tr>
<tr>
<td>弱引用</td>
<td><code>new WeakReference&lt;&gt;("asdf")</code></td>
<td>对象缓存</td>
<td>GC 运行后终止</td>
<td>垃圾回收时</td>
</tr>
<tr>
<td>虚引用</td>
<td><code>new PhantomReference&lt;&gt;("2014", new ReferenceQueue&lt;&gt;())</code></td>
<td>跟踪对象被垃圾回收器回收的活动</td>
<td>无生命周期</td>
<td>任何时候</td>
</tr>
</tbody>
</table>
</div>
<h2 id="测试相关"><a href="#测试相关" class="headerlink" title="测试相关"></a>测试相关</h2><h3 id="参数驱动"><a href="#参数驱动" class="headerlink" title="参数驱动"></a>参数驱动</h3><p>　利用 <code>@Parameterized.Parameters</code> 注解可以指定多个可能的传值，使得当前测试类下的所有测试用例可以被多次复用。但是该注解并不能让参数之间自行组合，所以严格来说，并不是参数驱动（后续介绍的 HttpRunner 框架则是严格意义上的参数驱动）</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.yuzhouwan.compression.CompressionType;</span><br><span class="line"><span class="keyword">import</span> org.junit.FixMethodOrder;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.junit.runners.MethodSorters;</span><br><span class="line"><span class="keyword">import</span> org.junit.runners.Parameterized;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="meta">@FixMethodOrder(MethodSorters.JVM)</span></span><br><span class="line"><span class="meta">@RunWith(Parameterized.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CompressionTest</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Parameterized</span>.Parameter()</span><br><span class="line">    <span class="keyword">public</span> CompressionType compressionType4ts;</span><br><span class="line">    <span class="meta">@Parameterized</span>.Parameter(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">public</span> CompressionType compressionType4longValue;</span><br><span class="line">    <span class="meta">@Parameterized</span>.Parameter(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">public</span> CompressionType compressionType4doubleValue;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Parameterized</span>.Parameters</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Iterable&lt;Object[]&gt; getParameters() {</span><br><span class="line">        <span class="keyword">return</span> Arrays.asList(<span class="keyword">new</span> Object[][]{</span><br><span class="line">                {CompressionType.NONE, CompressionType.NONE, CompressionType.NONE},</span><br><span class="line">                {CompressionType.SIMPLE8B, CompressionType.NONE, CompressionType.GORILLA},</span><br><span class="line">                {CompressionType.SIMPLE8B_WITH_RLE, CompressionType.ZIGZAG_WITH_SIMPLE8B, CompressionType.NONE},</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * NONE - NONE - NONE</span></span><br><span class="line"><span class="comment">     * SIMPLE8B - NONE - GORILLA</span></span><br><span class="line"><span class="comment">     * SIMPLE8B_WITH_RLE - ZIGZAG_WITH_SIMPLE8B - NONE</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>{</span><br><span class="line">        System.out.println(compressionType4ts + <span class="string">" - "</span> + compressionType4longValue + <span class="string">" - "</span> + compressionType4doubleValue);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="自动化测试"><a href="#自动化测试" class="headerlink" title="自动化测试"></a>自动化测试</h3><h4 id="HttpRunner"><a href="#HttpRunner" class="headerlink" title="HttpRunner"></a>HttpRunner</h4><h5 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h5><p>　<a target="_blank" rel="external nofollow noopener noreferrer" href="https://v2.httprunner.org/">HttpRunner</a>™ 是一款面向 HTTP(S) 协议的通用测试框架，只需编写维护一份 <code>YAML/JSON</code> 脚本，即可实现自动化测试、性能测试、线上监控、持续集成等多种测试需求。这里将以测试 OpenTSDB 为例，更加具象地介绍 HttpRunner</p>
<h5 id="QuickStart"><a href="#QuickStart" class="headerlink" title="QuickStart"></a>QuickStart</h5><h6 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h6><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ pip install httprunner==1.5.15</span><br><span class="line"></span><br><span class="line">$ hrun -V</span><br><span class="line">  1.5.15</span><br><span class="line"></span><br><span class="line">$ har2case -V</span><br><span class="line">  0.2.0</span><br></pre></td></tr></tbody></table></figure>
<h6 id="启动-Flask"><a href="#启动-Flask" class="headerlink" title="启动 Flask"></a>启动 Flask</h6><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ pip install flask</span><br><span class="line"></span><br><span class="line">$ mkdir docs/data/</span><br><span class="line">$ wget https://v2.httprunner.org/data/api_server.py -P docs/data/</span><br><span class="line">$ <span class="built_in">export</span> FLASK_APP=docs/data/api_server.py</span><br><span class="line">$ <span class="built_in">export</span> FLASK_ENV=development</span><br><span class="line">$ flask run</span><br><span class="line"></span><br><span class="line">$ curl localhost:5000                                          </span><br><span class="line">  Hello World!</span><br></pre></td></tr></tbody></table></figure>
<h6 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h6><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://v2.httprunner.org/data/demo-quickstart.har -P docs/data/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 demo-quickstart.har 转换为 HttpRunner 的测试用例文件</span></span><br><span class="line"><span class="comment"># 默认输出 JSON 文件，加 `-2y` 参数，可以转化为 YAML</span></span><br><span class="line">$ har2case docs/data/demo-quickstart.har</span><br><span class="line">$ hrun docs/data/demo-quickstart.json</span><br></pre></td></tr></tbody></table></figure>
<h5 id="新建测试项目"><a href="#新建测试项目" class="headerlink" title="新建测试项目"></a>新建测试项目</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 新建目录</span></span><br><span class="line">$ httprunner --startproject yuzhouwan</span><br><span class="line"></span><br><span class="line">$ ls -sail</span><br><span class="line">  12891420763 4 -rw-r--r--  1 benedictjin wheel   44 Feb  2 11:37 .env</span><br><span class="line">  12891384628 0 drwxr-xr-x  2 benedictjin wheel   64 Feb  1 16:44 api/</span><br><span class="line">  12891454305 4 -rw-r--r--  1 benedictjin wheel 2389 Feb  2 14:34 debugtalk.py</span><br><span class="line">  12891454901 4 -rw-r--r--  1 benedictjin wheel 1452 Feb  2 15:21 locustfile.py</span><br><span class="line">  12891454386 0 drwxr-xr-x  8 benedictjin wheel  256 Feb  2 15:30 reports/</span><br><span class="line">  12891384629 0 drwxr-xr-x  7 benedictjin wheel  224 Feb  2 14:47 testcases/</span><br><span class="line">  12891384630 0 drwxr-xr-x  2 benedictjin wheel   64 Feb  1 16:44 testsuites/</span><br><span class="line"><span class="comment"># .env         存放环境变量的 properties 文件</span></span><br><span class="line"><span class="comment"># testcases    存放所有 httprunner 的 json 测试实例</span></span><br><span class="line"><span class="comment"># debugtalk.py 存放所有 httprunner 测试实例中，需要用到自定义函数</span></span><br><span class="line"><span class="comment"># reports      生成的 html 结果页面</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="性能测试"><a href="#性能测试" class="headerlink" title="性能测试"></a>性能测试</h5><h6 id="环境部署"><a href="#环境部署" class="headerlink" title="环境部署"></a>环境部署</h6><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ python -m pip install --trusted-host pypi.python.org --trusted-host files.pythonhosted.org --trusted-host pypi.org locustio</span><br><span class="line"></span><br><span class="line">$ locusts -V</span><br><span class="line">  [2019-02-02 10:17:55,387] BenedictJin.local/INFO/stdout: Locust 0.9.0</span><br><span class="line">  [2019-02-02 10:17:55,387] BenedictJin.local/INFO/stdout:</span><br><span class="line"></span><br><span class="line">$ locusts -f put_one_point_with_variable_data_types.json --processes 4</span><br><span class="line">  [2019-02-02 10:18:53,668] BenedictJin.local/INFO/locust.main: Starting web monitor at *:8089</span><br><span class="line">  [2019-02-02 10:18:53,668] BenedictJin.local/INFO/locust.main: Starting Locust 0.9.0</span><br></pre></td></tr></tbody></table></figure>
<h6 id="测试限流"><a href="#测试限流" class="headerlink" title="测试限流"></a>测试限流</h6><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 需要先打开服务端的限流</span></span><br><span class="line">$ <span class="built_in">source</span> .env</span><br><span class="line">$ locusts -f testcases/<span class="built_in">limit</span>/limit_tps_with_number.json --processes 4 -H <span class="variable">${base_url_from_env}</span> -L DEBUG</span><br><span class="line">$ locusts -f testcases/<span class="built_in">limit</span>/limit_tps_with_string.json --processes 4 -H <span class="variable">${base_url_from_env}</span> -L DEBUG</span><br></pre></td></tr></tbody></table></figure>
<p><img data-src="/picture/java/java_limit_tps_with_string.png" alt></p>
<center>（对 <a href="https://github.com/HttpRunner" target="_blank" rel="external nofollow noopener noreferrer">HttpRunner</a>™ 的截图）</center>


<h5 id="抓包并转为-TestCase"><a href="#抓包并转为-TestCase" class="headerlink" title="抓包并转为 TestCase"></a>抓包并转为 TestCase</h5><h6 id="使用-Charles-抓包工具"><a href="#使用-Charles-抓包工具" class="headerlink" title="使用 Charles 抓包工具"></a>使用 Charles 抓包工具</h6><p>　通过该方法，可以将现有的测试用例，轻松地转为 http_runner 的表现形式。具体步骤如下：</p>
<p>a) 安装 Charles Proxy</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Mac</span></span><br><span class="line"><span class="comment"># https://www.charlesproxy.com/download/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Linux</span></span><br><span class="line">$ cat &lt;&lt;EOF &gt; /etc/yum.repos.d/Charles.repo</span><br><span class="line">  [charlesproxy]</span><br><span class="line">  name=Charles Proxy Repository</span><br><span class="line">  baseurl=https://www.charlesproxy.com/packages/yum</span><br><span class="line">  gpgkey=https://www.charlesproxy.com/packages/yum/PublicKey</span><br><span class="line">  EOF</span><br><span class="line"></span><br><span class="line">$ sudo yum install charles-proxy</span><br></pre></td></tr></tbody></table></figure>
<p>b) 关闭 browsermob-proxy</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pkill -1 -f browsermob-proxy</span><br></pre></td></tr></tbody></table></figure>
<p>c) 在 Http Request 中增加 Proxy</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">request.setConfig(RequestConfig.custom().setProxy(<span class="keyword">new</span> HttpHost(<span class="string">"127.0.0.1"</span>, <span class="number">8888</span>)).build());</span><br><span class="line"><span class="comment">// 修改好之后，重新打包编译即可</span></span><br></pre></td></tr></tbody></table></figure>
<h6 id="使用-browsermobproxy-代理库"><a href="#使用-browsermobproxy-代理库" class="headerlink" title="使用 browsermobproxy 代理库"></a>使用 browsermobproxy 代理库</h6><p>　也可以通过编写 Python 脚本，来创建 Proxy，并使用 Json 库将 Proxy 抓包内容以 har 的形式保存为文件</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> psutil</span><br><span class="line"><span class="keyword">from</span> browsermobproxy <span class="keyword">import</span> Server</span><br><span class="line"></span><br><span class="line"><span class="comment"># pkill -1 -f browsermob-proxy</span></span><br><span class="line"><span class="keyword">for</span> proc <span class="keyword">in</span> psutil.process_iter():</span><br><span class="line">    <span class="keyword">if</span> proc.name() == <span class="string">"browsermob-proxy"</span>:</span><br><span class="line">        proc.kill()</span><br><span class="line"></span><br><span class="line">server = Server(path=<span class="string">"/apps/browsermob-proxy-2.1.4/bin/browsermob-proxy"</span>,</span><br><span class="line">                options={<span class="string">'port'</span>: <span class="number">8880</span>})</span><br><span class="line">server.start()</span><br><span class="line"></span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">proxy = server.create_proxy(params={<span class="string">'port'</span>: <span class="number">8881</span>})</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'testcases.txt'</span>, <span class="string">"r+"</span>, encoding=<span class="string">"utf8"</span>) <span class="keyword">as</span> of:</span><br><span class="line">    os.chdir(<span class="string">"/code/yuzhouwan-test-cloud"</span>)</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> of.readlines():</span><br><span class="line"></span><br><span class="line">        line = line.strip(<span class="string">'\n'</span>)</span><br><span class="line">        print(line)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'.'</span> <span class="keyword">not</span> <span class="keyword">in</span> line:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        splits = line.split(<span class="string">'.'</span>)</span><br><span class="line">        clazz = splits[<span class="number">0</span>]</span><br><span class="line">        method = splits[<span class="number">1</span>]</span><br><span class="line">        proxy.new_har(<span class="string">"com.yuzhouwan.yuzhouwan.client.%s,%s"</span> % (clazz, method),</span><br><span class="line">                      options={<span class="string">'captureHeaders'</span>: <span class="literal">True</span>, <span class="string">'captureContent'</span>: <span class="literal">True</span>, <span class="string">'captureBinaryContent'</span>: <span class="literal">True</span>})</span><br><span class="line"></span><br><span class="line">        command = <span class="string">'java -ea -Didea.test.cyclic.buffer.size=1048576 -javaagent:'</span> \</span><br><span class="line">                  <span class="string">'&lt;...&gt;" '</span> \</span><br><span class="line">                  <span class="string">'com.intellij.rt.execution.junit.JUnitStarter -ideVersion5 -junit4 '</span> \</span><br><span class="line">                  <span class="string">'com.yuzhouwan.yuzhouwan.client.%s,%s'</span> % (clazz, method)</span><br><span class="line">        os.system(command)</span><br><span class="line"></span><br><span class="line">        json_obj = json.dumps(proxy.har)</span><br><span class="line"></span><br><span class="line">        file_dir = <span class="string">'/Users/benedictjin/Documents/http_runner/%s/'</span> % clazz</span><br><span class="line">        file_name = method</span><br><span class="line">        file_extension = <span class="string">'.har'</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(file_dir):</span><br><span class="line">            os.makedirs(file_dir)</span><br><span class="line"></span><br><span class="line">        fileObject = open(file_dir + file_name + file_extension, <span class="string">'w'</span>)</span><br><span class="line">        fileObject.write(json_obj)</span><br><span class="line">        fileObject.close()</span><br><span class="line"></span><br><span class="line">server.stop()</span><br></pre></td></tr></tbody></table></figure>
<h5 id="二次开发"><a href="#二次开发" class="headerlink" title="二次开发"></a>二次开发</h5><h6 id="解决-http-runner-中只能解析部分-parameters-的问题"><a href="#解决-http-runner-中只能解析部分-parameters-的问题" class="headerlink" title="解决 http_runner 中只能解析部分 parameters 的问题"></a>解决 http_runner 中只能解析部分 parameters 的问题</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim httprunner/parser.py</span></span><br><span class="line">parsed_parameters_list = []</span><br><span class="line"><span class="keyword">for</span> parameter <span class="keyword">in</span> parameters:</span><br><span class="line">    parameter_name, parameter_content = list(parameter.items())[<span class="number">0</span>]</span><br><span class="line">    parameter_name_list = parameter_name.split(<span class="string">"-"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 改为</span></span><br><span class="line">parsed_parameters_list = []</span><br><span class="line"><span class="keyword">for</span> parameter_name, parameter_content <span class="keyword">in</span> parameters.items():</span><br><span class="line">    parameter_name_list = parameter_name.split(<span class="string">"-"</span>)</span><br></pre></td></tr></tbody></table></figure>
<h6 id="使得-har2case-支持-list-结构的-JSON"><a href="#使得-har2case-支持-list-结构的-JSON" class="headerlink" title="使得 har2case 支持 list 结构的 JSON"></a>使得 har2case 支持 list 结构的 JSON</h6><p>　详见：Let <code>_make_validate</code> method supports the <code>list</code> structures JSON <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/HttpRunner/har2case/pull/18/files">#18</a></p>
<h6 id="使得-har2case-支持普通文本的返回类型"><a href="#使得-har2case-支持普通文本的返回类型" class="headerlink" title="使得 har2case 支持普通文本的返回类型"></a>使得 har2case 支持普通文本的返回类型</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim har2case/core.py</span></span><br><span class="line">mime_type = resp_content_dict.get(<span class="string">"mimeType"</span>)</span><br><span class="line"><span class="keyword">if</span> mime_type <span class="keyword">and</span> mime_type.startswith(<span class="string">"application/json"</span>):</span><br><span class="line"></span><br><span class="line">    encoding = resp_content_dict.get(<span class="string">"encoding"</span>)</span><br><span class="line">    <span class="keyword">if</span> encoding <span class="keyword">and</span> encoding == <span class="string">"base64"</span>:</span><br><span class="line">        content = base64.b64decode(text).decode(<span class="string">'utf-8'</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            resp_content_json = json.loads(content)</span><br><span class="line">        <span class="keyword">except</span> JSONDecodeError:</span><br><span class="line">            logging.warning(<span class="string">"response content can not be loaded as json."</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        resp_content_json = json.loads(text)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 改为</span></span><br><span class="line">mime_type = resp_content_dict.get(<span class="string">"mimeType"</span>)</span><br><span class="line"><span class="keyword">if</span> mime_type <span class="keyword">and</span> mime_type.startswith(<span class="string">"application/json"</span>):</span><br><span class="line"></span><br><span class="line">    encoding = resp_content_dict.get(<span class="string">"encoding"</span>)</span><br><span class="line">    <span class="keyword">if</span> encoding <span class="keyword">and</span> encoding == <span class="string">"base64"</span>:</span><br><span class="line">        text = base64.b64decode(text).decode(<span class="string">'utf-8'</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        resp_content_json = json.loads(text)</span><br><span class="line">    <span class="keyword">except</span> JSONDecodeError:</span><br><span class="line">        logging.warning(<span class="string">"response content can not be loaded as json."</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    print(<span class="string">"resp_content_json"</span>, resp_content_json)</span><br></pre></td></tr></tbody></table></figure>
<h6 id="使二次开发的改动生效"><a href="#使二次开发的改动生效" class="headerlink" title="使二次开发的改动生效"></a>使二次开发的改动生效</h6><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ pip uninstall har2case -y</span><br><span class="line">$ <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/har2case/har2case</span><br><span class="line">$ python setup.py install</span><br><span class="line"></span><br><span class="line">$ har2case --<span class="built_in">log</span>-level DEBUG test.har</span><br></pre></td></tr></tbody></table></figure>
<h5 id="可视化管理系统"><a href="#可视化管理系统" class="headerlink" title="可视化管理系统"></a>可视化管理系统</h5><h6 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h6><p>　按照<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/HttpRunner/HttpRunnerManager#%E6%9C%AC%E5%9C%B0%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2">部署手册</a>即可部署成功。相关的，比如，<a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.jianshu.com/p/07a9826898c0">MySQL 安装</a>、<a target="_blank" rel="external nofollow noopener noreferrer" href="https://blog.csdn.net/jeikerxiao/article/details/73822184">RabbitMQ 安装</a>，都能找到很多资料。这里，主要记录几个可能踩到的坑</p>
<h6 id="可视化管理页面"><a href="#可视化管理页面" class="headerlink" title="可视化管理页面"></a>可视化管理页面</h6><p>　配置环境、增加测试用例、组合测试套件等，效果如下图所示：</p>
<p><img data-src="/picture/java/java_http_runner_suit.png" alt></p>
<p>　运行结果报告页面，效果如下图所示：</p>
<p><img data-src="/picture/java/java_http_runner_report.png" alt></p>
<p>　支持权限管理，超级管理员可以配置整个管理系统，效果如下图所示：</p>
<p><img data-src="/picture/java/java_http_runner_super_user.png" alt></p>
<center>（对 <a href="https://github.com/HttpRunner" target="_blank" rel="external nofollow noopener noreferrer">HttpRunner</a>™ 的截图）</center>



<h5 id="踩到的坑"><a href="#踩到的坑" class="headerlink" title="踩到的坑"></a>踩到的坑</h5><h6 id="MySQL-默认编码导致-Django-报错-OperationalError"><a href="#MySQL-默认编码导致-Django-报错-OperationalError" class="headerlink" title="MySQL 默认编码导致 Django 报错 OperationalError"></a>MySQL 默认编码导致 Django 报错 OperationalError</h6><ul>
<li>描述</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ python manage.py migrate</span><br><span class="line"><span class="comment"># 报错 django.db.utils.OperationalError: (1366, "Incorrect string value for column 'name' at row 1")</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>解决</li>
</ul>
<p>　这个问题是因为新安装的 MySQL 默认的编码不是 <code>UTF-8</code> 导致的，停掉 <code>mysql</code> 实例配置 <code>my.cnf</code> 再重启即可。如果停止不掉，可以 <code>pkill mysql</code> 强制停止。之前创建的数据库也需要删掉重新创建</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/mysql/support-files</span><br><span class="line">$ sudo ./mysql.server stop</span><br><span class="line">$ vim my.cnf</span><br><span class="line">  [client]</span><br><span class="line">  default-character-set=utf8</span><br><span class="line"></span><br><span class="line">  [mysql]</span><br><span class="line">  default-character-set=utf8</span><br><span class="line"></span><br><span class="line">  [mysqld]</span><br><span class="line">  collation-server=utf8_unicode_ci</span><br><span class="line">  init-connect=<span class="string">'SET NAMES utf8'</span></span><br><span class="line">  character-set-server=utf8</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果 my.cnf 没有生效，可能需要拷贝一份到 /private/etc 目录下</span></span><br><span class="line">$ <span class="built_in">cd</span> /private/etc</span><br><span class="line">$ sudo cp /usr/<span class="built_in">local</span>/mysql/support-files/my.cnf .</span><br><span class="line"></span><br><span class="line">$ sudo ./mysql.server restart</span><br><span class="line">$ mysql -u root -p</span><br><span class="line">mysql&gt; show variables like <span class="string">'%char%'</span>;</span><br><span class="line">+--------------------------+-----------------------------------------------------------+</span><br><span class="line">| Variable_name            | Value                                                     |</span><br><span class="line">+--------------------------+-----------------------------------------------------------+</span><br><span class="line">| character_set_client     | utf8                                                      |</span><br><span class="line">| character_set_connection | utf8                                                      |</span><br><span class="line">| character_set_database   | utf8                                                      |</span><br><span class="line">| character_set_filesystem | binary                                                    |</span><br><span class="line">| character_set_results    | utf8                                                      |</span><br><span class="line">| character_set_server     | utf8                                                      |</span><br><span class="line">| character_set_system     | utf8                                                      |</span><br><span class="line">| character_sets_dir       | /usr/<span class="built_in">local</span>/mysql-5.7.25-macos10.14-x86_64/share/charsets/ |</span><br><span class="line">+--------------------------+-----------------------------------------------------------+</span><br><span class="line">8 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; drop database HttpRunner;</span><br><span class="line">Query OK, 27 rows affected (0.05 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; create database HttpRunner;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 增加 `TEST_CHARSET` 连接配置</span></span><br><span class="line">$ vim HttpRunnerManager/settings.py</span><br><span class="line">  DATABASES = {</span><br><span class="line">      <span class="string">'default'</span>: {</span><br><span class="line">          <span class="comment"># ...</span></span><br><span class="line">          <span class="string">'TEST_CHARSET'</span>: <span class="string">'utf-8'</span></span><br><span class="line">      }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">$ python manage.py migrate</span><br></pre></td></tr></tbody></table></figure>
<h2 id="JVM-相关"><a href="#JVM-相关" class="headerlink" title="JVM 相关"></a><a href="https://yuzhouwan.com/posts/27328/">JVM 相关</a></h2><h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><h4 id="堆内-vs-堆外"><a href="#堆内-vs-堆外" class="headerlink" title="堆内 vs 堆外"></a>堆内 vs 堆外</h4><h5 id="堆内内存"><a href="#堆内内存" class="headerlink" title="堆内内存"></a>堆内内存</h5><p>　一般情况下，Java 中分配的非空对象都是由 Java 虚拟机的垃圾收集器管理的，也称为<strong>堆内内存</strong>（on-heap memory）</p>
<h5 id="堆外内存"><a href="#堆外内存" class="headerlink" title="堆外内存"></a>堆外内存</h5><p>　<strong>堆外内存</strong>（off-heap memory）意味着把内存对象分配在 Java 虚拟机的堆以外的内存，这些内存直接受操作系统管理（而不是虚拟机）</p>
<h5 id="堆外内存的优势"><a href="#堆外内存的优势" class="headerlink" title="堆外内存的优势"></a>堆外内存的优势</h5><ul>
<li>对于大内存有良好的伸缩性</li>
<li>对垃圾回收停顿的改善可以明显感觉到</li>
<li>在进程间可以共享，减少虚拟机间的复制</li>
</ul>
<h5 id="堆外内存的劣势"><a href="#堆外内存的劣势" class="headerlink" title="堆外内存的劣势"></a>堆外内存的劣势</h5><ul>
<li>数据结构变得不那么直观，发生内存溢出的时候，排查定位会很麻烦</li>
<li>如果数据结构比较复杂，就要对它进行串行化（serialization），而串行化本身也会影响性能</li>
<li>可以使用更大的内存的同时，需要担心虚拟内存（即硬盘）的速度对应用的影响</li>
</ul>
<h5 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">-XX:MaxDirectMemorySize=64M 可以控制堆外内存大小，默认在 VM 静态变量 directMemory 为 64M</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">maxDirectMemory: 67108864</span></span><br><span class="line"><span class="comment">isDirect: true</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>{</span><br><span class="line">    System.out.println(<span class="string">"maxDirectMemory: "</span> + VM.maxDirectMemory());</span><br><span class="line">    ByteBuffer buffer = ByteBuffer.allocateDirect(<span class="number">1024</span> * <span class="number">1024</span> * <span class="number">64</span>);</span><br><span class="line">    Thread.sleep(<span class="number">200</span>);</span><br><span class="line">    <span class="keyword">boolean</span> isDirect = buffer.isDirect();</span><br><span class="line">    System.out.println(<span class="string">"isDirect: "</span> + isDirect);</span><br><span class="line">    <span class="keyword">if</span> (isDirect) ((DirectBuffer) buffer).cleaner().clean();</span><br><span class="line">    <span class="keyword">else</span> buffer.clear();</span><br><span class="line">    Thread.sleep(<span class="number">200</span>);</span><br><span class="line">    System.exit(<span class="number">0</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="指针压缩"><a href="#指针压缩" class="headerlink" title="指针压缩"></a>指针压缩</h4><h5 id="定义-1"><a href="#定义-1" class="headerlink" title="定义"></a>定义</h5><p>　64 位环境下，寄存器是 64 位的，对应指针也就成 64 位了，也就是 8 字节。我们知道 4 字节可以表示 4G，实际中基本不会有需要加载这么多对象的情况。因此 8 字节就显得浪费了，narrowKlass 只使用 4 个字节，预分配给 _metadata 的 8 字节中的另外 4 字节就可以用做它用了。看似 4 个字节无关紧要，但是堆中存在上千万到亿个对象时，省下的内存就是几百兆啊</p>
<h5 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h5><p>基于以下事实</p>
<ul>
<li>CPU 使用的虚拟地址是 64 位的，访问内存时，必须使用 64 位的指针访问内存对象</li>
<li>Java 对象是分配于具体的某个内存位置的，对其访问必须使用 64 位地址</li>
<li>对 Java 对象内的引用字段进行访问时，必须经过虚拟机这一层，操作某个对象引用不管是 getfield 还是 putfield，都是由虚拟机来执行。或者简单来说，要改变 Java 对象某个引用字段，必须经过虚拟机的参与</li>
</ul>
<p>　细心的你从上面一定可以看出一点线索，由于存一个对象引用和取一个对象引用必须经过虚拟机，所以完全可以在虚拟机这一层做些手脚。对于外部来说，putfield 提供的对象地址是 64 位的，经过虚拟机的转换，映射到 32 位，然后存入对象；getfield 指定目标对象的 64 位地址和其内部引用字段的偏移，取 32 位的数据，然后反映射到 64 位内存地址。对于外部来说，只看见 64 位的对象放进去，拿出来，内部的转换是透明的（本质上，就是按字节寻址，变成了按字寻址）</p>
<h5 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h5><h6 id="描述-1"><a href="#描述-1" class="headerlink" title="描述"></a>描述</h6><p>　CompressedOops 的原理是，解释器在解释字节码时，植入压缩指令（不影响正常和 JVM 优化后的指令顺序）<br>　具体逻辑是，当对象被读取时，解压，存入 heap 时，压缩</p>
<h6 id="压缩指令伪码"><a href="#压缩指令伪码" class="headerlink" title="压缩指令伪码"></a>压缩指令伪码</h6><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">! int R8; oop[] R9; // R9 is 64 bits</span><br><span class="line">! oop R10 = R9[R8]; // R10 is 32 bits</span><br><span class="line">! load compressed ptr from wide base ptr:</span><br><span class="line">movl R10, [R9 + R8&lt;&lt;3 + 16]</span><br><span class="line">! klassOop R11 = R10._klass; // R11 is 32 bits</span><br><span class="line">! void* const R12 = GetHeapBase();</span><br><span class="line">! load compressed klass ptr from compressed base ptr:</span><br><span class="line">movl R11, [R12 + R10&lt;&lt;3 + 8]</span><br></pre></td></tr></tbody></table></figure>
<h5 id="零基压缩优化（Zero-Based-Compressd-Oops）"><a href="#零基压缩优化（Zero-Based-Compressd-Oops）" class="headerlink" title="零基压缩优化（Zero Based Compressd Oops）"></a>零基压缩优化（Zero Based Compressd Oops）</h5><p>　零基压缩是针对压解压动作的进一步优化。它通过改变正常指针的随机地址分配特性，强制从零开始做分配（需要 OS 支持），进一步提高了压解压效率</p>
<p>　要启用零基压缩，你分配给 JVM 的内存大小必须控制在 4G 以上，32G 以下<br>　如果小于 4G，那么 JVM 会使用低虚拟地址空间（low virutal address space，64 位下模拟 32 位），这样就不需要做压解压动作了<br>　而对于大于 32G，将采用默认的随机地址分配特性，进行压解压</p>
<h5 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h5><p>　CompressedOops，可以让跑在 64 位平台下的 JVM，不需要因为更宽的寻址，而付出 Heap 容量损失的代价。<br>　不过，它的实现方式是在机器码中植入压缩与解压指令，可能会给 JVM 增加额外的开销</p>
<h5 id="参数控制"><a href="#参数控制" class="headerlink" title="参数控制"></a>参数控制</h5><p>　<code>-XX:+UseCompressedOops</code> 开启（<code>jdk1.6.0_14+</code>）<br>　<code>-XX:-UseCompressedOops</code> 关闭</p>
<h5 id="零基压缩的边界"><a href="#零基压缩的边界" class="headerlink" title="零基压缩的边界"></a>零基压缩的边界</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ JAVA_HOME=`/usr/libexec/java_home -v 1.8` java -Xmx32766m -XX:+PrintFlagsFinal 2&gt; /dev/null | grep UseCompressedOops</span><br><span class="line">  bool UseCompressedOops   := <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">$ JAVA_HOME=`/usr/libexec/java_home -v 1.8` java -Xmx32767m -XX:+PrintFlagsFinal 2&gt; /dev/null | grep UseCompressedOops</span><br><span class="line">  bool UseCompressedOops   = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果已经 JVM 进程已经启动了，可以通过 jinfo 进行查询</span></span><br><span class="line">$ jinfo -flag UseCompressedOops 18979</span><br><span class="line">  -XX:-UseCompressedOops</span><br></pre></td></tr></tbody></table></figure>
<h5 id="压缩-class-信息中的指针"><a href="#压缩-class-信息中的指针" class="headerlink" title="压缩 class 信息中的指针"></a>压缩 class 信息中的指针</h5><p>　从 JDK6_u23 开始 UseCompressedOops 被默认打开了。因此既能享受 64bit 带来的好处，又避免了 64bit 带来的性能损耗。当然，如果你有机会使用超过 32G 的堆内存，记得把这个选项关了</p>
<p>　到了 Java8，永久代被干掉了，有了 “meta space” 的概念，存储 JVM 中的元数据，包括 Byte code，class 等信息。Java8 在 UseCompressedOops 之外，额外增加了一个新选项叫做 UseCompressedClassPointer。这个选项打开后，class 信息中的指针也用 32bit 的 Compressed 版本。而这些指针指向的空间被称作 “Compressed Class Space”。默认大小是 1G，但可以通过 “CompressedClassSpaceSize” 调整</p>
<p>　如果你的 Java 程序引用了太多的包，有可能会造成这个空间不够用，于是会看到</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.lang.OutOfMemoryError: Compressed <span class="class"><span class="keyword">class</span> <span class="title">space</span></span></span><br></pre></td></tr></tbody></table></figure>
<p>　这时，一般调大 CompreseedClassSpaceSize 就可以了</p>
<h3 id="常用-Collector"><a href="#常用-Collector" class="headerlink" title="常用 Collector"></a>常用 Collector</h3><h4 id="CMS"><a href="#CMS" class="headerlink" title="CMS"></a>CMS</h4><h5 id="定义-2"><a href="#定义-2" class="headerlink" title="定义"></a>定义</h5><p>　<strong>CMS</strong>，全称 <strong>C</strong>oncurrent <strong>M</strong>ark <strong>S</strong>weep，是一款并发的、使用<strong>标记-清除</strong>算法的垃圾回收器</p>
<h5 id="内存碎片"><a href="#内存碎片" class="headerlink" title="内存碎片"></a>内存碎片</h5><p>　CMS 本身是不会移动内存的，长时间运行后，会产生很多内存碎片，导致没有一段足够大的连续区域可以存放大对象，导致 <code>promotion failed</code>、<code>concurrent mode failure</code> 等异常，从而触发 Full GC</p>
<p>　启用 <code>-XX:+UseCMSCompactAtFullCollection</code> 参数之后，会在 Full GC 的时候，对年老代的内存进行压缩。再配合 <code>-XX:CMSFullGCsBeforeCompaction=0</code> 参数可以控制多少次 FGC 后对老年代做压缩操作。默认值为 0，代表每次都压缩。该参数开启后，会把对象移动到内存的最左边，可能会影响性能，但是可以消除碎片</p>
<h5 id="浮动垃圾"><a href="#浮动垃圾" class="headerlink" title="浮动垃圾"></a>浮动垃圾</h5><p>　由于 CMS 并发清理阶段用户线程还在运行着，伴随程序运行自然就还会有新的垃圾不断产生，这一部分垃圾出现在标记过程之后，CMS 无法在当次收集中处理掉它们，只好留待下一次 GC 时再清理掉。这些无法被 GC 掉，留到下一次 GC 的垃圾，称之为<strong>浮动垃圾</strong></p>
<h3 id="常用参数"><a href="#常用参数" class="headerlink" title="常用参数"></a>常用参数</h3><h4 id="默认配置"><a href="#默认配置" class="headerlink" title="默认配置"></a>默认配置</h4><h5 id="Xss-堆栈大小"><a href="#Xss-堆栈大小" class="headerlink" title="-Xss 堆栈大小"></a>-Xss 堆栈大小</h5><div class="table-container">
<table>
<thead>
<tr>
<th>Platform</th>
<th>Default（KB）</th>
</tr>
</thead>
<tbody>
<tr>
<td>Windows IA32</td>
<td>64</td>
</tr>
<tr>
<td>Linux IA32</td>
<td>128</td>
</tr>
<tr>
<td>Windows x86_64</td>
<td>128</td>
</tr>
<tr>
<td>Linux x86_64</td>
<td>256</td>
</tr>
<tr>
<td>Windows IA64</td>
<td>320</td>
</tr>
<tr>
<td>Linux IA64</td>
<td>1024</td>
</tr>
<tr>
<td>Solaris Sparc</td>
<td>512</td>
</tr>
</tbody>
</table>
</div>
<p>Tips: <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/OpenTSDB/opentsdb/issues/334#issuecomment-482528576">实际案例</a> OpenTSDB 大查询导致 <code>java.long.StackOverflowError</code> 后，调整 <code>-Xss32m</code> 得以解决</p>
<h4 id="日志方面"><a href="#日志方面" class="headerlink" title="日志方面"></a>日志方面</h4><h5 id="常用的配置项"><a href="#常用的配置项" class="headerlink" title="常用的配置项"></a>常用的配置项</h5><div class="table-container">
<table>
<thead>
<tr>
<th>Flag</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>-verbose:gc</td>
<td>The <code>-verbose:gc</code> option enables logging of garbage collection (GC) information.</td>
</tr>
<tr>
<td>-XX:+PrintGCDetails -XX:+PrintGCTimeStamps</td>
<td><code>-XX:+PrintGCDetails</code> and <code>-XX:+PrintGCTimeStamps</code> are used to print detailed information about garbage collection.（这里由于 <code>-verbose:gc</code> 相当于 <code>-XX:+PrintGCDetails</code> 的别名，避免冗余，应该去掉 <code>-verbose:gc</code>）</td>
</tr>
<tr>
<td>-XX:-PrintTenuringDistribution</td>
<td>Print tenuring age information.</td>
</tr>
<tr>
<td>-XX:-UseGCLogFileRotation</td>
<td>Enabled GC log rotation, requires -Xloggc.</td>
</tr>
<tr>
<td>-XX:NumberOfGCLogFiles=3</td>
<td>Set the number of files to use when rotating logs, must be &gt;= 1. The rotated log files will use the following naming scheme, <code>&lt;filename&gt;</code>.0, <code>&lt;filename&gt;</code>.1, …, <code>&lt;filename&gt;</code>.n-1.</td>
</tr>
<tr>
<td>-XX:GCLogFileSize=8K</td>
<td>The size of the log file at which point the log will be rotated, must be &gt;= 8K.</td>
</tr>
<tr>
<td>-XX:ErrorFile=./hs_err_pid_%p.log</td>
<td>当 JVM 进程发生 Crash 的时候，会记录下相关的错误信息、信号信息、寄存器信息，以及内存分配情况等。其中 <code>%p</code> 是当前 JVM 进程的 pid 值。默认该日志会创建在当前 JVM 进程的工作目录下</td>
</tr>
</tbody>
</table>
</div>
<h5 id="实际效果"><a href="#实际效果" class="headerlink" title="实际效果"></a>实际效果</h5><h6 id="描述-2"><a href="#描述-2" class="headerlink" title="描述"></a>描述</h6><p>　以 <a href="https://yuzhouwan.com/posts/5845/">Apache Druid</a> 为例，在 Tranquility 组件启动时，加上 <code>-XX:+PrintTenuringDistribution</code> 参数后的效果如下：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ nohup ./bin/tranquility -J-XX:+HeapDumpOnOutOfMemoryError -J-XX:HeapDumpPath=/data02/druid/ -J-verbose:gc -J-XX:+PrintGCDetails -J-XX:+PrintGCDateStamps -J-XX:+PrintGCDetails -J-XX:+PrintTenuringDistribution -J-Xloggc:/data02/druid/gc.log -Ddruid.extensions.directory=/home/druid/software/druid/extensions -Ddruid.extensions.loadList=<span class="string">'["druid-avro-extensions"]'</span> kafka -configFile conf/service/hbase_metrics_kafka2_avro.json &gt; /home/druid/logs/tranquility/hbase_metrics_kafka2_avro.log 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment"># before</span></span><br><span class="line">2017-03-23T14:38:23.582+0800: 90.288: [GC (Allocation Failure) [PSYoungGen: 9934821K-&gt;5622K(10469376K)] 12602986K-&gt;7093554K(28291584K), 0.6114898 secs] [Times: user=13.74 sys=0.06, real=0.61 secs] </span><br><span class="line">2017-03-23T14:38:24.801+0800: 91.507: [GC (Allocation Failure) [PSYoungGen: 10071976K-&gt;3022K(10469376K)] 17159909K-&gt;8861529K(28291584K), 0.1748974 secs] [Times: user=3.91 sys=0.03, real=0.17 secs] </span><br><span class="line">2017-03-23T14:38:26.178+0800: 92.884: [GC (Allocation Failure) [PSYoungGen: 10303201K-&gt;3733K(10469376K)] 19161707K-&gt;9746931K(28291584K), 0.1744318 secs] [Times: user=3.89 sys=0.02, real=0.17 secs] </span><br><span class="line">2017-03-23T14:38:27.277+0800: 93.983: [GC (Allocation Failure) [PSYoungGen: 10091092K-&gt;902K(10469888K)] 19834290K-&gt;10628837K(28292096K), 0.1108355 secs] [Times: user=2.48 sys=0.01, real=0.12 secs] </span><br><span class="line">2017-03-23T14:38:28.586+0800: 95.292: [GC (Allocation Failure) [PSYoungGen: 10089131K-&gt;1078K(10472448K)] 20717066K-&gt;11513094K(28294656K), 0.1054663 secs] [Times: user=2.34 sys=0.01, real=0.11 secs] </span><br><span class="line">2017-03-23T14:38:29.840+0800: 96.546: [GC (Allocation Failure) [PSYoungGen: 10400114K-&gt;1501K(10461696K)] 21912131K-&gt;13281552K(28283904K), 0.1337201 secs] [Times: user=2.99 sys=0.01, real=0.13 secs] </span><br><span class="line">2017-03-23T14:38:30.865+0800: 97.571: [GC (Allocation Failure) [PSYoungGen: 10133038K-&gt;1099K(10472448K)] 23413089K-&gt;15049201K(28294656K), 0.1312707 secs] [Times: user=2.94 sys=0.02, real=0.13 secs] </span><br><span class="line">2017-03-23T14:38:30.996+0800: 97.702: [Full GC (Ergonomics) [PSYoungGen: 1099K-&gt;0K(10472448K)] [ParOldGen: 15048102K-&gt;1783009K(17664000K)] 15049201K-&gt;1783009K(28136448K), [Metaspace: 54341K-&gt;54341K(1095680K)], 0.3020992 secs] [Times: user=3.90 sys=0.00, real=0.31 secs]</span><br><span class="line"></span><br><span class="line"><span class="comment"># after</span></span><br><span class="line">2017-03-23T14:41:03.576+0800: 31.699: [GC (Allocation Failure) </span><br><span class="line">Desired survivor size 23592960 bytes, new threshold 1 (max 15)</span><br><span class="line">[PSYoungGen: 9975727K-&gt;6112K(10454016K)] 13540045K-&gt;6222293K(27026432K), 0.2530233 secs] [Times: user=5.67 sys=0.03, real=0.25 secs] </span><br><span class="line">2017-03-23T14:41:05.031+0800: 33.154: [GC (Allocation Failure) </span><br><span class="line">Desired survivor size 23592960 bytes, new threshold 1 (max 15)</span><br><span class="line">[PSYoungGen: 10241863K-&gt;11872K(10457088K)] 16458045K-&gt;8885401K(27029504K), 0.2811251 secs] [Times: user=6.27 sys=0.05, real=0.29 secs] </span><br><span class="line">2017-03-23T14:41:06.022+0800: 34.145: [GC (Allocation Failure) </span><br><span class="line">Desired survivor size 25165824 bytes, new threshold 1 (max 15)</span><br><span class="line">[PSYoungGen: 10378567K-&gt;15664K(10458624K)] 19252097K-&gt;10661383K(27031040K), 0.2552984 secs] [Times: user=5.70 sys=0.05, real=0.25 secs] </span><br><span class="line">2017-03-23T14:41:06.893+0800: 35.016: [GC (Allocation Failure) </span><br><span class="line">Desired survivor size 24117248 bytes, new threshold 1 (max 15)</span><br><span class="line">[PSYoungGen: 10054634K-&gt;10669K(10460160K)] 20700353K-&gt;12431545K(27032576K), 0.3152384 secs] [Times: user=6.89 sys=0.19, real=0.31 secs] </span><br><span class="line">2017-03-23T14:41:07.208+0800: 35.33</span><br><span class="line">1: [Full GC (Ergonomics) [PSYoungGen: 10669K-&gt;0K(10460160K)] [ParOldGen: 12420876K-&gt;1803376K(14484992K)] 12431545K-&gt;1803376K(24945152K), [Metaspace: 54185K-&gt;54185K(1095680K)], 0.2905749 secs] [Times: user=4.77 sys=0.00, real=0.29 secs] </span><br></pre></td></tr></tbody></table></figure>
<h4 id="内存方面"><a href="#内存方面" class="headerlink" title="内存方面"></a>内存方面</h4><h5 id="XX-AlwaysPreTouch"><a href="#XX-AlwaysPreTouch" class="headerlink" title="-XX:+AlwaysPreTouch"></a>-XX:+AlwaysPreTouch</h5><p>　<a href="https://yuzhouwan.com/posts/31915/#swappiness">Pre-touch</a> the Java heap during JVM initialization. Every page of the heap is thus demand-zeroed during initialization rather than incrementally during application execution.</p>
<h5 id="XX-UseStringDeduplication"><a href="#XX-UseStringDeduplication" class="headerlink" title="-XX:+UseStringDeduplication"></a>-XX:+UseStringDeduplication</h5><p>　在 JDK 1.7.0_6 版本之后，每个 String 对象内部都持有一个私有 <code>char[]</code> 数组。因为该数组没有暴露出来，所以 JVM 可以先判断两个 String 的内容是否一致，再将 <code>char[]</code> 替换成另一个字符串的 <code>char[]</code>。该特性在 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://openjdk.java.net/jeps/192">JDK 1.8.0_20</a> 版本中引入，但只有在 JVM 使用了 G1GC 的情况下，才可以开启。相关的还有两个参数，其一是 <code>-XX:StringDeduplicationAgeThreshold</code>（默认值：3，即多次 GC 后仍然存活的 String 对象），用来避免作用于生命周期短的字符串；其二是  <code>+PrintStringDeduplicationStatistics</code>，用来打印一些统计信息，以判断特性是否生效。最后，需要注意的是，该特性的执行是发生在 GC 过程中的，如果 String 去重率不高的话，有可能会得不偿失，反而导致 GC 时间变长</p>
<h4 id="启动方面"><a href="#启动方面" class="headerlink" title="启动方面"></a>启动方面</h4><h5 id="ea"><a href="#ea" class="headerlink" title="-ea"></a>-ea</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Usage:</span></span><br><span class="line">  -enableassertions[:&lt;packageName&gt;<span class="string">"..."</span> | :&lt;className&gt;]</span><br><span class="line">  -ea[:&lt;packageName&gt;<span class="string">"..."</span> | :&lt;className&gt;]</span><br><span class="line"></span><br><span class="line">  该参数用来设置 jvm 是否启动断言机制（从 JDK 1.4 开始支持），默认 JVM 是关闭断言机制的，增加 `-ea` 参数可打开断言机制</span><br><span class="line">  不指定 packageName 和 className 时运行所有包和类中的断言</span><br><span class="line">  如果希望只运行某些包或类中的断言，可将包名或类名加到 `-ea` 之后</span><br><span class="line">  比如想要启动包 `com.yuzhouwan.common` 下的断言机制，可用命令 `java -ea:com.yuzhouwan.common...&lt;Main Class&gt;`</span><br></pre></td></tr></tbody></table></figure>
<h3 id="实战技巧"><a href="#实战技巧" class="headerlink" title="实战技巧"></a>实战技巧</h3><h4 id="查看-JVM-参数的默认值"><a href="#查看-JVM-参数的默认值" class="headerlink" title="查看 JVM 参数的默认值"></a>查看 JVM 参数的默认值</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 JDK8 中是否默认打开了 “对象头压缩” 开关</span></span><br><span class="line"><span class="comment"># 实际上，JDK6u23 版本之后，Hotspot 都已经打开了 -XX:+UseCompressedOops 功能（OOP，Ordinary Object Pointer）</span></span><br><span class="line">$ java -XX:+PrintFlagsFinal -version | grep UseCompressedOops</span><br><span class="line">       bool UseCompressedOops                        := <span class="literal">true</span></span><br><span class="line">            {lp64_product}</span><br><span class="line">  java version <span class="string">"1.8.0_111"</span></span><br><span class="line">  Java(TM) SE Runtime Environment (build 1.8.0_111-b14)</span><br><span class="line">  Java HotSpot(TM) 64-Bit Server VM (build 25.111-b14, mixed mode)</span><br></pre></td></tr></tbody></table></figure>
<h4 id="查看-Java-进程的-JVM-参数"><a href="#查看-Java-进程的-JVM-参数" class="headerlink" title="查看 Java 进程的 JVM 参数"></a>查看 Java 进程的 JVM 参数</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ jcmd 666 VM.flags</span><br><span class="line">  666:</span><br><span class="line">  -XX:CICompilerCount=15 -XX:ConcGCThreads=6 -XX:G1HeapRegionSize=33554432 -XX:InitialHeapSize=197904039936 -XX:MarkStackSize=4194304 -XX:MaxGCPauseMillis=200 -XX:MaxHeapSize=197904039936 -XX:MaxNewSize=118715580416 -XX:MinHeapDeltaBytes=33554432 -XX:+PrintGC -XX:+PrintGCDateStamps -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+UseFastUnorderedTimeStamps -XX:+UseG1GC</span><br></pre></td></tr></tbody></table></figure>
<h4 id="堆内内存分析"><a href="#堆内内存分析" class="headerlink" title="堆内内存分析"></a>堆内内存分析</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ jmap -histo:live &lt;pid&gt; | less</span><br></pre></td></tr></tbody></table></figure>
<h4 id="堆外内存分析"><a href="#堆外内存分析" class="headerlink" title="堆外内存分析"></a>堆外内存分析</h4><h5 id="google-perftools"><a href="#google-perftools" class="headerlink" title="google-perftools"></a>google-perftools</h5><h6 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h6><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 先安装 g++</span></span><br><span class="line">$ yum -y install gcc gcc-c++</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 libunwind</span></span><br><span class="line">$ wget http://download.savannah.gnu.org/releases/libunwind/libunwind-0.99.tar.gz</span><br><span class="line">$ tar -xzvf libunwind-0.99.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> libunwind-0.99</span><br><span class="line">$ ./configure --prefix=/data0/java/deploy/google-perftools/<span class="built_in">local</span>/libunwind</span><br><span class="line">$ make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 gperftools</span></span><br><span class="line">$ wget https://github.com/gperftools/gperftools/releases/download/gperftools-2.5/gperftools-2.5.tar.gz</span><br><span class="line">$ tar -xzvf gperftools-2.5.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> gperftools-2.5</span><br><span class="line">$ ./configure --prefix=/data0/java/deploy/google-perftools/<span class="built_in">local</span>/gperftools-2.5/</span><br><span class="line">$ make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使配置生效</span></span><br><span class="line">$ vim /etc/ld.so.conf.d/usr_local_lib.conf</span><br><span class="line">  /data0/java/deploy/google-perftools/<span class="built_in">local</span>/libunwind/lib</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行 ldconfig 命令，使libunwind生效。 需要 sudo 权限</span></span><br><span class="line">$ /sbin/ldconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 tmp 目录</span></span><br><span class="line">$ mkdir -p /data0/java/deploy/google-perftools/<span class="built_in">local</span>/tmp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加入环境变量</span></span><br><span class="line"><span class="comment"># 不要加在 .bashrc 里面，放在 jvm 启动脚本里面即可</span></span><br><span class="line">  <span class="built_in">export</span> LD_PRELOAD=/data0/java/deploy/google-perftools/<span class="built_in">local</span>/gperftools-2.5/lib/libtcmalloc.so</span><br><span class="line">  <span class="built_in">export</span> HEAPPROFILE=/data0/java/deploy/google-perftools/<span class="built_in">local</span>/tmp/gzip</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 jvm 进程，就会在 /data0/java/deploy/google-perftools/local/ 目录下生成 heap 文件</span></span><br><span class="line">$ bin/hitsdb restart</span><br></pre></td></tr></tbody></table></figure>
<h6 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h6><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 分析函数调用</span></span><br><span class="line">$ /data0/java/deploy/google-perftools/<span class="built_in">local</span>/gperftools-2.5/bin/pprof --text /usr/<span class="built_in">local</span>/jdk1.8.0_181/bin/java /data0/java/deploy/google-perftools/<span class="built_in">local</span>/tmp/gzip.0001.heap</span><br><span class="line"></span><br><span class="line">  Using <span class="built_in">local</span> file /usr/<span class="built_in">local</span>/jdk1.8.0_181/bin/java.</span><br><span class="line">  Using <span class="built_in">local</span> file /data0/java/deploy/google-perftools/<span class="built_in">local</span>/tmp/gzip.0001.heap.</span><br><span class="line">  Total: 0.0 MB</span><br><span class="line">       0.0  87.9%  87.9%      0.0 100.0% __FRAME_END__</span><br><span class="line">       0.0   9.6%  97.5%      0.0   9.6% _nl_intern_locale_data</span><br><span class="line">       0.0   1.2%  98.7%      0.0   1.2% __gconv_lookup_cache</span><br><span class="line">       0.0   0.6%  99.3%      0.0   0.6% new_composite_name</span><br><span class="line">       0.0   0.3%  99.6%      0.0  10.0% _nl_load_locale_from_archive</span><br><span class="line">       0.0   0.2%  99.8%      0.0   0.2% __GI___strdup</span><br><span class="line">       0.0   0.1%  99.9%      0.0   1.3% __wcsmbs_load_conv</span><br><span class="line">       0.0   0.1% 100.0%      0.0   0.1% __bindtextdomain</span><br><span class="line">       0.0   0.0% 100.0%      0.0  10.7% __GI_setlocale</span><br><span class="line">       0.0   0.0% 100.0%      0.0   1.3% __btowc</span><br><span class="line">       0.0   0.0% 100.0%      0.0   1.2% __gconv_find_transform</span><br><span class="line">       0.0   0.0% 100.0%      0.0 100.0% __libc_start_main</span><br><span class="line">       0.0   0.0% 100.0%      0.0   0.0% __textdomain</span><br><span class="line">       0.0   0.0% 100.0%      0.0  10.0% _nl_find_locale</span><br></pre></td></tr></tbody></table></figure>
<h2 id="常用工具"><a href="#常用工具" class="headerlink" title="常用工具"></a>常用工具</h2><h3 id="JMC-监控报警工具（Java-Mission-Control）"><a href="#JMC-监控报警工具（Java-Mission-Control）" class="headerlink" title="JMC 监控报警工具（Java Mission Control）"></a>JMC 监控报警工具（Java Mission Control）</h3><p>　JMC 工具是 JDK 里面自带的，只需要运行 <code>jmc</code> 命令即可</p>
<p><img data-src="/picture/java/java_jvm_jmc_java_mission_control.png" alt></p>
<center>（对 <a href="https://www.oracle.com/technetwork/java/javaseproducts/mission-control/index.html" target="_blank" rel="external nofollow noopener noreferrer">JMC</a>™ 的截图）</center>


<h3 id="GCViewer"><a href="#GCViewer" class="headerlink" title="GCViewer"></a>GCViewer</h3><h4 id="安装-2"><a href="#安装-2" class="headerlink" title="安装"></a>安装</h4><p>　在 GCViewer 的<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/chewiebug/GCViewer/releases">下载页面</a>，找到当前最新版本 <a target="_blank" rel="external nofollow noopener noreferrer" href="http://sourceforge.net/projects/gcviewer/files/gcviewer-1.35.jar/download">gcviewer-1.35.jar</a> 进行下载</p>
<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 文件 gc.log 是由增加了 `-verbose:gc -XX:+PrintGCDetails -XX:+PrintGCDateStamps -Xloggc:/home/yuzhouwan/gc.log` 参数的 JVM 进程生成的 GC 日志</span></span><br><span class="line">$ java -jar gcviewer-1.35.jar gc.log</span><br></pre></td></tr></tbody></table></figure>
<h4 id="效果图"><a href="#效果图" class="headerlink" title="效果图"></a>效果图</h4><p><img data-src="/picture/java/java_jvm_gcviewer_throughput_100_percent.png" alt="JVM GCViewer"></p>
<center>（对 <a href="https://github.com/chewiebug/GCViewer" target="_blank" rel="external nofollow noopener noreferrer">GCViewer</a>™ 的截图）</center>



<h3 id="MAT-内存分析工具（Memory-Analyzer-Tool）"><a href="#MAT-内存分析工具（Memory-Analyzer-Tool）" class="headerlink" title="MAT 内存分析工具（Memory Analyzer Tool）"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.eclipse.org/mat/">MAT</a> 内存分析工具（Memory Analyzer Tool）</h3><h4 id="创建-dump-文件"><a href="#创建-dump-文件" class="headerlink" title="创建 dump 文件"></a>创建 dump 文件</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果指定 live 参数的话，将会在 dump 之前，强制进行一次 Full GC</span></span><br><span class="line">$ jmap -dump:[live,]format=b,file=&lt;file_name&gt;.hprof &lt;pid&gt;</span><br></pre></td></tr></tbody></table></figure>
<div class="note info">如果 hprof 文件过大，打开时可能会有 OOM 的报错，此时则需要修改 /Applications/mat.app/Contents/Eclipse/MemoryAnalyzer.ini 文件中的 -Xmx1024m 默认参数为 -Xmx4096m，并重启 MAT</div>
<div class="note info">通过 Window - Preferences - Memory Analyzer - Bytes Display 选项卡，可以设置字节占用的展示单位为 GB，默认为 Bytes</div>



<h3 id="火焰图"><a href="#火焰图" class="headerlink" title="火焰图"></a>火焰图</h3><h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>　火焰图是一个二维图片，火焰图的 <strong>X</strong> 轴代表<strong>采样总量</strong>，而 <strong>Y</strong> 轴代表<strong>栈深度</strong>。每个框就代表了一个栈里的函数，其宽度代表了所占用的 <strong>CPU 总时间</strong>。因此，比较宽的框就表示，该函数运行时间较慢或被调用次数较多，从而占用的 CPU 时间多</p>
<h4 id="以往获得火焰图所需要的复杂步骤"><a href="#以往获得火焰图所需要的复杂步骤" class="headerlink" title="以往获得火焰图所需要的复杂步骤"></a>以往获得火焰图所需要的复杂步骤</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line">$ yum install perf -y</span><br><span class="line">$ yum install gcc -y</span><br><span class="line">$ yum install gcc-c++</span><br><span class="line">$ yum install cmake -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 perf</span></span><br><span class="line">$ git <span class="built_in">clone</span> --depth=1 https://github.com/jrudolph/perf-map-agent</span><br><span class="line">$ <span class="built_in">cd</span> perf-map-agent</span><br><span class="line">$ cmake .</span><br><span class="line">$ make</span><br><span class="line">$ bin/create-links-in /usr/bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 FlameGraph</span></span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/brendangregg/FlameGraph.git</span><br><span class="line">$ <span class="built_in">export</span> FLAMEGRAPH_DIR=/root/git/FlameGraph</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动程序时，增加 JVM 参数 -XX:+PreserveFramePointer</span></span><br><span class="line">$ perf-java-flames &lt;pid&gt;</span><br></pre></td></tr></tbody></table></figure>
<h4 id="使用新版-JVM-Profile-功能之后一键搞定"><a href="#使用新版-JVM-Profile-功能之后一键搞定" class="headerlink" title="使用新版 JVM Profile 功能之后一键搞定"></a>使用新版 JVM Profile 功能之后一键搞定</h4><div class="note success">这里我们以 2018.3 版本为例，但只要是高于该版本的 IDEA 也都是默认支持的</div>


<p>　打开下载 Intellij Idea 下载页面，找到 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.jetbrains.com/idea/nextversion/">Coming in 2018.3</a>，然后下载 EAP 版本的 Intellij Idea</p>
<p><img data-src="/picture/java/java_intellij_2018_3_coming_in.png" alt></p>
<p>　打开项目后，使用快捷键 <code>⌘⌥⇧/</code> 打开 <code>Maintenance</code> 面板，选择 <code>Experimantal features</code>，勾选 <code>linux.native.menu</code> 和 <code>idea.profiler.enabled</code></p>
<p><img data-src="/picture/java/java_idea_profiler_enabled.png" alt></p>
<p>　使用 <code>Run xxx with Async Profiler</code> 执行任意程序</p>
<p><img data-src="/picture/java/java_run_with_async_profiler.png" alt></p>
<p>　即可获得火焰图、方法调用链、方法列表</p>
<p><img data-src="/picture/java/java_jvm_profiler.png" alt></p>
<center>（对 <a href="https://www.jetbrains.com/idea/" target="_blank" rel="external nofollow noopener noreferrer">Intellij IDEA</a>™ 的截图）</center>

<p><strong>火焰图</strong>，主要用于分析 CPU 性能消耗。可以交互式地分析 JVM 进程中所有线程的 CPU 消耗火焰图，也可以选择某一个线程来分析；<br><strong>方法调用链</strong>，可以找到在某个线程中，消耗 CPU 最多的方法<br><strong>方法列表</strong>，可以看到每个方法的调用次数，展开后还可以看到详细的调用栈</p>
<h3 id="序列化-ID-排查工具"><a href="#序列化-ID-排查工具" class="headerlink" title="序列化 ID 排查工具"></a>序列化 ID 排查工具</h3><h4 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">serialver [ options ] [ classnames ]</span><br><span class="line"></span><br><span class="line">  options</span><br><span class="line">    The <span class="built_in">command</span>-line options. See Options.</span><br><span class="line"></span><br><span class="line">  classnames</span><br><span class="line">    The classes <span class="keyword">for</span> <span class="built_in">which</span> the serialVersionUID is to be returned.</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Arthas-诊断工具"><a href="#Arthas-诊断工具" class="headerlink" title="Arthas 诊断工具"></a>Arthas 诊断工具</h3><h4 id="介绍-2"><a href="#介绍-2" class="headerlink" title="介绍"></a>介绍</h4><p><img data-src="/picture/java/java_arthas_logo.png" alt></p>
<center>（图片来源：<a href="https://github.com/alibaba/arthas/issues/371#issuecomment-457469188" target="_blank" rel="external nofollow noopener noreferrer">Arthas</a>™ 官网，已获得 Collaborator 的授权）</center>

<p>　如果你想要对线上运行的 JVM 进程进行逻辑或性能分析，但是此时如果进程本身重启很耗时，或者进程内存很大无法进行 Dump 操作，亦或是不想有任何的代码侵入，就统计出各个方法的调用次数和耗时，那么，Arthas 绝对是不二之选</p>
<h4 id="使用-2"><a href="#使用-2" class="headerlink" title="使用"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://arthas.aliyun.com/doc/quick-start.html">使用</a></h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ curl -O https://arthas.aliyun.com/arthas-boot.jar</span><br><span class="line">$ java -jar arthas-boot.jar</span><br></pre></td></tr></tbody></table></figure>
<h3 id="tsar-资源监控工具"><a href="#tsar-资源监控工具" class="headerlink" title="tsar 资源监控工具"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/alibaba/tsar">tsar</a> 资源监控工具</h3><h4 id="安装-3"><a href="#安装-3" class="headerlink" title="安装"></a>安装</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ wget -O tsar.zip https://github.com/alibaba/tsar/archive/master.zip --no-check-certificate</span><br><span class="line">$ unzip tsar.zip</span><br><span class="line">$ <span class="built_in">cd</span> tsar-master</span><br><span class="line">$ make</span><br><span class="line">$ make install</span><br></pre></td></tr></tbody></table></figure>
<h4 id="使用-3"><a href="#使用-3" class="headerlink" title="使用"></a>使用</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tsar -l -i 1</span><br></pre></td></tr></tbody></table></figure>
<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h3 id="编码相关"><a href="#编码相关" class="headerlink" title="编码相关"></a>编码相关</h3><h4 id="SimpleDateFormat-多线程安全问题"><a href="#SimpleDateFormat-多线程安全问题" class="headerlink" title="SimpleDateFormat 多线程安全问题"></a>SimpleDateFormat 多线程安全问题</h4><p>　不安全的主要原因是，SimpleDateFormat 继承的 DateTime 类，本身就是不安全的。而根本原因是 DateTime 的类属性中 <code>Calendar</code> 实例，并没有使用同步代码块进行多线程安全处理。如果在执行 <code>format(...)</code> 方法的同时，有其他线程调用 <code>setCalendar(Calendar newCalendar)</code> 方法，则会出现混乱。处理的方法有很多，除了在每次需要使用重新初始化 SimpleDateFormat 实例，另外还可使用 ThreadLocal 对其进行缓存，再或者使用 Joda-time 替换 Jdk 原生的 SimpleDateFormat 和 Java 8 里面的 DateTimeFormatter（注意别触发 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://bugs.java.com/view_bug.do?bug_id=JDK-8031085">JDK-8031085</a>，该问题在 JDK9 才修复），亦可</p>
<p>Tips: Full code is <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-hacker/src/test/java/com/yuzhouwan/hacker/joda/JodaTimeHaveATry.java">here</a> and <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-common/src/main/java/com/yuzhouwan/common/util/TimeUtils.java#L99">here</a>.</p>
<h4 id="java-lang-IllegalThreadStateException"><a href="#java-lang-IllegalThreadStateException" class="headerlink" title="java.lang.IllegalThreadStateException"></a>java.lang.IllegalThreadStateException</h4><p>　报错是因为 <code>Thread</code> 不可以使用 <code>start()</code> 启动多次，可以将逻辑放在 <code>Runnable</code> 对象中，每次启动的时候，再通过  <code>new Thread(runnable).start()</code> 初始化一个 <code>Thread</code> 对象来启动即可</p>
<h4 id="java-util-ConcurrentModificationException"><a href="#java-util-ConcurrentModificationException" class="headerlink" title="java.util.ConcurrentModificationException"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-hacker/src/test/java/com/yuzhouwan/hacker/algorithms/collection/FastFailTest.java">java.util.ConcurrentModificationException</a></h4><p>　对集合遍历的时候，同时执行了 remove 元素的操作，就会出现该问题。除了“通过一个临时集合保存需要删除的元素，在遍历结束后，执行 removeAll 进行清理”这种方案外，还可以通过 Iterator 直接进行 remove。后者虽然可以节省了新集合的内存消耗，但是却不能使用增强 for 循环的特性。具体如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Iterator&lt;String&gt; iterator = parameters.keySet().iterator();</span><br><span class="line">String key;</span><br><span class="line"><span class="keyword">while</span> (iterator.hasNext()) {</span><br><span class="line">    key = iterator.next();</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">"c"</span>.equals(key)) {</span><br><span class="line">        parameters.remove(key);</span><br><span class="line">    }</span><br><span class="line">    assertEquals(<span class="number">1</span>, parameters.size());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="取消数值的科学计数法"><a href="#取消数值的科学计数法" class="headerlink" title="取消数值的科学计数法"></a>取消数值的科学计数法</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 数值过大后，double、long 的 toString 可能会出现科学计数法</span></span><br><span class="line"><span class="comment">// 可以通过 NumberFormat 来解决</span></span><br><span class="line">NumberFormat nf = NumberFormat.getInstance();</span><br><span class="line">nf.setGroupingUsed(<span class="keyword">false</span>);</span><br><span class="line">nf.setMaximumFractionDigits(<span class="number">0</span>);</span><br><span class="line">nf.setMaximumIntegerDigits(<span class="number">64</span>);</span><br><span class="line"></span><br><span class="line">assertEquals(<span class="string">"1234567890123456789"</span>, nf.format(<span class="number">1234567890123456789L</span>));</span><br><span class="line">assertEquals(<span class="number">1234567890123456789L</span>, Long.valueOf(nf.format(<span class="number">1234567890123456789L</span>)).longValue());</span><br><span class="line"><span class="comment">// 或者转换 double 的字符串为 long</span></span><br><span class="line">assertEquals(<span class="number">0L</span>, Long.valueOf(nf.format(<span class="number">0.0</span>)).longValue());</span><br><span class="line"></span><br><span class="line">nf.setMaximumFractionDigits(<span class="number">64</span>);</span><br><span class="line">assertEquals(<span class="string">"0.12345678901234568"</span>, nf.format(<span class="number">0.1234567890_12345678D</span>));</span><br><span class="line">assertEquals(<span class="number">0.12345678901234568D</span>, Double.valueOf(nf.format(<span class="number">0.1234567890_12345678D</span>)), <span class="number">64</span>);</span><br></pre></td></tr></tbody></table></figure>
<h4 id="File-toURL-过期"><a href="#File-toURL-过期" class="headerlink" title="File#toURL 过期"></a>File#toURL 过期</h4><p>　使用 <code>file.toURI().toURL()</code> 替代</p>
<h4 id="Jersey-的-Produces-默认不设置-UTF-8-存在中文乱码"><a href="#Jersey-的-Produces-默认不设置-UTF-8-存在中文乱码" class="headerlink" title="Jersey 的 @Produces 默认不设置 UTF-8 存在中文乱码"></a>Jersey 的 @Produces 默认不设置 UTF-8 存在中文乱码</h4><h5 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h5><p>　实现 ContainerResponseFilter 接口，给 <code>@Produces</code> 注解增加 <code>charset=UTF-8</code> 属性</p>
<h5 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h5><h6 id="编码-MediaTypeFilter"><a href="#编码-MediaTypeFilter" class="headerlink" title="编码 MediaTypeFilter"></a>编码 MediaTypeFilter</h6><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.jersey.core.util.Priority;</span><br><span class="line"><span class="keyword">import</span> com.sun.jersey.spi.container.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.ws.rs.Priorities;</span><br><span class="line"><span class="keyword">import</span> javax.ws.rs.Produces;</span><br><span class="line"><span class="keyword">import</span> javax.ws.rs.core.MediaType;</span><br><span class="line"><span class="keyword">import</span> javax.ws.rs.ext.Provider;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Annotation;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Provider</span></span><br><span class="line"><span class="meta">@Priority(Priorities.HEADER_DECORATOR)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MediaTypeFilter</span> <span class="keyword">implements</span> <span class="title">ResourceFilter</span>, <span class="title">ContainerResponseFilter</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ContainerResponse <span class="title">filter</span><span class="params">(ContainerRequest request, ContainerResponse response)</span> </span>{</span><br><span class="line">        Annotation[] annotations = response.getAnnotations();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; annotations.length; i++) {</span><br><span class="line">            <span class="keyword">if</span> (!(annotations[i] <span class="keyword">instanceof</span> Produces)) {</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            }</span><br><span class="line">            Produces produces = (Produces) annotations[i];</span><br><span class="line">            String[] producesValues = produces.value();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; producesValues.length; j++) {</span><br><span class="line">                <span class="keyword">if</span> (!MediaType.APPLICATION_JSON.equals(producesValues[j]) &amp;&amp; !MediaType.TEXT_PLAIN.equals(producesValues[j])) {</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                }</span><br><span class="line">                producesValues[j] += <span class="string">";charset=UTF-8"</span>;</span><br><span class="line">            }</span><br><span class="line">            annotations[i] = produces;</span><br><span class="line">        }</span><br><span class="line">        response.setAnnotations(annotations);</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ContainerRequestFilter <span class="title">getRequestFilter</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ContainerResponseFilter <span class="title">getResponseFilter</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h6 id="在-BrokerResource-中使用"><a href="#在-BrokerResource-中使用" class="headerlink" title="在 BrokerResource 中使用"></a>在 BrokerResource 中使用</h6><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.google.common.collect.ImmutableMap;</span><br><span class="line"><span class="keyword">import</span> com.google.inject.Inject;</span><br><span class="line"><span class="keyword">import</span> com.sun.jersey.spi.container.ResourceFilters;</span><br><span class="line"><span class="keyword">import</span> org.apache.druid.client.BrokerServerView;</span><br><span class="line"><span class="keyword">import</span> org.apache.druid.server.http.security.StateResourceFilter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.ws.rs.GET;</span><br><span class="line"><span class="keyword">import</span> javax.ws.rs.Path;</span><br><span class="line"><span class="keyword">import</span> javax.ws.rs.Produces;</span><br><span class="line"><span class="keyword">import</span> javax.ws.rs.core.MediaType;</span><br><span class="line"><span class="keyword">import</span> javax.ws.rs.core.Response;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Path("/druid/broker/v1")</span></span><br><span class="line"><span class="meta">@ResourceFilters({StateResourceFilter.class, MediaTypeFilter.class})</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrokerResource</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> BrokerServerView brokerServerView;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Inject</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">BrokerResource</span><span class="params">(BrokerServerView brokerServerView)</span></span></span><br><span class="line"><span class="function">  </span>{</span><br><span class="line">    <span class="keyword">this</span>.brokerServerView = brokerServerView;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="meta">@GET</span></span><br><span class="line">  <span class="meta">@Path("/loadstatus")</span></span><br><span class="line">  <span class="meta">@Produces(MediaType.APPLICATION_JSON)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Response <span class="title">getLoadStatus</span><span class="params">()</span></span></span><br><span class="line"><span class="function">  </span>{</span><br><span class="line">    <span class="keyword">return</span> Response.ok(ImmutableMap.of(<span class="string">"inventoryInitialized"</span>, brokerServerView.isInitialized())).build();</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="FastJSON-默认将浮点型反序列化为-BigDecimal"><a href="#FastJSON-默认将浮点型反序列化为-BigDecimal" class="headerlink" title="FastJSON 默认将浮点型反序列化为 BigDecimal"></a>FastJSON 默认将浮点型反序列化为 BigDecimal</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 全局</span></span><br><span class="line">JSON.DEFAULT_PARSER_FEATURE &amp;= ~Feature.UseBigDecimal.getMask();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 局部</span></span><br><span class="line"><span class="keyword">int</span> disable = JSON.DEFAULT_PARSER_FEATURE &amp; ~Feature.UseBigDecimal.getMask();</span><br><span class="line">JSON.parseObject(json, clazz, disable);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当然也可以通过 JSON.DEFAULT_PARSER_FEATURE |= Feature.UseBigDecimal.getMask() 重新打开该特性</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="IDE-相关"><a href="#IDE-相关" class="headerlink" title="IDE 相关"></a>IDE 相关</h3><h4 id="Intellij-Idea-Code-Check-中设置行长度为-120，却仍然有一条虚线竖在-80"><a href="#Intellij-Idea-Code-Check-中设置行长度为-120，却仍然有一条虚线竖在-80" class="headerlink" title="[Intellij Idea] Code Check 中设置行长度为 120，却仍然有一条虚线竖在 80"></a>[Intellij Idea] Code Check 中设置行长度为 120，却仍然有一条虚线竖在 80</h4><p>　依次选择菜单 <code>Settings</code> - <code>Editor</code> - <code>Code Style</code> - <code>Java</code>，这时候可以将默认的 <code>Scheme</code> 设置成想要的方案，也可以在 <code>Wrapping  and Braces</code> 中修改 <code>Hard wrap at</code> 为 <code>120</code>，以达到想要的效果</p>
<h3 id="版本相关"><a href="#版本相关" class="headerlink" title="版本相关"></a>版本相关</h3><h4 id="Unsupported-major-minor-version-52-0"><a href="#Unsupported-major-minor-version-52-0" class="headerlink" title="Unsupported major.minor version 52.0"></a>Unsupported major.minor version 52.0</h4><p>　此类报错，是因为用低版本 JDK 去运行高版本的 Java 程序了</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>JDK 版本</th>
<th>Major Version Number</th>
</tr>
</thead>
<tbody>
<tr>
<td>Java SE 11</td>
<td>55</td>
</tr>
<tr>
<td>Java SE 10</td>
<td>54</td>
</tr>
<tr>
<td>Java SE 9</td>
<td>53</td>
</tr>
<tr>
<td>Java SE 8</td>
<td>52</td>
</tr>
<tr>
<td>Java SE 7</td>
<td>51</td>
</tr>
<tr>
<td>Java SE 6.0</td>
<td>50</td>
</tr>
<tr>
<td>Java SE 5.0</td>
<td>49</td>
</tr>
<tr>
<td>JDK 1.4</td>
<td>48</td>
</tr>
<tr>
<td>JDK 1.3</td>
<td>47</td>
</tr>
<tr>
<td>JDK 1.2</td>
<td>46</td>
</tr>
<tr>
<td>JDK 1.1</td>
<td>45</td>
</tr>
</tbody>
</table>
</div>
<h3 id="Maven-相关"><a href="#Maven-相关" class="headerlink" title="Maven 相关"></a>Maven 相关</h3><h4 id="需要正确地在-Maven-的-checkstyle-插件的-Regexp-正则中使用-XML-关键字"><a href="#需要正确地在-Maven-的-checkstyle-插件的-Regexp-正则中使用-XML-关键字" class="headerlink" title="需要正确地在 Maven 的 checkstyle 插件的 Regexp 正则中使用 XML 关键字"></a>需要正确地在 Maven 的 checkstyle 插件的 Regexp 正则中使用 XML 关键字</h4><p>　如果不对下面 5 个符号加 <code>\</code> 反斜杠转义的话，就需要使用 HTML 来表示</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>原始符号</th>
<th>含义</th>
<th>HTML</th>
</tr>
</thead>
<tbody>
<tr>
<td>$\lt$</td>
<td>小于</td>
<td><code>&amp;lt;</code></td>
</tr>
<tr>
<td>$\gt$</td>
<td>大于</td>
<td><code>&amp;gt;</code></td>
</tr>
<tr>
<td>&amp;</td>
<td>和</td>
<td><code>&amp;amp;</code></td>
</tr>
<tr>
<td>‘</td>
<td>单引号</td>
<td><code>&amp;apos;</code></td>
</tr>
<tr>
<td>“</td>
<td>双引号</td>
<td><code>&amp;quot;</code></td>
</tr>
</tbody>
</table>
</div>
<h3 id="LogBack-相关"><a href="#LogBack-相关" class="headerlink" title="LogBack 相关"></a>LogBack 相关</h3><h4 id="日志文件过大"><a href="#日志文件过大" class="headerlink" title="日志文件过大"></a>日志文件过大</h4><h5 id="描述-3"><a href="#描述-3" class="headerlink" title="描述"></a>描述</h5><p>　多个 JVM 进程将日志写入同一个日志文件中，导致按照文件大小切割的策略失效，<code>xxx.log.1</code> 会持续写下去，以至于磁盘被撑爆</p>
<h5 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h5><p>　在日志路径上增加 <code>${JVM_PREFIX}</code> 变量，并在不同的 JVM 启动的时候，通过 <code>-DJVM_PREFIX="process001"</code> 的方式传入，使得不同的 JVM 进程将日志写入各自的日志文件中</p>
<h3 id="配置相关"><a href="#配置相关" class="headerlink" title="配置相关"></a>配置相关</h3><h4 id="ConfigFactory-load-只能加载固定目录下的配置文件"><a href="#ConfigFactory-load-只能加载固定目录下的配置文件" class="headerlink" title="ConfigFactory.load() 只能加载固定目录下的配置文件"></a>ConfigFactory.load() 只能加载固定目录下的配置文件</h4><p>　对于 Java 开发而言，要实现加载配置文件的功能，一般都会选用 typesafe 下 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/lightbend/config">config</a> 框架，它具备纯 Java 源码和无任何外部依赖的优点。而调用 <code>ConfigFactory.load()</code> 方法只能加载 <code>src/main/resources</code> 下配置文件的问题。针对该问题，只需调用 <code>ConfigFactory.parseFile(new File("yuzhouwan.conf"))</code> 方法，即可指定其他任意位置的配置文件</p>
<h3 id="JVM-相关-1"><a href="#JVM-相关-1" class="headerlink" title="JVM 相关"></a>JVM 相关</h3><h4 id="Too-small-initial-heap"><a href="#Too-small-initial-heap" class="headerlink" title="Too small initial heap"></a>Too small initial heap</h4><p>　<code>-Xmx1024 -Xms512</code> 应改为 <code>-Xmx1024M -Xms512M</code></p>
<h4 id="定位-OOM"><a href="#定位-OOM" class="headerlink" title="定位 OOM"></a>定位 OOM</h4><p>　<code>-XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=xxx</code></p>
<h4 id="堆外内存使用不当，导致-OOM-问题"><a href="#堆外内存使用不当，导致-OOM-问题" class="headerlink" title="堆外内存使用不当，导致 OOM 问题"></a>堆外内存使用不当，导致 OOM 问题</h4><h5 id="描述-4"><a href="#描述-4" class="headerlink" title="描述"></a>描述</h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">java.lang.OutOfMemoryError: Direct buffer memory</span><br><span class="line">  at java.nio.Bits.reserveMemory(Bits.java:<span class="number">658</span>)</span><br><span class="line">  at java.nio.DirectByteBuffer.&lt;init&gt;(DirectByteBuffer.java:<span class="number">123</span>)</span><br><span class="line">  at java.nio.ByteBuffer.allocateDirect(ByteBuffer.java:<span class="number">311</span>)</span><br><span class="line">  at org.jboss.netty.channel.socket.nio.SocketReceiveBufferAllocator.newBuffer(SocketReceiveBufferAllocator.java:<span class="number">64</span>)</span><br><span class="line">  at org.jboss.netty.channel.socket.nio.SocketReceiveBufferAllocator.get(SocketReceiveBufferAllocator.java:<span class="number">41</span>)</span><br><span class="line">  at org.jboss.netty.channel.socket.nio.NioWorker.read(NioWorker.java:<span class="number">62</span>)</span><br><span class="line">  at org.jboss.netty.channel.socket.nio.AbstractNioWorker.process(AbstractNioWorker.java:<span class="number">108</span>)</span><br><span class="line">  at org.jboss.netty.channel.socket.nio.AbstractNioSelector.run(AbstractNioSelector.java:<span class="number">337</span>)</span><br><span class="line">  at org.jboss.netty.channel.socket.nio.AbstractNioWorker.run(AbstractNioWorker.java:<span class="number">89</span>)</span><br><span class="line">  at org.jboss.netty.channel.socket.nio.NioWorker.run(NioWorker.java:<span class="number">178</span>)</span><br><span class="line">  at org.jboss.netty.util.ThreadRenamingRunnable.run(ThreadRenamingRunnable.java:<span class="number">108</span>)</span><br><span class="line">  at org.jboss.netty.util.internal.DeadLockProofWorker$<span class="number">1.</span>run(DeadLockProofWorker.java:<span class="number">42</span>)</span><br><span class="line">  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1142</span>)</span><br><span class="line">  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">617</span>)</span><br><span class="line">  at java.lang.Thread.run(Thread.java:<span class="number">745</span>)</span><br></pre></td></tr></tbody></table></figure>
<h5 id="解决-1"><a href="#解决-1" class="headerlink" title="解决"></a>解决</h5><p>　升级 JDK 版本到 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://bugs.openjdk.java.net/browse/JDK-8147468">1.8u102+</a>，并使用 <code>-Djdk.nio.maxCachedBufferSize</code> 参数限制每个线程的 <code>DirectByteBuffer</code> 大小</p>
<div class="note info">该参数不支持 M、G 这些单位，只能填写数字，且单位为 Byte</div>
<div class="note info">该参数默认值是 Integer.MAX_VALUE</div>



<h4 id="G1GC-报错-To-space-Exhausted"><a href="#G1GC-报错-To-space-Exhausted" class="headerlink" title="G1GC 报错 To-space Exhausted"></a>G1GC 报错 To-space Exhausted</h4><h5 id="描述-5"><a href="#描述-5" class="headerlink" title="描述"></a>描述</h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018</span>-<span class="number">08</span>-<span class="number">12</span>T00:<span class="number">52</span>:<span class="number">36.255</span>+<span class="number">0800</span>: <span class="number">17308164.871</span>: [<span class="function">GC <span class="title">pause</span> <span class="params">(G1 Evacuation Pause)</span> <span class="params">(young)</span> <span class="params">(to-space exhausted)</span>, 2.3349764 secs]</span></span><br><span class="line"><span class="function">   [Parallel Time: 331.1 ms, GC Workers: 23]</span></span><br><span class="line"><span class="function">      [GC Worker <span class="title">Start</span> <span class="params">(ms)</span>: Min: 17308164872.2, Avg: 17308164872.3, Max: 17308164872.3, Diff: 0.2]</span></span><br><span class="line"><span class="function">      [Ext Root <span class="title">Scanning</span> <span class="params">(ms)</span>: Min: 0.7, Avg: 1.0, Max: 3.1, Diff: 2.4, Sum: 23.1]</span></span><br><span class="line"><span class="function">      [Update <span class="title">RS</span> <span class="params">(ms)</span>: Min: 56.3, Avg: 58.3, Max: 59.2, Diff: 2.9, Sum: 1341.8]</span></span><br><span class="line"><span class="function">         [Processed Buffers: Min: 75, Avg: 95.6, Max: 133, Diff: 58, Sum: 2199]</span></span><br><span class="line"><span class="function">      [Scan <span class="title">RS</span> <span class="params">(ms)</span>: Min: 0.8, Avg: 1.4, Max: 1.5, Diff: 0.7, Sum: 33.0]</span></span><br><span class="line"><span class="function">      [Code Root <span class="title">Scanning</span> <span class="params">(ms)</span>: Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.1]</span></span><br><span class="line"><span class="function">      [Object <span class="title">Copy</span> <span class="params">(ms)</span>: Min: 269.3, Avg: 269.5, Max: 269.8, Diff: 0.6, Sum: 6197.7]</span></span><br><span class="line"><span class="function">      [<span class="title">Termination</span> <span class="params">(ms)</span>: Min: 0.0, Avg: 0.4, Max: 0.6, Diff: 0.5, Sum: 9.3]</span></span><br><span class="line"><span class="function">         [Termination Attempts: Min: 1, Avg: 290.0, Max: 325, Diff: 324, Sum: 6669]</span></span><br><span class="line"><span class="function">      [GC Worker <span class="title">Other</span> <span class="params">(ms)</span>: Min: 0.0, Avg: 0.1, Max: 0.2, Diff: 0.2, Sum: 3.0]</span></span><br><span class="line"><span class="function">      [GC Worker <span class="title">Total</span> <span class="params">(ms)</span>: Min: 330.7, Avg: 330.8, Max: 331.0, Diff: 0.3, Sum: 7608.0]</span></span><br><span class="line"><span class="function">      [GC Worker <span class="title">End</span> <span class="params">(ms)</span>: Min: 17308165202.9, Avg: 17308165203.0, Max: 17308165203.1, Diff: 0.2]</span></span><br><span class="line"><span class="function">   [Code Root Fixup: 0.2 ms]</span></span><br><span class="line"><span class="function">   [Code Root Purge: 0.0 ms]</span></span><br><span class="line"><span class="function">   [Clear CT: 1.1 ms]</span></span><br><span class="line"><span class="function">   [Other: 2002.7 ms]</span></span><br><span class="line"><span class="function">      [Evacuation Failure: 779.0 ms]</span></span><br><span class="line"><span class="function">      [Choose CSet: 0.0 ms]</span></span><br><span class="line"><span class="function">      [Ref Proc: 1217.9 ms]</span></span><br><span class="line"><span class="function">      [Ref Enq: 1.6 ms]</span></span><br><span class="line"><span class="function">      [Redirty Cards: 0.8 ms]</span></span><br><span class="line"><span class="function">      [Humongous Register: 0.2 ms]</span></span><br><span class="line"><span class="function">      [Humongous Reclaim: 0.9 ms]</span></span><br><span class="line"><span class="function">      [Free CSet: 1.5 ms]</span></span><br><span class="line"><span class="function">   [Eden: 8520.0<span class="title">M</span><span class="params">(<span class="number">8520.0</span>M)</span>-&gt;0.0<span class="title">B</span><span class="params">(<span class="number">3536.0</span>M)</span> Survivors: 368.0M-&gt;440.0M Heap: 14.8<span class="title">G</span><span class="params">(<span class="number">16.0</span>G)</span>-&gt;10.4<span class="title">G</span><span class="params">(<span class="number">16.0</span>G)</span>]</span></span><br><span class="line"><span class="function"> [Times: user</span>=<span class="number">25.22</span> sys=<span class="number">0.29</span>, real=<span class="number">2.33</span> secs] </span><br></pre></td></tr></tbody></table></figure>
<h5 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h5><p>　在日志中看到类似 Evacuation Failure、To-space Exhausted 或者 To-space Overflow 这样的输出（取决于不同版本的 JVM，输出略有不同）。这是 G1GC 收集器在将某个需要垃圾回收的分区进行回收时，无法找到一个能将其中存活对象拷贝过去的空闲分区。这种情况被称为 Evacuation Failure，常常会引发 Full GC</p>
<h5 id="解决-2"><a href="#解决-2" class="headerlink" title="解决"></a>解决</h5><ol>
<li>增加 <code>-XX:G1ReservePercent</code> 选项的值（并相应增加总的堆大小），为<strong>目标空间</strong>增加预留内存量</li>
<li>将 <code>-XX:InitiatingHeapOccupancyPercent</code> 参数调低（默认值是45），可以使 G1GC 收集器更早开始 Mixed GC；但另一方面，会增加 GC 发生频率</li>
<li>提高 <code>-XX:ConcGCThreads</code> 的值，在 Mixed GC 阶段投入更多的并发线程，争取提高每次暂停的效率。但是此参数会占用一定的有效工作线程资源</li>
</ol>
<h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><h3 id="Doc"><a href="#Doc" class="headerlink" title="Doc"></a>Doc</h3><ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://tools.ietf.org/html/rfc5789">PATCH Method for HTTP</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.oracle.com/javase/8/docs/index.html">Java Platform Standard Edition 8 Documentation</a></li>
</ul>
<h3 id="Tool"><a href="#Tool" class="headerlink" title="Tool"></a>Tool</h3><ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="http://jd.benow.ca/">JD-GUI</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://abi-laboratory.pro/index.php?view=tracker&amp;lang=java">ABI Laboratory</a></li>
</ul>
<h3 id="Blog"><a href="#Blog" class="headerlink" title="Blog"></a>Blog</h3><ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="http://mail.openjdk.java.net/pipermail/openjfx-dev/2015-April/017063.html">Private APIs not usable in Java 9?</a><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">getTotalPhysicalMemorySize</span><span class="params">()</span> </span>{</span><br><span class="line">    com.sun.management.OperatingSystemMXBean os = (com.sun.management.OperatingSystemMXBean)</span><br><span class="line">            java.lang.management.ManagementFactory.getOperatingSystemMXBean();</span><br><span class="line">    <span class="keyword">return</span> os.getTotalPhysicalMemorySize();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt></a></td>
</tr>
</tbody>
</table>
</div>

    </div>

    
    
    
      
  <div class="popular-posts-header">相关文章</div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/200906/" rel="bookmark">Presto：分布式 SQL 查询引擎</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/190816/" rel="bookmark">Gradle 实战</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/2254/" rel="bookmark">Maven 高级玩法</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/190101/" rel="bookmark">程序员的 Mac 高效手册</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/5845/" rel="bookmark">Apache Druid：一款高效的 OLAP 引擎</a></div>
    </li>
  </ul>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Benedict Jin
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://yuzhouwan.com/posts/190413/" title="那些绕不过去的 Java 知识点">https://yuzhouwan.com/posts/190413/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-ND</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

        

  <div class="followme">
    <p>欢迎关注我的其它发布渠道</p>

    <div class="social-list">

        <div class="social-item">
          <a target="_blank" class="social-link" href="/wechat_channel.jpg">
            <span class="icon">
              <i class="fab fa-weixin"></i>
            </span>

            <span class="label">WeChat</span>
          </a>
        </div>

        <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
        </div>
    </div>
  </div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Maven/" rel="tag"># Maven</a>
              <a href="/tags/Java/" rel="tag"># Java</a>
              <a href="/tags/JVM/" rel="tag"># JVM</a>
              <a href="/tags/SPI/" rel="tag"># SPI</a>
              <a href="/tags/HttpRunner/" rel="tag"># HttpRunner</a>
              <a href="/tags/JMC/" rel="tag"># JMC</a>
              <a href="/tags/MAT/" rel="tag"># MAT</a>
              <a href="/tags/Arthas/" rel="tag"># Arthas</a>
              <a href="/tags/Jersey/" rel="tag"># Jersey</a>
              <a href="/tags/LogBack/" rel="tag"># LogBack</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/posts/190101/" rel="prev" title="程序员的 Mac 高效手册">
      <i class="fa fa-chevron-left"></i> 程序员的 Mac 高效手册
    </a></div>
      <div class="post-nav-item">
    <a href="/posts/666/" rel="next" title="Algorithm">
      Algorithm <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
      <div class="tabs tabs-comment">
        <ul class="nav-tabs">
            <li class="tab"><a href="#comment-gitalk">Gitalk：可用 Github 账号登录</a></li>
            <li class="tab"><a href="#comment-disqus">Disqus：海外</a></li>
            <li class="tab"><a href="#comment-valine">Valine：匿名</a></li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane gitalk" id="comment-gitalk">
              <div class="comments" id="gitalk-container"></div>
            </div>
            <div class="tab-pane disqus" id="comment-disqus">
              
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  
            </div>
            <div class="tab-pane valine" id="comment-valine">
              <div class="comments" id="valine-comments"></div>
            </div>
        </div>
      </div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B3%E4%BA%8E%E6%9C%AC%E6%96%87"><span class="nav-number">1.</span> <span class="nav-text">关于本文</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="nav-number">2.</span> <span class="nav-text">基础知识</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B3%A8%E8%A7%A3"><span class="nav-number">2.1.</span> <span class="nav-text">注解</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#GuardedBy"><span class="nav-number">2.1.1.</span> <span class="nav-text">GuardedBy</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#InterfaceStability"><span class="nav-number">2.1.2.</span> <span class="nav-text">InterfaceStability</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#InterfaceAudience"><span class="nav-number">2.1.3.</span> <span class="nav-text">InterfaceAudience</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#JsonIgnoreProperties"><span class="nav-number">2.1.4.</span> <span class="nav-text">JsonIgnoreProperties</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">2.2.</span> <span class="nav-text">序列化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#transient"><span class="nav-number">2.2.1.</span> <span class="nav-text">transient</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B1%BB%E4%B8%AD%E5%8C%85%E5%90%AB%E6%B2%A1%E6%9C%89%E5%AE%9E%E7%8E%B0-Serializable-%E6%8E%A5%E5%8F%A3%E7%9A%84%E5%AD%97%E6%AE%B5"><span class="nav-number">2.2.2.</span> <span class="nav-text">类中包含没有实现 Serializable 接口的字段</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E7%94%A8%E6%8A%80%E5%B7%A7"><span class="nav-number">3.</span> <span class="nav-text">实用技巧</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Collection-%E5%86%85%E5%85%83%E7%B4%A0%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2"><span class="nav-number">3.1.</span> <span class="nav-text">Collection 内元素类型转换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E5%90%88%E7%9A%84%E5%B7%AE%E9%9B%86%E3%80%81%E4%BA%A4%E9%9B%86%E3%80%81%E5%B9%B6%E9%9B%86"><span class="nav-number">3.2.</span> <span class="nav-text">集合的差集、交集、并集</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E7%BB%84%E8%BD%AC%E4%B8%BA-Set"><span class="nav-number">3.3.</span> <span class="nav-text">数组转为 Set</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TransmittableThreadLocal-%E8%A7%A3%E5%86%B3%E8%B7%A8%E7%88%B6%E5%AD%90%E7%BA%BF%E7%A8%8B%E5%92%8C%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%BC%93%E5%AD%98%E9%97%AE%E9%A2%98"><span class="nav-number">3.4.</span> <span class="nav-text">TransmittableThreadLocal 解决跨父子线程和线程池缓存问题</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%96%E7%A0%81"><span class="nav-number">3.4.1.</span> <span class="nav-text">编码</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%A1%E7%AE%97%E4%B8%AD%E4%BD%8D%E6%95%B0"><span class="nav-number">3.5.</span> <span class="nav-text">计算中位数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Shutdown-Hook"><span class="nav-number">3.6.</span> <span class="nav-text">Shutdown Hook</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%8F%E8%BF%B0"><span class="nav-number">3.6.1.</span> <span class="nav-text">描述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%96%E7%A0%81-1"><span class="nav-number">3.6.2.</span> <span class="nav-text">编码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95"><span class="nav-number">3.6.3.</span> <span class="nav-text">测试</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SPI-%E8%A7%A3%E8%80%A6"><span class="nav-number">3.7.</span> <span class="nav-text">SPI 解耦</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89"><span class="nav-number">3.7.1.</span> <span class="nav-text">定义</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B"><span class="nav-number">3.7.2.</span> <span class="nav-text">示例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%89%B9%E6%80%A7"><span class="nav-number">3.7.3.</span> <span class="nav-text">特性</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%81%BF%E5%85%8D%E4%BD%BF%E7%94%A8-Properties-%E7%9A%84-put-%E5%92%8C-putAll-%E6%96%B9%E6%B3%95"><span class="nav-number">3.8.</span> <span class="nav-text">避免使用 Properties 的 put 和 putAll 方法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%AF%E8%AF%BB%E6%80%A7"><span class="nav-number">4.</span> <span class="nav-text">可读性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%AD%94%E6%B3%95%E6%95%B0%E5%AD%97"><span class="nav-number">4.1.</span> <span class="nav-text">魔法数字</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%8D%E9%9D%A2%E7%A4%BA%E4%BE%8B"><span class="nav-number">4.1.1.</span> <span class="nav-text">反面示例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A3%E9%9D%A2%E7%A4%BA%E4%BE%8B"><span class="nav-number">4.1.2.</span> <span class="nav-text">正面示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%88%A4%E7%A9%BA"><span class="nav-number">4.2.</span> <span class="nav-text">字符串判空</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%8D%E9%9D%A2%E7%A4%BA%E4%BE%8B-1"><span class="nav-number">4.2.1.</span> <span class="nav-text">反面示例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A3%E9%9D%A2%E7%A4%BA%E4%BE%8B-1"><span class="nav-number">4.2.2.</span> <span class="nav-text">正面示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%AD%E5%A4%B4%E5%9E%8B%E4%BB%A3%E7%A0%81"><span class="nav-number">4.3.</span> <span class="nav-text">箭头型代码</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%8D%E9%9D%A2%E7%A4%BA%E4%BE%8B-2"><span class="nav-number">4.3.1.</span> <span class="nav-text">反面示例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A3%E9%9D%A2%E7%A4%BA%E4%BE%8B-2"><span class="nav-number">4.3.2.</span> <span class="nav-text">正面示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B"><span class="nav-number">4.4.</span> <span class="nav-text">函数式编程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Optional"><span class="nav-number">4.4.1.</span> <span class="nav-text">Optional</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8F%8D%E9%9D%A2%E7%A4%BA%E4%BE%8B-3"><span class="nav-number">4.4.1.1.</span> <span class="nav-text">反面示例</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%AD%A3%E9%9D%A2%E7%A4%BA%E4%BE%8B-3"><span class="nav-number">4.4.1.2.</span> <span class="nav-text">正面示例</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#anyMatch"><span class="nav-number">4.4.2.</span> <span class="nav-text">anyMatch</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8F%8D%E9%9D%A2%E7%A4%BA%E4%BE%8B-4"><span class="nav-number">4.4.2.1.</span> <span class="nav-text">反面示例</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%AD%A3%E9%9D%A2%E7%A4%BA%E4%BE%8B-4"><span class="nav-number">4.4.2.2.</span> <span class="nav-text">正面示例</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#list-%E5%8E%BB%E9%87%8D%E7%BB%9F%E8%AE%A1"><span class="nav-number">4.4.3.</span> <span class="nav-text">list 去重统计</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8F%8D%E9%9D%A2%E7%A4%BA%E4%BE%8B-5"><span class="nav-number">4.4.3.1.</span> <span class="nav-text">反面示例</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%AD%A3%E9%9D%A2%E7%A4%BA%E4%BE%8B-5"><span class="nav-number">4.4.3.2.</span> <span class="nav-text">正面示例</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B5%8C%E5%A5%97-list-%E9%81%8D%E5%8E%86%E6%B1%82%E5%92%8C"><span class="nav-number">4.4.4.</span> <span class="nav-text">嵌套 list 遍历求和</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%AD%A3%E9%9D%A2%E7%A4%BA%E4%BE%8B-6"><span class="nav-number">4.4.4.1.</span> <span class="nav-text">正面示例</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F"><span class="nav-number">5.</span> <span class="nav-text">设计模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%95%E4%B8%80%E5%8A%9F%E8%83%BD%E5%8E%9F%E5%88%99"><span class="nav-number">5.1.</span> <span class="nav-text">单一功能原则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%80%E9%97%AD%E5%8E%9F%E5%88%99"><span class="nav-number">5.2.</span> <span class="nav-text">开闭原则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%87%8C%E6%B0%8F%E6%9B%BF%E6%8D%A2%E5%8E%9F%E5%88%99"><span class="nav-number">5.3.</span> <span class="nav-text">里氏替换原则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%A5%E5%8F%A3%E9%9A%94%E7%A6%BB%E5%8E%9F%E5%88%99"><span class="nav-number">5.4.</span> <span class="nav-text">接口隔离原则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BE%9D%E8%B5%96%E5%8F%8D%E8%BD%AC%E5%8E%9F%E5%88%99"><span class="nav-number">5.5.</span> <span class="nav-text">依赖反转原则</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="nav-number">6.</span> <span class="nav-text">性能优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B7%A5%E5%85%B7%E5%B1%82%E9%9D%A2"><span class="nav-number">6.1.</span> <span class="nav-text">工具层面</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87%E7%9B%91%E6%8E%A7"><span class="nav-number">6.1.1.</span> <span class="nav-text">性能指标监控</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#JMH-%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95"><span class="nav-number">6.1.2.</span> <span class="nav-text">JMH 基准测试</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%A2%9E%E5%8A%A0-Maven-%E4%BE%9D%E8%B5%96"><span class="nav-number">6.1.2.1.</span> <span class="nav-text">增加 Maven 依赖</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%BC%96%E5%86%99-JMH-%E6%B5%8B%E8%AF%95%E6%A1%88%E4%BE%8B"><span class="nav-number">6.1.2.2.</span> <span class="nav-text">编写 JMH 测试案例</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BC%98%E5%8A%BF"><span class="nav-number">6.1.2.3.</span> <span class="nav-text">优势</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#BTrace"><span class="nav-number">6.1.3.</span> <span class="nav-text">BTrace</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#LooseJar"><span class="nav-number">6.1.4.</span> <span class="nav-text">LooseJar</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BB%8B%E7%BB%8D"><span class="nav-number">6.1.4.1.</span> <span class="nav-text">介绍</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%AD%A5%E9%AA%A4"><span class="nav-number">6.1.4.2.</span> <span class="nav-text">使用步骤</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E7%A0%81%E5%B1%82%E9%9D%A2"><span class="nav-number">6.2.</span> <span class="nav-text">编码层面</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B9%B6%E5%8F%91%E7%9B%B8%E5%85%B3"><span class="nav-number">6.2.1.</span> <span class="nav-text">并发相关</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#synchronized"><span class="nav-number">6.2.1.1.</span> <span class="nav-text">synchronized</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#StampedLock"><span class="nav-number">6.2.1.2.</span> <span class="nav-text">StampedLock</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9B%86%E5%90%88%E4%BC%98%E5%8C%96"><span class="nav-number">6.2.2.</span> <span class="nav-text">集合优化</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#HashMap"><span class="nav-number">6.2.2.1.</span> <span class="nav-text">HashMap</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88-Java-8-%E7%89%88%E6%9C%AC%E4%B8%AD%E5%BC%95%E5%85%A5%E7%BA%A2%E9%BB%91%E6%A0%91"><span class="nav-number">6.2.2.1.1.</span> <span class="nav-text">为什么 Java 8 版本中引入红黑树</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Collections-%E7%B1%BB"><span class="nav-number">6.2.2.2.</span> <span class="nav-text">Collections 类</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%A9%BA%E9%9B%86%E5%90%88"><span class="nav-number">6.2.2.2.1.</span> <span class="nav-text">空集合</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%8D%95%E5%85%83%E7%B4%A0"><span class="nav-number">6.2.2.2.2.</span> <span class="nav-text">单元素</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#LinkedList-vs-ArrayList-vs-ArrayDeque"><span class="nav-number">6.2.2.3.</span> <span class="nav-text">LinkedList vs ArrayList vs ArrayDeque</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#java-util-Random-vs-java-util-concurrent-ThreadLocalRandom-vs-java-util-SplittableRandom"><span class="nav-number">6.2.2.4.</span> <span class="nav-text">java.util.Random vs java.util.concurrent.ThreadLocalRandom vs java.util.SplittableRandom</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#contains-%E6%96%B9%E6%B3%95"><span class="nav-number">6.2.2.5.</span> <span class="nav-text">contains 方法</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#HashSet"><span class="nav-number">6.2.2.5.1.</span> <span class="nav-text">HashSet</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#toArray-%E6%96%B9%E6%B3%95"><span class="nav-number">6.2.2.6.</span> <span class="nav-text">toArray 方法</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%AF%B4%E6%98%8E"><span class="nav-number">6.2.2.6.1.</span> <span class="nav-text">说明</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%8E%8B%E6%B5%8B"><span class="nav-number">6.2.2.6.2.</span> <span class="nav-text">压测</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#instanceof"><span class="nav-number">6.2.2.7.</span> <span class="nav-text">instanceof</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9B%B8%E5%85%B3"><span class="nav-number">6.2.3.</span> <span class="nav-text">字符串相关</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#repeat"><span class="nav-number">6.2.3.1.</span> <span class="nav-text">repeat</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Fork-Join-%E6%80%9D%E6%83%B3"><span class="nav-number">6.2.4.</span> <span class="nav-text">Fork &#x2F; Join 思想</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Memoization"><span class="nav-number">6.2.5.</span> <span class="nav-text">Memoization</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A0%86%E6%A0%88%E4%BC%98%E5%8C%96"><span class="nav-number">6.2.6.</span> <span class="nav-text">堆栈优化</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ByteBuffer"><span class="nav-number">6.2.6.1.</span> <span class="nav-text">ByteBuffer</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%8D%E8%BF%90%E7%AE%97"><span class="nav-number">6.2.7.</span> <span class="nav-text">位运算</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%A5%87%E5%81%B6%E6%95%B0"><span class="nav-number">6.2.7.1.</span> <span class="nav-text">奇偶数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%AF%AB%E7%A7%92"><span class="nav-number">6.2.7.2.</span> <span class="nav-text">毫秒</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%97%B6%E9%97%B4%E6%88%B3"><span class="nav-number">6.2.8.</span> <span class="nav-text">时间戳</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%BA%E5%BC%95%E7%94%A8-vs-%E8%BD%AF%E5%BC%95%E7%94%A8-vs-%E5%BC%B1%E5%BC%95%E7%94%A8-vs-%E8%99%9A%E5%BC%95%E7%94%A8"><span class="nav-number">6.2.9.</span> <span class="nav-text">强引用 vs 软引用 vs 弱引用 vs 虚引用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E7%9B%B8%E5%85%B3"><span class="nav-number">7.</span> <span class="nav-text">测试相关</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%82%E6%95%B0%E9%A9%B1%E5%8A%A8"><span class="nav-number">7.1.</span> <span class="nav-text">参数驱动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95"><span class="nav-number">7.2.</span> <span class="nav-text">自动化测试</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#HttpRunner"><span class="nav-number">7.2.1.</span> <span class="nav-text">HttpRunner</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BB%8B%E7%BB%8D-1"><span class="nav-number">7.2.1.1.</span> <span class="nav-text">介绍</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#QuickStart"><span class="nav-number">7.2.1.2.</span> <span class="nav-text">QuickStart</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%AE%89%E8%A3%85"><span class="nav-number">7.2.1.2.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8-Flask"><span class="nav-number">7.2.1.2.2.</span> <span class="nav-text">启动 Flask</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95-1"><span class="nav-number">7.2.1.2.3.</span> <span class="nav-text">测试</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%96%B0%E5%BB%BA%E6%B5%8B%E8%AF%95%E9%A1%B9%E7%9B%AE"><span class="nav-number">7.2.1.3.</span> <span class="nav-text">新建测试项目</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95"><span class="nav-number">7.2.1.4.</span> <span class="nav-text">性能测试</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2"><span class="nav-number">7.2.1.4.1.</span> <span class="nav-text">环境部署</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E9%99%90%E6%B5%81"><span class="nav-number">7.2.1.4.2.</span> <span class="nav-text">测试限流</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%8A%93%E5%8C%85%E5%B9%B6%E8%BD%AC%E4%B8%BA-TestCase"><span class="nav-number">7.2.1.5.</span> <span class="nav-text">抓包并转为 TestCase</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-Charles-%E6%8A%93%E5%8C%85%E5%B7%A5%E5%85%B7"><span class="nav-number">7.2.1.5.1.</span> <span class="nav-text">使用 Charles 抓包工具</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-browsermobproxy-%E4%BB%A3%E7%90%86%E5%BA%93"><span class="nav-number">7.2.1.5.2.</span> <span class="nav-text">使用 browsermobproxy 代理库</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BA%8C%E6%AC%A1%E5%BC%80%E5%8F%91"><span class="nav-number">7.2.1.6.</span> <span class="nav-text">二次开发</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3-http-runner-%E4%B8%AD%E5%8F%AA%E8%83%BD%E8%A7%A3%E6%9E%90%E9%83%A8%E5%88%86-parameters-%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">7.2.1.6.1.</span> <span class="nav-text">解决 http_runner 中只能解析部分 parameters 的问题</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E4%BD%BF%E5%BE%97-har2case-%E6%94%AF%E6%8C%81-list-%E7%BB%93%E6%9E%84%E7%9A%84-JSON"><span class="nav-number">7.2.1.6.2.</span> <span class="nav-text">使得 har2case 支持 list 结构的 JSON</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E4%BD%BF%E5%BE%97-har2case-%E6%94%AF%E6%8C%81%E6%99%AE%E9%80%9A%E6%96%87%E6%9C%AC%E7%9A%84%E8%BF%94%E5%9B%9E%E7%B1%BB%E5%9E%8B"><span class="nav-number">7.2.1.6.3.</span> <span class="nav-text">使得 har2case 支持普通文本的返回类型</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E4%BD%BF%E4%BA%8C%E6%AC%A1%E5%BC%80%E5%8F%91%E7%9A%84%E6%94%B9%E5%8A%A8%E7%94%9F%E6%95%88"><span class="nav-number">7.2.1.6.4.</span> <span class="nav-text">使二次开发的改动生效</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8F%AF%E8%A7%86%E5%8C%96%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F"><span class="nav-number">7.2.1.7.</span> <span class="nav-text">可视化管理系统</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2"><span class="nav-number">7.2.1.7.1.</span> <span class="nav-text">部署</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%8F%AF%E8%A7%86%E5%8C%96%E7%AE%A1%E7%90%86%E9%A1%B5%E9%9D%A2"><span class="nav-number">7.2.1.7.2.</span> <span class="nav-text">可视化管理页面</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%B8%A9%E5%88%B0%E7%9A%84%E5%9D%91"><span class="nav-number">7.2.1.8.</span> <span class="nav-text">踩到的坑</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#MySQL-%E9%BB%98%E8%AE%A4%E7%BC%96%E7%A0%81%E5%AF%BC%E8%87%B4-Django-%E6%8A%A5%E9%94%99-OperationalError"><span class="nav-number">7.2.1.8.1.</span> <span class="nav-text">MySQL 默认编码导致 Django 报错 OperationalError</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JVM-%E7%9B%B8%E5%85%B3"><span class="nav-number">8.</span> <span class="nav-text">JVM 相关</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="nav-number">8.1.</span> <span class="nav-text">基本概念</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A0%86%E5%86%85-vs-%E5%A0%86%E5%A4%96"><span class="nav-number">8.1.1.</span> <span class="nav-text">堆内 vs 堆外</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%A0%86%E5%86%85%E5%86%85%E5%AD%98"><span class="nav-number">8.1.1.1.</span> <span class="nav-text">堆内内存</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%A0%86%E5%A4%96%E5%86%85%E5%AD%98"><span class="nav-number">8.1.1.2.</span> <span class="nav-text">堆外内存</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%A0%86%E5%A4%96%E5%86%85%E5%AD%98%E7%9A%84%E4%BC%98%E5%8A%BF"><span class="nav-number">8.1.1.3.</span> <span class="nav-text">堆外内存的优势</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%A0%86%E5%A4%96%E5%86%85%E5%AD%98%E7%9A%84%E5%8A%A3%E5%8A%BF"><span class="nav-number">8.1.1.4.</span> <span class="nav-text">堆外内存的劣势</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B-1"><span class="nav-number">8.1.1.5.</span> <span class="nav-text">示例</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8C%87%E9%92%88%E5%8E%8B%E7%BC%A9"><span class="nav-number">8.1.2.</span> <span class="nav-text">指针压缩</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89-1"><span class="nav-number">8.1.2.1.</span> <span class="nav-text">定义</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B5%81%E7%A8%8B"><span class="nav-number">8.1.2.2.</span> <span class="nav-text">流程</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8E%9F%E7%90%86"><span class="nav-number">8.1.2.3.</span> <span class="nav-text">原理</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%8F%8F%E8%BF%B0-1"><span class="nav-number">8.1.2.3.1.</span> <span class="nav-text">描述</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%8E%8B%E7%BC%A9%E6%8C%87%E4%BB%A4%E4%BC%AA%E7%A0%81"><span class="nav-number">8.1.2.3.2.</span> <span class="nav-text">压缩指令伪码</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%9B%B6%E5%9F%BA%E5%8E%8B%E7%BC%A9%E4%BC%98%E5%8C%96%EF%BC%88Zero-Based-Compressd-Oops%EF%BC%89"><span class="nav-number">8.1.2.4.</span> <span class="nav-text">零基压缩优化（Zero Based Compressd Oops）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">8.1.2.5.</span> <span class="nav-text">适用场景</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8F%82%E6%95%B0%E6%8E%A7%E5%88%B6"><span class="nav-number">8.1.2.6.</span> <span class="nav-text">参数控制</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%9B%B6%E5%9F%BA%E5%8E%8B%E7%BC%A9%E7%9A%84%E8%BE%B9%E7%95%8C"><span class="nav-number">8.1.2.7.</span> <span class="nav-text">零基压缩的边界</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8E%8B%E7%BC%A9-class-%E4%BF%A1%E6%81%AF%E4%B8%AD%E7%9A%84%E6%8C%87%E9%92%88"><span class="nav-number">8.1.2.8.</span> <span class="nav-text">压缩 class 信息中的指针</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8-Collector"><span class="nav-number">8.2.</span> <span class="nav-text">常用 Collector</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#CMS"><span class="nav-number">8.2.1.</span> <span class="nav-text">CMS</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89-2"><span class="nav-number">8.2.1.1.</span> <span class="nav-text">定义</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E7%A2%8E%E7%89%87"><span class="nav-number">8.2.1.2.</span> <span class="nav-text">内存碎片</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B5%AE%E5%8A%A8%E5%9E%83%E5%9C%BE"><span class="nav-number">8.2.1.3.</span> <span class="nav-text">浮动垃圾</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E5%8F%82%E6%95%B0"><span class="nav-number">8.3.</span> <span class="nav-text">常用参数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%BB%98%E8%AE%A4%E9%85%8D%E7%BD%AE"><span class="nav-number">8.3.1.</span> <span class="nav-text">默认配置</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Xss-%E5%A0%86%E6%A0%88%E5%A4%A7%E5%B0%8F"><span class="nav-number">8.3.1.1.</span> <span class="nav-text">-Xss 堆栈大小</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%97%A5%E5%BF%97%E6%96%B9%E9%9D%A2"><span class="nav-number">8.3.2.</span> <span class="nav-text">日志方面</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E7%9A%84%E9%85%8D%E7%BD%AE%E9%A1%B9"><span class="nav-number">8.3.2.1.</span> <span class="nav-text">常用的配置项</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%9E%E9%99%85%E6%95%88%E6%9E%9C"><span class="nav-number">8.3.2.2.</span> <span class="nav-text">实际效果</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%8F%8F%E8%BF%B0-2"><span class="nav-number">8.3.2.2.1.</span> <span class="nav-text">描述</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E6%96%B9%E9%9D%A2"><span class="nav-number">8.3.3.</span> <span class="nav-text">内存方面</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#XX-AlwaysPreTouch"><span class="nav-number">8.3.3.1.</span> <span class="nav-text">-XX:+AlwaysPreTouch</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#XX-UseStringDeduplication"><span class="nav-number">8.3.3.2.</span> <span class="nav-text">-XX:+UseStringDeduplication</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E6%96%B9%E9%9D%A2"><span class="nav-number">8.3.4.</span> <span class="nav-text">启动方面</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ea"><span class="nav-number">8.3.4.1.</span> <span class="nav-text">-ea</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E6%88%98%E6%8A%80%E5%B7%A7"><span class="nav-number">8.4.</span> <span class="nav-text">实战技巧</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B-JVM-%E5%8F%82%E6%95%B0%E7%9A%84%E9%BB%98%E8%AE%A4%E5%80%BC"><span class="nav-number">8.4.1.</span> <span class="nav-text">查看 JVM 参数的默认值</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B-Java-%E8%BF%9B%E7%A8%8B%E7%9A%84-JVM-%E5%8F%82%E6%95%B0"><span class="nav-number">8.4.2.</span> <span class="nav-text">查看 Java 进程的 JVM 参数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A0%86%E5%86%85%E5%86%85%E5%AD%98%E5%88%86%E6%9E%90"><span class="nav-number">8.4.3.</span> <span class="nav-text">堆内内存分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A0%86%E5%A4%96%E5%86%85%E5%AD%98%E5%88%86%E6%9E%90"><span class="nav-number">8.4.4.</span> <span class="nav-text">堆外内存分析</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#google-perftools"><span class="nav-number">8.4.4.1.</span> <span class="nav-text">google-perftools</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-1"><span class="nav-number">8.4.4.1.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%88%86%E6%9E%90"><span class="nav-number">8.4.4.1.2.</span> <span class="nav-text">分析</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7"><span class="nav-number">9.</span> <span class="nav-text">常用工具</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#JMC-%E7%9B%91%E6%8E%A7%E6%8A%A5%E8%AD%A6%E5%B7%A5%E5%85%B7%EF%BC%88Java-Mission-Control%EF%BC%89"><span class="nav-number">9.1.</span> <span class="nav-text">JMC 监控报警工具（Java Mission Control）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GCViewer"><span class="nav-number">9.2.</span> <span class="nav-text">GCViewer</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-2"><span class="nav-number">9.2.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8"><span class="nav-number">9.2.2.</span> <span class="nav-text">使用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%88%E6%9E%9C%E5%9B%BE"><span class="nav-number">9.2.3.</span> <span class="nav-text">效果图</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MAT-%E5%86%85%E5%AD%98%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%EF%BC%88Memory-Analyzer-Tool%EF%BC%89"><span class="nav-number">9.3.</span> <span class="nav-text">MAT 内存分析工具（Memory Analyzer Tool）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA-dump-%E6%96%87%E4%BB%B6"><span class="nav-number">9.3.1.</span> <span class="nav-text">创建 dump 文件</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%81%AB%E7%84%B0%E5%9B%BE"><span class="nav-number">9.4.</span> <span class="nav-text">火焰图</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B"><span class="nav-number">9.4.1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%A5%E5%BE%80%E8%8E%B7%E5%BE%97%E7%81%AB%E7%84%B0%E5%9B%BE%E6%89%80%E9%9C%80%E8%A6%81%E7%9A%84%E5%A4%8D%E6%9D%82%E6%AD%A5%E9%AA%A4"><span class="nav-number">9.4.2.</span> <span class="nav-text">以往获得火焰图所需要的复杂步骤</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B0%E7%89%88-JVM-Profile-%E5%8A%9F%E8%83%BD%E4%B9%8B%E5%90%8E%E4%B8%80%E9%94%AE%E6%90%9E%E5%AE%9A"><span class="nav-number">9.4.3.</span> <span class="nav-text">使用新版 JVM Profile 功能之后一键搞定</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96-ID-%E6%8E%92%E6%9F%A5%E5%B7%A5%E5%85%B7"><span class="nav-number">9.5.</span> <span class="nav-text">序列化 ID 排查工具</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-1"><span class="nav-number">9.5.1.</span> <span class="nav-text">使用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Arthas-%E8%AF%8A%E6%96%AD%E5%B7%A5%E5%85%B7"><span class="nav-number">9.6.</span> <span class="nav-text">Arthas 诊断工具</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%8B%E7%BB%8D-2"><span class="nav-number">9.6.1.</span> <span class="nav-text">介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-2"><span class="nav-number">9.6.2.</span> <span class="nav-text">使用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tsar-%E8%B5%84%E6%BA%90%E7%9B%91%E6%8E%A7%E5%B7%A5%E5%85%B7"><span class="nav-number">9.7.</span> <span class="nav-text">tsar 资源监控工具</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-3"><span class="nav-number">9.7.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-3"><span class="nav-number">9.7.2.</span> <span class="nav-text">使用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"><span class="nav-number">10.</span> <span class="nav-text">常见问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E7%A0%81%E7%9B%B8%E5%85%B3"><span class="nav-number">10.1.</span> <span class="nav-text">编码相关</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#SimpleDateFormat-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98"><span class="nav-number">10.1.1.</span> <span class="nav-text">SimpleDateFormat 多线程安全问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#java-lang-IllegalThreadStateException"><span class="nav-number">10.1.2.</span> <span class="nav-text">java.lang.IllegalThreadStateException</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#java-util-ConcurrentModificationException"><span class="nav-number">10.1.3.</span> <span class="nav-text">java.util.ConcurrentModificationException</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%96%E6%B6%88%E6%95%B0%E5%80%BC%E7%9A%84%E7%A7%91%E5%AD%A6%E8%AE%A1%E6%95%B0%E6%B3%95"><span class="nav-number">10.1.4.</span> <span class="nav-text">取消数值的科学计数法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#File-toURL-%E8%BF%87%E6%9C%9F"><span class="nav-number">10.1.5.</span> <span class="nav-text">File#toURL 过期</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Jersey-%E7%9A%84-Produces-%E9%BB%98%E8%AE%A4%E4%B8%8D%E8%AE%BE%E7%BD%AE-UTF-8-%E5%AD%98%E5%9C%A8%E4%B8%AD%E6%96%87%E4%B9%B1%E7%A0%81"><span class="nav-number">10.1.6.</span> <span class="nav-text">Jersey 的 @Produces 默认不设置 UTF-8 存在中文乱码</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%96%B9%E6%A1%88"><span class="nav-number">10.1.6.1.</span> <span class="nav-text">方案</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0"><span class="nav-number">10.1.6.2.</span> <span class="nav-text">实现</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%BC%96%E7%A0%81-MediaTypeFilter"><span class="nav-number">10.1.6.2.1.</span> <span class="nav-text">编码 MediaTypeFilter</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%9C%A8-BrokerResource-%E4%B8%AD%E4%BD%BF%E7%94%A8"><span class="nav-number">10.1.6.2.2.</span> <span class="nav-text">在 BrokerResource 中使用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#FastJSON-%E9%BB%98%E8%AE%A4%E5%B0%86%E6%B5%AE%E7%82%B9%E5%9E%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%BA-BigDecimal"><span class="nav-number">10.1.7.</span> <span class="nav-text">FastJSON 默认将浮点型反序列化为 BigDecimal</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IDE-%E7%9B%B8%E5%85%B3"><span class="nav-number">10.2.</span> <span class="nav-text">IDE 相关</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Intellij-Idea-Code-Check-%E4%B8%AD%E8%AE%BE%E7%BD%AE%E8%A1%8C%E9%95%BF%E5%BA%A6%E4%B8%BA-120%EF%BC%8C%E5%8D%B4%E4%BB%8D%E7%84%B6%E6%9C%89%E4%B8%80%E6%9D%A1%E8%99%9A%E7%BA%BF%E7%AB%96%E5%9C%A8-80"><span class="nav-number">10.2.1.</span> <span class="nav-text">[Intellij Idea] Code Check 中设置行长度为 120，却仍然有一条虚线竖在 80</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%88%E6%9C%AC%E7%9B%B8%E5%85%B3"><span class="nav-number">10.3.</span> <span class="nav-text">版本相关</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Unsupported-major-minor-version-52-0"><span class="nav-number">10.3.1.</span> <span class="nav-text">Unsupported major.minor version 52.0</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Maven-%E7%9B%B8%E5%85%B3"><span class="nav-number">10.4.</span> <span class="nav-text">Maven 相关</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9C%80%E8%A6%81%E6%AD%A3%E7%A1%AE%E5%9C%B0%E5%9C%A8-Maven-%E7%9A%84-checkstyle-%E6%8F%92%E4%BB%B6%E7%9A%84-Regexp-%E6%AD%A3%E5%88%99%E4%B8%AD%E4%BD%BF%E7%94%A8-XML-%E5%85%B3%E9%94%AE%E5%AD%97"><span class="nav-number">10.4.1.</span> <span class="nav-text">需要正确地在 Maven 的 checkstyle 插件的 Regexp 正则中使用 XML 关键字</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LogBack-%E7%9B%B8%E5%85%B3"><span class="nav-number">10.5.</span> <span class="nav-text">LogBack 相关</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6%E8%BF%87%E5%A4%A7"><span class="nav-number">10.5.1.</span> <span class="nav-text">日志文件过大</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%8F%8F%E8%BF%B0-3"><span class="nav-number">10.5.1.1.</span> <span class="nav-text">描述</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3"><span class="nav-number">10.5.1.2.</span> <span class="nav-text">解决</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E7%9B%B8%E5%85%B3"><span class="nav-number">10.6.</span> <span class="nav-text">配置相关</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ConfigFactory-load-%E5%8F%AA%E8%83%BD%E5%8A%A0%E8%BD%BD%E5%9B%BA%E5%AE%9A%E7%9B%AE%E5%BD%95%E4%B8%8B%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">10.6.1.</span> <span class="nav-text">ConfigFactory.load() 只能加载固定目录下的配置文件</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JVM-%E7%9B%B8%E5%85%B3-1"><span class="nav-number">10.7.</span> <span class="nav-text">JVM 相关</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Too-small-initial-heap"><span class="nav-number">10.7.1.</span> <span class="nav-text">Too small initial heap</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9A%E4%BD%8D-OOM"><span class="nav-number">10.7.2.</span> <span class="nav-text">定位 OOM</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A0%86%E5%A4%96%E5%86%85%E5%AD%98%E4%BD%BF%E7%94%A8%E4%B8%8D%E5%BD%93%EF%BC%8C%E5%AF%BC%E8%87%B4-OOM-%E9%97%AE%E9%A2%98"><span class="nav-number">10.7.3.</span> <span class="nav-text">堆外内存使用不当，导致 OOM 问题</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%8F%8F%E8%BF%B0-4"><span class="nav-number">10.7.3.1.</span> <span class="nav-text">描述</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3-1"><span class="nav-number">10.7.3.2.</span> <span class="nav-text">解决</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#G1GC-%E6%8A%A5%E9%94%99-To-space-Exhausted"><span class="nav-number">10.7.4.</span> <span class="nav-text">G1GC 报错 To-space Exhausted</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%8F%8F%E8%BF%B0-5"><span class="nav-number">10.7.4.1.</span> <span class="nav-text">描述</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8E%9F%E5%9B%A0"><span class="nav-number">10.7.4.2.</span> <span class="nav-text">原因</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3-2"><span class="nav-number">10.7.4.3.</span> <span class="nav-text">解决</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B5%84%E6%96%99"><span class="nav-number">11.</span> <span class="nav-text">资料</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Doc"><span class="nav-number">11.1.</span> <span class="nav-text">Doc</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Tool"><span class="nav-number">11.2.</span> <span class="nav-text">Tool</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Blog"><span class="nav-number">11.3.</span> <span class="nav-text">Blog</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%AC%A2%E8%BF%8E%E5%8A%A0%E5%85%A5%E6%88%91%E4%BB%AC%E7%9A%84%E6%8A%80%E6%9C%AF%E7%BE%A4%EF%BC%8C%E4%B8%80%E8%B5%B7%E4%BA%A4%E6%B5%81%E5%AD%A6%E4%B9%A0"><span class="nav-number">12.</span> <span class="nav-text">欢迎加入我们的技术群，一起交流学习</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Benedict Jin" src="/yuzhouwan_logo_128x128.ico">
  <p class="site-author-name" itemprop="name">Benedict Jin</p>
  <div class="site-description" itemprop="description">Benedict Jin's Blog</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">54</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">147</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/asdf2014" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;asdf2014" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:asdf2014@apache.org" title="E-Mail → mailto:asdf2014@apache.org" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh" class="cc-opacity" rel="external nofollow noopener noreferrer" target="_blank"><img src="/images/cc-by-nc-nd.svg" alt="Creative Commons"></a>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        
  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="external nofollow noopener noreferrer" target="_blank">苏 ICP 备 17032505号 </a>
  </div>

<div class="copyright">
  
  &copy; 2014 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yuzhouwan.com</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">1.3m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">20:06</span>
</div>

        
<meta name="referrer" content="always">
<div class="busuanzi-count">
  <script async src="/lib/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




<script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.5/lib/darkmode-js.min.js"></script>
<script>
var options = {
  bottom: '32px', // default: '32px'
  right: '32px', // default: '32px'
  left: 'unset', // default: 'unset'
  time: '0.5s', // default: '0.3s'
  mixColor: '#fff', // default: '#fff'
  backgroundColor: '#fff',  // default: '#fff'
  buttonColorDark: '#100f2c',  // default: '#100f2c'
  buttonColorLight: '#fff', // default: '#fff'
  saveInCookies: true, // default: true,
  label: '🌓', // default: ''
  autoMatchOsTheme: false // default: true
}
const darkmode = new Darkmode(options);
darkmode.showWidget();
</script>
<style>
button.darkmode-toggle {
  z-index: 9999;
}
img, .darkmode-ignore {
  isolation: isolate;
  display: block;
}
</style>

  




  
<script src="/js/local-search.js"></script>











<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
          load: ['[tex]/mhchem'],
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
          packages: {'[+]': ['mhchem']},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

<script>
  var disqus_config = function() {
    this.page.url = "https://yuzhouwan.com/posts/190413/";
    this.page.identifier = "posts/190413/";
    this.page.title = "那些绕不过去的 Java 知识点";
    };
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://yuzhouwan.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : 'e5da61069b94deb8ef3a',
      clientSecret: 'c60ad4e430be258b705027a036eeee3d71cb934b',
      repo        : 'gitment',
      owner       : 'asdf2014',
      admin       : ['asdf2014'],
      id          : '60145ac323a2160b1763a68fc70b66e9',
        language: '',
      distractionFreeMode: false
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : true,
      appId      : 'BU4bnWsdAliFfk3fz7iMcFUU-gzGzoHsz',
      appKey     : '1xVLNFSy1qGCda3wt4GiGzHG',
      placeholder: "上述信息都不是必填的，可以直接提交评论",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</body>
</html>
