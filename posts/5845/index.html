<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/yuzhouwan_logo_with_copyright.jpg">
  <link rel="icon" type="image/png" sizes="32x32" href="/yuzhouwan_logo_32x32.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/yuzhouwan_logo_16x16.ico">
  <link rel="mask-icon" href="/yuzhouwan_logo_with_copyright.jpg" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yuzhouwan.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":5,"onmobile":true},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":true,"nav":{"valine":{"text":"Valine：匿名","order":-1},"disqus":{"text":"Disqus：海外","order":-2},"gitalk":{"text":"Gitalk：可用 Github 账号登录","order":-3}}},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="基本概念概述　Apache Druid™ 是目前非常流行的高性能的，分布式列存储的 OLAP 引擎（准确来说是 MOLAP）。它是一款可以快速（实时）访问大量的、很少变化的数据的系统。并被设计为，在面对代码部署、机器故障和生产系统的其他可能性问题时，依旧能 100％ 地正常提供服务  （图片来源：Vadim Ogievetsky 在万圣节的个人作品，已获得授权）    特性分析事件流　Druid">
<meta property="og:type" content="article">
<meta property="og:title" content="Apache Druid：一款高效的 OLAP 引擎">
<meta property="og:url" content="https://yuzhouwan.com/posts/5845/">
<meta property="og:site_name" content="宇宙湾">
<meta property="og:description" content="基本概念概述　Apache Druid™ 是目前非常流行的高性能的，分布式列存储的 OLAP 引擎（准确来说是 MOLAP）。它是一款可以快速（实时）访问大量的、很少变化的数据的系统。并被设计为，在面对代码部署、机器故障和生产系统的其他可能性问题时，依旧能 100％ 地正常提供服务  （图片来源：Vadim Ogievetsky 在万圣节的个人作品，已获得授权）    特性分析事件流　Druid">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://yuzhouwan.com/picture/druid/druid_pumpkin_compressed.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/druid/druid_overlord_and_middle_managers_with_zk.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/druid/druid_data_structure.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/druid/druid_console.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/druid/druid_save_30_days_rules.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/druid/druid_architecture_old_0.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/druid/druid_architecture_old_1.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/druid/druid_architecture_old_2.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/druid/druid_architecture.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/druid/druid_lambda.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/druid/apache_druid_balancer_strategy_cost.gif">
<meta property="og:image" content="https://yuzhouwan.com/picture/druid/apache_druid_ecosphere.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/druid/apache_druid_benchmark_partition_hashing_on.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/druid/apache_druid_benchmark_partition_hashing_off.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/druid/druid_query_processing.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/druid/druid_pivot_hbase_metrics.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/tsdb/tsdb_star_history.png">
<meta property="og:image" content="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg">
<meta property="og:image" content="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg">
<meta property="og:image" content="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg">
<meta property="og:image" content="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg">
<meta property="article:published_time" content="2017-04-02T03:05:11.000Z">
<meta property="article:modified_time" content="2021-03-28T14:03:11.074Z">
<meta property="article:author" content="Benedict Jin">
<meta property="article:tag" content="Apache Calcite">
<meta property="article:tag" content="Kubernetes">
<meta property="article:tag" content="Docker">
<meta property="article:tag" content="Maven">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="Helm">
<meta property="article:tag" content="Apache Druid">
<meta property="article:tag" content="Apache ZooKeeper">
<meta property="article:tag" content="InfluxDB">
<meta property="article:tag" content="Grafana">
<meta property="article:tag" content="TSDB">
<meta property="article:tag" content="Apache Superset">
<meta property="article:tag" content="Python">
<meta property="article:tag" content="Presto">
<meta property="article:tag" content="PostgreSQL">
<meta property="article:tag" content="Pivot">
<meta property="article:tag" content="Graphite">
<meta property="article:tag" content="OLAP">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://yuzhouwan.com/picture/druid/druid_pumpkin_compressed.png">

<link rel="canonical" href="https://yuzhouwan.com/posts/5845/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Apache Druid：一款高效的 OLAP 引擎 | 宇宙湾</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-97020848-1"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-97020848-1');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>


<style>.null { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .null > span { position: relative; z-index: 10; }  .null img, .null .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .null img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .null-fallback { color: inherit; } .null-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="宇宙湾" type="application/atom+xml"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">宇宙湾</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">厚积薄发</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">155</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">16</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">55</span></a>

  </li>
        <li class="menu-item menu-item-书单">

    <a href="/books/" rel="section"><i class="fa fa-book fa-fw"></i>书单</a>

  </li>
        <li class="menu-item menu-item-影视">

    <a href="/movies/" rel="section"><i class="fa fa-film fa-fw"></i>影视</a>

  </li>
        <li class="menu-item menu-item-友链">

    <a href="/links/" rel="section"><i class="fa fa-link fa-fw"></i>友链</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yuzhouwan.com/posts/5845/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/yuzhouwan_logo_128x128.ico">
      <meta itemprop="name" content="Benedict Jin">
      <meta itemprop="description" content="Benedict Jin's Blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宇宙湾">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Apache Druid：一款高效的 OLAP 引擎
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-04-02 11:05:11" itemprop="dateCreated datePublished" datetime="2017-04-02T11:05:11+08:00">2017-04-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-03-28 22:03:11" itemprop="dateModified" datetime="2021-03-28T22:03:11+08:00">2021-03-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/" itemprop="url" rel="index"><span itemprop="name">大数据</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>74k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1:07</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>　<strong>Apache Druid</strong>™ 是目前非常流行的高性能的，分布式列存储的 <strong>OLAP</strong> 引擎（准确来说是 <strong>MOLAP</strong>）。它是一款可以快速（实时）访问大量的、很少变化的数据的系统。并被设计为，在面对代码部署、机器故障和生产系统的其他可能性问题时，依旧能 100％ 地正常提供服务</p>
<p><img data-src="/picture/druid/druid_pumpkin_compressed.png" alt="Apache Druid Pumpkin"></p>
<center>（图片来源：Vadim Ogievetsky 在万圣节的个人作品，已获得授权）</center>



<h3 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h3><h4 id="分析事件流"><a href="#分析事件流" class="headerlink" title="分析事件流"></a>分析事件流</h4><p>　Druid 支持对 event-driven 数据进行快速地高并发查询。还可以实时地摄入流式数据，并提供亚秒级查询能力，以支持强大的 UI 交互</p>
<h4 id="创新的架构设计"><a href="#创新的架构设计" class="headerlink" title="创新的架构设计"></a>创新的架构设计</h4><p>　Druid 是一种新型数据库，它结合了 OLAP 分析数据库、时间序列数据库 和 全文检索 的思想，以支持流式体系架构下的大部分应用场景</p>
<h4 id="构建事件驱动的数据栈"><a href="#构建事件驱动的数据栈" class="headerlink" title="构建事件驱动的数据栈"></a>构建事件驱动的数据栈</h4><p>　Druid 天然集成了消息队列（Kafka、AWS Kinesis 等）和数据湖（HDFS、AWS S3 等），使得其非常适用于流式总线和流处理器的查询层</p>
<h4 id="解锁新的工作流"><a href="#解锁新的工作流" class="headerlink" title="解锁新的工作流"></a>解锁新的工作流</h4><p>　Druid 旨在对实时数据和历史数据进行快速地即时分析。使用可快速更替的查询，进行趋势解释，数据探索，以响应各种分析诉求</p>
<h4 id="多环境部署"><a href="#多环境部署" class="headerlink" title="多环境部署"></a>多环境部署</h4><p>　Druid 可以部署在任何的 <code>*NIX</code> 商用硬件上，无论是在云端还是内部部署。Druid 是 cloud-native 的，这意味着集群扩容和缩容，就像添加和删除进程一样简单</p>
<h4 id="多数据源摄入"><a href="#多数据源摄入" class="headerlink" title="多数据源摄入"></a>多数据源摄入</h4><p>　Druid 支持将多种外部数据系统作为数据源，进行数据摄入，包括 <a href="https://yuzhouwan.com/tags/Apache-Hadoop/">Hadoop</a>、<a href="https://yuzhouwan.com/posts/4735/">Spark</a>、<a href="https://yuzhouwan.com/tags/Apache-Storm/">Storm</a> 和 <a href="https://yuzhouwan.com/posts/26002/">Kafka</a> 等</p>
<h4 id="多版本控制"><a href="#多版本控制" class="headerlink" title="多版本控制"></a>多版本控制</h4><p>　多版本控制（<strong>MVCC</strong>，<strong>M</strong>ulti-<strong>V</strong>ersion <strong>C</strong>oncurrent <strong>C</strong>ontrol），主要是为了解决多用户操作同一条记录时的并发问题。MVCC 设计思路是，在并发访问数据库时，不使用粗暴的行锁，而是在事务型操作更新数据时，生成一个新版本的数据。如此，可以保证读写分离，避免了读写操作互相阻塞，以提高并发性能。另外，约束任意时刻只有最新版本的记录是有效的，即也保证了数据的一致性</p>
<p>　而 Druid 中是使用数据更新时间来区分版本，历史节点只加载最新版本的数据。同时，<strong>实时数据索引</strong>与<strong>离线数据批量覆盖</strong>同时进行的 Lambda 架构设计，既满足了实时响应的需求，又确保了数据的准确性</p>
<h4 id="易于运维"><a href="#易于运维" class="headerlink" title="易于运维"></a>易于运维</h4><p>　Druid 集群可以做到 Self-healing 和 Self-balancing。如果 Druid 服务器发生故障，系统将会自动绕过损坏的路由，直到这些机器恢复或被替换掉。在扩缩容集群的时候，只需要增加或下线服务器，集群本身会在后台自动 re-balance。Druid 在设计上保证了可以全天候工作，不会因为任何原因而停机，包括配置更改和集群升级</p>
<span id="more"></span>
<h3 id="基础组件"><a href="#基础组件" class="headerlink" title="基础组件"></a>基础组件</h3><h4 id="Router-进程"><a href="#Router-进程" class="headerlink" title="Router 进程"></a>Router 进程</h4><p>　Router 进程可以在 Brokers、Overlords 和 Coordinators 进程之上，提供一层统一的 API 网关。Router 进程本身是可选的，不过如果集群的数据规模已经达到了 TB 级别，还是需要考虑启用的（<code>druid.router.managementProxy.enabled=true</code>）。因为一旦集群规模达到一定的数量级，那么发生故障的概率就会变得不容忽视，而 Router 支持将请求只发送给健康的节点，避免请求失败。同时，查询的响应时间和资源消耗，也会随着数据量的增长而变高，而 Router 支持设置查询的优先级和负载均衡策略，避免了大查询造成的队列堆积或查询热点等问题。另外，Router 节点还可用于将查询路由到不同的 Broker 节点，便于实现冷热分层，以更好地应对超大规模数据集。默认情况下，Router 会根据设置的 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://druid.apache.org/docs/latest/operations/rule-configuration.html">Rule</a> 规则，来路由查询请求。例如，如果将最近 1 个月的数据加载到热集群中，则最近一个月内的查询可以路由到一组专用 Broker，超出该时间范围的查询将被路由到另一组 Broker，如此便实现了查询的冷热隔离</p>
<h4 id="Broker-进程"><a href="#Broker-进程" class="headerlink" title="Broker 进程"></a>Broker 进程</h4><p>　Broker 进程从客户端接收查询请求，并将这些查询转发给 Historical 和 MiddleManager 进程（通过存储在 <a href="https://yuzhouwan.com/posts/31915/">ZooKeeper</a> 上的元数据，可以准确地知道 Segment 具体在哪个节点上）。Broker 在接收到这些查询的结果之后，将会合并查询结果并将它们返回给客户端。用户通常会查询 Broker，而不是直接查询 Historical 或 MiddleManager 进程</p>
<h4 id="Overlord-进程"><a href="#Overlord-进程" class="headerlink" title="Overlord 进程"></a>Overlord 进程</h4><p>　Overlord 进程监视 MiddleManager 进程，是数据摄入的控制器。负责将数据摄入的任务分配给 MiddleManagers 并协调 Segment 的发布，包括接受、拆解、分配 Task，以及创建 Task 相关的锁，并返回 Task 的状态。大致流程如下图所示：</p>
<p><img data-src="/picture/druid/druid_overlord_and_middle_managers_with_zk.png" alt="Overlord and MiddleManagers with ZooKeeper in Apache Druid"></p>
<center>（图片来源：<a href="https://druid.apache.org/docs/latest/design/" target="_blank" rel="external nofollow noopener noreferrer">Apache Druid</a>™ 官网）</center>

<div class="note info">在很久远的 0.5.29 版本中，Overlord 被称之为 IndexCoordinator</div>

<h4 id="MiddleManager-进程"><a href="#MiddleManager-进程" class="headerlink" title="MiddleManager 进程"></a>MiddleManager 进程</h4><p>　MiddleManager 进程负责将新数据摄入到集群中，并发布新的 Segment</p>
<p>　MiddleManager 进程是执行提交的任务的工作节点。Middle Managers 将任务转发给在不同 JVM 中运行的 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://druid.apache.org/docs/latest/design/peons.html">Peon</a> 进程（如此，可以做到资源和日志的隔离）。MiddleManager、Peon、Task 的对应关系是，每个 Peon 进程一次只能运行一个 Task 任务，但一个 MiddleManager 却可以管理多个 Peon 进程</p>
<h4 id="Coordinator-进程"><a href="#Coordinator-进程" class="headerlink" title="Coordinator 进程"></a>Coordinator 进程</h4><p>　Coordinator 进程监视 Historical 节点。Coordinator 负责将 Segment 分配给指定的 Historical 节点，并确保 Segment 在 Historical 节点之间保持负载均衡。另外，Coordinator 还需要加载新的 Segment，以及基于配置的 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://druid.apache.org/docs/latest/operations/rule-configuration.html">Rule</a> 来丢弃过时的 Segment</p>
<p>　Coordinator 是周期性运行的（由 <code>druid.coordinator.period</code> 配置指定，默认执行间隔为 <code>60s</code>）。因为需要评估集群的当前状态，才能决定应用哪种策略，所以，Coordinator 需要维护和 <a href="https://yuzhouwan.com/posts/31915/">ZooKeeper</a> 的连接，以获取集群的信息。而关于 Segment 和 Rule 的信息保存在了元数据库中，所以也需要维护与元数据库的连接</p>
<h4 id="Historical-进程"><a href="#Historical-进程" class="headerlink" title="Historical 进程"></a>Historical 进程</h4><p>　Historical 进程是处理存储和查询“历史”数据（包括系统中所有已经存在足够长时间、可以被提交的流式数据）的主要工具（可以理解为，是整个 Druid 集群的支柱）。Historical 进程从 Deep Storage 中下载 Segment，并响应有关这些 Segment 的查询请求（这些请求来自 Broker 进程）。另外，Historical 进程不处理写入请求</p>
<p>　Historical 进程采用了 <code>无共享架构设计</code>（Shared-nothing Architecture），它知道如何去加载和删除 Segment，以及如何基于 Segment 来响应查询。因此，即便底层的 Deep Storage 无法正常工作，Historical 进程还是能针对其已同步的 Segments，正常提供查询服务</p>
<h3 id="核心插件"><a href="#核心插件" class="headerlink" title="核心插件"></a>核心插件</h3><h4 id="Kafka-Indexing-Service"><a href="#Kafka-Indexing-Service" class="headerlink" title="Kafka Indexing Service"></a>Kafka Indexing Service</h4><p>　Kafka Indexing Service 可以在 Overlord 上配置 Supervisor（这里的监管者具体是指 <code>KafkaSupervisor</code>，负责监控单个 DataSource 下的 KafkaIndexTask（Apache Druid 中的 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://druid.apache.org/docs/latest/querying/datasource.html">DataSource</a> 可以理解为关系型数据库中的表）。在其构造的时候，可以接受 <code>KafkaSupervisorSpec</code> 以知晓 Kafka 的 Topic 相关的配置信息，以及摄入的规则，用于生成 <code>KafkaIndexTask</code> 索引任务），并负责管理 Kafka 索引任务的创建和生命周期。这些 KIS 任务使用 Kafka 自身的分区和偏移机制来读取事件，因此能够提供 exactly-once 摄取的保证（旧版本下，Tranquility 采用的是 push 的方式，则完全无法实现不丢不重的特性）。KIS 任务还能够从 Kafka 读取非近期事件，并且不受其他摄取机制强加的窗口期限的影响。另外，Supervisor 会监控索引任务的状态，以便管理故障，并保证了可伸缩性和易复制的特性。更多差异点，详见下面的对比表：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">Before</th>
<th style="text-align:center">After</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">插件</td>
<td style="text-align:center">Druid Kafka Eight</td>
<td style="text-align:center">Kafka Indexing Service</td>
</tr>
<tr>
<td style="text-align:center">处理流式数据的模式</td>
<td style="text-align:center">push</td>
<td style="text-align:center">pull</td>
</tr>
<tr>
<td style="text-align:center">Exactly-Once</td>
<td style="text-align:center">push 模式 + 高级 Kafka API，导致无法实现</td>
<td style="text-align:center">pull 模式 + 低级 Kafka API，已实现</td>
</tr>
<tr>
<td style="text-align:center">乱序数据</td>
<td style="text-align:center">超过设定的时间窗口的数据会被丢弃，需通过离线任务补数据</td>
<td style="text-align:center">不受时间窗口限制，能够读取非近期的数据</td>
</tr>
<tr>
<td style="text-align:center">高可用</td>
<td style="text-align:center"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://druid.apache.org/docs/latest/ingestion/standalone-realtime.html">Realtime</a> 单进程（一旦发生宕机，节点上未提交到 DeepStorage 的数据将全部丢失）</td>
<td style="text-align:center">Historical 多进程</td>
</tr>
<tr>
<td style="text-align:center">易用性</td>
<td style="text-align:center">每个节点都需要唯一的配置，且 Schema 变更后需滚动重启</td>
<td style="text-align:center">统一配置，且无需重启</td>
</tr>
<tr>
<td style="text-align:center">可见性</td>
<td style="text-align:center">实时</td>
<td style="text-align:center">非实时</td>
</tr>
</tbody>
</table>
</div>
<div class="note info">在 0.16.0 版本中，Apache Druid 彻底删除了 Realtime Node 相关的插件，包括了 druid-kafka-eight、druid-kafka-eight-simpleConsumer、druid-rabbitmq 和 druid-rocketmq</div>
<div class="note warning">虽然新引入的 KIS 有诸多好处，但是世上并不存在“银弹”。因为 KIS 采用了 pull 的方式摄入数据，必然会存在拉取的频率一说。该频率由 offsetFetchPeriod 参数控制，默认 30s 会拉取一次，而最快只能 5s 拉取一次。那为什么不能设置更小的值呢？因为如果过于频繁地向 Kafka 发起请求，可能影响到 Kafka 的稳定性</div>



<h3 id="外部依赖"><a href="#外部依赖" class="headerlink" title="外部依赖"></a>外部依赖</h3><h4 id="Metadata-Storage"><a href="#Metadata-Storage" class="headerlink" title="Metadata Storage"></a>Metadata Storage</h4><p>　存储元数据信息，包括 DataSource、Segment 和 Task，以及一些配置信息等。默认使用 Derby，生产环境通常会选择 MySQL 或 PostgreSQL 作为存储媒介</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">表名</th>
<th style="text-align:center">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">druid_datasource</td>
<td style="text-align:center">存储 DataSources，以便 Kafka Index Service 查找</td>
</tr>
<tr>
<td style="text-align:center">druid_pendingsegments</td>
<td style="text-align:center">存储 pending 的 Segments</td>
</tr>
<tr>
<td style="text-align:center">druid_segments</td>
<td style="text-align:center">存储每个 Segment 的 metadata 信息<br>（表字段：segment_id, datasource, start, end, size, version, partition_num, num_replicas, num_rows, is_published, is_available, is_overshadowed, shardSpec, dimensions, metrics）</td>
</tr>
<tr>
<td style="text-align:center">druid_rules</td>
<td style="text-align:center">关于 Segment 的 load / drop 规则</td>
</tr>
<tr>
<td style="text-align:center">druid_config</td>
<td style="text-align:center">存放运行时配置信息</td>
</tr>
<tr>
<td style="text-align:center">druid_tasks</td>
<td style="text-align:center">为 Indexing Service 保存 Task 信息</td>
</tr>
<tr>
<td style="text-align:center">druid_tasklogs</td>
<td style="text-align:center">为 Indexing Service 保存 Task 日志</td>
</tr>
<tr>
<td style="text-align:center">druid_tasklocks</td>
<td style="text-align:center">为 Indexing Service 保存 Task 锁</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">上面三张表，都是 Overlord 用来存放索引 Task 的数据，防止 Overlord 挂掉，而导致 Task 丢失</td>
</tr>
<tr>
<td style="text-align:center">druid_supervisors</td>
<td style="text-align:center">为 Indexing Service 保存  Supervisor 信息</td>
</tr>
<tr>
<td style="text-align:center">druid_audit</td>
<td style="text-align:center">记录配置、Coordinator 规则的变化</td>
</tr>
</tbody>
</table>
</div>
<div class="note info">在 0.16.0 版本中，Apache Druid 从 druid_segments 表中删除了无用的 is_realtime 字段</div>
<div class="note info">在 0.19.0 版本中，Apache Druid 为了解决反序列化 payload 带来的性能问题，将 payload 字段替换为 dimensions、metrics 和 shardSpec</div>

<h4 id="Deep-Storage"><a href="#Deep-Storage" class="headerlink" title="Deep Storage"></a>Deep Storage</h4><p>　Deep Storage 作为每个 Druid Server 都可以访问的共享文件存储。通常是像 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/apache/druid/blob/master/docs/development/extensions-core/hdfs.md">HDFS</a>、<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/apache/druid/blob/master/docs/development/extensions-contrib/aliyun-oss-extensions.md">AliyunOSS</a> 或 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/apache/druid/blob/master/docs/development/extensions-core/s3.md">S3</a> 这样的分布式对象存储，或者是网络文件系统（NFS）。Druid 使用它来存储已被摄入系统的任何数据</p>
<p>　Druid 仅将 Deep Storage 用作数据的备份，并将其作为在 Druid 进程之间在后台传输数据的一种方式。当接受到查询请求，Historical 进程不会从 Deep Storage 读取数据，而是在响应任何查询之前，读取从本地磁盘 pre-fetched 的 Segments。这意味着 Druid 在查询期间永远不需要访问 Deep Storage，从而极大地降低了查询延迟。这也意味着，必须保证 Deep Storage 和 Historical 进程所在节点，能拥有足够的磁盘空间</p>
<h4 id="ZooKeeper"><a href="#ZooKeeper" class="headerlink" title="ZooKeeper"></a>ZooKeeper</h4><p>　用于管理集群的当前状态，并涵盖了以下几个主要特性：</p>
<ul>
<li>Coordinator 节点的 Leader 选举</li>
<li>Historical 节点发布 Segment 的协议</li>
<li>Coordinator 和 Historical 之间 load / drop Segment 的协议</li>
<li>Overlord 节点的 Leader 选举</li>
<li>Overlord 和 MiddleManager 之间的 Task 管理</li>
</ul>
<div class="note info">选举通过 Apache Curator 框架中的 LeaderLatch 来完成，具体的实现细节详见 CuratorDruidLeaderSelector</div>



<h3 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h3><p><img data-src="/picture/druid/druid_data_structure.png" alt="Apache Druid Data Structure"></p>
<center>（使用 Keynote™ 绘制而成）</center>

<h4 id="时间序列"><a href="#时间序列" class="headerlink" title="时间序列"></a>时间序列</h4><p>　时间序列（Timestamp），本身 Druid 是时间序列数据库，Druid 中所有查询以及索引过程都和时间维度有关。Druid 底层使用绝对毫秒数保存时间戳，默认使用 ISO-8601 格式展示时间：<code>yyyy-MM-ddThh:mm:sss.SSSZ</code></p>
<h4 id="维度列"><a href="#维度列" class="headerlink" title="维度列"></a>维度列</h4><p>　维度列（Dimensions），Druid 的维度概念和广义的 OLAP 定义一致，一条记录中的字符、数值、多值等类型的数据均可看作是维度列。维度列可用于过滤筛选（filter）、分组（group）数据</p>
<h4 id="度量列"><a href="#度量列" class="headerlink" title="度量列"></a>度量列</h4><p>　度量列（Metrics），Druid 的度量概念也与广义的 OLAP 定义一致，一条记录中的数值（Numeric）类型数据可看作是度量列，度量列被用于聚合（aggregation）和计算（computation）操作</p>
<div class="note success">从这里可以看出来，Apache Druid 是天然支持多值数据模型的</div>




<h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><h3 id="单机版"><a href="#单机版" class="headerlink" title="单机版"></a>单机版</h3><h4 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://mirrors.tuna.tsinghua.edu.cn/apache/druid/0.20.1/apache-druid-0.20.1-bin.tar.gz</span><br></pre></td></tr></tbody></table></figure>
<h4 id="解压"><a href="#解压" class="headerlink" title="解压"></a>解压</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tar zxvf apache-druid-0.20.1-bin.tar.gz</span><br></pre></td></tr></tbody></table></figure>
<h4 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> apache-druid-0.20.1</span><br><span class="line">$ bin/start-micro-quickstart</span><br></pre></td></tr></tbody></table></figure>
<div class="note info">通过 examples/conf/druid/single-server/micro-quickstart 下的配置项，可以计算得出 1C2G 的机器规格，便可以启动一个完整的 Apache Druid 服务</div>

<h4 id="可视化"><a href="#可视化" class="headerlink" title="可视化"></a>可视化</h4><p>　浏览器中打开 <code>localhost:8888</code> 地址，控制台的界面如下图所示：</p>
<p><img data-src="/picture/druid/druid_console.png" alt="Apache Druid Web Console"></p>
<center>（对 <a href="https://druid.apache.org/docs/latest/operations/druid-console.html" target="_blank" rel="external nofollow noopener noreferrer">Web Console</a> 可视化页面的截图）</center>



<h3 id="Docker-容器版"><a href="#Docker-容器版" class="headerlink" title="Docker 容器版"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/apache/druid/tree/master/distribution/docker">Docker 容器版</a></h3><h4 id="下载-1"><a href="#下载-1" class="headerlink" title="下载"></a>下载</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 搜索 Docker Hub</span></span><br><span class="line">$ docker search druid</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载最新版本的镜像</span></span><br><span class="line">$ docker pull apache/druid:0.20.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查镜像是否下载成功</span></span><br><span class="line">$ docker image list</span><br></pre></td></tr></tbody></table></figure>
<h4 id="配置-Docker-文件共享"><a href="#配置-Docker-文件共享" class="headerlink" title="配置 Docker 文件共享"></a>配置 Docker 文件共享</h4><p>　打开配置面板，进入 <code>File Sharing</code> 配置页面，增加 <code>${the path of your source code}/distribution/docker/storage</code> 路径，随后点击 <code>Apply &amp; Restart</code> 按钮，应用并重启</p>
<h4 id="启动-1"><a href="#启动-1" class="headerlink" title="启动"></a>启动</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/apache/druid.git</span><br><span class="line">$ <span class="built_in">cd</span> druid</span><br><span class="line">$ docker-compose -f distribution/docker/docker-compose.yml up</span><br><span class="line"></span><br><span class="line"><span class="comment"># 同理，也可以使用 start/stop 命令启停容器</span></span><br><span class="line">$ docker-compose -f distribution/docker/docker-compose.yml stop</span><br><span class="line">$ docker-compose -f distribution/docker/docker-compose.yml start</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者使用 down 命令移除容器</span></span><br><span class="line">$ docker-compose -f distribution/docker/docker-compose.yml down</span><br></pre></td></tr></tbody></table></figure>
<!-- docker run --rm -i -p 8888:8888 apache/druid:0.20.1 -->
<h4 id="校验"><a href="#校验" class="headerlink" title="校验"></a>校验</h4><h5 id="Historical-容器"><a href="#Historical-容器" class="headerlink" title="Historical 容器"></a>Historical 容器</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ docker <span class="built_in">exec</span> -it historical sh</span><br><span class="line">$ ls /opt/data/</span><br><span class="line">  indexing-logs  segments</span><br><span class="line">$ ls /opt/data/segments/</span><br><span class="line">  intermediate_pushes  wikipedia</span><br><span class="line">$ ls /opt/data/segments/wikipedia/</span><br><span class="line">  2016-06-27T00:00:00.000Z_2016-06-28T00:00:00.000Z</span><br><span class="line">$ ls /opt/data/segments/wikipedia/2016-06-27T00\:00\:00.000Z_2016-06-28T00\:00\:00.000Z/</span><br><span class="line">  2020-06-04T07:11:42.714Z</span><br><span class="line">$ ls /opt/data/segments/wikipedia/2016-06-27T00\:00\:00.000Z_2016-06-28T00\:00\:00.000Z/2020-06-04T07\:11\:42.714Z/0/</span><br><span class="line">  index.zip</span><br><span class="line">$ ls -lh</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">total 8M</span><br><span class="line">-rw-r--r--    1 druid    druid       5.9M Jun  4 07:49 00000.smoosh</span><br><span class="line">-rw-r--r--    1 druid    druid         29 Jun  4 07:49 factory.json</span><br><span class="line">-rw-r--r--    1 druid    druid       1.7M Jun  4 07:14 index.zip</span><br><span class="line">-rw-r--r--    1 druid    druid        707 Jun  4 07:49 meta.smoosh</span><br><span class="line">-rw-r--r--    1 druid    druid          4 Jun  4 07:49 version.bin</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cat factory.json</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">{<span class="attr">"type"</span>:<span class="string">"mMapSegmentFactory"</span>}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ xxd version.bin</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">00000000: 0000 0009                                ....</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cat meta.smoosh</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight css"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">v1</span>,2147483647,1</span><br><span class="line">__<span class="selector-tag">time</span>,0,0,1106</span><br><span class="line"><span class="selector-tag">channel</span>,0,145739,153122</span><br><span class="line"><span class="selector-tag">cityName</span>,0,153122,195592</span><br><span class="line"><span class="selector-tag">comment</span>,0,195592,1598156</span><br><span class="line"><span class="selector-tag">count</span>,0,1106,2063</span><br><span class="line"><span class="selector-tag">countryIsoCode</span>,0,1598156,1614170</span><br><span class="line"><span class="selector-tag">countryName</span>,0,1614170,1630859</span><br><span class="line"><span class="selector-tag">diffUrl</span>,0,1630859,4224103</span><br><span class="line"><span class="selector-tag">flags</span>,0,4224103,4252873</span><br><span class="line"><span class="selector-tag">index</span><span class="selector-class">.drd</span>,0,6162513,6163275</span><br><span class="line"><span class="selector-tag">isAnonymous</span>,0,4252873,4262876</span><br><span class="line"><span class="selector-tag">isMinor</span>,0,4262876,4282592</span><br><span class="line"><span class="selector-tag">isNew</span>,0,4282592,4290896</span><br><span class="line"><span class="selector-tag">isRobot</span>,0,4290896,4298796</span><br><span class="line"><span class="selector-tag">isUnpatrolled</span>,0,4298796,4307345</span><br><span class="line"><span class="selector-tag">metadata</span><span class="selector-class">.drd</span>,0,6163275,6163925</span><br><span class="line"><span class="selector-tag">namespace</span>,0,4307345,4342089</span><br><span class="line"><span class="selector-tag">page</span>,0,4342089,5710071</span><br><span class="line"><span class="selector-tag">regionIsoCode</span>,0,5710071,5730339</span><br><span class="line"><span class="selector-tag">regionName</span>,0,5730339,5759351</span><br><span class="line"><span class="selector-tag">sum_added</span>,0,2063,37356</span><br><span class="line"><span class="selector-tag">sum_commentLength</span>,0,37356,66244</span><br><span class="line"><span class="selector-tag">sum_deleted</span>,0,66244,81170</span><br><span class="line"><span class="selector-tag">sum_delta</span>,0,81170,126275</span><br><span class="line"><span class="selector-tag">sum_deltaBucket</span>,0,126275,145739</span><br><span class="line"><span class="selector-tag">user</span>,0,5759351,6162513</span><br></pre></td></tr></tbody></table></figure>
<div class="note info">其中，index.drd 包含该 Segment 覆盖的时间范围、指定的 Bitmap 种类（concise / roaring），以及包含的列和维度；而 metadata.drd 包含是否 Rollup、哪些聚合函数、查询的粒度，时间戳字段信息，以及可用于存储任意 Key-Value 数据的 Map 结构（例如 Kafka Firehose 用来存储 offset 信息）。更多细节，详见 org.apache.druid.segment.IndexIO.V9IndexLoader#load</div>



<h5 id="PostgreSQL-容器"><a href="#PostgreSQL-容器" class="headerlink" title="PostgreSQL 容器"></a>PostgreSQL 容器</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker <span class="built_in">exec</span> -it postgres bash</span><br><span class="line">$ psql --version</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql (PostgreSQL) 11.7</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ psql -U druid -d druid</span><br><span class="line">$ \l</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">                             List of databases</span><br><span class="line">   Name    | Owner | Encoding |  Collate   |   Ctype    | Access privileges</span><br><span class="line">-----------+-------+----------+------------+------------+-------------------</span><br><span class="line"> druid     | druid | UTF8     | en_US.utf8 | en_US.utf8 |</span><br><span class="line"> postgres  | druid | UTF8     | en_US.utf8 | en_US.utf8 |</span><br><span class="line"> template0 | druid | UTF8     | en_US.utf8 | en_US.utf8 | =c/druid         +</span><br><span class="line">           |       |          |            |            | druid=CTc/druid</span><br><span class="line"> template1 | druid | UTF8     | en_US.utf8 | en_US.utf8 | =c/druid         +</span><br><span class="line">           |       |          |            |            | druid=CTc/druid</span><br><span class="line">(4 rows)</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ \c druid</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">You are now connected to database <span class="string">"druid"</span> as user <span class="string">"druid"</span>.</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ \dt</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">               List of relations</span><br><span class="line"> Schema |         Name          | Type  | Owner</span><br><span class="line">--------+-----------------------+-------+-------</span><br><span class="line"> public | druid_audit           | table | druid</span><br><span class="line"> public | druid_config          | table | druid</span><br><span class="line"> public | druid_datasource      | table | druid</span><br><span class="line"> public | druid_pendingsegments | table | druid</span><br><span class="line"> public | druid_rules           | table | druid</span><br><span class="line"> public | druid_segments        | table | druid</span><br><span class="line"> public | druid_supervisors     | table | druid</span><br><span class="line"> public | druid_tasklocks       | table | druid</span><br><span class="line"> public | druid_tasklogs        | table | druid</span><br><span class="line"> public | druid_tasks           | table | druid</span><br><span class="line">(10 rows)</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; select id, datasource, created_date, start, "end", partitioned, version, used from public.druid_segments;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wikipedia_2016-06-27T00:00:00.000Z_2016-06-28T00:00:00.000Z_2020-06-04T07:11:42.714Z | wikipedia  | 2020-06-04T07:14:50.619Z | 2016-06-27T00:00:00.000Z | 2016-06-28T00:00:00.000Z | t           | 2020-06-04T07:11:42.714Z | t</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Kubernetes-集群版"><a href="#Kubernetes-集群版" class="headerlink" title="Kubernetes 集群版"></a>Kubernetes 集群版</h3><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ helm repo add incubator https://kubernetes-charts-incubator.storage.googleapis.com</span><br><span class="line">$ helm install incubator/druid --version 0.2.6 --generate-name</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">NAME: druid-1592218780</span><br><span class="line">LAST DEPLOYED: Mon Jun 15 23:59:42 2020</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br><span class="line">TEST SUITE: None</span><br><span class="line">NOTES:</span><br><span class="line">1. Get the router URL by running these commands:</span><br><span class="line">  <span class="built_in">export</span> POD_NAME=$(kubectl get pods --namespace default -l <span class="string">"app=druid,release=druid-1592218780"</span> -o jsonpath=<span class="string">"{.items[0].metadata.name}"</span>)</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"Visit http://127.0.0.1:8080 to use your application"</span></span><br><span class="line">  kubectl port-forward <span class="variable">$POD_NAME</span> 8080:8888</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> POD_NAME=$(kubectl get pods --namespace default -l <span class="string">"app=druid,release=`helm list | grep druid- | awk '{print <span class="variable">$1</span>}'`"</span> | grep router | awk <span class="string">'{print $1}'</span>)</span><br><span class="line">$ nohup kubectl port-forward <span class="variable">$POD_NAME</span> 8888:8888 --address 0.0.0.0 2&gt;&amp;1 &amp;</span><br></pre></td></tr></tbody></table></figure>
<h4 id="校验-1"><a href="#校验-1" class="headerlink" title="校验"></a>校验</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get all</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">NAME                                                READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/druid-1592364086-broker-76bf68c8bc-96d56        1/1     Running   0          2m36s</span><br><span class="line">pod/druid-1592364086-coordinator-5f645bd5c8-rhhpz   1/1     Running   0          2m36s</span><br><span class="line">pod/druid-1592364086-historical-0                   1/1     Running   0          2m36s</span><br><span class="line">pod/druid-1592364086-middle-manager-0               1/1     Running   0          2m36s</span><br><span class="line">pod/druid-1592364086-postgresql-0                   1/1     Running   0          2m36s</span><br><span class="line">pod/druid-1592364086-router-67f678b6c5-mw6b4        1/1     Running   0          2m36s</span><br><span class="line">pod/druid-1592364086-zookeeper-0                    1/1     Running   0          2m36s</span><br><span class="line">pod/druid-1592364086-zookeeper-1                    1/1     Running   0          2m8s</span><br><span class="line">pod/druid-1592364086-zookeeper-2                    1/1     Running   0          85s</span><br><span class="line">pod/<span class="built_in">local</span>-volume-provisioner-8sjtx                  1/1     Running   0          8m59s</span><br><span class="line">pod/<span class="built_in">local</span>-volume-provisioner-9z7mh                  1/1     Running   0          8m59s</span><br><span class="line">pod/<span class="built_in">local</span>-volume-provisioner-m2xrt                  1/1     Running   0          8m59s</span><br><span class="line">pod/<span class="built_in">local</span>-volume-provisioner-ptbqs                  1/1     Running   0          8m59s</span><br><span class="line">pod/<span class="built_in">local</span>-volume-provisioner-tw2fn                  1/1     Running   0          8m59s</span><br><span class="line"></span><br><span class="line">NAME                                           TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE</span><br><span class="line">service/druid-1592364086-broker                ClusterIP   10.10.10.128     &lt;none&gt;        8082/TCP                     2m36s</span><br><span class="line">service/druid-1592364086-coordinator           ClusterIP   10.10.10.195     &lt;none&gt;        8081/TCP                     2m36s</span><br><span class="line">service/druid-1592364086-historical            ClusterIP   10.10.10.226     &lt;none&gt;        8083/TCP                     2m36s</span><br><span class="line">service/druid-1592364086-middle-manager        ClusterIP   10.10.10.108     &lt;none&gt;        8091/TCP                     2m36s</span><br><span class="line">service/druid-1592364086-postgresql            ClusterIP   10.10.10.155     &lt;none&gt;        5432/TCP                     2m36s</span><br><span class="line">service/druid-1592364086-postgresql-headless   ClusterIP   None             &lt;none&gt;        5432/TCP                     2m36s</span><br><span class="line">service/druid-1592364086-router                ClusterIP   10.10.10.29      &lt;none&gt;        8888/TCP                     2m36s</span><br><span class="line">service/druid-1592364086-zookeeper             ClusterIP   10.10.10.122     &lt;none&gt;        2181/TCP                     2m36s</span><br><span class="line">service/druid-1592364086-zookeeper-headless    ClusterIP   None             &lt;none&gt;        2181/TCP,3888/TCP,2888/TCP   2m36s</span><br><span class="line">service/kubernetes                             ClusterIP   10.10.10.1       &lt;none&gt;        443/TCP                      30m</span><br><span class="line"></span><br><span class="line">NAME                                      DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE</span><br><span class="line">daemonset.apps/<span class="built_in">local</span>-volume-provisioner   5         5         5       5            5           &lt;none&gt;          9m</span><br><span class="line"></span><br><span class="line">NAME                                           READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/druid-1592364086-broker        1/1     1            1           2m36s</span><br><span class="line">deployment.apps/druid-1592364086-coordinator   1/1     1            1           2m36s</span><br><span class="line">deployment.apps/druid-1592364086-router        1/1     1            1           2m36s</span><br><span class="line"></span><br><span class="line">NAME                                                      DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/druid-1592364086-broker-76bf68c8bc        1         1         1       2m36s</span><br><span class="line">replicaset.apps/druid-1592364086-coordinator-5f645bd5c8   1         1         1       2m36s</span><br><span class="line">replicaset.apps/druid-1592364086-router-67f678b6c5        1         1         1       2m36s</span><br><span class="line"></span><br><span class="line">NAME                                               READY   AGE</span><br><span class="line">statefulset.apps/druid-1592364086-historical       1/1     2m36s</span><br><span class="line">statefulset.apps/druid-1592364086-middle-manager   1/1     2m36s</span><br><span class="line">statefulset.apps/druid-1592364086-postgresql       1/1     2m36s</span><br><span class="line">statefulset.apps/druid-1592364086-zookeeper        3/3     2m36s</span><br></pre></td></tr></tbody></table></figure>
<div class="note info">上述 CLUSTER-IP 信息已脱敏</div>

<h4 id="ZooKeeper-元数据"><a href="#ZooKeeper-元数据" class="headerlink" title="ZooKeeper 元数据"></a>ZooKeeper 元数据</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ zkCli.sh</span><br><span class="line">[zk: localhost:2181(CONNECTED) 0] ls -R /druid</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">/druid</span><br><span class="line"></span><br><span class="line">/druid/announcements</span><br><span class="line">/druid/coordinator</span><br><span class="line">/druid/discovery</span><br><span class="line">/druid/indexer</span><br><span class="line">/druid/internal-discovery</span><br><span class="line">/druid/loadQueue</span><br><span class="line">/druid/overlord</span><br><span class="line">/druid/segments</span><br><span class="line">/druid/servedSegments</span><br><span class="line"></span><br><span class="line">/druid/announcements/10.10.10.63:8083</span><br><span class="line"></span><br><span class="line">/druid/coordinator/_COORDINATOR</span><br><span class="line">/druid/coordinator/_COORDINATOR/_c_281fb87b-c40c-4d71-a657-8254cbcf3730-latch-0000000000</span><br><span class="line"></span><br><span class="line">/druid/discovery/druid:broker</span><br><span class="line">/druid/discovery/druid:coordinator</span><br><span class="line">/druid/discovery/druid:overlord</span><br><span class="line">/druid/discovery/druid:router</span><br><span class="line"></span><br><span class="line">/druid/discovery/druid:broker/0e76bfc1-87f8-4799-9c36-0fb0e5617aef</span><br><span class="line">/druid/discovery/druid:coordinator/035b1ada-531e-4a71-865b-7a1a6d6f1734</span><br><span class="line">/druid/discovery/druid:overlord/a74523d6-1708-45b3-9c0b-87f438cda4e3</span><br><span class="line">/druid/discovery/druid:router/c0bb18d3-51b1-4089-932b-a5d6e05ab91c</span><br><span class="line"></span><br><span class="line">/druid/indexer/announcements</span><br><span class="line">/druid/indexer/status</span><br><span class="line">/druid/indexer/tasks</span><br><span class="line"></span><br><span class="line">/druid/indexer/announcements/10.10.10.65:8091</span><br><span class="line">/druid/indexer/status/10.10.10.65:8091</span><br><span class="line">/druid/indexer/tasks/10.10.10.65:8091</span><br><span class="line"></span><br><span class="line">/druid/internal-discovery/BROKER</span><br><span class="line">/druid/internal-discovery/COORDINATOR</span><br><span class="line">/druid/internal-discovery/HISTORICAL</span><br><span class="line">/druid/internal-discovery/INDEXER</span><br><span class="line">/druid/internal-discovery/MIDDLE_MANAGER</span><br><span class="line">/druid/internal-discovery/OVERLORD</span><br><span class="line">/druid/internal-discovery/PEON</span><br><span class="line">/druid/internal-discovery/ROUTER</span><br><span class="line"></span><br><span class="line">/druid/internal-discovery/BROKER/10.10.10.73:8082</span><br><span class="line">/druid/internal-discovery/COORDINATOR/10.10.10.72:8081</span><br><span class="line">/druid/internal-discovery/HISTORICAL/10.10.10.63:8083</span><br><span class="line">/druid/internal-discovery/MIDDLE_MANAGER/10.10.10.65:8091</span><br><span class="line">/druid/internal-discovery/OVERLORD/10.10.10.72:8081</span><br><span class="line">/druid/internal-discovery/ROUTER/10.10.10.55:8888</span><br><span class="line"></span><br><span class="line">/druid/loadQueue/10.10.10.63:8083</span><br><span class="line"></span><br><span class="line">/druid/overlord/_OVERLORD</span><br><span class="line">/druid/overlord/_OVERLORD/_c_ecacbc56-4d36-4ca0-ac1d-0df919c40bff-latch-0000000000</span><br><span class="line"></span><br><span class="line">/druid/segments/10.10.10.63:8083</span><br><span class="line"></span><br><span class="line">/druid/segments/10.10.10.63:8083/10.10.10.63:8083_historical__default_tier_2020-06-20T04:08:23.309Z_1b957acb6850491ca6ea885fca1b3c210</span><br><span class="line">/druid/segments/10.10.10.63:8083/10.10.10.63:8083_historical__default_tier_2020-06-20T04:10:16.643Z_57c1f60104a94c459bf0331eb3c1f0a01</span><br><span class="line"></span><br><span class="line">/druid/servedSegments/10.10.10.63:8083</span><br></pre></td></tr></tbody></table></figure>
<div class="note info">上述 IP 地址相关信息已脱敏</div>

<h4 id="Broker-健康检查"><a href="#Broker-健康检查" class="headerlink" title="Broker 健康检查"></a>Broker 健康检查</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">kill</span> `ps -ef | grep 8082 | grep -v grep | awk <span class="string">'{print $2}'</span>`; <span class="built_in">export</span> POD_NAME=$(kubectl get pods --namespace default -l <span class="string">"app=druid,release=`helm list | grep druid- | awk '{print <span class="variable">$1</span>}'`"</span> | grep broker | awk <span class="string">'{print $1}'</span>) ; nohup kubectl port-forward <span class="variable">$POD_NAME</span> 8082:8082 --address 0.0.0.0 2&gt;&amp;1 &amp;</span><br><span class="line">$ curl localhost:8082/status/health</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">true</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="MiddleManager-任务"><a href="#MiddleManager-任务" class="headerlink" title="MiddleManager 任务"></a>MiddleManager 任务</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> -it druid-1593317208-middle-manager-0 sh</span><br><span class="line">$ <span class="built_in">cd</span> /opt/druid/var/druid/task</span><br><span class="line">$ find</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">./workerTaskManagerTmp</span><br><span class="line">./completedTasks</span><br><span class="line">./restore.json</span><br><span class="line">./assignedTasks</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cat restore.json</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">{<span class="attr">"runningTasks"</span>:[]}</span><br></pre></td></tr></tbody></table></figure>
<div class="note info">MiddleManager 会将运行中的任务 ID（TaskRunnerWorkItem#taskId）的列表持久化在本地 restore.json 文件中，以便重启节点的时候恢复正在运行中的任务</div>

<h4 id="Historical-缓存"><a href="#Historical-缓存" class="headerlink" title="Historical 缓存"></a>Historical 缓存</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /opt/druid/var/druid/segment-cache/info_dir</span><br><span class="line">$ cat wikipedia_2016-06-27T00:00:00.000Z_2016-06-27T01:00:00.000Z_2020-06-20T04:10:01.833Z</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"dataSource"</span>: <span class="string">"wikipedia"</span>,</span><br><span class="line">  <span class="attr">"interval"</span>: <span class="string">"2016-06-27T00:00:00.000Z/2016-06-27T01:00:00.000Z"</span>,</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"2020-06-20T04:10:01.833Z"</span>,</span><br><span class="line">  <span class="attr">"loadSpec"</span>: {</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"hdfs"</span>,</span><br><span class="line">    <span class="attr">"path"</span>: <span class="string">"hdfs://10.10.10.44:8020/druid/segments/wikipedia/20160627T000000.000Z_20160627T010000.000Z/2020-06-20T04_10_01.833Z/0_index.zip"</span></span><br><span class="line">  },</span><br><span class="line">  <span class="attr">"dimensions"</span>: <span class="string">"channel,cityName,comment,countryIsoCode,countryName,diffUrl,flags,isAnonymous,isMinor,isNew,isRobot,isUnpatrolled,namespace,page,regionIsoCode,regionName,user"</span>,</span><br><span class="line">  <span class="attr">"metrics"</span>: <span class="string">"count,sum_added,sum_commentLength,sum_deleted,sum_delta,sum_deltaBucket"</span>,</span><br><span class="line">  <span class="attr">"shardSpec"</span>: {</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"numbered"</span>,</span><br><span class="line">    <span class="attr">"partitionNum"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"partitions"</span>: <span class="number">0</span></span><br><span class="line">  },</span><br><span class="line">  <span class="attr">"binaryVersion"</span>: <span class="number">9</span>,</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">241189</span>,</span><br><span class="line">  <span class="attr">"identifier"</span>: <span class="string">"wikipedia_2016-06-27T00:00:00.000Z_2016-06-27T01:00:00.000Z_2020-06-20T04:10:01.833Z"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<div class="note success">上述 JSON 已格式化，以便于阅读</div>

<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /opt/druid/var/druid/segment-cache/wikipedia/2016-06-27T00:00:00.000Z_2016-06-27T01:00:00.000Z/2020-06-20T04:10:01.833Z/0</span><br><span class="line">$ ls</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">00000.smoosh  factory.json  meta.smoosh  version.bin</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Segment-文件"><a href="#Segment-文件" class="headerlink" title="Segment 文件"></a>Segment 文件</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> -it hdfs-1593317115-namenode-0 bash</span><br><span class="line">$ hdfs dfs -get /druid/segments/wikipedia/20160627T000000.000Z_20160627T010000.000Z/2020-06-28T04_10_01.833Z/0_index.zip /tmp/index/</span><br><span class="line">$ <span class="built_in">exit</span></span><br><span class="line">$ kubectl cp hdfs-1593317115-namenode-0:/tmp/index/0_index.zip /tmp/0_index.zip</span><br><span class="line">$ unzip 0_index.zip</span><br><span class="line">$ ls</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">00000.smoosh  0_index.zip  factory.json  meta.smoosh  version.bin</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Coordinator-动态配置"><a href="#Coordinator-动态配置" class="headerlink" title="Coordinator 动态配置"></a>Coordinator 动态配置</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">kill</span> `ps -ef | grep 8081 | grep -v grep | awk <span class="string">'{print $2}'</span>`; <span class="built_in">export</span> POD_NAME=$(kubectl get pods --namespace default -l <span class="string">"app=druid,release=`helm list | grep druid- | awk '{print <span class="variable">$1</span>}'`"</span> | grep coordinator | awk <span class="string">'{print $1}'</span>) ; nohup kubectl port-forward <span class="variable">$POD_NAME</span> 8081:8081 --address 0.0.0.0 2&gt;&amp;1 &amp;</span><br><span class="line">$ curl localhost:8081/druid/coordinator/v1/config | python -m json.tool</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"balancerComputeThreads"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"decommissioningMaxPercentOfMaxSegmentsToMove"</span>: <span class="number">70</span>,</span><br><span class="line">  <span class="attr">"decommissioningNodes"</span>: [],</span><br><span class="line">  <span class="attr">"emitBalancingStats"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"killAllDataSources"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"killDataSourceWhitelist"</span>: [],</span><br><span class="line">  <span class="attr">"killPendingSegmentsSkipList"</span>: [],</span><br><span class="line">  <span class="attr">"maxSegmentsInNodeLoadingQueue"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"maxSegmentsToMove"</span>: <span class="number">5</span>,</span><br><span class="line">  <span class="attr">"mergeBytesLimit"</span>: <span class="number">524288000</span>,</span><br><span class="line">  <span class="attr">"mergeSegmentsLimit"</span>: <span class="number">100</span>,</span><br><span class="line">  <span class="attr">"millisToWaitBeforeDeleting"</span>: <span class="number">900000</span>,</span><br><span class="line">  <span class="attr">"pauseCoordination"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"replicantLifetime"</span>: <span class="number">15</span>,</span><br><span class="line">  <span class="attr">"replicationThrottleLimit"</span>: <span class="number">10</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将 maxSegmentsToMove 调整为 50</span></span><br><span class="line">$ curl -XPOST -H <span class="string">'Content-Type:application/json'</span> localhost:8081/druid/coordinator/v1/config -d <span class="string">'{"maxSegmentsToMove":50}'</span></span><br><span class="line">$ curl localhost:8081/druid/coordinator/v1/config | python -m json.tool</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"balancerComputeThreads"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"decommissioningMaxPercentOfMaxSegmentsToMove"</span>: <span class="number">70</span>,</span><br><span class="line">  <span class="attr">"decommissioningNodes"</span>: [],</span><br><span class="line">  <span class="attr">"emitBalancingStats"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"killAllDataSources"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"killDataSourceWhitelist"</span>: [],</span><br><span class="line">  <span class="attr">"killPendingSegmentsSkipList"</span>: [],</span><br><span class="line">  <span class="attr">"maxSegmentsInNodeLoadingQueue"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"maxSegmentsToMove"</span>: <span class="number">50</span>,</span><br><span class="line">  <span class="attr">"mergeBytesLimit"</span>: <span class="number">524288000</span>,</span><br><span class="line">  <span class="attr">"mergeSegmentsLimit"</span>: <span class="number">100</span>,</span><br><span class="line">  <span class="attr">"millisToWaitBeforeDeleting"</span>: <span class="number">900000</span>,</span><br><span class="line">  <span class="attr">"pauseCoordination"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"replicantLifetime"</span>: <span class="number">15</span>,</span><br><span class="line">  <span class="attr">"replicationThrottleLimit"</span>: <span class="number">10</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<div class="note info">动态配置项 maxSegmentsToMove 可以用于控制同时被 rebalance 的 Segment 数量</div>
<div class="note info">动态配置项 replicantLifetime 可以用于控制 Historical 上 Segment 存活的时间。当 Historical 下线时，其上的 Segment 会被认为已经失效，然后 Coordinator 会通知其他 Historical 来加载这些 Segment。但是在 Historical 升级做滚动重启的时候，如果立即使这些 Segment 失效，会导致严重的数据漂移。因此，需要给这些 Segment 增加一个 lifetime 机制，以规避此类情况</div>

<h4 id="Druid-SQL-查询"><a href="#Druid-SQL-查询" class="headerlink" title="Druid SQL 查询"></a>Druid SQL 查询</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 映射 Broker 容器的 8082 端口</span></span><br><span class="line">$ <span class="built_in">kill</span> `ps -ef | grep 8082 | grep -v grep | awk <span class="string">'{print $2}'</span>`; <span class="built_in">export</span> POD_NAME=$(kubectl get pods --namespace default -l <span class="string">"app=druid,release=`helm list | grep druid- | awk '{print <span class="variable">$1</span>}'`"</span> | grep broker | awk <span class="string">'{print $1}'</span>) ; nohup kubectl port-forward <span class="variable">$POD_NAME</span> 8082:8082 --address 0.0.0.0 2&gt;&amp;1 &amp;</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">'{"query":"SELECT COUNT(*) as res FROM wikipedia"}'</span> &gt; druid_query.sql</span><br><span class="line">$ curl -XPOST -H<span class="string">'Content-Type: application/json'</span> http://localhost:8082/druid/v2/sql/ -d@druid_query.sql</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[{<span class="attr">"res"</span>:<span class="number">24433</span>}]</span><br></pre></td></tr></tbody></table></figure>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://druid.apache.org/docs/latest/configuration/index.html">配置</a></h2><h3 id="常用端口"><a href="#常用端口" class="headerlink" title="常用端口"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://druid.apache.org/docs/latest/tutorials/cluster.html">常用端口</a></h3><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">端口描述</th>
<th style="text-align:center">端口号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Router, if used</td>
<td style="text-align:center">8088</td>
</tr>
<tr>
<td style="text-align:center">Broker</td>
<td style="text-align:center">8082</td>
</tr>
<tr>
<td style="text-align:center">Overlord</td>
<td style="text-align:center">8090</td>
</tr>
<tr>
<td style="text-align:center">Middle Manager; you may need higher than port 8199 if you have a very high <code>druid.worker.capacity</code></td>
<td style="text-align:center">8091, 8100 ~ 8199</td>
</tr>
<tr>
<td style="text-align:center">Coordinator</td>
<td style="text-align:center">8081</td>
</tr>
<tr>
<td style="text-align:center">Historical</td>
<td style="text-align:center">8083</td>
</tr>
<tr>
<td style="text-align:center">Derby on your Coordinator; not needed if you are using a separate metadata store like MySQL or PostgreSQL</td>
<td style="text-align:center">1527</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://yuzhouwan.com/posts/31915/">ZooKeeper</a>; not needed if you are using a separate ZooKeeper cluster</td>
<td style="text-align:center">2181</td>
</tr>
</tbody>
</table>
</div>
<div class="note warning">生产中，建议将 ZooKeeper 和 Metadata Stroage 部署在独立的物理机上，而不是混合部署在 Coordinator 节点上</div>



<h3 id="rollup"><a href="#rollup" class="headerlink" title="rollup"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://druid.apache.org/docs/latest/ingestion/index.html#enabling-or-disabling-rollup">rollup</a></h3><p>　在 Apache Druid <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/apache/druid/releases/tag/druid-0.9.2">0.9.2</a> 版本之后，我们可以通过在 <code>granularitySpec</code> 中配置 <code>"rollup": false</code>，来完全关闭 RollUp 特性，即在数据摄入的过程中，不做任何的预聚合，只保留最原始的数据点。即便是同一时刻的、具有相同维度的、完全相同的多个数据点，都会全部存储下来，不会发生覆盖写</p>
<h3 id="selectStrategy"><a href="#selectStrategy" class="headerlink" title="selectStrategy"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://druid.apache.org/docs/latest/configuration/index.html#overlord">selectStrategy</a></h3><p>　该参数默认为 <code>fillCapacity</code>，意味着分配 Task 的时候，会将某个 MiddleManager 分配满，才会分配新的 Task 到其他 MiddleManager 上。这里可以考虑使用 <code>equalDistribution</code> 策略，将 Task 均匀分配到 MiddleManager 上</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> <span class="variable">$DRUID_HOME</span></span><br><span class="line">$ vim conf/druid/overlord/runtime.properties</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">druid.indexer.selectStrategy</span>=<span class="string">equalDistribution</span></span><br></pre></td></tr></tbody></table></figure>
<div class="note success">在 0.11.0 版本中，默认策略已经改成了 equalDistribution。详见 WorkerBehaviorConfig#DEFAULT_STRATEGY</div>



<h3 id="maxRowsPerSegment"><a href="#maxRowsPerSegment" class="headerlink" title="maxRowsPerSegment"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://druid.apache.org/docs/latest/ingestion/native-batch.html#dynamic-partitioning">maxRowsPerSegment</a></h3><p>　该参数用于控制每个 Segment 中最大能够存储的记录行数（默认值为 <code>500,0000</code>），只有二级分区采用的是 <code>dynamic</code> 才会生效。如果 <code>spec.tuningConfig.type</code> 设置的是 <code>hashed</code>，则需要指定 shard 的数量，以及哪些 Dimension 被用于 hash 计算（默认为所有 Dimension）。另外，在 <code>dynamic</code> 类型的二级分区中，还有一个 <code>maxTotalRows</code> 参数（默认值为 <code>2000,0000</code>），用来控制所有尚未被存储到 Deep Storage 中的 segment 的记录行数，一旦达到 <code>maxTotalRows</code> 则会立即触发 push 操作</p>
<div class="note danger">如果该参数设置得很低，会产生很多小的 Segment 文件。一方面，如果 DeepStorage 为 HDFS 的话，会触发小文件问题，影响到集群性能（访问大量小文件不同于访问少数大文件，需要不断地在 DataNode 之间跳转，大部分时间都会耗费在 task 的启动和释放上，并且 NameNode 要监控的数据块变多后，网络带宽和内存占用也会比高，还会拖慢 NameNode 节点的故障恢复）；另一方面，如果操作系统中 vm.max_map_count 参数为默认的 65530 的话，可能会达到这个阈值，使得 MMap 操作失败，进而导致 Historical 进程 crash 退出，如果 Segment 一直无法完成 handoff 的过程，则会促使 Coordinator 进程 kill 实时任务</div>



<h3 id="druid-server-tier"><a href="#druid-server-tier" class="headerlink" title="druid.server.tier"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://druid.apache.org/docs/latest/configuration/index.html#historical-general-configuration">druid.server.tier</a></h3><p>　该参数相当于给 Historical 节点加了一个标签，可以将相同 Tier 名称的 Historical 进行分组，便于实现冷热分层。在 <code>historical/runtime.properties</code> 配置文件中设置，默认值为 <code>_default_tier</code>。例如，可以创建 <code>hot</code> 和 <code>cold</code> 两个 Tier，<code>hot</code> Tier 用于存储最近三个月的数据，<code>cold</code> Tier 用于存储最近一年的数据。如此一来，因为 <code>cold</code> 分组下的 Historical 节点存储的数据只需要应对一些低频查询，便可以使用非 SSD 的磁盘，以节约硬件成本</p>
<h3 id="tieredReplicants"><a href="#tieredReplicants" class="headerlink" title="tieredReplicants"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://druid.apache.org/docs/latest/operations/rule-configuration.html#interval-load-rule">tieredReplicants</a></h3><p>　该参数用于在 Rule 中设置 Tier 存储的副本数量。假设将 tieredReplicants 设置为 2 之后，数据便会在不同的 Historical 节点上各自存储一份，以避免某一个 Historical 故障，而影响到查询</p>
<h3 id="Coordinator-Rule-配置"><a href="#Coordinator-Rule-配置" class="headerlink" title="Coordinator Rule 配置"></a>Coordinator Rule 配置</h3><h4 id="保留最近-30-天数据"><a href="#保留最近-30-天数据" class="headerlink" title="保留最近 30 天数据"></a>保留最近 30 天数据</h4><p><img data-src="/picture/druid/druid_save_30_days_rules.png" alt="Apache Druid Coordinator UI"></p>
<center>（对 <a href="https://druid.apache.org/docs/latest/design/coordinator.html" target="_blank" rel="external nofollow noopener noreferrer">Coordinator</a> 可视化页面的截图）</center>





<h2 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h2><h3 id="Druid-SQL"><a href="#Druid-SQL" class="headerlink" title="Druid SQL"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://druid.apache.org/docs/latest/querying/sql.html">Druid SQL</a></h3><h4 id="语法规则"><a href="#语法规则" class="headerlink" title="语法规则"></a>语法规则</h4><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[ <span class="keyword">EXPLAIN</span> PLAN <span class="keyword">FOR</span> ]</span><br><span class="line">[ <span class="keyword">WITH</span> tableName [ ( column1, column2, ... ) ] <span class="keyword">AS</span> ( <span class="keyword">query</span> ) ]</span><br><span class="line"><span class="keyword">SELECT</span> [ <span class="keyword">ALL</span> | <span class="keyword">DISTINCT</span> ] { * | exprs }</span><br><span class="line"><span class="keyword">FROM</span> { &lt;<span class="keyword">table</span>&gt; | (&lt;subquery&gt;) | &lt;o1&gt; [ <span class="keyword">INNER</span> | <span class="keyword">LEFT</span> ] <span class="keyword">JOIN</span> &lt;o2&gt; <span class="keyword">ON</span> condition }</span><br><span class="line">[ <span class="keyword">WHERE</span> expr ]</span><br><span class="line">[ <span class="keyword">GROUP</span> <span class="keyword">BY</span> [ exprs | <span class="keyword">GROUPING</span> <span class="keyword">SETS</span> ( (exprs), ... ) | <span class="keyword">ROLLUP</span> (exprs) | <span class="keyword">CUBE</span> (exprs) ] ]</span><br><span class="line">[ <span class="keyword">HAVING</span> expr ]</span><br><span class="line">[ <span class="keyword">ORDER</span> <span class="keyword">BY</span> expr [ <span class="keyword">ASC</span> | <span class="keyword">DESC</span> ], expr [ <span class="keyword">ASC</span> | <span class="keyword">DESC</span> ], ... ]</span><br><span class="line">[ <span class="keyword">LIMIT</span> <span class="keyword">limit</span> ]</span><br><span class="line">[ <span class="keyword">UNION</span> <span class="keyword">ALL</span> &lt;another <span class="keyword">query</span>&gt; ]</span><br></pre></td></tr></tbody></table></figure>
<h4 id="查询示例"><a href="#查询示例" class="headerlink" title="查询示例"></a>查询示例</h4><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="string">"__time"</span>, <span class="string">"channel"</span>, <span class="string">"cityName"</span>, <span class="string">"comment"</span>, <span class="string">"count"</span>, <span class="string">"countryIsoCode"</span>, <span class="string">"countryName"</span>, <span class="string">"diffUrl"</span>, <span class="string">"flags"</span>, <span class="string">"isAnonymous"</span>, <span class="string">"isMinor"</span>, <span class="string">"isNew"</span>, <span class="string">"isRobot"</span>, <span class="string">"isUnpatrolled"</span>, <span class="string">"namespace"</span>, <span class="string">"page"</span>, <span class="string">"regionIsoCode"</span>, <span class="string">"regionName"</span>, <span class="string">"sum_added"</span>, <span class="string">"sum_commentLength"</span>, <span class="string">"sum_deleted"</span>, <span class="string">"sum_delta"</span>, <span class="string">"sum_deltaBucket"</span>, <span class="string">"user"</span></span><br><span class="line"><span class="keyword">FROM</span> <span class="string">"wikipedia"</span></span><br><span class="line"><span class="keyword">WHERE</span> <span class="string">"__time"</span> &gt;= <span class="keyword">CURRENT_TIMESTAMP</span> - <span class="built_in">INTERVAL</span> <span class="string">'1'</span> <span class="keyword">DAY</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="PlyQL"><a href="#PlyQL" class="headerlink" title="PlyQL"></a>PlyQL</h3><h4 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h4><p>　通过 <code>--host</code> 和 <code>-q</code> 分别指定 <code>Broker 地址</code> 和 <code>查询语句</code></p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/druid/software/imply-1.3.0</span><br><span class="line">$ bin/plyql --host &lt;broker host&gt;:8082 -q <span class="string">"show tables"</span>        <span class="comment"># --host &lt;broker&gt;:&lt;port&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────┐</span><br><span class="line">│ Tables_in_database      │</span><br><span class="line">├─────────────────────────┤</span><br><span class="line">│ COLUMNS                 │</span><br><span class="line">│ SCHEMATA                │</span><br><span class="line">│ TABLES                  │</span><br><span class="line">│ yuzhouwan_metrics       │</span><br><span class="line">└─────────────────────────┘</span><br></pre></td></tr></tbody></table></figure>
<h4 id="表结构查询"><a href="#表结构查询" class="headerlink" title="表结构查询"></a>表结构查询</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ bin/plyql --host &lt;broker host&gt;:8082 -q <span class="string">"describe yuzhouwan_metrics"</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌────────────┬────────┬──────┬─────┬─────────┬───────┐</span><br><span class="line">│ Field      │ Type   │ Null │ Key │ Default │ Extra │</span><br><span class="line">├────────────┼────────┼──────┼─────┼─────────┼───────┤</span><br><span class="line">│ __time     │ TIME   │ YES  │     │         │       │</span><br><span class="line">│ metric01   │ NUMBER │ YES  │     │         │       │</span><br><span class="line">│ metric02   │ NUMBER │ YES  │     │         │       │</span><br><span class="line">│ // ...     │        │      │     │         │       │</span><br><span class="line">└────────────┴────────┴──────┴─────┴─────────┴───────┘</span><br></pre></td></tr></tbody></table></figure>
<h4 id="聚合查询"><a href="#聚合查询" class="headerlink" title="聚合查询"></a>聚合查询</h4><h5 id="简单聚合"><a href="#简单聚合" class="headerlink" title="简单聚合"></a>简单聚合</h5><p>　简单的 <code>max</code> / <code>min</code> / <code>count</code> 查询语句</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ bin/plyql --host &lt;broker host&gt;:8082 -q <span class="string">"select max(gcCount_max) from yuzhouwan_metrics where serverName='druid01'"</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──────────────────┐</span><br><span class="line">│ max(gcCount_max) │</span><br><span class="line">├──────────────────┤</span><br><span class="line">│ 39710            │</span><br><span class="line">└──────────────────┘</span><br></pre></td></tr></tbody></table></figure>
<h5 id="时间维度聚合"><a href="#时间维度聚合" class="headerlink" title="时间维度聚合"></a>时间维度聚合</h5><p>　利用 <code>TIME_PART</code> 进行时间维度的聚合</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ bin/plyql --host &lt;broker host&gt;:8082 -q <span class="string">"select TIME_PART(__time, MINUTE_OF_DAY, 'Asia/Shanghai'), max(gcCount_max) from yuzhouwan_metrics where serverName='druid01' and __time&gt;='2017-04-04' and __time&lt;'2017-04-05' group by 1"</span> -Z Asia/Shanghai</span><br><span class="line"></span><br><span class="line"><span class="comment"># 不参与 group by 的 指标需要进行 sum / min / max 之类的聚合操作</span></span><br><span class="line">$ bin/plyql --host &lt;broker host&gt;:8082 -q <span class="string">"select TIME_PART(__time, MINUTE_OF_DAY, 'Asia/Shanghai'), metric, sum(sum) as sum_value from yuzhouwan_metrics where level='level1' and metric='metric1' and __time&gt;='2017-04-04' and __time&lt;'2017-04-05' group by 1, 2 order by sum_value desc limit 10"</span> -Z Asia/Shanghai -v</span><br></pre></td></tr></tbody></table></figure>
<h4 id="展示查询对应的-JSON-语句"><a href="#展示查询对应的-JSON-语句" class="headerlink" title="展示查询对应的 JSON 语句"></a>展示查询对应的 JSON 语句</h4><p>　增加 <code>-v</code> 参数，可以将查询的 <code>JSON</code> 语句展示出来，用于检查 <code>plyql</code> 语句是否符合预期</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ bin/plyql --host &lt;broker host&gt;:8082 -q <span class="string">"select distinct level from yuzhouwan_metrics where __time&gt;='2017-01-16 03:00'"</span> -Z Asia/Shanghai -v</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">plyql version 0.9.6 (plywood version 0.15.4)</span><br><span class="line">Received query:</span><br><span class="line">select distinct level from yuzhouwan_metrics <span class="built_in">where</span> __time&gt;=<span class="string">'2017-01-16 03:00'</span></span><br><span class="line">---------------------------</span><br><span class="line">Parsed query as the following plywood expression (as JSON):</span><br><span class="line">{</span><br><span class="line">  <span class="string">"op"</span>: <span class="string">"split"</span>,</span><br><span class="line">  <span class="string">"operand"</span>: {</span><br><span class="line">    <span class="string">"op"</span>: <span class="string">"filter"</span>,</span><br><span class="line">    <span class="string">"operand"</span>: {</span><br><span class="line">      <span class="string">"op"</span>: <span class="string">"ref"</span>,</span><br><span class="line">      <span class="string">"name"</span>: <span class="string">"yuzhouwan_metrics"</span></span><br><span class="line">    },</span><br><span class="line">    <span class="string">"expression"</span>: {</span><br><span class="line">      <span class="string">"op"</span>: <span class="string">"greaterThanOrEqual"</span>,</span><br><span class="line">      <span class="string">"operand"</span>: {</span><br><span class="line">        <span class="string">"op"</span>: <span class="string">"ref"</span>,</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"__time"</span>,</span><br><span class="line">        <span class="string">"ignoreCase"</span>: <span class="literal">true</span></span><br><span class="line">      },    // ...</span><br><span class="line">      {</span><br><span class="line">        <span class="string">"version"</span>: <span class="string">"v1"</span>,</span><br><span class="line">        <span class="string">"timestamp"</span>: <span class="string">"2017-01-16T03:00:00.000Z"</span>,</span><br><span class="line">        <span class="string">"event"</span>: {</span><br><span class="line">          <span class="string">"level"</span>: <span class="string">"level1"</span>,</span><br><span class="line">          <span class="string">"!DUMMY"</span>: 1608</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">]</span><br><span class="line">^^^^^^^^^^^^^^^^^^^^^^^^^^</span><br><span class="line">┌────────────────┐</span><br><span class="line">│ level          │</span><br><span class="line">├────────────────┤</span><br><span class="line">│ level1         │</span><br><span class="line">│ level2         │</span><br><span class="line">└────────────────┘</span><br></pre></td></tr></tbody></table></figure>
<h4 id="计算查询耗时情况"><a href="#计算查询耗时情况" class="headerlink" title="计算查询耗时情况"></a>计算查询耗时情况</h4><p>　利用 time 命令，可以计算出查询语句的耗时情况</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ time bin/plyql -h &lt;broker host&gt;:8082 -q <span class="string">"select * from yuzhouwan_metrics where __time&gt;='2017-03-18' and __time&lt;'2017-03-19' and level='level01' limit 100"</span> -Z Asia/Shanghai</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">real    0m0.886s</span><br><span class="line">user    0m0.684s</span><br><span class="line">sys     0m0.062s</span><br></pre></td></tr></tbody></table></figure>
<h3 id="RESTful-API"><a href="#RESTful-API" class="headerlink" title="RESTful API"></a>RESTful API</h3><h4 id="获取所有-DataSource"><a href="#获取所有-DataSource" class="headerlink" title="获取所有 DataSource"></a>获取所有 DataSource</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl http://localhost:8082/druid/v2/datasources</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">"inline_data"</span>,<span class="string">"wikipedia"</span>]</span><br></pre></td></tr></tbody></table></figure>
<h4 id="聚合查询-1"><a href="#聚合查询-1" class="headerlink" title="聚合查询"></a>聚合查询</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim query.body</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"dimensions"</span>: [</span><br><span class="line">    <span class="string">"dimensions1"</span>,</span><br><span class="line">    <span class="string">"dimensions2"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"aggregations"</span>: [</span><br><span class="line">    {</span><br><span class="line">      <span class="attr">"filter"</span>: {</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"selector"</span>,</span><br><span class="line">        <span class="attr">"dimension"</span>: <span class="string">"metric"</span>,</span><br><span class="line">        <span class="attr">"value"</span>: <span class="string">"metrics01"</span></span><br><span class="line">      },</span><br><span class="line">      <span class="attr">"aggregator"</span>: {</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"doubleSum"</span>,</span><br><span class="line">        <span class="attr">"fieldName"</span>: <span class="string">"sum"</span>,</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"metric01"</span></span><br><span class="line">      },</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"filtered"</span></span><br><span class="line">    }</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"filter"</span>: {</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"selector"</span>,</span><br><span class="line">    <span class="attr">"dimension"</span>: <span class="string">"level"</span>,</span><br><span class="line">    <span class="attr">"value"</span>: <span class="string">"day"</span></span><br><span class="line">  },</span><br><span class="line">  <span class="attr">"intervals"</span>: <span class="string">"2017-02-09T15:03:12+08:00/2017-02-09T16:03:12+08:00"</span>,</span><br><span class="line">  <span class="attr">"limitSpec"</span>: {</span><br><span class="line">    <span class="attr">"limit"</span>: <span class="number">10</span>,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"default"</span>,</span><br><span class="line">    <span class="attr">"columns"</span>: [</span><br><span class="line">      {</span><br><span class="line">        <span class="attr">"direction"</span>: <span class="string">"descending"</span>,</span><br><span class="line">        <span class="attr">"dimension"</span>: <span class="string">"metric01"</span></span><br><span class="line">      }</span><br><span class="line">    ]</span><br><span class="line">  },</span><br><span class="line">  <span class="attr">"granularity"</span>: <span class="string">"all"</span>,</span><br><span class="line">  <span class="attr">"postAggregations"</span>: [],</span><br><span class="line">  <span class="attr">"queryType"</span>: <span class="string">"groupBy"</span>,</span><br><span class="line">  <span class="attr">"dataSource"</span>: <span class="string">"yuzhouwan_metrics"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -X POST <span class="string">"http://localhost:8082/druid/v2/?pretty"</span> -H <span class="string">'content-type: application/json'</span> -d @query.body</span><br></pre></td></tr></tbody></table></figure>
<div class="note info">在 postAggregations 中里面是串行执行的，并可以传递计算结果</div>



<h3 id="Apache-Calcite"><a href="#Apache-Calcite" class="headerlink" title="Apache Calcite"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://druid.apache.org/docs/latest/querying/sql.html#jdbc">Apache Calcite</a></h3><h4 id="Maven-依赖"><a href="#Maven-依赖" class="headerlink" title="Maven 依赖"></a>Maven 依赖</h4><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.calcite<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>calcite-druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.23.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="Java-实现"><a href="#Java-实现" class="headerlink" title="Java 实现"></a>Java 实现</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">String url = <span class="string">"jdbc:avatica:remote:url=http://localhost:8082/druid/v2/sql/avatica/"</span>;</span><br><span class="line">String query = <span class="string">"SELECT COUNT(*) as res FROM wikipedia"</span>;</span><br><span class="line"><span class="keyword">try</span> (Connection connection = DriverManager.getConnection(url)) {</span><br><span class="line">    <span class="keyword">try</span> (Statement statement = connection.createStatement();</span><br><span class="line">         ResultSet resultSet = statement.executeQuery(query)) {</span><br><span class="line">        <span class="keyword">while</span> (resultSet.next()) {</span><br><span class="line">            System.out.println(resultSet.getInt(<span class="number">1</span>));</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">24433</span></span><br></pre></td></tr></tbody></table></figure>
<div class="note success">Apache Calcite 的 Druid adapter 持续完善查询算子下推，已支持 count(*) 聚合、filter 过滤和 groupby 分组等</div>



<h3 id="Druid-Client"><a href="#Druid-Client" class="headerlink" title="Druid Client"></a>Druid Client</h3><p>　一旦有了 Client 之后，我们就可以做很多事情，比如流控、权限管理、统一 SQL 层等（社区正在 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/apache/druid/issues/5006">!5006</a> 中讨论，欢迎加入）。目前，社区已经有针对 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/implydata/druid-client">Java</a>、<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/druid-io/pydruid">Python</a>、<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/nisalperi/druid-client">Golang</a>、<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/daggerrz/druid-scala-client">Scala</a>、<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/y42/clj-druid">Clojure</a>、<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/level23/druid-client">PHP</a>、<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/druid-io/RDruid">R</a> <a target="_blank" rel="external nofollow noopener noreferrer" href="https://druid.apache.org/libraries">等</a>语言，实现了对应的 Client 工具</p>
<h3 id="Presto"><a href="#Presto" class="headerlink" title="Presto"></a>Presto</h3><p>　PrestoDB 和 PrestoSQL 均支持 Druid Connector。具体的使用方式，详见我的另一篇博客：<a href="https://yuzhouwan.com/posts/200906/#Apache-Druid-Connector">Presto：分布式 SQL 查询引擎</a></p>
<h3 id="InfluxDB-Line-Protocol-Parser"><a href="#InfluxDB-Line-Protocol-Parser" class="headerlink" title="InfluxDB Line Protocol Parser"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://druid.apache.org/docs/latest/development/extensions-contrib/influx.html">InfluxDB Line Protocol Parser</a></h3><p>　Apache Druid 通过 <code>druid-influx-extensions</code> 插件支持解析 InfluxDB 写入协议。更多关于 InfluxDB 的介绍，详见：<a href="https://yuzhouwan.com/posts/200315/">开源时序数据库 InfluxDB</a></p>
<h2 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h2><h3 id="设计总图"><a href="#设计总图" class="headerlink" title="设计总图"></a>设计总图</h3><h4 id="初始版本-0-6-0（2012-2013）"><a href="#初始版本-0-6-0（2012-2013）" class="headerlink" title="初始版本~0.6.0（2012~2013）"></a>初始版本~0.6.0（2012~2013）</h4><p><img data-src="/picture/druid/druid_architecture_old_0.png" alt="Apache Druid 初始构架图"></p>
<center>（图片来源：<a href="https://druid.apache.org/docs/img/druid-dataflow-2x.png" target="_blank" rel="external nofollow noopener noreferrer">Apache Druid</a>™ 官网）</center>

<h4 id="0-7-0-0-12-0（2013-2018）"><a href="#0-7-0-0-12-0（2013-2018）" class="headerlink" title="0.7.0~0.12.0（2013~2018）"></a>0.7.0~0.12.0（2013~2018）</h4><p><img data-src="/picture/druid/druid_architecture_old_1.png" alt="Apache Druid 旧构架图 - 数据流转"><br><img data-src="/picture/druid/druid_architecture_old_2.png" alt="Apache Druid 旧构架图 - 集群管理"></p>
<center>（图片来源：<a href="http://druid.io/docs/0.12.0/design/design.html" target="_blank" rel="external nofollow noopener noreferrer">Apache Druid</a>™ 官网）</center>

<h4 id="0-13-0-当前版本（2018-now）"><a href="#0-13-0-当前版本（2018-now）" class="headerlink" title="0.13.0~当前版本（2018~now）"></a>0.13.0~当前版本（2018~now）</h4><p><img data-src="/picture/druid/druid_architecture.png" alt="Apache Druid 构架图"></p>
<center>（图片来源：<a href="https://druid.apache.org/docs/latest/design/" target="_blank" rel="external nofollow noopener noreferrer">Apache Druid</a>™ 官网）</center>

<div class="note info">从架构图中可以看出来 Apache Druid 集群的通讯是基于 Apache ZooKeeper 的</div>



<h3 id="Lambda-流式架构"><a href="#Lambda-流式架构" class="headerlink" title="Lambda 流式架构"></a>Lambda 流式架构</h3><p><img data-src="/picture/druid/druid_lambda.png" alt="Apache Druid Lambda"></p>
<center>（利用 Axure™ 绘制而成）</center>

<div class="note info">通常流式数据的链路为 Raw data → Kafka → Stream processor（optional, typically for ETL) → Kafka（optional）→ Druid → Application / user，而批处理的链路为 Raw data → Kafka（optional）→ HDFS → ETL process（optional）→ Druid → Application / user</div>



<h3 id="OLTP-vs-OLAP"><a href="#OLTP-vs-OLAP" class="headerlink" title="OLTP vs OLAP"></a>OLTP vs OLAP</h3><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">OLTP</th>
<th style="text-align:center">OLAP</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">全称</td>
<td style="text-align:center"><strong>O</strong>n<strong>l</strong>ine <strong>T</strong>ransaction <strong>P</strong>rocessing</td>
<td style="text-align:center"><strong>O</strong>n<strong>l</strong>ine <strong>A</strong>nalytical <strong>P</strong>rocessing</td>
</tr>
<tr>
<td style="text-align:center">中文</td>
<td style="text-align:center">联机事务处理</td>
<td style="text-align:center">联机分析处理</td>
</tr>
<tr>
<td style="text-align:center">技术类别</td>
<td style="text-align:center">关系型数据库</td>
<td style="text-align:center">数据仓库</td>
</tr>
<tr>
<td style="text-align:center">场景</td>
<td style="text-align:center">基本的、日常的事务处理</td>
<td style="text-align:center">复杂的分析操作，侧重决策支持</td>
</tr>
<tr>
<td style="text-align:center">例子</td>
<td style="text-align:center">银行交易</td>
<td style="text-align:center">广告投放</td>
</tr>
<tr>
<td style="text-align:center">面向对象</td>
<td style="text-align:center">业务处理人员</td>
<td style="text-align:center">分析决策人员</td>
</tr>
<tr>
<td style="text-align:center">面向维度</td>
<td style="text-align:center">应用</td>
<td style="text-align:center">主题</td>
</tr>
<tr>
<td style="text-align:center">实时性</td>
<td style="text-align:center">高要求（如，银行交易希望能秒级完成）</td>
<td style="text-align:center">低要求（如，报表统计希望能天级完成）</td>
</tr>
<tr>
<td style="text-align:center">主要操作</td>
<td style="text-align:center">增删改</td>
<td style="text-align:center">查询</td>
</tr>
<tr>
<td style="text-align:center">数据的目的</td>
<td style="text-align:center">控制和运行基本业务任务</td>
<td style="text-align:center">帮助规划、解决问题和决策支持</td>
</tr>
<tr>
<td style="text-align:center">数据是什么</td>
<td style="text-align:center">业务流程的快照</td>
<td style="text-align:center">商业活动的多维视图</td>
</tr>
<tr>
<td style="text-align:center">插入和更新</td>
<td style="text-align:center">由终端用户发起</td>
<td style="text-align:center">由长时间运行的批处理作业定时触发</td>
</tr>
<tr>
<td style="text-align:center">查询复杂度</td>
<td style="text-align:center">简单事务查询</td>
<td style="text-align:center">复杂聚合查询</td>
</tr>
<tr>
<td style="text-align:center">查询数据量</td>
<td style="text-align:center">涉及的记录条数相对较少</td>
<td style="text-align:center">涉及大数据量的聚合</td>
</tr>
<tr>
<td style="text-align:center">处理速度</td>
<td style="text-align:center">通常非常快</td>
<td style="text-align:center">取决于所涉及的数据量，以及是否建立索引</td>
</tr>
<tr>
<td style="text-align:center">存储要求</td>
<td style="text-align:center">归档历史数据，以节省空间</td>
<td style="text-align:center">由于聚合结构的存在，相对更大</td>
</tr>
<tr>
<td style="text-align:center">数据量级别</td>
<td style="text-align:center">GB</td>
<td style="text-align:center">TB</td>
</tr>
<tr>
<td style="text-align:center">数据库设计</td>
<td style="text-align:center">相对标准化</td>
<td style="text-align:center">通常使用较少的表进行非规范化</td>
</tr>
<tr>
<td style="text-align:center">数据模型</td>
<td style="text-align:center">3NF、BCNF</td>
<td style="text-align:center">星型、雪花</td>
</tr>
</tbody>
</table>
</div>
<h3 id="MOLAP-vs-ROLAP"><a href="#MOLAP-vs-ROLAP" class="headerlink" title="MOLAP vs ROLAP"></a>MOLAP vs ROLAP</h3><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">MOLAP</th>
<th style="text-align:center">ROLAP</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">全称</td>
<td style="text-align:center"><strong>M</strong>ulti-dimensional <strong>OLAP</strong></td>
<td style="text-align:center"><strong>R</strong>elational <strong>OLAP</strong></td>
</tr>
<tr>
<td style="text-align:center">特征</td>
<td style="text-align:center">预聚合原始数据，加速聚合查询</td>
<td style="text-align:center"><a href="https://yuzhouwan.com/posts/200906/#MPP">MPP</a> 并⾏化 / 内存加速查询</td>
</tr>
<tr>
<td style="text-align:center">数据库</td>
<td style="text-align:center"><a href="https://yuzhouwan.com/tags/Apache-Druid/">Apache Druid</a> / Apache Kylin</td>
<td style="text-align:center">Apache Impala / Aapche Drill / <a href="https://yuzhouwan.com/tags/Apache-Spark/">Apache SparkSQL</a> / <a href="https://yuzhouwan.com/posts/200906/">Presto</a></td>
</tr>
</tbody>
</table>
</div>
<div class="note info">MPP（Massively Parallel Processor）大规模并行化处理架构</div>



<h3 id="Task-生命周期"><a href="#Task-生命周期" class="headerlink" title="Task 生命周期"></a>Task 生命周期</h3><pre class="mermaid">sequenceDiagram

participant Overlord
participant ZooKeeper
participant MiddleManager
participant Peon

Overlord -&gt;&gt; ZooKeeper : new_task
ZooKeeper -&gt;&gt; ZooKeeper : create path /tasks/mm1
ZooKeeper -&gt;&gt; MiddleManager : new_task
MiddleManager -&gt;&gt; Peon : new_task
Peon -&gt;&gt; ZooKeeper : new_task_status
ZooKeeper -&gt;&gt; ZooKeeper : create path /status/new_task
ZooKeeper -&gt;&gt; Overlord : new_task_status</pre>



<h3 id="写入链路"><a href="#写入链路" class="headerlink" title="写入链路"></a>写入链路</h3><pre class="mermaid">sequenceDiagram

participant MiddleManager
participant DeepStorage
participant MetadataStorage
participant ZooKeeper
participant Historical
participant Coordinator

MiddleManager -&gt;&gt; MiddleManager : indexing task
MiddleManager -&gt;&gt; MiddleManager : create segment
MiddleManager -&gt;&gt; DeepStorage : push segment
MiddleManager -&gt;&gt; MetadataStorage : record segment meta info
loop regularly
  Coordinator -&gt;&gt;+ MetadataStorage : pull segment info
  MetadataStorage --&gt;&gt;- Coordinator : return segment info
end
Coordinator -&gt;&gt;+ ZooKeeper : create ephemeral znode
ZooKeeper --&gt;&gt;- Historical : trigger watch
DeepStorage -&gt;&gt; Historical : pull segment
Historical -&gt;&gt; ZooKeeper : record segment location info
Historical --&gt;&gt; MiddleManager : handoff done</pre>

<div class="note info">Coordinator 会定期从 MetadataStorage 中获取 Segment 信息，拉取的频率由 druid.manager.segments.pollDuration 参数控制（默认值为 PT1M）。另外，druid.manager.config.pollDuration 参数控制拉取配置信息的频率，druid.manager.rules.pollDuration 参数控制拉取 Rule 规则的频率，这两个参数的默认值也均为 PT1M</div>
<div class="note info">需要注意的是 Coordinator 通知 Historical 从 DeepStorage 中加载 Segment 的操作，是通过 ZooKeeper 来通讯的，并且每一个 Historical 进程都会与 ZooKeeper 之间维护一个长连接，以感知 watch 机制发出的事件</div>



<h3 id="Segment-加载"><a href="#Segment-加载" class="headerlink" title="Segment 加载"></a>Segment 加载</h3><pre class="mermaid">sequenceDiagram

participant Historical
participant Disk
participant ZooKeeper

ZooKeeper --&gt;&gt; Historical : CHILD_ADDED event
Historical -&gt;&gt;+ Disk : get all files under info_dir
Disk -&gt;&gt;- Historical : return cached segments info
alt segment does not exist
Historical -&gt;&gt; Disk : delete the corresponding file under info_dir
end
Historical -&gt;&gt; Historical : load local segment
Historical -&gt;&gt; ZooKeeper : register loaded segment</pre>

<div class="note success">加载 Segment 的过程本质上就是反序列化的过程，如果对 Historical 节点滚动重启的时候，直接对其上的所有 Segment 都进行反序列化操作，会使得节点恢复比较缓慢。针对该问题 Apache Druid 在 0.17.0 版本中，引入了懒加载的机制，将反序列化的过程推迟到 Segment 实际被查询的时候进行。该特性可以通过 druid.segmentCache.lazyLoadOnStart 配置项开启，默认值为 false</div>

<p>　如果某个查询命中的 Segment 都存储在一个 Historical 节点上，则会导致该查询无法被并行化处理，查询的 RT 就会增高。因此，Segment 在各个 Historical 节点中的分布要尽可能保证分散。Segment 负载均衡的策略可以由 <code>druid.coordinator.balancer.strategy</code> 参数指定，默认值为 <code>cost</code>。该策略在 Aapche Druid 的 0.9.1 版本中被引入，其大体思路为：随机选择一个 Segment X 后，依次计算该 Segment X 和 Historical 节点上的所有 Segment Y 的 Cost，选取 Cost 值最小的节点（两个 Segment 对应的时间段相距越远，算出的 Cost 值也就越小，那么同时出现在一个 Historical 节点上的概率也就越大），然后到该节点上重新加载 Segment X。具体的计算公式如下：</p>
<script type="math/tex; mode=display">
Cost(X, Y) = \int_{x_0}^{x_1} \int_{y_0}^{y_1} e^{-\lambda|x-y|}{\rm d}x{\rm d}y</script><p>　其中，$X$ 为需要被重新加载的 Segment，其数据覆盖的时间范围为 $[x_0, x_1)$，$Y$ 为 Historical 上某一个 Segment，其数据覆盖的时间范围为 $[y_0, y_1)$，另外 $\lambda$ 为 $\frac{\log_e^2}{24}$，表示 Cost 函数的半衰期为 24 小时</p>
<p>　使用 Cost 负载均衡策略后，Segment 在 Historical 节点中分布情况如下：</p>
<p><img data-src="/picture/druid/apache_druid_balancer_strategy_cost.gif" alt="Apache Druid Balancer Strategy Cost"></p>
<center>（图片来源：<a href="https://github.com/apache/druid/pull/2972" target="_blank" rel="external nofollow noopener noreferrer">Apache Druid</a>™ 的 PR）</center>

<p>　图中，一个点就是一个 Segment，而不同的颜色就用来标识来自不同 DataSource 的 Segment，横坐标表示不同的 Historical 节点，纵坐标表示 Segment 中 Interval 的起始时间</p>
<h3 id="查询链路"><a href="#查询链路" class="headerlink" title="查询链路"></a>查询链路</h3><pre class="mermaid">sequenceDiagram

participant Client
participant Broker
participant ZooKeeper
participant Historical
participant MiddleManager

Client -&gt;&gt;+ Broker : http request
Broker -&gt;&gt;+ ZooKeeper : get segment location info
ZooKeeper --&gt;&gt;- Broker : return segment location info
Broker -&gt;&gt; Broker : split subquery
Broker -&gt;&gt;+ MiddleManager : query new data
MiddleManager --&gt;&gt;- Broker : return new data
Broker -&gt;&gt;+ Historical : query old data
Historical --&gt;&gt;- Broker : return old data
Broker -&gt;&gt; Broker : merge results
Broker -&gt;&gt;- Client : http response</pre>

<div class="note info">对于查询来说，Broker 只会将请求分发到 MiddleManager 和 Historical，而 MetadataStorage 和 DeepStorage 都不会参与其中</div>
<div class="note info">到这里我们可以看出来，Apache Druid 属于 AP 类型的分布式系统。首先是 Availability 可用性，主要体现于，Apache Druid 集群中不存在单点问题，即便是外部组件 MetadataStorage 和 DeepStorage 全部都宕机，也是可以正常进行数据查询的。其次是 Partition Tolerance 分区容错性，则体现在 Coordinator 可以根据 Rule 设置数据的副本数量，而 DeepStorage 也是可以使用 HDFS 这类支持数据副本的存储媒介。最后是 Consistency 一致性，这一点在 Apache Druid 中相对而言是被弱化的</div>
<div class="note success">在默认 v2 版本的 GroupBy 策略下，只有字符串字典会存储在堆内内存，Segment 数据都存储在堆外内存。同时，支持将数据压缩（LZ4）并溢出到磁盘上（通过环境变量 java.io.tmpdir 控制存储路径，默认 Linux 系统下为 /tmp），以避免内存出现 OOM 问题。不过，如果用于溢出的磁盘空间不足，仍会导致查询失败。具体的溢出逻辑，详见：org.apache.druid.query.groupby.epinephelinae.SpillingGrouper#spill。另外，Broker 采用多路归并排序（K-way Merge Sort）算法，将计算结果进行汇总</div>



<h3 id="SQL"><a href="#SQL" class="headerlink" title="SQL"></a>SQL</h3><pre class="mermaid">sequenceDiagram

participant HTTP Client
participant JDBC Driver
participant SqlResource
participant Avatica Jetty Handler
participant DruidMeta
participant Parser
participant SqlToRelConverter
participant Optimizer
participant Druid Schema
participant Druid RulesSet
participant QueryMaker
participant Query Execution

opt send SQL
HTTP Client -&gt;&gt; SqlResource : /druid/v2/sql
SqlResource -&gt;&gt; Parser : SQL
JDBC Driver -&gt;&gt; Avatica Jetty Handler : /druid/v2/sql/avatica
Avatica Jetty Handler -&gt;&gt; DruidMeta : meta
DruidMeta -&gt;&gt; Parser : SQL
end

opt parse SQL by calcite
Parser -&gt;&gt; SqlToRelConverter : SqlNode
SqlToRelConverter -&gt;&gt; Optimizer : RelNode
Optimizer -&gt;&gt; QueryMaker : DruidRel
end

opt execute SQL
QueryMaker -&gt;&gt; Query Execution : Query
end

Query Execution --&gt;&gt; HTTP Client : Result</pre>



<h3 id="整体知识树"><a href="#整体知识树" class="headerlink" title="整体知识树"></a>整体知识树</h3><p><img data-src="/picture/druid/apache_druid_ecosphere.png" alt="Apache Druid"></p>
<center>（利用 MindNode™ 绘制而成）</center>





<h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><h3 id="Powered-By"><a href="#Powered-By" class="headerlink" title="Powered By"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://druid.apache.org/druid-powered">Powered By</a></h3><p>　从 Apache Druid 官网看到有 100 多家企业都在使用，也包括了很多国内的公司，例如 BAT、字节跳动™、知乎™、优酷™、小米™、Oppo™、有赞™、作业帮™等等，大概占到 10% 左右</p>
<h3 id="主要应用"><a href="#主要应用" class="headerlink" title="主要应用"></a>主要应用</h3><ul>
<li><p>点击流分析（Web 和 移动端分析）</p>
</li>
<li><p>风控</p>
</li>
<li><p>网络遥测分析（网络性能监控）</p>
</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">分类</th>
<th style="text-align:center">协议</th>
<th style="text-align:center">优点</th>
<th style="text-align:center">缺点</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">主动测量</td>
<td style="text-align:center">PING、Traceroute、Iperf、IPMP、OWAMP、TWAMP、MPLS L/DM、Pingmesh</td>
<td style="text-align:center">易用且灵活</td>
<td style="text-align:center">网络增加额外带宽 / 处理开销，会引起海森堡测不准效应</td>
</tr>
<tr>
<td style="text-align:center">被动测量</td>
<td style="text-align:center">Netflow、sFlow、IPFIX、PSAMP</td>
<td style="text-align:center">不会因测量产生额外的负载</td>
<td style="text-align:center">只能监测交换节点本地状态信息，而不能监测网络状态和丢包率等全局状态信息</td>
</tr>
<tr>
<td style="text-align:center">混合测量</td>
<td style="text-align:center">Reactive Measurement、In-band Measurement、AM-PM、Postcard Based Telemetry、In-band Flow Analyzer、Hybrid Two Steps</td>
<td style="text-align:center">能够对网络拓扑、网络性能和网络流量实现更细粒度的测量</td>
<td style="text-align:center">1. 带内网络遥测检测范围有限，预先定义的随路检测特性使得带内网络遥测往往无法及时获得全网全状态的网络视图。因此，带内网络遥测只能监测特定路径上的某些数据包的遥测数据；<br>2. 由于将遥测指令和数据封装到正常数据包中，正常数据包的有效载荷比降低，遥测开销较大；<br>3. 遥测指令和数据的构造、封装、填充和提取等环节增加了交换机处理负担</td>
</tr>
</tbody>
</table>
</div>
<ul>
<li><p>服务器指标存储</p>
</li>
<li><p>供应链分析（制造指标）</p>
</li>
<li><p>应用程序性能指标</p>
</li>
<li><p>商业智能 / OLAP</p>
</li>
</ul>
<h3 id="适合的场景"><a href="#适合的场景" class="headerlink" title="适合的场景"></a>适合的场景</h3><ul>
<li>插入率很高，但更新并不常见</li>
<li>大多数查询都是聚合查询和 groupBy 分组查询，包括搜索和扫描查询</li>
<li>查询响应时间为百毫秒~几秒钟之间</li>
<li>时序数据</li>
<li>可能有多个表，但是每个查询仅命中其中某一个表</li>
<li>具有高基数数据列（例如 URL，用户 ID 等），并且需要对其进行快速计数和排序</li>
<li>要从 Kafka，HDFS，本地文件或 Amazon S3、AliyunOSS 之类的对象存储中加载数据</li>
</ul>
<div class="note success">Apache Druid 支持将 groupBy 查询的中间结果溢出存储至磁盘，以应对大查询导致的内存资源不足。通过 druid.query.groupBy.maxOnDiskStorage 配置项可以控制对应的磁盘空间大小，默认值为 0，表示不开启该特性</div>

<h3 id="不合适的场景"><a href="#不合适的场景" class="headerlink" title="不合适的场景"></a>不合适的场景</h3><ul>
<li>使用主键对现有记录进行低延迟更新。 Druid 支持流式插入，但不支持流式更新（使用后台批处理作业完成更新）</li>
<li>正在构建脱机报告系统，此时查询延迟不是很重要</li>
<li>需要进行大的联接查询（将一个大事实表连接到另一个大事实表），并且可以花很长时间来完成这些查询</li>
</ul>
<div class="note danger">网上关于 Apache Druid 教程有很多，其中也会提及一些缺点，但是 Apache Druid 社区发展是十分迅速的，例如“不支持 Join”、“不能存储明细数据”之类的说法已经过时了，希望大家能够以 Apache Druid 官网提供的最新版本为准</div>





<h2 id="性能测试"><a href="#性能测试" class="headerlink" title="性能测试"></a>性能测试</h2><p>　<strong>TPC</strong>™（<strong>T</strong>ransactionprocessing <strong>P</strong>erformance <strong>C</strong>ouncil，事务处理性能委员会）是一个发布基准程序的标准规范的非盈利组织。基于 TPC 定义的 TPC-H 规范，麻省大学定义了一套基准测试规范，可用于测试数据库产品在星型模式下的性能表现，即 <strong><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/electrum/ssb-dbgen">SSB</a></strong>（<strong>S</strong>tar <strong>S</strong>chema <strong>B</strong>enchmark）。它将 TPC-H 的雪花模式简化为了星型模式，将基准查询由 TPC-H 的复杂 Ad-Hoc 查询改为了结构更固定的 OLAP 查询</p>
<p><img data-src="/picture/druid/apache_druid_benchmark_partition_hashing_on.png" alt="Apache Druid Benchmark with Partition Hashing On"><br><img data-src="/picture/druid/apache_druid_benchmark_partition_hashing_off.png" alt="Apache Druid Benchmark with Partition Hashing Off"></p>
<center>（图片来源：<a href="https://imply.io/post/performance-benchmark-druid-presto-hive" target="_blank" rel="external nofollow noopener noreferrer">Imply</a>™ 官网）</center>





<h2 id="源码阅读"><a href="#源码阅读" class="headerlink" title="源码阅读"></a>源码阅读</h2><h3 id="数据结构-1"><a href="#数据结构-1" class="headerlink" title="数据结构"></a>数据结构</h3><h4 id="R-tree"><a href="#R-tree" class="headerlink" title="R-tree"></a>R-tree</h4><p>　一个空间数据库由一系列对应空间对象的 tuple 组成，而每一个 tuple 具有一个唯一标示（tuple identifier，简称 tupleID），数据库可以通过这个唯一标示获取到该 tuple。R-Tree 所做的就是将这些 tupleID 索引起来</p>
<h4 id="HyperLogLog"><a href="#HyperLogLog" class="headerlink" title="HyperLogLog"></a>HyperLogLog</h4><p>　基数计数会得到一个近似精确的计算结果，比如在执行 <code>Count</code> / <code>Distinct Count</code> 等计数查询的时候，会返回一个浮点数作为预估值</p>
<h3 id="依赖框架"><a href="#依赖框架" class="headerlink" title="依赖框架"></a>依赖框架</h3><h4 id="Apache-Calcite-查询引擎"><a href="#Apache-Calcite-查询引擎" class="headerlink" title="Apache Calcite 查询引擎"></a><a href="https://yuzhouwan.com/posts/201018/">Apache Calcite 查询引擎</a></h4><h4 id="Google-Guice-注入"><a href="#Google-Guice-注入" class="headerlink" title="Google Guice 注入"></a>Google Guice 注入</h4><h4 id="Google-Guava-扩展库"><a href="#Google-Guava-扩展库" class="headerlink" title="Google Guava 扩展库"></a>Google Guava 扩展库</h4><h4 id="JMH-压测"><a href="#JMH-压测" class="headerlink" title="JMH 压测"></a><a href="https://yuzhouwan.com/posts/190413/#JMH-%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95">JMH 压测</a></h4><h3 id="Query-查询流程"><a href="#Query-查询流程" class="headerlink" title="Query 查询流程"></a>Query 查询流程</h3><p><img data-src="/picture/druid/druid_query_processing.png" alt="Apache Druid Query Process"></p>
<center>（利用 StarUML™ 绘制而成）</center>







<h2 id="可视化-1"><a href="#可视化-1" class="headerlink" title="可视化"></a>可视化</h2><h3 id="Apache-Superset"><a href="#Apache-Superset" class="headerlink" title="Apache Superset"></a>Apache Superset</h3><p>　出于篇幅考虑，单独写了一篇博客，详见：<a href="https://yuzhouwan.com/posts/743/">Apache Superset 二次开发</a></p>
<h3 id="Grafana"><a href="#Grafana" class="headerlink" title="Grafana"></a>Grafana</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ helm repo add bitnami https://charts.bitnami.com/bitnami</span><br><span class="line">$ helm install my-release bitnami/grafana</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">NAME: my-release</span><br><span class="line">LAST DEPLOYED: Mon Jul 19 08:03:13 2020</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br><span class="line">TEST SUITE: None</span><br><span class="line">NOTES:</span><br><span class="line">** Please be patient <span class="keyword">while</span> the chart is being deployed **</span><br><span class="line"></span><br><span class="line">1. Get the application URL by running these commands:</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"Browse to http://127.0.0.1:8080"</span></span><br><span class="line">    kubectl port-forward svc/my-release-grafana 8080:3000 &amp;</span><br><span class="line"></span><br><span class="line">2. Get the admin credentials:</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"User: admin"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"Password: <span class="subst">$(kubectl get secret my-release-grafana-admin --namespace default -o jsonpath=<span class="string">"{.data.GF_SECURITY_ADMIN_PASSWORD}"</span> | base64 --decode)</span>"</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ grafana-cli --pluginsDir <span class="string">"<span class="variable">${GF_PATHS_PLUGINS}</span>"</span> plugins install abhisant-druid-datasource</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">kill</span> `ps -ef | grep 3000 | grep -v grep | awk <span class="string">'{print $2}'</span>`; <span class="built_in">export</span> POD_NAME=$(kubectl get pods | grep grafana | awk <span class="string">'{print $1}'</span>) ; nohup kubectl port-forward <span class="variable">$POD_NAME</span> 3000:3000 --address 0.0.0.0 2&gt;&amp;1 &amp;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Pivot"><a href="#Pivot" class="headerlink" title="Pivot"></a>Pivot</h3><h4 id="配置启动"><a href="#配置启动" class="headerlink" title="配置启动"></a>配置启动</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ whereis node</span><br><span class="line">  node: /usr/<span class="built_in">local</span>/bin/node</span><br><span class="line"></span><br><span class="line">$ /usr/<span class="built_in">local</span>/bin/node -v</span><br><span class="line">  v4.2.2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将环境变量引入，而不用 sudo su druid</span></span><br><span class="line">$ su - druid</span><br><span class="line"></span><br><span class="line"><span class="comment"># `--with-comments` 指标可以去掉不用，避免 comment 生成出现问题（部分注释，行开头漏 # 号的情况）</span></span><br><span class="line">$ /usr/<span class="built_in">local</span>/bin/node /home/druid/software/druid/dist/pivot/bin/pivot --druid &lt;druid.broker.host&gt;:8082 --<span class="built_in">print</span>-config &gt; /home/druid/software/druid/dist/pivot/bin/yuzhouwan_metrics.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 需要使用相对路径</span></span><br><span class="line">$ <span class="built_in">cd</span> /home/druid/software/imply-2.0.0</span><br><span class="line">$ nohup dist/pivot/bin/pivot -c /home/druid/software/druid/dist/pivot/bin/config_yuzhouwan_metrics.yaml  &gt;&gt; /home/druid/software/druid/dist/pivot/bin/nohup.log 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line">$ vim /home/druid/software/druid/dist/pivot/bin/config_yuzhouwan_metrics.yaml</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在 pivot 的配置文件中，可以利用简单的表达式，进行计算，如：除以采集的时间窗口，算得 `OPS`</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">metrics02_OPS</span></span><br><span class="line">  <span class="attr">title:</span> <span class="string">metrics02</span> <span class="string">ops</span></span><br><span class="line">  <span class="attr">expression:</span> <span class="string">$main.sum($metrics02_Sum)</span> <span class="string">/</span> <span class="string">$main.sum($period_Sum)</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="效果图"><a href="#效果图" class="headerlink" title="效果图"></a>效果图</h4><p><img data-src="/picture/druid/druid_pivot_hbase_metrics.png" alt="HBase Metrics in Pivot"></p>
<center>（对 <a href="https://docs.imply.io/on-prem/visualize/index" target="_blank" rel="external nofollow noopener noreferrer">Pivot</a>™ 可视化页面的截图）</center>





<h4 id="踩过的坑"><a href="#踩过的坑" class="headerlink" title="踩过的坑"></a>踩过的坑</h4><h5 id="指标项过多，维护配置困难"><a href="#指标项过多，维护配置困难" class="headerlink" title="指标项过多，维护配置困难"></a>指标项过多，维护配置困难</h5><h6 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h6><p>　可以通过 <code>列转行</code> 的方式，在 <code>dimensions</code> 里面增加一个 <code>metric</code> 维度，来管理指标项。如此，可以有效地避免在 <code>metricsSpec</code> 里面维护大量的指标。同时，也方便了动态新增指标项</p>
<p>　不过，<code>列换行</code> 也会带来数据膨胀的问题。如果在资源受限的情况下，很可能还是得在 <code>metricsSepc</code> 里面维护指标。这样的话，可以使用我写的 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-bigdata/yuzhouwan-bigdata-druid/src/main/java/com/yuzhouwan/bigdata/druid/util/DruidUtils.java">DruidUtils</a> 来快速生成配置文件，避免手动去维护配置</p>
<h3 id="Graphite"><a href="#Graphite" class="headerlink" title="Graphite"></a>Graphite</h3><h4 id="基础环境"><a href="#基础环境" class="headerlink" title="基础环境"></a>基础环境</h4><h5 id="OS"><a href="#OS" class="headerlink" title="OS"></a>OS</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ uname -a</span><br><span class="line">  Linux olap03-sit.yuzhouwan.com 2.6.32-431.el6.x86_64 <span class="comment">#1 SMP Fri Nov 22 03:15:09 UTC 2013 x86_64 x86_64 x86_64 GNU/Linux</span></span><br><span class="line"></span><br><span class="line">$ cat /proc/version</span><br><span class="line">  Linux version 2.6.32-431.el6.x86_64 (mockbuild@c6b8.bsys.dev.centos.org) (gcc version 4.4.7 20120313 (Red Hat 4.4.7-4) (GCC) ) <span class="comment">#1 SMP Fri Nov 22 03:15:09 UTC 2013</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># For Fedora and RHEL-derivatives</span></span><br><span class="line">$ sudo yum upgrade python-setuptools -y</span><br><span class="line">$ sudo yum install openssl openssl-devel install zlib zlib-devel readline readline-devel sqlite-devel libffi-devel -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># Machines</span></span><br><span class="line">druid.yuzhouwan.com        10.10.10.1        Druid</span><br><span class="line">graphite.yuzhouwan.com     192.168.1.101     Graphite</span><br></pre></td></tr></tbody></table></figure>
<h5 id="Python"><a href="#Python" class="headerlink" title="Python"></a><a href="https://yuzhouwan.com/posts/43687/">Python</a></h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">$ python --version</span><br><span class="line">  Python 2.7.8</span><br><span class="line"></span><br><span class="line">  [Note]: Superset is tested using Python 2.7 and Python 3.4+. Python 3 is the recommended version, Python 2.6 won<span class="string">'t be supported.'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 升级 Python（stable: Python 2.7.12 | 3.4.5, lastest: Python 3.5.2 [2016/12/15]）</span></span><br><span class="line">https://www.python.org/downloads/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 python ftp 服务器中下载到 对应版本的 python</span></span><br><span class="line">$ wget http://python.org/ftp/python/2.7.12/Python-2.7.12.tgz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译</span></span><br><span class="line">$ tar -zxvf Python-2.7.12.tgz</span><br><span class="line">$ <span class="built_in">cd</span> /root/software/Python-2.7.12</span><br><span class="line">$ ./configure --prefix=/usr/<span class="built_in">local</span>/python27</span><br><span class="line">$ make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line">$ ls /usr/<span class="built_in">local</span>/python27/ -al</span><br><span class="line"></span><br><span class="line">  drwxr-xr-x.  6 root root 4096 12月 15 14:22 .</span><br><span class="line">  drwxr-xr-x. 13 root root 4096 12月 15 14:20 ..</span><br><span class="line">  drwxr-xr-x.  2 root root 4096 12月 15 14:22 bin</span><br><span class="line">  drwxr-xr-x.  3 root root 4096 12月 15 14:21 include</span><br><span class="line">  drwxr-xr-x.  4 root root 4096 12月 15 14:22 lib</span><br><span class="line">  drwxr-xr-x.  3 root root 4096 12月 15 14:22 share</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 覆盖原来的 python6</span></span><br><span class="line">$ <span class="built_in">which</span> python</span><br><span class="line">  /usr/<span class="built_in">local</span>/bin/python</span><br><span class="line"></span><br><span class="line">$ mv /usr/<span class="built_in">local</span>/bin/python /usr/<span class="built_in">local</span>/bin/python_old</span><br><span class="line">$ ln -s /usr/<span class="built_in">local</span>/python27/bin/python /usr/<span class="built_in">local</span>/bin/</span><br><span class="line"></span><br><span class="line">$ python -V</span><br><span class="line">  Python 2.7.12</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 yum 引用的 python 版本为旧版 2.6 的 python</span></span><br><span class="line">$ vim /usr/bin/yum</span><br><span class="line">  <span class="comment"># 第一行修改为 python2.6</span></span><br><span class="line">  <span class="comment">#!/usr/bin/python2.6</span></span><br><span class="line"></span><br><span class="line">$ yum --version | sed <span class="string">'2,$d'</span></span><br><span class="line">  3.2.29</span><br></pre></td></tr></tbody></table></figure>
<h5 id="Pip"><a href="#Pip" class="headerlink" title="Pip"></a>Pip</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ pip --version</span><br><span class="line">  pip 9.0.1 from /usr/<span class="built_in">local</span>/lib/python2.7/site-packages (python 2.7)</span><br><span class="line"></span><br><span class="line"><span class="comment"># upgrade setup tools and pip</span></span><br><span class="line">$ pip install --upgrade setuptools pip</span><br><span class="line"></span><br><span class="line"><span class="comment">## Offline 环境下安装 pip</span></span><br><span class="line"><span class="comment"># https://pypi.python.org/pypi/setuptools#code-of-conduct 下载 setuptools-32.0.0.tar.gz</span></span><br><span class="line">$ tar zxvf setuptools-32.0.0.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> setuptools-32.0.0</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> setuptools-32.0.0</span><br><span class="line">$ python setup.py install</span><br><span class="line"></span><br><span class="line"><span class="comment"># https://pypi.python.org/pypi/pip 下载 pip-9.0.1.tar.gz</span></span><br><span class="line">$ wget --no-check-certificate https://pypi.python.org/packages/11/b6/abcb525026a4be042b486df43905d6893fb04f05aac21c32c638e939e447/pip-9.0.1.tar.gz<span class="comment">#md5=35f01da33009719497f01a4ba69d63c9</span></span><br><span class="line">$ tar zxvf pip-9.0.1.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> pip-9.0.1</span><br><span class="line">$ python setup.py install</span><br><span class="line"></span><br><span class="line">  Installed /usr/<span class="built_in">local</span>/python27/lib/python2.7/site-packages/pip-9.0.1-py2.7.egg</span><br><span class="line">  Processing dependencies <span class="keyword">for</span> pip==9.0.1</span><br><span class="line">  Finished processing dependencies <span class="keyword">for</span> pip==9.0.1</span><br><span class="line"></span><br><span class="line">$ pip --version</span><br><span class="line">  pip 9.0.1 from /root/software/pip-9.0.1 (python 2.7)</span><br></pre></td></tr></tbody></table></figure>
<h5 id="VirtualEnv"><a href="#VirtualEnv" class="headerlink" title="VirtualEnv"></a>VirtualEnv</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ pip install virtualenv</span><br><span class="line"></span><br><span class="line"><span class="comment"># virtualenv is shipped in Python 3 as pyvenv</span></span><br><span class="line">$ virtualenv venv</span><br><span class="line">$ . ./venv/bin/activate</span><br><span class="line"></span><br><span class="line"><span class="comment">## Offline 环境下安装 virtualenv</span></span><br><span class="line"><span class="comment"># https://pypi.python.org/pypi/virtualenv#downloads 下载 virtualenv-15.1.0.tar.gz</span></span><br><span class="line">$ tar zxvf virtualenv-15.1.0.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> virtualenv-15.1.0</span><br><span class="line">$ python setup.py install</span><br><span class="line"></span><br><span class="line">$ virtualenv --version</span><br><span class="line">  15.1.0</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Graphite-相关"><a href="#Graphite-相关" class="headerlink" title="Graphite 相关"></a>Graphite 相关</h4><h5 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root@graphite-sit.yuzhouwan.com (192.168.1.102)</span></span><br><span class="line">$ <span class="built_in">cd</span> /opt</span><br><span class="line">$ virtualenv -p /usr/<span class="built_in">local</span>/bin/python --system-site-packages graphite</span><br><span class="line">$ <span class="built_in">cd</span> graphite</span><br><span class="line">$ <span class="built_in">source</span> bin/activate</span><br><span class="line"></span><br><span class="line">$ pip install https://github.com/graphite-project/ceres/tarball/master  (ceres-0.10.0rc1)</span><br><span class="line">$ pip install whisper                                                   (whisper-0.9.15)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># trouble shooting</span></span><br><span class="line">  $ <span class="built_in">which</span> python</span><br><span class="line">    /root/graphite/bin/python      (<span class="keyword">in</span> virtualenv, otherwise <span class="string">"/usr/local/bin/python"</span>)</span><br><span class="line"></span><br><span class="line">  $ ll /root/graphite/bin/whisper*py</span><br><span class="line">    -rwxr-xr-x 1 root root 2847 Jan  3 17:06 /root/graphite/bin/whisper-create.py</span><br><span class="line">    -rwxr-xr-x 1 root root 2208 Jan  3 17:06 /root/graphite/bin/whisper-diff.py</span><br><span class="line">    -rwxr-xr-x 1 root root 2912 Jan  3 17:06 /root/graphite/bin/whisper-dump.py</span><br><span class="line">    -rwxr-xr-x 1 root root 1790 Jan  3 17:06 /root/graphite/bin/whisper-fetch.py</span><br><span class="line">    -rwxr-xr-x 1 root root 4309 Jan  3 17:06 /root/graphite/bin/whisper-fill.py</span><br><span class="line">    -rwxr-xr-x 1 root root 1081 Jan  3 17:06 /root/graphite/bin/whisper-info.py</span><br><span class="line">    -rwxr-xr-x 1 root root  685 Jan  3 17:06 /root/graphite/bin/whisper-merge.py</span><br><span class="line">    -rwxr-xr-x 1 root root 5994 Jan  3 17:06 /root/graphite/bin/whisper-resize.py</span><br><span class="line">    -rwxr-xr-x 1 root root  929 Jan  3 17:06 /root/graphite/bin/whisper-set-aggregation-method.py</span><br><span class="line">    -rwxr-xr-x 1 root root  980 Jan  3 17:06 /root/graphite/bin/whisper-update.py</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ pip install carbon    (carbon-0.9.15 constantly-15.1.0 incremental-16.10.1 twisted-16.6.0 txamqp-0.6.2 zope.interface-4.3.3)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># trouble shooting</span></span><br><span class="line">  $ ll /root/graphite/bin/carbon*py</span><br><span class="line">    -rwxr-xr-x 1 root root 1095 Jan  3 17:12 /root/graphite/bin/carbon-aggregator.py</span><br><span class="line">    -rwxr-xr-x 1 root root 1095 Jan  3 17:12 /root/graphite/bin/carbon-cache.py</span><br><span class="line">    -rwxr-xr-x 1 root root 4498 Jan  3 17:12 /root/graphite/bin/carbon-client.py</span><br><span class="line">    -rwxr-xr-x 1 root root 1095 Jan  3 17:12 /root/graphite/bin/carbon-relay.py</span><br><span class="line"></span><br><span class="line">$ pip install graphite-web</span><br><span class="line">$ pip install cairocffi</span><br><span class="line"></span><br><span class="line"><span class="comment"># pip freeze | grep graphite-web</span></span><br><span class="line"><span class="comment"># graphite-web==0.9.15</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="graphite-配置"><a href="#graphite-配置" class="headerlink" title="graphite 配置"></a>graphite 配置</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /root/graphite/conf      (otherwise /opt/graphite/conf)</span><br><span class="line"></span><br><span class="line">$ ls -sail</span><br><span class="line">  total 72</span><br><span class="line">  -rw-r--r-- 1 root root  1798 Jan  3 17:54 aggregation-rules.conf.example</span><br><span class="line">  -rw-r--r-- 1 root root   274 Jan  3 17:54 blacklist.conf.example</span><br><span class="line">  -rw-r--r-- 1 root root  2594 Jan  3 17:54 carbon.amqp.conf.example</span><br><span class="line">  -rw-r--r-- 1 root root 17809 Jan  3 17:54 carbon.conf.example</span><br><span class="line">  -rw-r--r-- 1 root root   888 Jan  3 17:54 relay-rules.conf.example</span><br><span class="line">  -rw-r--r-- 1 root root   558 Jan  3 17:54 rewrite-rules.conf.example</span><br><span class="line">  -rw-r--r-- 1 root root   827 Jan  3 17:54 storage-aggregation.conf.example</span><br><span class="line">  -rw-r--r-- 1 root root   489 Jan  3 17:54 storage-schemas.conf.example</span><br><span class="line">  -rw-r--r-- 1 root root   315 Jan  3 17:54 whitelist.conf.example</span><br><span class="line"></span><br><span class="line">$ cp aggregation-rules.conf.example aggregation-rules.conf</span><br><span class="line">$ cp blacklist.conf.example blacklist.conf</span><br><span class="line">$ cp carbon.amqp.conf.example carbon.amqp.conf</span><br><span class="line">$ cp carbon.conf.example carbon.conf</span><br><span class="line"><span class="comment"># following 3 conf files need to install graphite-web firstly</span></span><br><span class="line">$ cp dashboard.conf.example dashboard.conf</span><br><span class="line">$ cp graphite.wsgi.example graphite.wsgi</span><br><span class="line">$ cp graphTemplates.conf.example graphTemplates.conf</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">$ cp relay-rules.conf.example relay-rules.conf</span><br><span class="line">$ cp rewrite-rules.conf.example rewrite-rules.conf</span><br><span class="line">$ cp storage-aggregation.conf.example storage-aggregation.conf</span><br><span class="line">$ cp storage-schemas.conf.example storage-schemas.conf</span><br><span class="line">$ cp whitelist.conf.example whitelist.conf</span><br><span class="line"></span><br><span class="line">$ /root/graphite/bin/carbon-cache.py start</span><br><span class="line"></span><br><span class="line">  Starting carbon-cache (instance a)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># trouble shooting</span></span><br><span class="line">  $ ps -ef | grep carbon</span><br><span class="line">    root     12074     1  0 18:58 ?     00:00:00 /root/graphite/bin/python /root/graphite/bin/carbon-cache.py start</span><br><span class="line"></span><br><span class="line">  $ vim /root/graphite/conf/carbon.conf</span><br><span class="line">    <span class="comment"># carbon.conf 文件中，在 cache 区段下，接收端口这一行包含一个默认值，用于通过平文本协议（plaintext protocol）接受输入指标项</span></span><br><span class="line">    [cache]</span><br><span class="line">    LINE_RECEIVER_INTERFACE = 0.0.0.0</span><br><span class="line">    LINE_RECEIVER_PORT = 2003</span><br><span class="line"></span><br><span class="line">  $ yum install nc -y</span><br><span class="line">  <span class="comment"># echo "&lt;metric path&gt; &lt;metric value&gt; &lt;metric timestamp&gt;" | nc -q0 ${SERVER} ${PORT}</span></span><br><span class="line">  $ <span class="built_in">echo</span> <span class="string">"carbon.agents.graphite-tutorial.metricsReceived 28198 `date +%s`"</span> | nc -c localhost 2003</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Carbon 与 Whisper 交互，将这些时间序列数据存储到文件系统中，可以用 whisper-info 脚本获取为这些指标项创建的 Whisper 文件的元数据信息</span></span><br><span class="line">  $ /root/graphite/bin/whisper-info.py /root/graphite/storage/whisper/carbon/agents/graphite-tutorial/metricsReceived.wsp</span><br></pre></td></tr></tbody></table></figure>
<h5 id="graphite-web-应用"><a href="#graphite-web-应用" class="headerlink" title="graphite web 应用"></a>graphite web 应用</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dependency</span></span><br><span class="line"><span class="comment"># pip install Django==1.9.12 会导致 'WSGIRequest' object has no attribute 'REQUEST' 异常</span></span><br><span class="line">$ pip install django==1.8.17</span><br><span class="line">$ pip install django-tagging</span><br><span class="line"></span><br><span class="line"><span class="comment"># configure</span></span><br><span class="line">$ <span class="built_in">cd</span> /root/graphite/lib/python2.7/site-packages/opt/graphite/webapp/graphite</span><br><span class="line">$ cp local_settings.py.example local_settings.py</span><br><span class="line"><span class="comment"># 创建 SQLite3 数据库 &amp; 赋读写权限 &amp; 修改 local_settings.py</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> /root/graphite/conf</span><br><span class="line">$ cp dashboard.conf.example dashboard.conf</span><br><span class="line">$ cp graphTemplates.conf.example graphTemplates.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># init database</span></span><br><span class="line">$ <span class="built_in">cd</span> /root/graphite/lib/python2.7/site-packages/opt/graphite/webapp/graphite/</span><br><span class="line">$ python /root/graphite/lib/python2.7/site-packages/opt/graphite/webapp/graphite/manage.py syncdb</span><br><span class="line"></span><br><span class="line"> Would you like to create one now? (yes/no): yes</span><br><span class="line"> Username (leave blank to use <span class="string">'root'</span>): graphite</span><br><span class="line"> Email address: bj@yuzhouwan.com</span><br><span class="line"> Password:</span><br><span class="line"> Password (again):</span><br><span class="line"> Superuser created successfully.</span><br><span class="line"></span><br><span class="line"><span class="comment"># start</span></span><br><span class="line">$ mkdir -p /root/graphite/storage/<span class="built_in">log</span>/webapp/</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">''</span> &gt; /root/graphite/storage/<span class="built_in">log</span>/webapp/process.log</span><br><span class="line">$ <span class="built_in">cd</span> /root/graphite</span><br><span class="line">$ PYTHONPATH=/root/graphite/storage/whisper /root/graphite/bin/run-graphite-devel-server.py --port=8085 --libs=/root/graphite/lib/python2.7/site-packages/opt/graphite/webapp /root/graphite 1&gt;/root/graphite/storage/<span class="built_in">log</span>/webapp/process.log 2&gt;&amp;1 &amp;</span><br><span class="line"><span class="comment"># 或者用，python /root/graphite/lib/python2.7/site-packages/opt/graphite/webapp/graphite/manage.py runserver 0.0.0.0:8085</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># trouble shooting</span></span><br><span class="line">  $ tail -f /root/graphite/storage/<span class="built_in">log</span>/webapp/process.log</span><br><span class="line">  http://192.168.1.102:8085/</span><br></pre></td></tr></tbody></table></figure>
<h5 id="graphite-events"><a href="#graphite-events" class="headerlink" title="graphite events"></a>graphite events</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># PYTHONPATH=$GRAPHITE_ROOT/webapp django-admin.py migrate --settings=graphite.settings --run-syncdb</span></span><br><span class="line">$ PYTHONPATH=/root/graphite/lib/python2.7/site-packages/opt/graphite/webapp django-admin.py migrate --settings=graphite.settings --run-syncdb</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Operations to perform:</span><br><span class="line">  Synchronize unmigrated apps: account, cli, render, whitelist, metrics, url_shortener, dashboard, composer, events, browser</span><br><span class="line">  Apply all migrations: admin, contenttypes, tagging, auth, sessions</span><br><span class="line">Synchronizing apps without migrations:</span><br><span class="line">  Creating tables...</span><br><span class="line">  Running deferred SQL...</span><br><span class="line">Running migrations:</span><br><span class="line">  Rendering model states... DONE</span><br><span class="line">  Applying admin<span class="number">.0002</span>_logentry_remove_auto_add... OK</span><br><span class="line">  Applying auth<span class="number">.0007</span>_alter_validators_add_error_messages... OK</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -X POST <span class="string">"http://10.10.10.2:8085/events/"</span> -d <span class="string">'{ "what": "Event - deploy", "tags": ["deploy"], "when": 1467844481, "data": "deploy of master branch happened at Wed Jul  6 22:34:41 UTC 2016" }'</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># trouble shooting</span></span><br><span class="line">http://10.10.10.2:8085/events/  graphite events  when  what  tags</span><br><span class="line">22:34:41 Wed 06 Jul 2016        Event - deploy        [u<span class="string">'deploy'</span>]</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -s <span class="string">"http://10.10.10.2:8085/render/?target=events('exception')&amp;format=json"</span> | json_pp</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  {</span><br><span class="line">    <span class="attr">"target"</span>: <span class="string">"events(exception)"</span>,</span><br><span class="line">    <span class="attr">"datapoints"</span>: [</span><br><span class="line">      [</span><br><span class="line">        <span class="number">1</span>,</span><br><span class="line">        <span class="number">1388966651</span></span><br><span class="line">      ],</span><br><span class="line">      [</span><br><span class="line">        <span class="number">3</span>,</span><br><span class="line">        <span class="number">1388966652</span></span><br><span class="line">      ]</span><br><span class="line">    ]</span><br><span class="line">  }</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>
<h5 id="graphite-index"><a href="#graphite-index" class="headerlink" title="graphite-index"></a>graphite-index</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># douban new UI for graphite</span></span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/douban/graph-index.git</span><br><span class="line">$ <span class="built_in">cd</span> graph-index</span><br><span class="line"></span><br><span class="line">$ vim config.py</span><br><span class="line">  graphite_url = <span class="string">'http://192.168.1.101:9097'</span></span><br><span class="line"></span><br><span class="line">$ crontab -e</span><br><span class="line">  */5 * * * * python /root/software/graphite-index</span><br><span class="line"></span><br><span class="line">$ python /graph-index.py</span><br></pre></td></tr></tbody></table></figure>
<h4 id="整合-Druid"><a href="#整合-Druid" class="headerlink" title="整合 Druid"></a>整合 Druid</h4><h5 id="迁移到内网环境"><a href="#迁移到内网环境" class="headerlink" title="迁移到内网环境"></a>迁移到内网环境</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 192.168.1.102 to 10.10.10.2 (sit)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ps -ef | grep graphite # 关闭所有进程</span></span><br><span class="line"><span class="comment"># rsync 替换 scp 可以确保软链接也能被 cp（补充：用 tar zcvf 打包也是不能解决的）</span></span><br><span class="line">$ rsync -avuz -e ssh /root/graphite root@10.10.10.2:/root</span><br><span class="line"></span><br><span class="line"><span class="comment"># 192.168.1.102 to 192.168.2.101 to 192.168.1.101 (product)</span></span><br><span class="line">$ rsync -avuz -e ssh /root/graphite jinjy@192.168.2.101:/home/jinjy</span><br><span class="line">$ rsync -avuz -e ssh /home/jinjy/graphite root@192.168.1.101:/root</span><br><span class="line"></span><br><span class="line"><span class="comment"># default: --port=8085</span></span><br><span class="line">$ /root/graphite/bin/carbon-cache.py start</span><br><span class="line">$ PYTHONPATH=/root/graphite/storage/whisper /root/graphite/bin/run-graphite-devel-server.py --port=9097 --libs=/root/graphite/lib/python2.7/site-packages/opt/graphite/webapp /root/graphite 1&gt;/root/graphite/storage/<span class="built_in">log</span>/webapp/process.log 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment"># trouble shooting</span></span><br><span class="line">$ ps -ef | grep graphite</span><br><span class="line">  root     30754     1  0 15:42 ?        00:00:00 /root/graphite/bin/python /root/graphite/bin/carbon-cache.py start</span><br><span class="line">  root     30825 28048  3 15:43 pts/1    00:00:00 /root/graphite/bin/python /root/graphite/bin/django-admin runserver --pythonpath /root/graphite/webapp --settings graphite.settings 0.0.0.0:9097</span><br><span class="line">  root     30829 30825  5 15:43 pts/1    00:00:00 /root/graphite/bin/python /root/graphite/bin/django-admin runserver --pythonpath /root/graphite/webapp --settings graphite.settings 0.0.0.0:9097</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> /root/graphite/storage/<span class="built_in">log</span>/carbon-cache/carbon-cache<span class="_">-a</span></span><br><span class="line">  tail -f console.log creates.log listener.log                <span class="comment"># carbon 接收 event 事件相关的日志记录</span></span><br><span class="line">  tail -f /root/graphite/storage/<span class="built_in">log</span>/webapp/process.log</span><br><span class="line"></span><br><span class="line">http://192.168.1.101:9097/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># virtualenv</span></span><br><span class="line">$ rsync -avuz -e ssh /root/software jinjy@192.168.1.101:/home/jinjy</span><br><span class="line">$ rsync -avuz -e ssh /home/jinjy/software/Python-2.7.12.tgz root@192.168.1.101:/root/software</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> /root/software</span><br><span class="line">$ tar zxvf Python-2.7.12.tgz</span><br><span class="line">$ <span class="built_in">cd</span> Python-2.7.12</span><br><span class="line"></span><br><span class="line">$ ./configure --prefix=/usr --<span class="built_in">enable</span>-shared CFLAGS=-fPIC</span><br><span class="line">$ make -j4 &amp;&amp; make -j4 install</span><br><span class="line">$ /sbin/ldconfig -v | grep /</span><br><span class="line">$ python -V</span><br><span class="line">  Python 2.7.12</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 虽然软链接已经 rsync 过来了，但是目标机器相关目录下，没有对应的 python 的动态链接库</span></span><br><span class="line">$ file /root/graphite/lib/python2.7/lib-dynload</span><br><span class="line">  /root/graphite/lib/python2.7/lib-dynload: broken symbolic link to `/usr/<span class="built_in">local</span>/python27/lib/python2.7/lib-dynload<span class="string">'	'</span>`</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 需要和联网环境中，创建 virtualenv 时的 python 全局环境一致</span></span><br><span class="line">$ ./configure --prefix=/usr/<span class="built_in">local</span>/python27 --<span class="built_in">enable</span>-shared CFLAGS=-fPIC</span><br><span class="line">$ make -j4 &amp;&amp; make -j4 install</span><br><span class="line">$ /sbin/ldconfig -v | grep /</span><br><span class="line"></span><br><span class="line">$ ls /usr/<span class="built_in">local</span>/python27/lib/python2.7/lib-dynload -sail</span><br></pre></td></tr></tbody></table></figure>
<h5 id="修改-Druid-配置"><a href="#修改-Druid-配置" class="headerlink" title="修改 Druid 配置"></a>修改 Druid 配置</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ sudo su druid</span><br><span class="line">$ <span class="built_in">cd</span> /home/druid/software/druid</span><br><span class="line"></span><br><span class="line">$ find | grep common.runtime.properties | grep -v quickstart | grep -v dist</span><br><span class="line">  ./conf/druid/_common/common.runtime.properties</span><br><span class="line"></span><br><span class="line">$ cp /home/druid/software/druid/conf/druid/_common/common.runtime.properties /home/druid/software/druid/conf/druid/_common/common.runtime.properties.bak</span><br><span class="line">$ vim /home/druid/software/druid/conf/druid/_common/common.runtime.properties</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># module</span></span><br><span class="line"><span class="meta">druid.extensions.loadList</span>=<span class="string">[..., "graphite-emitter"]</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Monitoring</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="meta">druid.monitoring.monitors</span>=<span class="string">["com.metamx.metrics.JvmMonitor"]</span></span><br><span class="line"><span class="meta">druid.emitter</span>=<span class="string">http</span></span><br><span class="line"><span class="comment">#druid.emitter=logging</span></span><br><span class="line"><span class="meta">druid.emitter.logging.logLevel</span>=<span class="string">info</span></span><br><span class="line"><span class="meta">druid.emitter.http.recipientBaseUrl</span>=<span class="string">http://10.37.2.142:9999/metrics</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># monitor</span></span><br><span class="line"><span class="meta">druid.monitoring.monitors</span>=<span class="string">["com.metamx.metrics.JvmMonitor"]</span></span><br><span class="line"><span class="meta">druid.emitter</span>=<span class="string">composing</span></span><br><span class="line"><span class="meta">druid.emitter.composing.emitters</span>=<span class="string">["graphite", "logging"]</span></span><br><span class="line"><span class="meta">druid.emitter.graphite.hostname</span>=<span class="string">localhost</span></span><br><span class="line"><span class="comment"># 端口需要注意，不是 2003（即，非 /root/graphite/conf/carbon.conf 中的 LINE_RECEIVER_PORT or LINE_RECEIVER_PORT，而是 PICKLE_RECEIVER_PORT）</span></span><br><span class="line"><span class="meta">druid.emitter.graphite.port</span>=<span class="string">2004</span></span><br><span class="line"><span class="comment"># druid.emitter.graphite.eventConverter={"type":"whiteList", "namespacePrefix": "cluster_x", "ignoreHostname":true, "ignoreServiceName":false, "mapFile":"/a/b/c"}</span></span><br><span class="line"><span class="meta">druid.emitter.graphite.eventConverter</span>=<span class="string">{"ingest/events/thrownAway":["dataSource"],"ingest/events/unparseable":["dataSource"],"ingest/events/processed":["dataSource"],"ingest/handoff/failed":["dataSource"],"ingest/persists":[],"ingest/rows/output":[],"jvm/gc":[],"jvm/mem":[],"query/cpu/time":["dataSource","type"],"query/node/time":["dataSource","type"],"query/node/ttfb":["dataSource","type"],"query/partial/time":["dataSource","type"],"query/segment/time":["dataSource","type"],"query/segmentAndCache/time":["dataSource","type"],"query/time":["dataSource","type"],"query/wait/time":["dataSource","type"],"segment/count":[],"segment/dropQueue/count":[],"segment/loadQueue/count":[],"segment/loadQueue/failed":[],"segment/loadQueue/size":[],"segment/scan/pending":[],"segment/size":[],"segment/usedPercent":[]}</span></span><br><span class="line"><span class="meta">druid.emitter.logging.logLevel</span>=<span class="string">info</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">druid.emitter.graphite.eventConverter</span>=<span class="string">{"type":"all", "namespacePrefix": "druid", "ignoreHostname": false, "ignoreServiceName": false}</span></span><br><span class="line"><span class="comment">## pertty format start ##</span></span><br><span class="line"><span class="attr">{</span></span><br><span class="line">  <span class="meta">"ingest/events/thrownAway"</span>: <span class="string">["dataSource"],</span></span><br><span class="line">  <span class="meta">"ingest/events/unparseable"</span>: <span class="string">["dataSource"],</span></span><br><span class="line">  <span class="meta">"ingest/events/processed"</span>: <span class="string">["dataSource"],</span></span><br><span class="line">  <span class="meta">"ingest/handoff/failed"</span>: <span class="string">["dataSource"],</span></span><br><span class="line">  <span class="meta">"ingest/persists"</span>: <span class="string">[],</span></span><br><span class="line">  <span class="meta">"ingest/rows/output"</span>: <span class="string">[],</span></span><br><span class="line">  <span class="meta">"jvm/gc"</span>: <span class="string">[],</span></span><br><span class="line">  <span class="meta">"jvm/mem"</span>: <span class="string">[],</span></span><br><span class="line">  <span class="meta">"query/cpu/time"</span>: <span class="string">[</span></span><br><span class="line">    <span class="attr">"dataSource",</span></span><br><span class="line">    <span class="attr">"type"</span></span><br><span class="line">  <span class="attr">],</span></span><br><span class="line">  <span class="meta">"query/node/time"</span>: <span class="string">[</span></span><br><span class="line">    <span class="attr">"dataSource",</span></span><br><span class="line">    <span class="attr">"type"</span></span><br><span class="line">  <span class="attr">],</span></span><br><span class="line">  <span class="meta">"query/node/ttfb"</span>: <span class="string">[</span></span><br><span class="line">    <span class="attr">"dataSource",</span></span><br><span class="line">    <span class="attr">"type"</span></span><br><span class="line">  <span class="attr">],</span></span><br><span class="line">  <span class="meta">"query/partial/time"</span>: <span class="string">[</span></span><br><span class="line">    <span class="attr">"dataSource",</span></span><br><span class="line">    <span class="attr">"type"</span></span><br><span class="line">  <span class="attr">],</span></span><br><span class="line">  <span class="meta">"query/segment/time"</span>: <span class="string">[</span></span><br><span class="line">    <span class="attr">"dataSource",</span></span><br><span class="line">    <span class="attr">"type"</span></span><br><span class="line">  <span class="attr">],</span></span><br><span class="line">  <span class="meta">"query/segmentAndCache/time"</span>: <span class="string">[</span></span><br><span class="line">    <span class="attr">"dataSource",</span></span><br><span class="line">    <span class="attr">"type"</span></span><br><span class="line">  <span class="attr">],</span></span><br><span class="line">  <span class="meta">"query/time"</span>: <span class="string">[</span></span><br><span class="line">    <span class="attr">"dataSource",</span></span><br><span class="line">    <span class="attr">"type"</span></span><br><span class="line">  <span class="attr">],</span></span><br><span class="line">  <span class="meta">"query/wait/time"</span>: <span class="string">[</span></span><br><span class="line">    <span class="attr">"dataSource",</span></span><br><span class="line">    <span class="attr">"type"</span></span><br><span class="line">  <span class="attr">],</span></span><br><span class="line">  <span class="meta">"segment/count"</span>: <span class="string">[],</span></span><br><span class="line">  <span class="meta">"segment/dropQueue/count"</span>: <span class="string">[],</span></span><br><span class="line">  <span class="meta">"segment/loadQueue/count"</span>: <span class="string">[],</span></span><br><span class="line">  <span class="meta">"segment/loadQueue/failed"</span>: <span class="string">[],</span></span><br><span class="line">  <span class="meta">"segment/loadQueue/size"</span>: <span class="string">[],</span></span><br><span class="line">  <span class="meta">"segment/scan/pending"</span>: <span class="string">[],</span></span><br><span class="line">  <span class="meta">"segment/size"</span>: <span class="string">[],</span></span><br><span class="line">  <span class="meta">"segment/usedPercent"</span>: <span class="string">[]</span></span><br><span class="line"><span class="attr">}</span></span><br><span class="line"><span class="comment">## pertty format end ##</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kill historical process to make configure activate</span></span><br><span class="line">$ jps -m</span><br><span class="line">  1867 Main server historical</span><br><span class="line">  26339 Main server middleManager</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">kill</span> 1867</span><br></pre></td></tr></tbody></table></figure>
<h5 id="校验-2"><a href="#校验-2" class="headerlink" title="校验"></a>校验</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tail -f var/sv/supervise.log</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[Thu Jan  <span class="number">5</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">17</span> <span class="number">2017</span>] Running command[historical], logging to[/home/druid/software/imply-<span class="number">2.0</span>.<span class="number">0</span>/<span class="keyword">var</span>/sv/historical.log]: bin/run-druid historical conf</span><br><span class="line">[Thu Jan  <span class="number">5</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">21</span> <span class="number">2017</span>] Command[historical] exited (pid = <span class="number">1752</span>, exited = <span class="number">1</span>)</span><br><span class="line">[Thu Jan  <span class="number">5</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">21</span> <span class="number">2017</span>] Command[historical] failed, see logfile <span class="keyword">for</span> more details: /home/druid/software/imply-<span class="number">2.0</span>.<span class="number">0</span>/<span class="keyword">var</span>/sv/historical.log</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tail -f  /home/druid/software/imply-2.0.0/var/sv/historical.log</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2017</span>-<span class="number">01</span>-<span class="number">05</span>T11:<span class="number">34</span>:<span class="number">29</span>,<span class="number">203</span> INFO [GraphiteEmitter-<span class="number">1</span>] io.druid.emitter.graphite.GraphiteEmitter - trying to connect to graphite server</span><br></pre></td></tr></tbody></table></figure>
<div class="note info">如果连接不上，会报错 ERROR [GraphiteEmitter-1] io.druid.emitter.graphite.GraphiteEmitter - 拒绝连接，则需要检查 Graphite 进程是否运行正常</div>



<h4 id="优化配置"><a href="#优化配置" class="headerlink" title="优化配置"></a>优化配置</h4><h5 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h5><h6 id="Django"><a href="#Django" class="headerlink" title="Django"></a>Django</h6><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ pip freeze | grep Django</span><br><span class="line">  Django==1.8</span><br><span class="line"></span><br><span class="line">$ pip install --upgrade Django</span><br><span class="line">  Successfully installed Django-1.10.5</span><br><span class="line"></span><br><span class="line">$ pip uninstall Django</span><br><span class="line">$ pip install Django==1.8.17</span><br></pre></td></tr></tbody></table></figure>
<div class="note warning">高版本 Django 会导致 'WSGIRequest' object has no attribute 'REQUEST' 异常</div>

<h6 id="Graphite-Web-相关"><a href="#Graphite-Web-相关" class="headerlink" title="Graphite-Web 相关"></a>Graphite-Web 相关</h6><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim requirements.txt</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">python-memcached</span>=<span class="string">=1.47</span></span><br><span class="line"><span class="attr">txAMQP</span>=<span class="string">=0.4</span></span><br><span class="line"><span class="attr">simplejson</span>=<span class="string">=2.1.6</span></span><br><span class="line"><span class="meta">django-tagging</span>=<span class="string">=0.4.3</span></span><br><span class="line"><span class="attr">gunicorn</span></span><br><span class="line"><span class="attr">pytz</span></span><br><span class="line"><span class="attr">pyparsing</span>=<span class="string">=1.5.7</span></span><br><span class="line"><span class="attr">cairocffi</span></span><br><span class="line"><span class="attr">whitenoise</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pip install -r requirements.txt</span><br></pre></td></tr></tbody></table></figure>
<h5 id="采集"><a href="#采集" class="headerlink" title="采集"></a>采集</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim /root/graphite/conf/storage-schemas.conf</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[carbon]</span></span><br><span class="line"><span class="attr">pattern</span> = <span class="string">^carbon\.</span></span><br><span class="line"><span class="attr">retentions</span> = <span class="string">60:90d</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[default_1min_for_1day]</span></span><br><span class="line"><span class="attr">pattern</span> = <span class="string">.*</span></span><br><span class="line"><span class="comment"># retentions = 60s:1d</span></span><br><span class="line"><span class="comment"># 改为 3 种时间粒度</span></span><br><span class="line"><span class="attr">retentions</span> = <span class="string">10s:6h,1m:7d,10m:1y</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python /root/graphite/examples/example-client.py</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sending message</span><br><span class="line"></span><br><span class="line">-----------------------------------------------------</span><br><span class="line">system.loadavg_1min <span class="number">0.26</span> <span class="number">1483690449</span></span><br><span class="line">system.loadavg_5min <span class="number">0.30</span> <span class="number">1483690449</span></span><br><span class="line">system.loadavg_15min <span class="number">0.35</span> <span class="number">1483690449</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="启动命令汇总"><a href="#启动命令汇总" class="headerlink" title="启动命令汇总"></a>启动命令汇总</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ python /root/graphite/lib/python2.7/site-packages/opt/graphite/webapp/graphite/manage.py syncdb</span><br><span class="line">$ PYTHONPATH=/root/graphite/lib/python2.7/site-packages/opt/graphite/webapp django-admin.py migrate --settings=graphite.settings --run-syncdb</span><br><span class="line"></span><br><span class="line">$ /root/graphite/bin/carbon-cache.py start</span><br><span class="line">$ PYTHONPATH=/root/graphite/storage/whisper /root/graphite/bin/run-graphite-devel-server.py --port=9097 --libs=/root/graphite/webapp /root/graphite 1&gt;/root/graphite/storage/<span class="built_in">log</span>/webapp/process.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></tbody></table></figure>
<h4 id="踩过的坑-1"><a href="#踩过的坑-1" class="headerlink" title="踩过的坑"></a>踩过的坑</h4><h5 id="ImportError-No-module-named-carbon-util"><a href="#ImportError-No-module-named-carbon-util" class="headerlink" title="ImportError: No module named carbon.util"></a>ImportError: No module named carbon.util</h5><h6 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h6><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(graphite) [root@graphite-sit.yuzhouwan.com conf]<span class="comment"># /root/graphite/bin/carbon-cache.py start</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"/root/graphite/bin/carbon-cache.py"</span>, line <span class="number">28</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    <span class="keyword">from</span> carbon.util <span class="keyword">import</span> run_twistd_plugin</span><br><span class="line">ImportError: No module named carbon.util</span><br></pre></td></tr></tbody></table></figure>
<h6 id="解决-1"><a href="#解决-1" class="headerlink" title="解决"></a>解决</h6><ul>
<li>检查 carbon 是否已安装</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pip freeze</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">carbon</span>=<span class="string">=0.9.15</span></span><br><span class="line"><span class="attr">ceres</span>=<span class="string">=0.10.0rc1</span></span><br><span class="line"><span class="attr">constantly</span>=<span class="string">=15.1.0</span></span><br><span class="line"><span class="attr">incremental</span>=<span class="string">=16.10.1</span></span><br><span class="line"><span class="attr">Twisted</span>=<span class="string">=16.6.0</span></span><br><span class="line"><span class="attr">txAMQP</span>=<span class="string">=0.6.2</span></span><br><span class="line"><span class="attr">whisper</span>=<span class="string">=0.9.15</span></span><br><span class="line"><span class="meta">zope.interface</span>=<span class="string">=4.3.3</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>graphiteˊs default prefix (/opt/graphite)</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ mv /root/graphite/lib/python2.7/site-packages/opt/graphite/lib/carbon /root/graphite/lib/python2.7/site-packages/</span><br><span class="line">$ mv /root/graphite/lib/python2.7/site-packages/opt/graphite/lib/twisted/plugins/carbon_* /root/graphite/lib/python2.7/site-packages/twisted/plugins/</span><br></pre></td></tr></tbody></table></figure>
<h5 id="django-db-utils-OperationalError-unable-to-open-database-file"><a href="#django-db-utils-OperationalError-unable-to-open-database-file" class="headerlink" title="django.db.utils.OperationalError: unable to open database file"></a>django.db.utils.OperationalError: unable to open database file</h5><h6 id="描述-1"><a href="#描述-1" class="headerlink" title="描述"></a>描述</h6><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python manage.py syncdb</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/root/graphite/lib/python2<span class="number">.7</span>/site-packages/opt/graphite/webapp/graphite/settings.py:<span class="number">246</span>: UserWarning: SECRET_KEY <span class="keyword">is</span> set to an unsafe default. This should be set <span class="keyword">in</span> local_settings.py <span class="keyword">for</span> better security</span><br><span class="line">warn(<span class="string">'SECRET_KEY is set to an unsafe default. This should be set in local_settings.py for better security'</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">File <span class="string">"manage.py"</span>, line <span class="number">13</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  execute_from_command_line(sys.argv)</span><br><span class="line">File <span class="string">"/root/graphite/lib/python2.7/site-packages/django/core/management/__init__.py"</span>, line <span class="number">338</span>, <span class="keyword">in</span> execute_from_command_line</span><br><span class="line">utility.execute()</span><br><span class="line">// ...</span><br><span class="line">django.db.utils.OperationalError: unable to open database file</span><br></pre></td></tr></tbody></table></figure>
<h6 id="解决-2"><a href="#解决-2" class="headerlink" title="解决"></a>解决</h6><ul>
<li>change default SECRET_KEY in settings.py</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim /root/graphite/lib/python2.7/site-packages/opt/graphite/webapp/graphite/settings.py</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Django 1.5 requires this so we set a default but warn the user</span></span><br><span class="line"><span class="comment"># SECRET_KEY = 'UNSAFE_DEFAULT'</span></span><br><span class="line">SECRET_KEY = <span class="string">'graphite'</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>change DATABASE_NAME in sqlites</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir /root/graphite/sqlite</span><br><span class="line">$ <span class="built_in">cd</span> /root/graphite/sqlite</span><br><span class="line"></span><br><span class="line"><span class="comment"># create database</span></span><br><span class="line">$ sqlite3 graphite.db</span><br><span class="line">$ sqlite3</span><br><span class="line">sqlite&gt;.<span class="built_in">help</span></span><br><span class="line">sqlite&gt;.databases</span><br><span class="line">  seq  name             file</span><br><span class="line">  ---  ---------------  ------------------------------------------</span><br><span class="line">  0    main             /root/graphite/sqlite/graphite.db</span><br><span class="line"></span><br><span class="line">  Crtl + D (<span class="built_in">exit</span> like python)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># change DATABASE_NAME</span></span><br><span class="line">  DATABASE_NAME=<span class="string">'/root/graphite/sqlite/graphite.db'</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="variable">$DATABASE_NAME</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># run 'python manage.py syncdb' again, then the graphite database disappeared</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>modify settings.py for sqlite database</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /root/graphite/storage</span><br><span class="line">$ mkdir db</span><br><span class="line">$ <span class="built_in">cd</span> db</span><br><span class="line">$ sqlite3 graphite.db</span><br><span class="line">$ vim /root/graphite/lib/python2.7/site-packages/django/conf/project_template/project_name/settings.py</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># GRAPHITE_STORAGE_DIR = '/root/graphite/sqlite/graphite.db'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#DATABASES = {</span></span><br><span class="line"><span class="comment">#    'default': {</span></span><br><span class="line"><span class="comment">#        'ENGINE': 'django.db.backends.sqlite3',</span></span><br><span class="line"><span class="comment">#        'NAME': os.path.join(BASE_DIR, 'db.sqlite3'),</span></span><br><span class="line"><span class="comment">#    }</span></span><br><span class="line"><span class="comment">#}</span></span><br><span class="line">DATABASES = {</span><br><span class="line">  <span class="string">'default'</span>: {</span><br><span class="line">    <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.sqlite3'</span>, <span class="comment"># Add 'postgresql_psycopg2', 'postgresql', 'mysql', 'sqlite3' or 'oracle'.</span></span><br><span class="line">    <span class="string">'NAME'</span>: <span class="string">'/root/graphite/storage/db/graphite.db'</span>, <span class="comment"># Or path to database file if using sqlite3.</span></span><br><span class="line">    <span class="string">'USER'</span>: <span class="string">''</span>, <span class="comment"># Not used with sqlite3.</span></span><br><span class="line">    <span class="string">'PASSWORD'</span>: <span class="string">''</span>, <span class="comment"># Not used with sqlite3.</span></span><br><span class="line">    <span class="string">'HOST'</span>: <span class="string">''</span>, <span class="comment"># Set to empty string for localhost. Not used with sqlite3.</span></span><br><span class="line">    <span class="string">'PORT'</span>: <span class="string">''</span>, <span class="comment"># Set to empty string for default. Not used with sqlite3.</span></span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># trouble shooting</span></span><br><span class="line">$ sqlite3 /root/graphite/storage/db/graphite.db</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SQLite version 3.6.20</span><br><span class="line">Enter <span class="string">".help"</span> <span class="keyword">for</span> instructions</span><br><span class="line">Enter SQL statements terminated with a <span class="string">";"</span></span><br><span class="line">sqlite&gt; .databases</span><br><span class="line">seq  name             file</span><br><span class="line">---  ---------------  --------------------------------------</span><br><span class="line">0    main             /root/graphite/storage/db/graphite.db</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /root/graphite/</span><br><span class="line">$ find | grep /settings.py | grep -v pyc</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./lib/python2.7/site-packages/opt/graphite/webapp/graphite/settings.py</span><br><span class="line">./lib/python2.7/site-packages/tagging/tests/settings.py</span><br><span class="line">./lib/python2.7/site-packages/tagging/settings.py</span><br><span class="line">./lib/python2.7/site-packages/django/conf/project_template/project_name/settings.py</span><br></pre></td></tr></tbody></table></figure>
<div class="note success">全部修改完成，即可修复</div>

<ul>
<li>检查 Django 是否版本过低（&lt;= v1.4）</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ django-admin version</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1.8</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>检查访问权限</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ cut -d: -f1 /etc/passwd | grep graphite</span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$USER</span></span><br><span class="line">  root</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> /root/graphite/storage/db</span><br><span class="line">$ sudo chown root:root graphite.db</span><br><span class="line">$ sudo chmod o+rw graphite.db</span><br><span class="line">$ sudo chmod o+rwx db/</span><br><span class="line">$ sudo chmod o+rwx ../webapp/</span><br></pre></td></tr></tbody></table></figure>
<h5 id="ImportError-No-module-named-graphite-settings"><a href="#ImportError-No-module-named-graphite-settings" class="headerlink" title="ImportError: No module named graphite.settings"></a>ImportError: No module named graphite.settings</h5><h6 id="描述-2"><a href="#描述-2" class="headerlink" title="描述"></a>描述</h6><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./bin/run-graphite-devel-server.py --port=8085 --libs=/root/graphite/webapp /root/graphite 1&gt;/root/graphite/storage/<span class="built_in">log</span>/webapp/process.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">tail: /root/graphite/storage/log/webapp/process.log: file truncated</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"/root/graphite/bin/django-admin"</span>, line <span class="number">11</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  sys.exit(execute_from_command_line())</span><br><span class="line">  File <span class="string">"/root/graphite/lib/python2.7/site-packages/django/core/management/__init__.py"</span>, line <span class="number">338</span>, <span class="keyword">in</span> execute_from_command_line</span><br><span class="line">  utility.execute()</span><br><span class="line">  File <span class="string">"/root/graphite/lib/python2.7/site-packages/django/core/management/__init__.py"</span>, line <span class="number">303</span>, <span class="keyword">in</span> execute</span><br><span class="line">  settings.INSTALLED_APPS</span><br><span class="line">  File <span class="string">"/root/graphite/lib/python2.7/site-packages/django/conf/__init__.py"</span>, line <span class="number">48</span>, <span class="keyword">in</span> __getattr__</span><br><span class="line">  self._setup(name)</span><br><span class="line">  File <span class="string">"/root/graphite/lib/python2.7/site-packages/django/conf/__init__.py"</span>, line <span class="number">44</span>, <span class="keyword">in</span> _setup</span><br><span class="line">  self._wrapped = Settings(settings_module)</span><br><span class="line">  File <span class="string">"/root/graphite/lib/python2.7/site-packages/django/conf/__init__.py"</span>, line <span class="number">92</span>, <span class="keyword">in</span> __init__</span><br><span class="line">  mod = importlib.import_module(self.SETTINGS_MODULE)</span><br><span class="line">  File <span class="string">"/usr/local/python27/lib/python2.7/importlib/__init__.py"</span>, line <span class="number">37</span>, <span class="keyword">in</span> import_module</span><br><span class="line">  __import__(name)</span><br><span class="line">ImportError: No module named graphite.settings</span><br></pre></td></tr></tbody></table></figure>
<h6 id="解决-3"><a href="#解决-3" class="headerlink" title="解决"></a>解决</h6><ul>
<li>修改 local_settings.py</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim /root/graphite/lib/python2.7/site-packages/opt/graphite/webapp/graphite/local_settings.py</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">DATABASES = {</span><br><span class="line">    <span class="string">'default'</span>: {</span><br><span class="line">        <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.sqlite3'</span>, <span class="comment"># Add 'postgresql_psycopg2', 'postgresql', 'mysql', 'sqlite3' or 'oracle'.</span></span><br><span class="line">        <span class="string">'NAME'</span>: <span class="string">'/root/graphite/storage/db/graphite.db'</span>, <span class="comment"># Or path to database file if using sqlite3.</span></span><br><span class="line">        <span class="string">'USER'</span>: <span class="string">''</span>, <span class="comment"># Not used with sqlite3.</span></span><br><span class="line">        <span class="string">'PASSWORD'</span>: <span class="string">''</span>, <span class="comment"># Not used with sqlite3.</span></span><br><span class="line">        <span class="string">'HOST'</span>: <span class="string">''</span>, <span class="comment"># Set to empty string for localhost. Not used with sqlite3.</span></span><br><span class="line">        <span class="string">'PORT'</span>: <span class="string">''</span>, <span class="comment"># Set to empty string for default. Not used with sqlite3.</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>指定 PYTHONPATH</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ PYTHONPATH=/root/graphite/storage/whisper /root/graphite/bin/run-graphite-devel-server.py --port=8085 --libs=/root/graphite/webapp /root/graphite 1&gt;/root/graphite/storage/<span class="built_in">log</span>/webapp/process.log 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># new problem</span></span><br><span class="line">  ImportError: Cannot import either sping or piddle.</span><br><span class="line"></span><br><span class="line">$ PYTHONPATH=/root/graphite/storage/whisper /root/graphite/bin/run-graphite-devel-server.py --port=8085 --libs=/root/graphite/lib/python2.7/site-packages/opt/graphite/webapp /root/graphite 1&gt;/root/graphite/storage/<span class="built_in">log</span>/webapp/process.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></tbody></table></figure>
<h5 id="OError-Errno-2-No-such-file-or-directory-‘-root-graphite-lib-python2-7-site-packages-opt-graphite-storage-log-webapp-info-log’"><a href="#OError-Errno-2-No-such-file-or-directory-‘-root-graphite-lib-python2-7-site-packages-opt-graphite-storage-log-webapp-info-log’" class="headerlink" title="OError: [Errno 2] No such file or directory: ‘/root/graphite/lib/python2.7/site-packages/opt/graphite/storage/log/webapp/info.log’"></a>OError: [Errno 2] No such file or directory: ‘/root/graphite/lib/python2.7/site-packages/opt/graphite/storage/log/webapp/info.log’</h5><h6 id="描述-3"><a href="#描述-3" class="headerlink" title="描述"></a>描述</h6><p>　访问 <code>http://192.168.1.102:8085/</code> 返回如下信息：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Traceback (most recent call last):</span><br><span class="line">File <span class="string">"/root/graphite/lib/python2.7/site-packages/django/core/handlers/base.py"</span>, line <span class="number">119</span>, <span class="keyword">in</span> get_response</span><br><span class="line">resolver_match = resolver.resolve(request.path_info)</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">File <span class="string">"/usr/local/python27/lib/python2.7/logging/__init__.py"</span>, line <span class="number">943</span>, <span class="keyword">in</span> _open</span><br><span class="line">stream = open(self.baseFilename, self.mode)</span><br><span class="line">IOError: [Errno <span class="number">2</span>] No such file <span class="keyword">or</span> directory: <span class="string">'/root/graphite/lib/python2.7/site-packages/opt/graphite/storage/log/webapp/info.log'</span></span><br></pre></td></tr></tbody></table></figure>
<h6 id="解决-4"><a href="#解决-4" class="headerlink" title="解决"></a>解决</h6><ul>
<li>增加 <code>info.log</code> 文件</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p /root/graphite/lib/python2.7/site-packages/opt/graphite/storage/<span class="built_in">log</span>/webapp/</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">''</span> &gt; /root/graphite/lib/python2.7/site-packages/opt/graphite/storage/<span class="built_in">log</span>/webapp/info.log</span><br></pre></td></tr></tbody></table></figure>
<h5 id="Graphite-Web-页面无-event-数据"><a href="#Graphite-Web-页面无-event-数据" class="headerlink" title="Graphite Web 页面无 event 数据"></a>Graphite Web 页面无 event 数据</h5><h6 id="描述-4"><a href="#描述-4" class="headerlink" title="描述"></a>描述</h6><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 访问 http://192.168.1.101:9097/events/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 Druid 中是能看到 historical 进程的确在产生数据，并且成功连接到了 graphite</span></span><br><span class="line">$ tail -f /home/druid/software/imply-2.0.0/var/sv/historical.log</span><br><span class="line"></span><br><span class="line">  2017-01-05T11:34:29,203 INFO [GraphiteEmitter-1] io.druid.emitter.graphite.GraphiteEmitter - trying to connect to graphite server</span><br><span class="line">  <span class="comment"># 如果连接不上，会报错 ERROR [GraphiteEmitter-1] io.druid.emitter.graphite.GraphiteEmitter - 拒绝连接</span></span><br><span class="line">  <span class="comment"># 则检查 graphite 进程是否正常</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 Graphite 中也能看到数据被收到了</span></span><br><span class="line">$ <span class="built_in">cd</span> /root/graphite/storage/<span class="built_in">log</span>/carbon-cache/carbon-cache<span class="_">-a</span></span><br><span class="line">$ tail -f console.log creates.log listener.log</span><br><span class="line"></span><br><span class="line">  05/01/2017 20:05:18 :: Sorted 75 cache queues <span class="keyword">in</span> 0.000208 seconds</span><br><span class="line">  <span class="comment"># 如果数据有误，会报错 05/01/2017 20:32:32 :: invalid line ((L1483619493L) received from client 10.10.10.1:41752, ignoring</span></span><br><span class="line">  <span class="comment"># 则检查 druid emitter 配置是否正常</span></span><br></pre></td></tr></tbody></table></figure>
<h6 id="解决-5"><a href="#解决-5" class="headerlink" title="解决"></a>解决</h6><ul>
<li>是否是 SQLite 数据库没有成功存储</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># graphite 配置没有问题</span></span><br><span class="line">$ vim /root/graphite/lib/python2.7/site-packages/django/conf/project_template/project_name/settings.py</span><br><span class="line"></span><br><span class="line">  DATABASES = {</span><br><span class="line">    <span class="string">'default'</span>: {</span><br><span class="line">      <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.sqlite3'</span>, <span class="comment"># Add 'postgresql_psycopg2', 'postgresql', 'mysql', 'sqlite3' or 'oracle'.</span></span><br><span class="line">      <span class="string">'NAME'</span>: <span class="string">'/root/graphite/storage/db/graphite.db'</span>, <span class="comment"># Or path to database file if using sqlite3.</span></span><br><span class="line">      <span class="string">'USER'</span>: <span class="string">''</span>, <span class="comment"># Not used with sqlite3.</span></span><br><span class="line">      <span class="string">'PASSWORD'</span>: <span class="string">''</span>, <span class="comment"># Not used with sqlite3.</span></span><br><span class="line">      <span class="string">'HOST'</span>: <span class="string">''</span>, <span class="comment"># Set to empty string for localhost. Not used with sqlite3.</span></span><br><span class="line">      <span class="string">'PORT'</span>: <span class="string">''</span>, <span class="comment"># Set to empty string for default. Not used with sqlite3.</span></span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发现 sqlite 中并没有将 events 记录下来</span></span><br><span class="line">(graphite) [root@kylin03-pre db]<span class="comment"># sqlite3 /root/graphite/storage/db/graphite.db </span></span><br><span class="line">SQLite version 3.6.20</span><br><span class="line">Enter <span class="string">".help"</span> <span class="keyword">for</span> instructions</span><br><span class="line">Enter SQL statements terminated with a <span class="string">";"</span></span><br><span class="line">sqlite&gt; .databases</span><br><span class="line">  seq  name             file</span><br><span class="line">  ---  ---------------  ----------------------------------------</span><br><span class="line">  0    main             /root/graphite/storage/db/graphite.db</span><br><span class="line">  sqlite&gt; .tables</span><br><span class="line">    account_mygraph             dashboard_dashboard</span><br><span class="line">    account_profile             dashboard_dashboard_owners</span><br><span class="line">    account_variable            django_admin_log</span><br><span class="line">    account_view                django_content_type</span><br><span class="line">    account_window              django_migrations</span><br><span class="line">    auth_group                  django_session</span><br><span class="line">    auth_group_permissions      events_event</span><br><span class="line">    auth_permission             tagging_tag</span><br><span class="line">    auth_user                   tagging_taggeditem</span><br><span class="line">    auth_user_groups            url_shortener_link</span><br><span class="line">    auth_user_user_permissions</span><br><span class="line">  sqlite&gt; select * from auth_user;</span><br><span class="line">    1|pbkdf2_sha256<span class="variable">$20000</span><span class="variable">$oEgzveEmcg9B</span><span class="variable">$8xbilUymXlwVBAaB48xpUQwsfIucmeP</span>/4C4YF3U6SlI=|1|graphite|||bj@yuzhouwan.com|1|1|2017-01-04 05:59:10.615950|2017-01-05 08:24:54.957631</span><br><span class="line">    2|pbkdf2_sha256<span class="variable">$20000</span><span class="variable">$gG1lK6FNg0h7</span><span class="variable">$dXH47Wqc</span>+Gj/qTyI6EKOajd+Pj1kKN+U5CtnmDo0K/0=|0|default|||default@localhost.localdomain|0|1|2017-01-04 06:53:34.687401|</span><br><span class="line">    3|pbkdf2_sha256<span class="variable">$20000</span><span class="variable">$fcQ5sYbw0cjk</span><span class="variable">$anjZc4J0eRE51HGJ6D50c0c9</span>+d08iY7lhWseke9RmEY=|0|druid||||0|1|2017-01-05 09:03:48.696161|</span><br><span class="line">  sqlite&gt; select * from events_event;      <span class="comment"># no data!</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 尝试使用 MySQL 替换 SQLite</span></span><br><span class="line"><span class="comment"># 192.168.1.102</span></span><br><span class="line">$ mkdir -p /root/software/mysql</span><br><span class="line">  yum install -y --downloadonly --downloaddir=/root/software/mysql mysql</span><br><span class="line">  yum install -y --downloadonly --downloaddir=/root/software/mysql mysql-server</span><br><span class="line">  yum install -y --downloadonly --downloaddir=/root/software/mysql MySQL-python</span><br><span class="line">  <span class="comment"># 192.168.1.101</span></span><br><span class="line">  yum install -y mysql mysql-server MySQL-python</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> /root/software/mysql</span><br><span class="line">$ wget http://dev.mysql.com/get/mysql57-community-release-el5-7.noarch.rpm</span><br><span class="line">$ yum localinstall mysql57-community-release-el5-7.noarch.rpm</span><br><span class="line">$ yum repolist enabled | grep <span class="string">"mysql.*-community.*"</span></span><br><span class="line">$ yum install mysql-community-server</span><br><span class="line">$ vim /usr/bin/yum-config-manager</span><br><span class="line">  <span class="comment">#!/usr/bin/python2.6 -tt</span></span><br><span class="line"></span><br><span class="line">$ yum-config-manager --<span class="built_in">enable</span> mysql57-community</span><br><span class="line">$ service mysqld start</span><br><span class="line"></span><br><span class="line">$ mysql -uroot -p -S /home/mysql/data/mysql.sock</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 后面规范化部署的时候，可以创建 graphite 用户，并赋权</span></span><br><span class="line">  CREATE DATABASE graphite;</span><br><span class="line">  <span class="comment"># GRANT ALL PRIVILEGES ON graphite.* TO 'graphite'@'localhost' IDENTIFIED BY 'sysadmin';</span></span><br><span class="line">  GRANT ALL PRIVILEGES ON graphite.* TO <span class="string">'root'</span>@<span class="string">'localhost'</span> IDENTIFIED BY <span class="string">'sysadmin'</span>;</span><br><span class="line">  FLUSH PRIVILEGES;</span><br><span class="line"></span><br><span class="line">$ vim /root/graphite/lib/python2.7/site-packages/django/conf/project_template/project_name/settings.py</span><br><span class="line"></span><br><span class="line">  DATABASES = {</span><br><span class="line">    <span class="string">'default'</span>: {</span><br><span class="line">      <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.mysql'</span>,</span><br><span class="line">      <span class="comment"># 'NAME': 'jdbc:mysql://192.168.1.101:3306/graphite',</span></span><br><span class="line">      <span class="string">'NAME'</span>: <span class="string">'graphite'</span>,</span><br><span class="line">      <span class="string">'USER'</span>: <span class="string">'root'</span>,</span><br><span class="line">      <span class="comment"># 'HOST': 'localhost',</span></span><br><span class="line">      <span class="string">'PASSWORD'</span>: <span class="string">'root'</span></span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="comment"># TIME_ZONE = 'UTC'</span></span><br><span class="line">  TIME_ZONE = <span class="string">'Asia/Shanghai'</span></span><br><span class="line">  <span class="comment"># DEBUG = False</span></span><br><span class="line">  DEBUG = True</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> /root/graphite/</span><br><span class="line">$ find | grep /settings.py | grep -v pyc</span><br><span class="line">$ vim /root/graphite/lib/python2.7/site-packages/opt/graphite/webapp/graphite/settings.py</span><br><span class="line">$ vim /root/graphite/lib/python2.7/site-packages/tagging/tests/settings.py</span><br><span class="line">$ vim /root/graphite/lib/python2.7/site-packages/tagging/settings.py</span><br><span class="line"><span class="comment"># ./lib/python2.7/site-packages/django/conf/project_template/project_name/settings.py</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 全部修改完成，即可修复</span></span><br><span class="line"></span><br><span class="line">$ python /root/graphite/lib/python2.7/site-packages/opt/graphite/webapp/graphite/manage.py syncdb</span><br><span class="line"><span class="comment"># 如果需要添加其他的 superuser，可以使用如下命令 admin/admin</span></span><br><span class="line"><span class="comment"># echo "from django.contrib.auth.models import User; User.objects.create_superuser('admin', 'admin@hihuron.com', 'sysadmin')" | python /root/graphite/lib/python2.7/site-packages/opt/graphite/webapp/graphite/manage.py shell</span></span><br><span class="line"></span><br><span class="line">$ /root/graphite/bin/carbon-cache.py start</span><br><span class="line">$ PYTHONPATH=/root/graphite/storage/whisper /root/graphite/bin/run-graphite-devel-server.py --port=9097 --libs=/root/graphite/lib/python2.7/site-packages/opt/graphite/webapp /root/graphite 1&gt;/root/graphite/storage/<span class="built_in">log</span>/webapp/process.log 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> /root/graphite/webapp</span><br><span class="line">$ cp -r content/ /root/graphite/lib/python2.7/site-packages/opt/graphite/webapp</span><br><span class="line">$ <span class="built_in">cd</span> /root/graphite/lib/python2.7/site-packages/opt/graphite/webapp</span><br><span class="line">$ cp -r graphite/ /root/graphite/webapp</span><br><span class="line"></span><br><span class="line">$ PYTHONPATH=/root/graphite/storage/whisper /root/graphite/bin/run-graphite-devel-server.py --port=9097 --libs=/root/graphite/webapp /root/graphite 1&gt;/root/graphite/storage/<span class="built_in">log</span>/webapp/process.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></tbody></table></figure>
<h5 id="ImportError-No-module-named-twisted-python-util"><a href="#ImportError-No-module-named-twisted-python-util" class="headerlink" title="ImportError: No module named twisted.python.util"></a>ImportError: No module named twisted.python.util</h5><h6 id="描述-5"><a href="#描述-5" class="headerlink" title="描述"></a>描述</h6><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python carbon-cache.py start</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Traceback (most recent call last):</span><br><span class="line">File <span class="string">"carbon-cache.py"</span>, line <span class="number">28</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line"><span class="keyword">from</span> carbon.util <span class="keyword">import</span> run_twistd_plugin</span><br><span class="line">File <span class="string">"/opt/graphite/lib/carbon/util.py"</span>, line <span class="number">20</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line"><span class="keyword">from</span> twisted.python.util <span class="keyword">import</span> initgroups</span><br><span class="line">ImportError: No module named twisted.python.util</span><br></pre></td></tr></tbody></table></figure>
<h6 id="解决-6"><a href="#解决-6" class="headerlink" title="解决"></a>解决</h6><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pip freeze | grep zope.interface # 没有则需要安装</span></span><br><span class="line"><span class="comment"># pip install zope.interface==3.6.0</span></span><br><span class="line">$ wget https://pypi.python.org/packages/<span class="built_in">source</span>/T/Twisted/Twisted-14.0.0.tar.bz2<span class="comment">#md5=9625c094e0a18da77faa4627b98c9815 --no-check-certificate</span></span><br><span class="line">$ tar -jxf Twisted-14.0.0.tar.bz2</span><br><span class="line">$ <span class="built_in">cd</span> Twisted-14.0.0;</span><br><span class="line">$ python setup.py install</span><br></pre></td></tr></tbody></table></figure>
<h5 id="‘WSGIRequest’-object-has-no-attribute-‘REQUEST’"><a href="#‘WSGIRequest’-object-has-no-attribute-‘REQUEST’" class="headerlink" title="‘WSGIRequest’ object has no attribute ‘REQUEST’"></a>‘WSGIRequest’ object has no attribute ‘REQUEST’</h5><h6 id="描述-6"><a href="#描述-6" class="headerlink" title="描述"></a>描述</h6><p>　访问 <code>http://192.168.1.102:9097/</code> 返回如下信息：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">AttributeError at /render/</span><br><span class="line"><span class="string">'WSGIRequest'</span> object has no attribute <span class="string">'REQUEST'</span></span><br><span class="line">Request Method:  GET</span><br><span class="line">Request URL:  http://192.168.1.102:9097/render/?width=586&amp;height=308&amp;_salt=1483685265.903</span><br><span class="line">Django Version:  1.9.12</span><br><span class="line">Exception Type:  AttributeError</span><br><span class="line">Exception Value:</span><br><span class="line"><span class="string">'WSGIRequest'</span> object has no attribute <span class="string">'REQUEST'</span></span><br><span class="line">Exception Location:  /root/graphite/webapp/graphite/render/views.py <span class="keyword">in</span> parseOptions, line 236</span><br><span class="line">Python Executable:  /root/graphite/bin/python</span><br><span class="line">Python Version:  2.7.12</span><br><span class="line">Python Path:</span><br><span class="line">[<span class="string">'/root/graphite/webapp'</span>,</span><br><span class="line"><span class="string">'/root/graphite/webapp'</span>,</span><br><span class="line"><span class="string">'/root/graphite/webapp'</span>,</span><br><span class="line"><span class="string">'/root/graphite/bin'</span>,</span><br><span class="line"><span class="string">'/root/graphite/webapp'</span>,</span><br><span class="line"><span class="string">'/root/graphite/storage/whisper'</span>,</span><br><span class="line"><span class="string">'/root/graphite/lib/python27.zip'</span>,</span><br><span class="line"><span class="string">'/root/graphite/lib/python2.7'</span>,</span><br><span class="line"><span class="string">'/root/graphite/lib/python2.7/plat-linux2'</span>,</span><br><span class="line"><span class="string">'/root/graphite/lib/python2.7/lib-tk'</span>,</span><br><span class="line"><span class="string">'/root/graphite/lib/python2.7/lib-old'</span>,</span><br><span class="line"><span class="string">'/root/graphite/lib/python2.7/lib-dynload'</span>,</span><br><span class="line"><span class="string">'/usr/local/python27/lib/python2.7'</span>,</span><br><span class="line"><span class="string">'/usr/local/python27/lib/python2.7/plat-linux2'</span>,</span><br><span class="line"><span class="string">'/usr/local/python27/lib/python2.7/lib-tk'</span>,</span><br><span class="line"><span class="string">'/root/graphite/lib/python2.7/site-packages'</span>,</span><br><span class="line"><span class="string">'/root/graphite/lib/python2.7/site-packages/graphite-0.71-py2.7.egg'</span>,</span><br><span class="line"><span class="string">'/root/graphite/lib/python2.7/site-packages/spring-5.8.7-py2.7-linux-x86_64.egg'</span>,</span><br><span class="line"><span class="string">'/root/graphite/lib/python2.7/site-packages/Twisted-12.0.0-py2.7-linux-x86_64.egg'</span>,</span><br><span class="line"><span class="string">'/root/graphite/lib/python2.7/site-packages/requests-2.1.0-py2.7.egg'</span>,</span><br><span class="line"><span class="string">'/root/graphite/lib/python2.7/site-packages/numpy-1.12.0rc2-py2.7-linux-x86_64.egg'</span>,</span><br><span class="line"><span class="string">'/root/graphite/lib/python2.7/site-packages/logger-1.4-py2.7.egg'</span>,</span><br><span class="line"><span class="string">'/root/graphite/lib/python2.7/site-packages/decorator-4.0.10-py2.7.egg'</span>,</span><br><span class="line"><span class="string">'/root/graphite/lib/python2.7/site-packages/sping-1.1.15-py2.5.egg'</span>,</span><br><span class="line"><span class="string">'/usr/local/python27/lib/python2.7/site-packages'</span>,</span><br><span class="line"><span class="string">'/root/graphite/webapp/graphite/thirdparty'</span>]</span><br><span class="line">Server time:  Fri, 6 Jan 2017 14:47:46 +0800</span><br></pre></td></tr></tbody></table></figure>
<h6 id="解决-7"><a href="#解决-7" class="headerlink" title="解决"></a>解决</h6><p>　Django 版本不对应导致的，安装 1.8.17 版本即可</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">django==1.8.17</span><br></pre></td></tr></tbody></table></figure>
<h2 id="踩过的坑-2"><a href="#踩过的坑-2" class="headerlink" title="踩过的坑"></a>踩过的坑</h2><h3 id="true-false-存为维度后变成了-NULL"><a href="#true-false-存为维度后变成了-NULL" class="headerlink" title="true / false 存为维度后变成了 NULL"></a>true / false 存为维度后变成了 NULL</h3><h4 id="解决-8"><a href="#解决-8" class="headerlink" title="解决"></a>解决</h4><p>　Druid 本身是无法将 true / false 之类的 boolean 类型作为维度的，可以考虑将 <code>"true"</code> / <code>"false"</code> 字符串作为维度存入。但是，如果自定义的 Bean 对象中，有 <code>String isTimeout = "false"</code> 的属性存在，就不能直接使用 <code>JSON.toJSONString</code> 进行转换。因为 <code>toJSONString</code> 方法中会识别出 <code>"true"</code> / <code>"false"</code> 字符串，并将其自动转化为 boolean 类型。因此，需要通过 <code>Map&lt;String, Object&gt;</code> 将所有字段都存入，然后再调用 <code>JSON.toJSONString</code> 方法即可</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ bin/plyql --host localhost:8082 -q <span class="string">"select * from log"</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────┬───────┬───────────┬─────┬─────┬──────┬──────────────────────────────────────┐</span><br><span class="line">│ __time                                  │ count │ isTimeout │ max │ min │ sum  │ uuid                                 │</span><br><span class="line">├─────────────────────────────────────────┼───────┼───────────┼─────┼─────┼──────┼──────────────────────────────────────┤</span><br><span class="line">│ Wed Aug 02 2017 17:35:00 GMT+0800 (CST) │ 4     │ NULL      │ 860 │ 860 │ 3440 │ 4621a23d-8270-4bc3-948a-f577b460d72b │</span><br><span class="line">│ Wed Aug 02 2017 17:42:00 GMT+0800 (CST) │ 1     │ NULL      │ 860 │ 860 │ 860  │ 4621a23d-8270-4bc3-948a-f577b460d72b │</span><br><span class="line">│ Wed Aug 02 2017 17:44:00 GMT+0800 (CST) │ 1     │ NULL      │ 860 │ 860 │ 860  │ 4621a23d-8270-4bc3-948a-f577b460d72b │</span><br><span class="line">│ Wed Aug 02 2017 18:03:00 GMT+0800 (CST) │ 3     │ NULL      │ 0   │ 0   │ 0    │ 85f030bd-d737-4863-9af1-e6fd8bd3b15c │</span><br><span class="line">│ Wed Aug 02 2017 19:01:24 GMT+0800 (CST) │ 2     │ NULL      │ 0   │ 0   │ 0    │ 85f030bd-d737-4863-9af1-e6fd8bd3b15c │</span><br><span class="line">│ Wed Aug 02 2017 19:09:49 GMT+0800 (CST) │ 1     │ <span class="literal">false</span>     │ 0   │ 0   │ 0    │ ba11de00-7faf-4eaf-a8ea-1cf3c5033de5 │</span><br><span class="line">└─────────────────────────────────────────┴───────┴───────────┴─────┴─────┴──────┴──────────────────────────────────────┘</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Pool-was-initialized-with-limit-0"><a href="#Pool-was-initialized-with-limit-0" class="headerlink" title="Pool was initialized with limit = 0"></a>Pool was initialized with limit = 0</h3><h4 id="描述-7"><a href="#描述-7" class="headerlink" title="描述"></a>描述</h4><p>　执行 RESTful 查询语句的时候，报错</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"error"</span>: <span class="string">"Unknown exception"</span>,</span><br><span class="line">  <span class="attr">"errorClass"</span>: <span class="string">"java.lang.IllegalStateException"</span>,</span><br><span class="line">  <span class="attr">"errorMessage"</span>: <span class="string">"Pool was initialized with limit = 0, there are no objects to take."</span>,</span><br><span class="line">  <span class="attr">"host"</span>: <span class="string">"druid01:8101"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="解决-9"><a href="#解决-9" class="headerlink" title="解决"></a>解决</h4><p>　检查 Broker、Historical、MiddleManger 是否都已经配置了 <code>druid.processing.numMergeBuffers</code> 参数</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/druid/software/druid/conf/druid</span><br><span class="line">$ cat broker/runtime.properties historical/runtime.properties middleManager/runtime.properties | grep numMergeBuffers</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">druid.processing.numMergeBuffers</span>=<span class="string">4</span></span><br><span class="line"><span class="meta">druid.processing.numMergeBuffers</span>=<span class="string">4</span></span><br><span class="line"><span class="meta">druid.processing.numMergeBuffers</span>=<span class="string">4</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="No-buckets-seems-there-is-no-data-to-index"><a href="#No-buckets-seems-there-is-no-data-to-index" class="headerlink" title="No buckets?? seems there is no data to index"></a>No buckets?? seems there is no data to index</h3><h4 id="解决-10"><a href="#解决-10" class="headerlink" title="解决"></a>解决</h4><p>　除去 HDFS 里面的确没有数据的情况，还有可能是因为 Hadoop 任务的 TimeZone 没有设置正确</p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">"mapreduce.map.java.opts"</span>:<span class="string">"-Duser.timezone=UTC -Dfile.encoding=UTF-8"</span></span><br><span class="line"><span class="meta">"mapreduce.reduce.java.opts"</span>:<span class="string">"-Duser.timezone=UTC -Dfile.encoding=UTF-8"</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="hyperUniqueCardinality-输出浮点数，导致-having-无法使用-equalTo-进行过滤"><a href="#hyperUniqueCardinality-输出浮点数，导致-having-无法使用-equalTo-进行过滤" class="headerlink" title="hyperUniqueCardinality 输出浮点数，导致 having 无法使用 equalTo 进行过滤"></a>hyperUniqueCardinality 输出浮点数，导致 having 无法使用 equalTo 进行过滤</h3><h4 id="描述-8"><a href="#描述-8" class="headerlink" title="描述"></a>描述</h4><p>　通过下述查询，因为使用了 <code>hyperUniqueCardinality</code> 近似查询，导致 <code>alias-6</code> 输出的值为浮点数（如：10.0000213），如此无法在 <code>having</code> 中使用 <code>equalTo</code> 进行精确过滤（=10）</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"jsonClass"</span>: <span class="string">"GroupByQuerySpec"</span>,</span><br><span class="line">  <span class="attr">"queryType"</span>: <span class="string">"groupBy"</span>,</span><br><span class="line">  <span class="attr">"dataSource"</span>: <span class="string">"yuzhouwan"</span>,</span><br><span class="line">  <span class="attr">"dimensions"</span>: [</span><br><span class="line">    {</span><br><span class="line">      <span class="attr">"jsonClass"</span>: <span class="string">"ExtractionDimensionSpec"</span>,</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"extraction"</span>,</span><br><span class="line">      <span class="attr">"dimension"</span>: <span class="string">"__time"</span>,</span><br><span class="line">      <span class="attr">"outputName"</span>: <span class="string">"alias-4"</span>,</span><br><span class="line">      <span class="attr">"extractionFn"</span>: {</span><br><span class="line">        <span class="attr">"jsonClass"</span>: <span class="string">"TimeFormatExtractionFunctionSpec"</span>,</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"timeFormat"</span>,</span><br><span class="line">        <span class="attr">"format"</span>: <span class="string">"yyyy-MM-dd"</span>,</span><br><span class="line">        <span class="attr">"timeZone"</span>: <span class="string">"Asia/Shanghai"</span>,</span><br><span class="line">        <span class="attr">"locale"</span>: <span class="string">"en_US"</span></span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"having"</span>: {</span><br><span class="line">    <span class="attr">"jsonClass"</span>: <span class="string">"ComparisonHavingSpec"</span>,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"greaterThan"</span>,</span><br><span class="line">    <span class="attr">"aggregation"</span>: <span class="string">"alias-6"</span>,</span><br><span class="line">    <span class="attr">"value"</span>: <span class="number">10</span></span><br><span class="line">  },</span><br><span class="line">  <span class="attr">"granularity"</span>: <span class="string">"all"</span>,</span><br><span class="line">  <span class="attr">"aggregations"</span>: [</span><br><span class="line">    {</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"hyperUnique"</span>,</span><br><span class="line">      <span class="attr">"name"</span>: <span class="string">"alias-5"</span>,</span><br><span class="line">      <span class="attr">"fieldName"</span>: <span class="string">"__HLL_booksnumber1"</span></span><br><span class="line">    }</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"postAggregations"</span>: [</span><br><span class="line">    {</span><br><span class="line">      <span class="attr">"jsonClass"</span>: <span class="string">"HyperUniqueCardinalityPostAggregationSpec"</span>,</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"hyperUniqueCardinality"</span>,</span><br><span class="line">      <span class="attr">"fieldName"</span>: <span class="string">"alias-5"</span>,</span><br><span class="line">      <span class="attr">"name"</span>: <span class="string">"alias-6"</span></span><br><span class="line">    }</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"intervals"</span>: [</span><br><span class="line">    <span class="string">"2018-08-08T00:00:00.000+08:00/2018-08-18T00:00:00.000+08:00"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"context"</span>: {</span><br><span class="line">    <span class="attr">"queryId"</span>: <span class="string">"yuzhouwan-127.0.0.1-3395157377882475"</span>,</span><br><span class="line">    <span class="attr">"groupByStrategy"</span>: <span class="string">"v2"</span></span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="解决-11"><a href="#解决-11" class="headerlink" title="解决"></a>解决</h4><p>　通过在 <code>postAggregations</code> 中，增加一个 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://druid.apache.org/docs/latest/querying/post-aggregations.html#javascript-post-aggregator">JavaScript post-aggregator</a> 计算过程，再利用 <code>Math.round</code> 进行<strong>四舍五入</strong>即可</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"jsonClass"</span>: <span class="string">"GroupByQuerySpec"</span>,</span><br><span class="line">  <span class="attr">"queryType"</span>: <span class="string">"groupBy"</span>,</span><br><span class="line">  <span class="attr">"dataSource"</span>: <span class="string">"yuzhouwan"</span>,</span><br><span class="line">  <span class="attr">"dimensions"</span>: [</span><br><span class="line">    {</span><br><span class="line">      <span class="attr">"jsonClass"</span>: <span class="string">"ExtractionDimensionSpec"</span>,</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"extraction"</span>,</span><br><span class="line">      <span class="attr">"dimension"</span>: <span class="string">"__time"</span>,</span><br><span class="line">      <span class="attr">"outputName"</span>: <span class="string">"alias-4"</span>,</span><br><span class="line">      <span class="attr">"extractionFn"</span>: {</span><br><span class="line">        <span class="attr">"jsonClass"</span>: <span class="string">"TimeFormatExtractionFunctionSpec"</span>,</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"timeFormat"</span>,</span><br><span class="line">        <span class="attr">"format"</span>: <span class="string">"yyyy-MM-dd"</span>,</span><br><span class="line">        <span class="attr">"timeZone"</span>: <span class="string">"Asia/Shanghai"</span>,</span><br><span class="line">        <span class="attr">"locale"</span>: <span class="string">"en_US"</span></span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"having"</span>: {</span><br><span class="line">    <span class="attr">"jsonClass"</span>: <span class="string">"ComparisonHavingSpec"</span>,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"equalTo"</span>,</span><br><span class="line">    <span class="attr">"aggregation"</span>: <span class="string">"alias-6"</span>,</span><br><span class="line">    <span class="attr">"value"</span>: <span class="number">10</span></span><br><span class="line">  },</span><br><span class="line">  <span class="attr">"granularity"</span>: <span class="string">"all"</span>,</span><br><span class="line">  <span class="attr">"aggregations"</span>: [</span><br><span class="line">    {</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"hyperUnique"</span>,</span><br><span class="line">      <span class="attr">"name"</span>: <span class="string">"alias-5"</span>,</span><br><span class="line">      <span class="attr">"fieldName"</span>: <span class="string">"__HLL_booksnumber1"</span></span><br><span class="line">    }</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"postAggregations"</span>: [</span><br><span class="line">    {</span><br><span class="line">      <span class="attr">"jsonClass"</span>: <span class="string">"HyperUniqueCardinalityPostAggregationSpec"</span>,</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"hyperUniqueCardinality"</span>,</span><br><span class="line">      <span class="attr">"fieldName"</span>: <span class="string">"alias-5"</span>,</span><br><span class="line">      <span class="attr">"name"</span>: <span class="string">"alias6"</span></span><br><span class="line">    },</span><br><span class="line">    {</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"javascript"</span>,</span><br><span class="line">      <span class="attr">"name"</span>: <span class="string">"alias-6"</span>,</span><br><span class="line">      <span class="attr">"fieldNames"</span>: [</span><br><span class="line">        <span class="string">"alias6"</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"function"</span>: <span class="string">"function(alias6) { return Math.round(alias6); }"</span></span><br><span class="line">    }</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"intervals"</span>: [</span><br><span class="line">    <span class="string">"2018-08-08T00:00:00.000+08:00/2018-08-16T00:00:00.000+08:00"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"context"</span>: {</span><br><span class="line">    <span class="attr">"queryId"</span>: <span class="string">"yuzhouwan-127.0.0.1-3395157377882475"</span>,</span><br><span class="line">    <span class="attr">"groupByStrategy"</span>: <span class="string">"v2"</span></span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="修改-Apache-Druid-的默认时区"><a href="#修改-Apache-Druid-的默认时区" class="headerlink" title="修改 Apache Druid 的默认时区"></a>修改 Apache Druid 的默认时区</h3><h4 id="解决-12"><a href="#解决-12" class="headerlink" title="解决"></a>解决</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /opt/druid/conf/druid/cluster</span><br><span class="line">$ find . -name jvm.config</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./data/middleManager/jvm.config</span><br><span class="line">./data/historical/jvm.config</span><br><span class="line">./query/router/jvm.config</span><br><span class="line">./query/broker/jvm.config</span><br><span class="line">./master/coordinator-overlord/jvm.config</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ grep <span class="string">'user.timezone'</span> `find . -name jvm.config`</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">./data/middleManager/jvm.config</span>:<span class="string">-Duser.timezone=UTC</span></span><br><span class="line"><span class="meta">./data/historical/jvm.config</span>:<span class="string">-Duser.timezone=UTC</span></span><br><span class="line"><span class="meta">./query/router/jvm.config</span>:<span class="string">-Duser.timezone=UTC</span></span><br><span class="line"><span class="meta">./query/broker/jvm.config</span>:<span class="string">-Duser.timezone=UTC</span></span><br><span class="line"><span class="meta">./master/coordinator-overlord/jvm.config</span>:<span class="string">-Duser.timezone=UTC</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sed -<span class="keyword">in</span>-place -e <span class="string">'s/-Duser.timezone=UTC/-Duser.timezone=UTC+8/g'</span> `find . -name jvm.config`</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ grep <span class="string">'user.timezone'</span> `find . -name jvm.config`</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">./data/middleManager/jvm.config</span>:<span class="string">-Duser.timezone=UTC+8</span></span><br><span class="line"><span class="meta">./data/historical/jvm.config</span>:<span class="string">-Duser.timezone=UTC+8</span></span><br><span class="line"><span class="meta">./query/router/jvm.config</span>:<span class="string">-Duser.timezone=UTC+8</span></span><br><span class="line"><span class="meta">./query/broker/jvm.config</span>:<span class="string">-Duser.timezone=UTC+8</span></span><br><span class="line"><span class="meta">./master/coordinator-overlord/jvm.config</span>:<span class="string">-Duser.timezone=UTC+8</span></span><br></pre></td></tr></tbody></table></figure>
<div class="note info">Apache Druid 的默认时区为 UTC，这里我们以东八区为例，将 user.timezone 属性改为 UTC+8 即可</div>





<h2 id="社区发展"><a href="#社区发展" class="headerlink" title="社区发展"></a>社区发展</h2><h3 id="Star-趋势"><a href="#Star-趋势" class="headerlink" title="Star 趋势"></a>Star 趋势</h3><p><img data-src="/picture/tsdb/tsdb_star_history.png" alt="TSDB Star History"></p>
<center>（图片来源：<a href="https://star-history.t9t.io/#apache/druid&amp;apache/pinot&amp;influxdata/influxdb&amp;timescale/timescaledb&amp;OpenTSDB/opentsdb&amp;crate/crate" target="_blank" rel="external nofollow noopener noreferrer">star-history.t9t.io</a>™ 官网）</center>

<h3 id="个人贡献"><a href="#个人贡献" class="headerlink" title="个人贡献"></a>个人贡献</h3><ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/apache/druid/issues?utf8=%E2%9C%93&amp;q=%20is%3Aissue%20author%3Aasdf2014">Issues</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/apache/druid/pulls?utf8=✓&amp;q=%20is%3Apr%20author%3Aasdf2014">Pull Request</a></li>
</ul>
<p>　详见：《<a href="https://yuzhouwan.com/posts/19631/">如何成为 Apache 的 PMC</a>》</p>
<h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><h3 id="Doc"><a href="#Doc" class="headerlink" title="Doc"></a>Doc</h3><ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://imply.io/druid/cheat-sheet">Apache Druid API Cheat Sheet</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://druid.apache.org/docs/latest/querying/sql.html#data-types">Data types</a></li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">SQL type</th>
<th style="text-align:center">Druid runtime type</th>
<th style="text-align:center">Default value</th>
<th style="text-align:center">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">CHAR</td>
<td style="text-align:center">STRING</td>
<td style="text-align:center"><code>''</code></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">VARCHAR</td>
<td style="text-align:center">STRING</td>
<td style="text-align:center"><code>''</code></td>
<td style="text-align:center">Druid STRING columns are reported as VARCHAR. Can include <a target="_blank" rel="external nofollow noopener noreferrer" href="https://druid.apache.org/docs/latest/querying/sql.html#multi-value-strings">multi-value strings</a> as well.</td>
</tr>
<tr>
<td style="text-align:center">DECIMAL</td>
<td style="text-align:center">DOUBLE</td>
<td style="text-align:center"><code>0.0</code></td>
<td style="text-align:center">DECIMAL uses floating point, not fixed point math</td>
</tr>
<tr>
<td style="text-align:center">FLOAT</td>
<td style="text-align:center">FLOAT</td>
<td style="text-align:center"><code>0.0</code></td>
<td style="text-align:center">Druid FLOAT columns are reported as FLOAT</td>
</tr>
<tr>
<td style="text-align:center">REAL</td>
<td style="text-align:center">DOUBLE</td>
<td style="text-align:center"><code>0.0</code></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">DOUBLE</td>
<td style="text-align:center">DOUBLE</td>
<td style="text-align:center"><code>0.0</code></td>
<td style="text-align:center">Druid DOUBLE columns are reported as DOUBLE</td>
</tr>
<tr>
<td style="text-align:center">BOOLEAN</td>
<td style="text-align:center">LONG</td>
<td style="text-align:center"><code>false</code></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">TINYINT</td>
<td style="text-align:center">LONG</td>
<td style="text-align:center"><code>0</code></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">SMALLINT</td>
<td style="text-align:center">LONG</td>
<td style="text-align:center"><code>0</code></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">INTEGER</td>
<td style="text-align:center">LONG</td>
<td style="text-align:center"><code>0</code></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">BIGINT</td>
<td style="text-align:center">LONG</td>
<td style="text-align:center"><code>0</code></td>
<td style="text-align:center">Druid LONG columns (except <code>__time</code>) are reported as BIGINT</td>
</tr>
<tr>
<td style="text-align:center">TIMESTAMP</td>
<td style="text-align:center">LONG</td>
<td style="text-align:center"><code>0</code>, meaning 1970-01-01 00:00:00 UTC</td>
<td style="text-align:center">Druid’s <code>__time</code> column is reported as TIMESTAMP. Casts between string and timestamp types assume standard SQL formatting, e.g. <code>2000-01-02 03:04:05</code>, <em>not</em> ISO8601 formatting. For handling other formats, use one of the <a target="_blank" rel="external nofollow noopener noreferrer" href="https://druid.apache.org/docs/latest/querying/sql.html#time-functions">time functions</a></td>
</tr>
<tr>
<td style="text-align:center">DATE</td>
<td style="text-align:center">LONG</td>
<td style="text-align:center"><code>0</code>, meaning 1970-01-01</td>
<td style="text-align:center">Casting TIMESTAMP to DATE rounds down the timestamp to the nearest day. Casts between string and date types assume standard SQL formatting, e.g. <code>2000-01-02</code>. For handling other formats, use one of the <a target="_blank" rel="external nofollow noopener noreferrer" href="https://druid.apache.org/docs/latest/querying/sql.html#time-functions">time functions</a></td>
</tr>
<tr>
<td style="text-align:center">OTHER</td>
<td style="text-align:center">COMPLEX</td>
<td style="text-align:center">none</td>
<td style="text-align:center">May represent various Druid column types such as hyperUnique, approxHistogram, etc</td>
</tr>
</tbody>
</table>
</div>
<div class="note info">可以通过 druid.indexing.doubleStorage 配置项，来控制浮点型数据存储为 float 还是 double，默认值为 double</div>

<ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://druid.apache.org/docs/latest/tutorials/tutorial-update-data.html#append-to-the-data">Append to the data</a></li>
</ul>
<h3 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h3><ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/apache/druid/issues/6716">引入精确去重</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/apache/druid/issues/6832">全新的 UI 页面</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/apache/druid/issues/7093">查询矢量化</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/apache/druid/issues/8728">支持原生的 Join 查询</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/apache/druid/pull/9898">支持 Aliyun OSS 作为 Deep Storage</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/druid-io/druid-operator">Apache Druid Kubernetes Operator</a></li>
</ul>
<h3 id="Book"><a href="#Book" class="headerlink" title="Book"></a>Book</h3><ul>
<li>Druid 实时大数据分析原理与实践</li>
<li>大数据系统构建：可扩展实时数据系统构建原理</li>
</ul>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt></a></td>
</tr>
<tr>
<td style="text-align:center">Apache Druid</td>
<td style="text-align:center">钉钉群 23318065</td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt></a></td>
</tr>
</tbody>
</table>
</div>

    </div>

    
    
    
      
  <div class="popular-posts-header">相关文章</div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/200906/" rel="bookmark">Presto：分布式 SQL 查询引擎</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/200315/" rel="bookmark">开源时序数据库 InfluxDB</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/19631/" rel="bookmark">如何成为 Apache 的 PMC</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/200926/" rel="bookmark">Helm 实战</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/200919/" rel="bookmark">Kubernetes 实战</a></div>
    </li>
  </ul>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Benedict Jin
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://yuzhouwan.com/posts/5845/" title="Apache Druid：一款高效的 OLAP 引擎">https://yuzhouwan.com/posts/5845/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-ND</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

        

  <div class="followme">
    <p>欢迎关注我的其它发布渠道</p>

    <div class="social-list">

        <div class="social-item">
          <a target="_blank" class="social-link" href="/wechat_channel.jpg">
            <span class="icon">
              <i class="fab fa-weixin"></i>
            </span>

            <span class="label">WeChat</span>
          </a>
        </div>

        <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
        </div>
    </div>
  </div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Apache-Calcite/" rel="tag"># Apache Calcite</a>
              <a href="/tags/Kubernetes/" rel="tag"># Kubernetes</a>
              <a href="/tags/Docker/" rel="tag"># Docker</a>
              <a href="/tags/Maven/" rel="tag"># Maven</a>
              <a href="/tags/Java/" rel="tag"># Java</a>
              <a href="/tags/Helm/" rel="tag"># Helm</a>
              <a href="/tags/Apache-Druid/" rel="tag"># Apache Druid</a>
              <a href="/tags/Apache-ZooKeeper/" rel="tag"># Apache ZooKeeper</a>
              <a href="/tags/InfluxDB/" rel="tag"># InfluxDB</a>
              <a href="/tags/Grafana/" rel="tag"># Grafana</a>
              <a href="/tags/TSDB/" rel="tag"># TSDB</a>
              <a href="/tags/Apache-Superset/" rel="tag"># Apache Superset</a>
              <a href="/tags/Python/" rel="tag"># Python</a>
              <a href="/tags/Presto/" rel="tag"># Presto</a>
              <a href="/tags/PostgreSQL/" rel="tag"># PostgreSQL</a>
              <a href="/tags/Pivot/" rel="tag"># Pivot</a>
              <a href="/tags/Graphite/" rel="tag"># Graphite</a>
              <a href="/tags/OLAP/" rel="tag"># OLAP</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/posts/54206/" rel="prev" title="大数据生态圈里的一致性算法">
      <i class="fa fa-chevron-left"></i> 大数据生态圈里的一致性算法
    </a></div>
      <div class="post-nav-item">
    <a href="/posts/22654/" rel="next" title="搜索引擎 ElasticSearch">
      搜索引擎 ElasticSearch <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
      <div class="tabs tabs-comment">
        <ul class="nav-tabs">
            <li class="tab"><a href="#comment-gitalk">Gitalk：可用 Github 账号登录</a></li>
            <li class="tab"><a href="#comment-disqus">Disqus：海外</a></li>
            <li class="tab"><a href="#comment-valine">Valine：匿名</a></li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane gitalk" id="comment-gitalk">
              <div class="comments" id="gitalk-container"></div>
            </div>
            <div class="tab-pane disqus" id="comment-disqus">
              
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  
            </div>
            <div class="tab-pane valine" id="comment-valine">
              <div class="comments" id="valine-comments"></div>
            </div>
        </div>
      </div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="nav-number">1.</span> <span class="nav-text">基本概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A6%82%E8%BF%B0"><span class="nav-number">1.1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%B9%E6%80%A7"><span class="nav-number">1.2.</span> <span class="nav-text">特性</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E6%9E%90%E4%BA%8B%E4%BB%B6%E6%B5%81"><span class="nav-number">1.2.1.</span> <span class="nav-text">分析事件流</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E6%96%B0%E7%9A%84%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="nav-number">1.2.2.</span> <span class="nav-text">创新的架构设计</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E7%9A%84%E6%95%B0%E6%8D%AE%E6%A0%88"><span class="nav-number">1.2.3.</span> <span class="nav-text">构建事件驱动的数据栈</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E9%94%81%E6%96%B0%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%B5%81"><span class="nav-number">1.2.4.</span> <span class="nav-text">解锁新的工作流</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%9A%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2"><span class="nav-number">1.2.5.</span> <span class="nav-text">多环境部署</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E6%91%84%E5%85%A5"><span class="nav-number">1.2.6.</span> <span class="nav-text">多数据源摄入</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%9A%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6"><span class="nav-number">1.2.7.</span> <span class="nav-text">多版本控制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%98%93%E4%BA%8E%E8%BF%90%E7%BB%B4"><span class="nav-number">1.2.8.</span> <span class="nav-text">易于运维</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E7%BB%84%E4%BB%B6"><span class="nav-number">1.3.</span> <span class="nav-text">基础组件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Router-%E8%BF%9B%E7%A8%8B"><span class="nav-number">1.3.1.</span> <span class="nav-text">Router 进程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Broker-%E8%BF%9B%E7%A8%8B"><span class="nav-number">1.3.2.</span> <span class="nav-text">Broker 进程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Overlord-%E8%BF%9B%E7%A8%8B"><span class="nav-number">1.3.3.</span> <span class="nav-text">Overlord 进程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MiddleManager-%E8%BF%9B%E7%A8%8B"><span class="nav-number">1.3.4.</span> <span class="nav-text">MiddleManager 进程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Coordinator-%E8%BF%9B%E7%A8%8B"><span class="nav-number">1.3.5.</span> <span class="nav-text">Coordinator 进程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Historical-%E8%BF%9B%E7%A8%8B"><span class="nav-number">1.3.6.</span> <span class="nav-text">Historical 进程</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E6%8F%92%E4%BB%B6"><span class="nav-number">1.4.</span> <span class="nav-text">核心插件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Kafka-Indexing-Service"><span class="nav-number">1.4.1.</span> <span class="nav-text">Kafka Indexing Service</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%96%E9%83%A8%E4%BE%9D%E8%B5%96"><span class="nav-number">1.5.</span> <span class="nav-text">外部依赖</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Metadata-Storage"><span class="nav-number">1.5.1.</span> <span class="nav-text">Metadata Storage</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Deep-Storage"><span class="nav-number">1.5.2.</span> <span class="nav-text">Deep Storage</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ZooKeeper"><span class="nav-number">1.5.3.</span> <span class="nav-text">ZooKeeper</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">1.6.</span> <span class="nav-text">数据结构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97"><span class="nav-number">1.6.1.</span> <span class="nav-text">时间序列</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%B4%E5%BA%A6%E5%88%97"><span class="nav-number">1.6.2.</span> <span class="nav-text">维度列</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BA%A6%E9%87%8F%E5%88%97"><span class="nav-number">1.6.3.</span> <span class="nav-text">度量列</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2"><span class="nav-number">2.</span> <span class="nav-text">部署</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%95%E6%9C%BA%E7%89%88"><span class="nav-number">2.1.</span> <span class="nav-text">单机版</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD"><span class="nav-number">2.1.1.</span> <span class="nav-text">下载</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E5%8E%8B"><span class="nav-number">2.1.2.</span> <span class="nav-text">解压</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8"><span class="nav-number">2.1.3.</span> <span class="nav-text">启动</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%AF%E8%A7%86%E5%8C%96"><span class="nav-number">2.1.4.</span> <span class="nav-text">可视化</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Docker-%E5%AE%B9%E5%99%A8%E7%89%88"><span class="nav-number">2.2.</span> <span class="nav-text">Docker 容器版</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD-1"><span class="nav-number">2.2.1.</span> <span class="nav-text">下载</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE-Docker-%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB"><span class="nav-number">2.2.2.</span> <span class="nav-text">配置 Docker 文件共享</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8-1"><span class="nav-number">2.2.3.</span> <span class="nav-text">启动</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A0%A1%E9%AA%8C"><span class="nav-number">2.2.4.</span> <span class="nav-text">校验</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Historical-%E5%AE%B9%E5%99%A8"><span class="nav-number">2.2.4.1.</span> <span class="nav-text">Historical 容器</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#PostgreSQL-%E5%AE%B9%E5%99%A8"><span class="nav-number">2.2.4.2.</span> <span class="nav-text">PostgreSQL 容器</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Kubernetes-%E9%9B%86%E7%BE%A4%E7%89%88"><span class="nav-number">2.3.</span> <span class="nav-text">Kubernetes 集群版</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E8%A3%85"><span class="nav-number">2.3.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A0%A1%E9%AA%8C-1"><span class="nav-number">2.3.2.</span> <span class="nav-text">校验</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ZooKeeper-%E5%85%83%E6%95%B0%E6%8D%AE"><span class="nav-number">2.3.3.</span> <span class="nav-text">ZooKeeper 元数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Broker-%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5"><span class="nav-number">2.3.4.</span> <span class="nav-text">Broker 健康检查</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MiddleManager-%E4%BB%BB%E5%8A%A1"><span class="nav-number">2.3.5.</span> <span class="nav-text">MiddleManager 任务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Historical-%E7%BC%93%E5%AD%98"><span class="nav-number">2.3.6.</span> <span class="nav-text">Historical 缓存</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Segment-%E6%96%87%E4%BB%B6"><span class="nav-number">2.3.7.</span> <span class="nav-text">Segment 文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Coordinator-%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AE"><span class="nav-number">2.3.8.</span> <span class="nav-text">Coordinator 动态配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Druid-SQL-%E6%9F%A5%E8%AF%A2"><span class="nav-number">2.3.9.</span> <span class="nav-text">Druid SQL 查询</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE"><span class="nav-number">3.</span> <span class="nav-text">配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E7%AB%AF%E5%8F%A3"><span class="nav-number">3.1.</span> <span class="nav-text">常用端口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#rollup"><span class="nav-number">3.2.</span> <span class="nav-text">rollup</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#selectStrategy"><span class="nav-number">3.3.</span> <span class="nav-text">selectStrategy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#maxRowsPerSegment"><span class="nav-number">3.4.</span> <span class="nav-text">maxRowsPerSegment</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#druid-server-tier"><span class="nav-number">3.5.</span> <span class="nav-text">druid.server.tier</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tieredReplicants"><span class="nav-number">3.6.</span> <span class="nav-text">tieredReplicants</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Coordinator-Rule-%E9%85%8D%E7%BD%AE"><span class="nav-number">3.7.</span> <span class="nav-text">Coordinator Rule 配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BF%9D%E7%95%99%E6%9C%80%E8%BF%91-30-%E5%A4%A9%E6%95%B0%E6%8D%AE"><span class="nav-number">3.7.1.</span> <span class="nav-text">保留最近 30 天数据</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2"><span class="nav-number">4.</span> <span class="nav-text">查询</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Druid-SQL"><span class="nav-number">4.1.</span> <span class="nav-text">Druid SQL</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%AD%E6%B3%95%E8%A7%84%E5%88%99"><span class="nav-number">4.1.1.</span> <span class="nav-text">语法规则</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E7%A4%BA%E4%BE%8B"><span class="nav-number">4.1.2.</span> <span class="nav-text">查询示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PlyQL"><span class="nav-number">4.2.</span> <span class="nav-text">PlyQL</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95"><span class="nav-number">4.2.1.</span> <span class="nav-text">基本用法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A1%A8%E7%BB%93%E6%9E%84%E6%9F%A5%E8%AF%A2"><span class="nav-number">4.2.2.</span> <span class="nav-text">表结构查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%81%9A%E5%90%88%E6%9F%A5%E8%AF%A2"><span class="nav-number">4.2.3.</span> <span class="nav-text">聚合查询</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E8%81%9A%E5%90%88"><span class="nav-number">4.2.3.1.</span> <span class="nav-text">简单聚合</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%97%B6%E9%97%B4%E7%BB%B4%E5%BA%A6%E8%81%9A%E5%90%88"><span class="nav-number">4.2.3.2.</span> <span class="nav-text">时间维度聚合</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B1%95%E7%A4%BA%E6%9F%A5%E8%AF%A2%E5%AF%B9%E5%BA%94%E7%9A%84-JSON-%E8%AF%AD%E5%8F%A5"><span class="nav-number">4.2.4.</span> <span class="nav-text">展示查询对应的 JSON 语句</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%A1%E7%AE%97%E6%9F%A5%E8%AF%A2%E8%80%97%E6%97%B6%E6%83%85%E5%86%B5"><span class="nav-number">4.2.5.</span> <span class="nav-text">计算查询耗时情况</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RESTful-API"><span class="nav-number">4.3.</span> <span class="nav-text">RESTful API</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E6%89%80%E6%9C%89-DataSource"><span class="nav-number">4.3.1.</span> <span class="nav-text">获取所有 DataSource</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%81%9A%E5%90%88%E6%9F%A5%E8%AF%A2-1"><span class="nav-number">4.3.2.</span> <span class="nav-text">聚合查询</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Apache-Calcite"><span class="nav-number">4.4.</span> <span class="nav-text">Apache Calcite</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Maven-%E4%BE%9D%E8%B5%96"><span class="nav-number">4.4.1.</span> <span class="nav-text">Maven 依赖</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Java-%E5%AE%9E%E7%8E%B0"><span class="nav-number">4.4.2.</span> <span class="nav-text">Java 实现</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Druid-Client"><span class="nav-number">4.5.</span> <span class="nav-text">Druid Client</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Presto"><span class="nav-number">4.6.</span> <span class="nav-text">Presto</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#InfluxDB-Line-Protocol-Parser"><span class="nav-number">4.7.</span> <span class="nav-text">InfluxDB Line Protocol Parser</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9E%B6%E6%9E%84"><span class="nav-number">5.</span> <span class="nav-text">架构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BE%E8%AE%A1%E6%80%BB%E5%9B%BE"><span class="nav-number">5.1.</span> <span class="nav-text">设计总图</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E7%89%88%E6%9C%AC-0-6-0%EF%BC%882012-2013%EF%BC%89"><span class="nav-number">5.1.1.</span> <span class="nav-text">初始版本~0.6.0（2012~2013）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#0-7-0-0-12-0%EF%BC%882013-2018%EF%BC%89"><span class="nav-number">5.1.2.</span> <span class="nav-text">0.7.0~0.12.0（2013~2018）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#0-13-0-%E5%BD%93%E5%89%8D%E7%89%88%E6%9C%AC%EF%BC%882018-now%EF%BC%89"><span class="nav-number">5.1.3.</span> <span class="nav-text">0.13.0~当前版本（2018~now）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Lambda-%E6%B5%81%E5%BC%8F%E6%9E%B6%E6%9E%84"><span class="nav-number">5.2.</span> <span class="nav-text">Lambda 流式架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OLTP-vs-OLAP"><span class="nav-number">5.3.</span> <span class="nav-text">OLTP vs OLAP</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MOLAP-vs-ROLAP"><span class="nav-number">5.4.</span> <span class="nav-text">MOLAP vs ROLAP</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Task-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-number">5.5.</span> <span class="nav-text">Task 生命周期</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%99%E5%85%A5%E9%93%BE%E8%B7%AF"><span class="nav-number">5.6.</span> <span class="nav-text">写入链路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Segment-%E5%8A%A0%E8%BD%BD"><span class="nav-number">5.7.</span> <span class="nav-text">Segment 加载</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E9%93%BE%E8%B7%AF"><span class="nav-number">5.8.</span> <span class="nav-text">查询链路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SQL"><span class="nav-number">5.9.</span> <span class="nav-text">SQL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B4%E4%BD%93%E7%9F%A5%E8%AF%86%E6%A0%91"><span class="nav-number">5.10.</span> <span class="nav-text">整体知识树</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">6.</span> <span class="nav-text">应用场景</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Powered-By"><span class="nav-number">6.1.</span> <span class="nav-text">Powered By</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E8%A6%81%E5%BA%94%E7%94%A8"><span class="nav-number">6.2.</span> <span class="nav-text">主要应用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%82%E5%90%88%E7%9A%84%E5%9C%BA%E6%99%AF"><span class="nav-number">6.3.</span> <span class="nav-text">适合的场景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8D%E5%90%88%E9%80%82%E7%9A%84%E5%9C%BA%E6%99%AF"><span class="nav-number">6.4.</span> <span class="nav-text">不合适的场景</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95"><span class="nav-number">7.</span> <span class="nav-text">性能测试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB"><span class="nav-number">8.</span> <span class="nav-text">源码阅读</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-1"><span class="nav-number">8.1.</span> <span class="nav-text">数据结构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#R-tree"><span class="nav-number">8.1.1.</span> <span class="nav-text">R-tree</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#HyperLogLog"><span class="nav-number">8.1.2.</span> <span class="nav-text">HyperLogLog</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BE%9D%E8%B5%96%E6%A1%86%E6%9E%B6"><span class="nav-number">8.2.</span> <span class="nav-text">依赖框架</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Apache-Calcite-%E6%9F%A5%E8%AF%A2%E5%BC%95%E6%93%8E"><span class="nav-number">8.2.1.</span> <span class="nav-text">Apache Calcite 查询引擎</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Google-Guice-%E6%B3%A8%E5%85%A5"><span class="nav-number">8.2.2.</span> <span class="nav-text">Google Guice 注入</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Google-Guava-%E6%89%A9%E5%B1%95%E5%BA%93"><span class="nav-number">8.2.3.</span> <span class="nav-text">Google Guava 扩展库</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#JMH-%E5%8E%8B%E6%B5%8B"><span class="nav-number">8.2.4.</span> <span class="nav-text">JMH 压测</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Query-%E6%9F%A5%E8%AF%A2%E6%B5%81%E7%A8%8B"><span class="nav-number">8.3.</span> <span class="nav-text">Query 查询流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%AF%E8%A7%86%E5%8C%96-1"><span class="nav-number">9.</span> <span class="nav-text">可视化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Apache-Superset"><span class="nav-number">9.1.</span> <span class="nav-text">Apache Superset</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Grafana"><span class="nav-number">9.2.</span> <span class="nav-text">Grafana</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pivot"><span class="nav-number">9.3.</span> <span class="nav-text">Pivot</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E5%90%AF%E5%8A%A8"><span class="nav-number">9.3.1.</span> <span class="nav-text">配置启动</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%88%E6%9E%9C%E5%9B%BE"><span class="nav-number">9.3.2.</span> <span class="nav-text">效果图</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B8%A9%E8%BF%87%E7%9A%84%E5%9D%91"><span class="nav-number">9.3.3.</span> <span class="nav-text">踩过的坑</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%8C%87%E6%A0%87%E9%A1%B9%E8%BF%87%E5%A4%9A%EF%BC%8C%E7%BB%B4%E6%8A%A4%E9%85%8D%E7%BD%AE%E5%9B%B0%E9%9A%BE"><span class="nav-number">9.3.3.1.</span> <span class="nav-text">指标项过多，维护配置困难</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3"><span class="nav-number">9.3.3.1.1.</span> <span class="nav-text">解决</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Graphite"><span class="nav-number">9.4.</span> <span class="nav-text">Graphite</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E7%8E%AF%E5%A2%83"><span class="nav-number">9.4.1.</span> <span class="nav-text">基础环境</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#OS"><span class="nav-number">9.4.1.1.</span> <span class="nav-text">OS</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Python"><span class="nav-number">9.4.1.2.</span> <span class="nav-text">Python</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Pip"><span class="nav-number">9.4.1.3.</span> <span class="nav-text">Pip</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#VirtualEnv"><span class="nav-number">9.4.1.4.</span> <span class="nav-text">VirtualEnv</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Graphite-%E7%9B%B8%E5%85%B3"><span class="nav-number">9.4.2.</span> <span class="nav-text">Graphite 相关</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-1"><span class="nav-number">9.4.2.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#graphite-%E9%85%8D%E7%BD%AE"><span class="nav-number">9.4.2.2.</span> <span class="nav-text">graphite 配置</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#graphite-web-%E5%BA%94%E7%94%A8"><span class="nav-number">9.4.2.3.</span> <span class="nav-text">graphite web 应用</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#graphite-events"><span class="nav-number">9.4.2.4.</span> <span class="nav-text">graphite events</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#graphite-index"><span class="nav-number">9.4.2.5.</span> <span class="nav-text">graphite-index</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B4%E5%90%88-Druid"><span class="nav-number">9.4.3.</span> <span class="nav-text">整合 Druid</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%BF%81%E7%A7%BB%E5%88%B0%E5%86%85%E7%BD%91%E7%8E%AF%E5%A2%83"><span class="nav-number">9.4.3.1.</span> <span class="nav-text">迁移到内网环境</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9-Druid-%E9%85%8D%E7%BD%AE"><span class="nav-number">9.4.3.2.</span> <span class="nav-text">修改 Druid 配置</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%A0%A1%E9%AA%8C-2"><span class="nav-number">9.4.3.3.</span> <span class="nav-text">校验</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BC%98%E5%8C%96%E9%85%8D%E7%BD%AE"><span class="nav-number">9.4.4.</span> <span class="nav-text">优化配置</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BE%9D%E8%B5%96"><span class="nav-number">9.4.4.1.</span> <span class="nav-text">依赖</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Django"><span class="nav-number">9.4.4.1.1.</span> <span class="nav-text">Django</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Graphite-Web-%E7%9B%B8%E5%85%B3"><span class="nav-number">9.4.4.1.2.</span> <span class="nav-text">Graphite-Web 相关</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%87%87%E9%9B%86"><span class="nav-number">9.4.4.2.</span> <span class="nav-text">采集</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%9B%91%E6%8E%A7"><span class="nav-number">9.4.4.3.</span> <span class="nav-text">监控</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E5%91%BD%E4%BB%A4%E6%B1%87%E6%80%BB"><span class="nav-number">9.4.4.4.</span> <span class="nav-text">启动命令汇总</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B8%A9%E8%BF%87%E7%9A%84%E5%9D%91-1"><span class="nav-number">9.4.5.</span> <span class="nav-text">踩过的坑</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ImportError-No-module-named-carbon-util"><span class="nav-number">9.4.5.1.</span> <span class="nav-text">ImportError: No module named carbon.util</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%8F%8F%E8%BF%B0"><span class="nav-number">9.4.5.1.1.</span> <span class="nav-text">描述</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3-1"><span class="nav-number">9.4.5.1.2.</span> <span class="nav-text">解决</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#django-db-utils-OperationalError-unable-to-open-database-file"><span class="nav-number">9.4.5.2.</span> <span class="nav-text">django.db.utils.OperationalError: unable to open database file</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%8F%8F%E8%BF%B0-1"><span class="nav-number">9.4.5.2.1.</span> <span class="nav-text">描述</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3-2"><span class="nav-number">9.4.5.2.2.</span> <span class="nav-text">解决</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ImportError-No-module-named-graphite-settings"><span class="nav-number">9.4.5.3.</span> <span class="nav-text">ImportError: No module named graphite.settings</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%8F%8F%E8%BF%B0-2"><span class="nav-number">9.4.5.3.1.</span> <span class="nav-text">描述</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3-3"><span class="nav-number">9.4.5.3.2.</span> <span class="nav-text">解决</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#OError-Errno-2-No-such-file-or-directory-%E2%80%98-root-graphite-lib-python2-7-site-packages-opt-graphite-storage-log-webapp-info-log%E2%80%99"><span class="nav-number">9.4.5.4.</span> <span class="nav-text">OError: [Errno 2] No such file or directory: ‘&#x2F;root&#x2F;graphite&#x2F;lib&#x2F;python2.7&#x2F;site-packages&#x2F;opt&#x2F;graphite&#x2F;storage&#x2F;log&#x2F;webapp&#x2F;info.log’</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%8F%8F%E8%BF%B0-3"><span class="nav-number">9.4.5.4.1.</span> <span class="nav-text">描述</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3-4"><span class="nav-number">9.4.5.4.2.</span> <span class="nav-text">解决</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Graphite-Web-%E9%A1%B5%E9%9D%A2%E6%97%A0-event-%E6%95%B0%E6%8D%AE"><span class="nav-number">9.4.5.5.</span> <span class="nav-text">Graphite Web 页面无 event 数据</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%8F%8F%E8%BF%B0-4"><span class="nav-number">9.4.5.5.1.</span> <span class="nav-text">描述</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3-5"><span class="nav-number">9.4.5.5.2.</span> <span class="nav-text">解决</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ImportError-No-module-named-twisted-python-util"><span class="nav-number">9.4.5.6.</span> <span class="nav-text">ImportError: No module named twisted.python.util</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%8F%8F%E8%BF%B0-5"><span class="nav-number">9.4.5.6.1.</span> <span class="nav-text">描述</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3-6"><span class="nav-number">9.4.5.6.2.</span> <span class="nav-text">解决</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E2%80%98WSGIRequest%E2%80%99-object-has-no-attribute-%E2%80%98REQUEST%E2%80%99"><span class="nav-number">9.4.5.7.</span> <span class="nav-text">‘WSGIRequest’ object has no attribute ‘REQUEST’</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%8F%8F%E8%BF%B0-6"><span class="nav-number">9.4.5.7.1.</span> <span class="nav-text">描述</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3-7"><span class="nav-number">9.4.5.7.2.</span> <span class="nav-text">解决</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B8%A9%E8%BF%87%E7%9A%84%E5%9D%91-2"><span class="nav-number">10.</span> <span class="nav-text">踩过的坑</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#true-false-%E5%AD%98%E4%B8%BA%E7%BB%B4%E5%BA%A6%E5%90%8E%E5%8F%98%E6%88%90%E4%BA%86-NULL"><span class="nav-number">10.1.</span> <span class="nav-text">true &#x2F; false 存为维度后变成了 NULL</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3-8"><span class="nav-number">10.1.1.</span> <span class="nav-text">解决</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pool-was-initialized-with-limit-0"><span class="nav-number">10.2.</span> <span class="nav-text">Pool was initialized with limit &#x3D; 0</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%8F%E8%BF%B0-7"><span class="nav-number">10.2.1.</span> <span class="nav-text">描述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3-9"><span class="nav-number">10.2.2.</span> <span class="nav-text">解决</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#No-buckets-seems-there-is-no-data-to-index"><span class="nav-number">10.3.</span> <span class="nav-text">No buckets?? seems there is no data to index</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3-10"><span class="nav-number">10.3.1.</span> <span class="nav-text">解决</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#hyperUniqueCardinality-%E8%BE%93%E5%87%BA%E6%B5%AE%E7%82%B9%E6%95%B0%EF%BC%8C%E5%AF%BC%E8%87%B4-having-%E6%97%A0%E6%B3%95%E4%BD%BF%E7%94%A8-equalTo-%E8%BF%9B%E8%A1%8C%E8%BF%87%E6%BB%A4"><span class="nav-number">10.4.</span> <span class="nav-text">hyperUniqueCardinality 输出浮点数，导致 having 无法使用 equalTo 进行过滤</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%8F%E8%BF%B0-8"><span class="nav-number">10.4.1.</span> <span class="nav-text">描述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3-11"><span class="nav-number">10.4.2.</span> <span class="nav-text">解决</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9-Apache-Druid-%E7%9A%84%E9%BB%98%E8%AE%A4%E6%97%B6%E5%8C%BA"><span class="nav-number">10.5.</span> <span class="nav-text">修改 Apache Druid 的默认时区</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3-12"><span class="nav-number">10.5.1.</span> <span class="nav-text">解决</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A4%BE%E5%8C%BA%E5%8F%91%E5%B1%95"><span class="nav-number">11.</span> <span class="nav-text">社区发展</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Star-%E8%B6%8B%E5%8A%BF"><span class="nav-number">11.1.</span> <span class="nav-text">Star 趋势</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%AA%E4%BA%BA%E8%B4%A1%E7%8C%AE"><span class="nav-number">11.2.</span> <span class="nav-text">个人贡献</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B5%84%E6%96%99"><span class="nav-number">12.</span> <span class="nav-text">资料</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Doc"><span class="nav-number">12.1.</span> <span class="nav-text">Doc</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Github"><span class="nav-number">12.2.</span> <span class="nav-text">Github</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Book"><span class="nav-number">12.3.</span> <span class="nav-text">Book</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%AC%A2%E8%BF%8E%E5%8A%A0%E5%85%A5%E6%88%91%E4%BB%AC%E7%9A%84%E6%8A%80%E6%9C%AF%E7%BE%A4%EF%BC%8C%E4%B8%80%E8%B5%B7%E4%BA%A4%E6%B5%81%E5%AD%A6%E4%B9%A0"><span class="nav-number">13.</span> <span class="nav-text">欢迎加入我们的技术群，一起交流学习</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Benedict Jin" src="/yuzhouwan_logo_128x128.ico">
  <p class="site-author-name" itemprop="name">Benedict Jin</p>
  <div class="site-description" itemprop="description">Benedict Jin's Blog</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">55</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">155</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/asdf2014" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;asdf2014" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:asdf2014@apache.org" title="E-Mail → mailto:asdf2014@apache.org" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh" class="cc-opacity" rel="external nofollow noopener noreferrer" target="_blank"><img src="/images/cc-by-nc-nd.svg" alt="Creative Commons"></a>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        
  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="external nofollow noopener noreferrer" target="_blank">苏 ICP 备 17032505号 </a>
  </div>

<div class="copyright">
  
  &copy; 2014 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yuzhouwan.com</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">1.3m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">20:13</span>
</div>

        
<meta name="referrer" content="always">
<div class="busuanzi-count">
  <script async src="/lib/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




<script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.5/lib/darkmode-js.min.js"></script>
<script>
var options = {
  bottom: '32px', // default: '32px'
  right: '32px', // default: '32px'
  left: 'unset', // default: 'unset'
  time: '0.5s', // default: '0.3s'
  mixColor: '#fff', // default: '#fff'
  backgroundColor: '#fff',  // default: '#fff'
  buttonColorDark: '#100f2c',  // default: '#100f2c'
  buttonColorLight: '#fff', // default: '#fff'
  saveInCookies: true, // default: true,
  label: '🌓', // default: ''
  autoMatchOsTheme: false // default: true
}
const darkmode = new Darkmode(options);
darkmode.showWidget();
</script>
<style>
button.darkmode-toggle {
  z-index: 9999;
}
img, .darkmode-ignore {
  isolation: isolate;
  display: block;
}
</style>

  




  
<script src="/js/local-search.js"></script>











<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
          load: ['[tex]/mhchem'],
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
          packages: {'[+]': ['mhchem']},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

<script>
  var disqus_config = function() {
    this.page.url = "https://yuzhouwan.com/posts/5845/";
    this.page.identifier = "posts/5845/";
    this.page.title = "Apache Druid：一款高效的 OLAP 引擎";
    };
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://yuzhouwan.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : 'e5da61069b94deb8ef3a',
      clientSecret: 'c60ad4e430be258b705027a036eeee3d71cb934b',
      repo        : 'gitment',
      owner       : 'asdf2014',
      admin       : ['asdf2014'],
      id          : 'd03d5f417395b613a745587b06c8c750',
        language: '',
      distractionFreeMode: false
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : true,
      appId      : 'BU4bnWsdAliFfk3fz7iMcFUU-gzGzoHsz',
      appKey     : '1xVLNFSy1qGCda3wt4GiGzHG',
      placeholder: "上述信息都不是必填的，可以直接提交评论",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</body>
</html>
