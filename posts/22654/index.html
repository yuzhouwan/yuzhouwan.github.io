<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/yuzhouwan_logo_with_copyright.jpg">
  <link rel="icon" type="image/png" sizes="32x32" href="/yuzhouwan_logo_32x32.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/yuzhouwan_logo_16x16.ico">
  <link rel="mask-icon" href="/yuzhouwan_logo_with_copyright.jpg" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yuzhouwan.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":5,"onmobile":true},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":true,"nav":{"valine":{"text":"Valine：匿名","order":-1},"disqus":{"text":"Disqus：海外","order":-2},"gitalk":{"text":"Gitalk：可用 Github 账号登录","order":-3}}},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="ElasticSearch 是什么？　ElasticSearch™ 是一款基于 Lucene 的搜索引擎，不但稳定、可靠、快速，同时具备良好的水平扩展能力 特性 功能丰富，且开箱即用 横向可扩展性 分片机制更好地解决热点问题 多副本有效保证了高可用 精确的熔断器机制 社区庞大，生态完善  主要概念Cluster 集群　在一个分布式系统里面，可以通过多个 ElasticSearch 节点组成一个集群">
<meta property="og:type" content="article">
<meta property="og:title" content="搜索引擎 ElasticSearch">
<meta property="og:url" content="https://yuzhouwan.com/posts/22654/">
<meta property="og:site_name" content="宇宙湾">
<meta property="og:description" content="ElasticSearch 是什么？　ElasticSearch™ 是一款基于 Lucene 的搜索引擎，不但稳定、可靠、快速，同时具备良好的水平扩展能力 特性 功能丰富，且开箱即用 横向可扩展性 分片机制更好地解决热点问题 多副本有效保证了高可用 精确的熔断器机制 社区庞大，生态完善  主要概念Cluster 集群　在一个分布式系统里面，可以通过多个 ElasticSearch 节点组成一个集群">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://yuzhouwan.com/picture/es/es_architecture.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/es/elasticsearch_on_kubernetes_dashboard.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/es/es_rollup_1.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/es/es_rollup_2.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/es/es_rollup_3.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/es/es_rollup_4.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/es/es_rollup_5.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/es/es_rollup_6.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/es/es_rollup_7.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/es/es_rollup_8.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/es/es_rollup_9.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/es/es_reverted_index.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/lucene/lucene_term_directory_inverted_index.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/es/es_grossip.gif">
<meta property="og:image" content="https://yuzhouwan.com/picture/es/es_unicast.svg">
<meta property="og:image" content="https://yuzhouwan.com/picture/es/es_multicast.svg">
<meta property="og:image" content="https://yuzhouwan.com/picture/es/es_broadcast.svg">
<meta property="og:image" content="https://yuzhouwan.com/picture/es/es_write_1.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/es/es_write_2.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/es/es_write_3.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/es/es_read.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/es/es_segment_merge_before.png">
<meta property="og:image" content="https://yuzhouwan.com/picture/es/es_segment_merge_after.png">
<meta property="og:image" content="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg">
<meta property="og:image" content="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg">
<meta property="og:image" content="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg">
<meta property="og:image" content="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg">
<meta property="article:published_time" content="2017-04-02T04:18:42.000Z">
<meta property="article:modified_time" content="2020-11-17T14:24:10.126Z">
<meta property="article:author" content="Benedict Jin">
<meta property="article:tag" content="Kubernetes">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="Helm">
<meta property="article:tag" content="ElasticSearch">
<meta property="article:tag" content="Lucene">
<meta property="article:tag" content="Kafka">
<meta property="article:tag" content="Flume">
<meta property="article:tag" content="HBase">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://yuzhouwan.com/picture/es/es_architecture.png">

<link rel="canonical" href="https://yuzhouwan.com/posts/22654/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>搜索引擎 ElasticSearch | 宇宙湾</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-97020848-1"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-97020848-1');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>


<style>.null { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .null > span { position: relative; z-index: 10; }  .null img, .null .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .null img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .null-fallback { color: inherit; } .null-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="宇宙湾" type="application/atom+xml"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">宇宙湾</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">厚积薄发</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">146</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">15</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">53</span></a>

  </li>
        <li class="menu-item menu-item-书单">

    <a href="/books/" rel="section"><i class="fa fa-book fa-fw"></i>书单</a>

  </li>
        <li class="menu-item menu-item-影视">

    <a href="/movies/" rel="section"><i class="fa fa-film fa-fw"></i>影视</a>

  </li>
        <li class="menu-item menu-item-友链">

    <a href="/links/" rel="section"><i class="fa fa-link fa-fw"></i>友链</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yuzhouwan.com/posts/22654/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/yuzhouwan_logo_128x128.ico">
      <meta itemprop="name" content="Benedict Jin">
      <meta itemprop="description" content="Benedict Jin's Blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宇宙湾">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          搜索引擎 ElasticSearch
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-04-02 12:18:42" itemprop="dateCreated datePublished" datetime="2017-04-02T12:18:42+08:00">2017-04-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-11-17 22:24:10" itemprop="dateModified" datetime="2020-11-17T22:24:10+08:00">2020-11-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/" itemprop="url" rel="index"><span itemprop="name">大数据</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>31k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>29 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="ElasticSearch-是什么？"><a href="#ElasticSearch-是什么？" class="headerlink" title="ElasticSearch 是什么？"></a>ElasticSearch 是什么？</h2><p>　<a href="https://yuzhouwan.com/posts/22654/"><strong>ElasticSearch</strong></a>™ 是一款基于 Lucene 的搜索引擎，不但稳定、可靠、快速，同时具备良好的水平扩展能力</p>
<h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2><ul>
<li>功能丰富，且开箱即用</li>
<li>横向可扩展性</li>
<li>分片机制更好地解决热点问题</li>
<li>多副本有效保证了高可用</li>
<li>精确的熔断器机制</li>
<li>社区庞大，生态完善</li>
</ul>
<h2 id="主要概念"><a href="#主要概念" class="headerlink" title="主要概念"></a>主要概念</h2><h3 id="Cluster-集群"><a href="#Cluster-集群" class="headerlink" title="Cluster 集群"></a>Cluster 集群</h3><p>　在一个分布式系统里面，可以通过多个 ElasticSearch 节点组成一个<strong>集群</strong>。集群中会动态选举出一个主节点，保证了 ElasticSearch 集群不存在单点故障<br>　在同一子网内，只需要将进程设置为相同的集群名，ElasticSearch 就会把这些集群名相同的进程自动组成一个集群。集群中各节点间的通讯和数据负载均衡，全部都由 ElasticSearch 自动管理</p>
<h3 id="Node-节点"><a href="#Node-节点" class="headerlink" title="Node 节点"></a>Node 节点</h3><p>　每一个 ElasticSearch 进程称为一个 <strong>Node 节点</strong>。在测试环境中，可以在一台服务器上运行多个 ElasticSearch 进程；但生产环境中，则建议每台服务器只运行一个 ElasticSearch 进程</p>
<h3 id="Index-索引"><a href="#Index-索引" class="headerlink" title="Index 索引"></a>Index 索引</h3><p>　ElasticSearch 中的索引是文档数据存储的地方，相当于是传统关系数据库中的 DataBase 概念。更多逻辑上的对应关系，如下表所示：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">Relational DB</th>
<th style="text-align:center">HBase</th>
<th style="text-align:center">ElasticSearch</th>
<th style="text-align:center">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Database</td>
<td style="text-align:center">NameSpace</td>
<td style="text-align:center">Template</td>
<td style="text-align:center">一组索引的模板配置</td>
</tr>
<tr>
<td style="text-align:center">Table</td>
<td style="text-align:center">Table</td>
<td style="text-align:center">Index</td>
<td style="text-align:center">索引</td>
</tr>
<tr>
<td style="text-align:center">Row</td>
<td style="text-align:center">RowKey</td>
<td style="text-align:center">Document</td>
<td style="text-align:center">文档，和 Lucene 概念一致</td>
</tr>
<tr>
<td style="text-align:center">Column + Value</td>
<td style="text-align:center">Cell</td>
<td style="text-align:center">Field</td>
<td style="text-align:center">如果将文档理解为 JSON，那么 Field 就是字段和值</td>
</tr>
<tr>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
<td style="text-align:center">Term</td>
<td style="text-align:center">检索的基本单位，相当于是文本中的一个词</td>
</tr>
<tr>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
<td style="text-align:center">Token</td>
<td style="text-align:center">Term 内容、类型，以及 Term 在文本中的起始及偏移</td>
</tr>
</tbody>
</table>
</div>
<div class="note info">目前最新的 ElasticSearch 7.x 版本里面已经废弃了 Type 的概念</div>

<a id="more"></a>
<h3 id="Shard-分片"><a href="#Shard-分片" class="headerlink" title="Shard 分片"></a>Shard 分片</h3><p>　ElasticSearch 会把一个索引拆分为多个更细粒度的索引，并称之为 Shard<br>　完成分片之后，就可以把各个 Shard 分配到不同的节点中去。同时，ElasticSearch 会确保两个相同的 Shard 不会同时存在于一个 Node 上</p>
<h3 id="Replica-副本"><a href="#Replica-副本" class="headerlink" title="Replica 副本"></a>Replica 副本</h3><p>　ElasticSearch 的每一个 Shard 分片都可以有多个<strong>副本</strong>，而每一个副本也都是分片的完整拷贝。如此设计的好处是，既可以提升查询速度，也能提高系统的容错性<br>　一旦 ElasticSearch 的某个节点数据损坏或者服务不可用的时候，那么就可以用其他节点来代替故障的节点，以达到高可用的目标</p>
<h3 id="Recovery-故障恢复"><a href="#Recovery-故障恢复" class="headerlink" title="Recovery 故障恢复"></a>Recovery 故障恢复</h3><p>　ElasticSearch 的 Recovery 代表的是<strong>数据恢复</strong>或者称之为<strong>数据重新分布</strong><br>　当 ElasticSearch 集群中，有节点加入或退出时，它会根据机器负载对索引分片进行重新分配</p>
<div class="note info">另外，当挂掉的节点再次重新启动的时候也会进行数据恢复</div>


<h3 id="River-数据源"><a href="#River-数据源" class="headerlink" title="River 数据源"></a>River 数据源</h3><p>　River 代表的是一个<strong>数据源</strong>，这也是同步数据到 ElasticSearch 的一个方法<br>　主要流程是读取 River 中的数据，再将其索引到 ElasticSearch 中，并以插件方式对外提供服务。官方支持的 River 类型有 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/elastic/elasticsearch-river-couchdb">CouchDB</a>、<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/elastic/elasticsearch-river-rabbitmq">RabbitMQ</a>、<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/elastic/elasticsearch-river-twitter">Twitter</a>、<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/elastic/elasticsearch-river-wikipedia">Wikipedia</a> 等</p>
<h3 id="Gateway-时空门"><a href="#Gateway-时空门" class="headerlink" title="Gateway 时空门"></a>Gateway 时空门</h3><p>　Gateway 是 ElasticSearch 索引的<strong>持久化存储</strong>方式，ElasticSearch 默认会先把索引存放到内存中去，当内存满了的时候再持久化到硬盘里。之后，当 ElasticSearch 集群重启时，就会从 Gateway 中读取索引数据<br>　Gateway 支持多种存储媒介，包括本地文件系统（默认）、分布式文件系统、<a href="https://yuzhouwan.com/posts/60504/">HDFS</a> 和 S3 云存储服务 等</p>
<h3 id="discovery-zen-节点发现"><a href="#discovery-zen-节点发现" class="headerlink" title="discovery.zen 节点发现"></a>discovery.zen 节点发现</h3><p>　discovery.zen 是 ElasticSearch 的<strong>自动节点发现机制</strong>，支持基于配置（静态配置中设置的主机列表）与基于文件（定时加载外部文件中的主机列表）两种模式<br>　集群会以广播的方式去寻找存在的 Node 节点，然后再通过多播协议来进行节点之间的通信，同时也支持点对点（P2P，Point 2 Point）的交互操作</p>
<h3 id="Transport-通讯机制"><a href="#Transport-通讯机制" class="headerlink" title="Transport 通讯机制"></a>Transport 通讯机制</h3><p>　Transport 是 ElasticSearch 内部的节点或者集群与客户端之间的交互方式，默认会使用 TCP 协议完成通讯</p>
<h2 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a>架构图</h2><p><img data-src="/picture/es/es_architecture.png" alt="ElasticSearch Architecture"></p>
<center>（利用 <a href="https://www.axure.com.cn/" target="_blank" rel="external nofollow noopener noreferrer">Axure</a>™ 绘制而成）</center>





<h2 id="环境部署"><a href="#环境部署" class="headerlink" title="环境部署"></a>环境部署</h2><h3 id="单机版"><a href="#单机版" class="headerlink" title="单机版"></a>单机版</h3><h4 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h4><p>　首先从官方的<a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/cn/downloads/elasticsearch">下载页面</a>上，找到适合自己操作系统的安装包（这里我们以 MacOS 为例）</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.9.1-darwin-x86_64.tar.gz</span><br></pre></td></tr></tbody></table></figure>
<h4 id="解压"><a href="#解压" class="headerlink" title="解压"></a>解压</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ tar zxvf elasticsearch-7.9.1-darwin-x86_64.tar.gz</span><br><span class="line">$ ln -s elasticsearch-7.9.1 es</span><br><span class="line">$ <span class="built_in">cd</span> es</span><br></pre></td></tr></tbody></table></figure>
<h4 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ vim ~/.bashrc</span><br><span class="line">  <span class="built_in">export</span> ES_HOME=/apps/es</span><br><span class="line">  <span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$ES_HOME</span>/bin</span><br><span class="line">$ <span class="built_in">source</span> ~/.bashrc</span><br><span class="line">$ elasticsearch -version</span><br></pre></td></tr></tbody></table></figure>
<h4 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ elasticsearch</span><br><span class="line"></span><br><span class="line"><span class="comment"># 增加 -d 可以使得 ElasticSearch 进程在后台运行</span></span><br><span class="line">$ elasticsearch -d</span><br></pre></td></tr></tbody></table></figure>
<h4 id="校验"><a href="#校验" class="headerlink" title="校验"></a>校验</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -XGET <span class="string">'http://localhost:9200/_cluster/health'</span> | python -m json.tool</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"cluster_name"</span>: <span class="string">"elasticsearch"</span>,</span><br><span class="line">  <span class="attr">"status"</span>: <span class="string">"green"</span>,</span><br><span class="line">  <span class="attr">"timed_out"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"number_of_nodes"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"number_of_data_nodes"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"active_primary_shards"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"active_shards"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"relocating_shards"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"initializing_shards"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"unassigned_shards"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"delayed_unassigned_shards"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"number_of_pending_tasks"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"number_of_in_flight_fetch"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"task_max_waiting_in_queue_millis"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"active_shards_percent_as_number"</span>: <span class="number">100.0</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="可视化"><a href="#可视化" class="headerlink" title="可视化"></a>可视化</h4><h5 id="本地-Kibana"><a href="#本地-Kibana" class="headerlink" title="本地 Kibana"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/cn/downloads/kibana">本地 Kibana</a></h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载</span></span><br><span class="line">$ wget https://artifacts.elastic.co/downloads/kibana/kibana-7.9.1-darwin-x86_64.tar.gz</span><br><span class="line">$ tar zxvf kibana-7.9.1-darwin-x86_64.tar.gz</span><br><span class="line">$ ln -s kibana-7.9.1-darwin-x86_64 kibana</span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">$ <span class="built_in">cd</span> kibana</span><br><span class="line">$ bin/kibana</span><br><span class="line"><span class="comment"># 使用</span></span><br><span class="line">$ open <span class="string">'http://localhost:5601'</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="Kubernetes-版"><a href="#Kubernetes-版" class="headerlink" title="Kubernetes 版"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://hub.helm.sh/charts/bitnami/elasticsearch">Kubernetes 版</a></h3><h4 id="安装-Helm-Charts"><a href="#安装-Helm-Charts" class="headerlink" title="安装 Helm Charts"></a>安装 Helm Charts</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ helm repo add bitnami https://charts.bitnami.com/bitnami</span><br><span class="line">$ helm install my-release bitnami/elasticsearch</span><br></pre></td></tr></tbody></table></figure>
<h4 id="校验-1"><a href="#校验-1" class="headerlink" title="校验"></a>校验</h4><p><img data-src="/picture/es/elasticsearch_on_kubernetes_dashboard.png" alt="ElasticSearch on Kubernetes Dashboard"></p>
<center>（图片来源：对 <a href="https://github.com/kubernetes/dashboard" target="_blank" rel="external nofollow noopener noreferrer">Kubernetes Dashboard</a>™ 的截图）</center>



<h4 id="端口转发"><a href="#端口转发" class="headerlink" title="端口转发"></a>端口转发</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl port-forward --namespace default svc/my-release-elasticsearch-coordinating-only 9200:9200 &amp;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl http://127.0.0.1:9200/</span><br></pre></td></tr></tbody></table></figure>
<h4 id="可视化-1"><a href="#可视化-1" class="headerlink" title="可视化"></a>可视化</h4><h5 id="Kibana-on-Kubernetes"><a href="#Kibana-on-Kubernetes" class="headerlink" title="Kibana on Kubernetes"></a>Kibana on Kubernetes</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ helm repo add elastic https://helm.elastic.co</span><br><span class="line">$ helm install kibana elastic/kibana</span><br></pre></td></tr></tbody></table></figure>
<h2 id="实用技巧"><a href="#实用技巧" class="headerlink" title="实用技巧"></a>实用技巧</h2><div class="note success">以下介绍的内容均为 ElasticSearch 7.9.1 版本的用法</div>

<h3 id="写入数据"><a href="#写入数据" class="headerlink" title="写入数据"></a>写入数据</h3><h4 id="创建-Document"><a href="#创建-Document" class="headerlink" title="创建 Document"></a>创建 Document</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST yuzhouwan/_doc/</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"user"</span>: <span class="string">"BenedictJin"</span>,</span><br><span class="line">  <span class="attr">"end_time"</span>: <span class="string">"2038-01-19T03:14:07"</span>,</span><br><span class="line">  <span class="attr">"github"</span>: <span class="string">"asdf2014"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"_index"</span>: <span class="string">"yuzhouwan"</span>,</span><br><span class="line">  <span class="attr">"_type"</span>: <span class="string">"_doc"</span>,</span><br><span class="line">  <span class="attr">"_id"</span>: <span class="string">"Uqs7tm4B6KBuNSr8fQM0"</span>,</span><br><span class="line">  <span class="attr">"_version"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"result"</span>: <span class="string">"created"</span>,</span><br><span class="line">  <span class="attr">"_shards"</span>: {</span><br><span class="line">    <span class="attr">"total"</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">"successful"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"failed"</span>: <span class="number">0</span></span><br><span class="line">  },</span><br><span class="line">  <span class="attr">"_seq_no"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"_primary_term"</span>: <span class="number">1</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="指定-Document-ID"><a href="#指定-Document-ID" class="headerlink" title="指定 Document ID"></a>指定 Document ID</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST yuzhouwan/_doc/1</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"user"</span>: <span class="string">"BenedictJin"</span>,</span><br><span class="line">  <span class="attr">"end_time"</span>: <span class="string">"2038-01-19T03:14:07"</span>,</span><br><span class="line">  <span class="attr">"github"</span>: <span class="string">"asdf2014"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"_index"</span>: <span class="string">"yuzhouwan"</span>,</span><br><span class="line">  <span class="attr">"_type"</span>: <span class="string">"_doc"</span>,</span><br><span class="line">  <span class="attr">"_id"</span>: <span class="string">"1"</span>,</span><br><span class="line">  <span class="attr">"_version"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"result"</span>: <span class="string">"created"</span>,</span><br><span class="line">  <span class="attr">"_shards"</span>: {</span><br><span class="line">    <span class="attr">"total"</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">"successful"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"failed"</span>: <span class="number">0</span></span><br><span class="line">  },</span><br><span class="line">  <span class="attr">"_seq_no"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"_primary_term"</span>: <span class="number">1</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>　再次写入相同 Doc ID 的记录后，会更新 <code>_version</code></p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"_index"</span>: <span class="string">"yuzhouwan"</span>,</span><br><span class="line">  <span class="attr">"_type"</span>: <span class="string">"_doc"</span>,</span><br><span class="line">  <span class="attr">"_id"</span>: <span class="string">"1"</span>,</span><br><span class="line">  <span class="attr">"_version"</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="attr">"result"</span>: <span class="string">"updated"</span>,</span><br><span class="line">  <span class="attr">"_shards"</span>: {</span><br><span class="line">    <span class="attr">"total"</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">"successful"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"failed"</span>: <span class="number">0</span></span><br><span class="line">  },</span><br><span class="line">  <span class="attr">"_seq_no"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"_primary_term"</span>: <span class="number">1</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="查询数据"><a href="#查询数据" class="headerlink" title="查询数据"></a>查询数据</h3><h4 id="匹配所有索引"><a href="#匹配所有索引" class="headerlink" title="匹配所有索引"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-match-all-query.html">匹配所有索引</a></h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET _search</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"query"</span>: {</span><br><span class="line">    <span class="attr">"match_all"</span>: {}</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="指定索引"><a href="#指定索引" class="headerlink" title="指定索引"></a>指定索引</h4><h5 id="指定某一个索引"><a href="#指定某一个索引" class="headerlink" title="指定某一个索引"></a>指定某一个索引</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /yuzhouwan/_search</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"took"</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="attr">"timed_out"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"_shards"</span>: {</span><br><span class="line">    <span class="attr">"total"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"successful"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"skipped"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"failed"</span>: <span class="number">0</span></span><br><span class="line">  },</span><br><span class="line">  <span class="attr">"hits"</span>: {</span><br><span class="line">    <span class="attr">"total"</span>: {</span><br><span class="line">      <span class="attr">"value"</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">"relation"</span>: <span class="string">"eq"</span></span><br><span class="line">    },</span><br><span class="line">    <span class="attr">"max_score"</span>: <span class="number">1.0</span>,</span><br><span class="line">    <span class="attr">"hits"</span>: [</span><br><span class="line">      {</span><br><span class="line">        <span class="attr">"_index"</span>: <span class="string">"yuzhouwan"</span>,</span><br><span class="line">        <span class="attr">"_type"</span>: <span class="string">"_doc"</span>,</span><br><span class="line">        <span class="attr">"_id"</span>: <span class="string">"Uqs7tm4B6KBuNSr8fQM0"</span>,</span><br><span class="line">        <span class="attr">"_score"</span>: <span class="number">1.0</span>,</span><br><span class="line">        <span class="attr">"_source"</span>: {</span><br><span class="line">          <span class="attr">"user"</span>: <span class="string">"BenedictJin"</span>,</span><br><span class="line">          <span class="attr">"end_time"</span>: <span class="string">"2038-01-19T03:14:07"</span>,</span><br><span class="line">          <span class="attr">"github"</span>: <span class="string">"asdf2014"</span></span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    ]</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h5 id="指定多个索引"><a href="#指定多个索引" class="headerlink" title="指定多个索引"></a>指定多个索引</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /yuzhouwan01,yuzhouwan02/_search</span><br></pre></td></tr></tbody></table></figure>
<h5 id="通配符匹配多个索引"><a href="#通配符匹配多个索引" class="headerlink" title="通配符匹配多个索引"></a>通配符匹配多个索引</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /yuzhouwan*/_search</span><br></pre></td></tr></tbody></table></figure>
<h4 id="控制展示数量"><a href="#控制展示数量" class="headerlink" title="控制展示数量"></a>控制展示数量</h4><p>　由于默认只会展示 10 个匹配结果，所以需要设置 <code>size</code> 参数来调整</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /yuzhouwan/_search?size=100</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"query"</span>: {</span><br><span class="line">    <span class="attr">"match"</span>: {</span><br><span class="line">      <span class="attr">"pattern"</span>: <span class="string">"FLUSH"</span></span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /yuzhouwan/_search</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"from"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">100</span>,</span><br><span class="line">  <span class="attr">"query"</span>: {</span><br><span class="line">    <span class="attr">"match"</span>: {</span><br><span class="line">      <span class="attr">"pattern"</span>: <span class="string">"FLUSH"</span></span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="指定返回字段"><a href="#指定返回字段" class="headerlink" title="指定返回字段"></a>指定返回字段</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /yuzhouwan/_search</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"_source"</span>: [</span><br><span class="line">    <span class="string">"message"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"from"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">100</span>,</span><br><span class="line">  <span class="attr">"query"</span>: {</span><br><span class="line">    <span class="attr">"match_all"</span>: {}</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="范围查询"><a href="#范围查询" class="headerlink" title="范围查询"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-range-query.html">范围查询</a></h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /yuzhouwan/_search</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"query"</span>: {</span><br><span class="line">    <span class="attr">"range"</span>: {</span><br><span class="line">      <span class="attr">"CREATETIME"</span>: {</span><br><span class="line">        <span class="attr">"gte"</span>: <span class="string">"1496246400000"</span>,</span><br><span class="line">        <span class="attr">"lt"</span>: <span class="string">"1498838400000"</span></span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="聚合查询"><a href="#聚合查询" class="headerlink" title="聚合查询"></a>聚合查询</h4><h5 id="Group-Count"><a href="#Group-Count" class="headerlink" title="Group Count"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-terms-aggregation.html">Group Count</a></h5><p>　对 <code>end_time</code> 字段进行 group 分组，再进行 count 计数，并过滤</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /yuzhouwan/_search</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"aggs"</span>: {</span><br><span class="line">    <span class="attr">"group_by_link"</span>: {</span><br><span class="line">      <span class="attr">"terms"</span>: {</span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"end_time"</span>,</span><br><span class="line">        <span class="attr">"size"</span>: <span class="number">100</span></span><br><span class="line">      },</span><br><span class="line">      <span class="attr">"aggs"</span>: {</span><br><span class="line">        <span class="attr">"sales_bucket_filter"</span>: {</span><br><span class="line">          <span class="attr">"bucket_selector"</span>: {</span><br><span class="line">            <span class="attr">"buckets_path"</span>: {</span><br><span class="line">              <span class="attr">"the_doc_count"</span>: <span class="string">"_count"</span></span><br><span class="line">            },</span><br><span class="line">            <span class="attr">"script"</span>: <span class="string">"params.the_doc_count == 1"</span></span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"took"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"timed_out"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"_shards"</span>: {</span><br><span class="line">    <span class="attr">"total"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"successful"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"skipped"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"failed"</span>: <span class="number">0</span></span><br><span class="line">  },</span><br><span class="line">  <span class="attr">"hits"</span>: {</span><br><span class="line">    <span class="attr">"total"</span>: {</span><br><span class="line">      <span class="attr">"value"</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">"relation"</span>: <span class="string">"eq"</span></span><br><span class="line">    },</span><br><span class="line">    <span class="attr">"max_score"</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">"hits"</span>: []</span><br><span class="line">  },</span><br><span class="line">  <span class="attr">"aggregations"</span>: {</span><br><span class="line">    <span class="attr">"group_by_link"</span>: {</span><br><span class="line">      <span class="attr">"doc_count_error_upper_bound"</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"sum_other_doc_count"</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"buckets"</span>: [</span><br><span class="line">        {</span><br><span class="line">          <span class="attr">"key"</span>: <span class="number">2147483647000</span>,</span><br><span class="line">          <span class="attr">"key_as_string"</span>: <span class="string">"2038-01-19T03:14:07.000Z"</span>,</span><br><span class="line">          <span class="attr">"doc_count"</span>: <span class="number">1</span></span><br><span class="line">        }</span><br><span class="line">      ]</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="过滤查询"><a href="#过滤查询" class="headerlink" title="过滤查询"></a>过滤查询</h4><h5 id="数组长度"><a href="#数组长度" class="headerlink" title="数组长度"></a>数组长度</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST yuzhouwan/_doc/</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"user"</span>: <span class="string">"BenedictJin"</span>,</span><br><span class="line">  <span class="attr">"end_time"</span>: <span class="string">"2038-01-19T03:14:07"</span>,</span><br><span class="line">  <span class="attr">"github"</span>: <span class="string">"asdf2014"</span>,</span><br><span class="line">  <span class="attr">"follower"</span>: [</span><br><span class="line">    <span class="string">"f1"</span>,</span><br><span class="line">    <span class="string">"f2"</span>,</span><br><span class="line">    <span class="string">"f3"</span></span><br><span class="line">  ]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<div class="note info">过滤查询之前，需要修改 mapping，给 follower 字段增加 "fielddata": true 属性</div>

<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /yuzhouwan/_search</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"query"</span>: {</span><br><span class="line">    <span class="attr">"bool"</span>: {</span><br><span class="line">      <span class="attr">"must"</span>: [</span><br><span class="line">        {</span><br><span class="line">          <span class="attr">"range"</span>: {</span><br><span class="line">            <span class="attr">"end_time"</span>: {</span><br><span class="line">              <span class="attr">"gte"</span>: <span class="string">"1514960000000"</span></span><br><span class="line">            }</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"filter"</span>: {</span><br><span class="line">        <span class="attr">"script"</span>: {</span><br><span class="line">          <span class="attr">"script"</span>: {</span><br><span class="line">            <span class="attr">"source"</span>: <span class="string">"doc['follower'].length == 3"</span></span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="删除数据"><a href="#删除数据" class="headerlink" title="删除数据"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-delete-by-query.html">删除数据</a></h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST yuzhouwan/_delete_by_query</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"query"</span>: {</span><br><span class="line">    <span class="attr">"match"</span>: {</span><br><span class="line">      <span class="attr">"github"</span> : <span class="string">"asdf2014"</span></span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="清理缓存"><a href="#清理缓存" class="headerlink" title="清理缓存"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-clearcache.html">清理缓存</a></h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看缓存情况</span></span><br><span class="line">GET /_stats/fielddata?fields=*</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理某一个索引的缓存</span></span><br><span class="line">POST /yuzhouwan/_cache/clear</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理全部索引的缓存</span></span><br><span class="line">POST /_cache/clear</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定缓存类型</span></span><br><span class="line">POST /yuzhouwan/_cache/clear?fielddata=<span class="literal">true</span>  </span><br><span class="line">POST /yuzhouwan/_cache/clear?query=<span class="literal">true</span>      </span><br><span class="line">POST /yuzhouwan/_cache/clear?request=<span class="literal">true</span>    </span><br></pre></td></tr></tbody></table></figure>
<h3 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h3><h4 id="获取索引"><a href="#获取索引" class="headerlink" title="获取索引"></a>获取索引</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看所有索引</span></span><br><span class="line">GET /_cat/indices</span><br><span class="line"><span class="comment"># 指定查看某一个索引</span></span><br><span class="line">GET /_cat/indices/yuzhouwan</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yellow open yuzhouwan jslqKujdSUu6LTymB3Lq9A 1 1 1 0 10kb 10kb</span><br></pre></td></tr></tbody></table></figure>
<h4 id="获取-Mapping"><a href="#获取-Mapping" class="headerlink" title="获取 Mapping"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-get-mapping.html">获取</a> Mapping</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取指定索引的 mapping</span></span><br><span class="line">GET /yuzhouwan/_mapping</span><br><span class="line">GET /yuzhouwan_day_20160527/_mapping</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取所有索引的 mapping</span></span><br><span class="line">GET /_all/_mapping</span><br><span class="line">GET /_mapping</span><br></pre></td></tr></tbody></table></figure>
<h4 id="更新-Mapping"><a href="#更新-Mapping" class="headerlink" title="更新 Mapping"></a>更新 Mapping</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUT /yuzhouwan/_mapping</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"properties"</span>: {</span><br><span class="line">    <span class="attr">"end_time"</span>: {</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"date"</span></span><br><span class="line">    },</span><br><span class="line">    <span class="attr">"follower"</span>: {</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"text"</span>,</span><br><span class="line">      <span class="attr">"fields"</span>: {</span><br><span class="line">        <span class="attr">"keyword"</span>: {</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"keyword"</span>,</span><br><span class="line">          <span class="attr">"ignore_above"</span>: <span class="number">256</span></span><br><span class="line">        }</span><br><span class="line">      },</span><br><span class="line">      <span class="attr">"fielddata"</span>: <span class="literal">true</span></span><br><span class="line">    },</span><br><span class="line">    <span class="attr">"github"</span>: {</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"text"</span>,</span><br><span class="line">      <span class="attr">"fields"</span>: {</span><br><span class="line">        <span class="attr">"keyword"</span>: {</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"keyword"</span>,</span><br><span class="line">          <span class="attr">"ignore_above"</span>: <span class="number">256</span></span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    },</span><br><span class="line">    <span class="attr">"star_num"</span>: {</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"long"</span></span><br><span class="line">    },</span><br><span class="line">    <span class="attr">"user"</span>: {</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"text"</span>,</span><br><span class="line">      <span class="attr">"fields"</span>: {</span><br><span class="line">        <span class="attr">"keyword"</span>: {</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"keyword"</span>,</span><br><span class="line">          <span class="attr">"ignore_above"</span>: <span class="number">256</span></span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="自动创建索引"><a href="#自动创建索引" class="headerlink" title="自动创建索引"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-index_.html#index-creation">自动创建索引</a></h4><p>　默认的，<code>action.auto_create_index</code> 参数为 <code>true</code>，意味着任何索引都可以随着数据写入而被自动创建。反之，如果设置为 <code>false</code> 这不允许任何的索引被自动创建</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUT _cluster/settings</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"persistent"</span>: {</span><br><span class="line">    <span class="attr">"action.auto_create_index"</span>: <span class="string">"false"</span></span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>　<code>+*day*,-*</code> 意味着除了满足 <code>*day*</code> 正则表达式的索引，不允许其他任何索引的自动创建</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUT _cluster/settings</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"persistent"</span>: {</span><br><span class="line">    <span class="attr">"action.auto_create_index"</span>: <span class="string">"+*day*,-*"</span></span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<div class="note success">可以用于控制只允许按天新建索引</div>



<h4 id="TimeZone"><a href="#TimeZone" class="headerlink" title="TimeZone"></a>TimeZone</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim attack_alarm.json</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"query"</span>: {</span><br><span class="line">    <span class="attr">"bool"</span>: {</span><br><span class="line">      <span class="attr">"must"</span>: [</span><br><span class="line">        {</span><br><span class="line">          <span class="attr">"match"</span>: {</span><br><span class="line">            <span class="attr">"customerId"</span>: {</span><br><span class="line">              <span class="attr">"query"</span>: <span class="string">"69"</span></span><br><span class="line">            }</span><br><span class="line">          }</span><br><span class="line">        },</span><br><span class="line">        {</span><br><span class="line">          <span class="attr">"range"</span>: {</span><br><span class="line">            <span class="attr">"startTime"</span>: {</span><br><span class="line">              <span class="attr">"from"</span>: <span class="string">"2016-09-20 00:00:00,000"</span>,</span><br><span class="line">              <span class="attr">"to"</span>: <span class="string">"2016-09-20 17:47:57,887"</span>,</span><br><span class="line">              <span class="attr">"format"</span>: <span class="string">"yyyy-MM-dd HH:mm:ss,SSS"</span>,</span><br><span class="line">              <span class="attr">"include_lower"</span>: <span class="literal">true</span>,</span><br><span class="line">              <span class="attr">"include_upper"</span>: <span class="literal">false</span></span><br><span class="line">            }</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      ]</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -XPOST -H <span class="string">'Content-Type: application/json'</span> http://localhost:9200/yuzhouwan_201609/attack_alarm/_search -d @attack_alarm.json</span><br></pre></td></tr></tbody></table></figure>
<p>　如果在构建 date 字段相关的查询是，可以直接传入 <code>yyyy-MM-dd HH:mm:ss,SSS</code> 格式的字符串，避免 <code>+08:00</code> 时区带来的困扰。也可以在程序中，将日期中的 local 时区去掉，从而使得日期和 ElasticSearch 本身的默认时区 <code>+00:00</code> 一致，具体写法如下</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">QueryBuilders.rangeQuery(params.get(<span class="string">"timeField"</span>))</span><br><span class="line">    .format(<span class="string">"yyyy-MM-dd HH:mm:ss,SSS"</span>)</span><br><span class="line">    .gte(<span class="string">"2016-09-20 00:00:00,000"</span>)</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Hot-warm"><a href="#Hot-warm" class="headerlink" title="Hot-warm"></a>Hot-warm</h4><p>　ElasticSearch 5.x 引入的新特性，可以通过 <code>node.attr.box_type</code> 参数，将 ElasticSearch 集群中部分高资源的节点配置为 <code>hot</code>，以存放需要频繁访问的数据，再将部分低资源的节点配置为 <code>warm</code>，以存放大量低频访问的数据。随后，在摄入业务数据的时候，可以通过设置 Index 索引的 <code>index.routing.allocation.require.box_type</code> 配置项，来指定数据具体存放在 <code>hot</code> 还是 <code>warm</code> 节点上。默认，可以将 Index 设置为 <code>hot</code>，在满足一定条件后，手动或通过 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/client/curator/current/installation.html">Curator</a> 工具自动将冷数据设置为 <code>warm</code></p>
<div class="note info">可以通过 rollover 查看 Index 中最早写入的一条数据距今已经过去多久、最大的文档数和磁盘空间大小</div>



<h4 id="合并索引"><a href="#合并索引" class="headerlink" title="合并索引"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-reindex.html">合并索引</a></h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST _reindex</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"source"</span>: {</span><br><span class="line">    <span class="attr">"index"</span>: <span class="string">"yuzhouwan_by_day_20200101*"</span></span><br><span class="line">  },</span><br><span class="line">  <span class="attr">"dest"</span>: {</span><br><span class="line">    <span class="attr">"index"</span>: <span class="string">"yuzhouwan_by_month_20200101"</span></span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="合并-Segment"><a href="#合并-Segment" class="headerlink" title="合并 Segment"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-forcemerge.html">合并 Segment</a></h4><p>　通过合并 Shard 下的 Segment 数量来解决小文件的问题，具体命令如下：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 指定某一个索引</span></span><br><span class="line">POST /yuzhouwan_by_month_20200101/_forcemerge</span><br><span class="line"><span class="comment"># 指定某一组索引</span></span><br><span class="line">POST /yuzhouwan_by_day_20200101*/_forcemerge</span><br><span class="line"><span class="comment"># 针对所有索引</span></span><br><span class="line">POST /_forcemerge</span><br><span class="line"><span class="comment"># 通过 max_num_segments 参数控制合并后的 Segment 数量</span></span><br><span class="line">POST /_forcemerge?max_num_segments=1</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Shrink"><a href="#Shrink" class="headerlink" title="Shrink"></a>Shrink</h4><h5 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h5><p>　ElasticSearch 5.x 引入的新特性，可以将一个索引中的 Shard 分片进行合并。而且其利用了操作系统的硬链接，使得该操作的完成可以控制在毫秒级。当然，如果操作系统不支持硬链接的话，则仍然需要拷贝 Segment 文件</p>
<h5 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST /yuzhouwan_source_index/_shrink/yuzhouwan_target_index</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"settings"</span>: {</span><br><span class="line">    <span class="attr">"index.number_of_replicas"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"index.number_of_shards"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"index.codec"</span>: <span class="string">"best_compression"</span></span><br><span class="line">  },</span><br><span class="line">  <span class="attr">"aliases"</span>: {</span><br><span class="line">    <span class="attr">"my_search_indices"</span>: {}</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Rollup"><a href="#Rollup" class="headerlink" title="Rollup"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/rollup-apis.html">Rollup</a></h4><h5 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h5><p>　ElasticSearch 6.6 引入的新特性，可以通过启动 Rollup 任务的形式，对现有的 Index 索引进行 Rollup，以生成预聚合的新索引</p>
<h5 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h5><h6 id="命令行"><a href="#命令行" class="headerlink" title="命令行"></a>命令行</h6><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUT _rollup/job/yuzhouwan</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="comment">// 匹配 Index</span></span><br><span class="line">  <span class="attr">"index_pattern"</span>: <span class="string">"yuzhouwan-*"</span>,</span><br><span class="line">  <span class="comment">// Rollup 后生成的 Index</span></span><br><span class="line">  <span class="attr">"rollup_index"</span>: <span class="string">"yuzhouwan_rollup"</span>,</span><br><span class="line">  <span class="comment">// 执行周期</span></span><br><span class="line">  <span class="attr">"cron"</span>: <span class="string">"*/30 * * * * ?"</span>,</span><br><span class="line">  <span class="comment">// 批处理的大小</span></span><br><span class="line">  <span class="attr">"page_size"</span>: <span class="number">1000</span>,</span><br><span class="line">  <span class="attr">"groups"</span>: {</span><br><span class="line">    <span class="comment">// 基于时间戳字段</span></span><br><span class="line">    <span class="comment">// Rollup 的时间粒度</span></span><br><span class="line">    <span class="comment">// 延迟 7 天后进行 Rollup，避免乱序数据无法被处理</span></span><br><span class="line">    <span class="attr">"date_histogram"</span>: {</span><br><span class="line">      <span class="attr">"field"</span>: <span class="string">"timestamp"</span>,</span><br><span class="line">      <span class="attr">"fixed_interval"</span>: <span class="string">"1h"</span>,</span><br><span class="line">      <span class="attr">"delay"</span>: <span class="string">"7d"</span></span><br><span class="line">    },</span><br><span class="line">    <span class="comment">// 聚合的维度</span></span><br><span class="line">    <span class="attr">"terms"</span>: {</span><br><span class="line">      <span class="attr">"fields"</span>: [</span><br><span class="line">        <span class="string">"node"</span></span><br><span class="line">      ]</span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  <span class="comment">// 聚合的度量，以及具体的聚合操作</span></span><br><span class="line">  <span class="attr">"metrics"</span>: [</span><br><span class="line">    {</span><br><span class="line">      <span class="attr">"field"</span>: <span class="string">"temperature"</span>,</span><br><span class="line">      <span class="attr">"metrics"</span>: [</span><br><span class="line">        <span class="string">"min"</span>,</span><br><span class="line">        <span class="string">"max"</span>,</span><br><span class="line">        <span class="string">"sum"</span></span><br><span class="line">      ]</span><br><span class="line">    },</span><br><span class="line">    {</span><br><span class="line">      <span class="attr">"field"</span>: <span class="string">"voltage"</span>,</span><br><span class="line">      <span class="attr">"metrics"</span>: [</span><br><span class="line">        <span class="string">"avg"</span></span><br><span class="line">      ]</span><br><span class="line">    }</span><br><span class="line">  ]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h6 id="Kibana"><a href="#Kibana" class="headerlink" title="Kibana"></a>Kibana</h6><ul>
<li>测试数据集</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUT _template/yuzhouwan_by_hour</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"index_patterns"</span>: [</span><br><span class="line">    <span class="string">"yuzhouwan_by_hour_*"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"settings"</span>: {</span><br><span class="line">    <span class="attr">"index"</span>: {</span><br><span class="line">      <span class="attr">"number_of_shards"</span>: <span class="number">3</span>,</span><br><span class="line">      <span class="attr">"number_of_replicas"</span>: <span class="number">1</span></span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  <span class="attr">"mappings"</span>: {</span><br><span class="line">    <span class="attr">"_source"</span>: {</span><br><span class="line">      <span class="attr">"enabled"</span>: <span class="literal">true</span></span><br><span class="line">    },</span><br><span class="line">    <span class="attr">"properties"</span>: {</span><br><span class="line">      <span class="attr">"user"</span>: {</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">      },</span><br><span class="line">      <span class="attr">"date"</span>: {</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"date"</span></span><br><span class="line">      },</span><br><span class="line">      <span class="attr">"url"</span>: {</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"object"</span></span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST yuzhouwan_by_hour_2020020200/_doc/1</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"user"</span>: <span class="string">"asdf2014"</span>,</span><br><span class="line">  <span class="attr">"date"</span>: <span class="string">"2020-02-02T00:00:00Z"</span>,</span><br><span class="line">  <span class="attr">"url"</span>: {</span><br><span class="line">    <span class="attr">"base"</span>: <span class="string">"/"</span>,</span><br><span class="line">    <span class="attr">"param"</span>: {}</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST yuzhouwan_by_hour_2020020201/_doc/1</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"user"</span>: <span class="string">"asdf2014"</span>,</span><br><span class="line">  <span class="attr">"date"</span>: <span class="string">"2020-02-02T01:00:00Z"</span>,</span><br><span class="line">  <span class="attr">"url"</span>: {</span><br><span class="line">    <span class="attr">"base"</span>: <span class="string">"/index"</span>,</span><br><span class="line">    <span class="attr">"param"</span>: {}</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>设置 Rollup 任务的名称，选择哪些 Index 被 Rollup，以及指定被 Rollup 后的新 Index 名称</li>
</ul>
<p><img data-src="/picture/es/es_rollup_1.png" alt></p>
<ul>
<li>设置执行周期、批处理的大小、延迟多久执行</li>
</ul>
<p><img data-src="/picture/es/es_rollup_2.png" alt></p>
<ul>
<li>指定时间维度和 Rollup 的聚合粒度</li>
</ul>
<p><img data-src="/picture/es/es_rollup_3.png" alt></p>
<ul>
<li>选择会被聚合查询的字段</li>
</ul>
<p><img data-src="/picture/es/es_rollup_4.png" alt></p>
<ul>
<li>选择会被用来作为直方图展示的数值型字段</li>
</ul>
<p><img data-src="/picture/es/es_rollup_5.png" alt></p>
<ul>
<li>选择 Rollup 的时候，需要做预聚合计算的字段</li>
</ul>
<p><img data-src="/picture/es/es_rollup_6.png" alt></p>
<ul>
<li>最终配置完成</li>
</ul>
<p><img data-src="/picture/es/es_rollup_7.png" alt></p>
<ul>
<li>查看 Rollup 任务列表</li>
</ul>
<p><img data-src="/picture/es/es_rollup_8.png" alt></p>
<ul>
<li>启停 Rollup 任务</li>
</ul>
<p><img data-src="/picture/es/es_rollup_9.png" alt></p>
<ul>
<li>等价于通过命令行配置 Rollup 任务</li>
</ul>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"config"</span>: {</span><br><span class="line">    <span class="attr">"id"</span>: <span class="string">"rollup"</span>,</span><br><span class="line">    <span class="attr">"index_pattern"</span>: <span class="string">"yuzhouwan_by_hour_20200202*"</span>,</span><br><span class="line">    <span class="attr">"rollup_index"</span>: <span class="string">"yuzhouwan_by_day_20200202"</span>,</span><br><span class="line">    <span class="attr">"cron"</span>: <span class="string">"0 0 0 * * ?"</span>,</span><br><span class="line">    <span class="attr">"groups"</span>: {</span><br><span class="line">      <span class="attr">"date_histogram"</span>: {</span><br><span class="line">        <span class="attr">"fixed_interval"</span>: <span class="string">"60m"</span>,</span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"date"</span>,</span><br><span class="line">        <span class="attr">"delay"</span>: <span class="string">"1d"</span>,</span><br><span class="line">        <span class="attr">"time_zone"</span>: <span class="string">"UTC"</span></span><br><span class="line">      },</span><br><span class="line">      <span class="attr">"terms"</span>: {</span><br><span class="line">        <span class="attr">"fields"</span>: [</span><br><span class="line">          <span class="string">"user"</span>,</span><br><span class="line">          <span class="string">"url.base.keyword"</span></span><br><span class="line">        ]</span><br><span class="line">      }</span><br><span class="line">    },</span><br><span class="line">    <span class="attr">"metrics"</span>: [],</span><br><span class="line">    <span class="attr">"timeout"</span>: <span class="string">"20s"</span>,</span><br><span class="line">    <span class="attr">"page_size"</span>: <span class="number">1000</span></span><br><span class="line">  },</span><br><span class="line">  <span class="attr">"status"</span>: {</span><br><span class="line">    <span class="attr">"job_state"</span>: <span class="string">"started"</span>,</span><br><span class="line">    <span class="attr">"upgraded_doc_id"</span>: <span class="literal">true</span></span><br><span class="line">  },</span><br><span class="line">  <span class="attr">"stats"</span>: {</span><br><span class="line">    <span class="attr">"pages_processed"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"documents_processed"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"rollups_indexed"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"trigger_count"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"index_time_in_ms"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"index_total"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"index_failures"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"search_time_in_ms"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"search_total"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"search_failures"</span>: <span class="number">0</span></span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h5 id="局限性"><a href="#局限性" class="headerlink" title="局限性"></a>局限性</h5><p>　截止到 ElasticSearch 7.9.1 版本，也只支持对 Date、Histogram 和 Terms 三种字段类型进行 Rollup 操作，且聚合算子也只有 max、min、sum、avg 和 count <a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/rollup-put-job.html">五种</a></p>
<h3 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h3><h4 id="创建模板"><a href="#创建模板" class="headerlink" title="创建模板"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-templates.html">创建模板</a></h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim template_yuzhouwan_day.json</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"index_patterns"</span>: [</span><br><span class="line">    <span class="string">"monitor_log_day_*"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"settings"</span>: {</span><br><span class="line">    <span class="attr">"index"</span>: {</span><br><span class="line">      <span class="attr">"number_of_shards"</span>: <span class="number">3</span>,</span><br><span class="line">      <span class="attr">"number_of_replicas"</span>: <span class="number">1</span></span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  <span class="attr">"mappings"</span>: {</span><br><span class="line">    <span class="attr">"_source"</span>: {</span><br><span class="line">      <span class="attr">"enabled"</span>: <span class="literal">true</span></span><br><span class="line">    },</span><br><span class="line">    <span class="attr">"properties"</span>: {</span><br><span class="line">      <span class="attr">"ip"</span>: {</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">      },</span><br><span class="line">      <span class="attr">"requestLength"</span>: {</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"integer"</span></span><br><span class="line">      },</span><br><span class="line">      <span class="attr">"spendMs"</span>: {</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"long"</span></span><br><span class="line">      },</span><br><span class="line">      <span class="attr">"attributes"</span>: {</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"object"</span></span><br><span class="line">      },</span><br><span class="line">      <span class="attr">"time"</span>: {</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"date"</span>,</span><br><span class="line">        <span class="attr">"format"</span>: <span class="string">"yyyy-MM-dd HH:mm:ss||strict_date_optional_time||epoch_millis"</span></span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -XPUT -H <span class="string">'Content-Type: application/json'</span> localhost:9200/_template/template_yuzhouwan_day -d @template_yuzhouwan_day.json</span><br></pre></td></tr></tbody></table></figure>
<h4 id="获取模板"><a href="#获取模板" class="headerlink" title="获取模板"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-get-template.html">获取模板</a></h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -XGET localhost:9200/_template/template_yuzhouwan_day</span><br></pre></td></tr></tbody></table></figure>
<h4 id="删除模板"><a href="#删除模板" class="headerlink" title="删除模板"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-delete-template.html">删除模板</a></h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -XDELETE localhost:9200/_template/template_yuzhouwan_day</span><br></pre></td></tr></tbody></table></figure>
<h3 id="插件"><a href="#插件" class="headerlink" title="插件"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/plugins/current/installation.html">插件</a></h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ bin/elasticsearch-plugin install analysis-icu</span><br><span class="line">  -&gt; Downloading analysis-icu from elastic</span><br><span class="line">  [=================================================] 100%</span><br><span class="line">  -&gt; Installed analysis-icu</span><br></pre></td></tr></tbody></table></figure>
<h3 id="集群状态"><a href="#集群状态" class="headerlink" title="集群状态"></a>集群状态</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -XGET <span class="string">'http://localhost:9200/_nodes/stats/_all'</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="熔断机制"><a href="#熔断机制" class="headerlink" title="熔断机制"></a>熔断机制</h3><p>　ElasticSearch 熔断器在接收到请求后，会评估出可能耗费的内存大小，如果超过了单机所能处理的最大内存限制时，就会拒绝请求，并返回异常。熔断机制通过一个总控熔断器和多个子类熔断器（字段数据加载、聚合请求计算需要的内存、请求本身的大小、加载后未释放的 Lucene Segment，以及内联脚本编译次数），对内存消耗进行控制，避免了 OOM 问题。相关的配置均属于集群层面，所以我们可以通过修改 <code>config/elasticsearch.yml</code> 配置文件或者调用 <code>PUT /_cluster/settings</code> 接口中进行设置</p>
<h3 id="基于磁盘容量的负载均衡"><a href="#基于磁盘容量的负载均衡" class="headerlink" title="基于磁盘容量的负载均衡"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/disk-allocator.html">基于磁盘容量的负载均衡</a></h3><p>　ElasticSearch 在决定是向某一个节点分配新的 Shard，还是主动从该节点重新分配 Shard 之前，会先考虑节点上的可用磁盘空间。该特性通过 <code>cluster.routing.allocation.disk.threshold_enabled</code> 参数进行控制，默认是开启的。相关行为主要通过三个阀值进行控制：当磁盘使用率达到 <code>85%</code> 的时候，就不再往该节点分配新的 Shard；当磁盘使用率达到 <code>90%</code> 的时候，将触发负载均衡，将 Shard 重定向到其他空闲节点上；而当磁盘使用率达到 <code>95%</code> 的时候，将会给所有的索引加上 read-only 的锁。此时，数据将无法写入，需要显示地将 <code>index.blocks.read_only_allow_delete</code> 参数设置为 <code>false</code> 才可以解除只读锁。具体的操作方法，详见下文 “踩过的坑 - blocked by: [FORBIDDEN/12/index read-only / allow delete (api)]”</p>
<h2 id="整合其他框架"><a href="#整合其他框架" class="headerlink" title="整合其他框架"></a>整合其他框架</h2><h3 id="ElasticSearch-Kafka-整合"><a href="#ElasticSearch-Kafka-整合" class="headerlink" title="ElasticSearch + Kafka 整合"></a>ElasticSearch + Kafka 整合</h3><p>　详见：我的另一篇博客《<a href="https://yuzhouwan.com/posts/26002/#Kafka-2-ElasticSearch">Apache Kafka 分布式消息队列框架</a>》</p>
<h3 id="ElasticSearch-Flume-整合"><a href="#ElasticSearch-Flume-整合" class="headerlink" title="ElasticSearch + Flume 整合"></a>ElasticSearch + Flume 整合</h3><p>　详见：Flume <a target="_blank" rel="external nofollow noopener noreferrer" href="https://flume.apache.org/FlumeUserGuide.html#elasticsearchsink">官网文档</a></p>
<h3 id="ElasticSearch-IK-中文分词"><a href="#ElasticSearch-IK-中文分词" class="headerlink" title="ElasticSearch + IK 中文分词"></a>ElasticSearch + IK 中文分词</h3><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><p>　详见：IK <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/medcl/elasticsearch-analysis-ik">官网文档</a></p>
<h4 id="中文分词器比对表"><a href="#中文分词器比对表" class="headerlink" title="中文分词器比对表"></a>中文分词器比对表</h4><div class="table-container">
<table>
<thead>
<tr>
<th>分词器</th>
<th>分词粒度</th>
<th>出错情况</th>
<th>支持处理字符</th>
<th>新词识别</th>
<th>词性标注</th>
<th>认证方法</th>
<th>接口</th>
</tr>
</thead>
<tbody>
<tr>
<td>BosonNLP</td>
<td>多选择</td>
<td>无</td>
<td>识别繁体字</td>
<td>有</td>
<td>有</td>
<td>Token</td>
<td>RESTful</td>
</tr>
<tr>
<td>IKAnalyzer</td>
<td>多选择</td>
<td>无</td>
<td>兼容韩文日文</td>
<td>有</td>
<td>无</td>
<td>无</td>
<td>Jar</td>
</tr>
<tr>
<td>NLPIR</td>
<td>多选择</td>
<td>中文间隔符</td>
<td>未知</td>
<td>有</td>
<td>有</td>
<td>无</td>
<td>多语言接口</td>
</tr>
<tr>
<td>SCWS</td>
<td>多选择</td>
<td>无</td>
<td>未知</td>
<td>有</td>
<td>有</td>
<td>无</td>
<td>PHP、Cli</td>
</tr>
<tr>
<td>结巴分词</td>
<td>多选择</td>
<td>无</td>
<td>识别繁体字</td>
<td>有</td>
<td>有</td>
<td>无</td>
<td>Python</td>
</tr>
<tr>
<td>盘古分词</td>
<td>多选择</td>
<td>无</td>
<td>识别繁体字</td>
<td>有</td>
<td>无</td>
<td>无</td>
<td>无</td>
</tr>
<tr>
<td>庖丁解牛</td>
<td>多选择</td>
<td>无</td>
<td>是</td>
<td>有</td>
<td>无</td>
<td>无</td>
<td>Jar</td>
</tr>
<tr>
<td>搜狗分词</td>
<td>小</td>
<td>字符长度过大</td>
<td>识别繁体字</td>
<td>未知</td>
<td>有</td>
<td>无</td>
<td>上传文档</td>
</tr>
<tr>
<td>腾讯文智</td>
<td>小</td>
<td>空白字符</td>
<td>未知</td>
<td>有</td>
<td>中文词性</td>
<td>Signature</td>
<td>RESTful</td>
</tr>
<tr>
<td>新浪云</td>
<td>大</td>
<td>无</td>
<td>未知</td>
<td>有</td>
<td>有</td>
<td>创建仓库</td>
<td>RESTful</td>
</tr>
<tr>
<td>语言云</td>
<td>适中</td>
<td>无</td>
<td>识别繁体字</td>
<td>有</td>
<td>有</td>
<td>Token</td>
<td>RESTful</td>
</tr>
</tbody>
</table>
</div>
<h2 id="技术内幕"><a href="#技术内幕" class="headerlink" title="技术内幕"></a>技术内幕</h2><h3 id="ElasticSearch-和-Lucene-的本质是什么，为什么会选型-ElasticSearch？"><a href="#ElasticSearch-和-Lucene-的本质是什么，为什么会选型-ElasticSearch？" class="headerlink" title="ElasticSearch 和 Lucene 的本质是什么，为什么会选型 ElasticSearch？"></a>ElasticSearch 和 Lucene 的本质是什么，为什么会选型 ElasticSearch？</h3><h4 id="本质"><a href="#本质" class="headerlink" title="本质"></a>本质</h4><p>　Lucene 是基于 Java 的全文检索库，而 ElasticSearch 是一款功能丰富的分布式搜索引擎</p>
<h4 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h4><h5 id="Lucene"><a href="#Lucene" class="headerlink" title="Lucene"></a>Lucene</h5><p>　需要为分布式、高可用性和实时写入（索引建立 -&gt; 可检索）等特性，进行额外的编码工作</p>
<h5 id="ElasticSearch"><a href="#ElasticSearch" class="headerlink" title="ElasticSearch"></a>ElasticSearch</h5><p>　具备分布式、实时分发、实时搜索、易用性（Multi-tenancy 多租户 / Gateway 备份）、高可用性（各节点组成对等的网络结构，方便故障转移）等特性</p>
<h4 id="进一步思考"><a href="#进一步思考" class="headerlink" title="进一步思考"></a>进一步思考</h4><h5 id="Solr、Lucene-作为全文检索系统，和-ElasticSearch-这种搜索引擎又有什么本质的区别？"><a href="#Solr、Lucene-作为全文检索系统，和-ElasticSearch-这种搜索引擎又有什么本质的区别？" class="headerlink" title="Solr、Lucene 作为全文检索系统，和 ElasticSearch 这种搜索引擎又有什么本质的区别？"></a>Solr、Lucene 作为全文检索系统，和 ElasticSearch 这种搜索引擎又有什么本质的区别？</h5><p>　<strong>搜索引擎</strong>，包含网页数据的快速采集、海量数据的索引和存储、搜索结果的相关性排序、搜索效率的毫秒级要求、分布式处理和负载均衡、自然语言的理解技术 等等</p>
<p>　<strong>全文检索</strong>，即文本全文检索，包括信息的存储、组织、表现、查询、存取等各个方面，其核心为文本信息的索引和检索</p>
<h3 id="为什么-ElasticSearch-集群使用-Hash-路由，而不是-Paxos，这两个算法有什么区别，各自最适的应用场景在哪里？"><a href="#为什么-ElasticSearch-集群使用-Hash-路由，而不是-Paxos，这两个算法有什么区别，各自最适的应用场景在哪里？" class="headerlink" title="为什么 ElasticSearch 集群使用 Hash 路由，而不是 Paxos，这两个算法有什么区别，各自最适的应用场景在哪里？"></a>为什么 ElasticSearch 集群使用 Hash 路由，而不是 Paxos，这两个算法有什么区别，各自最适的应用场景在哪里？</h3><p>　Hash 路由，主要用于解决数据均衡分布的问题。而 Paxos 主要用于保证分布式数据副本的一致性</p>
<p>　ElasticSearch 中的 Hash Router 会对每次请求的 <code>_id</code> 属性（即 Document ID，默认的 ElasticSearch 会自动为每一个 Document 分配一个长度为 20 的 UUID 字符串，也可以指定其他的字段）进行 Hash 操作，再对 Shard 数量进行取模</p>
<p>　实际上，二者根本不是一个层面上的概念，更应该拿 ElasticSearch 的 Gossip + Bully 选举机制来和 Paxos 进行比较。下文会有对 Gossip + Bully 选主算法的详细说明，这里就多介绍了</p>
<p>（更多相关内容详见，我的另外两篇博客《<a href="https://yuzhouwan.com/posts/54206/">大数据生态圈的一致性算法</a>》和《<a href="https://yuzhouwan.com/posts/31915/">ZooKeeper 原理与优化</a>》）</p>
<h3 id="ElasticSearch-倒排索引的原理"><a href="#ElasticSearch-倒排索引的原理" class="headerlink" title="ElasticSearch 倒排索引的原理"></a>ElasticSearch 倒排索引的原理</h3><h4 id="图解"><a href="#图解" class="headerlink" title="图解"></a>图解</h4><p>　已经有太多的书和博客来介绍，这里就不班门弄斧了，就简单画个图来帮助理解“倒排索引”的流程吧</p>
<p><img data-src="/picture/es/es_reverted_index.png" alt="Elasticsearch Reverted Index"></p>
<center>（利用 <a href="https://products.office.com/en-us/visio/visio-online" target="_blank" rel="external nofollow noopener noreferrer">Visio</a>™ 绘制而成）</center>



<h3 id="Lucene-4-实现的-DocValues-特性，为什么可以加速聚合运算？"><a href="#Lucene-4-实现的-DocValues-特性，为什么可以加速聚合运算？" class="headerlink" title="Lucene 4 实现的 DocValues 特性，为什么可以加速聚合运算？"></a>Lucene 4 实现的 DocValues 特性，为什么可以加速聚合运算？</h3><h4 id="DocValues-是什么？"><a href="#DocValues-是什么？" class="headerlink" title="DocValues 是什么？"></a>DocValues 是什么？</h4><p>　Lucene 在构建倒排索引时，额外建立的一个有序的、基于 Document -&gt; Field Value 的映射列表</p>
<h4 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h4><ul>
<li>对字段进行排序或聚合</li>
<li>某些过滤，比如地理位置过滤</li>
<li>某些与字段相关的脚本计算</li>
</ul>
<h4 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h4><p>　可以通过 <code>doc_values</code> 字段控制 DocValues 特性是否开启。默认地，会对除了 <code>analyzed strings</code> 之外的所有字段启用（即数字、地理坐标、日期、IP 和  <code>not_analyzed</code> 字符类型）</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUT yuzhouwan_index</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"mappings"</span>: {</span><br><span class="line">    <span class="attr">"yuzhouwan_type"</span>: {</span><br><span class="line">      <span class="attr">"properties"</span>: {</span><br><span class="line">        <span class="attr">"blog"</span>: {</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"string"</span>,</span><br><span class="line">          <span class="attr">"index"</span>: <span class="string">"not_analyzed"</span>,</span><br><span class="line">          <span class="attr">"doc_values"</span>: <span class="literal">true</span></span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><p>　倒排索引建立的是 KeyWord -&gt; Document 的映射关系，以便在文本检索时，通过类似 Hash 算法，来快速定位到 KeyWord，再从索引中获取到包含该 KeyWord 的 Document ID 集合。虽然，该方法保证了高效的检索，但在对数据做聚合运算时，却需要将所有出现了 KeyWord 的 Document 加载到内存中，很容易导致进程的内存溢出问题</p>
<p>　针对该问题，DocValues 便应运而生了。其会对开启了该特性的字段，额外构建一个 Document -&gt; Field Value 的正排索引。此时，聚合操作的流程就变成了，先找到 KeyWord 的 Document，再从 DocValues 中加载 Document 对应的 Filed Value 到内存中进行运算即可。同时，如果 Field Value 占用的内存远小于节点的可用内存，则会自动常驻在内存中，进而保证了性能；反之，则会序列化到磁盘中，避免出现 OOM 问题。另外，因为其列式存储的特性，使得压缩效率也很高</p>
<h4 id="进一步思考-1"><a href="#进一步思考-1" class="headerlink" title="进一步思考"></a>进一步思考</h4><h5 id="设置-stored-”true”-属性同样会构建正排索引，它和-DocValues-又有何不同？"><a href="#设置-stored-”true”-属性同样会构建正排索引，它和-DocValues-又有何不同？" class="headerlink" title="设置 stored=”true” 属性同样会构建正排索引，它和 DocValues 又有何不同？"></a>设置 stored=”true” 属性同样会构建正排索引，它和 DocValues 又有何不同？</h5><p>　主要区别在于，<a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-store.html">前者</a>是行式存储，而<a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/doc-values.html">后者</a>是列式存储；且前者直接存储字段原始值，而后者会进行分词</p>
<h3 id="ElasticSearch-5-0-内核迁移为-Lucene-6-x，是如何利用-Block-K-d-Tree-来解决-深度分页-问题？"><a href="#ElasticSearch-5-0-内核迁移为-Lucene-6-x，是如何利用-Block-K-d-Tree-来解决-深度分页-问题？" class="headerlink" title="ElasticSearch 5.0 内核迁移为 Lucene 6.x，是如何利用 Block K-d Tree 来解决 深度分页 问题？"></a>ElasticSearch 5.0 内核迁移为 Lucene 6.x，是如何利用 Block K-d Tree 来解决 深度分页 问题？</h3><h4 id="ElasticSearch-2-x-现状"><a href="#ElasticSearch-2-x-现状" class="headerlink" title="ElasticSearch 2.x 现状"></a>ElasticSearch 2.x 现状</h4><p>　使用 form + size 或者 scroll 的方式效率很低</p>
<h4 id="算法简介"><a href="#算法简介" class="headerlink" title="算法简介"></a>算法简介</h4><p>　K-d Tree，利用 <strong>方差 + 中位数</strong> 分割数据入 <strong>二叉树</strong>，再利用 <strong>二叉查找 + 递归溯源</strong> 的方式来查找数据。而 Block K-d Tree 则是一组 K-d Tree，解决了多维空间数据搜索，较高的空间利用率，高性能的查询和更新。使得 ElasticSearch 处理数值型数据和高维数据的性能提高了约 30%，同时存储空间大小节约了约 60%</p>
<h4 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h4><p>　在搜索过程中，N 个节点、K 维 的 K-d Tree 最坏的时间复杂度为：$T_{worst} = O(K*N^{1-\frac{1}{K}})$，所以其无法很好地处理高维数据；</p>
<p>　而 Block K-d Tree 虽然在插入性能方面比 K-d Tree 提升了几个数量级，但是如果系统使用的是非 SSD 硬盘，则可能会出现严重的毛刺现象</p>
<h2 id="源码阅读"><a href="#源码阅读" class="headerlink" title="源码阅读"></a>源码阅读</h2><div class="note success">源码分析是基于 ElasticSearch 7.9.1 和 Lucene 8.6.2 版本进行的</div>

<h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a><a href="https://yuzhouwan.com/posts/190816/">环境搭建</a></h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Lucene</span></span><br><span class="line">$ ant ivy-bootstrap</span><br><span class="line">$ ant idea</span><br><span class="line"></span><br><span class="line"><span class="comment"># ElasticSearch</span></span><br><span class="line">$ ./gradlew clean</span><br><span class="line">$ ./gradlew idea</span><br></pre></td></tr></tbody></table></figure>
<div class="note info">如果遇到未完全下载等问题，可以通过执行 rm -rf ~/.ivy2/cache 清理缓存的命令来解决</div>



<h3 id="Lucene-1"><a href="#Lucene-1" class="headerlink" title="Lucene"></a>Lucene</h3><h4 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h4><h5 id="索引（Index）"><a href="#索引（Index）" class="headerlink" title="索引（Index）"></a>索引（Index）</h5><p>　在 Lucene 中一个索引是放在一个文件夹中的，同一文件夹中的所有的文件构成一个 Lucene 索引</p>
<h5 id="段（Segment）"><a href="#段（Segment）" class="headerlink" title="段（Segment）"></a>段（Segment）</h5><p>　一个索引可以包含多个段，段与段之间是独立的，添加新文档可以生成新的段，不同的段可以进行合并。从文件名来看，<code>_0</code>、<code>_1</code> 或者 <code>_N</code> 开头的一组文件用于表示属于某一个段，<code>segments.gen</code> 和 <code>segments_N</code> 文件则保存了 Segment 相关的元数据信息</p>
<h5 id="文档（Document）"><a href="#文档（Document）" class="headerlink" title="文档（Document）"></a>文档（Document）</h5><p>　文档是创建索引的基本单位，不同的文档会保存在不同的段中，即一个段可以包含多个文档。新写入的文档会单独保存在一个新生成的段中，在随后的段合并操作中，不同的文档才合并到同一个 Segment 中</p>
<h5 id="域（Field）"><a href="#域（Field）" class="headerlink" title="域（Field）"></a>域（Field）</h5><p>　一个文档包含不同类型的信息，分别存在不同的域中，也就是文档的字段</p>
<h5 id="词典（Term-Directory）"><a href="#词典（Term-Directory）" class="headerlink" title="词典（Term Directory）"></a>词典（Term Directory）</h5><p>　字段内容经过分词、归一化、还原词根等处理之后，得到的所有单词的集合</p>
<h5 id="词（Term）"><a href="#词（Term）" class="headerlink" title="词（Term）"></a>词（Term）</h5><p>　词是索引的最小单位，本质上是词法分析和语言处理后的一个字符串</p>
<div class="note info">包含关系（一对多）依次是：Index &gt; Segment &gt; Document &gt; Field &gt; Term Directory &gt; Term</div>



<h4 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h4><h5 id="下载-Lucene"><a href="#下载-Lucene" class="headerlink" title="下载 Lucene"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://lucene.apache.org/core/downloads.html">下载 Lucene</a></h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ wget http://mirrors.tuna.tsinghua.edu.cn/apache/lucene/java/8.6.2/lucene-8.6.2.tgz</span><br><span class="line">$ tar zxvf lucene-8.6.2.tgz</span><br><span class="line">$ ln -s lucene-8.6.2 lucene</span><br><span class="line">$ <span class="built_in">cd</span> lucene</span><br></pre></td></tr></tbody></table></figure>
<h5 id="构造需要被索引的数据"><a href="#构造需要被索引的数据" class="headerlink" title="构造需要被索引的数据"></a>构造需要被索引的数据</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ vim blog.txt</span><br><span class="line">  google.com</span><br><span class="line">  yuzhouwan.com</span><br></pre></td></tr></tbody></table></figure>
<h5 id="创建索引文件"><a href="#创建索引文件" class="headerlink" title="创建索引文件"></a>创建索引文件</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ java -classpath <span class="string">'demo/lucene-demo-8.6.2.jar:core/lucene-core-8.6.2.jar'</span> org.apache.lucene.demo.IndexFiles -docs blog.txt</span><br><span class="line">  Indexing to directory <span class="string">'index'</span>...</span><br><span class="line">  adding blog.txt</span><br><span class="line">  368 total milliseconds</span><br></pre></td></tr></tbody></table></figure>
<h5 id="检索文件"><a href="#检索文件" class="headerlink" title="检索文件"></a>检索文件</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ java -classpath <span class="string">'demo/lucene-demo-8.6.2.jar:core/lucene-core-8.6.2.jar:queryparser/lucene-queryparser-8.6.2.jar'</span> org.apache.lucene.demo.SearchFiles</span><br><span class="line">  Enter query:</span><br><span class="line">  blog</span><br><span class="line">  Searching <span class="keyword">for</span>: blog</span><br><span class="line">  0 total matching documents</span><br><span class="line"></span><br><span class="line">  Enter query:</span><br><span class="line">  yuzhouwan</span><br><span class="line">  Searching <span class="keyword">for</span>: yuzhouwan</span><br><span class="line">  0 total matching documents</span><br><span class="line"></span><br><span class="line">  Enter query:</span><br><span class="line">  yuzhouwan.com</span><br><span class="line">  Searching <span class="keyword">for</span>: yuzhouwan.com</span><br><span class="line">  1 total matching documents</span><br><span class="line">  1. blog.txt</span><br></pre></td></tr></tbody></table></figure>
<h5 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ tree -L 2 index</span><br><span class="line">  index</span><br><span class="line">  ├── _0.cfe</span><br><span class="line">  ├── _0.cfs</span><br><span class="line">  ├── _0.si</span><br><span class="line">  ├── segments_1</span><br><span class="line">  └── write.lock</span><br></pre></td></tr></tbody></table></figure>
<h4 id="编程"><a href="#编程" class="headerlink" title="编程"></a>编程</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index</span></span><br><span class="line"><span class="keyword">try</span> (Directory index = <span class="keyword">new</span> NIOFSDirectory(Paths.get(<span class="string">"/tmp/index"</span>))) {</span><br><span class="line">    <span class="comment">// add</span></span><br><span class="line">    <span class="keyword">try</span> (IndexWriter writer = <span class="keyword">new</span> IndexWriter(index, <span class="keyword">new</span> IndexWriterConfig(<span class="keyword">new</span> StandardAnalyzer()))) {</span><br><span class="line">        Document doc = <span class="keyword">new</span> Document();</span><br><span class="line">        doc.add(<span class="keyword">new</span> TextField(<span class="string">"blog"</span>, <span class="string">"yuzhouwan.com"</span>, Field.Store.YES));</span><br><span class="line">        doc.add(<span class="keyword">new</span> StringField(<span class="string">"github"</span>, <span class="string">"asdf2014"</span>, Field.Store.YES));</span><br><span class="line">        writer.addDocument(doc);</span><br><span class="line">        writer.commit();</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// search</span></span><br><span class="line">    <span class="keyword">try</span> (DirectoryReader reader = DirectoryReader.open(index)) {</span><br><span class="line">        IndexSearcher searcher = <span class="keyword">new</span> IndexSearcher(reader);</span><br><span class="line">        QueryParser parser = <span class="keyword">new</span> QueryParser(<span class="string">"blog"</span>, <span class="keyword">new</span> StandardAnalyzer());</span><br><span class="line">        Query query = parser.parse(<span class="string">"yuzhouwan.com"</span>);</span><br><span class="line">        ScoreDoc[] hits = searcher.search(query, <span class="number">1000</span>).scoreDocs;</span><br><span class="line">        <span class="keyword">for</span> (ScoreDoc hit : hits) {</span><br><span class="line">            Document hitDoc = searcher.doc(hit.doc);</span><br><span class="line">            System.out.println(hitDoc.get(<span class="string">"blog"</span>));</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>Tips: Full code is <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/asdf2014/yuzhouwan/blob/master/yuzhouwan-bigdata/yuzhouwan-bigdata-lucene/src/main/java/com/yuzhouwan/bigdata/lucene/LuceneExample.java">here</a>.</p>
<h4 id="文件格式"><a href="#文件格式" class="headerlink" title="文件格式"></a>文件格式</h4><h5 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h5><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">名称</th>
<th style="text-align:center">文件后缀</th>
<th style="text-align:center">简要描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://lucene.apache.org/core/8_6_2/core/org/apache/lucene/index/SegmentInfos.html"><code>Segments File</code></a></td>
<td style="text-align:center">segments_N</td>
<td style="text-align:center">Stores information about a commit point</td>
</tr>
<tr>
<td style="text-align:center"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://lucene.apache.org/core/8_6_2/core/org/apache/lucene/codecs/lucene84/package-summary.html#Lock_File"><code>Lock File</code></a></td>
<td style="text-align:center">write.lock</td>
<td style="text-align:center">The Write lock prevents multiple IndexWriters from writing to the same file.</td>
</tr>
<tr>
<td style="text-align:center"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://lucene.apache.org/core/8_6_2/core/org/apache/lucene/codecs/lucene86/Lucene86SegmentInfoFormat.html"><code>Segment Info</code></a></td>
<td style="text-align:center">.si</td>
<td style="text-align:center">Stores metadata about a segment</td>
</tr>
<tr>
<td style="text-align:center"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://lucene.apache.org/core/8_6_2/core/org/apache/lucene/codecs/lucene50/Lucene50CompoundFormat.html"><code>Compound File</code></a></td>
<td style="text-align:center">.cfs、.cfe</td>
<td style="text-align:center">An optional “virtual” file consisting of all the other index files for systems that frequently run out of file handles.</td>
</tr>
<tr>
<td style="text-align:center"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://lucene.apache.org/core/8_6_2/core/org/apache/lucene/codecs/lucene50/Lucene50FieldInfosFormat.html"><code>Fields</code></a></td>
<td style="text-align:center">.fnm</td>
<td style="text-align:center">Stores information about the fields</td>
</tr>
<tr>
<td style="text-align:center"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://lucene.apache.org/core/8_6_2/core/org/apache/lucene/codecs/lucene50/Lucene50StoredFieldsFormat.html"><code>Field Index</code></a></td>
<td style="text-align:center">.fdx</td>
<td style="text-align:center">Contains pointers to field data</td>
</tr>
<tr>
<td style="text-align:center"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://lucene.apache.org/core/8_6_2/core/org/apache/lucene/codecs/lucene50/Lucene50StoredFieldsFormat.html"><code>Field Data</code></a></td>
<td style="text-align:center">.fdt</td>
<td style="text-align:center">The stored fields for documents</td>
</tr>
<tr>
<td style="text-align:center"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://lucene.apache.org/core/8_6_2/core/org/apache/lucene/codecs/lucene84/Lucene84PostingsFormat.html"><code>Term Dictionary</code></a></td>
<td style="text-align:center">.tim</td>
<td style="text-align:center">The term dictionary, stores term info</td>
</tr>
<tr>
<td style="text-align:center"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://lucene.apache.org/core/8_6_2/core/org/apache/lucene/codecs/lucene84/Lucene84PostingsFormat.html"><code>Term Index</code></a></td>
<td style="text-align:center">.tip</td>
<td style="text-align:center">The index into the Term Dictionary</td>
</tr>
<tr>
<td style="text-align:center"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://lucene.apache.org/core/8_6_2/core/org/apache/lucene/codecs/lucene84/Lucene84PostingsFormat.html"><code>Frequencies</code></a></td>
<td style="text-align:center">.doc</td>
<td style="text-align:center">Contains the list of docs which contain each term along with frequency</td>
</tr>
<tr>
<td style="text-align:center"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://lucene.apache.org/core/8_6_2/core/org/apache/lucene/codecs/lucene84/Lucene84PostingsFormat.html"><code>Positions</code></a></td>
<td style="text-align:center">.pos</td>
<td style="text-align:center">Stores position information about where a term occurs in the index</td>
</tr>
<tr>
<td style="text-align:center"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://lucene.apache.org/core/8_6_2/core/org/apache/lucene/codecs/lucene84/Lucene84PostingsFormat.html"><code>Payloads</code></a></td>
<td style="text-align:center">.pay</td>
<td style="text-align:center">Stores additional per-position metadata information such as character offsets and user payloads</td>
</tr>
<tr>
<td style="text-align:center"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://lucene.apache.org/core/8_6_2/core/org/apache/lucene/codecs/lucene80/Lucene80NormsFormat.html"><code>Norms</code></a></td>
<td style="text-align:center">.nvd、.nvm</td>
<td style="text-align:center">Encodes length and boost factors for docs and fields</td>
</tr>
<tr>
<td style="text-align:center"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://lucene.apache.org/core/8_6_2/core/org/apache/lucene/codecs/lucene80/Lucene80DocValuesFormat.html"><code>Per-Document Values</code></a></td>
<td style="text-align:center">.dvd、.dvm</td>
<td style="text-align:center">Encodes additional scoring factors or other per-document information.</td>
</tr>
<tr>
<td style="text-align:center"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://lucene.apache.org/core/8_6_2/core/org/apache/lucene/codecs/lucene50/Lucene50TermVectorsFormat.html"><code>Term Vector Index</code></a></td>
<td style="text-align:center">.tvx</td>
<td style="text-align:center">Stores offset into the document data file</td>
</tr>
<tr>
<td style="text-align:center"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://lucene.apache.org/core/8_6_2/core/org/apache/lucene/codecs/lucene50/Lucene50TermVectorsFormat.html"><code>Term Vector Data</code></a></td>
<td style="text-align:center">.tvd</td>
<td style="text-align:center">Contains term vector data.</td>
</tr>
<tr>
<td style="text-align:center"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://lucene.apache.org/core/8_6_2/core/org/apache/lucene/codecs/lucene50/Lucene50LiveDocsFormat.html"><code>Live Documents</code></a></td>
<td style="text-align:center">.liv</td>
<td style="text-align:center">Info about what documents are live</td>
</tr>
<tr>
<td style="text-align:center"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://lucene.apache.org/core/8_6_2/core/org/apache/lucene/codecs/lucene86/Lucene86PointsFormat.html"><code>Point values</code></a></td>
<td style="text-align:center">.dii、.dim</td>
<td style="text-align:center">Holds indexed points, if any</td>
</tr>
</tbody>
</table>
</div>
<center>（表格来源：<a href="https://lucene.apache.org/core/8_6_2/core/org/apache/lucene/codecs/lucene86/package-summary.html" target="_blank" rel="external nofollow noopener noreferrer">lucene.apache.org</a> 官方文档）</center>

<h5 id="正排索引"><a href="#正排索引" class="headerlink" title="正排索引"></a>正排索引</h5><ul>
<li><code>segments_N</code> 保存了此 Index 包含多少个 Segment，每个 Segment 包含多少 Document</li>
<li><code>.fnm</code> 保存了此 Segment 包含了多少个 Field，每个 Field 的名称及索引方式</li>
<li><code>.fdx</code> 和 <code>.fdt</code> 保存了此 Segment 包含的所有 Document，各个 Document 包含了哪些 Field，以及每个 Field 保存了哪些信息</li>
<li><code>.tvx</code> 和 <code>.tvd</code> 保存了此 Segment 包含多少 Document，各个 Document 包含了多少 Field，每个 Field 包含了多少 Term，每个 Term 字符串的位置信息等</li>
</ul>
<h5 id="倒排索引"><a href="#倒排索引" class="headerlink" title="倒排索引"></a>倒排索引</h5><ul>
<li><p><code>.tim</code> 保存了 Term Directory，并以字典序保存 Term，方便进行高效的二分查找（ $O(\log_2^n)$） </p>
</li>
<li><p><code>.tip</code> 保存了 Term 到 Term Directory 的倒排索引。这里使用的数据结构是 FST（<strong>F</strong>inite <strong>S</strong>tate <strong>T</strong>ransducers，有限状态传感器），构建了一个 Term 的前缀树，不仅压缩了存储空间，还提高了查询速度（ $O(len(str))$） </p>
<p><img data-src="/picture/lucene/lucene_term_directory_inverted_index.png" alt="Term to Term Directory Inverted Index"></p>
<center>（图片来源：easynosql.com™，该网站已故障，侵删谢谢）</center>
</li>
<li><p><code>.doc</code> 保存了倒排表（即每个 Term 到 Document ID 的列表），同时也保存了 Document 中 Term 出现的频率</p>
</li>
</ul>
<h5 id="全文检索"><a href="#全文检索" class="headerlink" title="全文检索"></a>全文检索</h5><ul>
<li><code>.pos</code> 保存了倒排表中每个 Term，以及在 Document 中的位置</li>
<li><code>.nvd</code> 和 <code>.nvm</code> 保存 Field 得分信息</li>
</ul>
<h5 id="列式存储"><a href="#列式存储" class="headerlink" title="列式存储"></a>列式存储</h5><ul>
<li><code>.dvd</code> 和 <code>.dvm</code> 保存 DocValues 信息，用以加速聚合排序等查询</li>
</ul>
<div class="note info">其中，`.fdx`、`.tip` 和 `.dvm` 文件会被加载于内存中，以确保集群的高效运作；如果 `.liv` 文件不存在，则表示没有需要被删除的 Document</div>






<h4 id="Document-模块"><a href="#Document-模块" class="headerlink" title="Document 模块"></a>Document 模块</h4><h5 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h5><p>　定义 Document 和各种相关的数据类型</p>
<h5 id="主体"><a href="#主体" class="headerlink" title="主体"></a>主体</h5><ul>
<li><p>org.apache.lucene.document.<strong>Document</strong></p>
<p>由 Field 组成的文档记录的</p>
</li>
<li><p>org.apache.lucene.document.<strong>Field</strong></p>
<p>Document 中的一个字段</p>
</li>
</ul>
<h4 id="Codecs-模块"><a href="#Codecs-模块" class="headerlink" title="Codecs 模块"></a>Codecs 模块</h4><h5 id="功能-1"><a href="#功能-1" class="headerlink" title="功能"></a>功能</h5><p>　基础数据结构和编码压缩算法的实现，包括 skipList，docValue 等</p>
<h4 id="Analysis-模块"><a href="#Analysis-模块" class="headerlink" title="Analysis 模块"></a>Analysis 模块</h4><h5 id="功能-2"><a href="#功能-2" class="headerlink" title="功能"></a>功能</h5><p>　词法分析，并输出索引的最小单位 Term</p>
<h5 id="主体-1"><a href="#主体-1" class="headerlink" title="主体"></a>主体</h5><ul>
<li><p>org.apache.lucene.analysis.<strong>Analyzer</strong></p>
<p>分析器会对内容进行过滤，分词，转换等，把过滤之后的数据交给 IndexWriter 进行索引</p>
</li>
</ul>
<h4 id="Index-模块"><a href="#Index-模块" class="headerlink" title="Index 模块"></a>Index 模块</h4><h5 id="功能-3"><a href="#功能-3" class="headerlink" title="功能"></a>功能</h5><p>　创建索引</p>
<h5 id="主体-2"><a href="#主体-2" class="headerlink" title="主体"></a>主体</h5><ul>
<li><p>org.apache.lucene.index.<strong>IndexWriter</strong></p>
<p>索引写操作的核心类</p>
<ul>
<li><p>addDocument</p>
<p>将 Document 添加到索引中</p>
</li>
<li><p>updateDocument</p>
<p>更新 Document，等同于 delete by term + add document 两个操作的组合，并确保了其原子性</p>
</li>
<li><p>deleteDocument</p>
<p>删除 Document，支持 delete by term 和 delete by query</p>
</li>
<li><p>prepareCommit</p>
<p>二阶段提交的第一步</p>
</li>
<li><p>commit</p>
<p>二阶段提交的第二步，成功之后会生成一个 segment_N 文件新的 N 值，也只有 commit 成功之后，数据才可以被检索到</p>
</li>
<li><p>rollback</p>
<p>prepareCommit 或者 commit 任何一个操作失败之后，都会回滚到提交前的状态</p>
</li>
<li><p>maybeMerge</p>
<p>触发一次 MergePolicy 的执行，不满足条件的情况下，并不会执行 merge 操作</p>
</li>
<li><p>forceMerge</p>
<p>强制触发一次 merge 操作</p>
</li>
</ul>
</li>
<li><p>org.apache.lucene.index.<strong>SegmentInfos</strong></p>
<ul>
<li><p>getLastCommitGeneration(org.apache.lucene.store.Directory)</p>
<p>获取索引目录下最近一次的 commit 号，以定位最大的 segment_N 文件</p>
</li>
</ul>
</li>
<li><p>org.apache.lucene.index.<strong>Term</strong></p>
<p>Term 是文本检索的基本单元，一个 Term 由 KeyValue 组成，Key 为需要检索的字段名称，Value 为字段的值</p>
</li>
</ul>
<h5 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h5><ul>
<li><p>wait_for_active_shards</p>
<p>集群中至少有多少存活的 Shard 才执行写入操作，可以设置为 <code>all</code> 表示需要主 Shard 和所有的副 Shard 均存活才执行写操作，默认值：<code>1</code>（即只需要主 Shard 存活即可写入）</p>
</li>
</ul>
<h4 id="Store-模块"><a href="#Store-模块" class="headerlink" title="Store 模块"></a>Store 模块</h4><h5 id="功能-4"><a href="#功能-4" class="headerlink" title="功能"></a>功能</h5><p>　读写索引</p>
<h5 id="主体-3"><a href="#主体-3" class="headerlink" title="主体"></a>主体</h5><ul>
<li><p>org.apache.lucene.store.<strong>Directory</strong></p>
<p>IndexWriter 通过获取 Directory 的一个具体实现，在 Directory 指向的位置中操作索引</p>
<ul>
<li><p>FSDirectory</p>
<p>表示一个存储在文件系统中的索引的位置</p>
</li>
<li><p>ByteBuffersDirectory</p>
<p>表示一个存储在内存当中的索引的位置</p>
</li>
</ul>
</li>
</ul>
<h4 id="Parser-模块"><a href="#Parser-模块" class="headerlink" title="Parser 模块"></a>Parser 模块</h4><h5 id="功能-5"><a href="#功能-5" class="headerlink" title="功能"></a>功能</h5><p>　查询的语法分析</p>
<h4 id="Search-模块"><a href="#Search-模块" class="headerlink" title="Search 模块"></a>Search 模块</h4><h5 id="功能-6"><a href="#功能-6" class="headerlink" title="功能"></a>功能</h5><p>　搜索索引</p>
<h5 id="主体-4"><a href="#主体-4" class="headerlink" title="主体"></a>主体</h5><ul>
<li><p>org.apache.lucene.search.<strong>IndexSearcher</strong></p>
<p>以只读的方式打开一个索引，并进行检索</p>
<ul>
<li><p>search</p>
<p>从索引中检索 Document</p>
</li>
</ul>
</li>
<li><p>org.apache.lucene.search.<strong>Query</strong></p>
<p>封装查询请求</p>
<ul>
<li><p>TermQuery</p>
<p>最基本的 Term 查询</p>
</li>
<li><p>BooleanQuery</p>
<p>可以组合多个查询条件</p>
</li>
<li><p>PointRangeQuery</p>
<p>数值区间查询，可以通过 <code>IntPoint#newRangeQuery</code>、<code>LongPoint#newRangeQuery</code>、<code>FloatPoint#newRangeQuery</code> 和 <code>DoublePoint#newRangeQuery</code> 等方式进行创建</p>
</li>
<li><p>PrefixQuery</p>
<p>前缀查询</p>
</li>
<li><p>FuzzyQuery</p>
<p>模糊查询</p>
</li>
<li><p>WildcardQuery</p>
<p>通配符查询</p>
</li>
<li><p>RegexpQuery</p>
<p>正则表达式查询</p>
</li>
<li><p>MultiFieldQueryParser</p>
<p>多值查询</p>
</li>
<li><p>TopDocs</p>
<p>TopN 查询</p>
</li>
</ul>
</li>
</ul>
<h4 id="Similarity-模块"><a href="#Similarity-模块" class="headerlink" title="Similarity 模块"></a>Similarity 模块</h4><h5 id="功能-7"><a href="#功能-7" class="headerlink" title="功能"></a>功能</h5><p>　相关度打分</p>
<h4 id="Geo-模块"><a href="#Geo-模块" class="headerlink" title="Geo 模块"></a>Geo 模块</h4><h5 id="功能-8"><a href="#功能-8" class="headerlink" title="功能"></a>功能</h5><p>　空间查询</p>
<h3 id="ElasticSearch-1"><a href="#ElasticSearch-1" class="headerlink" title="ElasticSearch"></a>ElasticSearch</h3><h4 id="Transport-模块"><a href="#Transport-模块" class="headerlink" title="Transport 模块"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-transport.html">Transport</a> 模块</h4><h5 id="功能-9"><a href="#功能-9" class="headerlink" title="功能"></a>功能</h5><p>　保障了集群内各节点之间可以进行网络通讯</p>
<h5 id="主体-5"><a href="#主体-5" class="headerlink" title="主体"></a>主体</h5><ul>
<li><p>org.elasticsearch.cli.<strong>Command</strong>#main</p>
</li>
<li><p>org.elasticsearch.cli.<strong>EnvironmentAwareCommand</strong>#execute</p>
</li>
<li><p>org.elasticsearch.bootstrap.<strong>Elasticsearch</strong>#execute</p>
</li>
<li><p>org.elasticsearch.bootstrap.<strong>Bootstrap</strong></p>
</li>
<li><p>org.elasticsearch.node.<strong>Node</strong></p>
</li>
<li><p>org.elasticsearch.transport.<strong>TransportService</strong></p>
<ul>
<li><p>connectToNode</p>
<p>连接集群中的其他 Node 节点</p>
</li>
<li><p>sendRequest</p>
<p>发送请求</p>
</li>
<li><p>registerRequestHandler</p>
<p>注册 TransportRequestHandler，用于处理接收到的请求</p>
</li>
</ul>
</li>
<li><p>org.elasticsearch.transport.<strong>Transport</strong></p>
</li>
<li><p>org.elasticsearch.transport.netty4.<strong>Netty4Transport</strong>（transport-netty4 模块）</p>
</li>
<li><p>org.elasticsearch.transport.netty4.<strong>Netty4MessageChannelHandler</strong></p>
</li>
</ul>
<h5 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h5><ul>
<li><p>transport.port</p>
<p>Transport 服务绑定的端口范围，默认值为 <code>9300-9400</code></p>
</li>
<li><p>transport.type</p>
<p>控制 Transport 通讯时的网络类型，默认值为 <code>netty4</code></p>
</li>
<li><p>transport.compress</p>
<p>控制是否针对 Request 请求和 Response 返回结果进行压缩，默认值为 <code>false</code></p>
</li>
</ul>
<h5 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h5><p>　Command 完成 ElasticSearch 进程的启动，随后依次初始化 Bootstrap、Node、Transport 和 TransportService 并启动。节点间通讯的消息处理，最终由 Netty4MessageChannelHandler 进行处理。该 Handler 的注册操作，则会在 Netty4Transport 中完成</p>
<h4 id="Zen-Discovery-模块"><a href="#Zen-Discovery-模块" class="headerlink" title="Zen Discovery 模块"></a>Zen Discovery 模块</h4><h5 id="功能-10"><a href="#功能-10" class="headerlink" title="功能"></a>功能</h5><p>　可以让 ElasticSearch 节点自动互相发现，并组成一个集群，且能通过选举机制找到一个 Master 节点</p>
<h5 id="配置-2"><a href="#配置-2" class="headerlink" title="配置"></a>配置</h5><ul>
<li><p>node.master</p>
<p>如果设置为 true，则可以参与到 Master 选举过程中，默认值为 <code>true</code></p>
</li>
<li><p>node.data</p>
<p>如果设置为 true，则可以存储数据，并处理与数据相关的 CRUD、查询和聚合等操作，默认值为 <code>true</code></p>
<p>排列组合 <code>node.master</code> 和 <code>node.data</code> 这两个参数的结果，如下表所示：</p>
</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">data: true</th>
<th style="text-align:center">data: false</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><strong>master: true</strong></td>
<td style="text-align:center">既是种子节点，又是数据节点</td>
<td style="text-align:center">单纯的种子节点</td>
</tr>
<tr>
<td style="text-align:center"><strong>master: false</strong></td>
<td style="text-align:center">单纯的数据节点</td>
<td style="text-align:center">最简单的协调节点</td>
</tr>
</tbody>
</table>
</div>
  <div class="note info">其中，协调节点负责查询时的数据收集、合并以及聚合等操作。默认的，ElasticSearch 集群中所有节点都是协调节点。其实严格来说，除了 node.master 和 node.data 设置为 false，还需要将 node.ingest 也设置为 false 之后，才能算纯粹的 Coordinating 节点</div>

<ul>
<li><p>node.ingest</p>
<p>如果设置为 true，则可以创建一个 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/pipeline.html">ingest pipeline</a> 任务，对未被索引到 Index 之前的 Document 数据进行预处理，例如设置某一些字段值或者增加一个新字段（如记录摄入时间的新字段）。考虑到可能会增加机器的负载，生产环境中，最好将 Master 节点和 Node 节点上的这个功能关闭，默认值为 <code>true</code></p>
</li>
<li><p>xpack.ml.enabled</p>
<p>如果设置为 true，则可以处理 ElasticSearch 机器学习的接口请求，默认值为 <code>true</code></p>
</li>
<li><p>node.ml</p>
<p>如果设置为 true，则可以运行机器学习相关的任务，默认值为 <code>true</code></p>
</li>
<li><p>discovery.seed_hosts</p>
<p>提供一组可以成为 Master 的种子节点的 IP 地址，如果未指定端口号，将会自动使用 <code>transport.port</code> 的配置值（默认 9300）</p>
</li>
<li><p>discovery.seed_providers</p>
<p>另一种提供种子节点 IP 地址的方式，指定一个存放 IP 地址的文件，可以动态加载，避免集群扩缩容时需要重启 ElasticSearch 进程的问题</p>
</li>
<li><p>discovery.find_peers_interval</p>
<p>Discovery 机制的周期频率，默认值为 <code>1s</code></p>
</li>
</ul>
<h5 id="流程-1"><a href="#流程-1" class="headerlink" title="流程"></a>流程</h5><p>　ElasticSearch 将集群内的节点分为了四种类型，分别是 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html#master-node">Master-eligible node</a>、<a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html#data-node">Data node</a>、<a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/ingest.html">Ingest node</a> 和 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html#ml-node">Machine learning node</a>。Master 选举只会在 Master-eligible 种子节点之间进行，触发条件为：</p>
<ol>
<li>当前 Master-eligible 节点不是 Master 节点</li>
<li>当前 Master-eligible 节点与其它的节点通信后发现不存在 Master</li>
</ol>
<p>　发起 <a href="https://yuzhouwan.com/posts/22654/#Gossip">Gossip</a> + <a href="https://yuzhouwan.com/posts/22654/#Bully">Bully</a> 的选举流程：</p>
<ol>
<li>寻找 clusterStateVersion 比自己高的 Master-eligible 的节点，向其发送选票</li>
<li>如果 clusterStatrVersion 一样，则计算自己能找到的 Master-eligible 节点中（包括自己）ID 最小的一个节点，向该节点发送选票</li>
<li>如果一个节点收到过半的选票，并且它也向自己投票了，那么该节点成为 Master 节点</li>
</ol>
<p>　成功从 Master-eligible 节点中选举出 Master 节点之后，那么这个 Master 节点将会负责集群（集群信息、集群健康、集群状态、集群配置、所有分片、节点关闭、集群路由）和索引（索引的创建与删除、索引 Template 和 Mapping 的创建删除与更新、索引 Warmer 创建删除与获取、索引的打开与关闭）相关的所有请求</p>
<h5 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h5><h6 id="Bully"><a href="#Bully" class="headerlink" title="Bully"></a>Bully</h6><p>　Bully 算法会假定所有节点都有一个惟一的 ID，并可以依据 ID 对集群内节点进行排序，而拥有最高 ID 的那个节点则会成为 Master 节点</p>
<h6 id="Gossip"><a href="#Gossip" class="headerlink" title="Gossip"></a>Gossip</h6><p>　Gossip 本质上就是一个并行的图广度优先遍历搜索算法，可以借助一个动图来直观感受一下：</p>
<p><img data-src="/picture/es/es_grossip.gif" alt="Gossip"></p>
<center>（图片来源：jianshu.com™，已联系作者，获得授权。不过最近发现该文章已下线，侵删谢谢）</center>

<h6 id="单播-vs-组播-vs-广播"><a href="#单播-vs-组播-vs-广播" class="headerlink" title="单播 vs 组播 vs 广播"></a>单播 vs 组播 vs 广播</h6><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">网络模型</th>
<th style="text-align:center">优点</th>
<th style="text-align:center">缺点</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">单播（unicast）</td>
<td style="text-align:center"><img data-src="/picture/es/es_unicast.svg"></td>
<td style="text-align:center">点对点通讯可以保证低响应延迟</td>
<td style="text-align:center">服务端流量消耗较大</td>
</tr>
<tr>
<td style="text-align:center">组播（multicast）</td>
<td style="text-align:center"><img data-src="/picture/es/es_multicast.svg"></td>
<td style="text-align:center">共享数据流可以减少带宽负载</td>
<td style="text-align:center">无纠错机制，发生丢包或错包之后，很难弥补</td>
</tr>
<tr>
<td style="text-align:center">广播（broadcast）</td>
<td style="text-align:center"><img data-src="/picture/es/es_broadcast.svg"></td>
<td style="text-align:center">网络设备简单可以减少布网和维护的成本</td>
<td style="text-align:center">无法提供定制化服务，且客户端的网络带宽将成为瓶颈</td>
</tr>
</tbody>
</table>
</div>
<center>（图片来源：<a href="https://en.wikipedia.org/wiki/Unicast" target="_blank" rel="external nofollow noopener noreferrer">wikipedia.org</a>™，已确认无版权）</center>



<h4 id="数据写入"><a href="#数据写入" class="headerlink" title="数据写入"></a>数据写入</h4><h5 id="流程-2"><a href="#流程-2" class="headerlink" title="流程"></a>流程</h5><p>　因为 ElasticSearch 内所有节点都默认属于 Coordinating 节点，这意味着每个节点都有能力处理任何一种请求</p>
<p><img data-src="/picture/es/es_write_1.png" alt="ElasticSearch Write"></p>
<center>（图片来源：<a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/how-primary-and-replica-shards-interact.html" target="_blank" rel="external nofollow noopener noreferrer">ElasticSearch</a>™ 官方文档）</center>

<p>　这里我们以单 Index、两 Shard、三 Replication、三 Node 的 ElasticSearch 集群为例</p>
<p><img data-src="/picture/es/es_write_2.png" alt="ElasticSearch Write"></p>
<center>（图片来源：<a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/distrib-write.html" target="_blank" rel="external nofollow noopener noreferrer">ElasticSearch</a>™ 官方文档）</center>

<ol>
<li>客户端向 <code>NODE 1</code> 发送新建、索引或者删除请求</li>
<li>节点使用 Document 的 <code>_id</code> 确定 Document 属于 Shard 0。请求会被转发到 <code>NODE 3</code>，因为分片 0 的主分片目前被分配在 <code>NODE 3</code> 上</li>
<li><code>NODE 3</code> 在主分片上面执行请求。如果成功了，它将请求并行转发到 <code>NODE 1</code> 和 <code>NODE 2</code> 的副本分片上。一旦所有的副本分片都成功返回，<code>Node 3</code> 将向协调节点报告成功，随后协调节点再向客户端反馈请求成功</li>
</ol>
<p>　而内部持久化到磁盘的流程和 <a href="https://yuzhouwan.com/posts/45888/">HBase</a> 很像，所以还可以借鉴 HBase 的概念进行理解：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>HBase</th>
<th>ElasticSearch</th>
</tr>
</thead>
<tbody>
<tr>
<td>MemStore</td>
<td>IndexBuffer</td>
</tr>
<tr>
<td>HFile</td>
<td>Segment</td>
</tr>
<tr>
<td>WAL</td>
<td>Translog</td>
</tr>
<tr>
<td>Compaction</td>
<td>Merge</td>
</tr>
</tbody>
</table>
</div>
<p>　写入的数据都会先存放在 Buffer 中，以保证写入的效率。之后，每隔一段时间（默认 5s，最小 100ms），ElasticSearch 会批量将 Buffer 中的数据，Sync 到磁盘上的 Segment 中。此时，Segment 处于打开状态，可以被查询检索到。而为了确保数据不会丢失，ElasticSearch 会将每一个事务操作都记录到 Translog 中。每次 Sync 操作只会清空 Buffer 中的数据，并不会清空 Translog 中的事务日志。只有写入一段时间后，进行全量 Sync 操作的时候，才会将 Translog 清空（默认是 Translog 达到 512M 或者 12 小时之后）</p>
<p><img data-src="/picture/es/es_write_3.png" alt="ElasticSearch Flush"></p>
<center>（图片来源：<a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/merge-process.html" target="_blank" rel="external nofollow noopener noreferrer">ElasticSearch</a>™ 官方文档）</center>



<h4 id="数据查询"><a href="#数据查询" class="headerlink" title="数据查询"></a>数据查询</h4><h5 id="流程-3"><a href="#流程-3" class="headerlink" title="流程"></a>流程</h5><p>　和数据写入不同的是，数据查询是可以在主分片或者其任意副本分片上，完成文档检索的。同时，为了保证负载均衡，每次请求的时候，还会轮询地去查询副本分片</p>
<p><img data-src="/picture/es/es_read.png" alt="ElasticSearch Read"></p>
<center>（图片来源：<a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/distrib-read.html" target="_blank" rel="external nofollow noopener noreferrer">ElasticSearch</a>™ 官方文档）</center>

<p>　这里我们仍然以单 Index、两 Shard、三 Replication、三 Node 的 ElasticSearch 集群为例</p>
<ol>
<li>客户端向 <code>NODE 1</code> 发送查询请求</li>
<li>节点使用 Document 的 <code>_id</code> 来确定 Document 属于 Shard <code>0</code>。而所有节点上都存在着 Shard <code>0</code> 的副本分片。这种情况下，它将请求转发到 <code>NODE 2</code> </li>
<li><code>NODE 2</code> 将文档返回给 <code>NODE 1</code>，然后将文档返回给客户端</li>
</ol>
<div class="note info">可以通过 index.queries.cache.enabled 参数，来控制是否对查询结果进行缓存，默认是开启的</div>




<h4 id="段合并"><a href="#段合并" class="headerlink" title="段合并"></a>段合并</h4><h5 id="流程-4"><a href="#流程-4" class="headerlink" title="流程"></a>流程</h5><p>　为了避免 Segment 小文件过多，ElasticSearch 会定时进行 Segment 合并操作。因为段合并需要消耗大量的磁盘 IO 和 CPU，所以为了不影响正常的集群运行，ElasticSearch 会进行严格的限流，默认 20MB/s</p>
<p><img data-src="/picture/es/es_segment_merge_before.png" alt="Before ElasticSearch Segment Merge"></p>
<p><img data-src="/picture/es/es_segment_merge_after.png" alt="After ElasticSearch Segment Merge"></p>
<center>（图片来源：<a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/merge-process.html" target="_blank" rel="external nofollow noopener noreferrer">ElasticSearch</a>™ 官方文档）</center>



<h4 id="熔断器"><a href="#熔断器" class="headerlink" title="熔断器"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/circuit-breaker.html">熔断器</a></h4><h5 id="功能-11"><a href="#功能-11" class="headerlink" title="功能"></a>功能</h5><p>　熔断器（Circuit Breaker）用于防止 OOM 异常，以增强集群稳定性。更多介绍，详见上文 “使用技巧 - 熔断机制” 小节</p>
<h5 id="配置-3"><a href="#配置-3" class="headerlink" title="配置"></a>配置</h5><h6 id="Parent-Circuit-Breaker"><a href="#Parent-Circuit-Breaker" class="headerlink" title="Parent Circuit Breaker"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/circuit-breaker.html#parent-circuit-breaker">Parent Circuit Breaker</a></h6><ul>
<li><p>indices.breaker.total.use_real_memory</p>
<p>是否通过 <code>ManagementFactory.getMemoryMXBean().getHeapMemoryUsage().getUsed()</code> 的方式获取更加精准的内存使用指标，默认值为 <code>true</code></p>
</li>
<li><p>indices.breaker.total.limit</p>
<p>父熔断器限制内存使用的比例，默认值为 <code>70%</code>（上一个参数 <code>use_real_memory</code> 为 <code>false</code>） 或 <code>95%</code>（反之为 <code>true</code>）</p>
</li>
</ul>
<h6 id="Field-Data-Circuit-Breaker"><a href="#Field-Data-Circuit-Breaker" class="headerlink" title="Field Data Circuit Breaker"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/circuit-breaker.html#fielddata-circuit-breaker">Field Data Circuit Breaker</a></h6><ul>
<li><p>indices.breaker.fielddata.limit</p>
<p>字段数据熔断器，限制内存中加载的 Field 只能占到总内存的比例，默认值为 <code>40%</code></p>
</li>
<li><p>indices.breaker.fielddata.overhead</p>
<p>用来和字段数据估计值相乘的常数，默认值为 <code>1.03</code></p>
</li>
</ul>
<h6 id="Request-Circuit-Breaker"><a href="#Request-Circuit-Breaker" class="headerlink" title="Request Circuit Breaker"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/circuit-breaker.html#request-circuit-breaker">Request Circuit Breaker</a></h6><ul>
<li><p>indices.breaker.request.limit</p>
<p>请求熔断器，主要限制的是请求在执行过程中的可能会消耗的内存（例如，用于在请求期间计算聚合的内存），默认值为 <code>60%</code></p>
</li>
<li><p>indices.breaker.request.overhead</p>
<p>用来和请求内存消耗的估计值相乘的常数，默认值为 <code>1</code></p>
</li>
</ul>
<h6 id="In-Flight-Requests-Circuit-Breaker"><a href="#In-Flight-Requests-Circuit-Breaker" class="headerlink" title="In Flight Requests Circuit Breaker"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/circuit-breaker.html#in-flight-circuit-breaker">In Flight Requests Circuit Breaker</a></h6><ul>
<li><p>network.breaker.inflight_requests.limit</p>
<p>飞行中请求熔断器，则是作用于尚未开始执行的请求，主要限制的是，请求本身的内容长度，会在 HTTP 层面上对所有当前活跃的传入请求的内存大小进行限制，默认值为 <code>100%</code>（这意味着可能会在父熔断器允许的范围内将内存耗尽）</p>
</li>
<li><p>network.breaker.inflight_requests.overhead</p>
<p>用来和飞行中请求内存消耗的估计值相乘的常数，默认值为 <code>2</code></p>
</li>
</ul>
<h6 id="Accounting-Requests-Circuit-Breaker"><a href="#Accounting-Requests-Circuit-Breaker" class="headerlink" title="Accounting Requests Circuit Breaker"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/circuit-breaker.html#accounting-circuit-breaker">Accounting Requests Circuit Breaker</a></h6><ul>
<li><p>indices.breaker.accounting.limit</p>
<p>计费熔断器，限制的是请求完成时，未被释放的内容的内存大小（例如，Lucene 段内存等），默认值为 <code>100%</code>（这意味着可能会在父熔断器允许的范围内将内存耗尽）</p>
</li>
<li><p>indices.breaker.accounting.overhead</p>
<p>用来和计费熔断器的估计值相乘的常数，默认值为 <code>1</code></p>
</li>
</ul>
<h6 id="Script-Compilation-Circuit-Breaker"><a href="#Script-Compilation-Circuit-Breaker" class="headerlink" title="Script Compilation Circuit Breaker"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/circuit-breaker.html#script-compilation-circuit-breaker">Script Compilation Circuit Breaker</a></h6><ul>
<li><p>script.max_compilations_rate</p>
<p>脚本编译熔断器，限制的是一段时间内的内联脚本编译次数，默认值为 <code>75/5m</code></p>
</li>
</ul>
<h5 id="主体-6"><a href="#主体-6" class="headerlink" title="主体"></a>主体</h5><ul>
<li><p>org.elasticsearch.common.breaker.<strong>CircuitBreaker</strong></p>
<p>最上层的接口，定义了除脚本编译熔断器（ScriptService）之外的所有内置的 Breaker：</p>
<ul>
<li><code>PARENT</code></li>
<li><code>FIELDDATA</code></li>
<li><code>REQUEST</code></li>
<li><code>IN_FLIGHT_REQUESTS</code></li>
<li><code>ACCOUNTING</code></li>
</ul>
<p>和相应的类型：</p>
<ul>
<li><p><code>MEMORY</code></p>
<p>子熔断器</p>
</li>
<li><p><code>PARENT</code></p>
<p>父熔断器</p>
</li>
<li><p><code>NOOP</code></p>
<p>不会触发任何熔断行为的熔断器</p>
</li>
</ul>
<p>以及 Breaker 相关的行为：</p>
<ul>
<li><code>addEstimateBytesAndMaybeBreak</code></li>
<li><code>addWithoutBreaking</code></li>
<li><code>getUsed</code></li>
<li><code>getLimit</code></li>
<li><code>getOverhead</code></li>
<li><code>getTrippedCount</code></li>
<li><code>getName</code></li>
<li><code>getDurability</code></li>
</ul>
</li>
<li><p>org.elasticsearch.common.breaker.<strong>ChildMemoryCircuitBreaker</strong></p>
</li>
<li><p>org.elasticsearch.indices.breaker.<strong>HierarchyCircuitBreakerService</strong></p>
<ul>
<li><p><code>#breakers</code></p>
<p>记录所有的 Breaker，即 <code>&lt;熔断器名称，CircuitBreaker 实例&gt;</code></p>
</li>
<li><p><code>checkParentLimit</code></p>
<p>检查父熔断器是否已跳闸</p>
</li>
<li><p><code>registerBreaker</code></p>
<p>注册熔断器（支持注册自定义的熔断器，如果自定义的熔断器名称和已存在的熔断器的名称相同，将会覆盖掉已存在的熔断器）</p>
</li>
</ul>
</li>
<li><p>org.elasticsearch.indices.breaker.<strong>BreakerSettings</strong></p>
<ul>
<li><p><code>#name</code></p>
<p>熔断器的名称</p>
</li>
<li><p><code>#limitBytes</code></p>
<p>阀值</p>
</li>
<li><p><code>#overhead</code></p>
<p>计算内存消耗时的因子</p>
</li>
<li><p><code>#type</code></p>
<p>熔断器的类型</p>
</li>
</ul>
</li>
</ul>
<h4 id="Rollup-1"><a href="#Rollup-1" class="headerlink" title="Rollup"></a>Rollup</h4><h5 id="主体-7"><a href="#主体-7" class="headerlink" title="主体"></a>主体</h5><ul>
<li>org.elasticsearch.xpack.rollup.<strong>Rollup</strong></li>
<li>org.elasticsearch.xpack.rollup.job.<strong>RollupJobTask</strong></li>
<li>org.elasticsearch.xpack.rollup.job.RollupJobTask.<strong>RollupJobPersistentTasksExecutor</strong></li>
</ul>
<h5 id="时序图"><a href="#时序图" class="headerlink" title="时序图"></a>时序图</h5><pre class="mermaid">sequenceDiagram

participant User

participant TransportPutRollupJobAction
participant RollupJob
participant PersistentTasksService
participant ElasticsearchClient
participant AbstractClient
participant OriginSettingClient
participant ActionListener

User -&gt;&gt;+ TransportPutRollupJobAction : masterOperation
TransportPutRollupJobAction -&gt;&gt; TransportPutRollupJobAction : createRollupJob
TransportPutRollupJobAction -&gt;&gt;+ RollupJob : &lt;&lt; new &gt;&gt;
RollupJob --&gt;&gt;- TransportPutRollupJobAction : Instance
TransportPutRollupJobAction -&gt;&gt; TransportPutRollupJobAction : createIndex
TransportPutRollupJobAction -&gt;&gt;+ TransportPutRollupJobAction : startPersistentTask
TransportPutRollupJobAction -&gt;&gt; PersistentTasksService : sendStartRequest
PersistentTasksService -&gt;&gt;+ PersistentTasksService : execute
PersistentTasksService -&gt;&gt;+ ElasticsearchClient : execute
ElasticsearchClient -&gt;&gt;+ AbstractClient : doExecute
AbstractClient -&gt;&gt;+ OriginSettingClient : doExecute
OriginSettingClient --&gt;&gt;- AbstractClient : done
AbstractClient --&gt;&gt;- ElasticsearchClient : done
ElasticsearchClient --&gt;&gt;- PersistentTasksService : done
PersistentTasksService -&gt;&gt; PersistentTasksService : waitForPersistentTaskCondition
PersistentTasksService -&gt;&gt;+ ActionListener : onResponse | onFailure | onTimeout
ActionListener --&gt;&gt;- PersistentTasksService : done
PersistentTasksService --&gt;&gt;- TransportPutRollupJobAction : done
TransportPutRollupJobAction --&gt;&gt;- User : done</pre>







<h2 id="踩过的坑"><a href="#踩过的坑" class="headerlink" title="踩过的坑"></a>踩过的坑</h2><h3 id="Unknown-Analyzer-type-org-ElasticSearch-index-analysis-IkAnalyzerProvider-for-ik"><a href="#Unknown-Analyzer-type-org-ElasticSearch-index-analysis-IkAnalyzerProvider-for-ik" class="headerlink" title="Unknown Analyzer type [org.ElasticSearch.index.analysis.IkAnalyzerProvider] for [ik]"></a>Unknown Analyzer type [org.ElasticSearch.index.analysis.IkAnalyzerProvider] for [ik]</h3><p>　属于配置的问题，需注意 ElasticSearch 和 IK 中文分词插件的版本，不同的版本中支持的配置项也会不一样</p>
<h3 id="The-number-of-object-passed-must-be-even-but-was-1"><a href="#The-number-of-object-passed-must-be-even-but-was-1" class="headerlink" title="The number of object passed must be even but was [1]"></a>The number of object passed must be even but was [1]</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 建议不使用 JSON.toJSONString，而是自己在 POJO 中拼装 Map&lt;String, Object&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">toJSON</span><span class="params">()</span> </span>{</span><br><span class="line">  HashMap&lt;String, Object&gt; json = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">  json.put(<span class="string">"systemName"</span>, systemName);</span><br><span class="line">  json.put(<span class="string">"ip"</span>, ip);</span><br><span class="line">  json.put(<span class="string">"path"</span>, path);</span><br><span class="line">  json.put(<span class="string">"time"</span>, time);</span><br><span class="line">  json.put(<span class="string">"message"</span>, message);</span><br><span class="line">  <span class="keyword">return</span> json;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">(ElasticsearchSinkFunction&lt;HBaseServerLog&gt;) (element, ctx, indexer) -&gt; {</span><br><span class="line">  _log.debug(<span class="string">"Message: {} in ES Sink"</span>, element);</span><br><span class="line">  <span class="keyword">if</span> (element == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line">  indexer.add(indexRequest()</span><br><span class="line">         .index(HBASE_SERVER_LOG_INDEX_NAME)</span><br><span class="line">         .type(HBASE_SERVER_LOG_TYPE_NAME)</span><br><span class="line">         .source(element.toJSON()));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="blocked-by-FORBIDDEN-12-index-read-only-allow-delete-api"><a href="#blocked-by-FORBIDDEN-12-index-read-only-allow-delete-api" class="headerlink" title="blocked by: [FORBIDDEN/12/index read-only / allow delete (api)]"></a>blocked by: [FORBIDDEN/12/index read-only / allow delete (api)]</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUT _settings</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"index"</span>: {</span><br><span class="line">    <span class="attr">"blocks"</span>: {</span><br><span class="line">      <span class="attr">"read_only_allow_delete"</span>: <span class="string">"false"</span></span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<div class="note success">从 ElasticSearch 7.4.0 版本开始，支持在磁盘水位下降后，自动释放索引的 read-only 锁</div>



<h3 id="Docker-中无法开启-bootstrap-memory-lock-参数"><a href="#Docker-中无法开启-bootstrap-memory-lock-参数" class="headerlink" title="Docker 中无法开启 bootstrap.memory_lock 参数"></a>Docker 中无法开启 bootstrap.memory_lock 参数</h3><p>　非容器环境下，在 limits.conf 文件中增加 memlock 相关的配置即可（这里了的 admin 是 ElasticSearch 运行的用户，可以根据实际情况更换）</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ su -</span><br><span class="line">$ vim /etc/security/limits.conf</span><br><span class="line">  admin soft memlock unlimited</span><br><span class="line">  admin hard memlock unlimited</span><br></pre></td></tr></tbody></table></figure>
<p>　容器环境下，则需要用如下方式进行修改：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ grep locked /proc/$(ps --no-headers -o pid -C dockerd | tr -d <span class="string">' '</span>)/limits</span><br><span class="line">  Max locked memory         65536                65536                bytes</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> -e <span class="string">"[Service]\nLimitMEMLOCK=infinity"</span> | SYSTEMD_EDITOR=tee systemctl edit docker.service</span><br><span class="line">  [Service]</span><br><span class="line">  LimitMEMLOCK=infinity</span><br><span class="line"></span><br><span class="line">$ systemctl daemon-reload</span><br><span class="line">$ systemctl restart docker</span><br><span class="line"></span><br><span class="line">$ grep locked /proc/$(ps --no-headers -o pid -C dockerd | tr -d <span class="string">' '</span>)/limits</span><br><span class="line">  Max locked memory         unlimited            unlimited            bytes</span><br></pre></td></tr></tbody></table></figure>
<h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><h3 id="Doc"><a href="#Doc" class="headerlink" title="Doc"></a>Doc</h3><h4 id="Lucene-2"><a href="#Lucene-2" class="headerlink" title="Lucene"></a>Lucene</h4><ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://lucene.apache.org/core/8_6_2/changes/Changes.html">Lucene 8.6.2 Release Notes</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="http://lucene.apache.org/core/8_6_2/demo/overview-summary.html">Lucene 8.6.2 demo API</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/apache/lucene-solr/blob/master/README.md#building-lucenesolr">Building Lucene</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://lucene.apache.org/solr/guide/6_6/docvalues.html">Lucene: DocValues</a></li>
</ul>
<h4 id="ElasticSearch-2"><a href="#ElasticSearch-2" class="headerlink" title="ElasticSearch"></a>ElasticSearch</h4><ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/products/elasticsearch/features">Elasticsearch features</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/index.html">Elasticsearch Reference</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/sql-limitations.html">SQL Limitations</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/breaking-changes-7.0.html">Breaking changes in 7.0</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-types.html">Field datatypes</a></li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">主分类</th>
<th style="text-align:center">子分类</th>
<th style="text-align:center">字段类型</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">核心类型</td>
<td style="text-align:center">字符串类型</td>
<td style="text-align:center">text / keyword</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">整数类型</td>
<td style="text-align:center">long /integer / short / byte</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">浮点类型</td>
<td style="text-align:center">double / float / half_float / scaled_float</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">逻辑类型</td>
<td style="text-align:center">boolean</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">日期类型</td>
<td style="text-align:center">date</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">范围类型</td>
<td style="text-align:center">integer_range / float_range / long_range / double_range / date_range</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">二进制类型</td>
<td style="text-align:center">binary</td>
</tr>
<tr>
<td style="text-align:center">复合类型</td>
<td style="text-align:center">对象类型</td>
<td style="text-align:center">object</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">嵌套类型</td>
<td style="text-align:center">nested</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">数组类型</td>
<td style="text-align:center">不存在数组类型，所有的字段都有存储多个相同类型的字段值</td>
</tr>
<tr>
<td style="text-align:center">地理类型</td>
<td style="text-align:center">地理坐标类型</td>
<td style="text-align:center">geo_point</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">地理地图</td>
<td style="text-align:center">geo_shape</td>
</tr>
<tr>
<td style="text-align:center">特殊类型</td>
<td style="text-align:center">IP 类型</td>
<td style="text-align:center">ip</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">范围类型</td>
<td style="text-align:center">completion</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">令牌计数类型</td>
<td style="text-align:center">token_count</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">存储索引的 Hash 值类型</td>
<td style="text-align:center">murmur3</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">抽取类型</td>
<td style="text-align:center">percolator</td>
</tr>
</tbody>
</table>
</div>
<ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/doc-values.html">ElasticSearch: doc_values</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/rollup-apis.html">Rollup APIs</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/rollup-agg-limitations.html">Rollup aggregation limitations</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/xpack-rollup.html">Rolling up historical data</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/master/tune-for-indexing-speed.html">Tune for indexing speed</a></li>
</ul>
<h3 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h3><ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/apache/lucene-solr">Lucene</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/opendistro-for-elasticsearch/security">Open Distro for Elasticsearch Security</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/elastic/elasticsearch-formal-models">Formal models of core Elasticsearch algorithms</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/elastic/elasticsearch/pull/46169">Fix G1 GC default IHOP</a></li>
</ul>
<h3 id="Paper"><a href="#Paper" class="headerlink" title="Paper"></a>Paper</h3><ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://cs.nyu.edu/~mohri/pub/fla.pdf">Weighted Finite-State Transducer Algorithms</a></li>
</ul>
<h3 id="Book"><a href="#Book" class="headerlink" title="Book"></a>Book</h3><ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.amazon.com/Mastering-ElasticSearch-Rafal-Kuc/dp/178328143X">Mastering ElasticSearch</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.amazon.com/Monitoring-ElasticSearch-Dan-Noble/dp/1784397806">Monitoring ElasticSearch</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.amazon.com/ElasticSearch-Cookbook-Second-Alberto-Paro/dp/1783554835">ElasticSearch Cookbook, 2nd Edition</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.amazon.com/Elasticsearch-Action-Radu-Gheorghe/dp/1617291625">Elasticsearch in Action</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.amazon.com/ElasticSearch-Indexing-Huseyin-Akdogan/dp/1783987022">Elasticsearch Indexing</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.amazon.com/ElasticSearch-Server-Second-Rafal-Kuc/dp/1783980524">Elasticsearch Server, 2nd Edition</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.amazon.com/Elasticsearch-Definitive-Distributed-Real-Time-Analytics/dp/1449358543">Elasticsearch：The Definitive Guide</a></li>
</ul>
<h3 id="Tool"><a href="#Tool" class="headerlink" title="Tool"></a>Tool</h3><ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://home.apache.org/~mikemccand/geobench.html">Lucene Geo benchmarks</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://elasticsearch-benchmarks.elastic.co/">ElasticSearch Benchmark</a></li>
</ul>
<h2 id="欢迎加入我们的技术群，一起交流学习"><a href="#欢迎加入我们的技术群，一起交流学习" class="headerlink" title="欢迎加入我们的技术群，一起交流学习"></a><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/asdf2014/yuzhouwan#technical-discussion-group">欢迎加入我们的技术群，一起交流学习</a></h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">群名称</th>
<th style="text-align:center">群号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">人工智能（高级）</td>
<td style="text-align:center"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://shang.qq.com/wpa/qunwpa?idkey=71c6bd3fb0ff01d93abca654140387d99d3be752f92a53c1fbfd27f2dd4b4247"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1020982-blue.svg" alt></a></td>
</tr>
<tr>
<td style="text-align:center">人工智能（进阶）</td>
<td style="text-align:center"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://shang.qq.com/wpa/qunwpa?idkey=deb268f65589a1a0a1dbaf7b72c849ed45298697805bef81e0c613dea40cd05e"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1217710-blue.svg" alt></a></td>
</tr>
<tr>
<td style="text-align:center">BigData</td>
<td style="text-align:center"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://shang.qq.com/wpa/qunwpa?idkey=f86b3c8de20da1658a3bb42df17a2fc4eee0d75c4a130a63585fdd257e3565ed"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-1670647-blue.svg" alt></a></td>
</tr>
<tr>
<td style="text-align:center">算法</td>
<td style="text-align:center"><a target="_blank" rel="external nofollow noopener noreferrer" href="https://shang.qq.com/wpa/qunwpa?idkey=bfbcf1453371a0810fd6be235ace47147f6fb9d262fb768b497c861f50af0af4"><img data-src="https://img.shields.io/badge/QQ%E7%BE%A4-5366753-blue.svg" alt></a></td>
</tr>
</tbody>
</table>
</div>

    </div>

    
    
    
      
  <div class="popular-posts-header">相关文章</div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/5845/" rel="bookmark">Apache Druid：一款高效的 OLAP 引擎</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/200926/" rel="bookmark">Helm 实战</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/200315/" rel="bookmark">开源时序数据库 InfluxDB</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/19631/" rel="bookmark">如何成为 Apache 的 PMC</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/posts/200919/" rel="bookmark">Kubernetes 实战</a></div>
    </li>
  </ul>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Benedict Jin
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://yuzhouwan.com/posts/22654/" title="搜索引擎 ElasticSearch">https://yuzhouwan.com/posts/22654/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-ND</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

        

  <div class="followme">
    <p>欢迎关注我的其它发布渠道</p>

    <div class="social-list">

        <div class="social-item">
          <a target="_blank" class="social-link" href="/wechat_channel.jpg">
            <span class="icon">
              <i class="fab fa-weixin"></i>
            </span>

            <span class="label">WeChat</span>
          </a>
        </div>

        <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
        </div>
    </div>
  </div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Kubernetes/" rel="tag"># Kubernetes</a>
              <a href="/tags/Java/" rel="tag"># Java</a>
              <a href="/tags/Helm/" rel="tag"># Helm</a>
              <a href="/tags/ElasticSearch/" rel="tag"># ElasticSearch</a>
              <a href="/tags/Lucene/" rel="tag"># Lucene</a>
              <a href="/tags/Kafka/" rel="tag"># Kafka</a>
              <a href="/tags/Flume/" rel="tag"># Flume</a>
              <a href="/tags/HBase/" rel="tag"># HBase</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/posts/5845/" rel="prev" title="Apache Druid：一款高效的 OLAP 引擎">
      <i class="fa fa-chevron-left"></i> Apache Druid：一款高效的 OLAP 引擎
    </a></div>
      <div class="post-nav-item">
    <a href="/posts/19631/" rel="next" title="如何成为 Apache 的 PMC">
      如何成为 Apache 的 PMC <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
      <div class="tabs tabs-comment">
        <ul class="nav-tabs">
            <li class="tab"><a href="#comment-gitalk">Gitalk：可用 Github 账号登录</a></li>
            <li class="tab"><a href="#comment-disqus">Disqus：海外</a></li>
            <li class="tab"><a href="#comment-valine">Valine：匿名</a></li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane gitalk" id="comment-gitalk">
              <div class="comments" id="gitalk-container"></div>
            </div>
            <div class="tab-pane disqus" id="comment-disqus">
              
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  
            </div>
            <div class="tab-pane valine" id="comment-valine">
              <div class="comments" id="valine-comments"></div>
            </div>
        </div>
      </div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#ElasticSearch-%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="nav-number">1.</span> <span class="nav-text">ElasticSearch 是什么？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%89%B9%E6%80%A7"><span class="nav-number">2.</span> <span class="nav-text">特性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BB%E8%A6%81%E6%A6%82%E5%BF%B5"><span class="nav-number">3.</span> <span class="nav-text">主要概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Cluster-%E9%9B%86%E7%BE%A4"><span class="nav-number">3.1.</span> <span class="nav-text">Cluster 集群</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Node-%E8%8A%82%E7%82%B9"><span class="nav-number">3.2.</span> <span class="nav-text">Node 节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Index-%E7%B4%A2%E5%BC%95"><span class="nav-number">3.3.</span> <span class="nav-text">Index 索引</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Shard-%E5%88%86%E7%89%87"><span class="nav-number">3.4.</span> <span class="nav-text">Shard 分片</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Replica-%E5%89%AF%E6%9C%AC"><span class="nav-number">3.5.</span> <span class="nav-text">Replica 副本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Recovery-%E6%95%85%E9%9A%9C%E6%81%A2%E5%A4%8D"><span class="nav-number">3.6.</span> <span class="nav-text">Recovery 故障恢复</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#River-%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="nav-number">3.7.</span> <span class="nav-text">River 数据源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Gateway-%E6%97%B6%E7%A9%BA%E9%97%A8"><span class="nav-number">3.8.</span> <span class="nav-text">Gateway 时空门</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#discovery-zen-%E8%8A%82%E7%82%B9%E5%8F%91%E7%8E%B0"><span class="nav-number">3.9.</span> <span class="nav-text">discovery.zen 节点发现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Transport-%E9%80%9A%E8%AE%AF%E6%9C%BA%E5%88%B6"><span class="nav-number">3.10.</span> <span class="nav-text">Transport 通讯机制</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="nav-number">4.</span> <span class="nav-text">架构图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2"><span class="nav-number">5.</span> <span class="nav-text">环境部署</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%95%E6%9C%BA%E7%89%88"><span class="nav-number">5.1.</span> <span class="nav-text">单机版</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD"><span class="nav-number">5.1.1.</span> <span class="nav-text">下载</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E5%8E%8B"><span class="nav-number">5.1.2.</span> <span class="nav-text">解压</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="nav-number">5.1.3.</span> <span class="nav-text">环境变量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8"><span class="nav-number">5.1.4.</span> <span class="nav-text">启动</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A0%A1%E9%AA%8C"><span class="nav-number">5.1.5.</span> <span class="nav-text">校验</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%AF%E8%A7%86%E5%8C%96"><span class="nav-number">5.1.6.</span> <span class="nav-text">可视化</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%9C%AC%E5%9C%B0-Kibana"><span class="nav-number">5.1.6.1.</span> <span class="nav-text">本地 Kibana</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Kubernetes-%E7%89%88"><span class="nav-number">5.2.</span> <span class="nav-text">Kubernetes 版</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-Helm-Charts"><span class="nav-number">5.2.1.</span> <span class="nav-text">安装 Helm Charts</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A0%A1%E9%AA%8C-1"><span class="nav-number">5.2.2.</span> <span class="nav-text">校验</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91"><span class="nav-number">5.2.3.</span> <span class="nav-text">端口转发</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%AF%E8%A7%86%E5%8C%96-1"><span class="nav-number">5.2.4.</span> <span class="nav-text">可视化</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Kibana-on-Kubernetes"><span class="nav-number">5.2.4.1.</span> <span class="nav-text">Kibana on Kubernetes</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E7%94%A8%E6%8A%80%E5%B7%A7"><span class="nav-number">6.</span> <span class="nav-text">实用技巧</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE"><span class="nav-number">6.1.</span> <span class="nav-text">写入数据</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA-Document"><span class="nav-number">6.1.1.</span> <span class="nav-text">创建 Document</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8C%87%E5%AE%9A-Document-ID"><span class="nav-number">6.1.2.</span> <span class="nav-text">指定 Document ID</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE"><span class="nav-number">6.2.</span> <span class="nav-text">查询数据</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8C%B9%E9%85%8D%E6%89%80%E6%9C%89%E7%B4%A2%E5%BC%95"><span class="nav-number">6.2.1.</span> <span class="nav-text">匹配所有索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8C%87%E5%AE%9A%E7%B4%A2%E5%BC%95"><span class="nav-number">6.2.2.</span> <span class="nav-text">指定索引</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%8C%87%E5%AE%9A%E6%9F%90%E4%B8%80%E4%B8%AA%E7%B4%A2%E5%BC%95"><span class="nav-number">6.2.2.1.</span> <span class="nav-text">指定某一个索引</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%8C%87%E5%AE%9A%E5%A4%9A%E4%B8%AA%E7%B4%A2%E5%BC%95"><span class="nav-number">6.2.2.2.</span> <span class="nav-text">指定多个索引</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%80%9A%E9%85%8D%E7%AC%A6%E5%8C%B9%E9%85%8D%E5%A4%9A%E4%B8%AA%E7%B4%A2%E5%BC%95"><span class="nav-number">6.2.2.3.</span> <span class="nav-text">通配符匹配多个索引</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8E%A7%E5%88%B6%E5%B1%95%E7%A4%BA%E6%95%B0%E9%87%8F"><span class="nav-number">6.2.3.</span> <span class="nav-text">控制展示数量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8C%87%E5%AE%9A%E8%BF%94%E5%9B%9E%E5%AD%97%E6%AE%B5"><span class="nav-number">6.2.4.</span> <span class="nav-text">指定返回字段</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8C%83%E5%9B%B4%E6%9F%A5%E8%AF%A2"><span class="nav-number">6.2.5.</span> <span class="nav-text">范围查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%81%9A%E5%90%88%E6%9F%A5%E8%AF%A2"><span class="nav-number">6.2.6.</span> <span class="nav-text">聚合查询</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Group-Count"><span class="nav-number">6.2.6.1.</span> <span class="nav-text">Group Count</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4%E6%9F%A5%E8%AF%A2"><span class="nav-number">6.2.7.</span> <span class="nav-text">过滤查询</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%95%B0%E7%BB%84%E9%95%BF%E5%BA%A6"><span class="nav-number">6.2.7.1.</span> <span class="nav-text">数组长度</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AE"><span class="nav-number">6.3.</span> <span class="nav-text">删除数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B8%85%E7%90%86%E7%BC%93%E5%AD%98"><span class="nav-number">6.4.</span> <span class="nav-text">清理缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95"><span class="nav-number">6.5.</span> <span class="nav-text">索引</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E7%B4%A2%E5%BC%95"><span class="nav-number">6.5.1.</span> <span class="nav-text">获取索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96-Mapping"><span class="nav-number">6.5.2.</span> <span class="nav-text">获取 Mapping</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0-Mapping"><span class="nav-number">6.5.3.</span> <span class="nav-text">更新 Mapping</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%87%AA%E5%8A%A8%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95"><span class="nav-number">6.5.4.</span> <span class="nav-text">自动创建索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TimeZone"><span class="nav-number">6.5.5.</span> <span class="nav-text">TimeZone</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Hot-warm"><span class="nav-number">6.5.6.</span> <span class="nav-text">Hot-warm</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%88%E5%B9%B6%E7%B4%A2%E5%BC%95"><span class="nav-number">6.5.7.</span> <span class="nav-text">合并索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%88%E5%B9%B6-Segment"><span class="nav-number">6.5.8.</span> <span class="nav-text">合并 Segment</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Shrink"><span class="nav-number">6.5.9.</span> <span class="nav-text">Shrink</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BB%8B%E7%BB%8D"><span class="nav-number">6.5.9.1.</span> <span class="nav-text">介绍</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8"><span class="nav-number">6.5.9.2.</span> <span class="nav-text">使用</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Rollup"><span class="nav-number">6.5.10.</span> <span class="nav-text">Rollup</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BB%8B%E7%BB%8D-1"><span class="nav-number">6.5.10.1.</span> <span class="nav-text">介绍</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-1"><span class="nav-number">6.5.10.2.</span> <span class="nav-text">使用</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C"><span class="nav-number">6.5.10.2.1.</span> <span class="nav-text">命令行</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Kibana"><span class="nav-number">6.5.10.2.2.</span> <span class="nav-text">Kibana</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%B1%80%E9%99%90%E6%80%A7"><span class="nav-number">6.5.10.3.</span> <span class="nav-text">局限性</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A8%A1%E6%9D%BF"><span class="nav-number">6.6.</span> <span class="nav-text">模板</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E6%A8%A1%E6%9D%BF"><span class="nav-number">6.6.1.</span> <span class="nav-text">创建模板</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E6%A8%A1%E6%9D%BF"><span class="nav-number">6.6.2.</span> <span class="nav-text">获取模板</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E6%A8%A1%E6%9D%BF"><span class="nav-number">6.6.3.</span> <span class="nav-text">删除模板</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8F%92%E4%BB%B6"><span class="nav-number">6.7.</span> <span class="nav-text">插件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81"><span class="nav-number">6.8.</span> <span class="nav-text">集群状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%86%94%E6%96%AD%E6%9C%BA%E5%88%B6"><span class="nav-number">6.9.</span> <span class="nav-text">熔断机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E%E7%A3%81%E7%9B%98%E5%AE%B9%E9%87%8F%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-number">6.10.</span> <span class="nav-text">基于磁盘容量的负载均衡</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B4%E5%90%88%E5%85%B6%E4%BB%96%E6%A1%86%E6%9E%B6"><span class="nav-number">7.</span> <span class="nav-text">整合其他框架</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ElasticSearch-Kafka-%E6%95%B4%E5%90%88"><span class="nav-number">7.1.</span> <span class="nav-text">ElasticSearch + Kafka 整合</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ElasticSearch-Flume-%E6%95%B4%E5%90%88"><span class="nav-number">7.2.</span> <span class="nav-text">ElasticSearch + Flume 整合</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ElasticSearch-IK-%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D"><span class="nav-number">7.3.</span> <span class="nav-text">ElasticSearch + IK 中文分词</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E8%A3%85"><span class="nav-number">7.3.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D%E5%99%A8%E6%AF%94%E5%AF%B9%E8%A1%A8"><span class="nav-number">7.3.2.</span> <span class="nav-text">中文分词器比对表</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95"><span class="nav-number">8.</span> <span class="nav-text">技术内幕</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ElasticSearch-%E5%92%8C-Lucene-%E7%9A%84%E6%9C%AC%E8%B4%A8%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%8C%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%80%89%E5%9E%8B-ElasticSearch%EF%BC%9F"><span class="nav-number">8.1.</span> <span class="nav-text">ElasticSearch 和 Lucene 的本质是什么，为什么会选型 ElasticSearch？</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%AC%E8%B4%A8"><span class="nav-number">8.1.1.</span> <span class="nav-text">本质</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8C%BA%E5%88%AB"><span class="nav-number">8.1.2.</span> <span class="nav-text">区别</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Lucene"><span class="nav-number">8.1.2.1.</span> <span class="nav-text">Lucene</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ElasticSearch"><span class="nav-number">8.1.2.2.</span> <span class="nav-text">ElasticSearch</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%9B%E4%B8%80%E6%AD%A5%E6%80%9D%E8%80%83"><span class="nav-number">8.1.3.</span> <span class="nav-text">进一步思考</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Solr%E3%80%81Lucene-%E4%BD%9C%E4%B8%BA%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2%E7%B3%BB%E7%BB%9F%EF%BC%8C%E5%92%8C-ElasticSearch-%E8%BF%99%E7%A7%8D%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E%E5%8F%88%E6%9C%89%E4%BB%80%E4%B9%88%E6%9C%AC%E8%B4%A8%E7%9A%84%E5%8C%BA%E5%88%AB%EF%BC%9F"><span class="nav-number">8.1.3.1.</span> <span class="nav-text">Solr、Lucene 作为全文检索系统，和 ElasticSearch 这种搜索引擎又有什么本质的区别？</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88-ElasticSearch-%E9%9B%86%E7%BE%A4%E4%BD%BF%E7%94%A8-Hash-%E8%B7%AF%E7%94%B1%EF%BC%8C%E8%80%8C%E4%B8%8D%E6%98%AF-Paxos%EF%BC%8C%E8%BF%99%E4%B8%A4%E4%B8%AA%E7%AE%97%E6%B3%95%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB%EF%BC%8C%E5%90%84%E8%87%AA%E6%9C%80%E9%80%82%E7%9A%84%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF%E5%9C%A8%E5%93%AA%E9%87%8C%EF%BC%9F"><span class="nav-number">8.2.</span> <span class="nav-text">为什么 ElasticSearch 集群使用 Hash 路由，而不是 Paxos，这两个算法有什么区别，各自最适的应用场景在哪里？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ElasticSearch-%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95%E7%9A%84%E5%8E%9F%E7%90%86"><span class="nav-number">8.3.</span> <span class="nav-text">ElasticSearch 倒排索引的原理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9B%BE%E8%A7%A3"><span class="nav-number">8.3.1.</span> <span class="nav-text">图解</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Lucene-4-%E5%AE%9E%E7%8E%B0%E7%9A%84-DocValues-%E7%89%B9%E6%80%A7%EF%BC%8C%E4%B8%BA%E4%BB%80%E4%B9%88%E5%8F%AF%E4%BB%A5%E5%8A%A0%E9%80%9F%E8%81%9A%E5%90%88%E8%BF%90%E7%AE%97%EF%BC%9F"><span class="nav-number">8.4.</span> <span class="nav-text">Lucene 4 实现的 DocValues 特性，为什么可以加速聚合运算？</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#DocValues-%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="nav-number">8.4.1.</span> <span class="nav-text">DocValues 是什么？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%BA%E6%99%AF"><span class="nav-number">8.4.2.</span> <span class="nav-text">场景</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%94%A8%E6%B3%95"><span class="nav-number">8.4.3.</span> <span class="nav-text">用法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8E%9F%E7%90%86"><span class="nav-number">8.4.4.</span> <span class="nav-text">原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%9B%E4%B8%80%E6%AD%A5%E6%80%9D%E8%80%83-1"><span class="nav-number">8.4.5.</span> <span class="nav-text">进一步思考</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE-stored-%E2%80%9Dtrue%E2%80%9D-%E5%B1%9E%E6%80%A7%E5%90%8C%E6%A0%B7%E4%BC%9A%E6%9E%84%E5%BB%BA%E6%AD%A3%E6%8E%92%E7%B4%A2%E5%BC%95%EF%BC%8C%E5%AE%83%E5%92%8C-DocValues-%E5%8F%88%E6%9C%89%E4%BD%95%E4%B8%8D%E5%90%8C%EF%BC%9F"><span class="nav-number">8.4.5.1.</span> <span class="nav-text">设置 stored&#x3D;”true” 属性同样会构建正排索引，它和 DocValues 又有何不同？</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ElasticSearch-5-0-%E5%86%85%E6%A0%B8%E8%BF%81%E7%A7%BB%E4%B8%BA-Lucene-6-x%EF%BC%8C%E6%98%AF%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8-Block-K-d-Tree-%E6%9D%A5%E8%A7%A3%E5%86%B3-%E6%B7%B1%E5%BA%A6%E5%88%86%E9%A1%B5-%E9%97%AE%E9%A2%98%EF%BC%9F"><span class="nav-number">8.5.</span> <span class="nav-text">ElasticSearch 5.0 内核迁移为 Lucene 6.x，是如何利用 Block K-d Tree 来解决 深度分页 问题？</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ElasticSearch-2-x-%E7%8E%B0%E7%8A%B6"><span class="nav-number">8.5.1.</span> <span class="nav-text">ElasticSearch 2.x 现状</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AE%97%E6%B3%95%E7%AE%80%E4%BB%8B"><span class="nav-number">8.5.2.</span> <span class="nav-text">算法简介</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%BA%E7%82%B9"><span class="nav-number">8.5.3.</span> <span class="nav-text">缺点</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB"><span class="nav-number">9.</span> <span class="nav-text">源码阅读</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="nav-number">9.1.</span> <span class="nav-text">环境搭建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Lucene-1"><span class="nav-number">9.2.</span> <span class="nav-text">Lucene</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="nav-number">9.2.1.</span> <span class="nav-text">基本概念</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%EF%BC%88Index%EF%BC%89"><span class="nav-number">9.2.1.1.</span> <span class="nav-text">索引（Index）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%AE%B5%EF%BC%88Segment%EF%BC%89"><span class="nav-number">9.2.1.2.</span> <span class="nav-text">段（Segment）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%96%87%E6%A1%A3%EF%BC%88Document%EF%BC%89"><span class="nav-number">9.2.1.3.</span> <span class="nav-text">文档（Document）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9F%9F%EF%BC%88Field%EF%BC%89"><span class="nav-number">9.2.1.4.</span> <span class="nav-text">域（Field）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%AF%8D%E5%85%B8%EF%BC%88Term-Directory%EF%BC%89"><span class="nav-number">9.2.1.5.</span> <span class="nav-text">词典（Term Directory）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%AF%8D%EF%BC%88Term%EF%BC%89"><span class="nav-number">9.2.1.6.</span> <span class="nav-text">词（Term）</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E8%B7%B5"><span class="nav-number">9.2.2.</span> <span class="nav-text">实践</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD-Lucene"><span class="nav-number">9.2.2.1.</span> <span class="nav-text">下载 Lucene</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%9E%84%E9%80%A0%E9%9C%80%E8%A6%81%E8%A2%AB%E7%B4%A2%E5%BC%95%E7%9A%84%E6%95%B0%E6%8D%AE"><span class="nav-number">9.2.2.2.</span> <span class="nav-text">构造需要被索引的数据</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E6%96%87%E4%BB%B6"><span class="nav-number">9.2.2.3.</span> <span class="nav-text">创建索引文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%A3%80%E7%B4%A2%E6%96%87%E4%BB%B6"><span class="nav-number">9.2.2.4.</span> <span class="nav-text">检索文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="nav-number">9.2.2.5.</span> <span class="nav-text">目录结构</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%96%E7%A8%8B"><span class="nav-number">9.2.3.</span> <span class="nav-text">编程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F"><span class="nav-number">9.2.4.</span> <span class="nav-text">文件格式</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%A6%82%E8%A7%88"><span class="nav-number">9.2.4.1.</span> <span class="nav-text">概览</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%AD%A3%E6%8E%92%E7%B4%A2%E5%BC%95"><span class="nav-number">9.2.4.2.</span> <span class="nav-text">正排索引</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95"><span class="nav-number">9.2.4.3.</span> <span class="nav-text">倒排索引</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2"><span class="nav-number">9.2.4.4.</span> <span class="nav-text">全文检索</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%97%E5%BC%8F%E5%AD%98%E5%82%A8"><span class="nav-number">9.2.4.5.</span> <span class="nav-text">列式存储</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Document-%E6%A8%A1%E5%9D%97"><span class="nav-number">9.2.5.</span> <span class="nav-text">Document 模块</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8A%9F%E8%83%BD"><span class="nav-number">9.2.5.1.</span> <span class="nav-text">功能</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%BB%E4%BD%93"><span class="nav-number">9.2.5.2.</span> <span class="nav-text">主体</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Codecs-%E6%A8%A1%E5%9D%97"><span class="nav-number">9.2.6.</span> <span class="nav-text">Codecs 模块</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8A%9F%E8%83%BD-1"><span class="nav-number">9.2.6.1.</span> <span class="nav-text">功能</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Analysis-%E6%A8%A1%E5%9D%97"><span class="nav-number">9.2.7.</span> <span class="nav-text">Analysis 模块</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8A%9F%E8%83%BD-2"><span class="nav-number">9.2.7.1.</span> <span class="nav-text">功能</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%BB%E4%BD%93-1"><span class="nav-number">9.2.7.2.</span> <span class="nav-text">主体</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Index-%E6%A8%A1%E5%9D%97"><span class="nav-number">9.2.8.</span> <span class="nav-text">Index 模块</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8A%9F%E8%83%BD-3"><span class="nav-number">9.2.8.1.</span> <span class="nav-text">功能</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%BB%E4%BD%93-2"><span class="nav-number">9.2.8.2.</span> <span class="nav-text">主体</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE"><span class="nav-number">9.2.8.3.</span> <span class="nav-text">配置</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Store-%E6%A8%A1%E5%9D%97"><span class="nav-number">9.2.9.</span> <span class="nav-text">Store 模块</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8A%9F%E8%83%BD-4"><span class="nav-number">9.2.9.1.</span> <span class="nav-text">功能</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%BB%E4%BD%93-3"><span class="nav-number">9.2.9.2.</span> <span class="nav-text">主体</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Parser-%E6%A8%A1%E5%9D%97"><span class="nav-number">9.2.10.</span> <span class="nav-text">Parser 模块</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8A%9F%E8%83%BD-5"><span class="nav-number">9.2.10.1.</span> <span class="nav-text">功能</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Search-%E6%A8%A1%E5%9D%97"><span class="nav-number">9.2.11.</span> <span class="nav-text">Search 模块</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8A%9F%E8%83%BD-6"><span class="nav-number">9.2.11.1.</span> <span class="nav-text">功能</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%BB%E4%BD%93-4"><span class="nav-number">9.2.11.2.</span> <span class="nav-text">主体</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Similarity-%E6%A8%A1%E5%9D%97"><span class="nav-number">9.2.12.</span> <span class="nav-text">Similarity 模块</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8A%9F%E8%83%BD-7"><span class="nav-number">9.2.12.1.</span> <span class="nav-text">功能</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Geo-%E6%A8%A1%E5%9D%97"><span class="nav-number">9.2.13.</span> <span class="nav-text">Geo 模块</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8A%9F%E8%83%BD-8"><span class="nav-number">9.2.13.1.</span> <span class="nav-text">功能</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ElasticSearch-1"><span class="nav-number">9.3.</span> <span class="nav-text">ElasticSearch</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Transport-%E6%A8%A1%E5%9D%97"><span class="nav-number">9.3.1.</span> <span class="nav-text">Transport 模块</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8A%9F%E8%83%BD-9"><span class="nav-number">9.3.1.1.</span> <span class="nav-text">功能</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%BB%E4%BD%93-5"><span class="nav-number">9.3.1.2.</span> <span class="nav-text">主体</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE-1"><span class="nav-number">9.3.1.3.</span> <span class="nav-text">配置</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B5%81%E7%A8%8B"><span class="nav-number">9.3.1.4.</span> <span class="nav-text">流程</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Zen-Discovery-%E6%A8%A1%E5%9D%97"><span class="nav-number">9.3.2.</span> <span class="nav-text">Zen Discovery 模块</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8A%9F%E8%83%BD-10"><span class="nav-number">9.3.2.1.</span> <span class="nav-text">功能</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE-2"><span class="nav-number">9.3.2.2.</span> <span class="nav-text">配置</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B5%81%E7%A8%8B-1"><span class="nav-number">9.3.2.3.</span> <span class="nav-text">流程</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%85%B6%E4%BB%96"><span class="nav-number">9.3.2.4.</span> <span class="nav-text">其他</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Bully"><span class="nav-number">9.3.2.4.1.</span> <span class="nav-text">Bully</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Gossip"><span class="nav-number">9.3.2.4.2.</span> <span class="nav-text">Gossip</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%8D%95%E6%92%AD-vs-%E7%BB%84%E6%92%AD-vs-%E5%B9%BF%E6%92%AD"><span class="nav-number">9.3.2.4.3.</span> <span class="nav-text">单播 vs 组播 vs 广播</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%86%99%E5%85%A5"><span class="nav-number">9.3.3.</span> <span class="nav-text">数据写入</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B5%81%E7%A8%8B-2"><span class="nav-number">9.3.3.1.</span> <span class="nav-text">流程</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2"><span class="nav-number">9.3.4.</span> <span class="nav-text">数据查询</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B5%81%E7%A8%8B-3"><span class="nav-number">9.3.4.1.</span> <span class="nav-text">流程</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AE%B5%E5%90%88%E5%B9%B6"><span class="nav-number">9.3.5.</span> <span class="nav-text">段合并</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B5%81%E7%A8%8B-4"><span class="nav-number">9.3.5.1.</span> <span class="nav-text">流程</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%86%94%E6%96%AD%E5%99%A8"><span class="nav-number">9.3.6.</span> <span class="nav-text">熔断器</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8A%9F%E8%83%BD-11"><span class="nav-number">9.3.6.1.</span> <span class="nav-text">功能</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE-3"><span class="nav-number">9.3.6.2.</span> <span class="nav-text">配置</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Parent-Circuit-Breaker"><span class="nav-number">9.3.6.2.1.</span> <span class="nav-text">Parent Circuit Breaker</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Field-Data-Circuit-Breaker"><span class="nav-number">9.3.6.2.2.</span> <span class="nav-text">Field Data Circuit Breaker</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Request-Circuit-Breaker"><span class="nav-number">9.3.6.2.3.</span> <span class="nav-text">Request Circuit Breaker</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#In-Flight-Requests-Circuit-Breaker"><span class="nav-number">9.3.6.2.4.</span> <span class="nav-text">In Flight Requests Circuit Breaker</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Accounting-Requests-Circuit-Breaker"><span class="nav-number">9.3.6.2.5.</span> <span class="nav-text">Accounting Requests Circuit Breaker</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Script-Compilation-Circuit-Breaker"><span class="nav-number">9.3.6.2.6.</span> <span class="nav-text">Script Compilation Circuit Breaker</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%BB%E4%BD%93-6"><span class="nav-number">9.3.6.3.</span> <span class="nav-text">主体</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Rollup-1"><span class="nav-number">9.3.7.</span> <span class="nav-text">Rollup</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%BB%E4%BD%93-7"><span class="nav-number">9.3.7.1.</span> <span class="nav-text">主体</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%97%B6%E5%BA%8F%E5%9B%BE"><span class="nav-number">9.3.7.2.</span> <span class="nav-text">时序图</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B8%A9%E8%BF%87%E7%9A%84%E5%9D%91"><span class="nav-number">10.</span> <span class="nav-text">踩过的坑</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Unknown-Analyzer-type-org-ElasticSearch-index-analysis-IkAnalyzerProvider-for-ik"><span class="nav-number">10.1.</span> <span class="nav-text">Unknown Analyzer type [org.ElasticSearch.index.analysis.IkAnalyzerProvider] for [ik]</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#The-number-of-object-passed-must-be-even-but-was-1"><span class="nav-number">10.2.</span> <span class="nav-text">The number of object passed must be even but was [1]</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#blocked-by-FORBIDDEN-12-index-read-only-allow-delete-api"><span class="nav-number">10.3.</span> <span class="nav-text">blocked by: [FORBIDDEN&#x2F;12&#x2F;index read-only &#x2F; allow delete (api)]</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Docker-%E4%B8%AD%E6%97%A0%E6%B3%95%E5%BC%80%E5%90%AF-bootstrap-memory-lock-%E5%8F%82%E6%95%B0"><span class="nav-number">10.4.</span> <span class="nav-text">Docker 中无法开启 bootstrap.memory_lock 参数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B5%84%E6%96%99"><span class="nav-number">11.</span> <span class="nav-text">资料</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Doc"><span class="nav-number">11.1.</span> <span class="nav-text">Doc</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Lucene-2"><span class="nav-number">11.1.1.</span> <span class="nav-text">Lucene</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ElasticSearch-2"><span class="nav-number">11.1.2.</span> <span class="nav-text">ElasticSearch</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Github"><span class="nav-number">11.2.</span> <span class="nav-text">Github</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Paper"><span class="nav-number">11.3.</span> <span class="nav-text">Paper</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Book"><span class="nav-number">11.4.</span> <span class="nav-text">Book</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Tool"><span class="nav-number">11.5.</span> <span class="nav-text">Tool</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%AC%A2%E8%BF%8E%E5%8A%A0%E5%85%A5%E6%88%91%E4%BB%AC%E7%9A%84%E6%8A%80%E6%9C%AF%E7%BE%A4%EF%BC%8C%E4%B8%80%E8%B5%B7%E4%BA%A4%E6%B5%81%E5%AD%A6%E4%B9%A0"><span class="nav-number">12.</span> <span class="nav-text">欢迎加入我们的技术群，一起交流学习</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Benedict Jin" src="/yuzhouwan_logo_128x128.ico">
  <p class="site-author-name" itemprop="name">Benedict Jin</p>
  <div class="site-description" itemprop="description">Benedict Jin's Blog</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">53</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">146</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/asdf2014" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;asdf2014" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:asdf2014@apache.org" title="E-Mail → mailto:asdf2014@apache.org" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh" class="cc-opacity" rel="external nofollow noopener noreferrer" target="_blank"><img src="/images/cc-by-nc-nd.svg" alt="Creative Commons"></a>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        
  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="external nofollow noopener noreferrer" target="_blank">苏 ICP 备 17032505号 </a>
  </div>

<div class="copyright">
  
  &copy; 2014 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yuzhouwan.com</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">1.3m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">19:35</span>
</div>

        
<meta name="referrer" content="always">
<div class="busuanzi-count">
  <script async src="/lib/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




<script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.5/lib/darkmode-js.min.js"></script>
<script>
var options = {
  bottom: '32px', // default: '32px'
  right: '32px', // default: '32px'
  left: 'unset', // default: 'unset'
  time: '0.5s', // default: '0.3s'
  mixColor: '#fff', // default: '#fff'
  backgroundColor: '#fff',  // default: '#fff'
  buttonColorDark: '#100f2c',  // default: '#100f2c'
  buttonColorLight: '#fff', // default: '#fff'
  saveInCookies: true, // default: true,
  label: '🌓', // default: ''
  autoMatchOsTheme: false // default: true
}
const darkmode = new Darkmode(options);
darkmode.showWidget();
</script>
<style>
button.darkmode-toggle {
  z-index: 9999;
}
img, .darkmode-ignore {
  isolation: isolate;
  display: block;
}
</style>

  




  
<script src="/js/local-search.js"></script>











<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
          load: ['[tex]/mhchem'],
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
          packages: {'[+]': ['mhchem']},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

<script>
  var disqus_config = function() {
    this.page.url = "https://yuzhouwan.com/posts/22654/";
    this.page.identifier = "posts/22654/";
    this.page.title = "搜索引擎 ElasticSearch";
    };
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://yuzhouwan.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : 'e5da61069b94deb8ef3a',
      clientSecret: 'c60ad4e430be258b705027a036eeee3d71cb934b',
      repo        : 'gitment',
      owner       : 'asdf2014',
      admin       : ['asdf2014'],
      id          : 'e58d92f3d03a80959a397307cd6b674b',
        language: '',
      distractionFreeMode: false
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : true,
      appId      : 'BU4bnWsdAliFfk3fz7iMcFUU-gzGzoHsz',
      appKey     : '1xVLNFSy1qGCda3wt4GiGzHG',
      placeholder: "上述信息都不是必填的，可以直接提交评论",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</body>
</html>
